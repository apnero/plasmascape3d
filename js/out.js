b4w={module:{},register:function(a,q){var r=b4w.module;if(r[a])throw Error('Module "'+a+'" already registered');r[a]=q},require:function(a){var q=b4w.require,r=b4w.module[a];if(!r)throw Error('Module "'+a+'" not found');r._compiled||(r._compiled={},r(r._compiled,q));return r._compiled},module_check:function(a){return b4w.module[a]?!0:!1}};"object"==typeof module&&module.exports&&(GLOBAL.b4w={module:{}});
b4w.module.__version=function(a,q){function r(){var a=new Date,d=a.getDate(),d=10>d?"0"+String(d):String(d),b=a.getMonth()+1,b=10>b?"0"+String(b):String(b),l=String(a.getFullYear()),h=a.getHours(),h=10>h?"0"+String(h):String(h),e=a.getMinutes(),e=10>e?"0"+String(e):String(e),a=a.getSeconds(),a=10>a?"0"+String(a):String(a);return d+"."+b+"."+l+" "+h+":"+e+":"+a}a.version=function(){return""};a.type=function(){return"DEBUG"};a.date=r;a.timestamp=function(){var a=r(),a=a.split(" ").join("").split(":").join("").split(".").join("");
return"?t="+a}};"object"==typeof module&&module.exports&&b4w.module.__version(exports);b4w.module.__boundings=function(a,q){function r(a,b){for(var c=a[0],d=a[1],f=a[2],e=a[0],n=a[1],t=a[2],l=3;l<a.length;l+=3)var h=a[l],m=a[l+1],k=a[l+2],c=Math.max(c,h),d=Math.max(d,m),f=Math.max(f,k),e=Math.min(e,h),n=Math.min(n,m),t=Math.min(t,k);b.max_x=c;b.max_y=d;b.max_z=f;b.min_x=e;b.min_y=n;b.min_z=t;return b}function c(a,b){b||(b=new Float32Array(24));var c=a.max_x,d=a.max_y,f=a.max_z,e=a.min_x,n=a.min_y,t=a.min_z;b[0]=e;b[1]=n;b[2]=t;b[3]=c;b[4]=n;b[5]=t;b[6]=c;b[7]=d;b[8]=t;b[9]=e;b[10]=
d;b[11]=t;b[12]=e;b[13]=n;b[14]=f;b[15]=c;b[16]=n;b[17]=f;b[18]=c;b[19]=d;b[20]=f;b[21]=e;b[22]=d;b[23]=f;return b}function d(a,b,c){e.add(b,c,a.center);e.scale(a.center,.5,a.center);a.radius=e.distance(a.center,b);return a}var b=q("__geometry"),l=q("__util"),h=q("__tsr"),e=q("vec3"),k=new Float32Array(24),g=new Float32Array(3),y=new Float32Array(3),m=new Float32Array(3);a.copy_bb=function(a,b){b.min_x=a.min_x;b.max_x=a.max_x;b.min_y=a.min_y;b.max_y=a.max_y;b.min_z=a.min_z;b.max_z=a.max_z};a.big_bounding_box=
function(){return{max_x:1E12,min_x:-1E12,max_y:1E12,min_y:-1E12,max_z:1E12,min_z:-1E12}};a.zero_bounding_box=function(a){a||(a={});a.max_x=0;a.min_x=0;a.max_y=0;a.min_y=0;a.max_z=0;a.min_z=0;return a};a.expand_bounding_box=function(a,b){var c=a.max_y,d=a.max_z,f=a.min_x,e=a.min_y,n=a.min_z;a.max_x=Math.max(b.max_x,a.max_x);a.max_y=Math.max(b.max_y,c);a.max_z=Math.max(b.max_z,d);a.min_x=Math.min(b.min_x,f);a.min_y=Math.min(b.min_y,e);a.min_z=Math.min(b.min_z,n);return a};a.bb_from_coords=r;a.bounding_box_transform=
function(b,d,e){e||(e=a.zero_bounding_box());b=c(b,k);l.positions_multiply_matrix(b,d,b);return r(b,e)};a.extract_bb_corners=c;a.shrink_bounding_box=function(b,c,e){e||(e=a.zero_bounding_box());var d=c.min_x,f=c.max_x,l=c.min_y,n=c.max_y,t=c.min_z;c=c.max_z;if(d>=b.max_x||f<=b.min_x||l>=b.max_y||n<=b.min_y||t>=b.max_z||c<=b.min_z)return e.min_x=-.1,e.max_x=.1,e.min_y=-.1,e.max_y=.1,e.min_z=-.2,e.max_z=-.1,e;e.min_x=Math.max(b.min_x,d);e.max_x=Math.min(b.max_x,f);e.min_y=Math.max(b.min_y,l);e.max_y=
Math.min(b.max_y,n);e.min_z=Math.max(b.min_z,t);e.max_z=Math.min(b.max_z,c);return e};a.stretch_bounding_box=function(b,c,e){e||(e=a.zero_bounding_box());var d=b.max_x-b.min_x,f=b.max_y-b.min_y,l=b.max_z-b.min_z;e.min_x=b.min_x-.5*(c-1)*d;e.max_x=b.max_x+.5*(c-1)*d;e.min_y=b.min_y-.5*(c-1)*f;e.max_y=b.max_y+.5*(c-1)*f;e.min_z=b.min_z-.5*(c-1)*l;e.max_z=b.max_z+.5*(c-1)*l;return e};a.bounding_sphere_transform=function(b,c,d){d||(d=a.zero_bounding_sphere());e.transformMat4(b.center,c,d.center);d.radius=
b.radius*l.matrix_to_scale(c);return d};a.bounding_ellipsoid_transform=function(a,b,c){c||(c={axis_x:new Float32Array(3),axis_y:new Float32Array(3),axis_z:new Float32Array(3),center:new Float32Array([0,0,0])});h.transform_vec3(a.center,b,c.center);e.copy(a.axis_x,c.axis_x);e.copy(a.axis_y,c.axis_y);e.copy(a.axis_z,c.axis_z);h.transform_dir_vec3(c.axis_x,b,c.axis_x);h.transform_dir_vec3(c.axis_y,b,c.axis_y);h.transform_dir_vec3(c.axis_z,b,c.axis_z);return c};a.create_bounding_sphere=function(a,b){return{radius:a,
center:new Float32Array(b)}};a.zero_bounding_sphere=function(){return{center:new Float32Array([0,0,0]),radius:0}};a.create_bounding_ellipsoid=function(a,b,c,e){return{axis_x:new Float32Array(a),axis_y:new Float32Array(b),axis_z:new Float32Array(c),center:new Float32Array([e[0],e[1],e[2]])}};a.big_bounding_sphere=function(){return{center:new Float32Array([0,0,0]),radius:1E12}};a.expand_bounding_sphere=function(a,b){var c=e.subtract(b.center,a.center,e.create());0==e.length(c)&&e.set(1,0,0,c);var d=
e.normalize(c,e.create()),c=e.scale(d,a.radius,e.create());e.add(c,a.center,c);var f=e.scale(d,-a.radius,e.create());e.add(f,a.center,f);var l=e.scale(d,b.radius,e.create());e.add(l,b.center,l);var n=e.scale(d,-b.radius,e.create());e.add(n,b.center,n);c=[c,f,l,n];d=e.normalize(d,e.create());f=c[0];l=c[0];for(n=1;n<c.length;n++){var t=e.dot(c[n],d);t<e.dot(f,d)&&(f=c[n]);t>e.dot(l,d)&&(l=c[n])}d=[f,l];c=d[0];d=d[1];a.center=e.scale(e.add(c,d,e.create()),.5,e.create());a.radius=e.length(e.subtract(d,
c,e.create()))/2};a.create_bounding_capsule=function(a,b){var c=b.max_y,e=b.min_y,f=Math.max(0,c-e-2*a);return{radius:a,height:f,center:new Float32Array([0,(c+e)/2,0])}};a.create_bounding_cylinder=function(a,b){var c=b.max_y,e=b.min_y,f=Math.max(0,c-e);return{radius:a,height:f,center:new Float32Array([0,(c+e)/2,0])}};a.create_bounding_cone=function(a,b){var c=b.max_y,e=b.min_y,f=Math.max(0,c-e);return{radius:a,height:f,center:new Float32Array([0,(c+e)/2,0])}};a.check_bb_intersection=function(a,b){return a.min_x>
b.max_x||a.max_x<b.min_x?!1:a.min_y>b.max_y||a.max_y<b.min_y?!1:a.min_z>b.max_z||a.max_z<b.min_z?!1:!0};a.recalculate_mesh_boundings=function(a){for(var b=0,c=0,e=0,f=0,d=0,n=0,t=0,l=0,h=0;h<a.submeshes.length;h++){var m=a.submeshes[h];if(m.position.length){b=f=m.position[0];c=d=m.position[1];e=n=m.position[2];break}}for(h=0;h<a.submeshes.length;h++)for(var m=a.submeshes[h],m=m.position,k=0;k<m.length/3;k++)var K=m[3*k],v=m[3*k+1],Q=m[3*k+2],b=Math.max(K,b),c=Math.max(v,c),e=Math.max(Q,e),f=Math.min(K,
f),d=Math.min(v,d),n=Math.min(Q,n),t=Math.max(Math.sqrt(K*K+v*v+Q*Q),t),l=Math.max(Math.sqrt(K*K+Q*Q),l);a.b4w_bounding_box.max_x=b;a.b4w_bounding_box.min_x=f;a.b4w_bounding_box.max_y=c;a.b4w_bounding_box.min_y=d;a.b4w_bounding_box.max_z=e;a.b4w_bounding_box.min_z=n;a.b4w_bounding_sphere_radius=t;a.b4w_bounding_cylinder_radius=l};a.get_frustum_mec=function(c){var l=c.subarray(0,3),h=c.subarray(6,9),k=c.subarray(12,15),f=c.subarray(18,21);c=e.subtract(h,l,g);e.normalize(c,c);var E=b.get_plane_normal(l,
h,k,y),E=e.cross(E,c,E);e.normalize(E,E);var n=e.create(),t=e.create();e.subtract(h,l,m);t[0]=e.dot(m,c);t[1]=e.dot(m,E);h=e.create();e.subtract(k,l,m);h[0]=e.dot(m,c);h[1]=e.dot(m,E);k=e.create();e.subtract(f,l,m);k[0]=e.dot(m,c);k[1]=e.dot(m,E);f=a.zero_bounding_sphere();k=[n,t,h,k];n=d(f,k[0],k[1]);for(f=2;f<k.length;f++)if(e.distance(n.center,k[f])>n.radius){for(var M=n,n=k,t=k[f],h=f-1,M=d(M,t,n[0]),r=1;r<=h;r++)if(e.distance(M.center,n[r])>M.radius){for(var z=M,M=n,B=t,K=n[r],v=r-1,z=d(z,B,
K),Q=0;Q<=v;Q++)if(e.distance(z.center,M[Q])>z.radius){var O=B,L=K,G=M[Q],V=e.subtract(L,G,m),V=e.squaredLength(V),$=e.subtract(O,G,m),P=e.squaredLength($),$=e.subtract(O,L,m),q=e.squaredLength($),$=V*(P+q-V),T=P*(q+V-P),V=q*(V+P-q),P=$+T+V;e.copy(O,z.center);e.scale(z.center,$/P,z.center);e.scaleAndAdd(z.center,L,T/P,z.center);e.scaleAndAdd(z.center,G,V/P,z.center);z.radius=e.distance(z.center,O)}M=z}n=M}f=n;c=e.scale(c,f.center[0],m);e.scaleAndAdd(c,E,f.center[1],c);e.add(c,l,f.center);return f}};b4w.module.__constraints=function(a,q){function r(a){var b={};b.type=a;return b}function c(a,b){a._constraint&&a._constraint.obj_parent&&d(a._constraint.obj_parent,a);if(b.obj_parent){var c=b.obj_parent;if(-1==c._descends.indexOf(a))c._descends.push(a);else throw"Descendant object override is forbidden";}a._constraint=b}function d(a,b){var c=a._descends.indexOf(b);if(-1!=c)a._descends.splice(c,1);else throw"No descendant object";}function b(a,b,c){switch(b.type){case 1:var G=a._render.quat,d=b.obj_parent._render.world_matrix;
c=b.obj_parent._render.quat;b.rotation_offset?(x.copy(b.rotation_offset,G),x.multiply(c,G,G)):x.copy(c,G);s.transformMat4(b.offset,d,a._render.trans);a._render.scale=b.scale_offset*b.obj_parent._render.scale;break;case 9:var k=a._render.trans,G=a._render.quat,d=b.obj_parent._render.world_matrix;c=b.obj_parent._render.quat;x.multiply(x.invert(b.parent_prev_rotation,b.parent_prev_rotation),G,G);x.multiply(c,G,G);s.transformMat4(b.offset,d,k);x.copy(c,b.parent_prev_rotation);break;case 10:k=a._render.trans;
G=a._render.quat;d=b.obj_parent._render.world_matrix;c=b.obj_parent._render.quat;x.multiply(x.invert(b.parent_prev_rotation,b.parent_prev_rotation),G,G);x.multiply(c,G,G);s.transformMat4(b.offset,d,k);x.copy(c,b.parent_prev_rotation);var G=a._render.quat,k=b.obj_parent._render.quat,z=s.transformQuat(m.AXIS_Y,G,A),d=x.invert(k,t),M=s.transformQuat(z,d,f),r=E;r[0]=M[0];r[1]=0;r[2]=M[2];var q=s.length(r),d=-r[2]/q,d=Math.acos(d)*m.sign(r[0]),q=q/s.length(M),q=Math.acos(q)*m.sign(M[1]),M=!1;d<-b.clamp_left&&
(d=-b.clamp_left,M=!0);d>b.clamp_right&&(d=b.clamp_right,M=!0);q<-b.clamp_up&&(q=-b.clamp_up,M=!0);q>b.clamp_down&&(q=b.clamp_down,M=!0);M&&(b=Math.sin(q),q=Math.cos(q),M=Math.sin(d),d=Math.cos(d),r=f,r[0]=q*M,r[1]=b,r[2]=-q*d,s.transformQuat(r,k,r),b=x.rotationTo(z,r,t),x.multiply(b,G,G),x.normalize(G,G));"CAMERA"==a._render.type&&(b=s.transformQuat(m.AXIS_Y,c,f),e(a,b));break;case 12:k=a._render.trans;G=a._render.quat;d=b.obj_parent._render.world_matrix;q=b.obj_parent._render.trans;a=b.softness;
M=A;z=t;s.transformMat4(b.offset,d,M);m.smooth_v(M,k,c,a,k);b=A;s.sub(q,k,b);s.normalize(b,b);r=G;k=B;d=k.subarray(0,3);q=k.subarray(3,6);M=k.subarray(6,9);s.copy(b,q);s.negate(q,q);s.normalize(q,q);Boolean(.999999<Math.abs(s.dot(b,m.AXIS_Y)))?(b=C.fromQuat(x.normalize(r,z),K),s.copy(b.subarray(0,3),d)):s.cross(m.AXIS_Y,q,d);s.normalize(d,d);s.cross(d,q,M);s.normalize(M,M);x.fromMat3(k,z);x.normalize(z,z);m.smooth_q(z,G,c,.16*a,G);break;case 2:G=a._render.quat;k=n;c=t;g(b.obj_parent,b.bone_name,!0,
k,c);b.rotation_offset?(x.copy(b.rotation_offset,G),x.multiply(c,G,G)):x.copy(c,G);a._render.scale=b.scale_offset*k[3];m.transform_vec3(b.offset,k[3],c,k,a._render.trans);break;case 3:k=a._render.trans;G=a._render.quat;c=b.obj_parent._render.trans;l(k,G,c);"CAMERA"==a._render.type&&e(a,m.AXIS_Y);break;case 4:k=a._render.trans;G=a._render.quat;c=b.target;l(k,G,c);"CAMERA"==a._render.type&&e(a,m.AXIS_Y);break;case 5:k=a._render.trans;G=a._render.quat;c=b.obj_parent._render.trans;G=h(k,G,c,b.offset_min,
v);z=s.dist(k,c);if(b=G?z+b.offset_min:z>b.offset_max?z-b.offset_max:z<b.offset_min?z-b.offset_min:0)s.sub(c,k,A),s.normalize(A,A),s.scale(A,b,A),s.add(k,A,k);"CAMERA"==a._render.type&&e(a,m.AXIS_Y);break;case 6:k=a._render.trans;G=a._render.quat;c=b.target;G=h(k,G,c,b.offset_min,v);z=s.dist(k,c);if(b=G?z+b.offset_min:z>b.offset_max?z-b.offset_max:z<b.offset_min?z-b.offset_min:0)s.sub(c,k,A),s.normalize(A,A),s.scale(A,b,A),s.add(k,A,k);"CAMERA"==a._render.type&&e(a,m.AXIS_Y);break;case 7:d=b.obj_parent._render.world_matrix;
s.transformMat4(b.offset,d,a._render.trans);break;case 8:q=b.obj_parent._render.trans;k=a._render.trans;s.add(q,b.offset,k);break;case 13:G=a._render.quat;d=b.obj_parent._render.world_matrix;c=b.obj_parent._render.quat;b.rotation_offset?(x.copy(b.rotation_offset,G),x.multiply(c,G,G)):x.copy(c,G);s.transformMat4(b.offset,d,a._render.trans);break;case 11:c=b.obj_parent._render,c=y.create_sep(c.trans,c.scale,c.quat,S),y.multiply(c,b.tsr_offset,c),k=a._render.trans,k[0]=c[0],k[1]=c[1],k[2]=c[2],a._render.scale=
c[3],G=a._render.quat,G[0]=c[4],G[1]=c[5],G[2]=c[6],G[3]=c[7]}}function l(a,b,c){var G=A;m.quat_to_dir(b,m.AXIS_MY,G);s.normalize(G,G);var d=f;s.subtract(c,a,d);s.normalize(d,d);a=n;m.rotation_to_stable(G,d,a);x.multiply(a,b,b)}function h(a,b,c,G,d){var v=!1,e=A;m.quat_to_dir(b,m.AXIS_MY,e);s.normalize(e,e);var k=f;s.subtract(c,a,k);a=s.length(k);s.normalize(k,k);s.dot(e,k)<Math.cos(d)&&(s.scale(k,-1,k),v=!0);a>G-.001&&(G=m.rotation_to_stable(e,k,n),x.multiply(G,b,b),x.normalize(b,b));return v}function e(a,
b){var c=a._render.quat,G=k(c,b,t);x.multiply(G,c,c)}function k(a,b,c){a=C.fromQuat(a,B);var G=A;G[0]=a[3];G[1]=a[4];G[2]=a[5];if(.999999<Math.abs(s.dot(b,G)))return x.identity(c),c;b=s.cross(b,G,G);s.normalize(b,b);0<a[7]&&(b[0]*=-1,b[1]*=-1,b[2]*=-1);G=f;G[0]=a[0];G[1]=a[1];G[2]=a[2];s.normalize(G,G);x.rotationTo(G,b,c);return c}function g(a,b,c,G,f){var d=a._render,v=d.frame_factor,e=d.bone_pointers[b];b=e.deform_bone_index;a=a.pose.bones[e.pose_bone_index];var e=a._tsr_local,k=n,l=d.trans_before,
p=d.trans_after,h=d.quats_before,m=d.quats_after,K=l[4*b+1],s=l[4*b+2],B=l[4*b+3],g=p[4*b+1],D=p[4*b+2],I=p[4*b+3];k[0]=(1-v)*l[4*b]+v*p[4*b];k[1]=(1-v)*K+v*g;k[2]=(1-v)*s+v*D;k[3]=(1-v)*B+v*I;l=t;p=M;l[0]=h[4*b];l[1]=h[4*b+1];l[2]=h[4*b+2];l[3]=h[4*b+3];p[0]=m[4*b];p[1]=m[4*b+1];p[2]=m[4*b+2];p[3]=m[4*b+3];x.slerp(l,p,v,l);v=S;y.set_transcale(k,v);y.set_quat(l,v);c?(c=z,y.translate(e,a._tail,c),y.multiply(v,c,v)):y.multiply(v,e,v);y.multiply(d.tsr,v,v);G[0]=v[0];G[1]=v[1];G[2]=v[2];G[3]=v[3];f&&
(f[0]=v[4],f[1]=v[5],f[2]=v[6],f[3]=v[7])}var y=q("__tsr"),m=q("__util"),s=q("vec3"),x=q("quat"),C=q("mat3");q("mat4");a.CONS_TYPE_STIFF_OBJ=1;a.CONS_TYPE_STIFF_BONE=2;a.CONS_TYPE_TRACK_OBJ=3;a.CONS_TYPE_TRACK_POINT=4;a.CONS_TYPE_FOLLOW_OBJ=5;a.CONS_TYPE_FOLLOW_POINT=6;a.CONS_TYPE_STIFF_TRANS_OBJ=7;a.CONS_TYPE_COPY_TRANS_OBJ=8;a.CONS_TYPE_SEMI_STIFF_OBJ=9;a.CONS_TYPE_SEMI_STIFF_CAM_OBJ=10;a.CONS_TYPE_CHILD_OF=11;a.CONS_TYPE_SEMI_SOFT_CAM_OBJ=12;a.CONS_TYPE_STIFF_TRANS_ROT_OBJ=13;var A=new Float32Array(3),
f=new Float32Array(3),E=new Float32Array(3),n=new Float32Array(4),t=new Float32Array(4),M=new Float32Array(4),S=new Float32Array(16),z=new Float32Array(16),B=new Float32Array(9),K=new Float32Array(9),S=new Float32Array(8),v=9*Math.PI/10;a.CONS_ROTATE_LIMIT=v;a.append_stiff_obj=function(a,f,L,G,v){var d=r(1);d.obj_parent=f;d.offset=new Float32Array(L);d.rotation_offset=G?new Float32Array(G):null;d.scale_offset=v;c(a,d);b(a,d,0)};a.append_stiff_bone=function(a,f,L,G,d,v){var e=r(2);e.obj_parent=f;e.bone_name=
L;e.offset=new Float32Array(G);e.rotation_offset=d?new Float32Array(d):null;e.scale_offset=v;c(a,e);b(a,e,0)};a.append_semi_stiff_obj=function(a,f,L,G){var d=r(9),v=a._render.quat,e=f._render.quat;d.obj_parent=f;d.offset=new Float32Array(L);d.parent_prev_rotation=new Float32Array(e);G&&(x.copy(G,v),x.multiply(e,v,v));c(a,d);b(a,d,0)};a.append_semi_stiff_cam_obj=function(a,f,L,G,d,v,e,n){var k=r(10),l=a._render.quat,p=f._render.quat;k.obj_parent=f;k.offset=new Float32Array(L);k.parent_prev_rotation=
new Float32Array(p);k.clamp_left=d;k.clamp_right=v;k.clamp_up=e;k.clamp_down=n;G&&(x.copy(G,l),x.multiply(p,l,l));c(a,k);b(a,k,0)};a.append_semi_soft_cam_obj=function(a,f,L,G){var d=r(12);d.obj_parent=f;d.offset=new Float32Array(L);d.softness=G;c(a,d);b(a,d,0)};a.append_stiff_trans_rot_obj=function(a,f,L,G,d){var v=r(13);v.obj_parent=f;v.offset=new Float32Array(L);v.scale_offset=d||1;v.rotation_offset=G?new Float32Array(G):null;c(a,v);b(a,v,0)};a.append_track_obj=function(a,f){var L=r(3);L.obj_parent=
f;c(a,L);b(a,L,0)};a.append_track_point=function(a,f){var L=r(4);L.target=new Float32Array(f);c(a,L);b(a,L,0)};a.append_follow_obj=function(a,f,L,G){var d=r(5);d.obj_parent=f;d.offset_min=L;d.offset_max=G;c(a,d);b(a,d,0)};a.append_follow_point=function(a,f,L,G){var d=r(6);d.target=new Float32Array(f);d.offset_min=L;d.offset_max=G;c(a,d);b(a,d,0)};a.append_stiff_trans_obj=function(a,f,L){var G=r(7);G.obj_parent=f;G.offset=new Float32Array(L);c(a,G);b(a,G,0)};a.append_copy_trans_obj=function(a,f,L){var G=
r(8);G.obj_parent=f;G.offset=new Float32Array(L);c(a,G);b(a,G,0)};a.append_child_of=function(a,f,L){var G=r(11);G.obj_parent=f;G.tsr_offset=new Float32Array(L);c(a,G);b(a,G,0)};a.update_constraint=function(a,c){a._constraint&&b(a,a._constraint,c)};a.rotate_to=l;a.rotate_to_limits=h;a.correct_up=e;a.calc_cam_rot_correction=k;a.remove=function(a){a._constraint.obj_parent&&d(a._constraint.obj_parent,a);a._constraint=null};a.get_type=function(a){return a._constraint?a._constraint.type:null};a.get_parent=
function(a){return a._constraint&&a._constraint.obj_parent?a._constraint.obj_parent:null};a.get_child_of_offset=function(a){return a._constraint&&11==a._constraint.type?a._constraint.tsr_offset:null};a.get_bone_pose=g};b4w.module.__compat=function(a,q){function r(a){return-1<navigator.userAgent.indexOf(a)?!0:!1}function c(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)}function d(){return!window.ActiveXObject&&"ActiveXObject"in window}var b=q("__config"),l=q("__extensions"),h=q("__print"),
e=q("__util");a.set_hardware_defaults=function(a){var g=b.animation,y=b.defaults,m=b.context,s=b.scenes,x=b.sfx;y.max_texture_size=a.getParameter(a.MAX_TEXTURE_SIZE);y.max_cube_map_size=a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE);var C=Boolean(l.get_depth_texture());r("Firefox")&&b.is_built_in_data()&&(h.warn("Firefox detected for single HTML version, disable video textures."),y.firefox_disable_html_video_tex_hack=!0);r("Firefox/28.0")&&(r("Linux")||r("Macintosh"))&&(h.warn("Firefox 28 detected, applying depth hack"),
C=!1);r("iPad")||r("iPhone")?(h.warn("iOS detected, applying alpha hack, applying vertex animation mix normals hack and disable smaa. Disable ssao for performance. Disable video textures. Initialize WebAudio context with empty sound."),m.alpha||(y.background_color[3]=1),y.vert_anim_mix_normals_hack=!0,y.smaa=!1,y.ssao=!1,y.precision="highp",y.init_wa_context_hack=!0):r("Mac OS X")&&r("Safari")&&!r("Chrome")&&(h.warn("OS X / Safari detected, force to wait complete loading. Applying playback rate hack for video textures."),
x.audio_loading_hack=!0,x.clamp_playback_rate_hack=!0);r("Windows")&&(r("Chrome/40")||r("Firefox/33")||r("Firefox/34")||r("Firefox/35"))&&(h.warn("Windows/Chrome40 or Firefox33-35 detected. Applying clear procedural skydome hack."),y.clear_procedural_sky_hack=!0);c()&&(h.warn("Mobile detected, applying glsl loops unroll hack, applying various hacks for video textures."),y.glsl_unroll_hack=!0,y.is_mobile_device=!0,r("iPad")||r("iPhone")||(h.warn("Mobile (not iOS) detected, disable playback rate for video textures."),
x.disable_playback_rate_hack=!0));if(r("iPhone")||d())h.warn("iPhone or IE11 detected. Enable sequential video fallback for video textures."),y.seq_video_fallback=!0;10>a.getParameter(a.MAX_VARYING_VECTORS)&&(h.warn("Not enough varyings, disable shadows on blend objects"),y.disable_blend_shadows_hack=!0);if(m=l.get_renderer_info())r("Macintosh")&&-1<a.getParameter(m.UNMASKED_RENDERER_WEBGL).indexOf("Intel HD Graphics 3000")&&(h.warn("OS X / Intel HD 3000 detected, applying depth and glsl loops unroll hacks"),
C=!1,y.glsl_unroll_hack=!0),-1<a.getParameter(m.UNMASKED_VENDOR_WEBGL).indexOf("ARM")&&-1<a.getParameter(m.UNMASKED_RENDERER_WEBGL).indexOf("Mali-400")&&(h.warn("ARM Mali-400 detected, applying depth and frames blending hacks"),C=!1,g.frames_blending_hack=!0),-1<a.getParameter(m.UNMASKED_VENDOR_WEBGL).indexOf("ARM")&&-1<a.getParameter(m.UNMASKED_RENDERER_WEBGL).indexOf("Mali-T604")&&(h.warn('ARM Mali-T604 detected, set "highp" precision and disable shadows.'),y.precision="highp",y.shadows="NONE"),
-1<a.getParameter(m.UNMASKED_VENDOR_WEBGL).indexOf("ARM")&&-1<a.getParameter(m.UNMASKED_RENDERER_WEBGL).indexOf("Mali-T760")&&(h.warn("ARM Mali-T760 detected, disable SSAO."),y.ssao=!1),-1<a.getParameter(m.UNMASKED_VENDOR_WEBGL).indexOf("Qualcomm")&&-1<a.getParameter(m.UNMASKED_RENDERER_WEBGL).indexOf("Adreno")&&(h.warn("Qualcomm Adreno detected, applying shader constants hack."),y.shader_constants_hack=!0,-1<a.getParameter(m.UNMASKED_RENDERER_WEBGL).indexOf("305")&&(h.warn('Qualcomm Adreno305 detected, set "highp" precision.'),
y.precision="highp"),-1<a.getParameter(m.UNMASKED_RENDERER_WEBGL).indexOf("330")&&(h.warn('Qualcomm Adreno330 detected, set "highp" precision.'),y.precision="highp")),-1<a.getParameter(m.UNMASKED_VENDOR_WEBGL).indexOf("NVIDIA")&&-1<a.getParameter(m.UNMASKED_RENDERER_WEBGL).indexOf("Tegra 3")&&(h.warn("NVIDIA Tegra 3 detected, force low quality for LEVELS_OF_QUALITY nodes."),y.force_low_quality_nodes=!0);0==a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS)&&(h.warn("Vertex textures are not allowed. Disabling vertex textures"),
y.allow_vertex_textures=!1);y.allow_hidpi&&1<window.devicePixelRatio&&(h.log("%cENABLE HIDPI MODE","color: #00a"),y.resolution_factor=1,y.smaa=!1);C||(y.deferred_rendering=!1,y.foam=!1,y.parallax=!1,y.dynamic_grass=!1,y.procedural_fog=!1,y.water_dynamic=!1,y.shore_smoothing=!1,y.shore_distance=!1,y.refractions=!1,y.smaa=!1);y.use_dds=Boolean(l.get_s3tc());g=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS);g=e.clamp(g,128,Infinity);y.max_bones=e.trunc((g-50)/4);y.max_bones_no_blending=e.trunc((g-50)/2);
g=a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT);a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT);0===g.precision&&(y.precision="mediump");d()&&(h.warn("IE11 detected. Set sky cubemap texture size to 512 (power of two)."),s.cubemap_tex_size=512);128>=a.getParameter(a.MAX_FRAGMENT_UNIFORM_VECTORS)&&(h.warn("Not enough fragment uniforms, force low quality for LEVELS_OF_QUALITY nodes."),y.force_low_quality_nodes=!0)};a.detect_mobile=c;a.apply_context_alpha_hack=function(){(r("Firefox/35.0")||
r("Firefox/36.0"))&&r("Windows")&&(h.warn("Windows/Firefox 35/36 detected, forcing context's alpha"),b.context.alpha=!0)};a.is_ie11=d};b4w.module.__config=function(a,q){function r(){return b4w.module_check(a.paths.built_in_data_module)}var c=q("__print"),d=q("__util");a.P_LOW=1;a.P_HIGH=2;a.P_ULTRA=3;a.P_CUSTOM=4;a.context={alpha:!0,antialias:!1,premultipliedAlpha:!0};a.context_save=d.clone_object_r(a.context);a.defaults={alpha_sort:!0,alpha_sort_threshold:.1,min_format_version:5,max_fps:1E4,console_verbose:!1,do_not_load_resources:!1,use_min50:!1,fps_measurement_interval:1.5,fps_callback_interval:10,background_color:[0,0,0,0],force_selectable:!1,
all_objs_selectable:!1,lod_transition_ratio:.01,resolution_factor:1,canvas_resolution_factor:1,texture_min_filter:3,allow_cors:!1,force_low_quality_nodes:!1,anisotropic_filtering:!0,show_hud_debug_info:!1,depth_textures:!0,shadows:"DEPTH",anaglyph_use:!1,reflections:!0,reflect_multiplier:.5,refractions:!0,glow:!0,ssao:!0,dof:!0,god_rays:!0,bloom:!0,motion_blur:!0,compositing:!0,antialiasing:!0,smaa:!1,wireframe_debug:!1,water_wireframe_debug:!1,foam:!0,parallax:!0,dynamic_grass:!0,procedural_fog:!0,
water_dynamic:!0,shore_smoothing:!0,shore_distance:!0,max_texture_size:1024,max_cube_map_size:512,max_bones:53,use_dds:!0,precision:"highp",deferred_rendering:!0,quality:a.P_HIGH,allow_vertex_textures:!0,glsl_unroll_hack:!1,no_phy_interp_hack:!1,shader_constants_hack:!1,disable_blend_shadows_hack:!1,vert_anim_mix_normals_hack:!1,is_mobile_device:!1,init_wa_context_hack:!1,clear_procedural_sky_hack:!1,firefox_disable_html_video_tex_hack:!1,sky_update_hack:!1,seq_video_fallback:!1,allow_hidpi:!1,gyro_use:!1};
a.defaults_save=d.clone_object_r(a.defaults);a.animation={framerate:-1,frames_blending_hack:!1,frame_steps:1};a.controls={mouse_wheel_notch_multiplier:1/120};a.assets={dir:"ASSETS=../../deploy/assets/",max_requests:15,prevent_caching:!0,min50_available:!1,dds_available:!1};a.assets_save=d.clone_object_r(a.assets);a.paths={shaders_dir:"../../shaders/",shaders_include_dir:"include/",built_in_data_module:"built_in_data",smaa_search_texture_path:"",smaa_area_texture_path:"",resources_dir:"../deploy/apps/common/",
resources_search_paths:["b4w.min.js","b4w.full.min.js","src/data.js","USER_DEFINED_MODULE"]};a.physics={enabled:!0,max_fps:60,uranium_path:""};a.physics_save=d.clone_object_r(a.physics);a.scenes={offscreen_tex_size:1024,grass_tex_size:1024,cubemap_tex_size:384};a.scenes_save=d.clone_object_r(a.scenes);a.sfx={webaudio:!0,mix_mode:!1,audio_loading_hack:!1,clamp_playback_rate_hack:!1,disable_playback_rate_hack:!1};a.sfx_save=d.clone_object_r(a.sfx);a.debug_subs={enabled:!1,subs_type:"MAIN_OPAQUE",subs_number:0,
slink_type:"COLOR"};a.debug_subs_save=d.clone_object_r(a.debug_subs);a.apply_quality=function(){var b=a.defaults,c=a.physics,d=a.scenes;switch(b.quality){case a.P_ULTRA:b.shadows="DEPTH";b.shore_smoothing=!0;b.glow=!0;b.ssao=!0;b.dof=!0;b.god_rays=!0;b.bloom=!0;b.reflections=!0;b.reflect_multiplier=1;b.refractions=!0;b.foam=!0;b.parallax=!0;b.dynamic_grass=!0;b.procedural_fog=!0;b.resolution_factor=1.75;d.offscreen_tex_size=2048;d.grass_tex_size=2048;b.texture_min_filter=3;b.anisotropic_filtering=
!0;b.use_min50=!1;b.max_bones=53;b.precision="highp";b.water_dynamic=!0;b.shore_distance=!0;b.antialiasing=!0;b.smaa=!0;b.compositing=!0;b.motion_blur=!0;b.allow_hidpi=!0;c.max_fps=120;break;case a.P_HIGH:b.shadows="DEPTH";b.shore_smoothing=!0;b.glow=!0;b.ssao=!0;b.dof=!0;b.god_rays=!0;b.bloom=!0;b.reflections=!0;b.reflect_multiplier=.5;b.refractions=!0;b.foam=!0;b.parallax=!0;b.dynamic_grass=!0;b.procedural_fog=!0;b.resolution_factor=1;d.offscreen_tex_size=1024;d.grass_tex_size=1024;b.texture_min_filter=
3;b.anisotropic_filtering=!0;b.use_min50=!1;b.max_bones=53;b.precision="highp";b.water_dynamic=!0;b.shore_distance=!0;b.antialiasing=!0;b.smaa=!1;b.compositing=!0;b.motion_blur=!0;b.allow_hidpi=!1;c.max_fps=60;break;case a.P_LOW:b.shadows="NONE",b.shore_smoothing=!1,b.glow=!1,b.ssao=!1,b.dof=!1,b.god_rays=!1,b.bloom=!1,b.reflections=!1,b.reflect_multiplier=.5,b.refractions=!1,b.foam=!1,b.parallax=!1,b.dynamic_grass=!1,b.procedural_fog=!1,b.resolution_factor=1,d.offscreen_tex_size=512,d.grass_tex_size=
512,b.texture_min_filter=2,b.anisotropic_filtering=!1,b.use_min50=!0,b.max_bones=53,b.precision="mediump",b.water_dynamic=!1,b.shore_distance=!1,b.antialiasing=!1,b.smaa=!1,b.compositing=!1,b.motion_blur=!1,b.allow_hidpi=!1,c.max_fps=60}};a.set=function(b,d){switch(b){case "all_objs_selectable":a.defaults.all_objs_selectable=d;break;case "allow_cors":a.defaults.allow_cors=d;break;case "allow_hidpi":a.defaults.allow_hidpi=d;break;case "alpha":a.context.alpha=d;break;case "alpha_sort":a.defaults.alpha_sort=
d;break;case "alpha_sort_threshold":a.defaults.alpha_sort_threshold=d;break;case "anaglyph_use":a.defaults.anaglyph_use=d;break;case "animation_framerate":a.animation.framerate=d;break;case "antialiasing":a.defaults.antialiasing=d;break;case "assets_dds_available":a.assets.dds_available=d;break;case "assets_min50_available":a.assets.min50_available=d;break;case "background_color":a.defaults.background_color=d;break;case "built_in_module_name":a.paths.built_in_data_module=d;break;case "canvas_resolution_factor":a.defaults.canvas_resolution_factor=
d;break;case "console_verbose":a.defaults.console_verbose=d;break;case "context_antialias":a.context.antialias=d;break;case "deferred_rendering":a.defaults.deferred_rendering=d;break;case "do_not_load_resources":a.defaults.do_not_load_resources=d;break;case "force_selectable":a.defaults.force_selectable=d;break;case "gyro_use":a.defaults.gyro_use=d;break;case "glow":a.defaults.glow=d;break;case "physics_enabled":a.physics.enabled=d;break;case "physics_uranium_path":a.physics.uranium_path=d;break;
case "precision":a.defaults.precision=d;break;case "quality":a.defaults.quality=d;break;case "resolution_factor":a.defaults.resolution_factor=d;break;case "sfx_mix_mode":a.sfx.mix_mode=d;break;case "shaders_dir":a.paths.shaders_dir=d;break;case "show_hud_debug_info":a.defaults.show_hud_debug_info=d;break;case "smaa":a.defaults.smaa=d;break;case "smaa_search_texture_path":a.paths.smaa_search_texture_path=d;break;case "smaa_area_texture_path":a.paths.smaa_area_texture_path=d;break;case "wireframe_debug":a.defaults.wireframe_debug=
d;break;default:c.error("B4W config set - property unknown: "+b)}};a.get=function(b){switch(b){case "all_objs_selectable":return a.defaults.all_objs_selectable;case "allow_cors":return a.defaults.allow_cors;case "allow_hidpi":return a.defaults.allow_hidpi;case "alpha":return a.context.alpha;case "alpha_sort":return a.defaults.alpha_sort;case "alpha_sort_threshold":return a.defaults.alpha_sort_threshold;case "anaglyph_use":return a.defaults.anaglyph_use;case "animation_framerate":return a.animation.framerate;
case "antialiasing":return a.defaults.antialiasing;case "assets_dds_available":return a.assets.dds_available;case "assets_min50_available":return a.assets.min50_available;case "background_color":return a.defaults.background_color;case "built_in_module_name":return a.paths.built_in_data_module;case "canvas_resolution_factor":return a.defaults.canvas_resolution_factor;case "console_verbose":return a.defaults.console_verbose;case "context_antialias":return a.context.antialias;case "deferred_rendering":return a.defaults.deferred_rendering;
case "do_not_load_resources":return a.defaults.do_not_load_resources;case "force_selectable":return a.defaults.force_selectable;case "gyro_use":return a.defaults.gyro_use;case "glow":return a.defaults.glow;case "physics_enabled":return a.physics.enabled;case "physics_uranium_path":return a.physics.uranium_path;case "precision":return a.defaults.precision;case "quality":return a.defaults.quality;case "resolution_factor":return a.defaults.resolution_factor;case "sfx_mix_mode":return a.sfx.mix_mode;
case "shaders_dir":return a.paths.shaders_dir;case "show_hud_debug_info":return a.defaults.show_hud_debug_info;case "smaa":return a.defaults.smaa;case "smaa_search_texture_path":return a.paths.smaa_search_texture_path;case "smaa_area_texture_path":return a.paths.smaa_area_texture_path;case "wireframe_debug":return a.defaults.wireframe_debug;default:c.error("B4W config get - property unknown: "+b)}};a.reset=function(){a.context=d.clone_object_r(a.context_save);a.defaults=d.clone_object_r(a.defaults_save);
a.assets=d.clone_object_r(a.assets_save);a.physics=d.clone_object_r(a.physics_save);a.scenes=d.clone_object_r(a.scenes_save);a.sfx=d.clone_object_r(a.sfx_save);a.debug_subs=d.clone_object_r(a.debug_subs_save)};a.is_built_in_data=r;a.set_resources_paths=function(){var b=a.paths,d=a.physics;if(r())b.smaa_search_texture_path="smaa_search_texture.png",b.smaa_area_texture_path="smaa_area_texture.png";else if(""==b.smaa_search_texture_path||""==b.smaa_area_texture_path||""==d.uranium_path){for(var h=null,
e=document.getElementsByTagName("script"),k=0;k<e.length;k++){for(var g=e[k].src,y=0;y<b.resources_search_paths.length;y++)if(0<=g.indexOf(b.resources_search_paths[y])){h=g;break}if(null!==h)break}h||(c.warn("Couldn't determine path to external resources, fallback to current page URL"),h=document.location.href);e=h.indexOf("?");0<=e&&(h=h.substring(0,e));h=h.substring(0,h.lastIndexOf("/")+1)+b.resources_dir;d.uranium_path=d.uranium_path||h+"uranium.js";b.smaa_search_texture_path=b.smaa_search_texture_path||
h+"smaa_search_texture.png";b.smaa_area_texture_path=b.smaa_area_texture_path||h+"smaa_area_texture.png"}};a.get_std_assets_path=function(){return a.assets.dir.replace("ASSETS=","")}};b4w.module.__controls=function(a,q){function r(a){return{type:a,value:0,payload:null,lock_sensors:null,lock_sensor_values:null,lock_logic_fun:null,do_activation:!1,key:0,collision_id:"",collision_obj:null,need_collision_pt:!1,collision_cb:function(){},col_imp_obj:null,col_imp_cb:function(){},source_object:null,start_offset:new Float32Array(3),end_offset:new Float32Array(3),local_coords:!1,ray_cb:function(){},axis:"",time_last:0,trans_last:new Float32Array(3),quat_last:new Float32Array(4),threshold:0,
quat_temp:new Float32Array(4),avg_linear_vel:0,avg_angular_vel:0,rotation_threshold:0,avg_vertical_vel:0,period:0,repeat:!1,auto_release:!1,gyro_gamma_new:0,gyro_beta_new:0,gyro_alpha_new:0,gyro_gamma_last:0,gyro_beta_last:0,gyro_alpha_last:0}}function c(a,b){var c;if(a.lock_logic_fun){c=a.lock_sensors;for(var w=a.lock_sensor_values,I=0;I<c.length;I++)w[I]=c[I].value;c=a.lock_logic_fun(w)}else c=!1;c||(a.value=Number(b))}function d(a){a=Q.indexOf(a);-1<a?Q.splice(a,1):E.error("Wrong object")}function b(a,
b){for(var c=0,w=0;w<b.length;w++)for(var I=b[w]._sensor_manifolds_arr,L=0;L<I.length;L++)for(var f=I[L].sensors,G=0;G<f.length;G++)f[G]===a&&c++;return c}function l(a,b){switch(a.type){case 80:n.remove_collision_test(a.collision_obj,a.collision_id,a.collision_cb);a.do_activation=!0;break;case 90:n.clear_collision_impulse_test(a.col_imp_obj);a.do_activation=!0;break;case 100:n.remove_ray_test(a.source_object,a.collision_id,a.start_offset,a.end_offset,a.local_coords);a.do_activation=!0;break;case 130:a.do_activation=
!0}var c=b.indexOf(a);-1<c&&b.splice(c,1)}function h(a){for(var b=0;b<O.length;b++){var w=O[b];20==w.type&&a.keyCode==w.key&&c(w,1)}I&&a.preventDefault();fa&&fa(a)}function e(a){for(var b=0;b<O.length;b++){var w=O[b];20==w.type&&0==a.keyCode&&16==w.key&&c(w,0);20==w.type&&a.keyCode==w.key&&c(w,0)}I&&a.preventDefault();fa&&fa(a)}function k(a){var b=!1,I=null;V=a.clientX;$=a.clientY;for(var L=0;L<O.length;L++){var f=O[L];50==f.type&&(c(f,1),f.payload=a.which);160==f.type&&(b||(I=t.pick_object(a.clientX,
a.clientY),b=!0),f.value=I==f.source_object?1:0)}ia&&a.preventDefault();w&&w(a)}function g(a){for(var b=0;b<O.length;b++){var I=O[b];50==I.type&&c(I,0);160==I.type&&I.auto_release&&(I.value=0)}ia&&!H&&a.preventDefault();w&&w(a)}function y(a){var b=a.clientX,I=a.clientY;V=b;$=I;for(var b=b-P,I=I-Y,L=Math.sqrt(b*b+I*I),f=0;f<O.length;f++){var G=O[f];if(40===G.type)switch(G.axis){case "X":c(G,b);break;case "Y":c(G,I);break;case "XY":c(G,L)}}ia&&!H&&a.preventDefault();w&&w(a)}function m(a){var b=a.wheelDelta||
-40*a.detail,b=b*K.mouse_wheel_notch_multiplier;G+=b;for(b=0;b<O.length;b++){var w=O[b];30===w.type&&c(w,G)}ka&&a.preventDefault();ja&&ja(a)}function s(a){var b=a.targetTouches;if(1==b.length){for(var c=b[0],b=c.pageX,c=c.pageY,w=!1,I=null,L=0;L<O.length;L++){var f=O[L];160==f.type&&(w||(I=t.pick_object(b,c),w=!0),f.value=I==f.source_object)}p[0]=b;p[1]=-1;ga[0]=c;ga[1]=-1}else 1<b.length&&(F=ha=A(b),p[0]=b[0].pageX,p[1]=b[1].pageX,ga[0]=b[0].pageY,ga[1]=b[1].pageY);T.set(p);X.set(ga);oa&&oa(a)}function x(b){var w=
b.targetTouches;if(0!==w.length){if(1===w.length){T[0]=w[0].pageX;T[1]=-1;X[0]=w[0].pageY;X[1]=-1;var w=T[0]-p[0],I=X[0]-ga[0],L=Math.sqrt(w*w+I*I);if(-1!=p[1]&&-1!=ga[1]){var f=T[0]-p[1],G=X[0]-ga[1],d=Math.sqrt(f*f+G*G);d<L&&(w=f,I=G,L=d)}for(d=0;d<O.length;d++){var v=O[d];if(60===v.type)switch(v.payload=a.PL_SINGLE_TOUCH_MOVE,v.axis){case "X":c(v,w);break;case "Y":c(v,I);break;case "XY":c(v,L)}}}else if(1<w.length){T[0]=w[0].pageX;T[1]=w[1].pageX;X[0]=w[0].pageY;X[1]=w[1].pageY;F=A(w);L=F-ha;f=
Z;f[0]=(T[0]+T[1])/2;f[1]=(X[0]+X[1])/2;G=N;G[0]=(p[0]+p[1])/2;G[1]=(ga[0]+ga[1])/2;var e,w=f[0],I=f[1],d=G[0],v=G[1];e=Math.sqrt((w-d)*(w-d)+(I-v)*(I-v));for(d=0;d<O.length;d++)if(v=O[d],70===v.type&&Math.abs(e)<Math.abs(L)&&(v.payload=a.PL_MULTITOUCH_MOVE_ZOOM,c(v,L)),60===v.type&&Math.abs(e)>Math.abs(L))switch(v.payload=a.PL_MULTITOUCH_MOVE_PAN,v.axis){case "X":w=f[0]-G[0];c(v,w);break;case "Y":I=f[1]-G[1];c(v,I);break;case "XY":c(v,e)}}qa&&b.preventDefault();oa&&oa(b)}}function C(a){for(var b=
0;b<O.length;b++){var w=O[b];if(170==w.type||180==w.type)w.gyro_beta_new=a.beta,w.gyro_gamma_new=a.gamma,w.gyro_alpha_new=a.alpha,w.value||(w.gyro_gamma_last=a.gamma,w.gyro_beta_last=a.beta,w.gyro_alpha_last=a.alpha,c(w,1))}}function A(a){var b=a[0],c=a[1];a=b.pageX;var b=b.pageY,w=c.pageX,c=c.pageY;return Math.sqrt((a-w)*(a-w)+(b-c)*(b-c))}var f=q("__config"),E=q("__print"),n=q("__physics"),t=q("__scenes"),M=q("__time"),S=q("__util"),z=q("vec3"),B=q("quat"),K=f.controls,v=f.defaults,Q=[],O=[],L=
{},G=0,V=0,$=0,P=0,Y=0,T=new Float32Array(2),X=new Float32Array(2),p=new Float32Array(2),ga=new Float32Array(2),Z=new Float32Array(2),N=new Float32Array(2),F=0,ha=0,ea=!1,D=0,I=!1,ia=!1,ka=!1,qa=!1,H=!1,fa=null,w=null,ja=null,oa=null;a.CT_CONTINUOUS=10;a.CT_TRIGGER=20;a.CT_SHOT=30;a.CT_LEVEL=40;a.PL_SINGLE_TOUCH_MOVE=0;a.PL_MULTITOUCH_MOVE_ZOOM=1;a.PL_MULTITOUCH_MOVE_PAN=2;a.update=function(b,w){for(var I=0;I<O.length;I++){var f=O[I],d=b,v=w;if(v)switch(f.type){case 110:var e=f.source_object,H=e._render.trans,
e=e._render.quat,n=z.dist(f.trans_last,H),t=f.quat_temp;B.invert(f.quat_last,t);B.multiply(e,t,t);B.normalize(t,t);t=Math.abs(2*Math.acos(t[3]));n/=v;f.avg_linear_vel=S.smooth(n,f.avg_linear_vel,v,.3);f.payload[0]=n;n=t/v;f.avg_angular_vel=S.smooth(n,f.avg_angular_vel,v,.3);f.payload[1]=n;f.avg_linear_vel>=f.threshold||f.avg_angular_vel>=f.rotation_threshold?c(f,1):c(f,0);z.copy(H,f.trans_last);B.copy(e,f.quat_last);f.time_last=d;break;case 120:e=f.source_object;H=e._render.trans;e=Math.abs(H[1]-
f.trans_last[1])/v;f.avg_vertical_vel=S.smooth(e,f.avg_vertical_vel,v,.3);f.payload=e;f.avg_vertical_vel>=f.threshold?c(f,1):c(f,0);z.copy(H,f.trans_last);f.time_last=d;break;case 130:!f.do_activation&&0<=f.period&&d-f.time_last>=f.period&&(c(f,1),f.repeat?f.time_last=d:f.period=-f.period);break;case 140:f.time_last||(f.time_last=d);c(f,d-f.time_last);f.time_last=d;break;case 150:c(f,d);break;case 170:f.payload[0]=Math.PI*(f.gyro_gamma_new-f.gyro_gamma_last)/180;f.payload[1]=Math.PI*(f.gyro_beta_new-
f.gyro_beta_last)/180;f.payload[2]=Math.PI*(f.gyro_alpha_new-f.gyro_alpha_last)/180;f.gyro_gamma_last=f.gyro_gamma_new;f.gyro_beta_last=f.gyro_beta_new;f.gyro_alpha_last=f.gyro_alpha_new;break;case 180:f.payload[0]=Math.PI*f.gyro_gamma_new/180,f.payload[1]=Math.PI*f.gyro_beta_new/180,f.payload[2]=Math.PI*f.gyro_alpha_new/180}}for(I=0;I<Q.length;I++)for(v=Q[I],f=v._sensor_manifolds_arr,d=0;d<f.length;d++)if(H=f[d],H.update_counter!=D){H.update_counter=D;for(var e=H,n=e.sensors,t=e.sensor_values,k=
0;k<n.length;k++)t[k]=n[k].value;var e=e.logic_fun(t),n=H,t=n.last_pulse,h=k=void 0;switch(n.type){case a.CT_CONTINUOUS:e?h=k=1:1==t?h=k=-1:k=0;break;case a.CT_TRIGGER:e&&-1==t?h=k=1:e||1!=t?k=0:h=k=-1;break;case a.CT_SHOT:e&&-1==t?h=k=1:e||1!=t?k=0:(k=0,h=-1);break;case a.CT_LEVEL:k=n.last_logic_result!=e?1:0;break;default:S.panic("Wrong sensor manifold type: "+n.type)}h&&(n.last_pulse=h);if(n=k)if(t=v==L?null:v,ea=!1,H.callback(t,H.id,n,H.callback_param),H.last_logic_result=e,ea){I=-1;break}}for(I=
0;I<Q.length;I++)for(v=Q[I],f=v._sensor_manifolds_arr,d=0;d<f.length;d++)for(H=f[d],v=H.sensors,H=0;H<v.length;H++)switch(e=v[H],e.type){case 30:c(e,0);break;case 40:c(e,0);break;case 60:c(e,0);break;case 70:c(e,0);break;case 130:c(e,0)}G=0;P=V;Y=$;p.set(T);ga.set(X);ha=F;D++};a.create_custom_sensor=function(a){var b=r(10);c(b,a);return b};a.create_keyboard_sensor=function(a){var b=r(20);b.key=a;return b};a.create_collision_sensor=function(a,b,w){if(!a||!a._physics)return E.error("Wrong collision object"),
null;var f=r(80);f.collision_obj=a;f.collision_id=b||"ANY";f.need_collision_pt=w;f.collision_cb=function(a,b){c(f,a);a&&b&&w&&(f.payload=f.payload||new Float32Array(3),f.payload[0]=b[0],f.payload[1]=b[1],f.payload[2]=b[2])};f.do_activation=!0;return f};a.create_collision_impulse_sensor=function(a){if(!a||!a._physics)return E.error("Wrong collision impulse object"),null;var b=r(90);b.col_imp_obj=a;b.col_imp_cb=function(a){c(b,a)};b.do_activation=!0;return b};a.create_ray_sensor=function(a,b,w,f,I){if(!a)return E.error("Wrong collision object"),
null;var L=r(100);L.source_object=a;L.start_offset=b;L.end_offset=w;L.local_coords=f;L.collision_id=I||"ANY";L.ray_cb=function(a,b){c(L,a);a&&(L.payload=b)};L.do_activation=!0;return L};a.create_mouse_click_sensor=function(){return r(50)};a.create_mouse_wheel_sensor=function(){return r(30)};a.create_mouse_move_sensor=function(a){var b=r(40);b.axis=a||"XY";return b};a.create_touch_move_sensor=function(a){var b=r(60);b.axis=a||"XY";b.payload=0;return b};a.create_touch_zoom_sensor=function(){var a=r(70);
a.payload=0;return a};a.create_motion_sensor=function(a,b,c){if(!a)return E.error("Wrong collision object"),null;var w=r(110);w.source_object=a;var f=a._render.trans;a=a._render.quat;w.quat_temp=new Float32Array(4);w.trans_last=new Float32Array(f);w.quat_last=new Float32Array(a);w.avg_linear_vel=0;w.avg_angular_vel=0;w.threshold=b;w.rotation_threshold=c;w.time_last=0;w.payload=new Float32Array([0,0]);return w};a.create_vertical_velocity_sensor=function(a,b){if(!a)return E.error("Wrong collision object"),
null;var c=r(120);c.source_object=a;var w=a._render.quat;c.trans_last=new Float32Array(a._render.trans);c.quat_last=new Float32Array(w);c.avg_vertical_vel=0;c.threshold=b;c.time_last=0;c.payload=0;return c};a.create_timer_sensor=function(a,b){var c=r(130);c.period=a;c.repeat=b;c.do_activation=!0;return c};a.reset_timer_sensor=function(a,b,c,w){a=a||L;a=a._sensor_manifolds;if(!a||!a[b])return E.error("reset_timer_sensor(): wrong object"),null;b=a[b].sensors[c];if(!b)return E.error("reset_timer_sensor(): sensor not found"),
null;b.time_last=M.get_timeline();b.period=w};a.create_elapsed_sensor=function(){var a=r(140);a.time_last=0;return a};a.create_gyro_delta_sensor=function(){var a=r(170);a.payload=new Float32Array(3);return a};a.create_gyro_angles_sensor=function(){var a=r(180);a.payload=new Float32Array(3);return a};a.create_timeline_sensor=function(){return r(150)};a.create_selection_sensor=function(a,b){var c=r(160);c.source_object=a;c.auto_release=b;return c};a.sensor_set_value=c;a.get_sensor_value=function(a,
b,c){a=a||L;a=a._sensor_manifolds;if(!a||!a[b])return E.error("get_sensor_value(): wrong object"),null;b=a[b].sensors[c];return b?b.value:(E.error("get_sensor_value(): sensor not found"),null)};a.get_sensor_payload=function(a,b,c){a=a||L;a=a._sensor_manifolds;if(!a||!a[b])return E.error("get_sensor_payload(): wrong object"),null;b=a[b].sensors[c];return b?b.payload:(E.error("get_sensor_payload(): sensor not found"),null)};a.cleanup=function(){Q=[];O=[];L={}};a.check_sensor_manifold=function(a,b){a=
a||L;if(!a._sensor_manifolds)return!1;if(b&&a._sensor_manifolds[b])return!0;if(!b)for(var c in a._sensor_manifolds)return!0;return!1};a.remove_sensor_manifold=function(a,c){a=a||L;var w=a._sensor_manifolds;if(w){var f=a._sensor_manifolds_arr;if(c){var I=w[c];if(I){for(var G=I.sensors,v=0;v<G.length;v++)1===b(G[v],Q)&&l(G[v],O);delete w[c];I=f.indexOf(I);-1<I?f.splice(I,1):S.panic("Incorrect manifolds array");Object.getOwnPropertyNames(w).length||d(a)}}else{for(c in w){I=w[c];G=I.sensors;for(v=0;v<
G.length;v++)1===b(G[v],Q)&&l(G[v],O);delete w[c];I=f.indexOf(I);-1<I?f.splice(I,1):S.panic("Incorrect manifolds array")}d(a);ea=!0}}};a.create_sensor_manifold=function(a,c,w,f,I,G,d){a=a||L;a._sensor_manifolds=a._sensor_manifolds||{};a._sensor_manifolds_arr=a._sensor_manifolds_arr||[];var v=a._sensor_manifolds,e=a._sensor_manifolds_arr,H=v[c];if(H){f=H.sensors;for(var p=0;p<f.length;p++)1===b(f[p],Q)&&l(f[p],O);H=e.indexOf(H);-1<H?e.splice(H,1):S.panic("Incorrect manifolds array")}w={id:c,type:w,
sensors:f.slice(0),logic_fun:I,sensor_values:Array(f.length),callback:G,callback_param:d,last_pulse:-1,last_logic_result:0,update_counter:-1};v[c]=w;e.push(w);-1==Q.indexOf(a)&&Q.push(a);a=w.sensors;for(c=0;c<a.length;c++){v=a[c];if(v.do_activation){switch(v.type){case 80:n.append_collision_test(v.collision_obj,v.collision_id,v.collision_cb,v.need_collision_pt);break;case 90:n.apply_collision_impulse_test(v.col_imp_obj,v.col_imp_cb);break;case 100:n.append_ray_test(v.source_object,v.collision_id,
v.start_offset,v.end_offset,v.local_coords,v.ray_cb);break;case 130:v.time_last=M.get_timeline(),0>v.period&&(v.period=-v.period)}v.do_activation=!1}-1==O.indexOf(v)&&O.push(v)}ea=!0};a.default_AND_logic_fun=function(a){for(var b=0;b<a.length;b++)if(!a[b])return a[b];return a[a.length-1]};a.default_OR_logic_fun=function(a){for(var b=0;b<a.length;b++)if(a[b])return a[b];return a[a.length-1]};a.reset=function(){for(var a=0;a<Q.length;a++){var b=Q[a],c=b._sensor_manifolds,b=b._sensor_manifolds_arr,w;
for(w in c)delete c[w];b.splice(0,b.length)}for(a=0;a<O.length;a++)l(O[a],O),a--;Q.splice(0,Q.length)};a.debug=function(){E.log(String(Q.length)+" objects with manifolds",Q);E.log(String(O.length)+" sensors",O);for(var a=[],b=[],c=0;c<O.length;c++){var w=O[c];80==w.type&&a.push(w);100==w.type&&b.push(w)}E.log(String(a.length)+" collision sensors",a);E.log(String(b.length)+" ray sensors",b)};a.register_keyboard_events=function(a,b){a.addEventListener("keydown",h,!1);a.addEventListener("keyup",e,!1);
I=b};a.register_mouse_events=function(a,b,c){if(c)var w=window;else w=a,w.addEventListener("mouseout",g,!1);a.addEventListener("mousedown",k,!1);w.addEventListener("mousemove",y,!1);w.addEventListener("mouseup",g,!1);ia=b;H=c};a.register_wheel_events=function(a,b){a.addEventListener("mousewheel",m,!1);a.addEventListener("DOMMouseScroll",m,!1);ka=b};a.register_touch_events=function(a,b){a.addEventListener("touchstart",s,!1);a.addEventListener("touchmove",x,!1);document.addEventListener("touchstart",
function(){});qa=b};a.register_device_orientation=function(){window.DeviceOrientationEvent&&v.gyro_use&&window.addEventListener("deviceorientation",C,!1)};a.unregister_keyboard_events=function(a){a.removeEventListener("keydown",h,!1);a.removeEventListener("keyup",e,!1)};a.unregister_mouse_events=function(a){a.removeEventListener("mousedown",k,!1);a.removeEventListener("mousemove",y,!1);a.removeEventListener("mouseout",g,!1);a.removeEventListener("mouseup",g,!1)};a.unregister_wheel_events=function(a){a.removeEventListener("mousewheel",
m,!1);a.removeEventListener("DOMMouseScroll",m,!1)};a.unregister_touch_events=function(a){a.removeEventListener("touchstart",s,!1);a.removeEventListener("touchmove",x,!1);document.removeEventListener("touchstart",function(){})};a.unregister_device_orientation=function(){window.DeviceOrientationEvent&&v.gyro_use&&window.removeEventListener("deviceorientation",C,!1)};a.assign_keyboard_callback=function(a){fa=a};a.assign_mouse_callback=function(a){w=a};a.assign_wheel_callback=function(a){ja=a};a.assign_touch_callback=
function(a){oa=a}};b4w.module.__curve=function(a,q){function r(a,b,c,d,g){var y=d.length;g||(g=new Float32Array(y));for(var m=y+a,s=new Float32Array(m),x=1;x<=m-1;x++)s[x-1]=b>=c[x-1]&&b<c[x+1-1]?1:0;for(var C=2;C<=a;C++)for(x=1;x<=m-C;x++)s[x-1]=(0!=s[x-1]?(b-c[x-1])*s[x-1]/(c[x+C-1-1]-c[x-1]):0)+(0!=s[x+1-1]?(c[x+C-1]-b)*s[x+1-1]/(c[x+C-1]-c[x+1-1]):0);b==c[m-1]&&(s[y-1]=1);a=0;for(x=1;x<=y;x++)a+=s[x-1]*d[x-1];for(x=1;x<=y;x++)g[x-1]=0!=a?s[x-1]*d[x-1]/a:0;return g}function c(a){a=a.knot;return a[a.length-1]}function d(a){a=
a.cumulative_length;return a[a.length-1]}var b=q("__util");a.create_spline=function(a){var b={},c=a.data;a=c.splines[0];if(!a||"NURBS"!=a.type||!a.use_endpoint_u)return null;var d=a.order_u;b.order=d;a=a.points;var g=a.length/5,y=[],m=g+d,g=g+2;y[0]=0;for(var s=2;s<=m;s++)y[s-1]=s>d&&s<g?y[s-2]+1:y[s-2];b.knot=y;if("2D"==c.dimensions)b.is_3d=!1;else if("3D"==c.dimensions)b.is_3d=!0;else throw"Wrong curve dimensions";d=[];y=[];for(c=0;c<a.length;c+=5)d.push(a[c]),d.push(a[c+1]),d.push(a[c+2]),b.is_3d&&
d.push(a[c+3]),y.push(a[c+4]);b.cpoints=d;b.weights=y;a=[];for(var c=b.cpoints,d=b.is_3d?4:3,y=b.weights,m=b.knot,g=b.order,s=c.length/d,x=s+g,C=0,A=m[x-1]/999,f=0;1E3>f;f++){5E-6>m[x-1]-C&&(C=m[x-1]);for(var E=r(g,C,m,y),n=0;n<d;n++)for(var t=a[d*f+n]=0;t<s;t++)a[d*f+n]+=E[t]*c[d*t+n];C+=A}d=b.is_3d?4:3;y=new Float32Array(1E3);y[0]=0;for(c=1;1E3>c;c+=1)m=a[(c-1)*d],g=a[(c-1)*d+1],s=a[(c-1)*d+2],x=a[c*d],C=a[c*d+1],A=a[c*d+2],m=Math.sqrt((x-m)*(x-m)+(C-g)*(C-g)+(A-s)*(A-s)),y[c]=y[c-1]+m;b.cumulative_length=
y;return b};a.spline_point=function(a,b,d){d||(d=[]);var k=b,g=Math.max(k,0),g=c(a);b=g=Math.min(k,g);var k=a.cpoints,g=a.is_3d?4:3,y=a.weights,m=a.knot,s=a.order;a=k.length/g;var x=a+s;5E-6>m[x-1]-b&&(b=m[x-1]);x=new Float32Array(a);r(s,b,m,y,x);for(b=0;b<g;b++)for(y=d[b]=0;y<a;y++)d[b]+=x[y]*k[g*y+b];return d};a.spline_derivative=function(a,b,c){c||(c=[]);var d=a.cpoints,g=a.is_3d?4:3,y=a.weights,m=a.knot,s=a.order;a=d.length/g;var x=a+s;5E-6>m[x-1]-b&&(b=m[x-1]);var x=new Float32Array(a),C=b;b=
x;var A=y.length;b||(b=new Float32Array(A));var f=new Float32Array(A),E=new Float32Array(A),n=f,t=E;n||(n=new Float32Array(A));t||(t=new Float32Array(A));for(var M=A+s,r=new Float32Array(M),z=new Float32Array(M),B=1;B<=M-1;B++)r[B-1]=C>=m[B-1]&&C<m[B+1-1]?1:0;C==m[M-1]&&(r[A-1]=1);for(var K=2;K<=s;K++)for(B=1;B<=M-K;B++){var v=0!=r[B-1]?r[B-1]/(m[B+K-1-1]-m[B-1]):0,Q=0!=r[B+1-1]?-r[B+1-1]/(m[B+K-1]-m[B+1-1]):0,O=0!=z[B-1]?(C-m[B-1])*z[B-1]/(m[B+K-1-1]-m[B-1]):0,L=0!=z[B+1-1]?(m[B+K-1]-C)*z[B+1-1]/
(m[B+K-1]-m[B+1-1]):0;r[B-1]=(0!=r[B-1]?(C-m[B-1])*r[B-1]/(m[B+K-1-1]-m[B-1]):0)+(0!=r[B+1-1]?(m[B+K-1]-C)*r[B+1-1]/(m[B+K-1]-m[B+1-1]):0);z[B-1]=v+Q+O+L}for(B=1;B<=A;B++)n[B-1]=r[B-1],t[B-1]=z[B-1];m=0;for(s=1;s<=A;s++)m+=f[s-1]*y[s-1];C=0;for(s=1;s<=A;s++)C+=E[s-1]*y[s-1];for(s=1;s<=A;s++)b[s-1]=0!=m?E[s-1]*y[s-1]/m+f[s-1]*y[s-1]*C/(m*m):0;for(y=0;y<g;y++)for(m=c[y]=0;m<a;m++)c[y]+=x[m]*d[g*m+y];return c};a.spline_max_t=c;a.spline_length=d;a.spline_len_to_t=function(a,h){if(0>=h)return 0;var e=
c(a);if(h>=d(a))return e;var k=a.cumulative_length,g=b.binary_search_max(k,h,0,k.length-1);return e*(g+(h-k[g])/(k[g+1]-k[g]))/1E3}};b4w.module.__debug=function(a,q){function r(a){a=a.split("\n");for(var b=0;b<a.length;b++)a[b]=b+1+" "+a[b];return a=a.join("\n")}function c(a,b){typeof a!=typeof b&&h.panic("Structure assertion failed: incompatible types");for(var c in a)c in b||h.panic("Structure assertion failed: missing key in the first object: "+c);for(c in b)c in a||h.panic("Structure assertion failed: missing key in the second object: "+c),typeof a[c]!=typeof b[c]&&h.panic("Structure assertion failed: incompatible types for key "+
c)}var d=q("__extensions"),b=q("__print"),l=q("__textures"),h=q("__util"),e=null,k={},g=!1,y={},m=[],s=-1,x=null,C=!1;a.WIREFRAME_MODES={WM_OPAQUE_WIREFRAME:0,WM_TRANSPARENT_WIREFRAME:1,WM_FRONT_BACK_VIEW:2,WM_DEBUG_SPHERES:3};a.setup_context=function(a){var b="INVALID_ENUM INVALID_VALUE INVALID_OPERATION OUT_OF_MEMORY INVALID_FRAMEBUFFER_OPERATION CONTEXT_LOST_WEBGL".split(" "),c;for(c in b){var d=b[c];d in a&&(k[a[d]]=d)}e=a};a.check_gl=function(a){if(g){var b=e.getError();if(b!=e.NO_ERROR){if(b in
k)throw"B4W Error: "+b+", gl."+k[b]+" ("+a+")";throw"Unknown GL error: "+b+" ("+a+")";}}};a.check_bound_fb=function(){if(!g)return!0;switch(e.checkFramebufferStatus(e.FRAMEBUFFER)){case e.FRAMEBUFFER_COMPLETE:return!0;case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return b.error("B4W Error: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT"),!1;case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return b.error("B4W Error: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT"),!1;case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return b.error("B4W Error: Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS"),
!1;case e.FRAMEBUFFER_UNSUPPORTED:return b.error("B4W Error: Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED"),!1;default:return b.error("B4W Error: FRAMEBUFFER CHECK FAILED"),!1}};a.check_depth_only_issue=function(){if(-1!=s)return s;var a=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,a);a=l.create_texture("DEBUG",l.TT_DEPTH);l.resize(a,1,1);e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,a.w_target,a.w_texture,0);e.checkFramebufferStatus(e.FRAMEBUFFER)!=e.FRAMEBUFFER_COMPLETE?(s=
!0,b.warn("B4W warning: depth-only issue was found")):s=!1;e.bindFramebuffer(e.FRAMEBUFFER,null);return s};a.check_shader_compiling=function(a,c,d){if(g&&!e.getShaderParameter(a,e.COMPILE_STATUS))throw d=r(d),b.error("B4W Error: shader compilation failed:\n"+d+"\n"+e.getShaderInfoLog(a)+" ("+c+")"),"Engine failed: see above for error messages";};a.check_shader_linking=function(a,c,n,t,k,m){if(g&&!e.getProgramParameter(a,e.LINK_STATUS)){var h=d.get_debug_shaders();h&&(k=h.getTranslatedShaderSource(n),
m=h.getTranslatedShaderSource(t));k=r(k);m=r(m);b.error("B4W Error: shader linking failed:\n"+k+"\n\n\n"+m+"\n"+e.getProgramInfoLog(a)+" ("+c+")");throw"Engine failed: see above for error messages";}};a.set_check_gl_errors=function(a){g=a};a.exec_count=function(a){y[a]=a in y?y[a]+1:1};a.update=function(){for(var a in y)b.log(a,y[a]),y[a]=0};a.fbmsg=function(){for(var a=[performance.now()],b=0;b<arguments.length;b++){var c=arguments[b];if(h.is_vector(c))for(var d=0;d<c.length;d++)a.push(c[d]);else a.push(arguments[b])}m.push(a)};
a.msg=function(){for(var a=1,b=0;b<m.length;b++){var c=m[b];c[1]==arguments[0]&&a++}c=[a];for(b=0;b<arguments.length;b++)if(a=arguments[b],h.is_vector(a))for(var d=0;d<a.length;d++)c.push(a[d]);else c.push(arguments[b]);m.push(c)};var A=["color: #3366FF","color: #CC33FF","color: #FF3366","color: #33FF66","color: #FFCC33"];a.print_telemetry=function(a){a||(a=1);for(var c=0,d={},e=Math.max(0,performance.now()-1E3*a),k=0;k<m.length;k++){var h=m[k];a=h[0];if(!(a<e)){var s=String(h[1]);d[s]||(d[s]=A[c++%
A.length]);var g=d[s];a=["%c"+(a/1E3).toFixed(6),g,s];for(s=2;s<h.length;s++)a.push(h[s]);b.log.apply(this,a)}}m.splice(0)};a.plot_telemetry=function(a){a||(a=1);for(var c={},d=Math.max(0,performance.now()-1E3*a),e=0;e<m.length;e++){var k=m[e];a=k[0];if(!(a<d))for(var h=2;h<k.length;h++){var s=String(k[1]);3<k.length&&(s+="_"+String(h-2));c[s]||(c[s]=s+"\n");c[s]+=String(a)+" "+k[h]+"\n"}}a="";for(s in c)a+=c[s]+"\n\n";b.log(a);m.splice(0)};a.check_browser=function(a){var b=navigator.userAgent.toLowerCase(),
c=function(a){return-1<b.indexOf(a)?!0:!1};switch(a.toLowerCase()){case "chrome":return c("mozilla")&&c("applewebkit")&&c("chrome");case "firefox":return c("mozilla")&&c("gecko")&&c("firefox");case "msie":return c("mozilla")&&c("trident")&&c("msie");case "opera":return c("opera")&&c("presto");case "safari":return c("mozilla")&&c("applewebkit")&&c("safari")&&!c("chrome");default:return!1}};a.check_finite=function(a){if(h.is_vector(a)){for(var b=0;b<a.length;b++)if(!isFinite(a[b]))return!1;return Boolean(a.length)}return isFinite(a)?
!0:!1};a.assert_type=function(a,b){typeof a!=b&&h.panic("Type assertion failed: value type is not a {"+b+"}:",a)};a.assert_structure=c;a.assert_structure_seq=function(a){C?c(a,x):C=!0;x=a}};b4w.module.__extensions=function(a,q){function r(a){if(a in b)return b[a];var h=d.getExtension(a)||null;b[a]=h;c.log("%cGET EXTENSION","color: #"+(h?"0a0":"a00"),a);return h}var c=q("__print"),d=null,b={};a.setup_context=function(a){d=a};a.get_s3tc=function(){return r("WEBGL_compressed_texture_s3tc")||r("WEBKIT_WEBGL_compressed_texture_s3tc")||r("MOZ_WEBGL_compressed_texture_s3tc")};a.get_depth_texture=function(){return r("WEBGL_depth_texture")||r("WEBKIT_WEBGL_depth_texture")||r("MOZ_WEBGL_depth_texture")};
a.get_aniso=function(){return r("EXT_texture_filter_anisotropic")||r("WEBKIT_EXT_texture_filter_anisotropic")||r("MOZ_EXT_texture_filter_anisotropic")};a.get_debug_shaders=function(){return r("WEBGL_debug_shaders")};a.get_renderer_info=function(){return r("WEBGL_debug_renderer_info")};a.get_elem_index_uint=function(){return r("OES_element_index_uint")};a.get_standard_derivatives=function(){return r("OES_standard_derivatives")};a.cleanup=function(){b={}}};b4w.module.__graph=function(a,q){function r(a,b,L){L||(L=null);if(c(a,b))throw"Graph already has node with given ID";a.nodes.push(b,L)}function c(a,b){for(var c=a.nodes,d=0;d<c.length;d+=2)if(c[d]==b)return!0;return!1}function d(a,b,L,d){d||(d=null);if(c(a,b)&&c(a,L))a.edges.push(b,L,d);else throw"Wrong node IDs";}function b(a,b){if(!c(a,b))throw"Node not found";for(var L=a.nodes,d=0;d<L.length;d+=2)L[d]==b&&(L.splice(d,2),d-=2)}function l(a){a=a.nodes;for(var b=-1,c=0;c<a.length;c+=2)b=Math.max(b,
a[c]);return++b}function h(a,b){for(var c=a.nodes,d=0;d<c.length;d+=2)if(c[d+1]==b)return c[d];return-1}function e(a){var b=[],c={};k(a,c);for(var d=a.nodes,f=0;f<d.length;f+=2)0==n(a,d[f])&&g(a,d[f],c,b);return{nodes:b,edges:a.edges.slice(0)}}function k(a,b){for(var c=a.nodes,d=0;d<c.length;d+=2)b[c[d]]=!1}function g(a,b,c,d){if(!c[b]){c[b]=!0;for(var v=0;v<E(a,b);v++){var e=t(a,b,v);g(a,e,c,d)}d.unshift(b,f(a,b))}}function y(a,b,c,d){if(!c[b]){c[b]=!0;if(10==d||30==d)for(var f=0;f<E(a,b);f++){var v=
t(a,b,f);y(a,v,c,d)}if(20==d||30==d)for(f=0;f<n(a,b);f++)v=M(a,b,f),y(a,v,c,d)}}function m(a){var b=a.nodes;a=a.edges;for(var c=[],d=[],f=[],v=0;v<b.length;v++)f[b[2*v]]=v,c.push(v,b[2*v+1]);for(v=0;v<a.length;v+=3)d.push(f[a[v]],f[a[v+1]],a[v+2]);return{nodes:c,edges:d}}function s(a,b,c){if(c.core_len==c.n1){for(var d=0,f=0;d<c.n1;d++)-1!=c.core_1[d]&&(a[f]=d,b[f]=c.core_1[d],f++);return!0}if(c.n1>c.n2||c.t1both_len>c.t2both_len||c.t1out_len>c.t2out_len||c.t1in_len>c.t2in_len)return!1;for(var f=
d=-1,e=!1;!e&&x(c,v,d,f);)if(d=v[0],f=v[1],C(c,d,f)){var k;k=c;e={};e.g1=k.g1;e.g2=k.g2;e.node_comp=k.node_comp;e.edge_comp=k.edge_comp;e.n1=k.n1;e.n2=k.n2;e.order=k.order;e.core_len=e.orig_core_len=k.core_len;e.t1in_len=k.t1in_len;e.t1out_len=k.t1out_len;e.t1both_len=k.t1both_len;e.t2in_len=k.t2in_len;e.t2out_len=k.t2out_len;e.t2both_len=k.t2both_len;e.added_node1=-1;e.core_1=k.core_1;e.core_2=k.core_2;e.in_1=k.in_1;e.in_2=k.in_2;e.out_1=k.out_1;e.out_2=k.out_2;e.share_count=k.share_count;k.share_count[0]+=
1;var e=k=e,m=d,K=f,h=e.g1,p=e.g2,g=e.n1,B=e.n2,l=e.core_1,z=e.core_2,y=e.in_1,r=e.in_2,D=e.out_1,I=e.out_2;A(m<g);A(K<B);A(e.core_len<g);A(e.core_len<B);g=++e.core_len;e.added_node1=m;y[m]||(y[m]=g,e.t1in_len++,D[m]&&e.t1both_len++);D[m]||(D[m]=g,e.t1out_len++,y[m]&&e.t1both_len++);r[K]||(r[K]=g,e.t2in_len++,I[K]&&e.t2both_len++);I[K]||(I[K]=g,e.t2out_len++,r[K]&&e.t2both_len++);l[m]=K;z[K]=m;for(l=0;l<n(h,m);l++)z=M(h,m,l),y[z]||(y[z]=g,e.t1in_len++,D[z]&&e.t1both_len++);for(l=0;l<E(h,m);l++)z=
t(h,m,l),D[z]||(D[z]=g,e.t1out_len++,y[z]&&e.t1both_len++);for(l=0;l<n(p,K);l++)z=M(p,K,l),r[z]||(r[z]=g,e.t2in_len++,I[z]&&e.t2both_len++);for(l=0;l<E(p,K);l++)z=t(p,K,l),I[z]||(I[z]=g,e.t2out_len++,r[z]&&e.t2both_len++);e=s(a,b,k);A(1>=k.core_len-k.orig_core_len);A(-1!=k.added_node1);z=k.g1;m=k.g2;K=k.core_len;h=k.added_node1;p=k.core_1;y=k.core_2;g=k.in_1;r=k.in_2;B=k.out_1;D=k.out_2;if(k.orig_core_len<K){g[h]==K&&(g[h]=0);for(I=0;I<n(z,h);I++)l=M(z,h,I),g[l]==K&&(g[l]=0);B[h]==K&&(B[h]=0);for(I=
0;I<E(z,h);I++)l=t(z,h,I),B[l]==K&&(B[l]=0);z=p[h];r[z]==K&&(r[z]=0);for(I=0;I<n(m,z);I++)l=M(m,z,I),r[l]==K&&(r[l]=0);D[z]==K&&(D[z]=0);for(I=0;I<E(m,z);I++)l=t(m,z,I),D[l]==K&&(D[l]=0);p[h]=-1;y[z]=-1;k.core_len=k.orig_core_len;k.added_node1=-1}}return e}function x(a,b,c,d){-1==c&&(c=0);-1==d?d=0:d++;var f=a.t1both_len,v=a.t2both_len,e=a.t1out_len,k=a.t2out_len,n=a.t1in_len,t=a.t2in_len,p=a.core_len,m=a.n1,K=a.n2,h=a.core_1,s=a.core_2,g=a.in_1,B=a.in_2,l=a.out_1,I=a.out_2;if(f>p&&v>p)for(;c<m&&
(-1!=h[c]||0==l[c]||0==g[c]);)c++,d=0;else if(e>p&&k>p)for(;c<m&&(-1!=h[c]||0==l[c]);)c++,d=0;else if(n>p&&t>p)for(;c<m&&(-1!=h[c]||0==g[c]);)c++,d=0;else if(0==c&&0!=a.order){for(g=0;g<m&&-1!=h[c=a.order[g]];)g++;g==m&&(c=m)}else for(;c<m&&-1!=h[c];)c++,d=0;if(f>p&&v>p)for(;d<K&&(-1!=s[d]||0==I[d]||0==B[d]);)d++;else if(e>p&&k>p)for(;d<K&&(-1!=s[d]||0==I[d]);)d++;else if(n>p&&t>p)for(;d<K&&(-1!=s[d]||0==B[d]);)d++;else for(;d<K&&-1!=s[d];)d++;return c<m&&d<K?(b[0]=c,b[1]=d,!0):!1}function C(a,b,
c){var d=a.g1,v=a.g2,e=a.n2,k=a.core_1,m=a.core_2,K=a.in_1,h=a.in_2,p=a.out_1,s=a.out_2;A(b<a.n1);A(c<e);A(-1==k[b]);A(-1==m[c]);e=(0,a.node_comp)(f(d,b),f(v,c))?!0:!1;if(!e)return!1;for(var g=e=0,B=0,l=0,x=0,y=0,D=0;D<E(d,b);D++){var I=t(d,b,D);if(-1!=k[I]){var ia=k[I];if(!S(v,c,ia)||!z(a.edge_comp,d,b,I,v,c,ia))return!1}else K[I]&&B++,p[I]&&e++,K[I]||p[I]||x++}for(D=0;D<n(d,b);D++)if(I=M(d,b,D),-1!=k[I]){if(ia=k[I],!S(v,ia,c)||!z(a.edge_comp,d,I,b,v,ia,c))return!1}else K[I]&&B++,p[I]&&e++,K[I]||
p[I]||x++;for(D=0;D<E(v,c);D++)if(ia=t(v,c,D),-1!=m[ia]){if(I=m[ia],!S(d,b,I))return!1}else h[ia]&&l++,s[ia]&&g++,h[ia]||s[ia]||y++;for(D=0;D<n(v,c);D++)if(ia=M(v,c,D),-1!=m[ia]){if(I=m[ia],!S(d,I,b))return!1}else h[ia]&&l++,s[ia]&&g++,h[ia]||s[ia]||y++;return B<=l&&e<=g&&x<=y}function A(a){if(!a)throw"Assertion failed";}function f(a,b){for(var c=a.nodes,d=0;d<c.length;d+=2)if(c[d]==b)return c[d+1];return null}function E(a,b){for(var c=a.edges,d=0,f=0;f<c.length;f+=3)c[f]==b&&d++;return d}function n(a,
b){for(var c=a.edges,d=0,f=0;f<c.length;f+=3)c[f+1]==b&&d++;return d}function t(a,b,c){a=a.edges;for(var d=0,f=0;f<a.length;f+=3)if(a[f]==b){if(d==c)return a[f+1];d++}return-1}function M(a,b,c){a=a.edges;for(var d=0,f=0;f<a.length;f+=3)if(a[f+1]==b){if(d==c)return a[f];d++}return-1}function S(a,b,c){a=a.edges;for(var d=0;d<a.length;d+=3)if(a[d]==b&&a[d+1]==c)return!0;return!1}function z(a,b,c,d,f,v,e){for(var k=B(b,c,d),n=B(f,v,e),m=0;m<k;m++){for(var p=!1,t=0;t<n;t++)if(a(K(b,c,d,m),K(f,v,e,t))){p=
!0;break}if(!p)return!1}return!0}function B(a,b,c){var d=0;a=a.edges;for(var f=0;f<a.length;f+=3)a[f]==b&&a[f+1]==c&&d++;return d}function K(a,b,c,d){a=a.edges;for(var f=0,v=0;v<a.length;v+=3)if(a[v]==b&&a[v+1]==c){if(f==d)return a[v+2];f++}return null}var v=[-1,-1];a.NULL_NODE=-1;a.FORWARD_DIR=10;a.BACKWARD_DIR=20;a.TWO_WAY=30;a.create=function(){for(var a=arguments,b=[],c=[],d=0;d<a.length;d++){var f=a[d];switch(f.length){case 2:b.push(f[0],f[1]);break;case 3:c.push(f[0],f[1],f[2]);break;default:throw"Wrong graph constructor params";
}}return{nodes:b,edges:c}};a.create_node_edge_arr=function(a,b){for(var c=[],d=[],f=0;f<a.length;f++)c.push(a[f][0],a[f][1]);for(f=0;f<b.length;f++)d.push(b[f][0],b[f][1],b[f][2]);return{nodes:c,edges:d}};a.append_node=r;a.has_node=c;a.append_edge=d;a.remove_node=b;a.remove_edge=function(a,b,c,d){if(!S(a,b,c))throw"Edge not found";a=a.edges;for(var f=0,v=0;v<a.length;v+=3)if(a[v]==b&&a[v+1]==c){if(-1==d)a.splice(v,3);else{if(d==f){a.splice(v,3);break}f++}v-=3}};a.append_node_attr=function(a,b){if(-1==
h(a,b))r(a,l(a),b);else throw"Non-unique attribute";};a.replace_edge_attr=function(a,b,c,d,f){a=a.edges;for(var v=0;v<a.length;v+=3)a[v]==b&&a[v+1]==c&&a[v+2]==d&&(a[v+2]=f)};a.gen_node_id=l;a.node_by_attr=h;a.append_edge_attr=function(a,b,c,f){b=h(a,b);c=h(a,c);if(-1!=b&&-1!=c)d(a,b,c,f);else throw"Attributes not found";};a.traverse=function(a,b){for(var c=a.nodes,d=0;d<c.length&&!b(c[d],c[d+1]);d+=2);};a.traverse_edges=function(a,b){for(var c=a.edges,d=0;d<c.length&&!b(c[d],c[d+1],c[d+2]);d+=3);
};a.traverse_inputs=function(a,b,c){for(var d=a.edges,v=0;v<d.length;v+=3)if(d[v+1]==b){var e=d[v];if(c(e,f(a,e),d[v+2]))break}};a.traverse_outputs=function(a,b,c){for(var d=a.edges,v=0;v<d.length;v+=3)if(d[v]==b){var e=d[v+1];if(c(e,f(a,e),d[v+2]))break}};a.topsort=e;a.topsort_attr=function(a){a=e(a).nodes;for(var b=[],c=0;c<a.length;c+=2)b.push(a[c+1]);return b};a.is_connected=function(a){};a.subgraph_node_conn=function(a,b,d){if(!c(a,b))throw"No such node";var v={};k(a,v);y(a,b,v,d);b=[];for(var e in v)v[e]&&
(e=Number(e),b.push(e,f(a,e)));a={nodes:b,edges:a.edges.slice(0)};v=a.edges;for(e=0;e<v.length;e+=3)b=v[e+1],c(a,v[e])&&c(a,b)||(v.splice(e,3),e-=3);return a};a.get_source_nodes=function(a){for(var b=[],c=a.nodes,d=0;d<c.length;d+=2){var f=c[d];n(a,f)||b.push(f)}return b};a.get_sink_nodes=function(a){for(var b=[],c=a.nodes,d=0;d<c.length;d+=2){var f=c[d];E(a,f)||b.push(f)}return b};a.match=function(a,b,c,d){var f={};f.g1=m(a);f.g2=m(b);f.node_comp=c||function(a,b){return a==b};f.edge_comp=d||function(a,
b){return a==b};d=a.nodes.length/2;var v=b.nodes.length/2;f.n1=d;f.n2=v;f.order=0;f.core_len=f.orig_core_len=0;f.t1both_len=f.t1in_len=f.t1out_len=0;f.t2both_len=f.t2in_len=f.t2out_len=0;f.added_node1=-1;f.core_1=Array(d);f.core_2=Array(v);f.in_1=Array(d);f.in_2=Array(v);f.out_1=Array(d);f.out_2=Array(v);f.share_count=[1];for(c=0;c<d;c++)f.core_1[c]=-1,f.in_1[c]=0,f.out_1[c]=0;for(c=0;c<v;c++)f.core_2[c]=-1,f.in_2[c]=0,f.out_2[c]=0;v=Array(d);d=Array(d);if(s(v,d,f)){for(c=0;c<v.length;c++)v[c]=a.nodes[2*
v[c]],d[c]=b.nodes[2*d[c]];return[v,d]}return null};a.get_node_attr=f;a.out_edge_count=E;a.in_edge_count=n;a.get_out_edge=t;a.get_in_edge=M;a.get_edge_count=B;a.get_edge_attr=K;a.replace=function(a,c,d){for(var f=a.edges,v=l(a),e=0;e<c.length;e++){var k=c[e];b(a,k);for(var n=0;n<f.length;n+=3)f[n]==k&&(f[n]=v),f[n+1]==k&&(f[n+1]=v),f[n]==f[n+1]&&(f.splice(n,3),n-=3)}r(a,v,d)};a.debug_dot=function(a,b){var c=a.nodes,d=a.edges,f;f="digraph debug {\n    node [shape=box];\n";for(var v=0;v<c.length;v+=
2){var e=c[v],k=c[v+1],k=b?b(e,k):String(e);f+="    ";f+=String(e)+' [label="'+k.replace(/\"/g,'\\"')+'"];\n'}for(v=0;v<d.length;v+=3)c=d[v],e=d[v+1],f+="    ",f+=String(c)+" -> "+String(e)+";\n";return f+="}"}};b4w.module.__scenegraph=function(a,q){function r(a){a=Ya.clone_object_r(a);a.framebuffer=null;a.color_attachment=null;a.depth_attachment=null;return a}function c(a,c){var w=[];R.traverse_edges(a,function(b,c,d){-1<w.indexOf(d)?R.replace_edge_attr(a,b,c,d,l(d)):w.push(d)});R.traverse(a,function(b,c){for(var d=0;d<c.slinks_internal.length;d++){var f=c.slinks_internal[d];-1<w.indexOf(f)?c.slinks_internal[d]=l(f):w.push(f)}"ANTIALIASING"==c.type&&R.traverse_inputs(a,b,function(a,b,c){if("MOTION_BLUR"==
b.type)for(a=0;a<b.slinks_internal.length;a++)c=b.slinks_internal[a],c.min_filter=aa.TF_LINEAR,c.mag_filter=aa.TF_LINEAR})});R.traverse(a,function(w,f){var I={};d(a,w,I);for(var v in I){var e=I[v];if(c)for(var L=0;L<e.length;L++){var H=e[L];if("DEPTH"==H.from){if(b(H))throw"Failed to use renderbuffer as input texture: "+H.from+"->"+H.to;H.use_renderbuffer=!0}}H=e[0];for(L=0;L<e.length;L++)if(e[L].min_filter==aa.TF_LINEAR){H=e[L];break}for(var k=e[0],L=0;L<e.length;L++)if(e[L].mag_filter==aa.TF_LINEAR){k=
e[L];break}for(var p=e[0],L=0;L<e.length;L++)if(!e[L].use_renderbuffer){p=e[L];break}for(L=0;L<e.length;L++)e[L].min_filter=H.min_filter,e[L].mag_filter=k.mag_filter,e[L].use_renderbuffer=p.use_renderbuffer}})}function d(a,b,c){R.traverse_inputs(a,b,function(b,w,f){f.active&&f.from==f.to&&(c[f.from]=c[f.from]||[],-1==c[f.from].indexOf(f)&&c[f.from].push(f),d(a,b,c))});R.traverse_outputs(a,b,function(a,b,w){w.active&&(c[w.from]=c[w.from]||[],-1==c[w.from].indexOf(w)&&c[w.from].push(w))});b=R.get_node_attr(a,
b);if("MOTION_BLUR"==b.type)for(var w=0;w<b.slinks_internal.length;w++){var f=b.slinks_internal[w];c[f.from].push(f)}}function b(a){switch(a.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "SCREEN":case "NONE":return!1;default:return!0}}function l(a){if(a.texture)throw"Failed to clone slink with attached texture";return Ya.clone_object_json(a)}function h(a){var b=R.topsort(a),c=[];R.traverse(b,function(a,w){switch(w.type){case "MOTION_BLUR":case "SMAA_RESOLVE":case "SMAA_NEIGHBORHOOD_BLENDING":case "MAIN_REFLECT":var d=
[];break;default:d=c}for(var f=0;f<w.slinks_internal.length;f++){var I=w.slinks_internal[f],v=m(d,I,k(I));I.texture=v;w.textures_internal[f]=v}for(f=0;f<w.textures_internal.length;f++)v=w.textures_internal[f],y(d,v);switch(w.type){case "MOTION_BLUR":case "SMAA_RESOLVE":case "SMAA_NEIGHBORHOOD_BLENDING":case "MAIN_REFLECT":d=[]}R.traverse_outputs(b,a,function(c,w,f){if((c=g(b,a,f.from))&&f.active&&!f.texture){w=d;for(var I=c,v=0;v<w.length;v++){var e=w[v];e.tex===I&&e.ref++}}else c=m(d,f,k(f));f.texture=
c});R.traverse_inputs(b,a,function(a,b,c){y(d,c.texture)});R.traverse_outputs(b,a,function(a,b,c){c.texture&&"NONE"==c.to&&y(d,c.texture)})})}function e(a){x(a,function(b,c,w,d){b.update_dim&&(ka(a,w,"SMAA_NEIGHBORHOOD_BLENDING")&&"SMAA_NEIGHBORHOOD_BLENDING"!=w.type||ka(a,w,"ANTIALIASING"))&&(b.size_mult*=bb.resolution_factor)})}function k(a){a=Ya.clone_object_json(a);delete a.to;delete a.active;return JSON.stringify(a)}function g(a,b,c){var w=null;R.traverse_inputs(a,b,function(a,b,d){if(d.active&&
d.from==d.to&&d.from==c&&d.texture)return w=d.texture,!0});R.traverse_outputs(a,b,function(a,b,d){if(d.active&&d.from==c&&d.texture)return w=d.texture,!0});return w}function y(a,b){for(var c=0;c<a.length;c++){var w=a[c];w.tex===b&&w.ref&&w.ref--}}function m(a,b,c){for(var w=null,d=0;d<a.length;d++){var f=a[d];if(f.id==c&&0===f.ref){w=f;break}}if(w)return w.ref++,w.tex;b=s(b);a.push({id:c,ref:1,tex:b});return b}function s(a){var b=a.size_mult*a.size;switch(a.from){case "COLOR":var c=aa.create_texture("COLOR",
aa.TT_RGBA_INT);aa.resize(c,b,b);aa.set_filters(c,a.min_filter,a.mag_filter);return c;case "DEPTH":return a.use_renderbuffer?(c=aa.create_texture("DEPTH_RBUF",aa.TT_RENDERBUFFER),aa.resize(c,b,b)):(c=aa.create_texture("DEPTH_TEX",aa.TT_DEPTH),aa.resize(c,b,b),aa.set_filters(c,a.min_filter,a.mag_filter)),c;case "CUBEMAP":return c=aa.create_cubemap_texture("CUBEMAP",b);case "SCREEN":return null;default:throw"Wrong slink param: "+a.from;}}function x(a,b){var c=!1;R.traverse_edges(a,function(w,d,f){if(f&&
(w=R.get_node_attr(a,w),d=R.get_node_attr(a,d),b(f,!1,w,d)))return c=!0});c||R.traverse(a,function(a,c){for(var w=0;w<c.slinks_internal.length;w++)if(b(c.slinks_internal[w],!0,c,null))return!0})}function C(a){R.traverse(a,function(b,c){if("SINK"!=c.type){var w=c.camera;R.traverse_outputs(a,b,function(a,b,c){c.active&&c.texture&&(ca.set_attachment(w,c.from,c.texture),c.from==c.to&&b.camera&&ca.set_attachment(b.camera,c.from,c.texture))});for(var d=0;d<c.slinks_internal.length;d++){var f=c.slinks_internal[d];
f.active&&f.from==f.to&&ca.set_attachment(w,f.from,c.textures_internal[d])}!w.color_attachment&&!w.depth_attachment||w.framebuffer||(w.framebuffer=ta.render_target_create(w.color_attachment,w.depth_attachment))}})}function A(a,b){var c=f("SHADOW_CAST");c.csm_index=a;c.self_shadow_polygon_offset=b.self_shadow_polygon_offset;c.camera=ca.create_camera(ca.TYPE_ORTHO_ASYMMETRIC);return c}function f(a){return{type:a,blend:!1,pack:!1,assign_texture:!1,need_fog_update:!1,debug_render_calls:0,time:0,camera:null,
cube_view_matrices:null,reflection_plane:null,bundles:[],slinks_internal:[],textures_internal:[],wind:new Float32Array(3),zsort_eye_last:new Float32Array(3),grass_map_dim:new Float32Array(3),fog_color_density:new Float32Array(4),cube_fog:new Float32Array(16),environment_energy:0,num_lights:0,shadow_lamp_id:0,light_directions:null,light_positions:null,light_color_intensities:null,light_factors1:null,light_factors2:null,horizon_color:new Float32Array(3),zenith_color:new Float32Array(3),sun_intensity:new Float32Array([0,
0,0]),sun_direction:new Float32Array(3),sun_quaternion:new Float32Array(4),sky_texture_slots:null,glow_factor:0,draw_glow_flag:0,is_for_glow:!1,glow_color:new Float32Array(3),water:0,water_params:null,use_shoremap:!1,shoremap_center:new Float32Array(2),shoremap_size:new Float32Array(2),shoremap_tex_size:0,max_shore_dist:0,cam_water_depth:0,water_fog_color_density:null,water_waves_height:0,water_waves_length:0,water_level:0,caustics:!1,caust_scale:0,caust_speed:new Float32Array(2),caust_brightness:0,
procedural_skydome:!1,use_as_environment_lighting:!1,mie_brightness:0,rayleigh_brightness:0,spot_brightness:0,mie_strength:0,rayleigh_strength:0,scatter_strength:0,mie_collection_power:0,rayleigh_collection_power:0,mie_distribution:0,sky_color:new Float32Array(3),ssao_hemisphere:0,ssao_blur_depth:0,ssao_blur_discard_value:0,ssao_radius_increase:0,ssao_influence:0,ssao_dist_factor:0,ssao_samples:0,ssao_only:0,ssao_white:0,brightness:0,contrast:0,exposure:0,saturation:0,god_rays_intensity:0,max_ray_length:0,
radial_blur_step:0,steps_per_pass:0,csm_index:0,self_shadow_polygon_offset:0,self_shadow_normal_offset:0,v_light_matrix:null,b_light_matrix:null,p_light_matrix:null,bloom_key:0,bloom_blur:0,bloom_edge_lum:0,blur_texel_size_mult:0,ext_texel_size_mult:0,mb_decay_threshold:0,mb_factor:0,motion_blur_exp:0,pp_effect:"",jitter_projection_space:new Float32Array(2),do_render:!0,enqueue:!0,clear_color:!0,clear_depth:!0,depth_test:!0,need_perm_uniforms_update:!0}}function E(a,b,c,w,d){return{from:a,to:b,size:c,
size_mult:w,update_dim:d,active:!0,texture:null,use_renderbuffer:!1,min_filter:aa.TF_NEAREST,mag_filter:aa.TF_NEAREST}}function n(){var a=f("GRASS_MAP");a.camera=ca.create_camera(ca.TYPE_ORTHO_ASPECT);return a}function t(a){var b=f("POSTPROCESSING");b.clear_color=!1;b.clear_depth=!1;b.depth_test=!1;b.camera=ca.create_camera(ca.TYPE_NONE);b.pp_effect=a;return b}function M(a,b,c){a=f("BLOOM_BLUR");a.clear_color=!1;a.clear_depth=!1;a.depth_test=!1;a.camera=ca.create_camera(ca.TYPE_NONE);a.pp_effect=
c;return a}function S(a,b,c,w,d,I,v,e,L){var H=f("MAIN_"+a);if("OPAQUE"===a)H.clear_color=!0,H.clear_depth=c,H.blend=!1;else if("BLEND"===a)H.clear_color=!1,H.clear_depth=!1,H.blend=!0;else if("XRAY"===a)H.clear_color=!1,H.clear_depth=!0,H.blend=!0;else if("REFLECT"===a)H.clear_color=!0,H.clear_depth=!0,H.blend=!1;else throw"wrong main subscene type";H.blend&&e&&(H.self_shadow_normal_offset=e.self_shadow_normal_offset);H.camera=b;H.horizon_color.set(v.horizon_color);H.zenith_color.set(v.zenith_color);
H.environment_energy=v.environment_energy;H.sky_texture_slots=v.sky_texture_slots;H.fog_color_density=I;w&&(H.water_params=w,w.fog_color_density&&(H.water_fog_color_density=new Float32Array(w.fog_color_density)),H.water_waves_height=w.waves_height,H.water_waves_length=w.waves_length,H.water_level=w.water_level,w.caustic_scale&&L&&(H.caustics=!0,H.caust_scale=w.caustic_scale,H.caust_speed.set(w.caustic_speed),H.caust_brightness=w.caustic_brightness),w.shoremap_image&&(H.use_shoremap=!0,a=w.shore_boundings,
H.shoremap_center[0]=(a[0]+a[1])/2,H.shoremap_center[1]=(a[2]+a[3])/2,H.shoremap_size[0]=a[0]-a[1],H.shoremap_size[1]=a[2]-a[3],H.shoremap_tex_size=w.shoremap_tex_size,H.max_shore_dist=w.max_shore_dist));H.light_directions=new Float32Array(3*d);H.light_positions=new Float32Array(3*d);H.light_color_intensities=new Float32Array(3*d);H.light_factors1=new Float32Array(4*d);H.light_factors2=new Float32Array(4*d);return H}function z(a,b){var c=f("COLOR_PICKING");b&&(c.type+="_XRAY",c.clear_color=!1,c.clear_depth=
!0);c.enqueue=!1;c.camera=a;return c}function B(a){var b=f("WIREFRAME");b.do_render=!1;b.clear_color=!1;b.clear_depth=!1;b.camera=a;return b}function K(a,b,c){a=f("DEPTH");a.camera=b;a.self_shadow_normal_offset=c.self_shadow_normal_offset;return a}function v(a){var b=f("DEPTH_PACK");b.clear_color=!1;b.clear_depth=!1;b.camera=a;return b}function Q(a,b,c){var w=f("SSAO");w.clear_color=!1;w.clear_depth=!1;w.depth_test=!1;w.camera=a;w.fog_color_density=b;w.water_fog_color_density=new Float32Array(b);
w.ssao_radius_increase=c.radius_increase;w.ssao_hemisphere=c.hemisphere;w.ssao_influence=c.influence;w.ssao_dist_factor=c.dist_factor;w.ssao_samples=c.samples;return w}function O(a,b){var c=f("SSAO_BLUR");c.clear_color=!1;c.clear_depth=!1;c.depth_test=!1;c.ssao_blur_depth=b.blur_depth;c.ssao_blur_discard_value=b.blur_discard_value;c.camera=a;return c}function L(){var a=f("ANTIALIASING");a.clear_color=!1;a.clear_depth=!1;a.depth_test=!1;a.camera=ca.create_camera(ca.TYPE_NONE);return a}function G(a){var b=
f(a);b.clear_color="SMAA_BLENDING_WEIGHT_CALCULATION"==a||"SMAA_EDGE_DETECTION"==a?!0:!1;b.clear_depth=!1;b.depth_test=!1;b.camera=ca.create_camera(ca.TYPE_NONE);"SMAA_BLENDING_WEIGHT_CALCULATION"==a&&(b.jitter_subsample_ind=new Float32Array(4));return b}function V(a,b,c,w){var d=f("COMPOSITING");d.clear_color=!1;d.clear_depth=!1;d.depth_test=!1;d.camera=ca.create_camera(ca.TYPE_NONE);d.brightness=a;d.contrast=b;d.exposure=c;d.saturation=w;return d}function $(a,b){var c=f("MOTION_BLUR");c.clear_color=
!1;c.clear_depth=!1;c.depth_test=!1;c.camera=ca.create_camera(ca.TYPE_NONE);c.assign_texture=!0;c.mb_decay_threshold=a;c.mb_factor=b;return c}function P(a){var b=f("DOF");b.clear_color=!1;b.clear_depth=!1;b.depth_test=!1;b.camera=a;return b}function Y(a){var b=f("GLOW_MASK");b.camera=a;b.depth_test=!1;return b}function T(a){var b=f("GLOW");b.glow_color.set(a.glow_color);b.glow_factor=a.glow_factor;b.ext_texel_size_mult=5;b.blur_texel_size_mult=3;b.depth_test=!1;b.camera=ca.create_camera(ca.TYPE_NONE);
return b}function X(){var a=f("REFRACT");a.clear_color=!1;a.clear_depth=!1;a.depth_test=!1;a.camera=ca.create_camera(ca.TYPE_NONE);return a}function p(a,b,c,w,d,I,v){var e=f("GOD_RAYS");e.clear_color=!1;e.clear_depth=!1;e.depth_test=!1;e.horizon_color[0]=1;e.horizon_color[1]=1;e.horizon_color[2]=1;e.zenith_color[0]=1;e.zenith_color[1]=1;e.zenith_color[2]=1;e.environment_energy=1;e.pack=w;e.water=b;e.radial_blur_step=d;e.max_ray_length=c;e.steps_per_pass=v;e.camera=a;e.num_lights=I;e.light_directions=
new Float32Array(3*I);e.light_positions=new Float32Array(3*I);e.light_color_intensities=new Float32Array(3*I);e.light_factors1=new Float32Array(4*I);e.light_factors2=new Float32Array(4*I);return e}function ga(a,b){var c=f("GOD_RAYS_COMBINE");c.clear_color=!1;c.clear_depth=!1;c.depth_test=!1;c.camera=ca.create_camera(ca.TYPE_NONE);c.god_rays_intensity=a;c.num_lights=b;c.light_directions=new Float32Array(3*b);c.light_positions=new Float32Array(3*b);c.light_color_intensities=new Float32Array(3*b);c.light_factors1=
new Float32Array(4*b);c.light_factors2=new Float32Array(4*b);return c}function Z(a,b){var c=f("SKY");c.enqueue=!1;c.clear_color=!1;c.clear_depth=!1;c.depth_test=!1;var w=ca.create_camera(ca.TYPE_NONE);w.width=Aa.cubemap_tex_size;w.height=Aa.cubemap_tex_size;c.camera=w;c.cube_view_matrices=Ya.generate_cubemap_matrices();c.num_lights=a;c.light_directions=new Float32Array(3*a);c.light_positions=new Float32Array(3*a);c.light_color_intensities=new Float32Array(3*a);c.light_factors1=new Float32Array(4*
a);c.light_factors2=new Float32Array(4*a);c.horizon_color[0]=1;c.horizon_color[1]=1;c.horizon_color[2]=1;c.zenith_color[0]=1;c.zenith_color[1]=1;c.zenith_color[2]=1;c.environment_energy=1;c.sky_color.set(b.sky_color);c.procedural_skydome=b.procedural_skydome;c.use_as_environment_lighting=b.use_as_environment_lighting;c.rayleigh_brightness=b.rayleigh_brightness;c.mie_brightness=b.mie_brightness;c.spot_brightness=b.spot_brightness;c.scatter_strength=b.scatter_strength;c.rayleigh_strength=b.rayleigh_strength;
c.mie_strength=b.mie_strength;c.rayleigh_collection_power=b.rayleigh_collection_power;c.mie_collection_power=b.mie_collection_power;c.mie_distribution=b.mie_distribution;return c}function N(){var a=f("SCREEN");a.clear_color=!1;a.clear_depth=!1;a.camera=ca.create_camera(ca.TYPE_NONE);return a}function F(){var a=f("ANAGLYPH");a.clear_color=!1;a.clear_depth=!1;a.camera=ca.create_camera(ca.TYPE_NONE);return a}function ha(){var a=f("LUMINANCE");a.clear_color=!1;a.clear_depth=!1;a.camera=ca.create_camera(ca.TYPE_NONE);
return a}function ea(){var a=f("AVERAGE_LUMINANCE");a.clear_color=!1;a.clear_depth=!1;a.camera=ca.create_camera(ca.TYPE_NONE);return a}function D(a,b,c,w){var d=f("LUMINANCE_TRUNCED");d.clear_color=!1;d.clear_depth=!1;d.bloom_key=a;d.bloom_edge_lum=b;d.camera=w;d.light_directions=new Float32Array(3*c);d.light_positions=new Float32Array(3*c);d.light_color_intensities=new Float32Array(3*c);d.light_factors1=new Float32Array(4*c);d.light_factors2=new Float32Array(4*c);return d}function I(a){var b=f("BLOOM");
b.clear_color=!1;b.clear_depth=!1;b.camera=ca.create_camera(ca.TYPE_NONE);b.bloom_blur=a;return b}function ia(){var a=f("SINK");a.enqueue=!1;return a}function ka(a,b,c){if(b.type===c)return!0;b=w(a,b);for(var d=0;d<b.length;d++)if(ka(a,b[d],c))return!0;return!1}function qa(a,b,c){if(b.type===c)return!0;b=fa(a,b);for(var w=0;w<b.length;w++)if(qa(a,b[w],c))return!0;return!1}function H(a,b,c){if(b.type===c)return b;b=fa(a,b);for(var w=0;w<b.length;w++){var d=H(a,b[w],c);if(d)return d}return null}function fa(a,
b){var c=R.node_by_attr(a,b);if(c==R.NULL_NODE)throw"Subscene not in graph";for(var w=[],d=R.in_edge_count(a,c),f=0;f<d;f++){var I=R.get_in_edge(a,c,f);I!=c&&w.push(R.get_node_attr(a,I))}return w}function w(a,b){var c=R.node_by_attr(a,b);if(c==R.NULL_NODE)throw"Subscene not in graph";for(var w=[],d=R.out_edge_count(a,c),f=0;f<d;f++){var I=R.get_out_edge(a,c,f);I!=c&&w.push(R.get_node_attr(a,I))}return w}function ja(a){var b=[],c=[];x(a,function(a,w,d,f){a.texture&&-1==b.indexOf(a.texture)&&(b.push(a.texture),
c.push(a.texture,b.length-1))});return c}function oa(a,b,c,w){b=""+(a.from+"\\n");b+="NONE"!=a.to?a.to+"\\n":"";b+="(";a.update_dim?(c=a.size_mult,Math.round(c)!=c&&(c=c.toFixed(2)),c=(1==c?"":c)+"S",b+=c+"x"+c):b+=a.size+"x"+a.size;if("SCREEN"!=a.from){b+=" ";if(a.use_renderbuffer)b+="RR";else{c=a.min_filter;var d=a.mag_filter,f="";c==aa.TF_LINEAR?f+="L":c==aa.TF_NEAREST&&(f+="N");d==aa.TF_LINEAR?f+="L":d==aa.TF_NEAREST&&(f+="N");b+=f}for(c=0;c<w.length;c+=2)w[c]==a.texture&&(b+=" "+w[c+1])}return b+
")\\n"}var ca=q("__camera"),qb=q("__config"),ma=q("__debug"),R=q("__graph"),ta=q("__renderer"),aa=q("__textures"),Ya=q("__util");q("vec4");var na=qb.debug_subs,bb=qb.defaults,Aa=qb.scenes;a.create_rendering_graph_compat=function(a,b){var w=R.create(),d=a.cameras[0],f=b.lamps_number,I=b.world_light_set,v=b.fog_color_density,H=b.water_params,L=S("OPAQUE",d,!0,H,f,v,I,null,b.sun_exist);R.append_node_attr(w,L);var k=S("BLEND",d,!0,H,f,v,I,null,null,b.sun_exist);R.append_node_attr(w,k);R.append_edge_attr(w,
L,k,E("SCREEN","NONE",1,1,!0));if(b.xray){var p=S("XRAY",d,!1,H,f,v,I,null,b.sun_exist);R.append_node_attr(w,p);R.append_edge_attr(w,k,p,E("SCREEN","NONE",1,1,!0))}I=ia();R.append_node_attr(w,I);bb.wireframe_debug?(d=B(d),R.append_node_attr(w,d),b.xray?R.append_edge_attr(w,p,d,E("SCREEN","NONE",1,1,!0)):R.append_edge_attr(w,k,d,E("SCREEN","NONE",1,1,!0)),R.append_edge_attr(w,d,I,E("SCREEN","NONE",1,1,!0))):R.append_edge_attr(w,k,I,E("SCREEN","NONE",1,1,!0));b.color_picking&&(d=r(L.camera),a.cameras.push(d),
k=z(d,!1),R.append_node_attr(w,k),b.xray?(d=r(L.camera),a.cameras.push(d),L=z(d,!0),R.append_node_attr(w,L),d=E("COLOR","COLOR",1,1,!0),R.append_edge_attr(w,k,L,d),R.append_edge_attr(w,L,I,E("COLOR","NONE",1,1,!0)),R.append_edge_attr(w,L,I,E("DEPTH","NONE",1,1,!0))):(R.append_edge_attr(w,k,I,E("COLOR","NONE",1,1,!0)),R.append_edge_attr(w,k,I,E("DEPTH","NONE",1,1,!0))));b.sky_params.procedural_skydome&&(f=Z(f,b.sky_params),R.append_node_attr(w,f),L=E("CUBEMAP","u_sky",Aa.cubemap_tex_size,1,!1),R.append_edge_attr(w,
f,I,L));c(w,!0);1<bb.resolution_factor&&e(w);h(w);C(w);return w};a.check_slink_tex_conn=b;a.traverse_slinks=x;a.create_rendering_graph=function(a,b,w){var d=R.create(),f=[],H=[],k=[],m=[],s=[],g=[],l=[],ja=[],x=[],y=[],fa=[],oa=b.lamps_number,ka=b.water_params,qa=b.render_shadows,q=b.ssao,ta=b.god_rays,qb=b.materials_params,wb=b.refl_planes,td=b.bloom,qd=b.motion_blur,rd=b.compositing,sd=b.antialiasing,xb=b.world_light_set,rb=b.fog_color_density,Db=b.shadow_params,rc=b.mb_params,jd=b.bloom_params,
Kc=b.cc_params,Uc=b.god_rays_params,sc=b.glow_params,cd=b.dof,Ga=[];if(b.anaglyph_use&&!a){var yb=w.cameras[0],pb=r(yb);ca.make_stereo(yb,ca.TYPE_STEREO_LEFT);ca.make_stereo(pb,ca.TYPE_STEREO_RIGHT);Ga.push(yb,pb);w.cameras.push(pb)}else{var ya=w.cameras[0];Ga.push(ya)}if(qa){ca.update_camera_shadows(Ga[0],Db);for(var Sa=Db.csm_num,da=0;da<Sa;da++){var Za=A(da,Db);R.append_node_attr(d,Za);y.push(Za);var Eb=Db.csm_resolution,ya=Za.camera;ya.width=Eb;ya.height=Eb;Za.clear_color=!1;fa.push(E("DEPTH",
"u_shadow_map"+da,Eb,1,!1));ma.check_depth_only_issue()&&Za.slinks_internal.push(E("COLOR","COLOR",Eb,1,!1))}}if(0<wb.length&&!a)for(da=0;da<Ga.length;da++){ya=r(Ga[da]);w.cameras.push(ya);var ra=S("REFLECT",ya,!1,ka,oa,rb,xb,null,b.sun_exist);ra.reflection_plane=wb[0];ra.camera.reflection_plane=wb[0];R.append_node_attr(d,ra);g.push(ra);var Pa=E("COLOR","u_reflectmap",1,bb.reflect_multiplier,!0);l.push(Pa);var jc=E("DEPTH","DEPTH",1,bb.reflect_multiplier,!0);ra.slinks_internal.push(jc)}f=[];H=[];
if(b.dynamic_grass){var Ha=n();R.append_node_attr(d,Ha);Eb=Aa.grass_tex_size;Ha.camera.width=Eb;Ha.camera.height=Eb;var Ka=E("DEPTH","u_grass_map_depth",Eb,1,!1);Ka.min_filter=aa.TF_LINEAR;Ka.mag_filter=aa.TF_LINEAR;var eb=E("COLOR","u_grass_map_color",Eb,1,!1);eb.min_filter=aa.TF_LINEAR;eb.mag_filter=aa.TF_LINEAR}else eb=Ka=Ha=null;for(da=0;da<Ga.length;da++){var ya=Ga[da],tc=r(ya);w.cameras.push(tc);if(qa){var sa=K(d,tc,Db);R.append_node_attr(d,sa);for(var Xa=0;Xa<y.length;Xa++){var Za=y[Xa],Oa=
fa[Xa];R.append_edge_attr(d,Za,sa,Oa)}var Ec=E("COLOR","u_color",1,1,!0),kc=E("DEPTH","u_depth",1,1,!0);if(q){var uc=r(ya);w.cameras.push(uc);var vc=b.ssao_params,lb=Q(uc,rb,vc);R.append_node_attr(d,lb);var sb=E("COLOR","u_ssao_mask",1,1,!0);R.append_edge_attr(d,sa,lb,Ec);R.append_edge_attr(d,sa,lb,kc);var Lb=r(ya);w.cameras.push(Lb);var Vb=O(Lb,vc);R.append_node_attr(d,Vb);var tb=E("COLOR","u_shadow_mask",1,1,!0);R.append_edge_attr(d,lb,Vb,sb);R.append_edge_attr(d,sa,Vb,kc)}var Wb=r(tc);w.cameras.push(Wb);
var Mb=v(Wb);R.append_node_attr(d,Mb);R.append_edge_attr(d,sa,Mb,E("DEPTH","u_depth",1,1,!0));k.push(Mb);var Fa=E("DEPTH","DEPTH",1,1,!0);s.push(Fa)}else sa=K(d,tc,Db),R.append_node_attr(d,sa),Fa=E("DEPTH","DEPTH",1,1,!0),s.push(Fa),ma.check_depth_only_issue()&&sa.slinks_internal.push(E("COLOR","COLOR",1,1,!0)),Wb=r(tc),w.cameras.push(Wb),Mb=v(Wb),R.append_node_attr(d,Mb),R.append_edge_attr(d,sa,Mb,E("DEPTH","u_depth",1,1,!0)),k.push(Mb);Ha&&(R.append_edge_attr(d,Ha,sa,Ka),R.append_edge_attr(d,Ha,
sa,eb));ra=S("OPAQUE",ya,!1,ka,oa,rb,xb,null,b.sun_exist);R.append_node_attr(d,ra);H.push(ra);R.append_edge_attr(d,sa,ra,s[da]);sb?R.append_edge_attr(d,Vb,ra,tb):R.append_edge_attr(d,sa,ra,E("COLOR","u_shadow_mask",1,1,!0));var zb=E("COLOR","u_color",1,1,!0),Nb=E("COLOR","COLOR",1,1,!0);m.push(Nb);Ha&&(R.append_edge_attr(d,Ha,ra,Ka),R.append_edge_attr(d,Ha,ra,eb));g.length&&(R.append_edge_attr(d,g[da],ra,l[da]),ra.reflection_plane=wb[0])}f=H;H=[];if(!a&&b.color_picking){ya=r(f[0].camera);w.cameras.push(ya);
var bc=z(ya,!1);R.append_node_attr(d,bc);if(b.xray){ya=r(f[0].camera);w.cameras.push(ya);var Fb=z(ya,!0);R.append_node_attr(d,Fb);var mb=E("COLOR","COLOR",1,1,!0);R.append_edge_attr(d,bc,Fb,mb);var hb=E("DEPTH","DEPTH",1,1,!0);R.append_edge_attr(d,bc,Fb,hb)}}else bc=null;if(qb.refractions&&!a)for(da=0;da<Ga.length;da++){var J=X();R.append_node_attr(d,J);R.append_edge_attr(d,f[da],J,zb);ja.push(J);x.push(E("COLOR","u_refractmap",1,1,!0))}for(var Ia=[],da=0;da<Ga.length;da++){sa=k[da];ya=r(Ga[da]);
w.cameras.push(ya);ra=S("BLEND",ya,!1,ka,oa,rb,xb,Db,b.sun_exist);H.push(ra);R.append_node_attr(d,ra);R.append_edge_attr(d,f[da],ra,m[da]);R.append_edge_attr(d,f[da],ra,s[da]);Ha&&(R.append_edge_attr(d,Ha,ra,Ka),R.append_edge_attr(d,Ha,ra,eb));for(Xa=0;Xa<y.length;Xa++)Za=y[Xa],Oa=fa[Xa],R.append_edge_attr(d,Za,ra,Oa);if("DEPTH_PACK"==sa.type){var pa=E("COLOR","u_scene_depth",1,1,!0);pa.min_filter=aa.TF_NEAREST;pa.mag_filter=aa.TF_NEAREST}else pa=E("DEPTH","u_scene_depth",1,1,!0),pa.min_filter=aa.TF_LINEAR,
pa.mag_filter=aa.TF_LINEAR;R.append_edge_attr(d,sa,ra,pa);g.length&&(R.append_edge_attr(d,g[da],ra,l[da]),ra.reflection_plane=wb[0]);ja.length&&R.append_edge_attr(d,ja[da],ra,x[da]);Ia.push(ra)}f=H;H=[];if(b.xray){for(da=0;da<Ga.length;da++){sa=k[da];ya=r(Ga[da]);w.cameras.push(ya);ra=S("XRAY",ya,!1,ka,oa,rb,xb,Db,b.sun_exist);H.push(ra);R.append_node_attr(d,ra);R.append_edge_attr(d,f[da],ra,m[da]);R.append_edge_attr(d,f[da],ra,s[da]);Ha&&(R.append_edge_attr(d,Ha,ra,Ka),R.append_edge_attr(d,Ha,ra,
eb));for(Xa=0;Xa<y.length;Xa++)Za=y[Xa],Oa=fa[Xa],R.append_edge_attr(d,Za,ra,Oa);"DEPTH_PACK"==sa.type?(pa=E("COLOR","u_scene_depth",1,1,!0),pa.min_filter=aa.TF_NEAREST,pa.mag_filter=aa.TF_NEAREST):(pa=E("DEPTH","u_scene_depth",1,1,!0),pa.min_filter=aa.TF_LINEAR,pa.mag_filter=aa.TF_LINEAR);R.append_edge_attr(d,sa,ra,pa);g.length&&(R.append_edge_attr(d,g[da],ra,l[da]),ra.reflection_plane=wb[0]);ja.length&&R.append_edge_attr(d,ja[da],ra,x[da])}f=H;H=[]}if(bb.wireframe_debug){for(da=0;da<Ga.length;da++){ya=
Ya.clone_object_r(Ga[da]);w.cameras.push(ya);var fb=B(ya);H.push(fb);R.append_node_attr(d,fb);R.append_edge_attr(d,f[da],fb,m[da]);R.append_edge_attr(d,f[da],fb,s[da]);Ha&&(R.append_edge_attr(d,Ha,fb,Ka),R.append_edge_attr(d,Ha,fb,eb))}f=H;H=[]}if(ta&&!a){for(da=0;da<Ga.length;da++){var wa=Uc.max_ray_length,ba=Uc.intensity,La=Uc.steps_per_pass,ua=f[da],lc=ka?1:0,cc=E("DEPTH","u_input",1,1,!0);cc.min_filter=aa.TF_LINEAR;cc.mag_filter=aa.TF_LINEAR;var Xb=E("COLOR","u_input",1,.25,!0);Xb.min_filter=
aa.TF_LINEAR;Xb.mag_filter=aa.TF_LINEAR;var Ma=wa/La,xa=r(Ga[da]);w.cameras.push(xa);var Yb=p(xa,lc,wa,!0,Ma,oa,La);R.append_node_attr(d,Yb);R.append_edge_attr(d,ua,Yb,cc);var Ma=wa/La*.5,jb=r(Ga[da]);w.cameras.push(jb);var Vc=p(jb,lc,wa,!1,Ma,oa,La);R.append_node_attr(d,Vc);R.append_edge_attr(d,Yb,Vc,Xb);var Ma=wa/La*.25,vd=r(Ga[da]);w.cameras.push(vd);var Wc=p(vd,lc,wa,!1,Ma,oa,La);R.append_node_attr(d,Wc);R.append_edge_attr(d,Vc,Wc,Xb);g.length&&(Yb.reflection_plane=wb[0],Vc.reflection_plane=wb[0],
Wc.reflection_plane=wb[0]);var Lc=ga(ba,oa);H.push(Lc);R.append_node_attr(d,Lc);R.append_edge_attr(d,ua,Lc,E("COLOR","u_main",1,1,!0));R.append_edge_attr(d,Wc,Lc,E("COLOR","u_god_rays",1,1,!0))}f=H;H=[]}if(td&&!a){for(da=0;da<Ga.length;da++){var ua=f[da],dc=ha();R.append_node_attr(d,dc);R.append_edge_attr(d,ua,dc,E("COLOR","u_input",1,1,!0));var Mc=ea();R.append_node_attr(d,Mc);Mc.camera.width=1;Mc.camera.height=1;var $a=E("COLOR","u_input",1,.25,!0);$a.min_filter=aa.TF_LINEAR;$a.mag_filter=aa.TF_LINEAR;
var wc=E("COLOR","u_luminance",1,.25,!0);wc.min_filter=aa.TF_LINEAR;wc.mag_filter=aa.TF_LINEAR;R.append_edge_attr(d,dc,Mc,$a);var Gb=jd.key,dd=jd.edge_lum,Ab=r(Ga[da]);w.cameras.push(Ab);var Zb=D(Gb,dd,oa,Ab);R.append_node_attr(d,Zb);R.append_edge_attr(d,ua,Zb,E("COLOR","u_main",1,1,!0));R.append_edge_attr(d,dc,Zb,wc);R.append_edge_attr(d,Mc,Zb,E("COLOR","u_average_lum",1,1,!1));var Bb=E("COLOR","u_color",1,.25,!0);Bb.min_filter=aa.TF_LINEAR;Bb.mag_filter=aa.TF_LINEAR;var ub=M(d,dc,"X_BLUR",!0);R.append_node_attr(d,
ub);R.append_edge_attr(d,Zb,ub,Bb);var $b=M(d,ub,"Y_BLUR",!0);R.append_node_attr(d,$b);R.append_edge_attr(d,ub,$b,Bb);var xc=I(jd.blur);R.append_node_attr(d,xc);var mc=E("COLOR","u_bloom",1,.25,!0);mc.min_filter=aa.TF_LINEAR;mc.mag_filter=aa.TF_LINEAR;R.append_edge_attr(d,$b,xc,mc);R.append_edge_attr(d,ua,xc,E("COLOR","u_main",1,1,!0));H.push(xc)}f=H;H=[]}if(qd&&!a){for(da=0;da<f.length;da++){var Xc=f[da],nc=$(rc.mb_decay_threshold,rc.mb_factor);H.push(nc);R.append_node_attr(d,nc);var ec=E("COLOR",
"u_mb_tex_curr",1,1,!0);R.append_edge_attr(d,Xc,nc,ec);var ed=E("COLOR","u_mb_tex_accum",1,1,!0);nc.slinks_internal.push(ed)}f=H;H=[]}if(cd&&!a){for(da=0;da<f.length;da++){var ua=f[da],Ob=r(Ga[da]);w.cameras.push(Ob);Bb=E("COLOR","u_color",1,1,!0);Bb.min_filter=aa.TF_LINEAR;Bb.mag_filter=aa.TF_LINEAR;var ab=t("X_BLUR");R.append_node_attr(d,ab);R.append_edge_attr(d,ua,ab,Bb);var Pb=t("Y_BLUR");R.append_node_attr(d,Pb);R.append_edge_attr(d,ab,Pb,Bb);var sa=Ia[da],kb=P(Ob);Ob.dof_distance=w.dof_distance;
Ob.dof_object=w.dof_object;Ob.dof_front=w.dof_front;Ob.dof_rear=w.dof_rear;Ob.dof_power=w.dof_power;Ob.dof_on=1;H.push(kb);R.append_node_attr(d,kb);R.append_edge_attr(d,ua,kb,E("COLOR","u_sharp",1,1,!0));R.append_edge_attr(d,Pb,kb,E("COLOR","u_blurred",1,1,!0));R.append_edge_attr(d,sa,kb,E("DEPTH","u_depth",1,1,!0))}f=H;H=[]}if(!a&&b.glow){for(da=0;da<Ga.length;da++){var ua=f[da],kd=r(Ga[da]);w.cameras.push(kd);var yc=Y(kd);R.append_node_attr(d,yc);var oc=t("X_EXTEND"),Ad=E("COLOR","u_color",1,1,
!0),ac=E("COLOR","u_glow_mask",1,1,!0);oc.is_for_glow=!0;R.append_node_attr(d,oc);R.append_edge_attr(d,yc,oc,Ad);var ld=E("COLOR","u_color",1,.5,!0);ld.min_filter=aa.TF_LINEAR;ld.mag_filter=aa.TF_LINEAR;var Qb=t("Y_EXTEND");Qb.is_for_glow=!0;R.append_node_attr(d,Qb);R.append_edge_attr(d,oc,Qb,ld);ab=t("X_BLUR");ab.is_for_glow=!0;R.append_node_attr(d,ab);R.append_edge_attr(d,Qb,ab,ld);var Yc=E("COLOR","u_color",1,.25,!0);Yc.min_filter=aa.TF_LINEAR;Yc.mag_filter=aa.TF_LINEAR;var zc=E("COLOR","u_glow_mask_blurred",
1,.25,!0);zc.min_filter=aa.TF_LINEAR;zc.mag_filter=aa.TF_LINEAR;Pb=t("Y_BLUR");Pb.is_for_glow=!0;R.append_node_attr(d,Pb);R.append_edge_attr(d,ab,Pb,Yc);var gb=T(sc);R.append_node_attr(d,gb);R.append_edge_attr(d,ua,gb,E("COLOR","u_glow_src",1,1,!0));R.append_edge_attr(d,yc,gb,ac);R.append_edge_attr(d,Pb,gb,zc);H.push(gb)}f=H;H=[]}if(rd&&!a){for(da=0;da<f.length;da++){var ua=f[da],Fc=V(Kc.brightness,Kc.contrast,Kc.exposure,Kc.saturation);R.append_node_attr(d,Fc);R.append_edge_attr(d,ua,Fc,E("COLOR",
"u_color",1,1,!0));H.push(Fc)}f=H;H=[]}if(sd&&!a){for(da=0;da<f.length;da++)if(ua=f[da],bb.smaa){var pc=E("COLOR","u_color",1,1,!0);pc.min_filter=aa.TF_LINEAR;pc.mag_filter=aa.TF_LINEAR;var Ac=G("SMAA_EDGE_DETECTION");R.append_node_attr(d,Ac);R.append_edge_attr(d,ua,Ac,pc);var Gc=G("SMAA_BLENDING_WEIGHT_CALCULATION");R.append_node_attr(d,Gc);R.append_edge_attr(d,Ac,Gc,pc);var Zc=E("COLOR","u_search_tex",1,1,!1),wd=E("COLOR","u_area_tex",1,1,!1);Zc.min_filter=aa.TF_LINEAR;Zc.mag_filter=aa.TF_LINEAR;
wd.min_filter=aa.TF_LINEAR;wd.mag_filter=aa.TF_LINEAR;Gc.slinks_internal.push(Zc);Gc.slinks_internal.push(wd);var $c=G("SMAA_NEIGHBORHOOD_BLENDING");R.append_node_attr(d,$c);R.append_edge_attr(d,ua,$c,pc);var xd=E("COLOR","u_blend",1,1,!0);xd.min_filter=aa.TF_LINEAR;xd.mag_filter=aa.TF_LINEAR;R.append_edge_attr(d,Gc,$c,xd);H.push($c)}else{var ad=L();R.append_node_attr(d,ad);var Nc=E("COLOR","u_color",1,1,!0);Nc.min_filter=aa.TF_LINEAR;Nc.mag_filter=aa.TF_LINEAR;R.append_edge_attr(d,ua,ad,Nc);if(1<
bb.resolution_factor){var Bc=t("NONE");R.append_node_attr(d,Bc);R.append_edge_attr(d,ad,Bc,Nc);H.push(Bc)}else H.push(ad)}f=H;H=[]}if(b.anaglyph_use&&!a){var fc=F();R.append_node_attr(d,fc);R.append_edge_attr(d,f[0],fc,E("COLOR","u_sampler_left",1,1,!0));R.append_edge_attr(d,f[1],fc,E("COLOR","u_sampler_right",1,1,!0));H.push(fc)}else H.push(f[0]);var Oc=R.node_by_attr(d,f[0]),Bd=!1;R.traverse_inputs(d,Oc,function(a,b,c){if(c.from==c.to)return Bd=!0});if(Bd||a){var fd=N(f[0]);R.append_node_attr(d,
fd);R.append_edge_attr(d,f[0],fd,E("COLOR","u_color",1,1,!0));f=H;H=[];H.push(fd)}bc&&(Fb?H.push(Fb):H.push(bc));if(!a&&b.sky_params.procedural_skydome){var md=Z(oa,b.sky_params);R.append_node_attr(d,md);H.push(md)}var qc=ia();R.append_node_attr(d,qc);if(na.enabled){var Pc=t("NONE");R.append_node_attr(d,Pc)}for(da=0;da<H.length;da++)switch(H[da].type){case "COLOR_PICKING":case "COLOR_PICKING_XRAY":R.append_edge_attr(d,H[da],qc,E("COLOR","NONE",1,1,!0));R.append_edge_attr(d,H[da],qc,E("DEPTH","NONE",
1,1,!0));break;case "SKY":var yd=E("CUBEMAP","u_sky",Aa.cubemap_tex_size,1,!1);R.append_edge_attr(d,md,qc,yd);break;default:R.append_edge_attr(d,H[da],na.enabled?Pc:qc,E("SCREEN","NONE",1,1,!0))}if(na.enabled){var Rb=null,Cd=0;R.traverse(d,function(a,b){if(b.type==na.subs_type){if(Cd==na.subs_number)return Rb=b,!0;Cd++}});if(Rb){var gd=R.node_by_attr(d,Rb);R.traverse_edges(d,function(a,b,c){if(a==gd)return R.append_edge_attr(d,Rb,Pc,E(na.slink_type,"u_color",c.size,c.size_mult,c.update_dim)),R.append_edge_attr(d,
Pc,qc,E("SCREEN","NONE",.5,.5,!0)),!0})}}for(var Hc=R.get_sink_nodes(d),da=0;da<Hc.length;da++)for(var Ic=Hc[da],Xa=0;Xa<k.length;Xa++)sa=k[Xa],R.get_node_attr(d,Ic)==sa&&R.remove_node(d,Ic);c(d,!1);1<bb.resolution_factor&&e(d);h(d);C(d);return d};a.init_subs=f;a.find_on_screen=function(a){var b=null;R.traverse(a,function(a,c){return c.camera&&null===c.camera.framebuffer?(b=c,!0):!1});return b};a.find_input=function(a,b,c){a=fa(a,b);for(b=0;b<a.length;b++)if(a[b].type===c)return a[b];return null};
a.has_lower_subs=ka;a.has_upper_subs=qa;a.find_upper_subs=H;a.get_inputs=fa;a.get_outputs=w;a.find_subs=function(a,b){var c=null;R.traverse(a,function(a,w){return w.type==b?(c=w,!0):!1});return c};a.debug_convert_to_dot=function(a){var b="digraph scenegraph {\n",b=b+"    ",b=b+'size="11.7,16.5";\n',b=b+"    ",b=b+'ratio="fill";\n',b=b+"    ",b=b+'node [shape=box margin="0.25,0.055"];\n',c=ja(a);R.traverse(a,function(a,w){var d=b+="    ",f="",f=w.type.replace(/_/g," ");"POSTPROCESSING"==w.type&&(f+=
" ("+w.pp_effect.replace(/_/g," ")+")");if(w.camera){for(var f=f+"\\n",I=0;I<c.length;I+=2)c[I]==w.camera.color_attachment&&(f+="C"+c[I+1]+" ");for(I=0;I<c.length;I+=2)c[I]==w.camera.depth_attachment&&(f+="D"+c[I+1])}w.slinks_internal.length&&(f+="\\n-----\\n");for(I=0;I<w.slinks_internal.length;I++)f+=oa(w.slinks_internal[I],a,null,c);I="SINK"==w.type?"dotted":w.enqueue?"solid":"dashed";b=d+(String(a)+' [label="'+f+'" color="black" style="'+(I+",bold")+'"];\n')});R.traverse_edges(a,function(a,w,
d){var f=b+="    ",I=oa(d,a,w,c);b=f+(String(a)+" -> "+String(w)+' [label="'+I+'" style="'+(d.active?"solid":"dotted")+'"];\n')});return b+="}"};a.create_rendering_queue=function(a){a=R.topsort_attr(a);for(var b=[],c=0;c<a.length;c++){var w=a[c];w.enqueue&&b.push(w)}return b}};b4w.module.__objects=function(a,q){function r(a){a={type:a,data_id:0,grid_id:[0,0],trans:new Float32Array(3),quat:new Float32Array(4),tsr:new Float32Array(8),world_matrix:new Float32Array(16),inv_world_matrix:new Float32Array(16),pivot:new Float32Array(3),hover_pivot:new Float32Array(3),init_dist:0,init_top:0,use_panning:!1,move_style:0,velocity_trans:1,velocity_rot:1,velocity_zoom:1,dof_distance:0,dof_front:0,dof_rear:0,dof_power:0,dof_object:null,underwater:!1,distance_min:0,distance_max:0,use_distance_limits:!1,
horizontal_limits:null,vertical_limits:null,hover_angle_limits:null,enable_hover_hor_rotation:!0,cameras:null,glow_anim_settings:null,friction:0,elasticity:0,force_strength:0,lod_dist_min:0,lod_transition_ratio:0,physics_type:"",use_collision_compound:!1,shadow_cast:!1,shadow_receive:!1,shadow_cast_only:!1,reflexible:!1,reflexible_only:!1,reflective:!1,caustics:!1,wind_bending:!1,disable_fogging:!1,dynamic_geometry:!1,dynamic_grass:!1,do_not_cull:!1,hide:!1,last_lod:!1,selectable:!1,origin_selectable:!1,
is_hair_particles:!1,is_visible:!1,wind_bending_angle:0,wind_bending_amp:0,wind_bending_freq:0,detail_bending_freq:0,detail_bending_amp:0,branch_bending_amp:0,main_bend_col:"",detail_bend_col:null,bend_center_only:!1,billboard:!1,billboard_type:"",billboard_spherical:!1,frame_factor:0,time:0,va_frame:0,va_frame_factor:0,max_bones:0,frames_blending:!1,vertex_anim:!1,is_skinning:!1,anim_mixing:!1,anim_mix_factor:1,anim_mix_factor_change_speed:0,anim_destination_mix_factor:1,two_last_skeletal_slots:new Int8Array([-1,
-1]),skinned_renders:[],mesh_to_arm_bone_maps:[],skinning_data_cache:[],quats_before:null,quats_after:null,trans_before:null,trans_after:null,bone_pointers:null,pose_data:null,mats_anim_values:null,mats_anim_inds:null,bb_local:null,bcyl_local:null,bcap_local:null,bcon_local:null,bb_world:null,bs_local:null,bs_world:null,be_local:null,be_world:null,scale:1,lod_dist_max:1E4};E.identity(a.quat);A.identity(a.tsr);t.identity(a.world_matrix);t.identity(a.inv_world_matrix);return a}function c(a,b,c,d){var f=
a._render.params,e;for(e in f){var k=a.name+"_"+e;e in d||(d[e]=b.length,b.push(f[e][0]));c.push(k,d[e])}}var d=q("__animation"),b=q("__batch"),l=q("__boundings"),h=q("__camera"),e=q("__config"),k=q("__constraints"),g=q("__curve"),y=q("__lights"),m=q("__nla"),s=q("__particles");q("__print");var x=q("__scenes"),C=q("__transform"),A=q("__tsr"),f=q("__util"),E=q("quat"),n=q("vec3"),t=q("mat4"),M=e.defaults,S=0,z=new Float32Array(4);a.create_render=r;a.update_object=function(a,e){var v;if((v=a.parent)&&
v._is_dynamic)v=!0;else{if(!(v="ARMATURE"===a.type||"CAMERA"===a.type)&&(v="MESH"===a.type)){var E=d.is_animatable(a),O=a.b4w_do_not_batch,L=a.b4w_dynamic_geometry,G=a.b4w_collision,V=a.b4w_vehicle,$=a.b4w_floating;v=a.b4w_character;var P=a.b4w_billboard,q=s.has_dynamic_grass_particles(a),T=m.has_nla(a);if(!(E=E||O||L||G||V||$))b:{E=a.data;for(O=0;O<E.materials.length;O++)if("LENS_FLARES"===E.materials[O].name){E=!0;break b}E=!1}v=E||q||v||P||T}!v&&(v="EMPTY"===a.type)&&(v=d.is_animatable(a),P=m.has_nla(a),
v=v||P);v=v?!0:!1}a._is_dynamic=v;a._render=r("MESH"===a.type?v?"DYNAMIC":"STATIC":a.type);a._constraint=null;a._descends=[];a._dg_parent||(a._dg_parent=null);v=a._render;q=a.location;P=a.scale[0];f.quat_bpy_b4w(a.rotation_quaternion,z);C.set_translation(a,q);C.set_rotation(a,z);C.set_scale(a,P);switch(a.type){case "ARMATURE":q=a.pose.bones;for(P=0;P<q.length;P++)T=q[P],E=T.bone,O=new Float32Array(E.matrix_local),L=new Float32Array(16),t.invert(O,L),G=new Float32Array(T.matrix_basis),V=new Float32Array(3),
n.subtract(E.tail_local,E.head_local,V),f.vecdir_multiply_matrix(V,L,V),T._tail=V,T._chain=[T].concat(T.parent_recursive),T._tsr_local=A.from_mat4(O,A.create()),T._tsr_basis=A.from_mat4(G,A.create()),T._tsr_channel_cache=A.create(),T._tsr_channel_cache_valid=!1;q=d.calc_armature_bone_pointers(a);v.bone_pointers=q;q=d.calc_pose_data(a,q);a.b4w_animation_mixing?(v.quats_before=new Float32Array(q.quats),v.quats_after=new Float32Array(q.quats),v.trans_before=new Float32Array(q.trans),v.trans_after=new Float32Array(q.trans)):
(v.quats_before=q.quats,v.quats_after=q.quats,v.trans_before=q.trans,v.trans_after=q.trans);v.pose_data=q;v.frame_factor=0;v.anim_mixing=a.b4w_animation_mixing;break;case "MESH":v.selectable=M.all_objs_selectable||a.b4w_selectable;v.origin_selectable=a.b4w_selectable;v.billboard=a.b4w_billboard;v.billboard_type="BASIC";v.billboard_spherical="SPHERICAL"==a.b4w_billboard_geometry;v.glow_anim_settings={glow_duration:a.b4w_glow_settings.glow_duration,glow_period:a.b4w_glow_settings.glow_period,glow_relapses:a.b4w_glow_settings.glow_relapses};
v.selectable&&(a._color_id=f.gen_color_id(S),S++);if("MESH"!=a.type)throw"Wrong object type: "+a.name;a._render.vertex_anim=a.data.b4w_vertex_anim.length?!0:!1;if(P=d.get_first_armature_object(a)){q=a._render;T=a.data.vertex_groups;if(T.length){E=P.data.bones;O=P.pose.bones;L=0;G={};for(V=0;V<E.length;V++){var $=E[V].name,X=f.keysearch("name",$,T);if(X){var p=f.get_index_for_key_value(O,"name",$);G[$]={bone_index:V,deform_bone_index:L++,pose_bone_index:p,vgroup_index:X.index}}}q.bone_pointers=G;q.max_bones=
L;q.is_skinning=!0}q=a._render.bone_pointers;q=d.calc_pose_data(P,q);P.b4w_animation_mixing?(v.quats_before=new Float32Array(q.quats),v.quats_after=new Float32Array(q.quats),v.trans_before=new Float32Array(q.trans),v.trans_after=new Float32Array(q.trans)):(v.quats_before=q.quats,v.quats_after=q.quats,v.trans_before=q.trans,v.trans_after=q.trans);v.pose_data=q;v.frame_factor=0}if(d.has_animated_nodemats(a)){P=a._render;q=a.data.materials;T=[];E=[];for(O=0;O<q.length;O++)if((L=q[O].node_tree)&&L.animation_data)for(V=
L.animation_data,L={},(G=V.action)&&c(G,T,E,L),V=V.nla_tracks,$=0;$<V.length;$++)for(X=V[$].strips,p=0;p<V[$].strips.length;p++)G=X[p].action,c(G,T,E,L);P.mats_anim_values=T;P.mats_anim_inds=E}a._batches=[];v.shadow_cast=a.b4w_shadow_cast;v.shadow_receive=a.b4w_shadow_receive;v.shadow_cast_only=a.b4w_shadow_cast_only&&v.shadow_cast;v.reflexible=a.b4w_reflexible;v.reflexible_only=a.b4w_reflexible_only&&v.reflexible;v.reflective=a.b4w_reflective;v.caustics=a.b4w_caustics;v.wind_bending=a.b4w_wind_bending;
v.wind_bending_angle=a.b4w_wind_bending_angle;P=b.wb_angle_to_amp(a.b4w_wind_bending_angle,b.bb_bpy_to_b4w(a.data.b4w_bounding_box),a.scale[0]);v.wind_bending_amp=P;v.wind_bending_freq=a.b4w_wind_bending_freq;v.detail_bending_freq=a.b4w_detail_bending_freq;v.detail_bending_amp=a.b4w_detail_bending_amp;v.branch_bending_amp=a.b4w_branch_bending_amp;v.hide=!1;v.main_bend_col=a.b4w_main_bend_stiffness_col;P=a.b4w_detail_bend_colors;v.detail_bend_col={};v.detail_bend_col.leaves_stiffness=P.leaves_stiffness_col;
v.detail_bend_col.leaves_phase=P.leaves_phase_col;v.detail_bend_col.overall_stiffness=P.overall_stiffness_col;v.do_not_cull=a.b4w_do_not_cull;v.disable_fogging=a.b4w_disable_fogging;v.dynamic_geometry=a.b4w_dynamic_geometry;if("MESH"!==a.type)throw"Wrong object";P=a.data.materials[0];v.friction=P.physics.friction;v.elasticity=P.physics.elasticity;v.lod_dist_min=0;v.lod_dist_max=1E4;v.lod_transition_ratio=a.b4w_lod_transition;v.last_lod=!0;break;case "CAMERA":h.camera_object_to_camera(a);h.assign_boundings(a);
break;case "LAMP":y.lamp_to_light(a);break;case "CURVE":if(P=g.create_spline(a))a._spline=P;break;case "EMPTY":P=l.zero_bounding_box(),v.bb_local=P,P=l.zero_bounding_sphere(),v.bs_local=P}if(!e&&(a.parent&&"OBJECT"==a.parent_type?(q=v.trans,T=v.quat,P=v.scale,k.append_stiff_obj(a,a.parent,q,T,P)):a.parent&&"BONE"==a.parent_type&&"ARMATURE"==a.parent.type?(q=v.trans,T=v.quat,P=v.scale,k.append_stiff_bone(a,a.parent,a.parent_bone,q,T,P)):a._dg_parent&&a._dg_parent.b4w_group_relative?(P=A.create_sep(v.trans,
v.scale,v.quat),k.append_child_of(a,a._dg_parent,P)):a._dg_parent&&!a._dg_parent.b4w_group_relative&&(C.update_transform(a),T=v.world_matrix,t.multiply(a._dg_parent._render.world_matrix,T,T),q=f.matrix_to_trans(T),P=f.matrix_to_scale(T),T=f.matrix_to_quat(T),C.set_translation(a,q),C.set_rotation(a,T),C.set_scale(a,P)),P=a.dupli_group))for(q=P.objects,P=0;P<q.length;P++)q[P]._dg_parent=a;a.field&&(v.force_strength=a.field.strength,x.update_force(a));v.use_collision_compound=a.game.use_collision_compound;
v.physics_type=a.game.physics_type;C.update_transform(a)};a.update_objects_dynamics=function(a){for(var b=0;b<a.length;b++){var c=a[b];!c._render||"DYNAMIC"!=c._render.type&&"CAMERA"!=c._render.type||C.update_transform(c);c.b4w_use_default_animation&&d.is_animatable(c)&&(d.apply_def(c),d.play(c,null,d.SLOT_ALL))}};a.is_dynamic_mesh=function(a){return"MESH"==a.type&&a._is_dynamic?!0:!1};a.get_meta_tags=function(a){a=a.b4w_object_tags;return{title:a.title,description:a.description,category:a.category}};
a.cleanup=function(){S=0}};b4w.module.__ipc=function(a,q){var r=a.IN_COLLISION=0;a.IN_COLLISION_IMPULSE=1;a.IN_ERROR=2;a.IN_FBMSG=3;a.IN_FLOATER_BOB_TRANSFORM=4;a.IN_LOG=5;var c=a.IN_PROP_OFFSET=6,d=a.IN_RAY_HIT=7,b=a.IN_TRANSFORM=8;a.IN_VEHICLE_SPEED=9;a.IN_PING=10;a.OUT_INIT=11;a.OUT_ACTIVATE=12;a.OUT_ADD_BOAT_BOB=13;a.OUT_ADD_CAR_WHEEL=14;a.OUT_ADD_FLOATER_BOB=15;a.OUT_APPEND_BOUNDING_BODY=16;a.OUT_APPEND_BOAT=17;a.OUT_APPEND_CAR=18;a.OUT_APPEND_CHARACTER=19;a.OUT_APPEND_COLLISION_TEST=20;a.OUT_APPEND_CONSTRAINT=21;a.OUT_APPEND_FLOATER=
22;a.OUT_APPEND_GHOST_MESH_BODY=23;a.OUT_APPEND_STATIC_MESH_BODY=24;a.OUT_APPEND_WATER=25;a.OUT_APPEND_WORLD=26;a.OUT_APPLY_CENTRAL_FORCE=27;a.OUT_APPLY_COLLISION_IMPULSE_TEST=28;a.OUT_APPLY_TORQUE=29;a.OUT_CHARACTER_JUMP=30;a.OUT_CHARACTER_ROTATION_INCREMENT=31;a.OUT_CLEANUP=32;a.OUT_CLEAR_COLLISION_IMPULSE_TEST=33;a.OUT_DISABLE_SIMULATION=34;a.OUT_ENABLE_SIMULATION=35;a.OUT_PAUSE=36;a.OUT_RAY_TEST=37;a.OUT_REMOVE_COLLISION_TEST=38;a.OUT_REMOVE_CONSTRAINT=39;a.OUT_RESUME=40;a.OUT_SET_ACTIVE_WORLD=
41;a.OUT_SET_CHARACTER_FLY_VELOCITY=42;a.OUT_SET_CHARACTER_HOR_ROTATION=43;a.OUT_SET_CHARACTER_MOVE_DIR=44;a.OUT_SET_CHARACTER_MOVE_TYPE=45;a.OUT_SET_CHARACTER_ROTATION=46;a.OUT_SET_CHARACTER_RUN_VELOCITY=47;a.OUT_SET_CHARACTER_VERT_ROTATION=48;a.OUT_SET_CHARACTER_WALK_VELOCITY=49;a.OUT_SET_GRAVITY=50;a.OUT_SET_LINEAR_VELOCITY=51;var l=a.OUT_SET_TRANSFORM=52;a.OUT_SET_WATER_TIME=53;a.OUT_ADD_WATER_WRAPPER=54;a.OUT_UPDATE_BOAT_CONTROLS=55;a.OUT_UPDATE_CAR_CONTROLS=56;a.OUT_PING=57;a.OUT_DEBUG=58;for(var h=
null,e=[],k=[],g=[],y=[],m=0;59>m;m++)e.push(null),k.push(null),g.push(null),y.push(null);k[b]={msg_id:0,body_id:0,time:0,trans:new Float32Array(3),quat:new Float32Array(4),linvel:new Float32Array(3),angvel:new Float32Array(3)};k[c]={msg_id:0,chassis_hull_body_id:0,prop_ind:0,trans:new Float32Array(3),quat:new Float32Array(4)};k[d]={msg_id:0,body_id:0,from:new Float32Array(3),to:new Float32Array(3),local:0,body_id_b_hit:0,cur_result:0};k[r]={msg_id:0,body_id_a:0,body_id_b:0,result:0,coll_point:new Float32Array(3)};
k[l]={msg_id:0,body_id:0,trans:new Float32Array(3),quat:new Float32Array(4)};y[b]=["msg_id",1,"body_id",1,"time",1,"trans",3,"quat",4,"linvel",3,"angvel",3];y[c]=["msg_id",1,"chassis_hull_body_id",1,"prop_ind",1,"trans",3,"quat",4];y[d]=["msg_id",1,"body_id",1,"from",3,"to",3,"local",1,"body_id_b_hit",1,"cur_result",1];y[r]=["msg_id",1,"body_id_a",1,"body_id_b",1,"result",1,"coll_point",3];y[l]=["msg_id",1,"body_id",1,"trans",3,"quat",4];a.init=function(a,b){a.addEventListener("message",function(a){var c=
a.data;a=c[0]|0;if(y[a]){for(var d=k[a],e=y[a],n=0,m=0;m<e.length;m+=2){var h=e[m],g=e[m+1];if(1==g)d[h]="msg_id"==h||"body_id"==h||"body_id_a"==h||"body_id_b"==h?c[n]|0:c[n];else for(var s=0;s<g;s++)d[h][s]=c[n+s];n+=g}c=d}b(a,c)},!1);h=a};a.cleanup=function(){h=null};a.post_msg=function(){var a=arguments[0]|0;if(y[a]){var b=k[a],c=y[a],d=0;if(!g[a]){for(var f=0,m=1;m<c.length;m+=2)f+=c[m];g[a]=new Float32Array(f)}f=g[a];for(m=0;m<c.length;m+=2){var n=b[c[m]],t=c[m+1];1==t?f[d]=n:f.set(n,d);d+=t}e[a]||
(e[a]=f);a=e[a]}else for(b=arguments.length,e[a]||(e[a]=Array(b),e[a][0]=a),a=e[a],c=1;c<b;c++)a[c]=arguments[c];h.postMessage(a)};a.get_msg_cache=function(a){return k[a]}};b4w.module.__hud=function(a,q){function r(a){a.font="bold 15px Courier";a.textBaseline="middle";a.shadowBlur=0;a.shadowColor=null}function c(a){d(' SCENE "'+a.name+'"');if(a._render){var b=0,c=0;k.traverse(a._render.graph,function(a,e){if("SINK"==e.type)d(" (F)",e.type);else{var f=e.type,k=Math.round(e.camera.width)+"x"+Math.round(e.camera.height),n=e.bundles.length,m=e.debug_render_calls,h=e.enqueue&&e.do_render;h?d(" (A)",f,e.num_lights,k,m,"of",n):d(" (P)",f,e.num_lights,k,m,"of",n);e.debug_render_calls=
0;h&&(b+=n,c+=m)}});return[b,c]}d("No INFO")}function d(){for(var a=80+20*y[0],b=[5,18,3,10,4,3,5],c=arguments[0],d=1;d<arguments.length;d++){for(var e=b[d]-String(arguments[d]).length,f="",k=0;k<e;k++)f+=" ";c+=f+arguments[d]}y[0]++;g.fillText(c,30,a)}function b(a,b,c,d,e){e.x=a;e.y=b;e.w=c;e.h=d;return e}function l(a,b,c){b*=a.w;c.x=a.x+b;c.y=a.y;c.w=a.w-2*b;c.h=a.h;return c}function h(a){return a.x+a.w/2}function e(a){var c=g,d={x:0,y:0,w:0,h:0};b(0,0,c.canvas.width,c.canvas.height,d);l(d,.01,
d);c=.02*d.h;d.x=d.x;d.y+=c;d.w=d.w;d.h-=2*c;c=d.w/8;d.x+=c*a;d.y=d.y;d.w=c;d.h=d.h;l(d,.02,d);return d}var k=q("__graph"),g=null,y=[0,0];a.init=function(a){a=a.getContext("2d");r(a);return g=a};a.update_dim=function(){g&&r(g)};a.reset=function(){var a=g;a&&(a.clearRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle="rgba(0,0,0,0.5)",a.fillRect(0,0,a.canvas.width,a.canvas.height),y[0]=0,y[1]=0)};a.show_debug_info=function(a,b){var e=g;if(e){e.textAlign="left";e.fillStyle="rgba(0,255,0,255)";d(" FPS",
(1/b).toFixed(2));y[0]++;for(var k=e=0,h=0;h<a.length;h++){var f=c(a[h]),e=e+f[0],k=k+f[1];y[0]++}d(" ---------------------------------------------");d("    ","TOTAL ACTIVE","","",k,"of",e)}};a.print=function(){var a=g;a&&(a.textAlign="left",a.fillStyle="rgba(0,255,0,255)",d.apply(Math,arguments))};a.plot_array=function(a,b,c,d,k,f,l){var n=g;if(n){b=e(b);var t=b.h/5;b.x=b.x;b.y+=4*t;b.w=b.w;b.h=t;n.textAlign="center";n.fillStyle="#00FF00";g.fillText(a,h(b),b.y-10);n.strokeStyle="#00FF00";n.lineWidth=
.5;n.beginPath();n.moveTo(b.x,b.y);n.lineTo(b.x+b.w,b.y);n.lineTo(b.x+b.w,b.y+b.h);n.lineTo(b.x,b.y+b.h);n.closePath();n.stroke();if(!f&&!l)for(f=1E6,l=-1E6,a=0;a<c.length;a++)f=Math.min(f,c[a]),l=Math.max(l,c[a]);n.textAlign="right";g.fillText(String(f),b.x-10,b.y+b.h);g.fillText(String(l),b.x-10,b.y);n.textAlign="center";g.fillText(String(d),b.x,b.y+b.h+15);g.fillText(String(k),b.x+b.w,b.y+b.h+15);n.strokeStyle="#FF0000";n.lineWidth=1.5;n.beginPath();d=b.w/(c.length-1);l=b.h/(l-f);for(a=0;a<c.length;a++)k=
b.x+d*a,t=b.y+b.h-(c[a]-f)*l,0==a?n.moveTo(k,t):n.lineTo(k,t);n.stroke()}};a.draw_mixer_strip=function(a,c,d,k,l,f,y){var n=g;if(n)for(n.textAlign="center",n.fillStyle="#00FF00",n.font="bold 12px Courier",d=e(d),g.fillText(c?"["+a+"]":a,h(d),d.y),0<=f&&g.fillText(f?"[M]":"[ ]",h(d)-15,d.y+30),0<=y&&g.fillText(y?"[S]":"[ ]",h(d)+15,d.y+30),a={x:0,y:0,w:0,h:0},c=0;c<k.length;c++){var t=k[c];(y="VOLUME"==t[0])?b(d.x,d.y+350,d.w,250,a):b(d.x,d.y+10+50*c,d.w,d.h,a);f=n;var M=a,r=c==l,z=t[0],B=t[1],K=t[2],
v=t[3],Q=t[5],t=(v-K)/t[4],t=1>t?Math.floor(1/t-1E-5).toFixed(0).length:0,Q=Q?Math.log(B/K)/Math.log(v/K):(B-K)/(v-K);f.textAlign="center";r?f.fillText("["+z+"]",h(M),M.y):f.fillText(z,h(M),M.y);f.strokeStyle="#00FF00";f.lineWidth=y?3:1;y?(f.textAlign="right",f.fillText(v.toFixed(t),h(M)-10,M.y+15),f.textAlign="right",f.fillText(K.toFixed(t),h(M)-10,M.y+M.h-15)):(f.textAlign="right",f.fillText(K.toFixed(t),M.x+28,M.y+15),f.textAlign="left",f.fillText(v.toFixed(t),M.x+M.w-28,M.y+15));f.beginPath();
if(y){var O=M.y+15+(M.h-30)*(1-Q);f.moveTo(h(M),M.y+15);f.lineTo(h(M),M.y+M.h-15);f.moveTo(h(M)-5,M.y+15);f.lineTo(h(M)+5,M.y+15);f.moveTo(h(M)-5,M.y+M.h-15);f.lineTo(h(M)+5,M.y+M.h-15);f.moveTo(h(M)-5,O);f.lineTo(h(M)+5,O)}else{var L=M.x+30+(M.w-60)*Q;f.moveTo(M.x+30,M.y+15);f.lineTo(M.x+M.w-30,M.y+15);f.moveTo(M.x+30,M.y+15-5);f.lineTo(M.x+30,M.y+15+5);f.moveTo(M.x+M.w-30,M.y+15-5);f.lineTo(M.x+M.w-30,M.y+15+5);f.moveTo(L,M.y+15-5);f.lineTo(L,M.y+15+5)}f.stroke();"EQ_Q"==z?(r=B,r=1+1/(2*r*r)+Math.sqrt((2+
1/(r*r))*(2+1/(r*r))/4-1),r=Math.log(r)/Math.log(2),y?(f.textAlign="left",f.fillText(B.toFixed(t),h(M)+10,O),f.textAlign="left",f.fillText("("+r.toFixed(t+1)+")",h(M)+10,O+10)):(f.textAlign="right",f.fillText(B.toFixed(t),L,M.y+30),f.textAlign="left",f.fillText("("+r.toFixed(t+1)+")",L,M.y+30))):y?(f.textAlign="left",f.fillText(B.toFixed(t),h(M)+10,O)):(f.textAlign="center",f.fillText(B.toFixed(t),L,M.y+30))}}};b4w.module.__prerender=function(a,q){var r=q("__config"),c=q("__debug"),d=q("__geometry"),b=q("__util"),l=q("vec3"),h=r.defaults,e="MAIN_OPAQUE MAIN_BLEND MAIN_REFLECT SHADOW_CAST DEPTH GLOW_MASK WIREFRAME COLOR_PICKING MAIN_XRAY COLOR_PICKING_XRAY".split(" ");a.prerender_subs=function(a){if(-1<e.indexOf(a.type)){for(var g=!1,y=a.bundles,m=0;m<y.length;m++){var s=y[m],x=s,C=a,A=x.obj_render,f=C.camera;x.do_render=!0;A.is_visible=!1;if(A)if(A.hide)x.do_render=!1;else{var E=void 0;var n=f.eye,t=A.bs_world.center,
E=A.lod_dist_min,M=A.lod_dist_max,n=Math.sqrt((t[0]-n[0])*(t[0]-n[0])+(t[1]-n[1])*(t[1]-n[1])+(t[2]-n[2])*(t[2]-n[2])),t=A.lod_transition_ratio*A.bs_world.radius,E=n>=E&&n<M+t?!0:!1;E?(A.is_visible=!0,"GLOW_MASK"!=C.type||Boolean(x.batch.glow_intensity)?(E=void 0,f=f.frustum_planes,A.do_not_cull?E=!1:("STATIC"===A.type?(E=A.bs_world,A=E.center,A=b.sphere_is_out_of_frustum(A,f,E.radius)):(E=A.be_world,A=E.center,A=b.ellipsoid_is_out_of_frustum(A,f,E.axis_x,E.axis_y,E.axis_z)),E=A),E?x.do_render=!1:
"WIREFRAME"==C.type&&(x.do_render=x.batch.wireframe_mode==c.WIREFRAME_MODES.WM_DEBUG_SPHERES?x.batch.debug_sphere:!x.batch.debug_sphere)):x.do_render=!1):x.do_render=!1}else x.do_render=!1;s.do_render&&(g=!0)}switch(a.type){case "WIREFRAME":break;default:a.do_render="MAIN_OPAQUE"===a.type||"DEPTH"===a.type||g?!0:!1}}if("MAIN_BLEND"==a.type&&(g=a.camera.eye,l.dist(g,a.zsort_eye_last)>h.alpha_sort_threshold&&h.alpha_sort&&a.bundles)){for(y=0;y<a.bundles.length;y++)s=a.bundles[y],x=s.batch,m=s.obj_render.world_matrix,
x&&x.blend&&x.zsort_type!=d.ZSORT_DISABLED&&(x=x.bufs_data)&&s.do_render&&(s=x.info_for_z_sort_updates)&&s.type==d.ZSORT_BACK_TO_FRONT&&d.update_buffers_movable(x,m,g);a.zsort_eye_last.set(g)}}};b4w.module.__print=function(a,q){var r=!1,c=0,d=0;a.set_verbose=function(a){r=a};a.log=function(){r&&console.log.apply(console,arguments)};a.error=function(){c++;console.error.apply(console,arguments)};a.warn=function(){d++;console.warn.apply(console,arguments)};a.time=function(){r&&console.time.apply(console,arguments)};a.timeEnd=function(){r&&console.timeEnd.apply(console,arguments)};a.group=function(){r&&console.group.apply(console,arguments)};a.groupCollapsed=function(){r&&console.groupCollapsed.apply(console,
arguments)};a.groupEnd=function(){r&&console.groupEnd.apply(console,arguments)};a.clear=function(){"function"==typeof console.clear&&console.clear.apply(console,arguments)};a.get_warning_count=function(){return d};a.get_error_count=function(){return c};a.clear_errors_warnings=function(){c=d=0}};b4w.module.print=b4w.module.__print;b4w.module.__reformer=function(a,q){function r(a){switch(a.type){case "MAPPING":a.vector_type||(a.vector_type="POINT",c("node Mapping",a,"vector_type"));break;case "MATERIAL":case "MATERIAL_EXT":"specular_shader"in a||(a.specular_shader="COOKTORR",c("node material",a,"specular_shader")),"specular_hardness"in a||(a.specular_hardness=50,c("node material",a,"specular_hardness")),"specular_slope"in a||(a.specular_slope=.1,c("node material",a,"specular_slope")),"specular_toon_size"in a||(a.specular_toon_size=
.5,c("node material",a,"specular_toon_size")),"specular_toon_smooth"in a||(a.specular_toon_smooth=.1,c("node material",a,"specular_toon_smooth")),"specular_intensity"in a||(a.specular_intensity=.5,c("node material",a,"specular_intensity")),"diffuse_shader"in a||(a.diffuse_shader="LAMBERT",c("node material",a,"diffuse_shader")),"roughness"in a||(a.roughness=.5,c("node material",a,"roughness")),"diffuse_fresnel"in a||(a.diffuse_fresnel=.1,c("node material",a,"diffuse_fresnel")),"diffuse_fresnel_factor"in
a||(a.diffuse_fresnel_factor=.5,c("node material",a,"diffuse_fresnel_factor"))}}function c(a,b,c){c=c+">>"+a;c in x||(x[c]={storage:[],report_type:"undefined",type:a});x[c].storage.push(b.name)}function d(a,b,c){param_id in x||(x[param_id]={storage:[],report_type:"deprecated",type:a});x[param_id].storage.push(b.name)}function b(a,b){b||(b=a.name+"_COPY");var c=a.materials,d=a.submeshes;a.materials=null;a.submeshes=null;var e=k.clone_object_json(a);a.materials=c;a.submeshes=d;e.name=b;e.materials=
a.materials.slice(0);e.submeshes=[];for(c=0;c<d.length;c++){var h=k.clone_object_nr(d[c]);e.submeshes.push(h)}return e}var l=q("__boundings"),h=q("__curve"),e=q("__print"),k=q("__util"),g=q("vec3"),y=q("vec4"),m=q("quat"),s=q("mat4"),x={};a.check_bpy_data=function(a){x={};var b=a.worlds;if(0==b.length){e.warn("WARNING Datablock world is missing, reexport scene");var f={name:"DEFAULT",horizon_color:[0,0,0],zenith_color:[0,0,0],light_settings:{use_environment_light:!1,environment_energy:1,environment_color:"PLAIN"},
b4w_fog_color:[.5,.5,.5],b4w_fog_density:0};b.push(f)}for(var b=a.worlds,h=0;h<b.length;h++){var f=b[h],n=f.b4w_shadow_settings;"csm_resolution"in n||(c("world",f,"b4w_shadow_settings.csm_resolution"),n.csm_resolution=2048);"self_shadow_polygon_offset"in n||(c("world",f,"b4w_shadow_settings.self_shadow_polygon_offset"),n.self_shadow_polygon_offset=1);"self_shadow_normal_offset"in n||(c("world",f,"b4w_shadow_settings.self_shadow_normal_offset"),n.self_shadow_normal_offset=.01);"b4w_enable_csm"in n||
(c("world",f,"b4w_shadow_settings.b4w_enable_csm"),n.b4w_enable_csm=!1);"csm_num"in n||(c("world",f,"b4w_shadow_settings.csm_num"),n.csm_num=1);"csm_first_cascade_border"in n||(c("world",f,"b4w_shadow_settings.csm_first_cascade_border"),n.csm_first_cascade_border=10);"first_cascade_blur_radius"in n||(c("world",f,"b4w_shadow_settings.first_cascade_blur_radius"),n.first_cascade_blur_radius=3);"csm_last_cascade_border"in n||(c("world",f,"b4w_shadow_settings.csm_last_cascade_border"),n.csm_last_cascade_border=
100);"last_cascade_blur_radius"in n||(c("world",f,"b4w_shadow_settings.last_cascade_blur_radius"),n.last_cascade_blur_radius=1.5);"fade_last_cascade"in n||(c("world",f,"b4w_shadow_settings.fade_last_cascade"),n.fade_last_cascade=!0);"blend_between_cascades"in n||(c("world",f,"b4w_shadow_settings.blend_between_cascades"),n.blend_between_cascades=!0);n=f.b4w_ssao_settings;"dist_factor"in n||(c("world",f,"b4w_ssao_settings.dist_factor"),n.dist_factor=0,n.samples=16);"hemisphere"in n||(c("world",f,"b4w_ssao_settings.hemisphere"),
n.hemisphere=!1);"blur_depth"in n||(c("world",f,"b4w_ssao_settings.blur_depth"),n.blur_depth=!1);"blur_discard_value"in n||(c("world",f,"b4w_ssao_settings.blur_discard_value"),n.blur_discard_value=1);"b4w_glow_color"in f||(f.b4w_glow_color=[1,1,1],c("object",f,"b4w_glow_color"));"b4w_glow_factor"in f||(f.b4w_glow_factor=1,c("object",f,"b4w_glow_factor"));"b4w_fog_density"in f||(c("world",f,"b4w_fog_density"),f.b4w_fog_density=0);"b4w_sky_settings"in f&&"rayleigh_brightness"in f.b4w_sky_settings||
(c("world",f,"rayleigh_brightness"),f.b4w_sky_settings={procedural_skydome:!1,use_as_enviroment_map:!1,color:[.24,.43,.75],rayleigh_brightness:3.3,mie_brightness:.1,spot_brightness:10,scatter_strength:.2,rayleigh_strength:.2,mie_strength:.006,rayleigh_collection_power:.5,mie_collection_power:.5,mie_distribution:.4});"b4w_bloom_settings"in f?("blur"in f.b4w_bloom_settings||(c("world",f,"b4w_bloom_settings.blur"),f.b4w_bloom_settings.blur=4),"edge_lum"in f.b4w_bloom_settings||(c("world",f,"b4w_bloom_settings.edge_lum"),
f.b4w_bloom_settings.edge_lum=1)):(c("world",f,"b4w_bloom_settings"),f.b4w_bloom_settings={key:.2,blur:4});"b4w_motion_blur_settings"in f?("motion_blur_factor"in f.b4w_motion_blur_settings||(c("world",f,"b4w_motion_blur_settings.motion_blur_factor"),f.b4w_motion_blur_settings.motion_blur_factor=.01),"motion_blur_decay_threshold"in f.b4w_motion_blur_settings||(c("world",f,"b4w_motion_blur_settings.motion_blur_decay_threshold"),f.b4w_motion_blur_settings.motion_blur_decay_threshold=.01)):(c("world",
f,"b4w_motion_blur_settings"),f.b4w_motion_blur_settings={motion_blur_factor:.01,motion_blur_decay_threshold:.01});"b4w_color_correction_settings"in f||(c("world",f,"b4w_color_correction_settings"),f.b4w_color_correction_settings={brightness:0,contrast:0,exposure:1,saturation:1});"steps_per_pass"in f.b4w_god_rays_settings||(c("world",f,"b4w_god_rays_settings.steps_per_pass"),f.b4w_god_rays_settings.steps_per_pass=10)}b=a.scenes;for(h=0;h<b.length;h++)f=b[h],"b4w_use_nla"in f||(f.b4w_use_nla=!1,c("scene",
f,"b4w_use_nla")),"fps"in f||(f.fps=24,c("scene",f,"fps")),"b4w_nla_cyclic"in f||(f.b4w_nla_cyclic=!1,c("scene",f,"b4w_nla_cyclic")),"b4w_nla_script"in f||(f.b4w_nla_script=[],c("scene",f,"b4w_nla_script")),"b4w_detect_collisions"in f&&(d("scene",f,"b4w_detect_collisions"),delete f.b4w_detect_collisions),"audio_doppler_speed"in f||(f.audio_doppler_speed=343.3),"audio_doppler_factor"in f||(f.audio_doppler_factor=1),"b4w_dynamic_compressor_settings"in f||(f.b4w_dynamic_compressor_settings={threshold:-24,
knee:30,ratio:12,attack:.003,release:.25},c("scene",f,"b4w_dynamic_compressor_settings")),"b4w_enable_convolution_engine"in f||(f.b4w_enable_convolution_engine=!1),"b4w_enable_bloom"in f||(f.b4w_enable_bloom=!1,c("scene",f,"b4w_enable_bloom")),"b4w_enable_motion_blur"in f||(f.b4w_enable_motion_blur=!1,c("scene",f,"b4w_enable_motion_blur")),"b4w_enable_color_correction"in f||(f.b4w_enable_color_correction=!1,c("scene",f,"b4w_enable_color_correction")),"b4w_enable_antialiasing"in f||(f.b4w_enable_antialiasing=
!0,c("scene",f,"b4w_enable_antialiasing")),"b4w_tags"in f||(f.b4w_tags={title:"",description:""},c("scene",f,"b4w_tags"));f=a.meshes;for(h=0;h<f.length;h++)for(n=f[h],n.b4w_bounding_box||(c("mesh",n,"b4w_bounding_box"),n.b4w_bounding_box={max_x:0,max_y:0,max_z:0,min_x:0,min_y:0,min_z:0}),n.uv_textures||(c("mesh",n,"uv_textures"),n.uv_textures=[]),n.b4w_bounding_sphere_center||(n.b4w_bounding_sphere_center=[0,0,0]),n.b4w_bounding_cylinder_center||(n.b4w_bounding_cylinder_center=[0,0,0]),n.b4w_bounding_ellipsoid_center||
(n.b4w_bounding_ellipsoid_center=[0,0,0]),n.b4w_bounding_ellipsoid_axes||(b=n.b4w_bounding_box,n.b4w_bounding_ellipsoid_axes=[(b.max_x-b.min_x)/2,(b.max_y-b.min_y)/2,(b.max_z-b.min_z)/2]),b=0;b<n.b4w_vertex_anim.length;b++){var t=n.b4w_vertex_anim[b];"allow_nla"in t||(c('mesh["b4w_vertex_anim"]',n,"allow_nla"),t.allow_nla=!0)}b=a.cameras;for(h=0;h<b.length;h++)f=b[h],f.type||(f.type="PERSP",c("camera",f,"type")),"b4w_eye_target_dist"in f&&(delete f.b4w_eye_target_dist,d("camera",f,"b4w_eye_target_dist")),
"b4w_trans_velocity"in f||(f.b4w_trans_velocity=1,c("camera",f,"b4w_trans_velocity")),"b4w_rot_velocity"in f||(f.b4w_rot_velocity=1,c("camera",f,"b4w_rot_velocity")),"b4w_zoom_velocity"in f||(f.b4w_zoom_velocity=.1,c("camera",f,"b4w_zoom_velocity")),"b4w_use_distance_limits"in f||(f.b4w_use_distance_limits=!1,c("camera",f,"b4w_use_distance_limits")),"b4w_distance_min"in f||(f.b4w_distance_min=1,c("camera",f,"b4w_distance_min")),"b4w_distance_max"in f||(f.b4w_distance_max=100,c("camera",f,"b4w_distance_max")),
"b4w_horizontal_translation_min"in f||(f.b4w_horizontal_translation_min=-100,c("camera",f,"b4w_horizontal_translation_min")),"b4w_horizontal_translation_max"in f||(f.b4w_horizontal_translation_max=100,c("camera",f,"b4w_horizontal_translation_max")),"b4w_vertical_translation_min"in f||(f.b4w_vertical_translation_min=-100,c("camera",f,"b4w_vertical_translation_min")),"b4w_vertical_translation_max"in f||(f.b4w_vertical_translation_max=100,c("camera",f,"b4w_vertical_translation_max")),"b4w_use_horizontal_clamping"in
f||(f.b4w_use_horizontal_clamping=!1,c("camera",f,"b4w_use_horizontal_clamping")),"b4w_rotation_left_limit"in f||(f.b4w_rotation_left_limit=-Math.PI,c("camera",f,"b4w_rotation_left_limit")),"b4w_rotation_right_limit"in f||(f.b4w_rotation_right_limit=Math.PI,c("camera",f,"b4w_rotation_right_limit")),"b4w_horizontal_clamping_type"in f||(f.b4w_horizontal_clamping_type="LOCAL",c("camera",f,"b4w_horizontal_clamping_type")),"b4w_use_vertical_clamping"in f||(f.b4w_use_vertical_clamping=!1,c("camera",f,"b4w_use_vertical_clamping")),
"b4w_rotation_down_limit"in f||(f.b4w_rotation_down_limit=-Math.PI/2,c("camera",f,"b4w_rotation_down_limit")),"b4w_rotation_up_limit"in f||(f.b4w_rotation_up_limit=Math.PI/2,c("camera",f,"b4w_rotation_up_limit")),"b4w_vertical_clamping_type"in f||(f.b4w_vertical_clamping_type="LOCAL",c("camera",f,"b4w_vertical_clamping_type")),"b4w_hover_angle_min"in f||(f.b4w_hover_angle_min=Math.PI/6,c("camera",f,"b4w_hover_angle_min")),"b4w_hover_angle_max"in f||(f.b4w_hover_angle_max=Math.PI/6,c("camera",f,"b4w_hover_angle_max")),
"b4w_enable_hover_hor_rotation"in f||(f.b4w_enable_hover_hor_rotation=!0,c("camera",f,"b4w_enable_hover_hor_rotation")),"b4w_use_panning"in f||(f.b4w_use_panning=!0,c("camera",f,"b4w_use_panning"));b=a.lamps;for(h=0;h<b.length;h++)f=b[h],"b4w_generate_shadows"in f||(f.b4w_generate_shadows=!1,c("lamp",f,"b4w_generate_shadows")),"b4w_dynamic_intensity"in f||(f.b4w_dynamic_intensity=!1,c("lamp",f,"b4w_dynamic_intensity")),"use_diffuse"in f||(f.use_diffuse=!0,c("lamp",f,"use_diffuse")),"use_specular"in
f||(f.use_specular=!0,c("lamp",f,"use_specular"));b=a.speakers;for(h=0;h<b.length;h++)f=b[h],"b4w_behavior"in f||(f.b4w_behavior=f.b4w_background_music?"BACKGROUND_SOUND":"POSITIONAL"),"b4w_disable_doppler"in f||(f.b4w_disable_doppler=!1),"b4w_delay"in f||(f.b4w_delay=0),"b4w_delay_random"in f||(f.b4w_delay_random=0),"b4w_volume_random"in f||(f.b4w_volume_random=0),"b4w_pitch_random"in f||(f.b4w_pitch_random=0),"b4w_fade_in"in f||(f.b4w_fade_in=0),"b4w_fade_out"in f||(f.b4w_fade_out=0),"b4w_loop"in
f||(f.b4w_loop=!1),"b4w_loop_count"in f||(f.b4w_loop_count=0),"b4w_loop_count_random"in f||(f.b4w_loop_count_random=0),"b4w_playlist_id"in f||(f.b4w_playlist_id="");b=a.textures;for(h=0;h<b.length;h++)f=b[h],"b4w_anisotropic_filtering"in f||(f.b4w_anisotropic_filtering="OFF",c("texture",f,"b4w_anisotropic_filtering")),"b4w_water_foam"in f||(f.b4w_water_foam=!1,c("texture",f,"b4w_water_foam")),"b4w_foam_uv_freq"in f||(f.b4w_foam_uv_freq=[1,1],c("texture",f,"b4w_foam_uv_freq")),"b4w_foam_uv_magnitude"in
f||(f.b4w_foam_uv_magnitude=[1,1],c("texture",f,"b4w_foam_uv_magnitude")),"b4w_parallax_steps"in f||(f.b4w_parallax_steps=5,c("material",f,"b4w_parallax_steps")),"b4w_parallax_lod_dist"in f||(f.b4w_parallax_lod_dist=10,c("material",f,"b4w_parallax_lod_dist")),"b4w_shore_dist_map"in f||(f.b4w_shore_dist_map=!1,c("texture",f,"b4w_shore_dist_map")),"b4w_shore_boundings"in f||(f.b4w_shore_boundings=new Float32Array(4),f.b4w_shore_boundings=[1E3,-1E3,1E3,-1E3],c("texture",f,"b4w_shore_boundings")),"b4w_max_shore_dist"in
f||(f.b4w_max_shore_dist=100,c("texture",f,"b4w_max_shore_dist")),"b4w_disable_compression"in f||(f.b4w_disable_compression=!1,c("texture",f,"b4w_disable_compression")),"b4w_source_type"in f||(f.b4w_source_type="",c("texture",f,"b4w_source_type")),"b4w_source_id"in f||(f.b4w_source_id="",c("texture",f,"b4w_source_id")),"b4w_source_size"in f||(f.b4w_source_size=1024,c("texture",f,"b4w_source_size")),"b4w_enable_canvas_mipmapping"in f||(f.b4w_enable_canvas_mipmapping=!0,c("texture",f,"b4w_enable_canvas_mipmapping"));
f=a.materials;for(h=0;h<f.length;h++){n=f[h];"b4w_node_mat_type"in n&&d("material",n,"b4w_node_mat_type");"b4w_skydome"in n&&d("material",n,"b4w_skydome");"b4w_procedural_skydome"in n&&d("material",n,"b4w_procedural_skydome");n.b4w_water&&("b4w_water_shore_smoothing"in n||(n.b4w_water_shore_smoothing=!1,c("material",n,"b4w_water_shore_smoothing")),"b4w_water_dynamic"in n||(n.b4w_water_dynamic=!1,c("material",n,"b4w_water_dynamic")),"b4w_waves_height"in n||(n.b4w_waves_height=1,c("material",n,"b4w_waves_height")),
"b4w_waves_length"in n||(n.b4w_waves_length=1,c("material",n,"b4w_waves_length")),"b4w_water_dst_noise_scale0"in n||(n.b4w_water_dst_noise_scale0=.05,c("material",n,"b4w_water_dst_noise_scale0")),"b4w_water_dst_noise_scale1"in n||(n.b4w_water_dst_noise_scale1=.03,c("material",n,"b4w_water_dst_noise_scale1")),"b4w_water_dst_noise_freq0"in n||(n.b4w_water_dst_noise_freq0=1.3,c("material",n,"b4w_water_dst_noise_freq0")),"b4w_water_dst_noise_freq1"in n||(n.b4w_water_dst_noise_freq1=1,c("material",n,"b4w_water_dst_noise_freq1")),
"b4w_water_dir_min_shore_fac"in n||(n.b4w_water_dir_min_shore_fac=.4,c("material",n,"b4w_water_dir_min_shore_fac")),"b4w_water_dir_freq"in n||(n.b4w_water_dir_freq=.5,c("material",n,"b4w_water_dir_freq")),"b4w_water_dir_noise_scale"in n||(n.b4w_water_dir_noise_scale=.05,c("material",n,"b4w_water_dir_noise_scale")),"b4w_water_dir_noise_freq"in n||(n.b4w_water_dir_noise_freq=.07,c("material",n,"b4w_water_dir_noise_freq")),"b4w_water_dir_min_noise_fac"in n||(n.b4w_water_dir_min_noise_fac=.5,c("material",
n,"b4w_water_dir_min_noise_fac")),"b4w_water_dst_min_fac"in n||(n.b4w_water_dst_min_fac=.2,c("material",n,"b4w_water_dst_min_fac")),"b4w_water_waves_hor_fac"in n||(n.b4w_water_waves_hor_fac=5,c("material",n,"b4w_water_waves_hor_fac")),"b4w_water_absorb_factor"in n||(n.b4w_water_absorb_factor=6,c("material",n,"b4w_water_absorb_factor")),"b4w_water_fog_color"in n||(n.b4w_water_fog_color=new Float32Array(3),n.b4w_water_fog_color=[.5,.7,.7],c("material",n,"b4w_water_fog_color")),"b4w_foam_factor"in n||
(n.b4w_foam_factor=5,c("material",n,"b4w_foam_factor")),"b4w_generated_mesh"in n||(n.b4w_generated_mesh=!1,c("material",n,"b4w_generated_mesh")),"b4w_water_num_cascads"in n||(n.b4w_water_num_cascads=5,c("material",n,"b4w_water_num_cascads")),"b4w_water_subdivs"in n||(n.b4w_water_subdivs=64,c("material",n,"b4w_water_subdivs")),"b4w_water_detailed_dist"in n||(n.b4w_water_detailed_dist=1E3,c("material",n,"b4w_water_detailed_dist")));"b4w_dynamic_grass_size"in n||(n.b4w_dynamic_grass_size="");"b4w_dynamic_grass_color"in
n||(n.b4w_dynamic_grass_color="");"diffuse_intensity"in n||(n.diffuse_intensity=1,c("material",n,"diffuse_intensity"));"b4w_use_ghost"in n||(n.b4w_use_ghost=!1);"b4w_collision_group"in n||(n.b4w_collision_group=128,c("material",n,"b4w_collision_group"));"b4w_collision_mask"in n||(n.b4w_collision_mask=127,c("material",n,"b4w_collision_mask"));"b4w_do_not_render"in n||(n.b4w_do_not_render=!1,c("material",n,"b4w_do_not_render"));"HALO"!=n.type||"b4w_halo_sky_stars"in n||(n.b4w_halo_sky_stars=!1,c("material",
n,"b4w_halo_sky_stars"));"HALO"!=n.type||"b4w_halo_stars_blend_height"in n||(n.b4w_halo_stars_blend_height=10,c("material",n,"b4w_halo_stars_blend_height"));"HALO"!=n.type||"b4w_halo_stars_min_height"in n||(n.b4w_halo_stars_min_height=0,c("material",n,"b4w_halo_stars_min_height"));"specular_shader"in n||(n.specular_shader="COOKTORR",c("material",n,"specular_shader"));"diffuse_shader"in n||(n.diffuse_shader="LAMBERT",c("material",n,"diffuse_shader"));"roughness"in n||(n.roughness=.5,c("material",n,
"roughness"));"diffuse_fresnel"in n||(n.diffuse_fresnel=.1,c("material",n,"diffuse_fresnel"));"diffuse_fresnel_factor"in n||(n.diffuse_fresnel_factor=.5,c("material",n,"diffuse_fresnel_factor"));"specular_slope"in n||(n.specular_slope=.2,c("material",n,"specular_slope"));"specular_toon_size"in n||(n.specular_toon_size=.5,c("material",n,"specular_toon_size"));"specular_toon_smooth"in n||(n.specular_toon_smooth=.1,c("material",n,"specular_toon_smooth"));"specular_alpha"in n||(n.specular_alpha=1,c("material",
n,"specular_alpha"));"b4w_wettable"in n||(n.b4w_wettable=!1,c("material",n,"b4w_wettable"));"b4w_refractive"in n||(n.b4w_refractive=!1,c("material",n,"b4w_refractive"));"b4w_refr_bump"in n||(n.b4w_refr_bump=0,c("material",n,"b4w_refr_bump"));"b4w_shallow_water_col"in n||(n.b4w_shallow_water_col=[0,.8,.3],c("material",n,"b4w_shallow_water_col"));"b4w_shore_water_col"in n||(n.b4w_shore_water_col=[0,.9,.2],c("material",n,"b4w_shore_water_col"));"b4w_shallow_water_col_fac"in n||(n.b4w_shallow_water_col_fac=
1,c("material",n,"b4w_shallow_water_col_fac"));"b4w_shore_water_col_fac"in n||(n.b4w_shore_water_col_fac=.5,c("material",n,"b4w_shore_water_col_fac"));"b4w_water_sss_strength"in n||(n.b4w_water_sss_strength=5.9,c("material",n,"b4w_water_sss_strength"));"b4w_water_sss_width"in n||(n.b4w_water_sss_width=.45,c("material",n,"b4w_water_sss_width"));"b4w_render_above_all"in n||(n.b4w_render_above_all=!1,c("material",n,"b4w_render_above_all"));"b4w_water_norm_uv_velocity"in n||(n.b4w_water_norm_uv_velocity=
.05,c("material",n,"b4w_water_norm_uv_velocity"));t=n.texture_slots;for(b=0;b<t.length;b++){var m=t[b];"blend_type"in m||(m.blend_type="MIX",c("texture_slot",m,"blend_type"))}if(n.node_tree)for(n=n.node_tree.nodes,b=0;b<n.length;b++)r(n[b])}f=a.node_groups;for(h=0;h<f.length;h++)for(n=f[h].node_tree.nodes,b=0;b<n.length;b++)r(n[b]);f=a.objects;for(h=0;h<f.length;h++){n=f[h];switch(n.type){case "MESH":"b4w_dynamic_geometry"in n||(n.b4w_dynamic_geometry=!1);"b4w_reflexible"in n||(n.b4w_reflexible=!1);
"b4w_reflexible_only"in n||(n.b4w_reflexible_only=!1);"b4w_reflective"in n||(n.b4w_reflective=!1);"b4w_wind_bending"in n||(n.b4w_wind_bending=!1,c("object",n,"b4w_wind_bending"));"b4w_wind_bending_angle"in n||(n.b4w_wind_bending_angle=10,n.b4w_wind_bending_freq=.25,c("object",n,"wind bending params"));"b4w_detail_bending_amp"in n||(n.b4w_detail_bending_amp=.1,n.b4w_branch_bending_amp=.3,c("object",n,"detail bending params"));"b4w_detail_bending_freq"in n||(n.b4w_detail_bending_freq=1,c("object",n,
"b4w_detail_bending_freq"));"b4w_main_bend_stiffness_col"in n||(n.b4w_main_bend_stiffness_col="",c("object",n,"b4w_main_bend_stiffness_col"));"b4w_detail_bend_colors"in n||(n.b4w_detail_bend_colors={leaves_stiffness_col:"",leaves_phase_col:"",overall_stiffness_col:""},c("object",n,"b4w_detail_bend_colors"));"b4w_caustics"in n||(n.b4w_caustics=!1);"vertex_groups"in n&&n.vertex_groups.length&&n.data&&0==n.data.vertex_groups.length&&(n.data.vertex_groups=n.vertex_groups,delete n.vertex_groups,c("object",
n,"vertex_groups"));"b4w_vertex_anim"in n&&n.b4w_vertex_anim.length&&n.data&&0==n.data.b4w_vertex_anim.length&&(n.data.b4w_vertex_anim=n.b4w_vertex_anim,delete n.b4w_vertex_anim,c("object",n,"b4w_vertex_anim"));"b4w_do_not_render"in n||(n.b4w_do_not_render=!1);"use_ghost"in n.game||(n.game.use_ghost=!1);"use_sleep"in n.game||(n.game.use_sleep=!1);"velocity_min"in n.game||(n.game.velocity_min=0);"velocity_max"in n.game||(n.game.velocity_max=0);"collision_group"in n.game||(n.game.collision_group=1);
"collision_mask"in n.game||(n.game.collision_mask=255);"b4w_vehicle_settings"in n?n.b4w_vehicle_settings&&("steering_ratio"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.steering_ratio=10),"steering_max"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.steering_max=1),"inverse_control"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.inverse_control=!1),"force_max"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.force_max=1500),"brake_max"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.brake_max=
100),"speed_ratio"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.speed_ratio=.027),"max_speed_angle"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.max_speed_angle=Math.PI),"delta_tach_angle"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.delta_tach_angle=4.43),"suspension_compression"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.suspension_compression=4.4),"suspension_stiffness"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.suspension_stiffness=20),"suspension_damping"in n.b4w_vehicle_settings||
(n.b4w_vehicle_settings.suspension_damping=2.3),"wheel_friction"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.wheel_friction=1E3),"roll_influence"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.roll_influence=.1),"max_suspension_travel_cm"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.max_suspension_travel_cm=30),"floating_factor"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.floating_factor=3),"floating_factor"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.floating_factor=3),
"water_lin_damp"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.water_lin_damp=.9),"water_rot_damp"in n.b4w_vehicle_settings||(n.b4w_vehicle_settings.water_rot_damp=.9)):(n.b4w_vehicle_settings=null,c("object",n,"b4w_vehicle_settings"));"b4w_floating_settings"in n?n.b4w_floating_settings&&("floating_factor"in n.b4w_floating_settings||(n.b4w_floating_settings.floating_factor=3),"water_lin_damp"in n.b4w_floating_settings||(n.b4w_floating_settings.water_lin_damp=.8),"water_rot_damp"in n.b4w_floating_settings||
(n.b4w_floating_settings.water_rot_damp=.8)):(n.b4w_floating_settings=null,c("object",n,"b4w_floating_settings"));"b4w_character_settings"in n?n.b4w_character_settings&&("walk_speed"in n.b4w_character_settings||(n.b4w_character_settings.walk_speed=4),"run_speed"in n.b4w_character_settings||(n.b4w_character_settings.run_speed=8),"step_height"in n.b4w_character_settings||(n.b4w_character_settings.step_height=.25),"jump_strength"in n.b4w_character_settings||(n.b4w_character_settings.jump_strength=5),
"waterline"in n.b4w_character_settings||(n.b4w_character_settings.waterline=0)):(n.b4w_character_settings=null,c("object",n,"b4w_character_settings"));"b4w_selectable"in n||(n.b4w_selectable=!1,c("object",n,"b4w_selectable"));"b4w_billboard"in n||(n.b4w_billboard=!1,c("object",n,"b4w_billboard"));"b4w_billboard_geometry"in n||(n.b4w_billboard_geometry="SPHERICAL",c("object",n,"b4w_billboard_geometry"));"b4w_glow_settings"in n||(n.b4w_glow_settings={},n.b4w_glow_settings.glow_duration=1,n.b4w_glow_settings.glow_period=
1,n.b4w_glow_settings.glow_relapses=0,c("object",n,"b4w_glow_settings"));"b4w_lod_transition"in n||(n.b4w_lod_transition=.01,c("object",n,"b4w_lod_transition"));"lod_levels"in n||(n.lod_levels=[],c("object",n,"lod_levels"));"b4w_animation_mixing"in n||(n.b4w_animation_mixing=!1,c("object",n,"b4w_animation_mixing"));break;case "EMPTY":"b4w_group_relative"in n||(n.b4w_group_relative=!1,c("object",n,"b4w_group_relative"))}"b4w_anim_behavior"in n||(n.b4w_anim_behavior=n.b4w_cyclic_animation?"CYCLIC":
"FINISH_STOP",c("object",n,"b4w_anim_behavior"));if(!("rotation_quaternion"in n)){b=[0,0,0,1];k.euler_to_quat(n.rotation_euler,b);var t=b,m=b[0],g=b[1],l=b[2];t[0]=b[3];t[1]=m;t[2]=g;t[3]=l;n.rotation_quaternion=b;c("object",n,"rotation_quaternion")}"webgl_do_not_batch"in n&&(n.b4w_do_not_batch=n.webgl_do_not_batch)&&d("object",n,"webgl_do_not_batch");"b4w_shadow_cast_only"in n||(n.b4w_shadow_cast_only=!1,c("object",n,"b4w_shadow_cast_only"));"b4w_correct_bounding_offset"in n||(n.b4w_correct_bounding_offset=
"AUTO",c("object",n,"b4w_correct_bounding_offset"));t=n.particle_systems;for(b=0;b<t.length;b++)m=t[b],g=m.settings,"use_whole_group"in g||(g.use_whole_group=!1,c("object",g,"use_whole_group")),m.transforms||(m.transforms=new Float32Array,c("particle_system",m,"transforms")),"b4w_billboard_align"in g||(g.b4w_billboard_align="VIEW",c("particle_settings",g,"b4w_billboard_align")),"b4w_dynamic_grass"in g||(g.b4w_dynamic_grass=!1,c("object",g,"b4w_dynamic_grass")),"b4w_dynamic_grass_scale_threshold"in
g||(g.b4w_dynamic_grass_scale_threshold=.01,c("object",g,"b4w_dynamic_grass_scale_threshold")),"b4w_initial_rand_rotation"in g||(g.b4w_initial_rand_rotation=!1,c("particle_settings",g,"b4w_initial_rand_rotation")),"b4w_rotation_type"in g||(g.b4w_rotation_type="Z",c("particle_settings",g,"b4w_rotation_type")),"b4w_rand_rotation_strength"in g||(g.b4w_rand_rotation_strength=1,c("particle_settings",g,"b4w_rand_rotation_strength")),"b4w_hair_billboard"in g||(g.b4w_hair_billboard=!1,c("particle_settings",
g,"b4w_hair_billboard")),"b4w_hair_billboard_type"in g||(g.b4w_hair_billboard_type="BASIC",c("particle_settings",g,"b4w_hair_billboard_type")),"b4w_hair_billboard_jitter_amp"in g||(g.b4w_hair_billboard_jitter_amp=0,c("particle_settings",g,"b4w_hair_billboard_jitter_amp")),"b4w_hair_billboard_jitter_freq"in g||(g.b4w_hair_billboard_jitter_freq=0,c("particle_settings",g,"b4w_hair_billboard_jitter_freq")),"b4w_hair_billboard_geometry"in g||(g.b4w_hair_billboard_geometry="SPHERICAL",c("particle_settings",
g,"b4w_hair_billboard_geometry")),"b4w_wind_bend_inheritance"in g||(g.b4w_wind_bend_inheritance="PARENT",c("particle_settings",g,"b4w_wind_bend_inheritance")),"b4w_shadow_inheritance"in g||(g.b4w_shadow_inheritance="PARENT",c("particle_settings",g,"b4w_shadow_inheritance")),"b4w_reflection_inheritance"in g||(g.b4w_reflection_inheritance="PARENT",c("particle_settings",g,"b4w_reflection_inheritance")),"b4w_vcol_from_name"in g||(g.b4w_vcol_from_name="",c("particle_settings",g,"b4w_vcol_from_name")),
"b4w_vcol_to_name"in g||(g.b4w_vcol_to_name="",c("particle_settings",g,"b4w_vcol_to_name")),"b4w_coordinate_system"in g||(g.b4w_coordinate_system="LOCAL",c("particle_settings",g,"b4w_coordinate_system")),"b4w_allow_nla"in g||(g.b4w_allow_nla=!0,c("particle_settings",g,"b4w_allow_nla"));"constraints"in n||(n.constraints=[],c("object",n,"constraints"));t=n.modifiers;for(b=0;b<t.length;b++){a:{m=t[b];switch(m.type){case "ARRAY":if(!("fit_type"in m)){e.error("WARNING Incomplete modifier "+String(m.type)+
' for "'+n.name+'", reexport '+(n.library?"library"+n.library.split("/").slice(-1)[0]:"main scene"));m=!1;break a}}m=!0}m||(t.splice(b,1),b--)}"animation_data"in n||(n.animation_data={action:null,nla_tracks:[]},c("object",n,"animation_data"));if(n.animation_data)for(("action"in n.animation_data)||(n.animation_data.action=null,e.warn("B4W Warning: no action in animation data "+n.name)),("nla_tracks"in n.animation_data)||(n.animation_data.nla_tracks=[],e.warn("B4W Warning: no NLA in animation data "+
n.name)),t=n.animation_data.nla_tracks,b=0;b<t.length;b++)for(m=t[b],g=0;g<m.strips.length;g++)l=m.strips[g],"action"in l||(l.action=null,e.warn("B4W Warning: no action in NLA strip "+n.name)),"action_frame_start"in l||(l.action_frame_start=0,e.warn("B4W Warning: no action_frame_start in NLA strip "+n.name)),"action_frame_end"in l||(l.action_frame_end=l.frame_end-l.frame_start,e.warn("B4W Warning: no action_frame_start in NLA strip "+n.name));"b4w_collision_id"in n||(n.b4w_collision_id="",c("material",
n,"b4w_collision_id"));t=n.scale;b=Math.abs((t[0]-t[1])/t[0]);t=Math.abs((t[1]-t[2])/t[1]);.001>b&&.001>t||e.warn("B4W Warning: non-uniform scale for object "+n.name)}for(var s in x)h=x[s],b=s.match(/.*?(?=>>|$)/i)[0],e.warn("WARNING "+String(b)+" is "+h.report_type+" for "+h.type+", reexport "+a.b4w_filepath_blend)};a.apply_mesh_modifiers=function(a){var c;a:{c=a.modifiers;for(var d=0;d<c.length;d++){var e=c[d].type;if("ARRAY"==e||"CURVE"==e){c=!0;break a}}c=!1}if(!c)return null;c=b(a.data,a.data.name+
"_MOD");a=a.modifiers;for(d=0;d<a.length;d++){var n=a[d];switch(n.type){case "ARRAY":for(var e=c,t=n,x=0,r=0,z=0,B=new Float32Array(16),n=[],K=1;K<t.count;K++){t.use_constant_offset&&(x+=t.constant_offset_displace[0],r+=t.constant_offset_displace[1],z+=t.constant_offset_displace[2]);if(t.use_relative_offset)var v=e.b4w_bounding_box,x=x+(v.max_x-v.min_x)*t.relative_offset_displace[0],r=r+(v.max_y-v.min_y)*t.relative_offset_displace[1],z=z+(v.max_z-v.min_z)*t.relative_offset_displace[2];k.trans_matrix(x,
r,z,B);for(var Q=v=b(e),O=B,L=0;L<Q.submeshes.length;L++){var G=Q.submeshes[L];k.positions_multiply_matrix(G.position,O,G.position,0);k.vectors_multiply_matrix(G.normal,O,G.normal,0);k.tangents_multiply_matrix(G.tangent,O,G.tangent,0)}n.push(v)}for(K=0;K<n.length;K++)for(t=e,x=n[K],r=0;r<t.submeshes.length;r++){z=t.submeshes[r];B=x.submeshes[r];v=z.base_length;Q=z.indices.length;z.base_length+=B.base_length;for(var V in z)if("base_length"!=V)if("indices"==V)for(z[V]=k.uint32_concat(z[V],B[V]),O=Q;O<
z.indices.length;O++)z.indices[O]+=v;else z[V]=k.float32_concat(z[V],B[V])}break;case "CURVE":for(var e=c,K=n.object._spline,t=new Float32Array(16),r=K.is_3d?4:3,x=new Float32Array(r),r=new Float32Array(r),z=new Float32Array(3),B=new Float32Array(4),v=new Float32Array(4),Q=new Float32Array(3),O=new Float32Array(3),L=new Float32Array(3),G=new Float32Array(4),q=new Float32Array(4),P=0;P<e.submeshes.length;P++){var Y=e.submeshes[P],T=Y.position,X=Y.normal,Y=Y.tangent,p;a:switch(p=n.deform_axis,p){case "POS_X":case "NEG_X":p=
0;break a;case "POS_Y":case "NEG_Y":p=1;break a;case "POS_Z":case "NEG_Z":p=2;break a;default:throw"Wrong deform axis value "+p;}Q[0]=0;Q[1]=0;Q[2]=0;Q[p]=1;for(var ga=h.spline_length(K),Z=0;Z<T.length/3;Z++){L[0]=T[3*Z];L[1]=T[3*Z+1];L[2]=T[3*Z+2];var N=L[p],F=h.spline_len_to_t(K,N);h.spline_point(K,F,x);z[0]=x[0];z[1]=x[1];z[2]=x[2];h.spline_derivative(K,F,r);O[0]=r[0];O[1]=0;O[2]=r[2];g.normalize(O,O);m.rotationTo(Q,O,B);0>N?(x[0]=O[0],x[1]=O[1],x[2]=O[2],g.scale(x,N,x),g.add(z,x,z)):N>ga&&(x[0]=
O[0],x[1]=O[1],x[2]=O[2],g.scale(x,N-ga,x),g.add(z,x,z));s.fromRotationTranslation(B,z,t);K.is_3d&&(m.setAxisAngle(Q,x[3],v),g.transformQuat(L,v,L));L[p]=0;g.transformMat4(L,t,L);T[3*Z]=L[0];T[3*Z+1]=L[1];T[3*Z+2]=L[2];X.length&&(G[0]=X[3*Z],G[1]=X[3*Z+1],G[2]=X[3*Z+2],G[3]=0,y.transformMat4(G,t,G),X[3*Z]=G[0],X[3*Z+1]=G[1],X[3*Z+2]=G[2]);Y.length&&(q[0]=Y[3*Z],q[1]=Y[3*Z+1],q[2]=Y[3*Z+2],q[3]=0,y.transformMat4(q,t,q),Y[3*Z]=q[0],Y[3*Z+1]=q[1],Y[3*Z+2]=q[2])}}}l.recalculate_mesh_boundings(c)}return c};
a.create_material=function(a){return{name:a,use_nodes:!1,diffuse_shader:"LAMBERT",diffuse_color:[.8,.8,.8],diffuse_intensity:1,alpha:1,raytrace_transparency:{fresnel:0,fresnel_factor:1.25},raytrace_mirror:{reflect_factor:0,fresnel:0,fresnel_factor:1.25},specular_color:[1,1,1],specular_intensity:.5,specular_shader:"COOKTORR",specular_hardness:50,specular_slope:.2,emit:0,ambient:1,use_vertex_color_paint:!1,b4w_water:!1,b4w_water_shore_smoothing:!1,b4w_water_dynamic:!1,b4w_generated_mesh:!1,b4w_waves_height:1,
b4w_water_fog_color:[.5,.5,.5],b4w_water_fog_density:.06,b4w_water_num_cascads:5,b4w_water_subdivs:64,b4w_water_detailed_dist:1E3,b4w_terrain:!1,b4w_collision:!1,b4w_collision_id:"",b4w_double_sided_lighting:!1,physics:{friction:.5,elasticity:0},type:"SURFACE",use_transparency:!1,use_shadeless:!1,offset_z:0,b4w_render_above_all:!1,game_settings:{alpha_blend:"OPAQUE",use_backface_culling:!0},halo:{size:.5,hardness:50,b4w_halo_rings_color:[1,1,1],b4w_halo_lines_color:[1,1,1],b4w_halo_stars_blend_height:10,
b4w_halo_stars_min_height:0},node_tree:null,texture_slots:[]}};a.assign_nla_object_params=function(a,b){for(var c=0;c<b.length;c++){var d=b[c];if(d.b4w_use_nla)for(var d=d.b4w_nla_script,e=0;e<d.length;e++){var k=d[e];switch(k.type){case "SELECT":case "SELECT_PLAY":for(var h=0;h<a.length;h++){var g=a[h];g.name==k.object&&(g.b4w_selectable=!0)}break;case "SHOW":case "HIDE":for(h=0;h<a.length;h++)g=a[h],g.name==k.object&&(g.b4w_do_not_batch=!0)}}}}};b4w.module.__renderer=function(a,q){function r(a){if(a){var b=(a.clear_color?C.COLOR_BUFFER_BIT:0)|(a.clear_depth?C.DEPTH_BUFFER_BIT:0);if(!b)return;switch(a.type){case "SHADOW_CAST":a=y;break;case "DEPTH":a=m;break;case "COLOR_PICKING":case "COLOR_PICKING_XRAY":a=s;break;case "GLOW_MASK":case "SMAA_BLENDING_WEIGHT_CALCULATION":case "SMAA_EDGE_DETECTION":a=x;break;default:a=g.background_color}}else b=C.COLOR_BUFFER_BIT|C.DEPTH_BUFFER_BIT,a=g.background_color;C.colorMask(!0,!0,!0,!0);C.depthMask(!0);
C.clearColor(a[0],a[1],a[2],a[3]);C.clear(b)}function c(a,b,c){C.bindBuffer(C.ARRAY_BUFFER,a.vbo);for(var d=0;d<b.length;d++){var e=b[d];C.enableVertexAttribArray(e.loc);C.vertexAttribPointer(e.loc,e.num_comp,C.FLOAT,!1,0,e.base_offset+e.frame_length*c)}a.ibo?(C.bindBuffer(C.ELEMENT_ARRAY_BUFFER,a.ibo),C.drawElements(a.mode,a.count,a.ibo_type,0)):C.drawArrays(a.mode,0,a.count);for(d=0;d<b.length;d++)e=b[d],C.disableVertexAttribArray(e.loc)}function d(a){switch(a){case 0:return C.TEXTURE_CUBE_MAP_POSITIVE_X;
case 1:return C.TEXTURE_CUBE_MAP_NEGATIVE_X;case 2:return C.TEXTURE_CUBE_MAP_POSITIVE_Y;case 3:return C.TEXTURE_CUBE_MAP_NEGATIVE_Y;case 4:return C.TEXTURE_CUBE_MAP_POSITIVE_Z;case 5:return C.TEXTURE_CUBE_MAP_NEGATIVE_Z}}function b(a){var b=a.uniforms,c=[],d=[],e={},k;for(k in b){var h=!1;switch(k){case "u_proj_matrix":var g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,e.proj_matrix)},h=!0;break;case "u_view_matrix":case "u_view_matrix_frag":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,e.view_matrix)};
h=!0;break;case "u_shadow_cast_billboard_view_matrix":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,e.shadow_cast_billboard_view_matrix)};h=!0;break;case "u_view_proj_prev":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,e.prev_view_proj_matrix)};h=!0;break;case "u_view_proj_inverse":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,e.view_proj_inv_matrix)};h=!0;break;case "u_sky_vp_inverse":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,e.sky_vp_inv_matrix)};h=!0;break;case "u_camera_eye":case "u_camera_eye_frag":g=
function(a,b,c,d,f,e){a.uniform3fv(b,e.eye)};h=!0;break;case "u_camera_eye_last":g=function(a,b,c,d,f,e){a.uniform3fv(b,e.eye_last)};h=!0;break;case "u_camera_quat":g=function(a,b,c,d,f,e){a.uniform4fv(b,e.quat)};h=!0;break;case "u_view_max_depth":g=function(a,b,c,d,f,e){a.uniform1f(b,e.far)};h=!0;break;case "u_camera_range":g=function(a,b,c,d,f,e){a.uniform2f(b,e.near,e.far)};break;case "u_csm_center_dists":g=function(a,b,c,d,f,e){a.uniform4fv(b,e.csm_center_dists)};break;case "u_cam_water_depth":g=
function(a,b,c,d,f,e){a.uniform1f(b,c.cam_water_depth)};h=!0;break;case "u_waves_height":g=function(a,b,c,d,f,e){a.uniform1f(b,c.water_waves_height)};break;case "u_waves_length":g=function(a,b,c,d,f,e){a.uniform1f(b,c.water_waves_length)};break;case "u_fog_color_density":g=function(a,b,c,d,f,e){a.uniform4fv(b,c.fog_color_density)};break;case "u_underwater_fog_color_density":g=function(a,b,c,d,f,e){a.uniform4fv(b,c.water_fog_color_density)};break;case "u_bloom_key":g=function(a,b,c,d,f,e){a.uniform1f(b,
c.bloom_key)};break;case "u_bloom_edge_lum":g=function(a,b,c,d,f,e){a.uniform1f(b,c.bloom_edge_lum)};break;case "u_time":g=function(a,b,c,d,f,e){a.uniform1f(b,c.time)};h=!0;break;case "u_wind":g=function(a,b,c,d,f,e){a.uniform3fv(b,c.wind)};break;case "u_horizon_color":g=function(a,b,c,d,f,e){a.uniform3fv(b,c.horizon_color)};break;case "u_zenith_color":g=function(a,b,c,d,f,e){a.uniform3fv(b,c.zenith_color)};break;case "u_environment_energy":g=function(a,b,c,d,f,e){a.uniform1f(b,c.environment_energy)};
break;case "u_sky_color":g=function(a,b,c,d,f,e){a.uniform3fv(b,c.sky_color)};break;case "u_rayleigh_brightness":g=function(a,b,c,d,f,e){a.uniform1f(b,c.rayleigh_brightness)};break;case "u_mie_brightness":g=function(a,b,c,d,f,e){a.uniform1f(b,c.mie_brightness)};break;case "u_spot_brightness":g=function(a,b,c,d,f,e){a.uniform1f(b,c.spot_brightness)};break;case "u_scatter_strength":g=function(a,b,c,d,f,e){a.uniform1f(b,c.scatter_strength)};break;case "u_rayleigh_strength":g=function(a,b,c,d,f,e){a.uniform1f(b,
c.rayleigh_strength)};break;case "u_mie_strength":g=function(a,b,c,d,f,e){a.uniform1f(b,c.mie_strength)};break;case "u_rayleigh_collection_power":g=function(a,b,c,d,f,e){a.uniform1f(b,c.rayleigh_collection_power)};break;case "u_mie_collection_power":g=function(a,b,c,d,f,e){a.uniform1f(b,c.mie_collection_power)};break;case "u_mie_distribution":g=function(a,b,c,d,f,e){a.uniform1f(b,c.mie_distribution)};break;case "u_light_positions":g=function(a,b,c,d,f,e){a.uniform3fv(b,c.light_positions)};break;case "u_light_directions":g=
function(a,b,c,d,f,e){a.uniform3fv(b,c.light_directions)};break;case "u_light_color_intensities":g=function(a,b,c,d,f,e){a.uniform3fv(b,c.light_color_intensities)};break;case "u_light_factors1":g=function(a,b,c,d,f,e){a.uniform4fv(b,c.light_factors1)};break;case "u_light_factors2":g=function(a,b,c,d,f,e){a.uniform4fv(b,c.light_factors2)};break;case "u_shadow_lamp_id":g=function(a,b,c,d,f,e){a.uniform1i(b,c.shadow_lamp_id)};break;case "u_sun_quaternion":g=function(a,b,c,d,f,e){a.uniform4fv(b,c.sun_quaternion)};
break;case "u_sun_intensity":g=function(a,b,c,d,f,e){a.uniform3fv(b,c.sun_intensity)};break;case "u_sun_direction":g=function(a,b,c,d,f,e){a.uniform3fv(b,c.sun_direction)};break;case "u_height":g=function(a,b,c,d,f,e){a.uniform1f(b,e.height)};h=!0;break;case "u_model_matrix":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,d.world_matrix)};h=!0;break;case "u_transb":g=function(a,b,c,d,f,e){a.uniform4fv(b,d.trans_before)};h=!0;break;case "u_transa":g=function(a,b,c,d,f,e){a.uniform4fv(b,d.trans_after)};
h=!0;break;case "u_quat":g=function(a,b,c,d,f,e){a.uniform4fv(b,d.quat)};h=!0;break;case "u_quatsb":g=function(a,b,c,d,f,e){a.uniform4fv(b,d.quats_before)};h=!0;break;case "u_quatsa":g=function(a,b,c,d,f,e){a.uniform4fv(b,d.quats_after)};h=!0;break;case "u_frame_factor":g=function(a,b,c,d,f,e){a.uniform1f(b,d.frame_factor)};h=!0;break;case "au_center_pos":g=function(a,b,c,d,f,e){};h=!0;break;case "au_wind_bending_amp":g=function(a,b,c,d,f,e){a.uniform1f(b,d.wind_bending_amp)};h=!0;break;case "au_wind_bending_freq":g=
function(a,b,c,d,f,e){a.uniform1f(b,d.wind_bending_freq)};h=!0;break;case "au_detail_bending_freq":g=function(a,b,c,d,f,e){a.uniform1f(b,d.detail_bending_freq)};h=!0;break;case "au_detail_bending_amp":g=function(a,b,c,d,f,e){a.uniform1f(b,d.detail_bending_amp)};h=!0;break;case "au_branch_bending_amp":g=function(a,b,c,d,f,e){a.uniform1f(b,d.branch_bending_amp)};h=!0;break;case "u_anim_values":g=function(a,b,c,d,f,e){a.uniform1fv(b,d.mats_anim_values)};h=!0;break;case "u_diffuse_color":g=function(a,
b,c,d,f,e){a.uniform4fv(b,f.diffuse_color)};h=!0;break;case "u_diffuse_intensity":g=function(a,b,c,d,f,e){a.uniform1f(b,f.diffuse_intensity)};h=!0;break;case "u_diffuse_params":g=function(a,b,c,d,f,e){a.uniform2fv(b,f.diffuse_params)};h=!0;break;case "u_emit":g=function(a,b,c,d,f,e){a.uniform1f(b,f.emit)};h=!0;break;case "u_ambient":g=function(a,b,c,d,f,e){a.uniform1f(b,f.ambient)};h=!0;break;case "u_specular_color":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.specular_color)};h=!0;break;case "u_specular_alpha":g=
function(a,b,c,d,f,e){a.uniform1f(b,f.specular_alpha)};h=!0;break;case "u_specular_params":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.specular_params)};h=!0;break;case "u_reflect_factor":g=function(a,b,c,d,f,e){a.uniform1f(b,f.reflect_factor)};h=!0;break;case "u_mirror_factor":g=function(a,b,c,d,f,e){a.uniform1f(b,f.mirror_factor)};h=!0;break;case "u_grass_map_dim":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.grass_map_dim)};h=!0;break;case "u_grass_size":g=function(a,b,c,d,f,e){a.uniform1f(b,f.grass_size)};
h=!0;break;case "u_scale_threshold":g=function(a,b,c,d,f,e){a.uniform1f(b,f.grass_scale_threshold)};h=!0;break;case "u_cube_fog":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,f.cube_fog)};break;case "u_jitter_amp":g=function(a,b,c,d,f,e){a.uniform1f(b,f.jitter_amp)};h=!0;break;case "u_jitter_freq":g=function(a,b,c,d,f,e){a.uniform1f(b,f.jitter_freq)};h=!0;break;case "u_wireframe_mode":g=function(a,b,c,d,f,e){a.uniform1i(b,f.wireframe_mode)};break;case "u_wireframe_edge_color":g=function(a,b,c,d,
f,e){a.uniform3fv(b,f.wireframe_edge_color)};break;case "u_subpixel_jitter":g=function(a,b,c,d,f,e){a.uniform2fv(b,c.jitter_projection_space)};h=!0;break;case "u_subsample_indices":g=function(a,b,c,d,f,e){a.uniform4fv(b,c.jitter_subsample_ind)};h=!0;break;case "u_refr_bump":g=function(a,b,c,d,f,e){a.uniform1f(b,f.refr_bump)};h=!0;break;case "u_lamp_light_positions":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.lamp_light_positions)};break;case "u_lamp_light_directions":g=function(a,b,c,d,f,e){a.uniform3fv(b,
f.lamp_light_directions)};break;case "u_lamp_light_color_intensities":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.lamp_light_color_intensities)};break;case "u_lamp_light_factors":g=function(a,b,c,d,f,e){a.uniform4fv(b,f.lamp_light_factors)};break;case "u_halo_size":g=function(a,b,c,d,f,e){a.uniform1f(b,f.halo_size)};h=!0;break;case "u_halo_hardness":g=function(a,b,c,d,f,e){a.uniform1f(b,f.halo_hardness)};h=!0;break;case "u_halo_rings_color":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.halo_rings_color)};
h=!0;break;case "u_halo_lines_color":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.halo_lines_color)};h=!0;break;case "u_halo_stars_blend":g=function(a,b,c,d,f,e){a.uniform1f(b,f.halo_stars_blend)};h=!0;break;case "u_halo_stars_height":g=function(a,b,c,d,f,e){a.uniform1f(b,f.halo_stars_height)};h=!0;break;case "u_fresnel_params":g=function(a,b,c,d,f,e){a.uniform4fv(b,f.fresnel_params)};h=!0;break;case "u_texture_scale":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.texture_scale)};h=!0;break;case "u_parallax_scale":g=
function(a,b,c,d,f,e){a.uniform1f(b,f.parallax_scale)};h=!0;break;case "u_color_id":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.color_id)};h=!0;break;case "u_line_points":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.line_points)};h=!0;break;case "u_diffuse_color_factor":g=function(a,b,c,d,f,e){a.uniform1f(b,f.diffuse_color_factor)};h=!0;break;case "u_alpha_factor":g=function(a,b,c,d,f,e){a.uniform1f(b,f.alpha_factor)};h=!0;break;case "u_specular_color_factor":g=function(a,b,c,d,f,e){a.uniform1f(b,f.specular_color_factor)};
h=!0;break;case "u_normal_factor":g=function(a,b,c,d,f,e){a.uniform1f(b,f.normal_factor)};h=!0;break;case "u_normalmap0_scale":g=function(a,b,c,d,f,e){a.uniform2fv(b,f.normalmap_scales[0])};h=!0;break;case "u_normalmap1_scale":g=function(a,b,c,d,f,e){a.uniform2fv(b,f.normalmap_scales[1])};h=!0;break;case "u_normalmap2_scale":g=function(a,b,c,d,f,e){a.uniform2fv(b,f.normalmap_scales[2])};h=!0;break;case "u_normalmap3_scale":g=function(a,b,c,d,f,e){a.uniform2fv(b,f.normalmap_scales[3])};h=!0;break;
case "u_foam_factor":g=function(a,b,c,d,f,e){a.uniform1f(b,f.foam_factor)};h=!0;break;case "u_foam_uv_freq":g=function(a,b,c,d,f,e){a.uniform2fv(b,f.foam_uv_freq)};h=!0;break;case "u_foam_mag":g=function(a,b,c,d,f,e){a.uniform2fv(b,f.foam_mag)};h=!0;break;case "u_foam_scale":g=function(a,b,c,d,f,e){a.uniform2fv(b,f.foam_scale)};h=!0;break;case "u_water_norm_uv_velocity":g=function(a,b,c,d,f,e){a.uniform1f(b,f.water_norm_uv_velocity)};h=!0;break;case "u_shallow_water_col":g=function(a,b,c,d,f,e){a.uniform3fv(b,
f.shallow_water_col)};h=!0;break;case "u_shore_water_col":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.shore_water_col)};h=!0;break;case "u_water_shallow_col_fac":g=function(a,b,c,d,f,e){a.uniform1f(b,f.shallow_water_col_fac)};h=!0;break;case "u_water_shore_col_fac":g=function(a,b,c,d,f,e){a.uniform1f(b,f.shore_water_col_fac)};h=!0;break;case "u_p_length":g=function(a,b,c,d,f,e){a.uniform1f(b,f.p_length)};h=!0;break;case "u_p_cyclic":g=function(a,b,c,d,f,e){a.uniform1i(b,f.p_cyclic)};h=!0;break;case "u_p_max_lifetime":g=
function(a,b,c,d,f,e){a.uniform1f(b,f.p_max_lifetime)};h=!0;break;case "u_p_fade_in":g=function(a,b,c,d,f,e){a.uniform1f(b,f.p_fade_in)};h=!0;break;case "u_p_fade_out":g=function(a,b,c,d,f,e){a.uniform1f(b,f.p_fade_out)};h=!0;break;case "u_p_size":g=function(a,b,c,d,f,e){a.uniform1f(b,f.p_size)};h=!0;break;case "u_p_alpha_start":g=function(a,b,c,d,f,e){a.uniform1f(b,f.p_alpha_start)};h=!0;break;case "u_p_alpha_end":g=function(a,b,c,d,f,e){a.uniform1f(b,f.p_alpha_end)};h=!0;break;case "u_p_nfactor":g=
function(a,b,c,d,f,e){a.uniform1f(b,f.p_nfactor)};h=!0;break;case "u_p_gravity":g=function(a,b,c,d,f,e){a.uniform1f(b,f.p_gravity)};h=!0;break;case "u_p_mass":g=function(a,b,c,d,f,e){a.uniform1f(b,f.p_mass)};h=!0;break;case "u_p_size_ramp":g=function(a,b,c,d,f,e){a.uniform2fv(b,f.p_size_ramp)};h=!0;break;case "u_p_color_ramp":g=function(a,b,c,d,f,e){a.uniform4fv(b,f.p_color_ramp)};h=!0;break;case "u_p_wind":g=function(a,b,c,d,f,e){a.uniform3fv(b,f.p_wind)};h=!0;break;case "u_texel_size":g=function(a,
b,c,d,f,e){a.uniform2fv(b,f.texel_size)};h=!0;break;case "u_p_time":g=function(a,b,c,d,f,e){a.uniform1f(b,f.particle_system._internal.time)};h=!0;break;case "u_va_frame_factor":g=function(a,b,c,d,f,e){a.uniform1f(b,d.va_frame_factor)};h=!0;break;case "u_normal_offset":g=function(a,b,c,d,f,e){a.uniform1f(b,c.self_shadow_normal_offset)};break;case "u_pcf_blur_radii":g=function(a,b,c,d,f,e){a.uniform4fv(b,e.pcf_blur_radii)};break;case "u_v_light_matrix":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,
c.v_light_matrix)};h=!0;break;case "u_b_light_matrix":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,c.b_light_matrix)};break;case "u_p_light_matrix0":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,c.p_light_matrix[0])};h=!0;break;case "u_p_light_matrix1":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,c.p_light_matrix[1])};h=!0;break;case "u_p_light_matrix2":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,!1,c.p_light_matrix[2])};h=!0;break;case "u_p_light_matrix3":g=function(a,b,c,d,f,e){a.uniformMatrix4fv(b,
!1,c.p_light_matrix[3])};h=!0;break;case "u_motion_blur_exp":g=function(a,b,c,d,f,e){a.uniform1f(b,c.motion_blur_exp)};h=!0;break;case "u_refl_plane":g=function(a,b,c,d,f,e){a.uniform4fv(b,c.reflection_plane)};break;case "u_radial_blur_step":g=function(a,b,c,d,f,e){a.uniform1f(b,c.radial_blur_step)};break;case "u_god_rays_intensity":g=function(a,b,c,d,f,e){a.uniform1f(b,c.god_rays_intensity)};break;case "u_ssao_radius_increase":g=function(a,b,c,d,f,e){a.uniform1f(b,c.ssao_radius_increase)};break;
case "u_ssao_blur_discard_value":g=function(a,b,c,d,f,e){a.uniform1f(b,c.ssao_blur_discard_value)};h=!0;break;case "u_ssao_influence":g=function(a,b,c,d,f,e){a.uniform1f(b,c.ssao_influence)};break;case "u_ssao_dist_factor":g=function(a,b,c,d,f,e){a.uniform1f(b,c.ssao_dist_factor)};break;case "u_dof_dist":g=function(a,b,c,d,f,e){a.uniform1f(b,e.dof_distance)};h=!0;break;case "u_dof_front":g=function(a,b,c,d,f,e){a.uniform1f(b,e.dof_front)};h=!0;break;case "u_dof_rear":g=function(a,b,c,d,f,e){a.uniform1f(b,
e.dof_rear)};h=!0;break;case "u_glow_intensity":g=function(a,b,c,d,f,e){a.uniform1f(b,f.glow_intensity)};h=!0;break;case "u_glow_color":g=function(a,b,c,d,f,e){a.uniform3fv(b,c.glow_color)};break;case "u_draw_glow":g=function(a,b,c,d,f,e){a.uniform1f(b,c.draw_glow_flag)};h=!0;break;case "u_brightness":g=function(a,b,c,d,f,e){a.uniform1f(b,c.brightness)};break;case "u_contrast":g=function(a,b,c,d,f,e){a.uniform1f(b,c.contrast)};break;case "u_exposure":g=function(a,b,c,d,f,e){a.uniform1f(b,c.exposure)};
break;case "u_saturation":g=function(a,b,c,d,f,e){a.uniform1f(b,c.saturation)};break;default:g=null}g&&(g={name:k,fun:g,loc:b[k]},h?c.push(g):(d.push(g),e[k]=g))}a.transient_uniform_setters=c;a.permanent_uniform_setters=d;a.permanent_uniform_setters_table=e}var l=q("__config"),h=q("__debug"),e=q("__textures"),k=q("__util"),g=l.defaults,y=[1,1,1,1],m=[1,1,1,1],s=[0,0,0,1],x=[0,0,0,0];new Float32Array([.25,-.25]);new Float32Array([-.25,.25]);new Float32Array([1,1,1,0]);new Float32Array([2,2,2,0]);var C=
null,A=new Uint8Array(4);a.setup_context=function(a){var b=g.background_color;a.clearColor(b[0],b[1],b[2],b[3]);a.clearDepth(1);a.enable(a.DEPTH_TEST);a.depthFunc(a.LEQUAL);a.enable(a.CULL_FACE);a.frontFace(a.CCW);a.cullFace(a.BACK);a.enable(a.BLEND);a.blendFunc(a.ONE,a.ONE_MINUS_SRC_ALPHA);C=a};a.draw=function(a){if(a.do_render){var e=a.camera;C.bindFramebuffer(C.FRAMEBUFFER,e.framebuffer);if(a.assign_texture){var k=e.color_attachment;C.framebufferTexture2D(C.FRAMEBUFFER,C.COLOR_ATTACHMENT0,k.w_target,
k.w_texture,0)}C.viewport(0,0,e.width,e.height);r(a);a.blend?C.enable(C.BLEND):C.disable(C.BLEND);a.depth_test?C.enable(C.DEPTH_TEST):C.disable(C.DEPTH_TEST);if(a.need_perm_uniforms_update){for(var e=a.camera,k=a.bundles,m=0;m<k.length;m++){var l=k[m],s=l.batch,x=s.shader;C.useProgram(x.program);l=l.obj_render;x.permanent_uniform_setters.length||b(x);for(var x=x.permanent_uniform_setters,y=x.length;y--;){var K=x[y];K.fun(C,K.loc,a,l,s,e)}}a.need_perm_uniforms_update=!1}switch(a.type){case "SHADOW_CAST":C.enable(C.POLYGON_OFFSET_FILL);
C.polygonOffset(a.self_shadow_polygon_offset,a.self_shadow_polygon_offset);C.cullFace(C.BACK);break;case "MAIN_REFLECT":C.disable(C.POLYGON_OFFSET_FILL);C.cullFace(C.FRONT);break;default:C.disable(C.POLYGON_OFFSET_FILL),C.cullFace(C.BACK)}e=a.camera;k=a.bundles;for(m=0;m<k.length;m++)if(l=k[m],l.do_render){var s=a,K=e,x=l.obj_render,v=l.batch,l=v.shader;C.useProgram(l.program);for(var q=v.bufs_data,y=v.attribute_setters,O=l.transient_uniform_setters,L=O.length;L--;){var G=O[L];G.fun(C,G.loc,s,x,v,
K)}K=v.color_mask;C.colorMask(K,K,K,K);C.depthMask(v.depth_mask);v.use_backface_culling?C.enable(C.CULL_FACE):C.disable(C.CULL_FACE);K=v.textures;v=v.texture_names;O=l.uniforms;L=K.length|0;if(0!==L)if(1===L)C.activeTexture(C.TEXTURE0),C.bindTexture(K[0].w_target,K[0].w_texture);else for(G=0;G<L;G++){var V=K[G],$=v[G];C.activeTexture(C.TEXTURE0+G);C.bindTexture(V.w_target,V.w_texture);C.uniform1i(O[$],G)}if("SKY"==s.type){K=s;l=l.uniforms;v=K.camera.color_attachment.w_texture;O=K.cube_view_matrices;
for(L=0;6>L;L++)if(G=d(L),g.clear_procedural_sky_hack?(V=new Uint8Array([91.8,142.8,.96*255,255]),C.bindTexture(C.TEXTURE_CUBE_MAP,v),C.texImage2D(G,0,C.RGBA,1,1,0,C.RGBA,C.UNSIGNED_BYTE,V)):(C.uniformMatrix4fv(l.u_cube_view_matrix,!1,O[L]),C.framebufferTexture2D(C.FRAMEBUFFER,C.COLOR_ATTACHMENT0,G,v,0),c(q,y,x.va_frame)),K.need_fog_update&&3!=L){var G=K,V=L,P=A;C.readPixels(191,191,1,1,C.RGBA,C.UNSIGNED_BYTE,P);255!=P[0]&&255!=P[1]&&255!=P[2]||C.readPixels(191,220,1,1,C.RGBA,C.UNSIGNED_BYTE,P);var $=
P[0],Y=P[1],P=P[2],$=$/255,Y=Y/255,P=P/255;2===V?(G.cube_fog[3]=$,G.cube_fog[7]=Y,G.cube_fog[11]=P):2>V?(G.cube_fog[4*V]=$,G.cube_fog[4*V+1]=Y,G.cube_fog[4*V+2]=P):(G.cube_fog[4*(V-2)]=$,G.cube_fog[4*(V-2)+1]=Y,G.cube_fog[4*(V-2)+2]=P)}s.debug_render_calls+=6}else c(q,y,x.va_frame),s.debug_render_calls++}h.check_gl("draw subscene: "+a.type);C.bindFramebuffer(C.FRAMEBUFFER,null)}};a.clear=r;a.assign_attribute_setters=function(a){var b=a.attribute_setters;b.length=0;var c=a.bufs_data;a=a.shader;c&&
a||k.panic("Incomplete batch");c=c.pointers;a=a.attributes;for(var d in a){var e=c[d];b.push({loc:a[d],base_offset:4*e.offset,frame_length:1<e.frames?4*e.length:0,num_comp:e.num_comp})}};a.assign_uniform_setters=b;a.read_pixels=function(a,b,c,d,e,g){d||(d=1);e||(e=1);g||(g=new Uint8Array(4*d*e));g.length!=4*d*e&&k.panic("read_pixels(): Wrong storage");C.bindFramebuffer(C.FRAMEBUFFER,a);C.readPixels(b,c,d,e,C.RGBA,C.UNSIGNED_BYTE,g);C.bindFramebuffer(C.FRAMEBUFFER,null);return g};a.update_batch_permanent_uniform=
function(a,c){var d=a.shader;C.useProgram(d.program);d.permanent_uniform_setters.length||b(d);d=d.permanent_uniform_setters_table[c];d.fun(C,d.loc,null,null,a,null)};a.render_target_create=function(a,b){var c=C.createFramebuffer();C.bindFramebuffer(C.FRAMEBUFFER,c);if(a){var d=a,g=d.w_texture,d=d.w_target==C.TEXTURE_CUBE_MAP?C.TEXTURE_CUBE_MAP_NEGATIVE_Z:d.w_target;C.framebufferTexture2D(C.FRAMEBUFFER,C.COLOR_ATTACHMENT0,d,g,0)}e.is_renderbuffer(b)?C.framebufferRenderbuffer(C.FRAMEBUFFER,C.DEPTH_ATTACHMENT,
C.RENDERBUFFER,b.w_renderbuffer):e.is_texture(b)&&(d=b,g=d.w_texture,d=d.w_target,C.framebufferTexture2D(C.FRAMEBUFFER,C.DEPTH_ATTACHMENT,d,g,0));h.check_bound_fb();C.bindFramebuffer(C.FRAMEBUFFER,null);return c};a.render_target_cleanup=function(a,b,c,d,g){null==a?(C.bindFramebuffer(C.FRAMEBUFFER,a),C.viewport(0,0,d,g),C.clear(C.COLOR_BUFFER_BIT|C.DEPTH_BUFFER_BIT)):(e.is_texture(b)&&C.deleteTexture(b.w_texture),e.is_renderbuffer(c)?C.deleteRenderbuffer(c.w_renderbuffer):e.is_texture(c)&&C.deleteTexture(c.w_texture),
C.deleteFramebuffer(a))};a.increment_subpixel_index=function(){};a.cleanup=function(){}};b4w.module.__shaders=function(a,q){function r(a,b,d){var f=a.directives;"string"==typeof d&&(a=c(a,d))&&(d=a[1]);for(a=0;a<f.length;a++)if(f[a][0]==b){f[a][1]=d;return}f.push([b,d])}function c(a,b){for(var c=a.directives,d=0;d<c.length;d++)if(c[d][0]==b)return c[d];return!1}function d(a,b){var c=a+b;if(t[c])return t[c];if(f){var d=f[b];if(!d)return null}else{d=C.get_text_sync(a+b,!1);if(!d)return null;d=E.parser.parse(d)}return t[c]=d}function b(a,b,c,f){function e(b){b=b.parts;for(var c=0;c<b.length;c++){var k=
b[c];switch(k.type){case "condition":a:for(var k=k.parts,s=0;s<k.length;s++){var p=k[s];switch(p.type){case "if":case "elif":var y=p.expression;try{var G,C=l(y,h,n,!0);G=x.parser.parse(C)}catch(K){throw"Failed to process #"+p.type+" expression: "+y.join(" ");}if(G){e(p.group);break a}break;case "else":e(p.group);break;case "ifdef":p.name in h&&e(p.group);break;case "ifndef":p.name in h||e(p.group)}}break;case "include":k=d(A.shaders_dir,A.shaders_include_dir+k.file);e(k);break;case "var":case "export":case "import":break;
case "define":s=k.name;h[s]=k.tokens;k.params&&(n[s]=k.params);break;case "error":throw"Shader error: #error "+k.tokens.join(" ");case "line":break;case "pragma":g.push("#pragma "+k.name+" "+k.tokens.join(" "));break;case "undef":k=k.name;delete h[k];delete n[k];break;case "warning":m.warn("Shader warning: #warning "+k.tokens.join(" "));break;case "extension":g.push("#extension "+l(k.tokens,h,n,!1));break;case "#":break;case "node":t[k.name]=k.group.parts;break;case "nodes_global":k=f;for(s=0;s<k.length;s++)if(p=
k[s],y=t[p.id])for(var E=0,B=0;B<y.length;B++){var D=y[B];"node_param"==D.type&&(D=D.qualifier.join(" ")+" ","vert"==a?D+=p.vparams[E]:"frag"==a&&(D+=p.params[E],null!==p.param_values[E]&&(D+=" = "+p.param_values[E])),D+=";",g.push(D),E++)}break;case "nodes_main":k=f;s={};for(p=0;p<k.length;p++)if(D=k[p],y=t[D.id]){var I=0,ia=0,ka=0;s[p]={};for(E=0;E<y.length;E++)switch(B=y[E],B.type){case "node_in":var qa=D.inputs[I];if(null!==D.input_values[I]){var H=B.qualifier.join(" ")+" ",H=H+qa,H=H+(" = "+
D.input_values[I]),H=H+";";g.push(H)}s[p][B.name]=qa;I++;break;case "node_out":qa=D.outputs[ia];H=B.qualifier.join(" ")+" ";H+=qa;H+=";";g.push(H);s[p][B.name]=qa;ia++;break;case "node_param":"vert"==a?qa=D.vparams[ka]:"frag"==a&&(qa=D.params[ka]),s[p][B.name]=qa,ka++}}for(p=0;p<k.length;p++)if(D=k[p],y=t[D.id])for(E=0;E<y.length;E++)if(B=y[E],"textline"==B.type){D=[];for(I=0;I<B.tokens.length;I++)ia=B.tokens[I],ia in s[p]?D.push(s[p][ia]):D.push(ia);g.push(l(D,h,n,!1))}break;case "textline":g.push(l(k.tokens,
h,n,!1));break;default:throw"Unknown element type: "+k.type;}}}for(var g=[],h={},k=0;k<c.length;k++)h[c[k][0]]=[c[k][1]];for(k=0;k<f.length;k++)h["USE_NODE_"+f[k].id]=[1];var n={},t={};e(b);return g.join("\n")}function l(a,b,c,d){var f=[];h(a,b,c,d,f);return f.join(" ")}function h(a,b,c,d,f){for(var e=0;e<a.length;e++){var g=a[e];g in b?(g=b[g],0==g.length&&d?f.push(0):h(g,b,c,d,f)):f.push(g)}}function e(a,b,c,d,f){d=a.createShader(d);a.shaderSource(d,c);a.compileShader(d);s.check_shader_compiling(d,
b,c);return d}function k(a,b){!b&&a.length?b=a.length:b||(b=1);switch(b){case 1:return g(a);case 2:return"vec2("+g(a[0])+","+g(a[1])+")";case 3:return"vec3("+g(a[0])+","+g(a[1])+","+g(a[2])+")";case 4:return"vec4("+g(a[0])+","+g(a[1])+","+g(a[2])+","+g(a[3])+")";case 9:return"mat3("+g(a[0])+","+g(a[1])+","+g(a[2])+","+g(a[3])+","+g(a[4])+","+g(a[5])+","+g(a[6])+","+g(a[7])+","+g(a[8])+")";case 16:return"mat4("+g(a[0])+","+g(a[1])+","+g(a[2])+","+g(a[3])+","+g(a[4])+","+g(a[5])+","+g(a[6])+","+g(a[7])+
","+g(a[8])+","+g(a[9])+","+g(a[10])+","+g(a[11])+","+g(a[12])+","+g(a[13])+","+g(a[14])+","+g(a[15])+")";default:throw"Wrong glsl value dimension";}}function g(a){return a%1?String(a):String(a)+".0"}var y=q("__config"),m=q("__print"),s=q("__debug"),x=q("__gpp_eval"),C=q("__assets");q("__util");var A=y.paths;if(b4w.module_check("shader_texts"))var f=q("shader_texts"),E=null;else f=null,E=q("__gpp_parser");var n={},t={},M=[],S=null;a.setup_context=function(a){S=a};a.set_directive=r;a.get_directive=
c;a.is_enabled=function(a,b){for(var c=a.directives,d=0;d<c.length;d++)if(c[d][0]==b&&1==c[d][1])return!0;return!1};a.set_default_directives=function(a){a.directives=[];for(var b="ALPHA ALPHA_CLIP BEND_CENTER_ONLY CAUSTICS CSM_BLEND_BETWEEEN_CASCADES CSM_FADE_LAST_CASCADE CSM_SECTION0 CSM_SECTION1 CSM_SECTION2 CSM_SECTION3 DEBUG_SPHERE DEBUG_SPHERE_DYNAMIC DEPTH_RGBA DISABLE_FOG DOUBLE_SIDED_LIGHTING DYNAMIC DYNAMIC_GRASS DYNAMIC_GRASS_COLOR DYNAMIC_GRASS_SIZE FOAM FRAMES_BLENDING BILLBOARD_JITTERED BILLBOARD_SPHERICAL HAIR_BILLBOARD SHADOW_TEX_RES MAIN_BEND_COL MAX_BONES NUM_NORMALMAPS PARALLAX PARALLAX_STEPS PROCEDURAL_FOG REFLECTION REFLECTION_PASS REFLECTIVE REFRACTIVE USE_REFRACTION SHORE_SMOOTHING SKINNED SKY_TEXTURE SSAO_HEMISPHERE SSAO_BLUR_DEPTH SSAO_ONLY SSAO_WHITE STATIC_BATCH TEXTURE_COLOR TEXTURE_MIRROR TEXTURE_NORM TEXTURE_SPEC TEXTURE_STENCIL_ALPHA_MASK VERTEX_ANIM VERTEX_ANIM_MIX_NORMALS_FACTOR VERTEX_COLOR WATER_EFFECTS WIND_BEND DETAIL_BEND SHORE_PARAMS ALPHA_AS_SPEC DEPTH_RGBA NUM_LIGHTS NUM_LAMP_LIGHTS MAX_STEPS BILLBOARD_ALIGN SHADOW_SRC SHADOW_DST POST_EFFECT SSAO_QUALITY TEXTURE_BLEND_TYPE TEXTURE_COORDS AA_METHOD AU_QUALIFIER BILLBOARD BILLBOARD_RANDOM PRECISION EPSILON WIREFRAME_QUALITY SIZE_RAMP_LENGTH COLOR_RAMP_LENGTH PARTICLES_SHADELESS".split(" "),
c=0;c<b.length;c++){var d=b[c],f;switch(d){case "ALPHA":case "ALPHA_CLIP":case "CAUSTICS":case "CSM_SECTION0":case "CSM_SECTION1":case "CSM_SECTION2":case "CSM_SECTION3":case "DEBUG_SPHERE":case "DEBUG_SPHERE_DYNAMIC":case "DEPTH_RGBA":case "DISABLE_FOG":case "DOUBLE_SIDED_LIGHTING":case "DYNAMIC":case "DYNAMIC_GRASS":case "DYNAMIC_GRASS_COLOR":case "DYNAMIC_GRASS_SIZE":case "FOAM":case "FRAMES_BLENDING":case "BILLBOARD_JITTERED":case "MAIN_BEND_COL":case "MAX_BONES":case "NUM_LIGHTS":case "NUM_NORMALMAPS":case "PARALLAX":case "PARALLAX_STEPS":case "PROCEDURAL_FOG":case "REFLECTION":case "REFLECTION_PASS":case "REFLECTIVE":case "REFRACTIVE":case "USE_REFRACTION":case "SHORE_SMOOTHING":case "SKINNED":case "SKY_TEXTURE":case "SSAO_HEMISPHERE":case "SSAO_BLUR_DEPTH":case "SSAO_ONLY":case "SSAO_WHITE":case "STATIC_BATCH":case "TEXTURE_COLOR":case "TEXTURE_MIRROR":case "TEXTURE_NORM":case "TEXTURE_SPEC":case "TEXTURE_STENCIL_ALPHA_MASK":case "VERTEX_ANIM":case "VERTEX_COLOR":case "WATER_EFFECTS":case "WIND_BEND":case "DETAIL_BEND":case "SHORE_PARAMS":case "BILLBOARD":case "BILLBOARD_RANDOM":case "HAIR_BILLBOARD":case "WIREFRAME_QUALITY":case "SIZE_RAMP_LENGTH":case "COLOR_RAMP_LENGTH":case "PARTICLES_SHADELESS":case "SMAA_JITTER":f=
0;break;case "ALPHA_AS_SPEC":case "BEND_CENTER_ONLY":case "CSM_BLEND_BETWEEEN_CASCADES":case "CSM_FADE_LAST_CASCADE":case "DEPTH_RGBA":case "BILLBOARD_SPHERICAL":case "NUM_LAMP_LIGHTS":case "MAX_STEPS":f=1;break;case "SHADOW_TEX_RES":f=k(2048);break;case "AA_METHOD":f="AA_METHOD_FXAA_QUALITY";break;case "AU_QUALIFIER":f="NOT_ASSIGNED";break;case "BILLBOARD_ALIGN":f="BILLBOARD_ALIGN_VIEW";break;case "POST_EFFECT":f="POST_EFFECT_NONE";break;case "SHADOW_SRC":f="SHADOW_SRC_NONE";break;case "SHADOW_DST":f=
"SHADOW_DST_NONE";break;case "SSAO_QUALITY":f="SSAO_QUALITY_32";break;case "TEXTURE_BLEND_TYPE":f="TEXTURE_BLEND_TYPE_MIX";break;case "TEXTURE_COORDS":f="TEXTURE_COORDS_UV_ORCO";break;case "PRECISION":f=y.defaults.precision;break;case "EPSILON":f="highp"==y.defaults.precision?1E-6:1E-4;break;case "VERTEX_ANIM_MIX_NORMALS_FACTOR":f="u_va_frame_factor";break;default:m.error("Unknown directive ("+a.vert+", "+a.frag+"): "+d)}r(a,d,f)}};a.get_vname=function(a){return a.vert};a.get_fname=function(a){return a.frag};
a.inherit_directives=function(a,b){for(var d=b.directives,f=0;f<d.length;f++){var e=d[f][0],g=d[f][1];c(a,e)&&r(a,e,g)}};a.get_compiled_shader=function(a,c){var f=JSON.stringify(a)+JSON.stringify(c),g=n[f];if(g)return g;var h=a.frag,g=d(A.shaders_dir,a.vert),h=d(A.shaders_dir,h);if(!g||!h)return null;var k=a.directives||[],l=b("vert",g,k,c),k=b("frag",h,k,c),g=S,t=e(g,f,l,g.VERTEX_SHADER,a),x=e(g,f,k,g.FRAGMENT_SHADER,a),h=g.createProgram();g.attachShader(h,t);g.attachShader(h,x);g.linkProgram(h);
g.validateProgram(h);g.getProgramParameter(h,g.VALIDATE_STATUS)==g.FALSE&&m.error("B4W Error - shader program is not valid",f);s.check_shader_linking(h,f,t,x,l,k);l={vshader:t,fshader:x,program:h,attributes:{},uniforms:{},permanent_uniform_setters:[],permanent_uniform_setters_table:{},transient_uniform_setters:[],shaders_info:a};t=g.getProgramParameter(h,g.ACTIVE_ATTRIBUTES);for(k=0;k<t;k++){var x=g.getActiveAttrib(h,k).name,y=g.getAttribLocation(h,x);l.attributes[x]=y}t=g.getProgramParameter(h,g.ACTIVE_UNIFORMS);
for(k=0;k<t;k++)x=g.getActiveUniform(h,k).name.split("[0]").join(""),y=g.getUniformLocation(h,x),l.uniforms[x]=y;return n[f]=g=l};a.debug_get_compilation_stats=function(){return M};a.get_compiled_shaders=function(){return n};a.cleanup=function(){for(var a in n){var b=n[a];S.deleteProgram(b.program);S.deleteShader(b.vshader);S.deleteShader(b.fshader);delete n[a]}for(var c in t)delete t[c];for(var d in M)delete M[d]};a.debug_shaders_info=function(a){var b=a.directives;m.log("Shader: "+a.vert+" "+a.frag+
", "+String(b.length)+" directives: ");for(a=0;a<b.length;a++)m.log("  "+b[a][0],b[a][1])};a.glsl_value=k;a.check_uniform=function(a,b){return b in a.uniforms?!0:!1};a.get_varyings_count=function(a){return(S.getShaderSource(a).match(/(?:^|\s)varying(?=\s)/g)||[]).length}};b4w.module.__assets=function(a,q){function r(){return C.is_built_in_data()?q(C.paths.built_in_data_module).data:null}function c(){var a={_source_url:null,_parse_response:function(b){switch(a.responseType){case "json":case "text":return b;case "arraybuffer":b=atob(b);for(var c=b.length,d=new Int8Array(c),f=0;f<c;f++)d[f]=b.charCodeAt(f);return d.buffer;default:return b}},status:0,readyState:0,response:"",responseType:"",onreadystatechange:null,overrideMimeType:function(){},addEventListener:function(){},
open:function(b,c,d){a._source_url=c;a.readyState=1},send:function(){a.status=404;a.readyState=4;var b=r();b&&a._source_url in b&&(a.status=200,b[a._source_url]&&(a.response=a._parse_response(b[a._source_url])));if("[object Function]"==={}.toString.call(a.onreadystatechange))a.onreadystatechange()}};return a}function d(c){for(var d=0,f=0;f<c.length;f++){var m=c[f];20===m.state&&d++;if(d>=M.max_requests)break;if(10===m.state)switch(m.state=20,d++,m.type){case a.AT_ARRAYBUFFER:b(m,"arraybuffer");break;
case a.AT_JSON:b(m,"json");break;case a.AT_TEXT:b(m,"text");break;case a.AT_AUDIOBUFFER:l(m);break;case a.AT_IMAGE_ELEMENT:h(m);break;case a.AT_AUDIO_ELEMENT:e(m);break;case a.AT_VIDEO_ELEMENT:k(m);break;case a.AT_SEQ_VIDEO_ELEMENT:g(m);break;default:throw"Wrong asset type: "+m.type;}}}function b(a,b){var d=r(),f=d&&a.filepath in d?new c:new XMLHttpRequest;f.open("GET",a.filepath,!0);"text"==b?(f.overrideMimeType("text/plain"),f.responseType="text"):"json"==b?(f.overrideMimeType("application/json"),
f.responseType="text"):f.responseType=b;f.onreadystatechange=function(){if(40!=a.state&&4==f.readyState){if(200==f.status||0==f.status){var c=f.response;if(c){if("json"==b&&"string"==typeof c)try{c=JSON.parse(c)}catch(d){a.asset_cb(null,a.uri,a.type,a.filepath);A.error(d+" (parsing JSON "+a.filepath+")");return}a.asset_cb(c,a.uri,a.type,a.filepath)}else a.asset_cb(null,a.uri,a.type,a.filepath),A.error("B4W Error: empty responce when trying to get "+a.filepath)}else a.asset_cb(null,a.uri,a.type,a.filepath),
A.error("B4W Error: "+f.status+" when trying to get "+a.filepath);a.state=30}};f.addEventListener("progress",function(b){b.lengthComputable&&a.progress_cb(b.loaded/b.total)},!1);f.send(null)}function l(a){var b=r(),d=b&&a.filepath in b?new c:new XMLHttpRequest;d.open("GET",a.filepath,!0);d.responseType="arraybuffer";d.onreadystatechange=function(){if(40!=a.state&&4==d.readyState)if(200==d.status||0==d.status){var b=d.response;b?f.decode_audio_data(b,function(b){a.asset_cb(b,a.uri,a.type,a.filepath);
a.state=30},function(){a.asset_cb(null,a.uri,a.type,a.filepath);A.error("B4W Error: failed to decode "+a.filepath);a.state=30}):(a.asset_cb(null,a.uri,a.type,a.filepath),A.error("B4W Error: empty responce when trying to get "+a.filepath),a.state=30)}else a.asset_cb(null,a.uri,a.type,a.filepath),A.error("B4W Error: "+d.status+" when trying to get "+a.filepath),a.state=30};d.send(null)}function h(a){var b=document.createElement("img");S.allow_cors&&(b.crossOrigin="Anonymous");b.onload=function(){40!=
a.state&&(a.asset_cb(b,a.uri,a.type,a.filepath),a.state=30)};b.addEventListener("error",function(){40!=a.state&&(a.asset_cb(null,a.uri,a.type,a.filepath),A.error("B4W Error: could not load image: "+a.filepath),a.state=30)},!1);var c=r();if(c&&a.filepath in c)if(c[a.filepath]){var d=m(a.filepath);b.src="data:"+d+";base64,"+c[a.filepath]}else t.is_ie11()?(c=document.createEvent("CustomEvent"),c.initCustomEvent("error",!1,!1,null)):c=new CustomEvent("error"),b.dispatchEvent(c);else b.src=a.filepath}
function e(a){var b=document.createElement("audio");S.allow_cors&&(b.crossOrigin="Anonymous");b.addEventListener("loadeddata",function(){40!=a.state&&(a.asset_cb(b,a.uri,a.type,a.filepath),a.state=30)},!1);b.addEventListener("error",function(){40!=a.state&&(a.asset_cb(null,a.uri,a.type,a.filepath),A.error("B4W Error: could not load sound: "+a.filepath),a.state=30)},!1);var c=r();if(c&&a.filepath in c)if(c[a.filepath]){var d=s(a.filepath);b.src="data:"+d+";base64,"+c[a.filepath];40!=a.state&&(a.asset_cb(b,
a.uri,a.type,a.filepath),a.state=30)}else t.is_ie11()?(c=document.createEvent("CustomEvent"),c.initCustomEvent("error",!1,!1,null)):c=new CustomEvent("error"),b.dispatchEvent(c);else b.src=a.filepath,S.is_mobile_device&&b.load();setTimeout(function(){b.some_prop_to_prevent_gc=1},5E3)}function k(a){var b=document.createElement("video");b.muted=!0;if(S.allow_cors||S.is_mobile_device)b.crossOrigin="Anonymous";b.addEventListener("loadeddata",function(){40!=a.state&&(a.asset_cb(b,a.uri,a.type,a.filepath),
a.state=30)},!1);b.addEventListener("error",function(){40!=a.state&&(a.asset_cb(null,a.uri,a.type,a.filepath),A.error("B4W Error: could not load video: "+a.filepath),a.state=30)},!1);var c=r();if(c&&a.filepath in c)if(c[a.filepath]){var d=x(a.filepath);b.src="data:"+d+";base64,"+c[a.filepath];40!=a.state&&(a.asset_cb(b,a.uri,a.type,a.filepath),a.state=30)}else t.is_ie11()?(c=document.createEvent("CustomEvent"),c.initCustomEvent("error",!1,!1,null)):c=new CustomEvent("error"),b.dispatchEvent(c);else b.src=
a.filepath,S.is_mobile_device&&b.load();setTimeout(function(){b.some_prop_to_prevent_gc=1},1E4)}function g(a){function b(c){a.asset_cb(c,a.uri,a.type,a.filepath)}var d=r(),f=d&&a.filepath in d?new c:new XMLHttpRequest;f.open("GET",a.filepath,!0);f.responseType="arraybuffer";f.onreadystatechange=function(){if(40!=a.state&&4==f.readyState){if(200==f.status||0==f.status){var c=f.response;c?y(c,b):(a.asset_cb(null,a.uri,a.type,a.filepath),A.error("B4W Error: empty responce when trying to get "+a.filepath))}else a.asset_cb(null,
a.uri,a.type,a.filepath),A.error("B4W Error: "+f.status+" when trying to get "+a.filepath);a.state=30}};f.addEventListener("progress",function(b){b.lengthComputable&&a.progress_cb(b.loaded/b.total)},!1);f.send(null)}function y(a,b){for(var c=new Int32Array(a),d=new Int8Array(a),f=c[3],e={images:[],fps:c[4]},g=20,h=0;h<f;h++){var k=c[g/4],m=d.subarray(g+4,g+4+k),m=new Blob([m],{type:"image/jpg"}),n=document.createElement("img");n.src=window.URL.createObjectURL(m);e.images.push(n);g+=k+8-k%4}n.onload=
function(){b(e)}}function m(a){var b="image";switch(E.get_file_extension(a).toLowerCase()){case "jpeg":case "jpg":b+="/jpeg";break;case "png":b+="/png"}return b}function s(a){var b="audio";switch(E.get_file_extension(a).toLowerCase()){case "ogv":case "ogg":b+="/ogg";break;case "mp3":b+="/mpeg";break;case "m4v":case "mp4":b+="/mp4";break;case "webm":b+="/webm"}return b}function x(a){var b="video";switch(E.get_file_extension(a).toLowerCase()){case "ogv":b+="/ogg";break;case "webm":b+="/webm";break;
case "m4v":b+="/mp4"}return b}var C=q("__config"),A=q("__print"),f=q("__sfx"),E=q("__util"),n=q("__version"),t=q("__compat"),M=C.assets,S=C.defaults;a.AT_ARRAYBUFFER=10;a.AT_JSON=20;a.AT_TEXT=30;a.AT_AUDIOBUFFER=40;a.AT_IMAGE_ELEMENT=50;a.AT_AUDIO_ELEMENT=60;a.AT_VIDEO_ELEMENT=70;a.AT_SEQ_VIDEO_ELEMENT=80;var z=[],B=0,K={};a.split_extension=function(a){a=a.split(".");var b=Array(2);b[0]=a.slice(0,-1).join(".");b[1]=String(a.slice(-1));return b};a.get_text_sync=function(a){if(K[a])return K[a];var b=
M.prevent_caching?a+n.timestamp():a,c=new XMLHttpRequest;c.overrideMimeType("text/plain");c.open("GET",b,!1);c.send(null);if(200==c.status||0==c.status){b=c.responseText;if(b.length)return K[a]=b;throw"Error XHR: responce is empty, GET "+a;}throw"Error XHR: "+c.status+", GET "+a;};a.cleanup=function(){for(var a=0;a<z.length;a++)z[a].state=40;z=[];B=0;K={}};a.enqueue=function(a,b,c,f){for(var e=0;e<a.length;e++){var g=a[e],g={uri:g[0],type:g[1],filepath:g[2],name:g[3],state:10,asset_cb:b||function(){},
pack_cb:c||function(){},progress_cb:f||function(){},pack_index:B};if(M.prevent_caching){var h=r();h&&g.filepath in h||(g.filepath+=n.timestamp())}z.push(g)}d(z);B++};a.update=function(){d(z);for(var a=z,b=0,c=!0,f=0;f<a.length;f++){var e=a[f];e.pack_index===a[b].pack_index?30!==e.state&&(c=!1):(c&&(a[f-1].pack_cb(),c=f-b,a.splice(b,c),f-=c),b=f,c=30===a[f].state?!0:!1);f===a.length-1&&c&&(a[f].pack_cb(),a.splice(b))}}};b4w.module.__geometry=function(a,q){function r(a){return 65536<a.base_length?S.get_elem_index_uint()?!1:!0:!1}function c(a){return 0<a.indices.length?!0:!1}function d(a,d,f){if(!c(a))return a;f||n.log('%cDEBUG max vertices exceeded for indexed submesh "'+a.name+'": '+a.base_length*(d||1)+", will use drawArrays","color: #aa0");d=a.indices;f=a.base_length;var e=a.va_common,g=a.va_frames,h;for(h in e){var k=e[h],m=s(k,f);e[h]=b(d,k,m)}for(e=0;e<g.length;e++){var l=g[e];for(h in l)k=l[h],m=s(k,f),l[h]=
b(d,k,m)}a.base_length=d.length;a.indices=new Uint16Array(0);return a}function b(a,b,c){if(0==b.length)return new Float32Array(0);for(var d=new Float32Array(a.length*c),f=0;f<a.length;f++)for(var e=a[f],g=0;g<c;g++)d[c*f+g]=b[c*e+g];return d}function l(a,b){var c=a.vbo_array,d=a.pointers[b];if(d)return c.subarray(d.offset,d.offset+d.length);throw"extract_array() failed; invalid name: "+b;}function h(b,c){var d,f;switch(c){case a.DM_DEFAULT:case a.DM_TRIANGLES:d=Q.TRIANGLES;f=Q.STATIC_DRAW;break;case a.DM_POINTS:d=
Q.POINTS;f=Q.STATIC_DRAW;break;case a.DM_DYNAMIC_TRIANGLES:d=Q.TRIANGLES;f=Q.DYNAMIC_DRAW;break;case a.DM_DYNAMIC_POINTS:d=Q.POINTS;f=Q.DYNAMIC_DRAW;break;case a.DM_LINES:d=Q.LINES;f=Q.STATIC_DRAW;break;default:throw"Wrong draw_mode";}b.mode=d;b.usage=f}function e(a){a.ibo_array?(a.ibo||(a.ibo=Q.createBuffer()),Q.bindBuffer(Q.ELEMENT_ARRAY_BUFFER,a.ibo),Q.bufferData(Q.ELEMENT_ARRAY_BUFFER,a.ibo_array,a.usage),a.debug_ibo_bytes=a.ibo_array.byteLength):a.debug_ibo_bytes=0;a.vbo||(a.vbo=Q.createBuffer());
Q.bindBuffer(Q.ARRAY_BUFFER,a.vbo);Q.bufferData(Q.ARRAY_BUFFER,a.vbo_array,a.usage);a.debug_vbo_bytes=a.vbo_array.byteLength}function k(a){for(var b=M.create_empty_submesh("JOIN_"+a.length+"_SUBMESHES"),c=0,d=0;d<a.length;d++)c+=a[d].indices.length;b.indices=new Uint32Array(c);for(d=c=0;d<a.length;d++)c+=a[d].base_length;b.base_length=c;var f=a[0],e;for(e in f.va_common){for(d=c=0;d<a.length;d++)c+=a[d].va_common[e].length;b.va_common[e]=new Float32Array(c)}for(e in f.va_frames[0]){for(d=c=0;d<a.length;d++)c+=
a[d].va_frames[0][e].length;for(d=0;d<f.va_frames.length;d++)b.va_frames[d]=b.va_frames[d]||{},b.va_frames[d][e]=new Float32Array(c)}for(f=d=c=0;f<a.length;f++){e=a[f];for(var g=e.indices,h=e.base_length,k=e.va_common,p=0;p<g.length;p++)b.indices[c+p]=g[p]+d;var c=c+g.length,m;for(m in k){var g=k[m],n=d*s(g,h);b.va_common[m].set(g,n)}for(p=0;p<e.va_frames.length;p++){var k=e.va_frames[p],l=b.va_frames[p];for(m in k)g=k[m],n=d*s(g,h),l[m].set(g,n)}d+=h}return b}function g(a,b,c,e,g,h){var k=M.create_empty_submesh("SUBMESH_"+
a.name+"_"+b),l=a.submeshes[b],t=l.base_length,p=a.materials[b];k.base_length=t;if(y(c,"a_texcoord")){var s=null,x=a.materials[b];b=a.submeshes[b];if(x.texture_slots.length)switch(x=x.texture_slots[0],x.texture_coords){case "UV":x=a.uv_textures.indexOf(x.uv_layer);-1==x||0==x?s=new Float32Array(b.texcoord):1==x&&(s=new Float32Array(b.texcoord2));break;case "ORCO":for(var v=a.b4w_bounding_box,s=new Float32Array(2*b.base_length),x=(v.max_x+v.min_x)/2,A=(v.max_z+v.min_z)/2,C=v.max_x-v.min_x,v=v.max_z-
v.min_z,E=0,D=0;D<b.position.length;D+=3)s[E++]=(b.position[D]-x)/C+.5,s[E++]=(A-b.position[D+2])/v+.5}null===s&&(s=new Float32Array(b.texcoord));b=s}else b=new Float32Array(0);var I,s=l.group;if(y(c,"a_influence")&&e){x=new Float32Array(4*t);A=s.length/t;C=new Float32Array(A);for(v=0;v<A;v++)for(I in C[v]=-1,e)if(E=e[I],E.vgroup_index===v){C[v]=E.deform_bone_index;break}D=3<A?A:4;e=new Float32Array(D);I=new Uint32Array(D);for(var v=new Float32Array(4),E=new Float32Array(D),D=new Uint32Array(D),ia=
new Float32Array(4),ka=0;ka<t;ka++)e.set(E),I.set(D),v.set(ia),x.set(m(s,A,ka,t,C,e,I,v),4*ka)}else x=new Float32Array(0);I=x;e=g?M.clone_object_r(g):{};e.a_color={generate_buffer:!0};y(c,"a_color")&&a.active_vcol_name?e.a_color.src=[{name:a.active_vcol_name,mask:7}]:e.a_color.src=[];g={a_texcoord:b,a_influence:I};I=l.vertex_colors;b=l.color;s=a.name;x=[];for(A=0;A<I.length;A++)x.push(I[A].name);for(var qa in e)if(A=e[qa].src,A.length){for(v=C=0;v<A.length;v++)C+=M.rgb_mask_get_channels_count(A[v].mask);
g[qa]=new Float32Array(C*t);for(v=E=0;v<A.length;v++){var H=A[v].name,D=A[v].mask,ia=M.rgb_mask_get_channels_presence(D),fa=x.indexOf(H);if(-1==fa)throw'B4W Error: vertex color "'+H+'" for mesh "'+s+'" not found.';var ka=I[fa].mask,w=M.rgb_mask_get_channels_count(ka);(D&ka)!==D&&n.error("B4W Error: Wrong color extraction from "+H+" to "+qa+".");for(var H=I,ja=t,oa=0,r=0;r<fa;r++)oa+=M.rgb_mask_get_channels_count(H[r].mask);H=oa*ja;for(fa=0;fa<t;fa++)for(ja=0;3>ja;ja++)ia[ja]&&(oa=E+M.rgb_mask_get_channel_presence_index(D,
ja),r=M.rgb_mask_get_channel_presence_index(ka,ja),g[qa][fa*C+oa]=b[H+fa*w+r]);E+=w}}else g[qa]=new Float32Array(0);qa=a.uv_textures;e=l.texcoord;I=l.texcoord2;b=a.name;if(h)for(var q in h){s=qa.indexOf(q);if(-1==s)throw'B4W Error: uv map "'+q+'" for mesh "'+b+'" not found';if(0==s)var ma=new Float32Array(e);else 1==s&&(ma=new Float32Array(I));g[h[q]]=ma}k.va_common=g;k.indices=new Uint32Array(l.indices);h=l.position.length/t/3;ma=(q=y(c,"a_normal")&&l.normal.length?!0:!1)&&y(c,"a_tangent")&&l.tangent.length?
!0:!1;qa=q&&p.texture_slots.length&&y(c,"a_tangent")&&"ORCO"==p.texture_slots[0].texture_coords?!0:!1;for(g=0;g<h;g++){p={};e=new Float32Array(3*t);I=new Float32Array(q?3*t:0);b=new Float32Array(ma||qa?4*t:0);s=g*t*3;x=s+3*t;e.set(l.position.subarray(s,x),0);q&&(s=g*t*3,x=s+3*t,I.set(l.normal.subarray(s,x),0));if(ma)s=g*t*4,x=s+4*t,b.set(l.tangent.subarray(s,x),0);else if(qa)for(s=I,x=b,A=t,n.warn('B4W Warning: Not precise tangents calculation for normalmap using GENERATED texture coordinates in mesh: "'+
a.name+'". Please add a UV-map.'),C=0;C<A;C++)v=B,E=K,v[0]=s[3*C],v[1]=s[3*C+1],v[2]=s[3*C+2],z.cross(v,M.AXIS_Z,E),0==z.length(E)&&z.cross(v,M.AXIS_X,E),z.normalize(E,E),x[4*C]=E[0],x[4*C+1]=E[1],x[4*C+2]=E[2],x[4*C+3]=1;else if(q&&y(c,"a_tangent"))for(b=new Float32Array(4*t),g=0;g<b.length;g++)b[g]=1;p.a_position=e;p.a_normal=I;p.a_tangent=b;k.va_frames.push(p)}if(1<h){a=k.va_frames[0];var p={},R;for(R in a)p[R]=new Float32Array(a[R]);k.va_frames.push(p)}y(c,"a_polyindex")&&(d(k,1,!0),k.va_common.a_polyindex=
f(k));return k}function y(a,b){return-1<a.indexOf(b)?!0:!1}function m(a,b,c,d,f,e,g,h){for(var k=!0,p=0;p<b;p++){var m=a[p*d+c];if(-1!==m){var n=f[p];-1!==n&&(e[p]=m,g[p]=n,k=!1)}}if(k)return h;x(e,g,!1);for(p=a=0;4>p;p++)a+=e[p];if(.01>a)return h;for(p=0;4>p;p++)e[p]/=a;if(.01>Math.abs(e[0]-1))h[0]=g[0]+1;else for(p=0;4>p;p++)h[p]=g[p]+e[p];return h}function s(a,b){if(0==b)return 0;var c=a.length,d=c/b;if(d!=Math.floor(d))throw"Array size mismatch during geometry calculation: array length="+c+", base length="+
b;return d}function x(a,b,c){var d=a.length,f=d,e=!1;for(c=c?-1:1;1<f||e;){1<f&&(f=Math.floor(f/1.247330950103979));for(var e=!1,g=0;f+g<d;g++)0>c*(a[g]-a[g+f])&&(e=a[g],a[g]=a[g+f],a[g+f]=e,e=b[g],b[g]=b[g+f],b[g+f]=e,e=!0)}}function C(a,b,c){var d=[],f=[];z.subtract(b,a,d);z.subtract(c,a,f);z.normalize(d,d);z.normalize(f,f);return Math.acos(z.dot(d,f))}function A(a,b,d){b||(b=[]);d=d?a.va_frames[0].a_normal:a.va_frames[0].a_position;if(c(a)){a=a.indices;for(var f=a.length/3,e=0;e<f;e++){var g=new Float32Array(9),
h=a[3*e];g[0]=d[3*h];g[1]=d[3*h+1];g[2]=d[3*h+2];h=a[3*e+1];g[3]=d[3*h];g[4]=d[3*h+1];g[5]=d[3*h+2];h=a[3*e+2];g[6]=d[3*h];g[7]=d[3*h+1];g[8]=d[3*h+2];b[e]=g}}else for(e=0;e<d.length;e++)g=new Float32Array(9),g[0]=d[9*e],g[1]=d[9*e+1],g[2]=d[9*e+2],g[3]=d[9*e+3],g[4]=d[9*e+4],g[5]=d[9*e+5],g[6]=d[9*e+6],g[7]=d[9*e+7],g[8]=d[9*e+8],b[e]=g;return b}function f(a){for(var b=new Float32Array(a.base_length),c=0;c<a.base_length;c++)b[c]=c%3;return b}function E(a,b,c){var d=z.dist(a,b);a=z.dist(a,c);b=z.dist(b,
c);c=(d+a+b)/2;return c*(c-d)*(c-a)*(c-b)}var n=q("__print"),t=q("__tsr"),M=q("__util"),S=q("__extensions"),z=q("vec3"),B=new Float32Array(3),K=new Float32Array(3),v=new Float32Array(3);a.ZSORT_DISABLED=10;a.ZSORT_BACK_TO_FRONT=20;a.ZSORT_FRONT_TO_BACK=30;a.DM_TRIANGLES=10;a.DM_POINTS=20;a.DM_DYNAMIC_TRIANGLES=30;a.DM_DYNAMIC_POINTS=40;a.DM_LINES=50;a.DM_DEFAULT=a.DM_TRIANGLES;var Q=null;a.setup_context=function(a){Q=a};a.delete_buffers=function(a){var b=_buffers[a];Q.deleteBuffer(b.ibo);Q.deleteBuffer(b.vbo);
delete _buffers[a]};a.submesh_to_bufs_data=function(b,f,g,k){r(b)&&d(b);var m=b.indices,n=b.base_length,l=b.va_frames,t={},x;for(x in b.va_common)x in k&&!k[x].generate_buffer||(t[x]=b.va_common[x]);k={ibo_array:null,vbo_array:null,ibo_type:0,count:0,pointers:{},mode:0,usage:0,debug_ibo_bytes:0,debug_vbo_bytes:0,vbo:null,ibo:null,info_for_z_sort_updates:null};if(m.length)if(x=m.length,65536>=n)var p=new Uint16Array(m),y=Q.UNSIGNED_SHORT;else p=new Uint32Array(m),y=Q.UNSIGNED_INT;else x=n,p=null;var v=
0,A=l.length,C;for(C in l[0])var E=l[0][C],v=v+E.length*A;for(C in t)E=t[C],v+=E.length;C=new Float32Array(v);var v=0,A={},K;for(K in t){var D=t[K];if(E=D.length)C.set(D,v),A[K]={attribute_name:K,num_comp:s(D,n),offset:v,frames:1,length:E},v+=E}t=l.length;for(K in l[0])if(D=l[0][K],E=D.length,D=s(D,n),E){A[K]={num_comp:D,offset:v,frames:t,length:E};1<t&&(A[K+"_next"]={num_comp:D,offset:v+E,frames:t,length:E});for(var I=0;I<t;I++)D=l[I][K],C.set(D,v),v+=E}k.count=x;k.ibo_array=p;k.vbo_array=C;k.ibo_type=
y;k.pointers=A;h(k,g);e(k);f!=a.ZSORT_DISABLED&&c(b)&&(k.info_for_z_sort_updates={median_cache:new Float32Array(m.length),median_world_cache:new Float32Array(m.length),dist_cache:new Float32Array(m.length/3),type:f});return k};a.is_long_submesh=r;a.is_indexed=c;a.submesh_drop_indices=d;a.update_bufs_data_index_array=function(a,b,c){h(a,b);a.count=c.length;a.ibo_array=c;a.ibo_type=c instanceof Uint16Array?Q.UNSIGNED_SHORT:Q.UNSIGNED_INT;return a};a.update_bufs_data_array=function(a,b,c,d){var f=a.vbo_array,
g=a.pointers,h=g[b];if(h){if(c&&h.num_comp!=c)throw'Error: invalid num_comp for "'+b+'"';f.set(d,h.offset)}else f=f.length,h=new Float32Array(f+d.length),h.set(a.vbo_array),h.set(d,f),a.vbo_array=h,g[b]={num_comp:c,offset:f};e(a);return a};a.extract_array=l;a.make_static=function(a){a.usage=Q.STATIC_DRAW};a.make_dynamic=function(a){a.usage=Q.DYNAMIC_DRAW};a.update_gl_buffers=e;a.cleanup_bufs_data=function(a){a.ibo&&Q.deleteBuffer(a.ibo);a.vbo&&Q.deleteBuffer(a.vbo)};a.has_empty_submesh=function(a,
b){return a.submeshes[b].base_length?!1:!0};a.submesh_apply_transform=function(a,b){for(var c=0;c<a.va_frames.length;c++){var d=a.va_frames[c].a_position;t.transform_vectors(d,b,d,0);d=a.va_frames[c].a_normal;0<d.length&&t.transform_dir_vectors(d,b,d,0);d=a.va_frames[c].a_tangent;0<d.length&&t.transform_tangents(d,b,d,0)}(c=a.va_common.au_center_pos)&&c.length&&t.transform_vectors(c,b,c,0);return a};a.submesh_apply_particle_transform=function(a,b){var c=a.va_common.au_center_pos;if(c&&c.length){var d=
new Float32Array(c);t.transform_vectors(d,b,d,0);for(var f=0;f<a.va_frames.length;f++)for(var e=0;e<d.length;e++)a.va_frames[f].a_position[e]+=d[e]-c[e];c.set(d)}else throw'Attribute "au_center_pos" is missing in particle submesh';return a};a.submesh_apply_params=function(a,b){var c=a.base_length,d;for(d in b){var f=b[d].length;a.va_common[d]=new Float32Array(f*c);for(var e=0;e<c;e++)for(var g=0;g<f;g++)a.va_common[d][e*f+g]=b[d][g]}return a};a.submesh_list_join=k;a.make_clone_submesh=function(a,
b,c){if(!a.base_length)return M.create_empty_submesh("EMPTY");var f=c.length;65536<a.base_length*f&&!S.get_elem_index_uint()&&d(a,f);var e=a.indices,g=a.base_length,h=a.va_common;a=a.va_frames;for(var k in b){var m=b[k].length,p=m*g;h[k]=new Float32Array(p);for(var n=0;n<g;n++)for(p=0;p<m;p++)h[k][n*m+p]=b[k][p]}b=M.create_empty_submesh("CLONE_"+f+"_SUBMESHES");b.base_length=g*f;b.indices=new Uint32Array(e.length*f);for(n=0;n<f;n++)for(m=e.length*n,k=g*n,p=0;p<e.length;p++)b.indices[m+p]=e[p]+k;for(var l in h)for(e=
h[l],p=e.length*f,m=s(e,g),b.va_common[l]=new Float32Array(p),n=0;n<f;n++)k=g*m*n,b.va_common[l].set(e,k);for(l in a[0])for(n=0;n<a.length;n++)for(e=a[n][l],p=e.length*f,m=s(e,g),b.va_frames[n]=b.va_frames[n]||{},b.va_frames[n][l]=new Float32Array(p),p=0;p<f;p++)switch(h=c[p],k=g*m*p,l){case "a_position":t.transform_vectors(e,h,b.va_frames[n][l],k);break;case "a_normal":t.transform_dir_vectors(e,h,b.va_frames[n][l],k);break;case "a_tangent":t.transform_tangents(e,h,b.va_frames[n][l],k);break;default:throw"Wrong attribute name: "+
l;}return b};a.extract_submesh=g;a.extract_halo_submesh=function(a){var b=a.base_length,c=a.va_frames[0].a_position,d=new Float32Array(12*b),f=new Float32Array(8*b);a=new Uint16Array(4*a.indices.length);for(var e=0;e<b;e++)d[12*e]=c[3*e],d[12*e+1]=c[3*e+1],d[12*e+2]=c[3*e+2],d[12*e+3]=c[3*e],d[12*e+4]=c[3*e+1],d[12*e+5]=c[3*e+2],d[12*e+6]=c[3*e],d[12*e+7]=c[3*e+1],d[12*e+8]=c[3*e+2],d[12*e+9]=c[3*e],d[12*e+10]=c[3*e+1],d[12*e+11]=c[3*e+2],f[8*e]=-.5,f[8*e+1]=-.5,f[8*e+2]=-.5,f[8*e+3]=.5,f[8*e+4]=
.5,f[8*e+5]=.5,f[8*e+6]=.5,f[8*e+7]=-.5,a[6*e]=4*e+2,a[6*e+1]=4*e+1,a[6*e+2]=4*e,a[6*e+3]=4*e+2,a[6*e+4]=4*e,a[6*e+5]=4*e+3;c=M.create_empty_submesh("HALO");c.va_frames=[];c.va_frames[0]={};c.base_length=4*b;c.va_frames[0].a_position=d;c.va_common.a_halo_bb_vertex=f;c.indices=a;return c};a.has_attr=y;a.extract_submesh_all_mats=function(a,b){for(var c=[],d=0;d<a.submeshes.length;d++){var f=g(a,d,b,null,null,null);f.base_length&&c.push(f)}return 0==c.length?M.create_empty_submesh("EMPTY"):1==c.length?
c[0]:k(c)};a.update_buffers_movable=function(a,b,c){for(var d=a.ibo_array,f=l(a,"a_position"),e=a.info_for_z_sort_updates,g=e.median_cache,h=e.median_world_cache,e=e.dist_cache,k=d,m=k.length/3,n=0;n<m;n++){var t=k[3*n],s=k[3*n+1],x=k[3*n+2],y=f[3*t+1],v=f[3*t+2],D=f[3*s+1],I=f[3*s+2],ia=f[3*x+1],A=f[3*x+2];g[3*n]=(f[3*t]+f[3*s]+f[3*x])/3;g[3*n+1]=(y+D+ia)/3;g[3*n+2]=(v+I+A)/3}M.positions_multiply_matrix(g,b,h);b=g.length/3;for(f=0;f<b;f++)h=g[3*f]-c[0],k=g[3*f+1]-c[1],m=g[3*f+2]-c[2],e[f]=h*h+k*
k+m*m;c=d;d=e.length;if(!(2>d))for(g=d,f=!1;1<g||f;)for(1<g&&(g=Math.floor(g/1.247330950103979)),f=!1,b=0;g+b<d;b++)0>e[b]-e[b+g]&&(f=e[b],e[b]=e[b+g],e[b+g]=f,f=c,h=b,k=b+g,m=f[3*h],n=f[3*h+1],t=f[3*h+2],f[3*h]=f[3*k],f[3*h+1]=f[3*k+1],f[3*h+2]=f[3*k+2],f[3*k]=m,f[3*k+1]=n,f[3*k+2]=t,f=!0);d=c;Q.bindBuffer(Q.ELEMENT_ARRAY_BUFFER,a.ibo);Q.bufferData(Q.ELEMENT_ARRAY_BUFFER,d,Q.DYNAMIC_DRAW)};a.sort_two_arrays=x;a.calc_normals=function(a,b,c){for(var d=b.length/3,f=a.length/3,e=[],g=Array(3),h=Array(3),
k=Array(3),m=0;m<f;m++){for(var n=a[3*m],l=a[3*m+1],t=a[3*m+2],s=0;3>s;s++)g[s]=b[3*n+s],h[s]=b[3*l+s],k[s]=b[3*t+s];if(c)var s=C(g,h,k),x=C(h,k,g),y=Math.PI-s-x;else y=x=s=1;var D=e,I;I=g;var ia=k,v=[],A=[],H=[];z.subtract(h,I,v);z.subtract(ia,I,A);z.cross(v,A,H);z.normalize(H,H);I=H;for(ia=0;3>ia;ia++)v=3*l+ia,A=3*t+ia,D[3*n+ia]=s*I[ia],D[v]=x*I[ia],D[A]=y*I[ia]}if(c)for(var fa in c)for(m=c[fa],a=0;3>a;a++){b=3*m[0]+a;for(f=1;f<m.length;f++)g=3*m[f]+a,e[b]+=e[g];for(f=1;f<m.length;f++)g=3*m[f]+
a,e[g]=e[b]}for(m=0;m<d;m++){c=m;fa=e;a=new Float32Array(3);for(b=0;3>b;b++)f=3*c+b,a[b]=fa[f];z.normalize(a,a);for(b=0;3>b;b++)f=3*c+b,fa[f]=a[b]}return e};a.calc_shared_indices=function(a,b,c){for(var d={},f=b.length/3,e=0;e<f;e++){var g=String(b[3*e])+String(b[3*e+1])+String(b[3*e+2]);d[g]=[]}f=a.length;for(e=0;e<f;e++)b=a[e],g=String(c[3*b])+String(c[3*b+1])+String(c[3*b+2]),g in d&&d[g].push(b);return d};a.geometry_random_points=function(a,b,c,d){var f=A(a,null,!1);if(c)var e=A(a,null,!0);var g=
f.length,h=new Float32Array(g),k=B,m=K;for(a=0;a<g;a++){var n=f[a];k.set(n.subarray(0,3));m.set(n.subarray(3,6));v.set(n.subarray(6));h[a]=Math.sqrt(E(k,m,v))}k=new Float32Array(g);k[0]=h[0];for(a=1;a<g;a++)k[a]=k[a-1]+h[a];g=k[h.length-1];h=[];for(a=0;a<b;a++){var m=g*M.rand_r(d),m=M.binary_search_max(k,m,0,k.length-1),n=c?e[m]:f[m],m=a,l=n,t=d,n=void 0,n=new Float32Array(3),s=l[0],x=l[1],y=l[2],D=l[3],I=l[4],ia=l[5],C=l[6],z=l[7],H=l[8],l=M.rand_r(t),t=M.rand_r(t);1<l+t&&(l=1-l,t=1-t);var fa=1-
l-t,x=fa*x+l*I+t*z,y=fa*y+l*ia+t*H;n[0]=fa*s+l*D+t*C;n[1]=x;n[2]=y;h[m]=n}return h};a.extract_triangles=A;a.extract_polyindices=f;a.triangle_area_squared=E;a.get_plane_normal=function(a,b,c,d){var f=b[0]-a[0],e=c[0]-a[0],g=b[1]-a[1],h=c[1]-a[1];b=b[2]-a[2];a=c[2]-a[2];d[0]=g*a-b*h;d[1]=e*b-f*a;d[2]=f*h-g*e;return d};a.scale_submesh_xyz=function(a,b,c){a=a.va_frames[0].a_position;for(var d=0;d<a.length;d+=3)a[d]=(a[d]-c[0])*b[0]+c[0],a[d+1]=(a[d+1]-c[1])*b[1]+c[1],a[d+2]=(a[d+2]-c[2])*b[2]+c[2]}};b4w.module.__primitives=function(a,q){function r(a,b,c,d){for(var e=[],l=[],C=[],A=[],f=2*c/(a-1),E=2*d/(b-1),n=0;n<a;n++)for(var t=-c+n*f,r=0;r<b;r++)if(l.push(t,0,-d+r*E),C.push(0,1,0),A.push(n/(a-1),r/(b-1)),n&&r){var q=n*b+r,z=q-1,B=(n-1)*b+r,K=B-1;e.push(q,z,B);e.push(z,K,B)}a=h.create_empty_va_frame();a.a_position=new Float32Array(l);a.a_normal=new Float32Array(C);C=h.create_empty_submesh("GRID_PLANE");C.va_frames[0]=a;C.va_common.a_texcoord=new Float32Array(A);C.indices=new Uint32Array(e);
C.base_length=l.length/3;return C}function c(a){var c=a.length;if(c%4)throw"Wrong array";for(var d=[],e=[],l=0;l<c;l+=4){var x=a[l+1],C=a[l+2],A=a[l+3];b(a[l],e);b(x,e);b(C,e);b(A,e);d.push(l,l+1,l+2);d.push(l,l+2,l+3)}a=h.create_empty_va_frame();a.a_position=new Float32Array(e);c=h.create_empty_submesh("FROM_QUADS");c.va_frames[0]=a;c.indices=new Uint32Array(d);c.base_length=e.length/3;return c}function d(a,b){var c=3*b;return[a[c],a[c+1],a[c+2]]}function b(a,b){b.push(a[0],a[1],a[2])}var l=q("__geometry"),
h=q("__util"),e=q("__config").defaults;a.generate_lines=function(a){for(var b=h.create_empty_submesh("LINE"),c=[],d=0;d<2*a;d++)c.push(d);d=h.create_empty_va_frame();d.a_point=new Float32Array(c);b.va_frames[0]=d;b.indices=new Uint32Array(c);b.base_length=2*a;return b};a.generate_plane=function(a,b){var c=r(2,2,a,b);c.name="PLANE";return c};a.generate_grid=r;a.generate_multigrid=function(a,b,c){function d(a,b){return 1==a%2&&(0==b||b==A-1)||1==b%2&&(0==a||a==C-1)?!0:!1}var s=c/=Math.pow(2,a-1),x=
c,C=b+1,A=b+1;b=[];c=[];for(var f=0,E=0,n=-1,t=[],r=0;r<a;r++){for(var q=2*s/(C-1),z=2*x/(A-1),B=[],K=[],v=0,Q=0;Q<C;Q++){for(var O=-s+Q*q,L=[],G=0;G<A;G++){var V=-x+G*z;if(O>-f&&O<f&&V>-E&&V<E)L.push(-1),v++;else{for(var $=null,P=0;P<t.length;P+=3)if(O==t[P]&&V==t[P+1]){$=t[P+2];break}P=null!==$?$:n+1;d(Q,G)?(L.push(-2),v++):(null==$&&(0==G||G==A-1||0==Q||Q==C-1?($=r==a-1?q:2*q,B.push(O,V,P)):$=q,c.push(O,$,V),n++),L.push(P));if(Q&&G)if(1==Q)if(d(Q-1,G)){if(1<G){var V=P-1,$=K[Q-1][G+1],Y=$-1;b.push(P,
V,Y)}else $=K[Q-1][G+1],Y=$-1;b.push(P,Y,$)}else d(Q,G)||(V=P-1,$=K[Q-1][G],b.push(P,V,$));else if(Q==C-1){if(!d(Q,G))if(G==A-1)V=P-1,$=K[Q-1][G-1],Y=K[Q-2][G],b.push(P,V,$),b.push(P,$,Y);else{var V=P-1,$=K[Q-1][G],Y=$-1,T=$+1;b.push(P,V,Y);b.push(P,Y,$);b.push(P,$,T);2==G&&(T=K[Q-2][G-2],b.push(V,T,Y))}}else 1==G?d(Q,G-1)?(V=K[Q-1][G],$=K[Q-1][G-1],b.push(P,$,V)):(V=L[G-1],$=K[Q-1][G],Y=K[Q-2][G-1],b.push(P,V,$),b.push(V,Y,$)):G==A-1?d(Q,G)||(V=L[G-1],$=K[Q-1][G-1],Y=K[Q-2][G],b.push(P,V,$),b.push(P,
$,Y)):-1!=K[Q-1][G]&&-1!=K[Q-1][G-1]&&-1!=L[G-1]?(V=L[G-1],$=K[Q-1][G],Y=K[Q-1][G-1],b.push(P,V,$),b.push(V,Y,$),G==A-2&&d(Q,G+1)&&(T=K[Q-1][G+1],b.push(P,$,T))):G==A-2&&d(Q,G+1)&&($=K[Q-1][G],T=K[Q-1][G+1],b.push(P,$,T))}}K.push(L)}t=B;f=s;E=x;s*=2;x*=2}2E4>f&&(a=-(2*f)/(C-1),c.push(-2E4,a,-2E4),c.push(-2E4,a,2E4),c.push(-f,a,-E),c.push(-f,a,E),c.push(2E4,a,-2E4),c.push(2E4,a,2E4),c.push(f,a,-E),c.push(f,a,E),P=n+1,b.push(P+3,P+2,P+1,P+2,P+0,P+1,P+6,P+4,P+2,P+4,P+0,P+2,P+5,P+7,P+1,P+7,P+3,P+1,P+
5,P+4,P+7,P+7,P+4,P+6));a=h.create_empty_va_frame();a.a_position=new Float32Array(c);s=h.create_empty_submesh("multigrid_plane");s.va_frames[0]=a;s.indices=new Uint32Array(b);s.base_length=c.length/3;e.water_wireframe_debug&&(l.submesh_drop_indices(s,1,!0),a.a_polyindex=l.extract_polyindices(s));return s};a.generate_from_triangles=function(a){var c=a.length;if(c%3)throw"Wrong array";for(var d=[],e=[],l=0;l<c;l+=3){var x=a[l+1],C=a[l+2];b(a[l],e);b(x,e);b(C,e);d.push(l,l+1,l+2)}a=h.create_empty_va_frame();
a.a_position=new Float32Array(e);c=h.create_empty_submesh("FROM_TRIANGLES");c.va_frames[0]=a;c.indices=new Uint32Array(d);c.base_length=e.length/3;return c};a.generate_from_quads=c;a.generate_frustum=function(a){a=h.vectorize(a,[]);var b=[];b.push(a[0],a[1],a[2],a[3]);b.push(a[0],a[3],a[5],a[4]);b.push(a[3],a[2],a[6],a[5]);b.push(a[1],a[7],a[6],a[2]);b.push(a[0],a[4],a[7],a[1]);b.push(a[4],a[5],a[6],a[7]);a=c(b);a.name="FRUSTUM";return a};a.generate_fullscreen_quad=function(){var a=h.create_empty_submesh("BILLBOARD"),
b=h.create_empty_va_frame();b.a_position=new Float32Array([-1,1,1,1,-1,-1,1,-1]);a.va_frames[0]=b;a.indices=new Uint32Array([0,2,1,1,2,3]);a.base_length=4;return a};a.generate_billboard=function(){var a=h.create_empty_submesh("BILLBOARD"),b=h.create_empty_va_frame();b.a_bb_vertex=new Float32Array([-.5,-.5,-.5,.5,.5,.5,.5,-.5]);a.va_frames[0]=b;a.indices=new Uint32Array([0,2,1,0,3,2]);a.base_length=4;return a};a.generate_cube=function(){var a=h.create_empty_submesh("CUBEMAP_BOARD"),b=h.create_empty_va_frame();
b.a_position=new Float32Array([-1,-1,-1,1,1,1,1,-1]);a.va_frames[0]=b;a.indices=new Uint32Array([0,2,1,0,3,2]);a.base_length=4;return a};a.generate_uv_sphere=function(a,c,e,m,s,x){var C=h.create_empty_submesh("UV_SPHERE"),A,f,E=[],n=[],t=[];for(f=0;f<=c;f++)for(A=0;A<=a;A++){var r=A/a,q=f/c,z=-e*Math.cos(2*r*Math.PI)*Math.sin(q*Math.PI),B=e*Math.cos(q*Math.PI),r=e*Math.sin(2*r*Math.PI)*Math.sin(q*Math.PI);s&&(z=1E-5>Math.abs(z)?0:z,B=1E-5>Math.abs(B)?0:B,r=1E-5>Math.abs(r)?0:r);n.push(z+m[0],B+m[1],
r+m[2])}for(f=s=0;f<c;f++)for(A=0;A<a;A++)z=d(n,(a+1)*f+A+1),B=d(n,(a+1)*f+A),r=d(n,(a+1)*(f+1)+A),q=d(n,(a+1)*(f+1)+A+1),Math.abs(z[1])==e+m[1]?(b(z,E),b(r,E),b(q,E),x?t.push(s,s+1,s+1,s+2,s+2,s):t.push(s,s+1,s+2),s+=3):Math.abs(r[1])==e+m[1]?(b(z,E),b(B,E),b(r,E),x?t.push(s,s+1,s+1,s+2,s+2,s):t.push(s,s+1,s+2),s+=3):(b(z,E),b(B,E),b(r,E),b(q,E),x?(t.push(s,s+1),t.push(s+1,s+2),t.push(s+2,s+3),t.push(s+3,s)):(t.push(s,s+1,s+2),t.push(s,s+2,s+3)),s+=4);a={};a.a_position=E;x?a.a_normal=[]:(x=l.calc_shared_indices(t,
n,E),a.a_normal=l.calc_normals(t,E,x));a.a_tangent=[];C.va_common.a_influence=[];C.va_common.a_color=[];C.va_common.a_texcoord=[];C.va_frames[0]=a;C.indices=t;C.base_length=E.length/3;return C}};b4w.module.__particles=function(a,q){function r(a,b,c,d,g,h,k){var l=a._internal.delay_attrs,s=a._internal.emitter_tsr_snapshots,z=a._internal.time;a=a._internal.prev_time;for(var r=b?4:1,K=0;K<l.length;K+=r){var v=l[K];if(v>a&&v<=z)for(v=0;8>v;v++)s[8*K+v]=g[v];for(v=0;8>v;v++)y[v]=s[8*K+v];v=m;v[0]=c[3*K];v[1]=c[3*K+1];v[2]=c[3*K+2];e.transform_vec3(v,y,v);h[3*K]=v[0];h[3*K+1]=v[1];h[3*K+2]=v[2];var q=m;q[0]=d[3*K];q[1]=d[3*K+1];q[2]=d[3*K+2];e.transform_dir_vec3(q,y,q);k[3*K]=q[0];k[3*K+1]=q[1];
k[3*K+2]=q[2];if(b)for(v=1;4>v;v++)h[3*(K+v)]=h[3*K],h[3*(K+v)+1]=h[3*K+1],h[3*(K+v)+2]=h[3*K+2],k[3*(K+v)]=q[0],k[3*(K+v)+1]=q[1],k[3*(K+v)+2]=q[2]}}function c(a){a?(h.srand(a),s=function(){return h.rand()}):s=function(){return Math.random()}}var d=q("__config"),b=q("__geometry"),l=q("__scenes"),h=q("__util"),e=q("__tsr"),k=q("vec3"),g=d.animation,y=new Float32Array(8),m=new Float32Array(3),s=function(){throw"_rand() undefined";};a.has_particles=function(a){return 0<a.particle_systems.length?!0:
!1};a.has_anim_particles=function(a){for(var b=0;b<a.particle_systems.length;b++)if("EMITTER"==a.particle_systems[b].settings.type)return!0;return!1};a.has_hair_particles=function(a){for(var b=0;b<a.particle_systems.length;b++)if("HAIR"==a.particle_systems[b].settings.type)return!0;return!1};a.has_dynamic_grass_particles=function(a){for(var b=0;b<a.particle_systems.length;b++){var c=a.particle_systems[b].settings;if("HAIR"==c.type&&c.b4w_dynamic_grass)return!0}return!1};a.generate_emitter_particles_submesh=
function(a,d,l,f,m){l._internal=l._internal||{};var n=b.extract_submesh_all_mats(d,["a_position","a_normal"],!1);f=l.settings.count;var t=l.settings.frame_start/g.framerate,y=l.settings.frame_end/g.framerate,q=l.settings.lifetime/g.framerate,z=l.settings.lifetime_random,B=l.settings.emit_from,K=l.settings.factor_random,v=l.settings.angular_velocity_mode,Q=l.settings.angular_velocity_factor,O=l.settings.b4w_randomize_emission,L=l.settings.b4w_cyclic;c(l.seed);var G=l._internal.use_world_space="WORLD"==
l.settings.b4w_coordinate_system?!0:!1;l._internal.frame=0;if(d=!a.halo_particles){var V;V=[];for(var $=0;$<f;$++)V.push(-.5,-.5,-.5,.5,.5,.5,.5,-.5);V=new Float32Array(V);for(var $=[],P=0;P<f;P++)$.push(4*P,4*P+2,4*P+1,4*P,4*P+3,4*P+2);$=new Uint16Array($)}switch(B){case "VERT":for(var P=n.va_frames[0].a_position,n=n.va_frames[0].a_normal,Y=P.length/3,B=[],T=0;T<f;T++){var X=Math.round((Y-1)*s());B.push(X);d&&(B.push(X),B.push(X),B.push(X))}Y=[];for(T=0;T<B.length;T++)Y.push(P[3*B[T]]),Y.push(P[3*
B[T]+1]),Y.push(P[3*B[T]+2]);P=new Float32Array(Y);Y=[];for(T=0;T<B.length;T++)Y.push(n[3*B[T]]),Y.push(n[3*B[T]+1]),Y.push(n[3*B[T]+2]);B=new Float32Array(Y);break;case "FACE":P=[];B=[];T=[];h.init_rand_r_seed(0,T);Y=b.geometry_random_points(n,f,!1,T);h.init_rand_r_seed(0,T);n=b.geometry_random_points(n,f,!0,T);for(T=0;T<Y.length;T++)P.push(Y[T][0],Y[T][1],Y[T][2]),d&&(P.push(Y[T][0],Y[T][1],Y[T][2]),P.push(Y[T][0],Y[T][1],Y[T][2]),P.push(Y[T][0],Y[T][1],Y[T][2])),B.push(n[T][0],n[T][1],n[T][2]),
d&&(B.push(n[T][0],n[T][1],n[T][2]),B.push(n[T][0],n[T][1],n[T][2]),B.push(n[T][0],n[T][1],n[T][2]));P=new Float32Array(P);B=new Float32Array(B);break;case "VOLUME":throw"Particle emission from volume is not supported";default:throw"Wrong emit from option";}B=[P,B];n=B[0];B=B[1];l._internal.positions=new Float32Array(n);l._internal.normals=new Float32Array(B);l._internal.positions_cache=new Float32Array(n.length);l._internal.normals_cache=new Float32Array(B.length);l._internal.time=0;l._internal.prev_time=
-1;P=[];y=(y-t)/f;for(Y=0;Y<f;Y++)T=O?y*Y+10*y*(.5-s()):y*Y,L||(T+=t),P.push(T),d&&(P.push(T),P.push(T),P.push(T));t=new Float32Array(P);l._internal.delay_attrs=new Float32Array(t);l._internal.delay_attrs_masked=new Float32Array(t);l._internal.emitter_tsr_snapshots=new Float32Array(8*t.length);for(O=0;O<8*t.length;O++)for(L=0;8>L;L++)l._internal.emitter_tsr_snapshots[8*O+L]=m[L];G?r(l,d,n,B,m,n,B):(e.transform_vectors(n,m,n,0),e.transform_dir_vectors(B,m,B,0));l=[];m=q*z;for(z=0;z<f;z++)G=m*s(),l.push(q-
G),d&&(l.push(q-G),l.push(q-G),l.push(q-G));q=new Float32Array(l);l=[];for(m=0;m<f;m++){z=[s()-.5,s()-.5,s()-.5];k.normalize(z,z);l.push(K*z[0]);l.push(K*z[1]);l.push(K*z[2]);switch(v){case "NONE":l.push(0);break;case "SPIN":case "VELOCITY":l.push(Q);break;case "RAND":l.push(2*Q*(s()-.5));break;default:throw"Undefined velocity factor";}if(d)for(z=l.slice(-4),G=0;12>G;G++)l.push(z[G%4])}f=new Float32Array(l);K=h.create_empty_submesh("EMITTER_PARTICLES");v=h.create_empty_va_frame();v.a_position=n;v.a_normal=
B;K.va_frames[0]=v;d?K.indices=$:(a.draw_mode=b.DM_POINTS,K.indices=new Uint16Array(0));K.base_length=n.length/3;K.va_common.a_p_delay=t;K.va_common.a_p_lifetime=q;K.va_common.a_p_vels=f;d&&(K.va_common.a_p_bb_vertex=V);return K};a.update_emitter_transform=function(a){for(var c=a._batches,d=0;d<c.length;d++){var f=c[d],g=c[d].particle_system;if(g){var h=f.bufs_data,k=g._internal.positions_cache,l=g._internal.normals_cache,m=g._internal.positions,s=g._internal.normals;g._internal.use_world_space?r(g,
!f.halo_particles,m,s,a._render.tsr,k,l):(f=s,g=a._render.tsr,s=l,e.transform_vectors(m,g,k,0),e.transform_dir_vectors(f,g,s,0));b.make_dynamic(h);b.update_bufs_data_array(h,"a_position",3,k);b.update_bufs_data_array(h,"a_normal",3,l)}}};a.set_emitter_particles_uniforms=function(a,b,c){var d=b.settings.lifetime/g.framerate,e=b.settings.normal_factor,h=9.81*b.settings.effector_weights.gravity,k=b.settings.effector_weights.wind,m=b.settings.mass,s=b.settings.b4w_fade_in/g.framerate,y=b.settings.b4w_fade_out/
g.framerate,r=b.settings.b4w_cyclic;a.p_length=b.settings.frame_end/g.framerate-b.settings.frame_start/g.framerate;a.p_cyclic=r?1:0;a.p_nfactor=e;a.p_gravity=h;e=l.get_wind();a.p_wind[0]=e[0]*k;a.p_wind[1]=e[1]*k;a.p_wind[2]=e[2]*k;a.p_max_lifetime=d;a.p_mass=m;a.p_fade_in=s;a.p_fade_out=y;a.halo_particles?(d=c.halo.size,k=c.halo.hardness,30>k?(k=.5,m=.9):40>k?(k=.1,m=1):50>k?(k=0,m=.8):(k=0,m=.5)):(d=b.settings.particle_size,m=k=1);a.p_size=d;a.p_alpha_start=k;a.p_alpha_end=m;d=b.settings.texture_slots;
b=[-1,0,-1,0,-1,0,-1,0];if(d[0]&&d[0].use_map_size&&d[0].texture&&"BLEND"==d[0].texture.type&&d[0].texture.use_color_ramp){d=d[0].texture.color_ramp.elements;k=Math.min(2*d.length,b.length);for(m=0;m<k;m+=2)s=d[m/2],b[m]=s.position,b[m+1]=(s.color[0]+s.color[1]+s.color[2])/3;a.p_size_ramp_length=d.length}a.p_size_ramp.set(b);b=c.texture_slots;c=[-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0];if(b[0]&&"STRAND"==b[0].texture_coords&&b[0].texture&&"BLEND"==b[0].texture.type&&b[0].texture.use_color_ramp){d=b[0].texture.color_ramp.elements;
k=Math.min(4*d.length,c.length);for(m=0;m<k;m+=4)s=d[m/4],c[m]=s.position,c[m+1]=s.color[0],c[m+2]=s.color[1],c[m+3]=s.color[2];a.p_color_ramp_length=d.length}a.p_color_ramp.set(c)};a.set_time=function(a,b){a._internal.prev_time=a._internal.time;a._internal.time=b};a.prepare_lens_flares=function(a){for(var b=a.base_length,c=a.va_frames[0].a_position,d=a.va_common.a_texcoord,e=[],g=[],h=0;h<b;h++)g.push(c[3*h]),g.push(c[3*h+1]),e.push(c[3*h+2]);e=new Float32Array(e);g=new Float32Array(g);a.va_common.a_lf_dist=
e;a.va_common.a_lf_bb_vertex=g;a.va_common.a_texcoord=d;return a};a.set_size=function(a,b,c){a=a._batches;for(var d=0;d<a.length;d++){var e=a[d],g=e.particle_system;g&&g.name==b&&(e.p_size=c)}};a.set_normal_factor=function(a,b,c){a=a._batches;for(var d=0;d<a.length;d++){var e=a[d],g=e.particle_system;g&&g.name==b&&(e.p_nfactor=c)}};a.set_factor=function(a,c,d){a=a._batches;for(var f=0;f<a.length;f++){var e=a[f],g=e.particle_system;if(g&&g.name==c){var h=g._internal.delay_attrs;if(1==d)g=h;else if(0==
d)for(var k=!e.halo_particles,l=k?4:1,g=g._internal.delay_attrs_masked,m=0;m<g.length;m+=l)g[m]=1E4,k&&(g[m+1]=g[m],g[m+2]=g[m],g[m+3]=g[m]);else for(var s=1/d,g=g._internal.delay_attrs_masked,l=(k=!e.halo_particles)?4:1,y=0,m=0;m<g.length;m+=l)m>=y?(g[m]=h[m],y+=s):g[m]=1E4,k&&(g[m+1]=g[m],g[m+2]=g[m],g[m+3]=g[m]);b.update_bufs_data_array(e.bufs_data,"a_p_delay",1,g)}}};a.update_start_pos=function(a,b,c){a=a.particle_systems;for(var d=0;d<a.length;d++){var e=a[d];if("EMITTER"==e.settings.type)for(var g=
e._internal.delay_attrs,d=0;d<8*g.length;d++)e._internal.emitter_tsr_snapshots[8*d]=b[0],e._internal.emitter_tsr_snapshots[8*d+1]=b[1],e._internal.emitter_tsr_snapshots[8*d+2]=b[2],e._internal.emitter_tsr_snapshots[8*d+3]=b[3],e._internal.emitter_tsr_snapshots[8*d+4]=c[0],e._internal.emitter_tsr_snapshots[8*d+5]=c[1],e._internal.emitter_tsr_snapshots[8*d+6]=c[2],e._internal.emitter_tsr_snapshots[8*d+7]=c[3]}}};b4w.module.__textures=function(a,q){function r(){return{name:"",type:0,source:"",width:0,height:0,compress_ratio:1,allow_node_dds:!0,source_size:1024,enable_canvas_mipmapping:!1,canvas_context:null,video_file:null,seq_video:null,seq_fps:1,seq_cur_frame:0,seq_video_played:!1,video_was_stopped:!1,is_movie:!1,frame_start:0,frame_offset:0,frame_duration:0,use_auto_refresh:!1,use_cyclic:!1,movie_length:0,fps:0,w_target:0,w_texture:null,w_renderbuffer:null}}function c(b,c,e){var g=b.type,h=new Uint8Array([204,
204,204,255]),k=r();switch(g){case "DATA_TEX2D":case "IMAGE":var l=z.createTexture(),m=z.TEXTURE_2D;z.bindTexture(m,l);z.texImage2D(m,0,z.RGBA,1,1,0,z.RGBA,z.UNSIGNED_BYTE,h);b.image&&"MOVIE"==b.image.source&&(k.is_movie=!0,k.frame_start=b.frame_start,k.frame_offset=b.frame_offset,k.frame_duration=b.frame_duration,k.use_auto_refresh=b.use_auto_refresh,k.use_cyclic=b.use_cyclic,k.movie_length=b.movie_length,0!=k.frame_offset&&x.warn('Frame offset for texture "'+b.name+'" has a nonzero value. Can lead to undefined behaviour for mobile devices.'));
break;case "NONE":l=z.createTexture();m=z.TEXTURE_2D;z.bindTexture(m,l);if("NONE"==b.b4w_source_type)return null;if("SCENE"==b.b4w_source_type)if(b.b4w_source_id&&(e=f.keysearch("name",b.b4w_source_id,e)))k.offscreen_scene=e,k.source_size=b.b4w_source_size,e._render_to_texture=!0,z.texImage2D(m,0,z.RGBA,1,1,0,z.RGBA,z.UNSIGNED_BYTE,h);else return null;break;case "ENVIRONMENT_MAP":l=z.createTexture();m=z.TEXTURE_CUBE_MAP;z.bindTexture(m,l);e="POSITIVE_X NEGATIVE_X POSITIVE_Y NEGATIVE_Y POSITIVE_Z NEGATIVE_Z".split(" ");
for(var n=0;6>n;n++)z.texImage2D(z["TEXTURE_CUBE_MAP_"+e[n]],0,z.RGBA,1,1,0,z.RGBA,z.UNSIGNED_BYTE,h);break;case "VORONOI":case "BLEND":return null;default:return x.error('B4W warning: texture "'+b.name+'" has unsupported type "'+g+'"'),null}("NONE"!=g||b.b4w_enable_canvas_mipmapping&&"CANVAS"==b.b4w_source_type)&&"DATA_TEX2D"!=g?z.texParameteri(m,z.TEXTURE_MIN_FILTER,B[E.texture_min_filter]):z.texParameteri(m,z.TEXTURE_MIN_FILTER,z.LINEAR);z.texParameteri(m,z.TEXTURE_MAG_FILTER,z.LINEAR);h=m;e=b.b4w_anisotropic_filtering;
"DEFAULT"===e&&(e=c);"OFF"!==e&&E.anisotropic_filtering&&(c=A.get_aniso())&&(e=parseFloat(e.split("x")[0]),z.texParameterf(h,c.TEXTURE_MAX_ANISOTROPY_EXT,e));"REPEAT"!=b.extension||b.b4w_shore_dist_map?(z.texParameteri(m,z.TEXTURE_WRAP_S,z.CLAMP_TO_EDGE),z.texParameteri(m,z.TEXTURE_WRAP_T,z.CLAMP_TO_EDGE)):(z.texParameteri(m,z.TEXTURE_WRAP_S,z.REPEAT),z.texParameteri(m,z.TEXTURE_WRAP_T,z.REPEAT));k.type=a.TT_RGBA_INT;k.width=1;k.height=1;k.w_texture=l;k.w_target=m;"CANVAS"==b.b4w_source_type&&"NONE"==
g?(g=b.b4w_source_id,l=b.b4w_source_size,k.enable_canvas_mipmapping=b.b4w_enable_canvas_mipmapping,k.name=g,k.source="CANVAS",m=document.createElement("canvas"),m.setAttribute("id",g),m.width=l,m.height=l,k.canvas_context=m.getContext("2d"),M[g]=k,d(k)):(k.name=b.name,k.source=g,z.generateMipmap(m),z.bindTexture(m,null));return b._render=k}function d(a){if("CANVAS"!=a.source)throw"Wrong texture";var b=a.w_target;z.bindTexture(b,a.w_texture);var c=e(a),d=k(a),f=a.canvas_context.canvas;z.pixelStorei(z.UNPACK_FLIP_Y_WEBGL,
!0);z.texImage2D(b,0,c,c,d,f);z.pixelStorei(z.UNPACK_FLIP_Y_WEBGL,!1);a.enable_canvas_mipmapping&&z.generateMipmap(b);z.bindTexture(b,null);a.width=f.width;a.height=f.height}function b(a){var b=a.w_target;z.bindTexture(b,a.w_texture);z.pixelStorei(z.UNPACK_FLIP_Y_WEBGL,!0);z.texImage2D(b,0,z.RGBA,z.RGBA,z.UNSIGNED_BYTE,a.seq_video[a.seq_cur_frame]);z.bindTexture(b,null)}function l(a){z.texParameteri(a,z.TEXTURE_WRAP_S,z.CLAMP_TO_EDGE);z.texParameteri(a,z.TEXTURE_WRAP_T,z.CLAMP_TO_EDGE);z.texParameteri(a,
z.TEXTURE_MAG_FILTER,z.LINEAR);z.texParameteri(a,z.TEXTURE_MIN_FILTER,z.LINEAR)}function h(a,b){var c=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384];return-1==c.indexOf(a)||-1==c.indexOf(b)}function e(b){switch(b.type){case a.TT_RGBA_INT:b=z.RGBA;break;case a.TT_RGB_INT:b=z.RGB;break;case a.TT_RGBA_FLOAT:b=z.RGBA;break;case a.TT_RGB_FLOAT:b=z.RGB;break;case a.TT_DEPTH:b=z.DEPTH_COMPONENT;break;default:throw"Wrong texture type";}return b}function k(b){switch(b.type){case a.TT_RGBA_INT:b=
z.UNSIGNED_BYTE;break;case a.TT_RGB_INT:b=z.UNSIGNED_BYTE;break;case a.TT_RGBA_FLOAT:b=z.FLOAT;break;case a.TT_RGB_FLOAT:b=z.FLOAT;break;case a.TT_DEPTH:b=z.UNSIGNED_INT;break;default:throw"Wrong texture type";}return b}function g(a){return a in S?(E.seq_video_fallback?S[a].seq_video_played=!0:S[a].video_file.play(),!0):null}function y(a){return a in S?(a=S[a],E.seq_video_fallback?(a.seq_cur_frame=a.frame_offset,b(a),a.seq_cur_frame++):a.video_file.currentTime=a.frame_offset/a.fps,!0):null}function m(a){return a in
S?(E.seq_video_fallback?S[a].seq_video_played=!1:S[a].video_file.pause(),!0):null}var s=q("__config"),x=q("__print"),C=q("__dds"),A=q("__extensions"),f=q("__util"),E=s.defaults,n=s.animation,t=s.sfx;a.TF_NEAREST=0;a.TF_LINEAR=0;a.TF_NEAREST_MIPMAP_NEAREST=0;a.TF_LINEAR_MIPMAP_NEAREST=0;a.TF_NEAREST_MIPMAP_LINEAR=0;a.TF_LINEAR_MIPMAP_LINEAR=0;a.TT_RGBA_INT=10;a.TT_RGB_INT=20;a.TT_RGBA_FLOAT=30;a.TT_RGB_FLOAT=40;a.TT_DEPTH=50;a.TT_RENDERBUFFER=60;var M={},S={},z=null,B;a.setup_context=function(b){B=
[b.NEAREST_MIPMAP_NEAREST,b.NEAREST_MIPMAP_LINEAR,b.LINEAR_MIPMAP_NEAREST,b.LINEAR_MIPMAP_LINEAR];a.TF_NEAREST=b.NEAREST;a.TF_LINEAR=b.LINEAR;a.TF_NEAREST_MIPMAP_NEAREST=b.NEAREST_MIPMAP_NEAREST;a.TF_LINEAR_MIPMAP_NEAREST=b.LINEAR_MIPMAP_NEAREST;a.TF_NEAREST_MIPMAP_LINEAR=b.NEAREST_MIPMAP_LINEAR;a.TF_LINEAR_MIPMAP_LINEAR=b.LINEAR_MIPMAP_LINEAR;z=b};a.get_canvas_context=function(a){return a in M?M[a].canvas_context:null};a.update_canvas_context=function(a){return a in M?(d(M[a]),!0):!1};a.create_texture=
function(b,c){var d=r();d.name=b;d.type=c;d.source="NONE";if(c==a.TT_RENDERBUFFER)d.w_renderbuffer=z.createRenderbuffer();else{var f=z.TEXTURE_2D,e=z.createTexture();z.bindTexture(f,e);z.texParameteri(f,z.TEXTURE_MAG_FILTER,z.LINEAR);z.texParameteri(f,z.TEXTURE_MIN_FILTER,z.LINEAR);z.texParameteri(f,z.TEXTURE_WRAP_S,z.CLAMP_TO_EDGE);z.texParameteri(f,z.TEXTURE_WRAP_T,z.CLAMP_TO_EDGE);z.bindTexture(f,null);d.w_target=f;d.w_texture=e}return d};a.create_cubemap_texture=function(b,c){var d=z.createTexture(),
f=z.TEXTURE_CUBE_MAP;z.bindTexture(f,d);z.texParameteri(f,z.TEXTURE_MAG_FILTER,z.LINEAR);z.texParameteri(f,z.TEXTURE_MIN_FILTER,z.LINEAR);z.texParameteri(f,z.TEXTURE_WRAP_S,z.CLAMP_TO_EDGE);z.texParameteri(f,z.TEXTURE_WRAP_T,z.CLAMP_TO_EDGE);for(var e="TEXTURE_CUBE_MAP_POSITIVE_X TEXTURE_CUBE_MAP_NEGATIVE_X TEXTURE_CUBE_MAP_POSITIVE_Y TEXTURE_CUBE_MAP_NEGATIVE_Y TEXTURE_CUBE_MAP_POSITIVE_Z TEXTURE_CUBE_MAP_NEGATIVE_Z".split(" "),g=0;6>g;g++)z.texImage2D(z[e[g]],0,z.RGBA,c,c,0,z.RGBA,z.UNSIGNED_BYTE,
null);z.bindTexture(f,null);f=r();f.name=b;f.type=a.TT_RGBA_INT;f.source="NONE";f.width=3*c;f.height=2*c;f.compress_ratio=1;f.w_texture=d;f.w_target=z.TEXTURE_CUBE_MAP;return f};a.set_filters=function(b,c,d){if(b.type!=a.TT_RENDERBUFFER){var f=b.w_target;z.bindTexture(f,b.w_texture);c&&z.texParameteri(f,z.TEXTURE_MIN_FILTER,c);d&&z.texParameteri(f,z.TEXTURE_MAG_FILTER,d);z.bindTexture(f,null)}};a.get_filters=function(b){if(b.type==a.TT_RENDERBUFFER)return{min:a.TF_NEAREST,mag:a.TF_NEAREST};var c=
b.w_target;z.bindTexture(c,b.w_texture);b=z.getTexParameter(c,z.TEXTURE_MIN_FILTER);var d=z.getTexParameter(c,z.TEXTURE_MAG_FILTER);z.bindTexture(c,null);return{min:b,mag:d}};a.resize=function(b,c,d){c=Math.max(c,1);d=Math.max(d,1);if(b.width!=c||b.height!=d){if(b.type==a.TT_RENDERBUFFER)z.bindRenderbuffer(z.RENDERBUFFER,b.w_renderbuffer),z.renderbufferStorage(z.RENDERBUFFER,z.DEPTH_COMPONENT16,c,d),z.bindRenderbuffer(z.RENDERBUFFER,null);else{var f=b.w_target;z.bindTexture(f,b.w_texture);var g=e(b),
h=k(b);z.texImage2D(f,0,g,c,d,0,g,h,null);z.bindTexture(f,null)}c>E.max_texture_size||d>E.max_texture_size?x.error("B4W warning: texture has unsupported size",filepath):(b.width=c,b.height=d)}};a.create_texture_bpy=c;a.update_video_texture=function(a){var b=a.w_target;z.bindTexture(b,a.w_texture);z.pixelStorei(z.UNPACK_FLIP_Y_WEBGL,!0);4!=a.video_file.length?z.texImage2D(b,0,z.RGBA,z.RGBA,z.UNSIGNED_BYTE,a.video_file):z.texImage2D(b,0,z.RGBA,1,1,0,z.RGBA,z.UNSIGNED_BYTE,a.video_file);z.bindTexture(b,
null)};a.update_seq_video_texture=b;a.update_texture=function(a,b,c,d){var f=a.source,e=a.w_target;z.bindTexture(e,a.w_texture);if(4==b.length){var g=!0;b=new Uint8Array([255*b[0],255*b[1],255*b[2],255*b[3]])}if("IMAGE"==f)if(g)z.texImage2D(e,0,z.RGBA,1,1,0,z.RGBA,z.UNSIGNED_BYTE,b),a.width=1,a.height=1;else if(c){c=C.get_width_height(b);if(c.width>E.max_texture_size||c.height>E.max_texture_size){x.error("B4W warning: texture has unsupported size",d);return}C.upload_dds_levels(z,A.get_s3tc(),b,!0);
h(c.width,c.height)&&(a.auxilary_texture||x.warn("B4W warning: using NPOT texture",d),l(e));a.width=c.width;a.height=c.height;a.compress_ratio=C.get_compress_ratio(b)}else{z.pixelStorei(z.UNPACK_FLIP_Y_WEBGL,!0);if(b.width>E.max_texture_size||b.height>E.max_texture_size){x.error("B4W warning: texture has unsupported size",d);return}a.is_movie?E.seq_video_fallback?b&&(S[a.name]=a,a.seq_video=b,a.fps=a.movie_length/b.length,a.frame_duration=Math.round(a.frame_duration/a.fps),a.frame_offset=Math.round(a.frame_offset/
a.fps),a.frame_start=Math.round(a.frame_start/a.fps),a.seq_cur_frame=a.frame_offset,z.texImage2D(e,0,z.RGBA,z.RGBA,z.UNSIGNED_BYTE,a.seq_video[0])):(a.video_file=b,a.video_file.loop=a.use_cyclic,b&&(S[a.name]=a),a.fps=n.framerate,b.duration&&(a.fps=a.movie_length/b.duration),t.disable_playback_rate_hack||(b.playbackRate=n.framerate/a.fps,t.clamp_playback_rate_hack&&2<b.playbackRate&&(b.playbackRate=2)),z.texImage2D(e,0,z.RGBA,z.RGBA,z.UNSIGNED_BYTE,a.video_file)):z.texImage2D(e,0,z.RGBA,z.RGBA,z.UNSIGNED_BYTE,
b);E.seq_video_fallback&&a.is_movie?(a.width=b[0].width,a.height=b[0].height):(a.width=b.width,a.height=b.height);h(b.width,b.height)?(a.auxilary_texture||(a.is_movie?x.warn("B4W warning: using NPOT video texture",d):x.warn("B4W warning: using NPOT texture",d)),l(e)):a.is_movie||z.generateMipmap(e)}else if("ENVIRONMENT_MAP"==f)if(c=[["POSITIVE_X",2,0],["NEGATIVE_X",0,0],["POSITIVE_Y",1,1],["NEGATIVE_Y",0,1],["POSITIVE_Z",1,0],["NEGATIVE_Z",2,1]],g){for(g=0;6>g;g++)f=c[g],z.texImage2D(z["TEXTURE_CUBE_MAP_"+
f[0]],0,z.RGBA,1,1,0,z.RGBA,z.UNSIGNED_BYTE,b);a.width=3;a.height=2}else{z.pixelStorei(z.UNPACK_FLIP_Y_WEBGL,!1);var k=b.width/3;if(k>E.max_cube_map_size||k>E.max_cube_map_size){x.error("B4W warning: cubemap has unsupported size",d);return}for(g=0;6>g;g++){var f=c[g],m=document.createElement("canvas");m.width=k;m.height=k;var s=m.getContext("2d");"POSITIVE_Y"==f[0]||"NEGATIVE_Y"==f[0]?(s.translate(0,k),s.scale(1,-1)):(s.translate(k,0),s.scale(-1,1));s.drawImage(b,f[1]*k,f[2]*k,k,k,0,0,k,k);z.texImage2D(z["TEXTURE_CUBE_MAP_"+
f[0]],0,z.RGBA,z.RGBA,z.UNSIGNED_BYTE,m)}a.width=3*k;a.height=2*k;h(b.width/3,b.height/2)?(x.warn("B4W warning: using NPOT cube map texture",d),l(e)):z.generateMipmap(e)}else"DATA_TEX2D"==f&&(z.texImage2D(e,0,z.RGBA,b.width,b.height,0,z.RGBA,z.UNSIGNED_BYTE,b.data),a.width=b.width,a.height=b.height);z.bindTexture(e,null)};a.delete_texture=function(a){z.deleteTexture(a)};a.is_texture=function(a){return a&&a.name&&(a.w_texture||a.w_renderbuffer)?!0:!1};a.is_renderbuffer=function(a){return a&&a.name&&
a.w_renderbuffer?!0:!1};a.is_float=function(b){return b.type==a.TT_RGBA_FLOAT||b.type==a.TT_RGB_FLOAT?!0:!1};a.get_texture_channel_size=function(b){var c=0;switch(b.type){case a.TT_RGBA_INT:case a.TT_RGB_INT:c=4;break;case a.TT_RGBA_FLOAT:case a.TT_RGB_FLOAT:c=16;break;case a.TT_DEPTH:c=3;break;case a.TT_RENDERBUFFER:c=2}return c};a.generate_texture=function(a,b){var d=null;switch(a){case "SSAO_TEXTURE":d={name:"special_ssao_texture",type:"DATA_TEX2D",extension:"REPEAT",b4w_anisotropic_filtering:"OFF"},
c(d,null,b),d.image={filepath:null}}return d};a.cleanup=function(){M={};S={}};a.play_video=g;a.reset_video=y;a.pause_video=m;a.pause=function(){for(var a in S)E.seq_video_fallback&&!S[a].seq_video_played||!E.seq_video_fallback&&S[a].video_file.paused||(m(a),S[a].video_was_stopped=!0)};a.reset=function(){for(var a in S)y(a),S[a].video_was_stopped=!1};a.play=function(a){for(var b in S)if(!a||S[b].video_was_stopped)g(b),S[b].video_was_stopped=!1}};b4w.module.__dds=function(a,q){function r(a,b,c,d){var e=new Uint16Array(4),g=new Uint16Array(c*d),f=0,h=0,k=0,l=h=f=0,r=0,q=0,z=0,B=c/4;d/=4;for(var K=0;K<d;K++)for(var v=0;v<B;v++)k=b+4*(K*B+v),e[0]=a[k],e[1]=a[k+1],f=e[0]&31,h=e[0]&2016,l=e[0]&63488,r=e[1]&31,q=e[1]&2016,z=e[1]&63488,e[2]=5*f+3*r>>3|5*h+3*q>>3&2016|5*l+3*z>>3&63488,e[3]=5*r+3*f>>3|5*q+3*h>>3&2016|5*z+3*l>>3&63488,f=a[k+2],h=4*K*c+4*v,g[h]=e[f&3],g[h+1]=e[f>>2&3],g[h+2]=e[f>>4&3],g[h+3]=e[f>>6&3],h+=c,g[h]=e[f>>8&3],g[h+1]=e[f>>
10&3],g[h+2]=e[f>>12&3],g[h+3]=e[f>>14],f=a[k+3],h+=c,g[h]=e[f&3],g[h+1]=e[f>>2&3],g[h+2]=e[f>>4&3],g[h+3]=e[f>>6&3],h+=c,g[h]=e[f>>8&3],g[h+1]=e[f>>10&3],g[h+2]=e[f>>12&3],g[h+3]=e[f>>14];return g}function c(a,b,c,d){var C=new Int32Array(c,0,31),A,f,E,n,t,q;if(542327876!=C[0])return h.error("Invalid magic number in DDS header"),0;if(!C[20]&4)return h.error("Unsupported format, must contain a FourCC code"),0;A=C[21];switch(A){case e:f=8;E=b?b.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case k:f=16;E=
b?b.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case g:f=16;E=b?b.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:return h.error("Unsupported FourCC code:",l(A)),null}q=1;C[2]&131072&&!1!==d&&(q=Math.max(1,C[7]));n=C[4];t=C[3];C=C[1]+4;if(b)for(A=0;A<q;++A)d=Math.max(4,n)/4*Math.max(4,t)/4*f,b=new Uint8Array(c,C,d),a.compressedTexImage2D(a.TEXTURE_2D,A,E,n,t,0,b),C+=d,n=Math.max(.5*n,1),t=Math.max(.5*t,1);else if(A==e)Math.max(4,n),Math.max(4,t),b=new Uint16Array(c),c=r(b,C/2,n,t),a.texImage2D(a.TEXTURE_2D,
0,a.RGB,n,t,0,a.RGB,a.UNSIGNED_SHORT_5_6_5,c),d&&a.generateMipmap(a.TEXTURE_2D);else return h.error("No manual decoder for",l(A),"and no native support"),0;return q}function d(a,b,d,e,g,h){var f=new XMLHttpRequest;f.open("GET",d,!0);f.responseType="arraybuffer";f.onload=function(){if(200==f.status){a.bindTexture(a.TEXTURE_2D,e);var d=c(a,b,f.response,g);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,1<d?a.LINEAR_MIPMAP_LINEAR:a.LINEAR)}h&&
h(e)};f.send(null);return e}function b(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function l(a){return String.fromCharCode(a&255,a>>8&255,a>>16&255,a>>24&255)}var h=q("__print"),e=b("DXT1"),k=b("DXT3"),g=b("DXT5");a.dxt_to_rgb_565=r;a.upload_dds_levels=c;a.get_width_height=function(a){a=new Int32Array(a,0,31);return{width:a[4],height:a[3]}};a.get_compress_ratio=function(a){var b=1;a=(new Int32Array(a,0,31))[21];switch(a){case e:b=6;break;case k:case g:b=
4;break;default:h.error("Unsupported FourCC code:",l(a))}return b};a.load_dds_texture_ex=d;a.load_dds_texture=function(a,b,c,e){var g=a.createTexture();d(a,b,c,g,!0,e);return g}};b4w.module.__loader=function(a,q){function r(b,d,e,g){var h=A,k=s.create(),l;for(l in d){var y=c(d[l]);(g&&y.is_resource||!b&&y.primary_only)&&m(y);s.append_node_attr(k,y)}for(l in d)for(y=d[l],y.name=l,b=0;b<y.inputs.length;b++)s.append_edge_attr(k,d[y.inputs[b]],y,null);d=c({name:"out",priority:a.FINISH_PRIORITY,cb_before:function(a,b,c,d,f,e){0===b.id&&(h.primary_loaded=!0);3!=b.status&&(b.status=2);b.loaded_cb(b.id,!0);f(b,c);x.log("%cTHREAD "+b.id+": LOADED CALLBACK","color: #f0f;")},relative_size:5});
var r=[];if(e)for(e=s.get_sink_nodes(k),b=0;b<e.length;b++)r.push(s.get_node_attr(k,e[b]));else s.traverse(k,function(a,b){b.background_loading||r.push(b)});s.append_node_attr(k,d);for(b=0;b<r.length;b++)d.inputs.push(r[b].name),s.append_edge_attr(k,r[b],d,null);return k}function c(a){a.background_loading=a.background_loading||!1;a.priority||0===a.priority||(a.priority=a.SYNC_PRIORITY);a.inputs=a.inputs||[];a.is_finished=a.is_finished||!1;a.skip=a.skip||!1;a.relative_size=a.relative_size||0;a.is_resource=
a.is_resource||!1;a.primary_only=a.primary_only||!1;a.status=0;a.loop_index=0;a.load_rate=0;a.cb_param=a.cb_param||null;return a}function d(a,b){for(var c=[],d=[],e=0;e<b.length;e++){var g=b[e];s.get_node_attr(a.stage_graph,g).is_finished&&(s.traverse_outputs(a.stage_graph,g,function(d,e,g){var h=!0;s.traverse_inputs(a.stage_graph,d,function(a,b,c){if(!b.is_finished)return h=!1,1});h&&-1==c.indexOf(d)&&-1==b.indexOf(d)&&c.push(d)}),d.push(e))}for(e=d.length-1;0<=e;e--)b.splice(d[e],1);return c}function b(a){var b=
[],c=a.stages_queue,e=!1;do{var g=d(a,c);b.push.apply(b,c);0<g.length&&(e=!0);c=g}while(0<g.length);c=function(b,c){var d=s.get_node_attr(a.stage_graph,b),e=s.get_node_attr(a.stage_graph,c),g=e.priority-d.priority;0==g&&(g=d.background_loading-e.background_loading);return g};e&&b.sort(c);a.stages_queue=b;return a.stages_queue.length}function l(a,b,c){if(b.skip)return b.is_finished=!0,e(a,b),!1;if(!b.cb_before&&!b.cb_loop&&!b.cb_after)return e(a,b),!1;if(0==b.status&&(b.status++,b.cb_before))return b.cb_before(c,
a,b,b.cb_param,e,k),!0;if(1==b.status){if(b.cb_loop)return b.cb_loop(c,a,b,b.cb_param,e,k),!0;b.status++}return 2==b.status&&(b.status++,b.cb_after)?(b.cb_after(c,a,b,b.cb_param,e,k),!0):!1}function h(a){if(0==a.stages_size_total)return 100;var b=0;s.traverse(a.stage_graph,function(c,d){a.do_not_load_resources&&d.is_resource||(b+=d.load_rate*d.relative_size)});return C.trunc(100*b/a.stages_size_total)}function e(a,b){b.is_finished=!0;b.status=3;g(a,b,1)}function k(a,b,c){1>c?g(a,b,c):b.status++}function g(a,
b,c){var d=A;if(b.cb_before||b.cb_loop||b.cb_after)if(b.load_rate=c,b=h(a),a.curr_percents!=b||1==c)a.stageload_cb(b,performance.now()-a.time_load_start),a.curr_percents=b,d.make_idle_iteration=!0}function y(a,b){var c=null;s.traverse(a.stage_graph,function(a,d){if(d.name==b)return c=d,1});return c}function m(a){a.skip=!0;a.load_rate=1}var s=q("__graph"),x=q("__print"),C=q("__util");a.SYNC_PRIORITY=0;a.ASYNC_PRIORITY=1;a.FINISH_PRIORITY=2;var A=null;a.get_scheduler=function(){return A};a.create_scheduler=
function(){var a={threads:[],current_thread_index:0,active_threads:0,primary_loaded:!1,make_idle_iteration:!1};return A=a};a.create_thread=function(a,b,c,d,e,g,h,k){var l=A,m={id:l.threads.length,status:0,filepath:b,binary_name:"",loaded_cb:c||function(){},load_hidden:k||!1,wait_complete_loading:g,time_load_start:0,curr_percents:0,stages_size_total:0,reset_time_cycle:!1,stageload_cb:d||function(){},complete_load_cb:e||function(){},stage_graph:null,stages_queue:null,has_video_textures:!1,has_background_music:!1,
init_wa_context:!1};a=r(0===m.id,a,g,h);m.stage_graph=a;b=[];c=s.get_source_nodes(a);for(d=0;d<c.length;d++)b.push(c[d]);m.stages_queue=b;s.traverse(a,function(a,b){if(b.cb_before||b.cb_loop||b.cb_after)m.do_not_load_resources&&b.is_resource||(m.stages_size_total+=b.relative_size)});l.threads.push(m);l.active_threads++;return m.id};a.update_scheduler=function(c){var d=A,e;(e=!d)||(e=0==A.active_threads);if(!e)if(d.make_idle_iteration)d.make_idle_iteration=!1;else{e=performance.now();do{var g=d.threads[d.current_thread_index],
h=c[g.id];if(3!=g.status)if(0==g.status&&(g.status=1,g.time_load_start=performance.now(),g.stageload_cb(0,0)),b(g)){var k=g,m=k.stages_queue.length;do{var x=s.get_node_attr(k.stage_graph,k.stages_queue[0]),y=l(k,x,h);x.priority==a.ASYNC_PRIORITY&&(k.reset_time_cycle=!0);x=k.stages_queue.shift();k.stages_queue.push(x);m--}while(!y&&0!=m)}else g.complete_load_cb(h,g),g.status=3,d.active_threads--,k=g,k.stageload_cb=null,k.complete_load_cb=null,k.stage_graph=null,k.stages_queue=null;d.primary_loaded&&
(d.current_thread_index=(d.current_thread_index+1)%d.threads.length);if(g.reset_time_cycle){g.reset_time_cycle=!1;break}}while(16>performance.now()-e)}};a.stage_part_finish_cb=k;a.skip_stage_by_name=function(a,b){var c=y(a,b);null!==c&&m(c)};a.thread_is_finished=function(a){return a&&3==a.status};a.is_primary_loaded=function(a){var b=A;if(!b)return!1;a|=0;return b.threads[a]&&(3==b.threads[a].status||2==b.threads[a].status)};a.cleanup=function(){A=null}};b4w.module.__camera=function(a,q){function r(b){switch(b){case "STATIC":return a.MS_STATIC;case "TARGET":return a.MS_TARGET_CONTROLS;case "EYE":return a.MS_EYE_CONTROLS;case "HOVER":return a.MS_HOVER_CONTROLS;default:throw"Unknown move style";}}function c(b){var c;c={type:b,name:"",size_mult:1,width:0,height:0,framebuffer:null,color_attachment:null,depth_attachment:null,aspect:0,fov:0,near:0,far:0,left:0,right:0,top:0,bottom:0,eye:new Float32Array(3),eye_last:new Float32Array(3),quat:new Float32Array(4),
view_matrix:new Float32Array(16),billboard_view_matrix:new Float32Array(16),proj_matrix:new Float32Array(16),view_proj_inv_matrix:new Float32Array(16),prev_view_proj_matrix:new Float32Array(16),sky_vp_inv_matrix:new Float32Array(16),shadow_cast_billboard_view_matrix:new Float32Array(16),view_proj_matrix:new Float32Array(16),dof_distance:0,dof_front:0,dof_rear:0,dof_power:0,dof_object:null,dof_on:0,frustum_planes:{left:new Float32Array([0,0,0,0]),right:new Float32Array([0,0,0,0]),top:new Float32Array([0,
0,0,0]),bottom:new Float32Array([0,0,0,0]),near:new Float32Array([0,0,0,0]),far:new Float32Array([0,0,0,0])},stereo_conv_dist:0,stereo_eye_dist:0,reflection_plane:null,csm_centers:null,csm_radii:null,csm_center_dists:new Float32Array(4),pcf_blur_radii:new Float32Array(4)};if(b==a.TYPE_NONE)return c;switch(b){case a.TYPE_PERSP:l(c,40,.1,1E3);break;case a.TYPE_ORTHO:l(c,2.5,.1,1E3);break;case a.TYPE_PERSP_ASPECT:break;case a.TYPE_ORTHO_ASPECT:break;case a.TYPE_ORTHO_ASYMMETRIC:break;case a.TYPE_STEREO_LEFT:case a.TYPE_STEREO_RIGHT:throw"Stereo camera may only be created from perspective one";
default:throw"Unknown camera type";}return c}function d(b,c,d){if(b.type!=a.TYPE_STEREO_LEFT&&b.type!=a.TYPE_STEREO_RIGHT)throw"set_stereo_params(): wrong camera type";b.stereo_conv_dist=c;b.stereo_eye_dist=d;E(b,b.aspect);if(L.check_active())for(c=L.get_active(),b=c._render.shadow_params,c=L.get_camera(c)._render.cameras,d=0;d<c.length;d++)z(c[d],b)}function b(a,b){var c=a._render,d=G.quat_to_dir(c.quat,G.AXIS_MY,p),e=Math.asin(d[1]/V.length(d));0==d[0]&&0==d[2]?c=0:(Math.abs(e)>Math.PI/4&&(d=0>=
e?G.quat_to_dir(c.quat,G.AXIS_MZ,ga):G.quat_to_dir(c.quat,G.AXIS_Z,ga)),c=Math.atan(Math.abs(d[0]/d[2])),0<d[2]&&(c=Math.PI-c),0<d[0]&&(c=2*Math.PI-c));b[0]=c;b[1]=e;return b}function l(b,c,d,e,f){switch(b.type){case a.TYPE_PERSP:case a.TYPE_STEREO_LEFT:case a.TYPE_STEREO_RIGHT:b.fov=c;b.aspect=1;break;case a.TYPE_ORTHO:b.top=c;b.aspect=1;break;case a.TYPE_PERSP_ASPECT:delete b.fov;b.fov=c;b.aspect=f/c;break;case a.TYPE_ORTHO_ASPECT:b.top=c;b.aspect=f/c;break;default:O.error("set_frustum(): Unsupported camera type: "+
b.type)}b.near=d;b.far=e}function h(b,c){var d=c._render.trans,e=c._render.quat,f=ea;T.rotateX(c._render.world_matrix,-Math.PI/2,f);T.invert(f,b.view_matrix);if(b.reflection_plane){var f=b.reflection_plane[0],g=b.reflection_plane[1],w=b.reflection_plane[2],h=b.reflection_plane[3],k=ea;k[0]=1-2*f*f;k[1]=-2*f*g;k[2]=-2*f*w;k[3]=0;k[4]=-2*f*g;k[5]=1-2*g*g;k[6]=-2*g*w;k[7]=0;k[8]=-2*f*w;k[9]=-2*g*w;k[10]=1-2*w*w;k[11]=0;k[12]=-2*f*h;k[13]=-2*g*h;k[14]=-2*w*h;k[15]=1;T.multiply(b.view_matrix,k,b.view_matrix);
E(b,b.aspect,!0);f=N;g=ea;T.invert(b.view_matrix,g);T.transpose(g,g);$.transformMat4(b.reflection_plane,g,f);g=F;g[0]=(G.sign(f[0])+b.proj_matrix[8])/b.proj_matrix[0];g[1]=(G.sign(f[1])+b.proj_matrix[9])/b.proj_matrix[5];g[2]=-1;g[3]=(1+b.proj_matrix[10])/b.proj_matrix[14];$.scale(f,2/(f[0]*g[0]+f[1]*g[1]+f[2]*g[2]+f[3]*g[3]),f);b.proj_matrix[2]=f[0];b.proj_matrix[6]=f[1];b.proj_matrix[10]=f[2]+1;b.proj_matrix[14]=f[3]}b.type==a.TYPE_STEREO_LEFT?b.view_matrix[12]+=b.stereo_eye_dist/2:b.type==a.TYPE_STEREO_RIGHT&&
(b.view_matrix[12]-=b.stereo_eye_dist/2);T.multiply(b.proj_matrix,b.view_matrix,b.view_proj_matrix);t(b);n(b);V.copy(b.eye,b.eye_last);V.copy(d,b.eye);P.copy(e,b.quat)}function e(b,c,d,e){T.lookAt(c,d,e,b.view_matrix);b.type==a.TYPE_STEREO_LEFT?b.view_matrix[12]+=b.stereo_eye_dist/2:b.type==a.TYPE_STEREO_RIGHT&&(b.view_matrix[12]-=b.stereo_eye_dist/2);T.multiply(b.proj_matrix,b.view_matrix,b.view_proj_matrix);t(b);n(b);V.copy(c,b.eye)}function k(a){var b=a._render.cameras;if(!b)throw"Wrong object";
for(var c=a._render,d=0;d<b.length;d++){var e=b[d];h(e,a);G.extract_frustum_planes(e.view_proj_matrix,e.frustum_planes);if(e.dof_object)if(e.dof_on){var f=V.dist(c.trans,e.dof_object.location);e.dof_distance=f}else e.dof_distance=0}}function g(b){b=b._render;if(b.horizontal_limits){var c=p;b.move_style==a.MS_TARGET_CONTROLS?V.subtract(b.trans,b.pivot,c):G.quat_to_dir(b.quat,G.AXIS_MY,c);c[1]=0;V.normalize(c,c);var d=-Math.acos(-c[2]);0>c[0]&&(d=-2*Math.PI-d);b.move_style==a.MS_EYE_CONTROLS&&(d*=-1);
b.horizontal_limits.left+=d;b.horizontal_limits.right+=d}}function y(b){b=b._render;if(b.vertical_limits){var c=p;b.move_style==a.MS_TARGET_CONTROLS?V.subtract(b.trans,b.pivot,c):G.quat_to_dir(b.quat,G.AXIS_MY,c);V.normalize(c,c);c=Math.asin(c[1]);b.vertical_limits.up+=c;b.vertical_limits.down+=c}}function m(a){a=a._render;if(a.horizontal_limits)if(a.vertical_limits){var b=G.angle_wrap_0_2pi(a.vertical_limits.up+Math.PI/2),c=G.angle_wrap_0_2pi(a.vertical_limits.down+Math.PI/2);if(c>Math.PI)a.vertical_limits=
{down:-Math.PI/2,up:Math.PI/2};else if(b>Math.PI||b<c)a.vertical_limits.up=Math.PI/2}else a.vertical_limits={down:-Math.PI/2,up:Math.PI/2}}function s(b){var c=b._render;if(S(b)&&c.cameras[0].type===a.TYPE_ORTHO){if(c.move_style===a.MS_TARGET_CONTROLS)var d=V.dist(c.trans,c.pivot),c=d/c.init_dist*c.init_top;else c.use_distance_limits&&c.move_style===a.MS_HOVER_CONTROLS?(d=f(b,p),d=V.len(d),c=d/c.init_dist*c.init_top):c=c.init_top;for(var e in b._render.cameras)d=b._render.cameras[e],d.top=c,E(d,d.aspect);
k(b)}}function x(a){a=G.quat_to_dir(a._render.quat,G.AXIS_MY,p);V.normalize(a,a);return-Math.asin(a[1])}function C(a,b,c){if(b==c)return c-a;a=G.angle_wrap_0_2pi(a);b=G.angle_wrap_0_2pi(b);c=G.angle_wrap_0_2pi(c);var d=Math.abs(b-c);if(.001>d||.001>Math.abs(d-2*Math.PI))return 0;b=2*Math.PI-b;c=G.angle_wrap_0_2pi(c+b);a=G.angle_wrap_0_2pi(a+b);return a>c?(c-=a,a=2*Math.PI-a,-c>a?a:c):0}function A(a,b,c){a=a._render;var d=V.subtract(a.pivot,a.trans,p);b=P.setAxisAngle(b,c,Z);V.transformQuat(d,b,d);
V.subtract(a.pivot,d,a.trans);P.multiply(b,a.quat,a.quat)}function f(a,b){var c=a._render;if(c.use_distance_limits){var d=G.quat_to_dir(c.quat,G.AXIS_MY,p);V.normalize(d,d);if(c.hover_angle_limits.up-c.hover_angle_limits.down)var e=(-Math.asin(d[1])-c.hover_angle_limits.down)/(c.hover_angle_limits.up-c.hover_angle_limits.down),e=Math.max(e,0);else e=0;return V.scale(d,-(e*(c.distance_max-c.distance_min)+c.distance_min),b)}return null}function E(b,c,d){switch(b.type){case a.TYPE_PERSP:if(!c)throw"No aspect ratio";
b.aspect=c;case a.TYPE_PERSP_ASPECT:T.perspective(G.rad(b.fov),b.aspect,b.near,b.far,b.proj_matrix);break;case a.TYPE_ORTHO:if(!c)throw"No aspect ratio";b.aspect=c;case a.TYPE_ORTHO_ASPECT:c=b.top*b.aspect;T.ortho(-c,c,-b.top,b.top,b.near,b.far,b.proj_matrix);break;case a.TYPE_ORTHO_ASYMMETRIC:T.ortho(b.left,b.right,b.bottom,b.top,b.near,b.far,b.proj_matrix);break;case a.TYPE_STEREO_LEFT:case a.TYPE_STEREO_RIGHT:if(!c)throw"No aspect ratio";b.aspect=c;var e=Math.tan(b.fov*Math.PI/360);c=b.near*e;
var f=b.aspect*b.stereo_conv_dist*e;b.type==a.TYPE_STEREO_LEFT?(e=f-b.stereo_eye_dist/2,f+=b.stereo_eye_dist/2):(e=f+b.stereo_eye_dist/2,f-=b.stereo_eye_dist/2);e=-(b.near/b.stereo_conv_dist*e);f*=b.near/b.stereo_conv_dist;T.frustum(e,f,-c,c,b.near,b.far,b.proj_matrix);b.left=e;b.right=f;break;case a.TYPE_NONE:return;default:throw"Wrong camera type: "+b.type;}d||(T.multiply(b.proj_matrix,b.view_matrix,b.view_proj_matrix),t(b),n(b))}function n(a){T.copy(a.view_matrix,a.sky_vp_inv_matrix);a.sky_vp_inv_matrix[12]=
0;a.sky_vp_inv_matrix[13]=0;a.sky_vp_inv_matrix[14]=0;a.sky_vp_inv_matrix[15]=1;T.multiply(a.proj_matrix,a.sky_vp_inv_matrix,a.sky_vp_inv_matrix);T.invert(a.sky_vp_inv_matrix,a.sky_vp_inv_matrix)}function t(a){T.copy(a.view_matrix,a.view_proj_inv_matrix);T.multiply(a.proj_matrix,a.view_proj_inv_matrix,a.view_proj_inv_matrix);T.invert(a.view_proj_inv_matrix,a.view_proj_inv_matrix)}function M(b,c,d,e,f){e||(e=new Float32Array(24));c||(c=b.near);d||(d=b.far);var g,w,h,k,l,m,p,n;switch(b.type){case a.TYPE_NONE:throw"Extraction from NONE camera is not possible";
case a.TYPE_PERSP:case a.TYPE_PERSP_ASPECT:g=c*Math.tan(b.fov*Math.PI/360);k=-g;w=g*b.aspect;h=-w;l=d/c*g;n=-l;m=l*b.aspect;p=-m;break;case a.TYPE_ORTHO:case a.TYPE_ORTHO_ASPECT:h=b.top*b.aspect;g=l=b.top;w=m=h;k=n=-b.top;h=p=-h;break;case a.TYPE_ORTHO_ASYMMETRIC:g=l=b.top;w=m=b.right;k=n=b.bottom;h=p=b.left;break;case a.TYPE_STEREO_LEFT:case a.TYPE_STEREO_RIGHT:l=c/b.near;g=c*Math.tan(b.fov*Math.PI/360);k=-g;w=b.right*l;h=b.left*l;p=d/c;l=g*p;n=-l;m=w*p;p*=h;break;default:throw"Wrong camera type: "+
b.type;}e[0]=h;e[1]=k;e[2]=-c;e[3]=w;e[4]=k;e[5]=-c;e[6]=w;e[7]=g;e[8]=-c;e[9]=h;e[10]=g;e[11]=-c;e[12]=p;e[13]=n;e[14]=-d;e[15]=p;e[16]=l;e[17]=-d;e[18]=m;e[19]=l;e[20]=-d;e[21]=m;e[22]=n;e[23]=-d;f&&(c=ea,T.invert(b.view_matrix,c),G.positions_multiply_matrix(e,c,e,0));return e}function S(a){return"CAMERA"===a.type?!0:!1}function z(a,b){if(b.b4w_enable_csm){var c=b.csm_num;if(!a.csm_centers){var d=b.csm_num;a.csm_centers=Array(d);for(var e=0;e<d;e++)a.csm_centers[e]=new Float32Array(3);a.csm_radii=
new Float32Array(d)}for(d=0;d<c;d++){var e=0==d?a.near:B(b,a,d-1),f=B(b,a,d),e=M(a,e,f,D),e=v.get_frustum_mec(e);a.csm_centers[d].set(e.center);a.csm_radii[d]=e.radius;a.csm_center_dists[d]=V.length(e.center);a.pcf_blur_radii[d]=K(b.first_cascade_blur_radius,b.last_cascade_blur_radius,c,d)}}else a.pcf_blur_radii[0]=b.first_cascade_blur_radius}function B(a,b,c){var d=a.csm_num,e=G.clamp(a.csm_first_cascade_border,b.near,b.far);a=G.clamp(a.csm_last_cascade_border,b.near,b.far);c=K(e,a,d,c);return G.clamp(c,
b.near,b.far)}function K(a,b,c,d){switch(d){case 0:break;case c-1:a=b;break;default:a=0==a?0:a*Math.pow(b/a,d/(c-1))}return a}var v=q("__boundings");q("__config");var Q=q("__constraints"),O=q("__print"),L=q("__scenes"),G=q("__util"),V=q("vec3"),$=q("vec4"),P=q("quat"),Y=q("mat3"),T=q("mat4");a.TYPE_NONE=10;a.TYPE_PERSP=20;a.TYPE_ORTHO=30;a.TYPE_PERSP_ASPECT=40;a.TYPE_ORTHO_ASPECT=50;a.TYPE_ORTHO_ASYMMETRIC=60;a.TYPE_STEREO_LEFT=70;a.TYPE_STEREO_RIGHT=80;a.MS_STATIC=0;a.MS_ANIMATION=1;a.MS_TARGET_CONTROLS=
2;a.MS_EYE_CONTROLS=3;a.MS_HOVER_CONTROLS=4;var X=new Float32Array(2),p=new Float32Array(3),ga=new Float32Array(3),Z=new Float32Array(4);new Float32Array(4);var N=new Float32Array(4),F=new Float32Array(4),ha=new Float32Array(16),ea=new Float32Array(16),D=new Float32Array(24);a.camera_object_to_camera=function(b){var d=b._render,e=b.data;switch(e.type){case "PERSP":var f=c(a.TYPE_PERSP);if(e.angle_y)var h=e.angle_y/Math.PI*180;l(f,h,e.clip_start,e.clip_end);break;case "ORTHO":f=c(a.TYPE_ORTHO),l(f,
e.ortho_scale/2,e.clip_start,e.clip_end)}f.name=b.name;d.underwater=!1;d.move_style=r(e.b4w_move_style);d.dof_distance=b.data.dof_distance;d.dof_object=b.data.dof_object;d.dof_front=b.data.b4w_dof_front;d.dof_rear=b.data.b4w_dof_rear;d.dof_power=b.data.b4w_dof_power;d.enable_hover_hor_rotation=b.data.b4w_enable_hover_hor_rotation;d.cameras=[f];if(d.move_style==a.MS_TARGET_CONTROLS||d.move_style==a.MS_EYE_CONTROLS||d.move_style==a.MS_HOVER_CONTROLS)d.velocity_trans=b.data.b4w_trans_velocity,d.velocity_rot=
b.data.b4w_rot_velocity,d.velocity_zoom=b.data.b4w_zoom_velocity;d.move_style==a.MS_TARGET_CONTROLS&&d.pivot.set(e.b4w_target);d=b._render;if(d.move_style===a.MS_TARGET_CONTROLS||d.move_style===a.MS_EYE_CONTROLS||d.move_style===a.MS_HOVER_CONTROLS)e=b.data,d.move_style===a.MS_TARGET_CONTROLS||d.move_style===a.MS_EYE_CONTROLS?(e.b4w_use_horizontal_clamping&&(d.horizontal_limits={left:e.b4w_rotation_left_limit,right:e.b4w_rotation_right_limit}),e.b4w_use_vertical_clamping&&(d.vertical_limits={down:e.b4w_rotation_down_limit,
up:e.b4w_rotation_up_limit}),"LOCAL"==e.b4w_horizontal_clamping_type&&g(b),"LOCAL"==e.b4w_vertical_clamping_type&&y(b),m(b),e.b4w_use_panning&&(d.use_panning=e.b4w_use_panning)):d.move_style===a.MS_HOVER_CONTROLS&&(e.b4w_use_horizontal_clamping&&e.b4w_horizontal_translation_min<=e.b4w_horizontal_translation_max&&(d.horizontal_limits={left:e.b4w_horizontal_translation_min,right:e.b4w_horizontal_translation_max}),e.b4w_use_vertical_clamping&&e.b4w_vertical_translation_min<=e.b4w_vertical_translation_max&&
(d.vertical_limits={down:-e.b4w_vertical_translation_max,up:-e.b4w_vertical_translation_min}),e.b4w_use_distance_limits&&e.b4w_hover_angle_min<=e.b4w_hover_angle_max&&(d.hover_angle_limits={down:e.b4w_hover_angle_min,up:e.b4w_hover_angle_max})),d.use_distance_limits=e.b4w_use_distance_limits&&e.b4w_distance_min<=e.b4w_distance_max,d.use_distance_limits&&(d.distance_min=e.b4w_distance_min,d.distance_max=e.b4w_distance_max);d=b._render;if(d.move_style===a.MS_HOVER_CONTROLS&&d.use_distance_limits)if(d.hover_angle_limits){if(e=
x(b),f=G.quat_to_dir(d.quat,G.AXIS_Z,p),b=0,0<f[1]&&(b-=Math.asin(f[1]/V.len(f))),e>d.hover_angle_limits.up?b+=e-d.hover_angle_limits.up:e<d.hover_angle_limits.down&&(b+=d.hover_angle_limits.down-e),(b||0>e)&&O.warn("B4W Warning: Active hover camera has wrong orientation"),b&&(e=G.quat_to_dir(d.quat,G.AXIS_X,ga),b=P.setAxisAngle(e,-b,Z),P.normalize(b,b),P.multiply(b,d.quat,d.quat)),b=G.quat_to_dir(d.quat,G.AXIS_MY,p),e=N,e.set(G.AXIS_Y),e[3]=0,b=G.line_plane_intersect(e,0,d.trans,b,d.hover_pivot),
d.init_dist=V.dist(d.trans,d.hover_pivot),d.init_top=d.cameras[0].top,!b||100<V.len(b))d.hover_pivot[0]=d.trans[0],d.hover_pivot[1]=0,d.hover_pivot[2]=d.trans[2]}else d.use_distance_limits=!1;else d.move_style===a.MS_TARGET_CONTROLS&&(d.init_dist=V.dist(d.trans,d.pivot),d.init_top=d.cameras[0].top)};a.create_camera=c;a.check_attachment=function(a,b){switch(b){case "COLOR":case "CUBEMAP":return Boolean(a.color_attachment);case "DEPTH":return Boolean(a.depth_attachment);case "SCREEN":return!Boolean(a.color_attachment)&&
!Boolean(a.depth_attachment);default:throw"Wrong attachment type: "+b;}};a.set_attachment=function(a,b,c){switch(b){case "COLOR":case "CUBEMAP":a.color_attachment=c;break;case "DEPTH":a.depth_attachment=c;break;case "SCREEN":a.color_attachment=null;a.depth_attachment=null;break;default:throw"Wrong attachment type: "+b;}};a.get_attachment=function(a,b){switch(b){case "COLOR":case "CUBEMAP":return a.color_attachment;case "DEPTH":return a.depth_attachment;case "SCREEN":return null;default:throw"Wrong attachment type: "+
b;}};a.make_stereo=function(b,c){if(b.type!=a.TYPE_PERSP||c!=a.TYPE_STEREO_LEFT&&c!=a.TYPE_STEREO_RIGHT)throw"make_stereo(): wrong camera type";b.type=c;d(b,6,.065)};a.set_stereo_params=d;a.rotate_h=function(a,b){var c=a._render.quat,d=Z,e=p;e[0]=0;e[1]=1;e[2]=0;P.setAxisAngle(e,b,d);P.multiply(d,c,c)};a.rotate_v=function(a,b){var c=a._render.quat,d=Z,e=p;e[0]=1;e[1]=0;e[2]=0;P.setAxisAngle(e,b,d);P.multiply(d,c,c)};a.rotate_h_local=function(a,b){var c=a._render.quat;P.invert(c,c);var d=Z,e=p;e[0]=
0;e[1]=0;e[2]=1;P.setAxisAngle(e,-b,d);P.multiply(d,c,c);P.invert(c,c)};a.rotate_v_local=function(a,b){var c=a._render.quat;P.invert(c,c);var d=Z,e=p;e[0]=1;e[1]=0;e[2]=0;P.setAxisAngle(e,-b,d);P.multiply(d,c,c);P.invert(c,c)};a.get_angles=b;a.set_frustum=l;a.set_frustum_asymmetric=function(b,c,d,e,f,g,w){switch(b.type){case a.TYPE_ORTHO_ASYMMETRIC:b.left=c;b.right=d;b.bottom=e;b.top=f;b.near=g;b.far=w;break;default:O.error("set_frustum_asymmetric(): Unsupported camera type: "+b.type)}};a.get_move_style=
function(a){return a._render.move_style};a.set_view=h;a.set_view_eye_target_up=e;a.set_view_trans_quat=function(a,b,c){var d=p;d[0]=0;d[1]=-1;d[2]=0;V.transformQuat(d,c,d);d[0]+=b[0];d[1]+=b[1];d[2]+=b[2];var f=ga;f[0]=0;f[1]=0;f[2]=-1;V.transformQuat(f,c,f);e(a,b,d,f)};a.set_camera_trans_quat=function(a,b,c){if("CAMERA"!=a.type)throw"Wrong camera object";a=a._render;a.trans.set(b);a.quat.set(c)};a.eye_target_up_to_trans_quat=function(a,b,c,d,e){d[0]=a[0];d[1]=a[1];d[2]=a[2];T.lookAt(a,b,c,ea);T.invert(ea,
ea);T.rotateX(ea,Math.PI/2,ea);Y.fromMat4(ea,ha);P.fromMat3(ha,e)};a.update_camera_transform=k;a.update_camera=function(b){var c=b._render;if(c.move_style==a.MS_TARGET_CONTROLS)if(c.use_distance_limits){if(Q.rotate_to_limits(c.trans,c.quat,c.pivot,c.distance_min,Q.CONS_ROTATE_LIMIT)){var d=V.subtract(c.trans,c.pivot,p);V.scale(d,-c.distance_min/V.length(d),d);V.add(c.pivot,d,c.trans)}}else Q.rotate_to(c.trans,c.quat,c.pivot);c.move_style!=a.MS_TARGET_CONTROLS&&c.move_style!=a.MS_EYE_CONTROLS||Q.correct_up(b,
G.AXIS_Y)};a.horizontal_limits_local_to_world=g;a.vertical_limits_local_to_world=y;a.vertical_limits_correct=m;a.update_ortho_scale=s;a.clamp_limits=function(c){var d=c._render;if(d.move_style===a.MS_TARGET_CONTROLS||d.move_style===a.MS_EYE_CONTROLS){if(d.horizontal_limits){var e=d.horizontal_limits.left,g=d.horizontal_limits.right,h=b(c,X),h=h[0],h=d.move_style==a.MS_TARGET_CONTROLS?h-Math.PI:-1*h;if(h=C(h,e,g))d.move_style==a.MS_TARGET_CONTROLS?A(c,G.AXIS_Y,h):(h=P.setAxisAngle(G.AXIS_MY,h,Z),P.multiply(h,
c._render.quat,c._render.quat))}d.vertical_limits&&(e=d.vertical_limits.down,g=d.vertical_limits.up,h=b(c,X),h=h[1],d.move_style==a.MS_TARGET_CONTROLS&&(h*=-1),h=0<G.quat_to_dir(d.quat,G.AXIS_Z,p)[1]?G.sign(h)*Math.PI-h:h,h=C(h,e,g))&&(d.move_style==a.MS_TARGET_CONTROLS?(e=G.quat_to_dir(c._render.quat,G.AXIS_MX,ga),A(c,e,h)):(e=h,h=c._render,g=G.quat_to_dir(h.quat,G.AXIS_X,p),e=P.setAxisAngle(g,e,Z),P.multiply(e,h.quat,h.quat)));d.move_style===a.MS_TARGET_CONTROLS&&(d.use_distance_limits&&(h=c._render,
e=V.subtract(h.trans,h.pivot,p),g=V.length(e),g>h.distance_max?(V.scale(e,h.distance_max/g,e),V.add(h.pivot,e,h.trans)):g<h.distance_min&&(g=G.quat_to_dir(h.quat,G.AXIS_MY,ga),V.scale(g,100*h.distance_min,g),V.add(e,g,e),V.scale(e,-h.distance_min/V.length(e),e),V.add(h.pivot,e,h.trans))),s(c))}d.move_style===a.MS_HOVER_CONTROLS&&(d=c._render,h=d.use_distance_limits?d.hover_pivot:d.trans,d.horizontal_limits&&(h[0]=G.clamp(h[0],d.horizontal_limits.left,d.horizontal_limits.right)),d.vertical_limits&&
(h[2]=G.clamp(h[2],d.vertical_limits.down,d.vertical_limits.up)),d=c._render,d.use_distance_limits&&(e=G.quat_to_dir(d.quat,G.AXIS_Z,p),h=0,0<e[1]&&(h=Math.asin(e[1]/V.len(e))),e=V.negate(b(c,X),X),e[1]<d.hover_angle_limits.down?h+=e[1]-d.hover_angle_limits.down:e[1]>d.hover_angle_limits.up&&(h+=e[1]-d.hover_angle_limits.up),h&&(e=G.quat_to_dir(d.quat,G.AXIS_X,ga),V.normalize(e,e),h=P.setAxisAngle(e,h,Z),P.normalize(h,h),P.multiply(h,d.quat,d.quat)),h=f(c,p),V.add(d.hover_pivot,h,d.trans),s(c)))};
a.get_hover_angle=x;a.get_hover_dir_pivot=f;a.is_float_aspect=function(b){switch(b.type){case a.TYPE_PERSP:case a.TYPE_ORTHO:case a.TYPE_STEREO_LEFT:case a.TYPE_STEREO_RIGHT:return!0;default:return!1}};a.get_angular_diameter=function(b){b=b._render.cameras[0];switch(b.type){case a.TYPE_PERSP:case a.TYPE_PERSP_ASPECT:case a.TYPE_STEREO_LEFT:case a.TYPE_STEREO_RIGHT:return Math.PI*b.fov/180;default:return O.error("get_min_fov(): Unsupported camera type: "+b.type),0}};a.set_projection=E;a.calc_sky_vp_inverse=
n;a.calc_view_proj_inverse=t;a.extract_frustum_corners=M;a.assign_boundings=function(a){a=a._render;var b=v.zero_bounding_box();b.min_x=-1;b.max_x=1;b.min_y=-1;b.max_y=1;b.min_z=-1;b.max_z=1;a.bb_local=b;var c=v.create_bounding_sphere(1,[0,0,0]);a.bs_local=c;a.bcap_local=v.create_bounding_capsule(1,b);a.bcyl_local=v.create_bounding_cylinder(1,b);a.bcon_local=v.create_bounding_cone(1,b)};a.is_camera=S;a.is_target_camera=function(b){return S(b)&&b._render&&b._render.move_style==a.MS_TARGET_CONTROLS?
!0:!1};a.is_hover_camera=function(b){return S(b)&&b._render&&b._render.move_style==a.MS_HOVER_CONTROLS?!0:!1};a.is_eye_camera=function(b){return S(b)&&b._render&&b._render.move_style==a.MS_EYE_CONTROLS?!0:!1};a.update_camera_shadows=z;a.csm_far_plane=B};b4w.module.__lights=function(a,q){function r(a){return{name:"",index:0,type:a,direction:new Float32Array(3),color:new Float32Array(3),color_intensity:new Float32Array(3),spot_size:0,spot_blend:0,generate_shadows:!1,dynamic_intensity:!1,use_diffuse:!0,use_specular:!0,energy:1,distance:25,falloff_type:"INVERSE_SQUARE"}}function c(a){a.color_intensity[0]=a.color[0]*a.energy;a.color_intensity[1]=a.color[1]*a.energy;a.color_intensity[2]=a.color[2]*a.energy}var d=q("__util"),b=q("vec3");a.init_light=r;
a.lamp_to_light=function(a){var h=a.data,e=r(h.type);e.name=a.name;e.use_diffuse=h.use_diffuse;e.use_specular=h.use_specular;var k=d.quat_to_dir(a._render.quat,d.AXIS_Y,[]);b.normalize(k,k);e.direction[0]=k[0];e.direction[1]=k[1];e.direction[2]=k[2];e.color[0]=h.color[0];e.color[1]=h.color[1];e.color[2]=h.color[2];e.energy=h.energy;c(e);e.distance=h.distance;if("POINT"===e.type||"SPOT"===e.type)e.falloff_type=h.falloff_type;"SPOT"===e.type&&(e.spot_size=h.spot_size,e.spot_blend=h.spot_blend);e.generate_shadows=
h.b4w_generate_shadows;e.dynamic_intensity=h.b4w_dynamic_intensity;a._light=e};a.set_light_color=function(a,b){a.color[0]=b[0];a.color[1]=b[1];a.color[2]=b[2];c(a)};a.set_light_energy=function(a,b){a.energy=b;c(a)};a.update_light_transform=function(a){if("LAMP"!=a.type)throw"Wrong light object";var b=a._light;b&&d.quat_to_dir(a._render.quat,d.AXIS_Y,b.direction)}};b4w.module.__scenes=function(a,q){function r(){if(!Va)throw"No active scene available";return Va}function c(){return Va?!0:!1}function d(a,b,c,d){for(var e=null,f=0;f<b.length;f++){var w=b[f];if((c?w.origin_name:w.name)==a&&w._render.data_id==d){e=w;break}}return e}function b(a,b){b||(b="ALL");var c=[];l(a.objects,b,c);return c}function l(a,b,c){for(var d=0;d<a.length;d++){var e=a[d];"ALL"!=b&&b!=e.type||c.push(e);(e=e.dupli_group)&&l(e.objects,b,c)}}function h(b){if("NONE"==na.shadows||!b.b4w_render_shadows)return!1;
var c=!1,d=!1;if(0==K(b,"LAMP",a.DATA_ID_ALL).length)return!1;b=K(b,"MESH",a.DATA_ID_ALL);for(var e=0;e<b.length;e++){var f=b[e];f.b4w_shadow_cast&&(c=!0);f.b4w_shadow_receive&&(d=!0);if(c&&d)return!0}return!1}function e(a){var b={};a=v(a);for(var c=function(a){if(a){a=a.nodes;for(var d=0;d<a.length;d++){var e=a[d];"GROUP"==e.type&&e.node_group&&c(e.node_group.node_tree);"GROUP"==e.type&&"REFRACTION"==e.node_tree_name&&(b.refractions=!0)}}},d=0;d<a.length;d++){var e=a[d];e.b4w_refractive&&(b.refractions=
!0);e.node_tree&&c(e.node_tree)}return b}function k(a,b,c){c=ka.node_by_attr(a,b);ka.traverse_inputs(a,c,function(a,c,d){if(d.active){switch(d.from){case "COLOR":case "CUBEMAP":a=c.camera.color_attachment;break;case "DEPTH":a=c.camera.depth_attachment;break;case "SCREEN":a=null;break;default:throw"Wrong slink";}switch(d.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "NONE":case "SCREEN":break;default:if(!a)throw"Connection of SCREEN is forbidden";c=b.bundles;for(var e=0;e<c.length;e++){var f=c[e].batch;
ma.check_uniform(f.shader,d.to)&&F.append_texture(f,a,d.to)}}}});for(a=0;a<b.slinks_internal.length;a++){var d=b.slinks_internal[a],e=b.textures_internal[a];switch(d.to){case "COLOR":case "CUBEMAP":case "DEPTH":case "NONE":case "SCREEN":break;default:for(var f=b.bundles,w=0;w<f.length;w++)c=f[w].batch,ma.check_uniform(c.shader,d.to)&&F.append_texture(c,e,d.to)}}}function g(a,b,c,d,e){for(var f=b._render,w=b._batches,g=0;g<w.length;g++){var h=w[g];if(!(h.shadow_cast_only||h.reflexible_only||"MAIN"!=
h.type&&"NODES"!=h.type&&"PARTICLES"!=h.type||A(a,h))){if("OPAQUE"===d){if(h.blend)continue;var l=ca.find_subs(c,"SHADOW_CAST")&&h.shadow_receive?"SHADOW_SRC_MASK":"SHADOW_SRC_NONE"}else if("BLEND"===d||"XRAY"===d){if(!h.blend)continue;if("XRAY"==d!=h.xray)continue;if(ca.find_subs(c,"SHADOW_CAST")&&h.shadow_receive)switch(na.shadows){case "DEPTH":l="SHADOW_SRC_DEPTH";break;default:throw"Wrong shadows type";}else l="SHADOW_SRC_NONE"}else throw"Wrong main subscene type";"NODES"==h.type&&h.anim_mat_values&&
(b._render.all_mats_anim_values.push(h.anim_mat_values),b._render.all_mats_anim_inds.push(h.anim_node_val_indices));var H=h.shaders_info,p=e._render.shadow_params;ma.set_directive(H,"SHADOW_SRC",l);F.assign_shadow_receive_dirs(h,p);ma.set_directive(H,"NUM_LIGHTS",a.num_lights);"special_skydome.glslf"==ma.get_fname(H)&&ma.set_directive(H,"REFLECTION_PASS",0);ma.set_directive(H,"SSAO_ONLY",0);a.water_params&&a.water_fog_color_density?ma.set_directive(H,"WATER_EFFECTS",1):ma.set_directive(H,"WATER_EFFECTS",
0);a.water_params&&a.caustics&&f.caustics?(ma.set_directive(H,"CAUSTICS",1),ma.set_directive(H,"CAUST_SCALE",a.caust_scale),ma.set_directive(H,"CAUST_SPEED",ma.glsl_value(a.caust_speed,2)),ma.set_directive(H,"CAUST_BRIGHT",a.caust_brightness)):ma.set_directive(H,"CAUSTICS",0);a.water_params&&(ma.set_directive(H,"WAVES_HEIGHT",ma.glsl_value(a.water_waves_height)),ma.set_directive(H,"WAVES_LENGTH",ma.glsl_value(a.water_waves_length)),ma.set_directive(H,"WATER_LEVEL",ma.glsl_value(a.water_level)));h.reflective&&
ca.find_subs(c,"MAIN_REFLECT")&&-1===h.texture_names.indexOf("u_mirrormap")?ma.set_directive(H,"REFLECTIVE",1):ma.set_directive(H,"REFLECTIVE",0);if(p=ca.find_subs(c,"SKY"))if(h.procedural_sky){var n=p.camera.color_attachment;F.append_texture(h,n,"u_sky")}else na.procedural_fog?(h.cube_fog=p.cube_fog,ma.set_directive(H,"PROCEDURAL_FOG",1)):ma.set_directive(H,"PROCEDURAL_FOG",0);else ma.set_directive(H,"PROCEDURAL_FOG",0);if("SKY_TEXTURE"==e.world.light_settings.environment_color){n=null;if(e._render.sky_params.procedural_skydome&&
e.world.b4w_sky_settings.use_as_environment_lighting)n=p.camera.color_attachment;else for(g=0;g<a.sky_texture_slots.length;g++)if(a.sky_texture_slots[g].texture.b4w_use_as_environment_lighting){n=F.get_batch_texture(a.sky_texture_slots[g],!1);break}n?(ma.set_directive(H,"SKY_TEXTURE",1),F.append_texture(h,n,"u_sky_texture")):ja.warn("B4W Warning: environment lighting is set to 'Sky Texture', but there is no world texture with environment map")}h.dynamic_grass&&(p=ca.find_subs(c,"GRASS_MAP"))&&C(h,
p,f);h.refractive?"NODES"==h.type?(ma.set_directive(H,"REFRACTIVE",1),e._render.refractions?ma.set_directive(H,"USE_REFRACTION",1):ma.set_directive(H,"USE_REFRACTION",0)):e._render.refractions?ma.set_directive(H,"REFRACTIVE",1):ma.set_directive(H,"REFRACTIVE",0):(ma.set_directive(H,"REFRACTIVE",0),ma.set_directive(H,"USE_REFRACTION",0));h.water&&(h.water_shore_smoothing&&ca.find_subs(c,"DEPTH")?ma.set_directive(H,"SHORE_SMOOTHING",1):ma.set_directive(H,"SHORE_SMOOTHING",0),h.water_dynamic&&a.water_params&&
a.water_waves_height?ma.set_directive(H,"DYNAMIC",1):ma.set_directive(H,"DYNAMIC",0));"PARTICLES"==h.type&&(ma.set_directive(H,"SIZE_RAMP_LENGTH",h.p_size_ramp_length),ma.set_directive(H,"COLOR_RAMP_LENGTH",h.p_color_ramp_length));for(var p=h.textures,I=0;I<p.length;I++){var n=p[I],t=n.offscreen_scene;if(t){var D=t._render.graph,v=null,ia=null;ka.traverse_edges(D,function(a,b,c){if("SCREEN"==c.from)return v=ka.get_node_attr(D,a),ia=c,!0});if(!v||!ia)throw"Failed to assign RTT";R.set_filters(n,R.TF_LINEAR,
R.TF_LINEAR);ia.texture=n;var r=v.camera;r.color_attachment=n;r.framebuffer=oa.render_target_create(n,null);Q(t,n.source_size,n.source_size,!0);n=ca.create_rendering_queue(D);for(r=n.length-1;0<=r;r--){var fa=n[r],L=fa.camera;ea.set_projection(L,1);"MAIN_OPAQUE"==a.type&&L.type==ea.TYPE_PERSP&&ea.update_camera_shadows(L,t._render.shadow_params);e._render.queue.unshift(fa)}}}if(h.lamp_uuid_indexes){var p=0,z;for(z in h.lamp_uuid_indexes)p++;ma.set_directive(H,"NUM_LAMP_LIGHTS",p);h.lamp_light_positions=
new Float32Array(3*p);h.lamp_light_directions=new Float32Array(3*p);h.lamp_light_color_intensities=new Float32Array(3*p);h.lamp_light_factors=new Float32Array(4*p);for(I=0;I<e._objects.LAMP.length;I++)y(h,e._objects.LAMP[I])}x(c,a,l);F.update_shader(h);l={do_render:!0,obj_render:f,batch:h};m(h);a.bundles.push(l);k(c,a,h);s(h)}}a.bundles.sort(function(a,b){var c;if(a.batch&&b.batch){c=a.batch.blend;var d=b.batch.blend;(c=c==d?0:c>d?1:-1)||(c=a.batch.offset_z,d=b.batch.offset_z,c=c==d?0:c>d?1:-1)}else c=
0;return c})}function y(a,b){var c=b.uuid;if(c in a.lamp_uuid_indexes){c=a.lamp_uuid_indexes[c];a.lamp_light_positions.set(b._render.trans,3*c);a.lamp_light_directions.set(b._light.direction,3*c);a.lamp_light_color_intensities.set(b._light.color_intensity,3*c);var d=vb;S(b._light,ic,d);a.lamp_light_factors.set(d,4*c)}}function m(a){var b=a.shader.attributes,c=a.bufs_data.pointers,d;for(d in b)if(!c[d])throw'B4W Error: missing data for "'+d+'" attribute';if("MAIN"==a.type||"NODES"==a.type)b=ma.get_varyings_count(a.shader.vshader),
10<b&&("MAIN"==a.type&&ja.warn("B4W Warning: Varying limit exceeded for main shader - "+b+', materials: "'+a.material_names.join(", ")+'"'),"NODES"==a.type&&(d=c=0,a.uv_maps_usage&&(c=ta.get_dict_length(a.uv_maps_usage)),a.vertex_colors_usage&&(d=ta.get_dict_length(a.vertex_colors_usage)),ja.warn("B4W Warning: Varying limit exceeded for node shader - "+b+", uv: "+c+", vc: "+d+', materials: "'+a.material_names.join(", ")+'"')))}function s(a){8<a.textures.length&&ja.warn("B4W Warning: too many textures used - "+
a.textures.length+' (max 8), materials "'+a.material_names.join(", ")+'"')}function x(a,b,c){for(var d=0,e=ca.get_inputs(a,b),f=0;f<e.length;f++){var w=e[f];"SHADOW_SRC_DEPTH"!=c||"SHADOW_CAST"!=w.type&&"POSTPROCESSING"!=w.type||(w=ca.find_upper_subs(a,w,"SHADOW_CAST").camera,b.v_light_matrix=w.view_matrix,b.b_light_matrix=new Float32Array([.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1]),b.p_light_matrix=b.p_light_matrix||[],b.p_light_matrix[d]=w.proj_matrix,d++)}}function C(a,b,c){a.grass_map_dim=b.grass_map_dim;
var d=b.grass_map_dim[0],e=b.grass_map_dim[1],f=b.grass_map_dim[2];c=c.bb_local;c=Math.max(c.max_x-c.min_x,c.max_z-c.min_z);f=0==f?c:Math.max(f,c);b.grass_map_dim[2]=f;b=b.camera;ea.set_frustum(b,f/2,-e,-d,f/2);ea.set_projection(b);d=a.grass_size||0;d=0==d?c:Math.max(d,c);a.grass_size=d}function A(a,b){for(var c=a.bundles,d=0;d<c.length;d++){var e=c[d].batch;if(e&&e.id==b.id)return!0}return!1}function f(a){var b=G(a,"MAIN_OPAQUE"),c=!0;ka.traverse(a._render.graph,function(d,e){"SHADOW_CAST"===e.type&&
(E(e,b,e.bundles,a,c),c=!1)})}function E(b,c,d,e,f){if(0!=d.length){var w=b.camera;c=c.camera;var g=K(e,"LAMP",a.DATA_ID_ALL),g=(n(g)||g[0])._render;ea.set_view_trans_quat(w,g.trans,g.quat);aa.copy(c.eye,w.eye);Ya.copy(c.view_matrix,w.shadow_cast_billboard_view_matrix);g=rd;ha.zero_bounding_box(g);for(var h=0;h<d.length;h++){var k=d[h].obj_render;0==h?ha.copy_bb(k.bb_world,g):ha.expand_bounding_box(g,k.bb_world)}d=ha.extract_bb_corners(g,td);ta.positions_multiply_matrix(d,w.view_matrix,d);if(e._render.shadow_params.b4w_enable_csm){e=
aa.copy(c.csm_centers[b.csm_index],Cb);g=Ya.invert(c.view_matrix,wb);ta.positions_multiply_matrix(e,g,e);ta.positions_multiply_matrix(e,w.view_matrix,e);b=c.csm_radii[b.csm_index];if(f)for(rb=0,f=2;f<d.length;f+=3)rb=Math.min(rb,d[f]);f=rd;f.max_x=e[0]+b;f.max_y=e[1]+b;f.max_z=0;f.min_x=e[0]-b;f.min_y=e[1]-b;f.min_z=rb}else{b=f=rd;c=qd;c.set(d);e=Ub/9;d=Ya.identity(wb);Ya.rotate(d,e,ta.AXIS_MZ,d);h=g=-1;for(k=0;10>k;k++){var m=ha.bb_from_coords(c,sd),l=(m.max_x-m.min_x)*(m.max_y-m.min_y);if(-1==g||
l<g)g=l,h=k,ha.copy_bb(m,b);ta.positions_multiply_matrix(c,d,c)}b=h*e;0<b&&(c=Ya.identity(wb),Ya.rotate(c,b,ta.AXIS_MZ,c),Ya.multiply(c,w.view_matrix,w.view_matrix));b=f.max_x-f.min_x;c=f.max_y-f.min_y;b&&c&&(e=Math.abs(b-c)/2,2<b/c?(f.max_y+=e,f.min_y-=e):2<c/b&&(f.max_x+=e,f.min_x-=e));f.max_x+=.005;f.max_y+=.005;f.max_z+=.005;f.min_x-=.005;f.min_y-=.005;f.min_z-=.005}ea.set_frustum_asymmetric(w,f.min_x,f.max_x,f.min_y,f.max_y,-f.max_z,-f.min_z);ea.set_projection(w);ta.extract_frustum_planes(w.view_proj_matrix,
w.frustum_planes)}}function n(a){for(var b=0;b<a.length;b++){var c=a[b];if(c.data.b4w_generate_shadows)return c}return!1}function t(a,b){for(var c=b._render,d=b._batches,e="COLOR_PICKING_XRAY"==a.type,f=0;f<d.length;f++){var w=d[f];if(w.xray==e&&"COLOR_ID"==w.type&&!A(a,w)){F.set_batch_directive(w,"USE_GLOW",0);F.update_shader(w);var g={do_render:!0,obj_render:c,batch:w};m(w);a.bundles.push(g)}}}function M(a){var b=ta.clone_object_nr(a);a.shaders_info=JSON.parse(JSON.stringify(a.shaders_info));return b}
function S(a,b,c){b[0]=1;b[1]=0;b[2]=0;b[3]=a.use_diffuse?1:0;c[0]=-1;c[1]=-1;c[2]=-1;c[3]=a.use_specular?1:0;switch(a.type){case "HEMI":b[0]=.5;b[1]=.5;break;case "POINT":c[2]=a.distance;break;case "SPOT":c[2]=a.distance,b=c[0]=Math.cos(a.spot_size/2),c[1]=a.spot_blend*(1-b)}}function z(a,b){for(var c=L(b,Qa),d=a._light,e=a._render,f=d.index,w=0;w<c.length;w++){var g=c[w];g.light_positions.set(e.trans,3*f);g.light_directions.set(d.direction,3*f);g.light_color_intensities.set(d.color_intensity,3*
f);var h=ic,k=vb;S(d,h,k);switch(d.type){case "SUN":if(g.sun_quaternion.set(e.quat),g.sun_intensity=d.color_intensity,"SKY"===g.type){var m=Cb;m[0]=m[1]=m[2]=1;var l=Math.acos(aa.dot(g.sun_direction,m)),m=Math.acos(aa.dot(d.direction,m));g.need_fog_update=Math.floor(l/.025)!=Math.floor(m/.025)?!0:!1;aa.copy(d.direction,g.sun_direction);B(b,g)}else aa.copy(d.direction,g.sun_direction);case "HEMI":case "POINT":case "SPOT":break;default:ja.error("B4W Warning: unknown light type: "+d.type)}g.light_factors1.set(h,
4*f);g.light_factors2.set(k,4*f);g.need_perm_uniforms_update=!0;for(h=0;h<g.bundles.length;h++)k=g.bundles[h].batch,k.lamp_uuid_indexes&&y(k,a)}}function B(a,b){oa.draw(b);if(b.need_fog_update)for(var c=L(a,["MAIN_OPAQUE","MAIN_BLEND","MAIN_XRAY"]),d=0;d<c.length;d++)for(var e=c[d].bundles,f=0;f<e.length;f++){var w=e[f];w.do_render&&(w=w.batch,F.check_batch_perm_uniform(w,"u_cube_fog")&&oa.update_batch_permanent_uniform(w,"u_cube_fog"))}}function K(b,c,d){if(!b._objects)throw"Access to uninitialized scene";
b=b._objects[c];if(d==a.DATA_ID_ALL)return b;c=[];for(var e=0;e<b.length;e++){var f=b[e];f._render.data_id==d&&c.push(f)}return c}function v(b){var c=[];b=K(b,"MESH",a.DATA_ID_ALL);for(var d=0;d<b.length;d++)for(var e=b[d].data,f=0;f<e.materials.length;f++){var w=e.materials[f];-1==c.indexOf(w)&&c.push(w)}return c}function Q(a,b,c,d){for(var e=a._render,f=a.camera._render.cameras,w=0;w<f.length;w++){var g=f[w];ea.set_projection(g,b/c);e.render_shadows&&ea.update_camera_shadows(g,e.shadow_params)}e.render_shadows&&
(e.need_shadow_update=!0,G(a,"DEPTH").need_perm_uniforms_update=!0,G(a,"MAIN_BLEND").need_perm_uniforms_update=!0);ea.update_camera_transform(a.camera);ca.traverse_slinks(e.graph,function(e,f,w,g){if(d||e.update_dim){g=e.size_mult*b;var h=e.size_mult*c;if(f)for(f=0;f<w.slinks_internal.length;f++)w.slinks_internal[f]==e&&R.resize(e.texture,g,h);else R.is_texture(e.texture)&&R.resize(e.texture,g,h),e=w.camera,e.width=g,e.height=h,"DOF"==w.type&&V(a,{dof_power:w.camera.dof_power,dof_on:w.camera.dof_on}),
O(w,1/b,1/c)}})}function O(a,b,c){a=a.bundles;for(var d=0;d<a.length;d++){var e=a[d].batch;e&&F.set_texel_size(e,b,c)}}function L(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];ka.traverse(a._render.graph,function(a,b){b.type==e&&c.push(b)})}return c}function G(a,b){return ca.find_subs(a._render.graph,b)}function V(a,b){var c=G(a,"DOF");if(!c)return ja.error("DOF is not enabled on scene. Check camera settings"),0;var d=a._render.graph;"boolean"==typeof b.dof_on&&(c.camera.dof_on=parseFloat(b.dof_on));
"number"==typeof b.dof_distance&&(c.camera.dof_distance=b.dof_distance);"number"==typeof b.dof_front&&(c.camera.dof_front=b.dof_front);"number"==typeof b.dof_rear&&(c.camera.dof_rear=b.dof_rear);if("number"==typeof b.dof_power){c.camera.dof_power=b.dof_power;for(var e=ca.find_input(d,c,"POSTPROCESSING"),d=ca.find_input(d,e,"POSTPROCESSING"),e=[e,d],d=0;d<e.length;d++){var f=e[d].bundles[0].batch;f&&(F.set_texel_size_mult(f,c.camera.dof_power),O(e[d],1/c.camera.width,1/c.camera.height))}}c.need_perm_uniforms_update=
!0}function $(a,b){var c=G(Va,"MAIN_OPAQUE");if(!c||!c.water_params)return ja.error("get_water_surface_level() - no water parameters on this scene"),0;var d=c.water_waves_height,e=c.water_waves_length,f=c.water_level,w=c.water_params;if(!d||!w.dynamic)return w.water_level;var g=aa.length(c.wind),h=c.time;g&&(h*=g);var k=Dc;k[0]=20/e*(a-.25*h);k[1]=20/e*(b-.25*h);g=ta.cellular2x2(k);k[0]=17/e*(b+.1*h);k[1]=17/e*(a+.1*h);var k=ta.cellular2x2(k),g=g+k-1,m=w.dst_noise_scale0,k=w.dst_noise_scale1,l=w.dst_noise_freq0,
H=w.dst_noise_freq1,p=Dc;p[0]=m*(a+l*h);p[1]=m*(b+l*h);m=ta.snoise(p);p[0]=k*(b-H*h);p[1]=k*(a-H*h);k=ta.snoise(p);k*=d*m;if(c.use_shoremap)if(H=(a-c.shoremap_center[0])/c.shoremap_size[0],p=(c.shoremap_center[1]+b)/c.shoremap_size[1],H+=.5,p+=.5,1<H||0>H||1<p||0>p)d=k;else var H=ta.get_array_smooth_value(Va._render.shore_distances,c.shoremap_tex_size,H,p),p=w.dir_min_shore_fac,m=w.dir_freq,n=w.dir_noise_scale,I=w.dir_noise_freq,l=w.dir_min_noise_fac,w=w.dst_min_fac,c=e/c.max_shore_dist/Math.PI,n=
[n/e*(a+I*h),n/e*(b+I*h)],e=Math.sqrt(H),d=d*Math.max(H,p)*Math.sin(e/c+m*h)*Math.max(ta.snoise(n),l),h=Math.max(e,w),d=d*(1-h)+k*h,g=g*H;else d=k;return f+(d+.05*g)}function P(a,b,c){b.is_for_glow&&"POSTPROCESSING"==b.type&&c.do_render!=b.do_render&&(b.do_render=c.do_render);c.do_render||"GLOW"!=b.type||(b.draw_glow_flag=0)}function Y(a,b,c,d){var e=ka.get_node_attr(a,b);ea.set_attachment(e.camera,c,d);e.assign_texture=!0;ka.traverse_outputs(a,b,function(b,e,f){f.active&&f.from==c&&ca.check_slink_tex_conn(f)&&
T(a,b,f.to,d)});ka.traverse_inputs(a,b,function(b,e,f){f.active&&f.from==c&&f.from==f.to&&Y(a,b,c,d)})}function T(a,b,c,d){a=ka.get_node_attr(a,b).bundles;for(b=0;b<a.length;b++)F.replace_texture(a[b].batch,d,c)}function X(a){var b=G(a,"GRASS_MAP");if(b){var c=b.camera,d=a.camera._render,e=d.trans;a=Cb;a[0]=0;a[1]=-b.grass_map_dim[2]/2;a[2]=0;aa.transformQuat(a,d.quat,a);a[0]+=e[0];a[1]=0;a[2]+=e[2];b=pd;b[0]=0;b[1]=0;b[2]=0;b[3]=1;ea.set_view_trans_quat(c,a,b)}}function p(a,b){ka.traverse(a,function(c,
d){if("MOTION_BLUR"==d.type){if(!d.slinks_internal[0]||!d.textures_internal[0])throw"Wrong MOTION_BLUR subscene";var e=d.slinks_internal[0],f=d.textures_internal[0];d.textures_internal[0]=d.camera.color_attachment;ka.traverse_outputs(a,c,function(b,c,d){d.active&&T(a,b,d.to,f)});Y(a,c,e.from,f);T(a,c,e.to,d.textures_internal[0]);d.motion_blur_exp=Math.exp(-b/d.mb_factor)}})}function ga(b,c){var d=0,e=b._glow_anim;0==e.time_start&&(e.time_start=c);var f=c-e.time_start;if(e.relapses&&f/e.period>=e.relapses)a.clear_glow_anim(b);
else{f%=e.period;if(f<e.glow_time)switch(e=f/(e.glow_time/5),f=Math.floor(e),f){case 0:d=(e-f)/2;break;case 1:d=(e-f)/2+.5;break;case 2:d=1;break;case 3:d=1-(e-f)/2;break;case 4:d=.5-(e-f)/2}for(e=0;e<b._batches.length;e++)f=b._batches[e],"COLOR_ID"==f.type&&(f.glow_intensity=d)}}function Z(a){ka.traverse(a._render.graph,function(a,b){b.need_perm_uniforms_update=!0})}function N(a){if("WIND"==a.field.type){a=a._render;ta.quat_to_dir(a.quat,ta.AXIS_Y,xb);aa.normalize(xb,xb);aa.scale(xb,a.force_strength,
xb);a=Ta;for(var b=0;b<a.length;b++)for(var c=L(a[b],Tb),d=0;d<c.length;d++)c[d].wind.set(xb)}}var F=q("__batch"),ha=q("__boundings"),ea=q("__camera"),D=q("__config"),I=q("__debug"),ia=q("__geometry"),ka=q("__graph"),qa=q("__hud"),H=q("__objects");q("__particles");var fa=q("__prerender"),w=q("__primitives"),ja=q("__print"),oa=q("__renderer"),ca=q("__scenegraph"),qb=q("__sfx"),ma=q("__shaders"),R=q("__textures"),ta=q("__util"),aa=q("vec3"),Ya=q("mat4"),na=D.defaults,bb=D.animation,Aa="ARMATURE CAMERA EMPTY LAMP MESH SPEAKER".split(" "),
Jb=["ARMATURE","EMPTY","MESH","SPEAKER"],cb="GRASS_MAP SHADOW_CAST MAIN_OPAQUE MAIN_BLEND MAIN_XRAY MAIN_REFLECT COLOR_PICKING COLOR_PICKING_XRAY DEPTH GLOW_MASK WIREFRAME".split(" "),Qa="MAIN_OPAQUE MAIN_BLEND MAIN_XRAY MAIN_REFLECT GOD_RAYS GOD_RAYS_COMBINE SKY LUMINANCE_TRUNCED".split(" "),Kb=["MAIN_OPAQUE","SSAO","MAIN_BLEND","MAIN_XRAY","MAIN_REFLECT"],Tb="SHADOW_CAST MAIN_OPAQUE MAIN_BLEND MAIN_XRAY MAIN_REFLECT COLOR_PICKING COLOR_PICKING_XRAY DEPTH GOD_RAYS GLOW_MASK WIREFRAME".split(" "),
bd=["MAIN_OPAQUE","MAIN_BLEND","MAIN_XRAY","MAIN_REFLECT"],hc=0,Va=null,Ta=[],ob=[],Ua=0,Wa=0,ib=1,Ba=0,db=0,Ub=Math.PI/2;a.GET_OBJECT_BY_NAME=0;a.GET_OBJECT_BY_DUPLI_NAME=1;a.GET_OBJECT_BY_DUPLI_NAME_LIST=2;a.DATA_ID_ALL=-1;var Dc=new Float32Array(2),Cb=new Float32Array(3),ic=new Float32Array(4),vb=new Float32Array(4),pd=new Float32Array(4),wb=new Float32Array(16),td=new Float32Array(24),qd=new Float32Array(24),rd=ha.zero_bounding_box(),sd=ha.zero_bounding_box(),xb=new Float32Array(3),rb=null;a.set_active=
function(a){Va=a;qb.set_active_scene(a)};a.prepare_rendering=function(a){var b=a._render;if(!a._render_to_texture){for(var c=ca.create_rendering_queue(b.graph),d=0;d<c.length;d++)b.queue.push(c[d]);Q(a,Ua,Wa,!1)}a=L(a,Tb);for(c=0;c<a.length;c++)a[c].wind.set(xb);for(d=0;d<b.queue.length;d++)"SHADOW_CAST"==b.queue[d].type&&oa.draw(b.queue[d])};a.get_active=r;a.check_active=c;a.get_camera=function(a){return a.camera};a.get_all_scenes=function(){return Ta};a.get_object=function(b,c,e,f){for(var w=Ta,
g=null,h="",k=0;k<w.length;k++){var m=K(w[k],"ALL",a.DATA_ID_ALL);switch(b){case a.GET_OBJECT_BY_NAME:h=c;g=d(c,m,!1,e);break;case a.GET_OBJECT_BY_DUPLI_NAME:var g=h=e,l=f,H=null;(m=d(c,m,!1,l))&&m.dupli_group&&(H=d(g,m.dupli_group.objects,!0,l));g=H;break;case a.GET_OBJECT_BY_DUPLI_NAME_LIST:for(var h=c[c.length-1],g=c,l=e,H=null,p=0;p<g.length;p++)if((H=d(g[p],m,0!=p,l))&&H.dupli_group)m=H.dupli_group.objects;else break;g=H}if(g)break}g||ja.warn("get object "+h+": not found");return g};a.append_to_existed_scene=
function(a,c,d){for(var e in Jb){var f=Jb[e],w=b(a,f),g=c._render.video_textures,h=!1;for(e=0;e<d.length;e++)if(h=!0,d[e]._render&&d[e]._render.is_movie){for(var k=0;k<g.length;k++)g[k]==d[e]&&(h=!1);h&&g.push(d[e])}f in c._objects||(c._objects[f]=[]);for(k=0;k<w.length;k++)ta.is_armature(w[k])&&w[k].proxy||(c._objects.ALL.push(w[k]),c._objects[f].push(w[k]))}};a.append_scene=function(c,d){c._objects={ALL:[]};for(var f in Aa){var w=Aa[f],g=b(c,w);c._objects[w]=[];for(var k=0;k<g.length;k++)ta.is_armature(g[k])&&
g[k].proxy||(c._objects.ALL.push(g[k]),c._objects[w].push(g[k]))}c._render=c._render||{};w=c._render;g=c.camera._render;f=c.world.b4w_shadow_settings;k=w.shadow_params={};k.csm_resolution=f.csm_resolution;k.self_shadow_polygon_offset=f.self_shadow_polygon_offset;k.self_shadow_normal_offset=f.self_shadow_normal_offset;k.b4w_enable_csm=f.b4w_enable_csm;k.b4w_enable_csm?(k.csm_num=f.csm_num,k.csm_first_cascade_border=f.csm_first_cascade_border,k.first_cascade_blur_radius=f.first_cascade_blur_radius,
k.csm_last_cascade_border=f.csm_last_cascade_border,k.last_cascade_blur_radius=f.last_cascade_blur_radius,k.fade_last_cascade=f.fade_last_cascade,k.blend_between_cascades=f.blend_between_cascades):(k.csm_num=1,k.csm_first_cascade_border=f.csm_first_cascade_border,k.first_cascade_blur_radius=f.first_cascade_blur_radius,k.csm_last_cascade_border=f.csm_last_cascade_border,k.last_cascade_blur_radius=f.last_cascade_blur_radius,k.fade_last_cascade=!1,k.blend_between_cascades=!1);w.video_textures=[];for(f=
0;f<d.length;f++)d[f]._render&&d[f]._render.is_movie&&w.video_textures.push(d[f]);f=c.world.b4w_fog_color;w.fog_color_density=new Float32Array([f[0],f[1],f[2],c.world.b4w_fog_density]);a:{if(c._objects)for(f=c._objects.LAMP,k=0;k<f.length;k++)if("SUN"==f[k]._light.type){f=!0;break a}f=!1}w.sun_exist=f;f=w.sun_exist;var k={},m=c.world.b4w_sky_settings;k.procedural_skydome=m.procedural_skydome&&f;k.use_as_environment_lighting=m.use_as_environment_lighting;k.sky_color=m.color;k.rayleigh_brightness=m.rayleigh_brightness;
k.mie_brightness=m.mie_brightness;k.spot_brightness=m.spot_brightness;k.scatter_strength=m.scatter_strength;k.rayleigh_strength=m.rayleigh_strength;k.mie_strength=m.mie_strength;k.rayleigh_collection_power=m.rayleigh_collection_power;k.mie_collection_power=m.mie_collection_power;k.mie_distribution=m.mie_distribution;!f&&m.procedural_skydome&&ja.warn("B4W Warning: There is no sun on the scene. Procedural sky won't be rendered");w.sky_params=k;var l=c.world;f=[0,0,0];var k=[0,0,0],m=l.light_settings,
H=l.texture_slots;if(m.use_environment_light)if("SKY_COLOR"==m.environment_color||"SKY_TEXTURE"==m.environment_color)f=l.horizon_color.slice(0),k=l.zenith_color.slice(0);else if("PLAIN"==m.environment_color)f=[1,1,1],k=[1,1,1];else throw"Unsupported world environment color"+m.environment_color;l={};l.environment_energy=m.environment_energy;l.horizon_color=f;l.zenith_color=k;l.sky_texture_slots=H;w.world_light_set=l;w.lamps_number=K(c,"LAMP",a.DATA_ID_ALL).length;f=v(c);k=[];m=K(c,"MESH",a.DATA_ID_ALL);
for(H=0;H<f.length;H++){var p=f[H];if(p.b4w_water){for(var l={},n=0;n<m.length;n++)for(var I=m[n],t=I.data.materials,s=0;s<t.length;s++)t[s]==p&&(l.water_level=I.location[1]);if(na.deferred_rendering)for(l.fog_color_density=p.b4w_water_fog_color.slice(0),l.fog_color_density.push(p.b4w_water_fog_density),p.b4w_water_dynamic?(l.dynamic=!0,l.waves_height=p.b4w_waves_height,l.waves_length=p.b4w_waves_length,l.dst_noise_scale0=p.b4w_water_dst_noise_scale0,l.dst_noise_scale1=p.b4w_water_dst_noise_scale1,
l.dst_noise_freq0=p.b4w_water_dst_noise_freq0,l.dst_noise_freq1=p.b4w_water_dst_noise_freq1,l.dir_min_shore_fac=p.b4w_water_dir_min_shore_fac,l.dir_freq=p.b4w_water_dir_freq,l.dir_noise_scale=p.b4w_water_dir_noise_scale,l.dir_noise_freq=p.b4w_water_dir_noise_freq,l.dir_min_noise_fac=p.b4w_water_dir_min_noise_fac,l.dst_min_fac=p.b4w_water_dst_min_fac,l.waves_hor_fac=p.b4w_water_waves_hor_fac):(l.dynamic=!1,l.waves_height=0,l.waves_length=0),l.caustic_scale=null,l.caustic_brightness=null,l.caustic_speed=
new Float32Array(2),l.shoremap_image=null,p=p.texture_slots,n=0;n<p.length;n++)I=p[n].texture,"VORONOI"==I.type&&(l.caustic_scale=I.noise_scale,l.caustic_speed.set([.3,.7]),l.caustic_brightness=I.noise_intensity),!0===I.b4w_shore_dist_map&&(l.shoremap_image=I.image,l.shoremap_tex_size=I.image.size[0],l.shore_boundings=I.b4w_shore_boundings,l.max_shore_dist=I.b4w_max_shore_dist);else l.waves_height=0,l.waves_length=0,l.caustic_scale=null,l.caustic_brightness=null,l.caustic_speed=null,l.fog_color_density=
null,l.dynamic=!1;k.push(l)}}if(0<k.length){l=k[0];if(!l.dynamic)for(H=0;H<k.length;H++)k[H].dynamic&&(l=k[H]);f=l}else f=null;w.water_params=f;w.materials_params=e(c);a:{f=K(c,"MESH",a.DATA_ID_ALL);for(k=0;k<f.length;k++)if(f[k]._render.selectable){f=!0;break a}f=!1}w.color_picking=f||na.force_selectable;a:{f=K(c,"MESH",a.DATA_ID_ALL);for(k=0;k<f.length;k++)for(m=f[k].data.materials,H=0;H<m.length;H++)if(l=m[H],n=l.game_settings.alpha_blend,l.b4w_render_above_all&&"OPAQUE"!=n&&"CLIP"!=n){f=!0;break a}f=
!1}w.xray=f;w.num_lamps_added=0;if(na.deferred_rendering){f=c._render_to_texture;g.cameras[0].type!=ea.TYPE_PERSP&&na.anaglyph_use?(ja.warn("B4W Warning: Anaglyph stereo is disabled for the non-perspective camera"),k=!1):k=na.anaglyph_use;w.anaglyph_use=k;w.render_shadows=h(c);w.fog_color=c.world.b4w_fog_color;a:{if(na.shore_smoothing)for(k=v(c),m=0;m<k.length;m++)if(H=k[m],H.b4w_water&&H.b4w_water_shore_smoothing){k=!0;break a}k=!1}w.shore_smoothing=k;if(na.reflections&&c.b4w_render_reflections)for(k=
[],m=K(c,"MESH",a.DATA_ID_ALL),H=0;H<m.length;H++){if(l=m[H],l.b4w_reflective){b:{l=l.constraints;for(n=0;n<l.length;n++)if(p=l[n],"LOCKED_TRACK"==p.type&&"REFLECTION PLANE"==p.name){n=p.target;break b}n=null}n&&(l=n.location,n=n._render.quat,p=new Float32Array(4),ta.trans_quat_to_plane(l,n,ta.AXIS_Y,p),k.push(p))}}else k=!1;w.refl_planes=k;k={};m=c.world.b4w_bloom_settings;k.blur=m.blur;k.edge_lum=m.edge_lum;k.key=m.key;w.bloom_params=k;k={};m=c.world.b4w_motion_blur_settings;k.mb_decay_threshold=
m.motion_blur_decay_threshold;k.mb_factor=m.motion_blur_factor;w.mb_params=k;k={};m=c.world.b4w_color_correction_settings;k.brightness=m.brightness;k.contrast=m.contrast;k.exposure=m.exposure;k.saturation=m.saturation;w.cc_params=k;k={};m=c.world.b4w_god_rays_settings;k.intensity=m.intensity;k.max_ray_length=m.max_ray_length;k.steps_per_pass=m.steps_per_pass;w.god_rays_params=k;k={};m=c.world;k.glow_color=m.b4w_glow_color;k.glow_factor=m.b4w_glow_factor;w.glow_params=k;w.dof=na.dof&&(0<g.dof_distance||
g.dof_object);a:{if(na.dynamic_grass)for(m=k=!1,H=K(c,"MESH",a.DATA_ID_ALL),l=0;l<H.length;l++){p=H[l];I=p.data.materials;for(n=0;n<I.length;n++)I[n].b4w_terrain&&(k=!0);p=p.particle_systems;for(n=0;n<p.length;n++)I=p[n].settings,"HAIR"==I.type&&I.b4w_dynamic_grass&&(m=!0);if(k&&m){k=!0;break a}}k=!1}w.dynamic_grass=k;w.motion_blur=na.motion_blur&&c.b4w_enable_motion_blur;w.compositing=na.compositing&&c.b4w_enable_color_correction;w.antialiasing=na.antialiasing&&c.b4w_enable_antialiasing;w.bloom=
na.bloom&&c.b4w_enable_bloom&&w.sun_exist;w.ssao=na.ssao&&c.b4w_enable_ssao;k={};m=c.world.b4w_ssao_settings;k.radius_increase=m.radius_increase;k.hemisphere=m.hemisphere;k.blur_depth=m.blur_depth;k.blur_discard_value=m.blur_discard_value;k.influence=m.influence;k.dist_factor=m.dist_factor;k.samples=m.samples;w.ssao_params=k;w.god_rays=na.god_rays&&c.b4w_enable_god_rays&&w.sun_exist;w.refractions=na.refractions&&c.b4w_render_refractions;w.glow=na.glow?w.color_picking:!1;w.graph=ca.create_rendering_graph(f,
w,g)}else w.graph=ca.create_rendering_graph_compat(g,w);w.queue=[];w.need_shadow_update=!1;w.need_grass_map_update=!1;Ta.push(c)};a.combine_scene_objects=b;a.get_graph=function(a){return a._render.graph};a.generate_auxiliary_batches=function(a){ka.traverse(a,function(b,c){var d=null;switch(c.type){case "POSTPROCESSING":d=F.create_postprocessing_batch(c.pp_effect);break;case "SSAO":d=F.create_ssao_batch(c);break;case "SSAO_BLUR":d=F.create_ssao_blur_batch(c);F.set_texel_size(d,1/c.camera.width,1/c.camera.height);
break;case "DEPTH_PACK":d=F.create_depth_pack_batch();break;case "REFRACT":case "SCREEN":d=F.create_postprocessing_batch("NONE");break;case "GOD_RAYS":d=ca.find_input(a,c,"WIREFRAME")||ca.find_input(a,c,"MAIN_BLEND")||ca.find_input(a,c,"GOD_RAYS");d=F.create_god_rays_batch(d.camera.color_attachment,c.pack|0,(c.reflection_plane&&c.water)|0,c.steps_per_pass);break;case "GOD_RAYS_COMBINE":var d=ca.find_input(a,c,"WIREFRAME")||ca.find_input(a,c,"MAIN_BLEND"),e=ca.find_input(a,c,"GOD_RAYS"),d=F.create_god_rays_combine_batch(d.camera.color_attachment,
e.camera.color_attachment);break;case "MOTION_BLUR":d=F.create_motion_blur_batch(c.mb_decay_threshold);break;case "DOF":d=F.create_dof_batch();F.set_texel_size_mult(d,c.camera.dof_power);for(var e=ca.find_input(a,c,"POSTPROCESSING"),f=ca.find_input(a,e,"POSTPROCESSING"),w=[e,f],g=0;g<w.length;g++){var h=w[g].bundles;(e=h[0].batch)&&F.set_texel_size_mult(e,c.camera.dof_power)}break;case "GLOW":w=ca.find_input(a,c,"POSTPROCESSING");g=ca.find_input(a,w,"POSTPROCESSING");e=ca.find_input(a,g,"POSTPROCESSING");
f=ca.find_input(a,e,"POSTPROCESSING");d=F.create_glow_batch();w=[g,w];for(g=0;g<w.length;g++)h=w[g].bundles,(h=h[0].batch)&&F.set_texel_size_mult(h,c.blur_texel_size_mult);w=[f,e];for(g=0;g<w.length;g++)h=w[g].bundles,(h=h[0].batch)&&F.set_texel_size_mult(h,c.ext_texel_size_mult*c.glow_factor);break;case "COMPOSITING":d=F.create_compositing_batch();break;case "ANTIALIASING":d=F.create_antialiasing_batch();break;case "LANCZOS":d=F.create_lanczos_batch(c.lanczos_type);break;case "SMAA_RESOLVE":case "SMAA_EDGE_DETECTION":case "SMAA_BLENDING_WEIGHT_CALCULATION":case "SMAA_NEIGHBORHOOD_BLENDING":d=
F.create_smaa_batch(c.type);break;case "ANAGLYPH":d=F.create_anaglyph_batch();break;case "SKY":d=F.create_sky_batch();F.set_texel_size(d,1/c.camera.width,1/c.camera.height);break;case "LUMINANCE":d=F.create_luminance_batch();break;case "AVERAGE_LUMINANCE":d=F.create_average_luminance_batch();break;case "LUMINANCE_TRUNCED":d=F.create_luminance_trunced_batch();break;case "BLOOM_BLUR":d=F.create_bloom_blur_batch(c.pp_effect);F.set_texel_size(d,1/c.camera.width,1/c.camera.height);break;case "BLOOM":d=
ca.find_input(a,c,"BLOOM_BLUR");w=[ca.find_input(a,d,"BLOOM_BLUR"),d];for(g=0;g<w.length;g++)h=w[g].bundles,(h=h[0].batch)&&F.set_texel_size_mult(h,c.bloom_blur);d=F.create_bloom_combine_batch();break;case "VELOCITY":d=F.create_velocity_batch()}d&&(e={do_render:!0,obj_render:H.create_render("NONE"),batch:d},m(d),c.bundles.push(e),k(a,c,d),s(d))})};a.append_object=function(a,b){switch(b.type){case "MESH":var c=a._render.graph,d=b._render;!ca.find_subs(c,"SHADOW_CAST")&&d.shadow_receive&&(d.shadow_receive=
!1);for(var d=L(a,cb),e=0;e<d.length;e++){var f=d[e],w=b,h=c,l=a;switch(f.type){case "MAIN_OPAQUE":g(f,w,h,"OPAQUE",l);break;case "MAIN_BLEND":g(f,w,h,"BLEND",l);break;case "MAIN_XRAY":g(f,w,h,"XRAY",l);break;case "MAIN_REFLECT":h=w._render;w=w._batches;for(l=0;l<w.length;l++){var H=w[l],p=M(H);if(!("MAIN"!=p.type&&"NODES"!=p.type&&"PARTICLES"!=p.type||A(f,p)||p.blend)&&p.reflexible){var n=p.shaders_info;ma.set_directive(n,"DISABLE_FOG",0);ma.set_directive(n,"WATER_EFFECTS",0);"special_skydome.glslf"==
ma.get_fname(n)&&ma.set_directive(n,"REFLECTION_PASS",1);ma.set_directive(n,"SHADOW_SRC","SHADOW_SRC_NONE");ma.set_directive(n,"TEXTURE_NORM",0);F.update_shader(p);n={do_render:!0,obj_render:h,batch:p};m(p);f.bundles.push(n);"MAIN"==p.type&&(H.childs||(H.childs=[]),H.childs.push(p))}}break;case "DEPTH":H=w._render;w=w._batches;for(p=0;p<w.length;p++){var I=w[p];if("DEPTH"==I.type&&!A(f,I)&&!I.shadow_cast_only){if(ca.has_upper_subs(h,f,"SHADOW_CAST"))if(I.shadow_receive){switch(na.shadows){case "DEPTH":var n=
"SHADOW_SRC_DEPTH",ja="SHADOW_DST_MASK";break;default:throw"Wrong shadows type";}I=F.update_batch_shadow_src_dst(I,n,ja);F.assign_shadow_receive_dirs(I,l._render.shadow_params);ca.get_inputs(h,f);x(h,f,n)}else I=F.update_batch_shadow_src_dst(I,"SHADOW_SRC_NONE","SHADOW_DST_MASK");else I=F.update_batch_shadow_src_dst(I,"SHADOW_SRC_NONE","SHADOW_DST_NONE");I.dynamic_grass&&(n=ca.find_subs(h,"GRASS_MAP"))&&C(I,n,H);F.update_shader(I);n={do_render:!0,obj_render:H,batch:I};m(I);f.bundles.push(n);k(h,f,
I);s(I)}}break;case "SHADOW_CAST":H=!1;p=w._render;w=w._batches;for(n=0;n<w.length;n++)if(I=w[n],I.shadow_cast||I.shadow_receive)if(H=!0,"DEPTH"==I.type&&!A(f,I)&&I.shadow_cast){switch(na.shadows){case "DEPTH":ja="SHADOW_DST_DEPTH";break;default:throw"Wrong shadows type";}I=F.create_shadow_batch_form_depth(I,"SHADOW_SRC_NONE",ja);I.dynamic_grass&&(ja=ca.find_subs(h,"GRASS_MAP"))&&C(I,ja,p);F.set_batch_directive(I,"SHADOW_TEX_RES",ma.glsl_value(l._render.shadow_params.csm_resolution));F.update_shader(I);
ja={do_render:!0,obj_render:p,batch:I};m(I);f.bundles.push(ja)}H&&E(f,ca.find_subs(h,"MAIN_OPAQUE"),f.bundles,l,!0);break;case "COLOR_PICKING":t(f,w);break;case "COLOR_PICKING_XRAY":t(f,w);break;case "GRASS_MAP":h=w._render;w=w._batches;for(l=0;l<w.length;l++)H=w[l],"GRASS_MAP"!=H.type||A(f,H)||(F.update_shader(H),p={do_render:!0,obj_render:h,batch:H},m(H),f.bundles.push(p),H=f.camera,ja=h.bb_world,p=f.grass_map_dim[0],n=f.grass_map_dim[1],I=f.grass_map_dim[2],0==p&&0==n?(p=ja.min_y,n=ja.max_y):(p=
Math.min(p,ja.min_y),n=Math.max(n,ja.max_y)),ja=1E-4*(n-p),f.grass_map_dim[0]=p-ja,f.grass_map_dim[1]=n+ja,ea.set_frustum(H,I/2,-n,-p,I/2),ea.set_projection(H));break;case "GLOW_MASK":h=w._render;w=w._batches;for(l=0;l<w.length;l++)H=w[l],"COLOR_ID"!=H.type||A(f,H)||(p=M(H),F.set_batch_directive(p,"USE_GLOW",1),F.update_shader(p),w.push(p),n={do_render:!0,obj_render:h,batch:p},m(p),f.bundles.push(n),H.childs||(H.childs=[]),H.childs.push(p));break;case "WIREFRAME":for(l=w._render,w=w._batches,H=0;H<
w.length;H++)p=w[H],"WIREFRAME"!=p.type||A(f,p)||(p.dynamic_grass&&(n=ca.find_subs(h,"GRASS_MAP"))&&C(p,n,l),F.update_shader(p),n={do_render:!0,obj_render:l,batch:p},m(p),f.bundles.push(n),k(h,f,p),s(p))}}break;case "LAMP":b._light.index=a._render.num_lamps_added++;c=L(a,Qa);for(d=0;d<c.length;d++)c[d].num_lights++;z(b,a)}};a.has_batch=A;a.schedule_shadow_update=function(a){a._render.need_shadow_update=!0};a.get_csm_borders=function(a,b){for(var c=a._render.shadow_params,d=new Float32Array(c.csm_num),
e=0;e<c.csm_num;e++)d[e]=ea.csm_far_plane(c,b,e);return d};a.hide_object=function(a){a._render.hide=!0};a.show_object=function(a){a._render.hide=!1};a.remove_object_bundles=function(a,b){for(var c=b._render,d=L(a,cb),e=0;e<d.length;e++)for(var f=d[e].bundles,w=f.length-1;0<=w;w--){var g=f[w];g.obj_render==c&&(g.batch&&ia.cleanup_bufs_data(g.batch.bufs_data),f.splice(w,1))}};a.check_object=function(a,b){return b._objects[a.type]&&-1<b._objects[a.type].indexOf(a)?!0:!1};a.sort_lamps=function(a){var b=
a._objects.LAMP;if(b.length==a._render.num_lamps_added){for(var c=[],d=0;d<b.length;d++)c[b[d]._light.index]=d;for(d=0;d<c.length-1;d++)for(var e=d+1;e<c.length;e++){var f;f=b[c[d]]._light;var w=b[c[e]]._light;f=!w.use_diffuse||!w.use_specular||f.use_diffuse&&f.use_specular?!f.use_diffuse&&(w.use_diffuse||!f.use_specular&&w.use_specular)?!0:!1:!0;f&&(f=c[d],c[d]=c[e],c[e]=f)}for(d=0;d<c.length;d++)b[c[d]]._light.index=d,z(b[c[d]],a,!0)}};a.update_lamp_scene=z;a.update_shadow_lamp_id=function(b){var c=
K(b,"LAMP",a.DATA_ID_ALL);if(c=n(c)||c[0]){b=L(b,Qa);for(var d=0;d<b.length;d++)b[d].shadow_lamp_id=c._light.index}};a.cleanup=function(){for(var a=0;a<Ta.length;a++){var b=Ta[a];ka.traverse(b._render.graph,function(a,b){if("SINK"!=b.type){var c=b.camera;oa.render_target_cleanup(c.framebuffer,c.color_attachment,c.depth_attachment,c.width,c.height);for(var c=b.bundles,d=0;d<c.length;d++){var e=c[d].batch;e&&F.clear_batch(e)}}});b._render.graph=[];b._render.queue=[]}Va=null;Ta.length=0;ob.length=0;
xb[0]=0;xb[1]=0;xb[2]=0};a.make_frustum_shot=function(a,b,c){a=ea.extract_frustum_corners(a,a.near,a.far,null,!0);var d=w.generate_frustum(a);a=H.create_render("DYNAMIC");a.bb_world=a.bb_local=ha.big_bounding_box();a.bs_world=a.bs_local=ha.big_bounding_sphere();var e=a.bs_world.radius;a.be_world=a.be_local=ha.create_bounding_ellipsoid([e,0,0],[0,e,0],[0,0,e],a.bs_world.center);c=F.create_shadeless_batch(d,c,.5);b.bundles.push({do_render:!0,obj_render:a,batch:c})};a.get_scene_objs=K;a.get_scene_timeline=
function(a){return[a.frame_start,a.frame_end]};a.setup_dim=function(a,b,c,d,e){Ua=a;Wa=b;ib=c;Ba=e;db=d;Va&&Q(Va,a,b,!1)};a.set_texel_size=O;a.subs_array=L;a.get_subs=G;a.get_environment_colors=function(a){a=L(a,Qa)[0];var b=a.horizon_color,c=a.zenith_color,d=[],e=[];d[0]=b[0];d[1]=b[1];d[2]=b[2];e[0]=c[0];e[1]=c[1];e[2]=c[2];return[a.environment_energy,d,e]};a.set_environment_colors=function(a,b,c,d){a=L(a,Qa);for(var e=0;e<a.length;e++){var f=a[e];isNaN(b)||(f.environment_energy=b);c&&f.horizon_color.set(c);
d&&f.zenith_color.set(d);f.need_perm_uniforms_update=!0}};a.get_sky_params=function(a){if(a=G(a,"SKY")){var b={};b.color=Array(3);aa.copy(a.sky_color,b.color);b.procedural_skydome=a.procedural_skydome;b.use_as_environment_lighting=a.use_as_environment_lighting;b.rayleigh_brightness=a.rayleigh_brightness;b.mie_brightness=a.mie_brightness;b.spot_brightness=a.spot_brightness;b.scatter_strength=a.scatter_strength;b.rayleigh_strength=a.rayleigh_strength;b.mie_strength=a.mie_strength;b.rayleigh_collection_power=
a.rayleigh_collection_power;b.mie_collection_power=a.mie_collection_power;b.mie_distribution=a.mie_distribution;return b}return null};a.set_sky_params=function(a,b){var c=G(a,"SKY");c&&("number"==typeof b.procedural_skydome&&(c.procedural_skydome=b.procedural_skydome),"number"==typeof b.use_as_environment_lighting&&(c.use_as_environment_lighting=b.use_as_environment_lighting),"object"==typeof b.color&&c.sky_color.set(b.color),"number"==typeof b.rayleigh_brightness&&(c.rayleigh_brightness=b.rayleigh_brightness),
"number"==typeof b.mie_brightness&&(c.mie_brightness=b.mie_brightness),"number"==typeof b.spot_brightness&&(c.spot_brightness=b.spot_brightness),"number"==typeof b.scatter_strength&&(c.scatter_strength=b.scatter_strength),"number"==typeof b.rayleigh_strength&&(c.rayleigh_strength=b.rayleigh_strength),"number"==typeof b.mie_strength&&(c.mie_strength=b.mie_strength),"number"==typeof b.rayleigh_collection_power&&(c.rayleigh_collection_power=b.rayleigh_collection_power),"number"==typeof b.mie_collection_power&&
(c.mie_collection_power=b.mie_collection_power),"number"==typeof b.mie_distribution&&(c.mie_distribution=b.mie_distribution),c.need_perm_uniforms_update=!0,c.need_fog_update=!0,B(a,c))};a.get_fog_color_density=function(a,b){var c=b||[],d=L(a,Kb)[0].fog_color_density;c[0]=d[0];c[1]=d[1];c[2]=d[2];c[3]=d[3];return c};a.set_fog_color_density=function(a,b){for(var c=L(a,Kb),d=0;d<c.length;d++){var e=c[d];e.fog_color_density.set(b);e.need_perm_uniforms_update=!0}};a.get_ssao_params=function(a){var b=G(a,
"SSAO");a=G(a,"SSAO_BLUR");if(!b)return null;var c=b.bundles[0].batch,d={};d.ssao_quality=F.get_batch_directive(c,"SSAO_QUALITY")[1];d.ssao_hemisphere=b.ssao_hemisphere;d.ssao_blur_depth=a.ssao_blur_depth;d.blur_discard_value=a.ssao_blur_discard_value;d.radius_increase=b.ssao_radius_increase;d.influence=b.ssao_influence;d.dist_factor=b.ssao_dist_factor;d.ssao_only=b.ssao_only;d.ssao_white=F.get_batch_directive(c,"SSAO_WHITE")[1];return d};a.set_ssao_params=function(a,b){var c=G(a,"SSAO"),d=G(a,"SSAO_BLUR");
if(!c)return ja.error("SSAO is not enabled on scene"),0;if("string"==typeof b.ssao_quality){var e=c.bundles[0].batch;F.set_batch_directive(e,"SSAO_QUALITY",b.ssao_quality);F.update_shader(e,!0)}"number"==typeof b.ssao_hemisphere&&(e=c.bundles[0].batch,F.set_batch_directive(e,"SSAO_HEMISPHERE",b.ssao_hemisphere),F.update_shader(e,!0));"number"==typeof b.ssao_blur_depth&&(e=d.bundles[0].batch,F.set_batch_directive(e,"SSAO_BLUR_DEPTH",b.ssao_blur_depth),F.update_shader(e,!0));"number"==typeof b.ssao_blur_discard_value&&
(d.ssao_blur_discard_value=b.ssao_blur_discard_value);"number"==typeof b.ssao_radius_increase&&(c.ssao_radius_increase=b.ssao_radius_increase);"number"==typeof b.ssao_influence&&(c.ssao_influence=b.ssao_influence);"number"==typeof b.ssao_dist_factor&&(c.ssao_dist_factor=b.ssao_dist_factor);if("number"==typeof b.ssao_only){c=G(a,"MAIN_OPAQUE");c.ssao_only=b.ssao_only;for(var f=0;f<c.bundles.length;f++)e=c.bundles[f].batch,F.set_batch_directive(e,"SSAO_ONLY",b.ssao_only),F.update_shader(e,!0)}"number"==
typeof b.ssao_white&&(e=c.bundles[0].batch,F.set_batch_directive(e,"SSAO_WHITE",b.ssao_white),F.update_shader(e,!0));c.need_perm_uniforms_update=!0;d.need_perm_uniforms_update=!0};a.get_dof_params=function(a){a=G(a,"DOF");if(!a)return null;var b={};b.dof_distance=a.camera.dof_distance;b.dof_front=a.camera.dof_front;b.dof_rear=a.camera.dof_rear;b.dof_power=a.camera.dof_power;return b};a.set_dof_params=V;a.get_god_rays_params=function(a){var b=L(a,["GOD_RAYS"]);a=G(a,"GOD_RAYS_COMBINE");if(!b||!a)return null;
var c={};c.god_rays_max_ray_length=b[0].max_ray_length;c.god_rays_intensity=a.god_rays_intensity;c.god_rays_steps=F.get_batch_directive(b[0].bundles[0].batch,"STEPS_PER_PASS")[1];return c};a.set_god_rays_params=function(a,b){var c=L(a,["GOD_RAYS"]),d=G(a,"GOD_RAYS_COMBINE");if(!c||!d)return ja.error("God Rays are not enabled on scene"),0;"number"==typeof b.god_rays_intensity&&(d.god_rays_intensity=b.god_rays_intensity);if("number"==typeof b.god_rays_max_ray_length)for(var e=b.god_rays_max_ray_length,
f=0;f<c.length;f++)c[f].max_ray_length=e,c[f].radial_blur_step=e/c[f].steps_per_pass/(f+1),c[f].need_perm_uniforms_update=!0;if("number"==typeof b.god_rays_steps)for(var w=ma.glsl_value(b.god_rays_steps,1),e=c[0].max_ray_length,f=0;f<c.length;f++){c[f].steps_per_pass=w;c[f].radial_blur_step=e/w/(f+1);c[f].need_perm_uniforms_update=!0;var g=c[f].bundles[0].batch;F.set_batch_directive(g,"STEPS_PER_PASS",w);F.update_shader(g,!0)}d.need_perm_uniforms_update=!0};a.get_bloom_params=function(a){var b=G(a,
["LUMINANCE_TRUNCED"]);a=G(a,"BLOOM");if(!b||!a)return null;var c={};c.bloom_key=b.bloom_key;c.bloom_edge_lum=b.bloom_edge_lum;c.bloom_blur=a.bloom_blur;return c};a.set_bloom_params=function(a,b){var c=G(a,"LUMINANCE_TRUNCED"),d=G(a,"BLOOM");if(!c||!d)return ja.error("Bloom is not enabled on scene"),0;"number"==typeof b.bloom_key&&(c.bloom_key=b.bloom_key,c.need_perm_uniforms_update=!0);"number"==typeof b.bloom_edge_lum&&(c.bloom_edge_lum=b.bloom_edge_lum,c.need_perm_uniforms_update=!0);if("number"==
typeof b.bloom_blur)for(var e=a._render.graph,c=ca.find_input(e,d,"BLOOM_BLUR"),e=ca.find_input(e,c,"BLOOM_BLUR"),c=[c,e],e=0;e<c.length;e++){var f=c[e].bundles[0].batch;f&&(F.set_texel_size_mult(f,b.bloom_blur),O(c[e],1/d.camera.width,1/d.camera.height))}};a.get_wind_params=function(){var a=xb,b=aa.length(a);if(0==b)return null;var a=180*Math.atan(a[0]/a[2])/Math.PI,c={};c.wind_dir=a;c.wind_strength=b;return c};a.set_wind_params=function(b,c){for(var d=K(b,"ALL",a.DATA_ID_ALL),e=0;e<d.length;e++){var f=
d[e];if("EMPTY"===f.type&&f.field&&"WIND"===f.field.type)var w=f}if(!w)return ja.error("There is no wind on the scene"),0;d=w._render;"number"==typeof c.wind_dir&&(Cb=[0,c.wind_dir/180*Math.PI,-Math.PI/2],ta.euler_to_quat(Cb,pd),d.quat.set(pd),N(w));"number"==typeof c.wind_strength&&(d.force_strength=c.wind_strength,N(w));Z(b)};a.schedule_grass_map_update=function(a){a._render.need_grass_map_update=!0};a.get_water_surface_level=$;a.get_water_mat_params=function(a,b){var c=G(a,"MAIN_OPAQUE");if(c&&
(b.waves_height=c.water_waves_height,b.waves_length=c.water_waves_length,c.water_fog_color_density)){b.water_fog_density=c.water_fog_color_density[3];var d=b.water_fog_color=[];d[0]=c.water_fog_color_density[0];d[1]=c.water_fog_color_density[1];d[2]=c.water_fog_color_density[2]}};a.set_water_params=function(a,b){var c=G(a,"MAIN_OPAQUE");if(!c||!c.water_params)return ja.error("set_water_params() - no water parameters on this scene"),null;c=c.water_params;"number"==typeof b.dst_noise_scale0&&(c.dst_noise_scale0=
b.dst_noise_scale0);"number"==typeof b.dst_noise_scale1&&(c.dst_noise_scale1=b.dst_noise_scale1);"number"==typeof b.dst_noise_freq0&&(c.dst_noise_freq0=b.dst_noise_freq0);"number"==typeof b.dst_noise_freq1&&(c.dst_noise_freq1=b.dst_noise_freq1);"number"==typeof b.dir_min_shore_fac&&(c.dir_min_shore_fac=b.dir_min_shore_fac);"number"==typeof b.dir_freq&&(c.dir_freq=b.dir_freq);"number"==typeof b.dir_noise_scale&&(c.dir_noise_scale=b.dir_noise_scale);"number"==typeof b.dir_noise_freq&&(c.dir_noise_freq=
b.dir_noise_freq);"number"==typeof b.dir_min_noise_fac&&(c.dir_min_noise_fac=b.dir_min_noise_fac);"number"==typeof b.dst_min_fac&&(c.dst_min_fac=b.dst_min_fac);"number"==typeof b.waves_hor_fac&&(c.waves_hor_fac=b.waves_hor_fac);"number"==typeof b.water_dynamic&&(c.dynamic=b.water_dynamic);for(var d=L(a,bd),e=0;e<d.length;e++){var f=d[e];"number"==typeof b.water_fog_density&&c.fog_color_density&&(f.water_fog_color_density[3]=b.water_fog_density);"object"==typeof b.water_fog_color&&c.fog_color_density&&
f.water_fog_color_density.set(b.water_fog_color);"number"==typeof b.waves_height&&(f.water_waves_height=b.waves_height);"number"==typeof b.waves_length&&(f.water_waves_length=b.waves_length);f.need_perm_uniforms_update=!0}};a.get_shore_dist=function(a,b){var c=G(Va,"MAIN_OPAQUE");if(!c.use_shoremap)return 100;var d=c.max_shore_dist,e=c.water_level,f=(a[0]-c.shoremap_center[0])/c.shoremap_size[0],w=(c.shoremap_center[1]+a[2])/c.shoremap_size[1],f=f+.5,w=w+.5;if(1<f||0>f||1<w||0>w)e=1;else return c=
d*ta.get_array_smooth_value(Va._render.shore_distances,c.shoremap_tex_size,f,w),e=(e-a[1])*b,e=Math.sqrt(c*c+e*e)};a.update=function(a,b){for(var c=r().camera._render,d=0;d<Ta.length;d++){var e=Ta[d],w=e._render.graph;if(e._render.water_params)var g=c.trans[1]-$(c.trans[0],c.trans[2]);for(var h=e._render.video_textures,k=0;k<h.length;k++){var l=h[k]._render,m=l.video_file,H=l.frame_duration+l.frame_offset;if(m){var n=Math.round(m.currentTime*l.fps),I=l.frame_offset/l.fps;if(n<l.frame_offset-(na.is_mobile_device?
5:0)||h[k]._render.use_cyclic&&n>H)m.currentTime=I;!l.use_cyclic&&n>H&&m.pause();2<=m.readyState&&!m.paused&&R.update_video_texture(l)}else if(l.seq_video){m=Math.min(l.seq_video.length,l.frame_duration+l.frame_offset);if(l.seq_cur_frame<l.frame_offset||l.use_cyclic&&l.seq_cur_frame>=m)l.seq_cur_frame=l.frame_offset;!l.use_cyclic&&l.seq_cur_frame>=m&&(l.seq_video_played=!1);m=Math.round(a*bb.framerate/l.fps)*l.seq_fps;m!=hc&&l.seq_video_played&&(R.update_seq_video_texture(l),l.seq_cur_frame++);hc=
m}}ka.traverse(w,function(b,c){-1<Tb.indexOf(c.type)&&(c.time=a);-1<bd.indexOf(c.type)&&e._render.water_params&&(c.cam_water_depth=g)})}if(na.deferred_rendering)for(d=0;d<ob.length;d++)ga(ob[d],a);for(d=0;d<Ta.length;d++)if(e=Ta[d],c=e._render,w=c.queue,c.need_shadow_update&&(f(e),c.need_shadow_update=!1),c.need_grass_map_update&&(X(e),c.need_grass_map_update=!1),w.length){e.b4w_enable_motion_blur&&p(c.graph,b);if(na.deferred_rendering&&c.glow){for(var h=G(e,"GLOW_MASK").bundles,t=0,k=0;k<h.length;k++)t+=
h[k].batch.glow_intensity;ka.traverse(e._render.graph,function(a,b){"GLOW"===b.type&&(b.draw_glow_flag=t)})}h=null;for(k=0;k<w.length;k++)"GLOW_MASK"==w[k].type&&(h=k);for(k=0;k<w.length;k++)l=w[k],fa.prerender_subs(l),null!==h&&P(c.graph,l,w[h]),oa.draw(l)}na.show_hud_debug_info&&qa.show_debug_info(Ta,b)};a.get_all_subscenes=function(a){var b=[];ka.traverse(a._render.graph,function(a,c){b.push(c)});return b};a.apply_glow_anim=function(a,b,c,d){a._glow_anim={time_start:0,glow_time:b,period:c,relapses:d};
-1==ob.indexOf(a)&&ob.push(a)};a.clear_glow_anim=function(a){if(a._batches)for(var b=0;b<a._batches.length;b++){var c=a._batches[b];"COLOR_ID"==c.type&&(c.glow_intensity=0)}a=ob.indexOf(a);-1!=a&&ob.splice(a,1)};a.cleanup_glow_anim=function(){ob=[]};a.get_cam_water_depth=function(){var a=G(Va,"MAIN_BLEND"),b=Va;return a||b._render.water_params?a.cam_water_depth:null};a.get_object_data_id=function(a){return a._render.data_id};a.update_scene_permanent_uniforms=Z;a.set_wireframe_mode=function(a,b){switch(b){case "WM_NONE":a.do_render=
!1;break;case "WM_OPAQUE_WIREFRAME":case "WM_TRANSPARENT_WIREFRAME":case "WM_FRONT_BACK_VIEW":case "WM_DEBUG_SPHERES":for(var c=0;c<a.bundles.length;c++)a.bundles[c].batch.wireframe_mode=I.WIREFRAME_MODES[b];a.do_render=!0}a.blend="WM_TRANSPARENT_WIREFRAME"==b;a.need_perm_uniforms_update=!0};a.set_wireframe_edge_color=function(a,b){for(var c=0;c<a.bundles.length;c++)a.bundles[c].batch.wireframe_edge_color=b,a.need_perm_uniforms_update=!0};a.add_meta_objects=function(a,b){for(var c=0;c<b.length;c++)a._objects.ALL.push(b[c]),
a._objects.MESH.push(b[c])};a.update_force=N;a.pick_object=function(b,d){if(!c())return ja.error("No active scene"),null;var e=r(),f=G(e,"COLOR_PICKING");if(f){b-=db;d-=Ba;b*=ib;d*=ib;fa.prerender_subs(f);oa.draw(f,f.bundles);var w=G(e,"COLOR_PICKING_XRAY");w?(fa.prerender_subs(w),oa.draw(w,w.bundles),f=w.camera):f=f.camera;d=f.height-d;f=oa.read_pixels(f.framebuffer,b,d);e=K(e,"MESH",a.DATA_ID_ALL);for(w=0;w<e.length;w++){var g=e[w]._color_id;if(g&&5>Math.abs(255*g[0]-f[0])&&5>Math.abs(255*g[1]-
f[1])&&5>Math.abs(255*g[2]-f[2]))return e[w]}}else ja.error("Color picking is not available");return null};a.get_wind=function(){return xb};a.get_selectable_objects=function(b){var c=[];b=K(b,"MESH",a.DATA_ID_ALL);for(var d=0;d<b.length;d++){var e=b[d];e._render.selectable&&c.push(e)}return c};a.get_meta_tags=function(a){var b={title:"",description:""};a.b4w_tags&&(b.title=a.b4w_tags.title,b.description=a.b4w_tags.description);return b}};b4w.module.__physics=function(a,q){function r(a,b){for(var c=a._descends,d=0;d<c.length;d++)c[d]._render.use_collision_compound&&b.push(c[d]),r(c[d],b);return null}function c(a,b){if(T)switch(a){case B.IN_LOG:S.log(b);break;case B.IN_ERROR:S.error(b);break;case B.IN_FBMSG:z.fbmsg.apply(this,b.slice(1));break;case B.IN_TRANSFORM:var c=d(b.body_id);if(c){var e=b.trans,f=b.quat,g=b.linvel,w=b.angvel,c=c._physics;c.curr_time=b.time;Q.set_sep(e,1,f,c.curr_tsr);G.copy(g,c.linvel);G.copy(w,c.angvel)}break;
case B.IN_PROP_OFFSET:(e=d(b.chassis_hull_body_id))&&Q.set_sep(b.trans,1,b.quat,e._vehicle.prop_offsets[b.prop_ind]);break;case B.IN_FLOATER_BOB_TRANSFORM:if(c=d(b[1]))e=b[4],c=c._floater.bobs[b[2]],v.set_translation(c,b[3]),v.set_rotation(c,e),v.update_transform(c);break;case B.IN_VEHICLE_SPEED:if(c=d(b[1]))c._vehicle.speed=b[2];break;case B.IN_COLLISION:for(var w=T,e=b.body_id_a,c=b.body_id_b,f=b.result,g=b.coll_point,e=parseInt(e),w=w._physics.bundles,h=0;h<w.length;h++)for(var k=w[h].physics,
l=0;l<k.collision_tests.length;l++){for(var m=k.collision_tests[l],p=m.pairs,n=!1,t=0;t<p.length;t++){var s=p[t];if(s[0]===e&&s[1]===c){m.pair_results[t]=f;n=!0;break}}if(n){p=m.pair_results;for(t=n=0;t<p.length;t++)n=n||p[t];m.callback(n,g)}}break;case B.IN_COLLISION_IMPULSE:if(c=d(b[1]))c=c._physics,c.col_imp_test_cb&&c.col_imp_test_cb(b[2]);break;case B.IN_RAY_HIT:if(c=d(b.body_id))for(c=c._physics,f=b.from,g=b.to,w=b.local,h=b.body_id_b_hit,k=b.cur_result,l=0;l<c.ray_tests.length;l++)if(p=c.ray_tests[l],
O.cmp_arr_float(p.from,f,1E-7)&&O.cmp_arr_float(p.to,g,1E-7)&&p.local==w){for(e in p.results)p.results[e]=1;-1!=h&&(p.results[h]=k);for(var m=p.collision_id,t=p.callback,p=p.results,n=!1,s=1,D=0;D<T._physics.bundles.length;D++){var x=T._physics.bundles[D].physics;if(("ANY"==m||x.id==m)&&x.body_id in p&&1!==p[x.body_id]){n=!0;s=p[x.body_id];break}}t(n,s)}break;case B.IN_PING:console.log("Physics message ping: ",performance.now()-b[1]);break;default:S.error("Wrong message: "+a)}}function d(a){return p[a]||
null}function b(){ga.body++;return ga.body}function l(a){return{body_id:a,mass:0,is_ghost:!1,simulated:!0,is_vehicle:!1,is_character:!1,is_floater:!1,cons_id:null,id:"",collision_callbacks:{},collision_tests:[],col_imp_test_cb:null,ray_tests:[],curr_time:0,curr_tsr:new Float32Array([0,0,0,1,0,0,0,1]),linvel:new Float32Array(3),angvel:new Float32Array(3),cached_trans:new Float32Array(3),cached_quat:new Float32Array(4)}}function h(a,b){switch(a){case "BOX":var c=b.bb_local;break;case "CYLINDER":c=b.bcyl_local;
break;case "CONE":c=b.bcon_local;break;case "SPHERE":c=b.bs_local;break;case "CAPSULE":c=b.bcap_local}return c}function e(a){if(!a)return null;var b={};"number"===typeof a.min_x&&(b.min_x=a.min_x);"number"===typeof a.min_y&&(b.min_y=a.min_y);"number"===typeof a.min_z&&(b.min_z=a.min_z);"number"===typeof a.max_x&&(b.max_x=a.max_x);"number"===typeof a.max_y&&(b.max_y=a.max_y);"number"===typeof a.max_z&&(b.max_z=a.max_z);"object"===typeof a.center&&(b.center=a.center);"number"===typeof a.radius&&(b.radius=
a.radius);"number"===typeof a.height&&(b.height=a.height);return b}function k(a,b,c,d){var e=a._render.trans,f=b._render.world_matrix,w=new Float32Array(16);$.invert(f,w);f=new Float32Array(3);G.transformMat4(e,w,f);switch(b._vehicle.type){case 10:b=b.b4w_vehicle_settings;a=a._render.bb_local;B.post_msg(B.OUT_ADD_CAR_WHEEL,c,f,b.suspension_rest_length,b.roll_influence,(a.max_y-a.min_y)/2,d);break;case 20:B.post_msg(B.OUT_ADD_BOAT_BOB,c,f,a.synchronize_pos)}}function g(a){return a._physics&&a._physics.cons_id?
!0:!1}function y(a,b,c,d,e,f,w,g,h,k){var l;ga.constraint++;l=ga.constraint.toString(16);B.post_msg(B.OUT_APPEND_CONSTRAINT,l,a,g,b._physics.body_id,c,d,e._physics.body_id,f,w,h,k);b._physics.cons_id=l}function m(a){var b=a._physics;if(b&&(0===b.mass||!0===b.is_ghost||!1===b.simulated||"RIGID_BODY"!==b.type&&"DYNAMIC"!==b.type)&&(a._render.trans[0]!=a._physics.cached_trans[0]||a._render.trans[1]!=a._physics.cached_trans[1]||a._render.trans[2]!=a._physics.cached_trans[2]||a._render.quat[0]!=a._physics.cached_quat[0]||
a._render.quat[1]!=a._physics.cached_quat[1]||a._render.quat[2]!=a._physics.cached_quat[2])){a._physics.cached_trans.set(a._render.trans);a._physics.cached_quat.set(a._render.quat);var b=a._physics,c=B.get_msg_cache(B.OUT_SET_TRANSFORM);c.msg_id=B.OUT_SET_TRANSFORM;c.body_id=a._physics.body_id;c.trans=a._render.trans;"DYNAMIC"===b.type?(c.quat=N,V.identity(N)):c.quat=a._render.quat;B.post_msg(B.OUT_SET_TRANSFORM,c)}a=a._descends;for(b=0;b<a.length;b++)m(a[b])}function s(a,b,c,d,e){e=e||new Float32Array(3);
a=a._render.quat;e[0]=b;e[1]=c;e[2]=d;return G.transformQuat(e,a,e)}function x(a,b,c,d){if(!c&&!d)throw"At least one destination required";for(var e=0;e<b._physics.bundles.length;e++){var f=b._physics.bundles[e];if("ANY"==a||f.physics.id==a)f=f.physics.body_id,c&&-1==c.indexOf(f)&&c.push(f),d&&(d[f]=0)}}function C(a,b){B.post_msg(B.OUT_ACTIVATE,a);if(b.length){for(var c={},d=0;d<b.length;d++){var e=b[d],f=O.array_stringify(e.from)+O.array_stringify(e.to)+String(e.local);c[f]=c[f]||{from:e.from,to:e.to,
local:e.local,body_ids:[]};var w=c[f].body_ids,g;for(g in e.results)-1==w.indexOf(g)&&w.push(g)}for(f in c)d=c[f].from,e=c[f].to,g=c[f].local,w=c[f].body_ids,B.post_msg(B.OUT_RAY_TEST,a,d,e,g,w)}else B.post_msg(B.OUT_RAY_TEST,a,null,null,!1,null)}function A(a,b){if(b.steering_wheel){var c=a._physics.body_id,d=b.engine_force*b.force_max,e=b.brake_force*b.brake_max,f=-b.steering*b.steering_max*2*Math.PI/b.steering_ratio;b.inverse_control&&(f*=-1);switch(b.type){case 10:B.post_msg(B.OUT_ACTIVATE,c);
B.post_msg(B.OUT_UPDATE_CAR_CONTROLS,c,d,e,f);break;case 20:B.post_msg(B.OUT_ACTIVATE,c),B.post_msg(B.OUT_UPDATE_BOAT_CONTROLS,c,d,e,f)}}}function f(a){return a.b4w_vehicle&&"CHASSIS"==a.b4w_vehicle_settings.part?!0:!1}function E(a){return a.b4w_vehicle&&"HULL"==a.b4w_vehicle_settings.part?!0:!1}function n(a){return a.b4w_character?!0:!1}function t(a){return a.b4w_floating&&"MAIN_BODY"==a.b4w_floating_settings.part?!0:!1}q("__camera");var M=q("__config");q("__constraints");var S=q("__print"),z=q("__debug"),
B=q("__ipc");q("__renderer");var K=q("__scenes"),v=q("__transform"),Q=q("__tsr"),O=q("__util"),L=q("__version"),G=q("vec3"),V=q("quat"),$=q("mat4"),P=M.physics,Y=M.defaults,T=null,X=[],p=[],ga={world:0,body:0,constraint:0,shape:0},Z=new Float32Array(3),N=new Float32Array(4),F=new Float32Array(4),ha=new Float32Array(16),ea=new Float32Array(8),D=new Float32Array(8);a.init_engine=function(a){if(P.enabled){var b=P.uranium_path+L.timestamp();S.log("%cLOAD PHYSICS","color: #0a0",b,"Max FPS: "+P.max_fps);
b=new Worker(b);B.init(b,c);B.post_msg(B.OUT_INIT,a,P.max_fps)}};a.attach_scene_physics=function(a){var b;ga.world++;b=ga.world;B.post_msg(B.OUT_APPEND_WORLD,b);a._physics={};a._physics.world_id=b;a._physics.bundles=[]};a.cleanup=function(){if(P.enabled){B.post_msg(B.OUT_CLEANUP);T=null;X.length=0;p.length=0;for(var a in ga)ga[a]=0}};a.append_object=function(a,c){T=c;B.post_msg(B.OUT_SET_ACTIVE_WORLD,c._physics.world_id);var d=a._render;if(!d)throw"No object render: "+a.name;if(a.parent&&d.use_collision_compound)return null;
var m=[];d.use_collision_compound&&r(a,m);for(var H=a._batches||[],s=0;s<H.length;s++){var w=H[s],ja;if(!(ja="PHYSICS"!=w.type))a:{for(var D=c._physics.bundles,x=0;x<D.length;x++){var v=D[x].batch;if(v&&v.id==w.id){ja=!0;break a}}ja=!1}if(!ja)if(w.submesh.base_length)if(w.water&&c._render.water_params){var C=w;B.post_msg(B.OUT_APPEND_WATER);var L=T,z=K.get_subs(L,"MAIN_OPAQUE");if(z.water_params&&C.water_dynamics){var q={};q.dst_noise_scale0=C.dst_noise_scale0;q.dst_noise_scale1=C.dst_noise_scale1;
q.dst_noise_freq0=C.dst_noise_freq0;q.dst_noise_freq1=C.dst_noise_freq1;q.dir_min_shore_fac=C.dir_min_shore_fac;q.dir_freq=C.dir_freq;q.dir_noise_scale=C.dir_noise_scale;q.dir_noise_freq=C.dir_noise_freq;q.dir_min_noise_fac=C.dir_min_noise_fac;q.dst_min_fac=C.dst_min_fac;q.waves_hor_fac=C.waves_hor_fac;var M=z.water_waves_height,N=z.water_waves_length,P=z.water_level;z.use_shoremap?B.post_msg(B.OUT_ADD_WATER_WRAPPER,q,z.shoremap_size[0],z.shoremap_size[1],z.shoremap_center[0],z.shoremap_center[1],
z.max_shore_dist,M,N,P,z.shoremap_tex_size,L._render.shore_distances):B.post_msg(B.OUT_ADD_WATER_WRAPPER,q,0,0,0,0,0,M,N,P,0,null)}}else{if(w.use_ghost){var Q,ga=a,Z=w,Y=b(),ea=Z.submesh;B.post_msg(B.OUT_APPEND_GHOST_MESH_BODY,Y,ea.va_frames[0].a_position,ea.indices||null,ga._render.trans,Z.collision_group,Z.collision_mask);var Tb=l(Y);Tb.is_ghost=!0;Q=Tb}else{var bd=a,hc=w,Va=b(),Ta=hc.submesh;B.post_msg(B.OUT_APPEND_STATIC_MESH_BODY,Va,Ta.va_frames[0].a_position,Ta.indices||null,bd._render.trans,
hc.friction,hc.elasticity,hc.collision_group,hc.collision_mask);Q=l(Va)}Q.id=w.collision_id;var ob={batch:w,physics:Q};c._physics.bundles.push(ob)}else S.error("Object "+a.name+" has collision material with no assigned vertices")}if(f(a)||E(a)||n(a)||t(a)||a.b4w_collision){var Ua=a,Wa=d.physics_type,ib=Ua._render,Ba=Ua.game,db=b();if("CAMERA"==Ua.type)var Ub=Ba.use_collision_bounds?Ba.collision_bounds_type:"BOX",Dc=h(Ub,ib),Cb=ib.friction,ic=ib.elasticity,Cb=.5,ic=0;else"EMPTY"==Ua.type?(Ub="EMPTY",
Dc=null,ic=Cb=0):(Ub=Ba.use_collision_bounds?Ba.collision_bounds_type:"BOX",Dc=h(Ub,ib),Cb=ib.friction,ic=ib.elasticity);var vb=ib.trans,pd=ib.quat,wb=Ba.use_ghost,td=Ba.use_sleep,qd=Ba.mass,rd=Ba.velocity_min,sd=Ba.velocity_max,xb=Ba.damping,rb=Ba.rotation_damping,Db=Ba.collision_group,rc=Ba.collision_mask,jd=ib.bs_local.radius,Kc=e(Dc),Uc=Ua.b4w_correct_bounding_offset,sc;var cd=Ub;if(m.length){var Ga=[],yb={};yb.quat=new Float32Array([0,0,0,1]);yb.trans=new Float32Array(3);yb.worker_bounding=Kc;
yb.bounding_type=cd;Ga.push(yb);$.invert(ib.world_matrix,ha);V.invert(ib.quat,F);for(var pb=0;pb<m.length;pb++){var ya={},Sa=m[pb],da=Sa.game.collision_bounds_type,Za=new Float32Array(4),Eb=new Float32Array(3);G.transformMat4(Sa._render.trans,ha,Eb);V.multiply(F,Sa._render.quat,Za);ya.trans=Eb;ya.quat=Za;ya.bounding_type=da;ya.worker_bounding=e(h(da,Sa._render));Ga.push(ya)}sc=Ga}else sc=[];B.post_msg(B.OUT_APPEND_BOUNDING_BODY,db,vb,pd,Wa,wb,td,qd,rd,sd,xb,rb,Db,rc,Ub,Kc,jd,Cb,ic,sc,Uc);X.push(Ua);
p[db]=Ua;var ra=l(db);ra.type=Wa;ra.mass=qd;ra.is_ghost=wb;Q=ra;a._physics=Q;ob={batch:null,physics:Q};c._physics.bundles.push(ob)}if(f(a)||E(a)){var Pa=a,jc=Pa._physics.body_id;f(Pa)?(Pa._vehicle.type=10,B.post_msg(B.OUT_APPEND_CAR,jc,Pa._vehicle.suspension_compression,Pa._vehicle.suspension_stiffness,Pa._vehicle.suspension_damping,Pa._vehicle.wheel_friction,Pa._vehicle.max_suspension_travel_cm)):E(Pa)&&(Pa._vehicle.type=20,B.post_msg(B.OUT_APPEND_BOAT,jc,Pa._vehicle.floating_factor,Pa._vehicle.water_lin_damp,
Pa._vehicle.water_rot_damp));if(Pa._vehicle.props){var Ha=Pa._vehicle.props;switch(Pa._vehicle.type){case 10:k(Ha[1],Pa,jc,!0);k(Ha[0],Pa,jc,!0);k(Ha[3],Pa,jc,!1);k(Ha[2],Pa,jc,!1);break;case 20:for(var Ka=0;Ka<Ha.length;Ka++)k(Ha[Ka],Pa,jc,!1)}}Pa._physics.id=Pa.b4w_vehicle_settings.name;A(a,a._vehicle)}else if(n(a)){var eb=a._render,tc=a._physics,sa=eb.bb_local.max_y-eb.bb_local.min_y,Xa=tc.body_id,Oa=a.b4w_character_settings,Ec=Oa.walk_speed,kc=Oa.run_speed,uc=Oa.step_height,vc=Oa.jump_strength,
lb=Oa.waterline,sb=O.dir_ground_proj_angle(a);B.post_msg(B.OUT_APPEND_CHARACTER,Xa,sb,sa,Ec,kc,uc,vc,lb);tc.is_character=!0}else if(t(a)){var Lb=a,Vb=Lb._physics.body_id;B.post_msg(B.OUT_APPEND_FLOATER,Vb,Lb._floater.floating_factor,Lb._floater.water_lin_damp,Lb._floater.water_rot_damp);if(Lb._floater.bobs)for(var tb=Lb._floater.bobs,Wb=0;Wb<tb.length;Wb++){var Mb=tb[Wb],Fa=Mb._render.trans,zb=Lb._render.world_matrix,Nb=new Float32Array(16);$.invert(zb,Nb);var bc=new Float32Array(3);G.transformMat4(Fa,
Nb,bc);B.post_msg(B.OUT_ADD_FLOATER_BOB,Vb,bc,Mb.bob_synchronize_pos)}Lb._physics.is_floater=!0}else a.b4w_collision&&(Q.id=a.b4w_collision_id);for(s=0;s<X.length;s++)if(a=X[s],a._physics){var Fb=a;if(!g(Fb))for(var mb=0;mb<Fb.constraints.length;mb++){var hb=Fb.constraints[mb],J=hb.target,Ia=hb.pivot_type;if("RIGID_BODY_JOINT"==hb.type&&J._physics){var pa=new Float32Array([hb.pivot_x,hb.pivot_y,hb.pivot_z]),fb,wa=new Float32Array([hb.axis_x,hb.axis_y,hb.axis_z]);fb=O.euler_to_quat(wa,new Float32Array(4));
var ba=$.fromRotationTranslation(fb,pa,new Float32Array(16)),La=$.multiply(Fb._render.world_matrix,ba,new Float32Array(16)),ua=$.invert(J._render.world_matrix,new Float32Array(16)),lc=$.multiply(ua,La,ua),cc=O.matrix_to_trans(lc),Xb=O.matrix_to_quat(lc),Ma=hb,xa={};xa.use_limit_x=Ma.use_limit_x;xa.use_limit_y=Ma.use_limit_y;xa.use_limit_z=Ma.use_limit_z;xa.use_angular_limit_x=Ma.use_angular_limit_x;xa.use_angular_limit_y=Ma.use_angular_limit_y;xa.use_angular_limit_z=Ma.use_angular_limit_z;xa.limit_max_x=
Ma.limit_max_x;xa.limit_min_x=Ma.limit_min_x;xa.limit_max_y=Ma.limit_max_y;xa.limit_min_y=Ma.limit_min_y;xa.limit_max_z=Ma.limit_max_z;xa.limit_min_z=Ma.limit_min_z;xa.limit_angle_max_x=Ma.limit_angle_max_x;xa.limit_angle_min_x=Ma.limit_angle_min_x;xa.limit_angle_max_y=Ma.limit_angle_max_y;xa.limit_angle_min_y=Ma.limit_angle_min_y;xa.limit_angle_max_z=Ma.limit_angle_max_z;xa.limit_angle_min_z=Ma.limit_angle_min_z;y(Ia,Fb,pa,fb,J,cc,Xb,xa,null,null)}}}};a.find_obj_by_body_id=d;a.update=function(a,
b){for(var c=0;c<X.length;c++){var d=X[c],e=d._physics;if(e.simulated&&e.curr_time){var f=performance.now()/1E3-e.curr_time,f=Math.min(f,10/60);Y.no_phy_interp_hack&&(f=0);var w=ea;Q.integrate(e.curr_tsr,f,e.linvel,e.angvel,ea);v.set_translation(d,Q.get_trans_view(w));v.set_rotation(d,Q.get_quat_view(w));v.update_transform(d);m(d);if(d._vehicle)for(var e=d,f=e._vehicle.props,w=e._render.tsr,g=ea,h=0;h<f.length;h++){var k=f[h];Q.multiply(w,e._vehicle.prop_offsets[h],g);v.set_tsr(k,g);v.update_transform(k)}d._vehicle&&
d._vehicle.steering_wheel&&(e=d._vehicle,f=e.steering_wheel)&&(w=d._vehicle.steering_wheel_axis,k=ha,g=d._render.trans,h=d._render.quat,O.transform_mat4(d._vehicle.steering_wheel_matrix,1,h,g,k),O.matrix_to_trans(k,f._render.trans),O.matrix_to_quat(k,f._render.quat),k=N,O.transform_vec4(w,1,h,g,k),w=F,V.setAxisAngle(k,-e.steering*e.steering_max*2*Math.PI,w),V.multiply(w,f._render.quat,f._render.quat),v.update_transform(f));d._vehicle&&d._vehicle.speedometer&&(e=d._vehicle,f=e.speedometer)&&(g=d._vehicle.speedometer_axis,
w=ha,h=d._render.trans,k=d._render.quat,O.transform_mat4(d._vehicle.speedometer_matrix,1,k,h,w),O.matrix_to_trans(w,f._render.trans),O.matrix_to_quat(w,f._render.quat),w=N,O.transform_vec4(g,1,k,h,w),g=F,h=Math.abs(e.speed)*e.speed_ratio,h>e.max_speed_angle&&(h=e.max_speed_angle),V.setAxisAngle(w,-h,g),V.multiply(g,f._render.quat,f._render.quat),v.update_transform(f));d._vehicle&&d._vehicle.tachometer&&(e=d._vehicle,f=e.tachometer)&&(w=d._vehicle.tachometer_axis,k=ha,g=d._render.trans,h=d._render.quat,
O.transform_mat4(d._vehicle.tachometer_matrix,1,h,g,k),O.matrix_to_trans(k,f._render.trans),O.matrix_to_quat(k,f._render.quat),d=N,O.transform_vec4(w,1,h,g,d),w=F,V.setAxisAngle(d,-Math.abs(e.engine_force)*e.delta_tach_angle,w),V.multiply(w,f._render.quat,f._render.quat),v.update_transform(f))}}if(c=T)c=K.get_subs(c,"MAIN_OPAQUE"),c.water_params&&0<c.water_params.waves_height&&(d=G.length(c.wind),B.post_msg(B.OUT_SET_WATER_TIME,c.time*d))};a.get_active_scene=function(){return T};a.pause=function(){P.enabled&&
B.post_msg(B.OUT_PAUSE)};a.resume=function(){P.enabled&&B.post_msg(B.OUT_RESUME)};a.enable_simulation=function(a){a=a._physics;if(!a)throw"No object physics";if(!a.simulated){var b=a.body_id;a.simulated=!0;B.post_msg(B.OUT_ENABLE_SIMULATION,b)}};a.disable_simulation=function(a){a=a._physics;if(!a)throw"No object physics";if(a.simulated){var b=a.body_id;a.simulated=!1;B.post_msg(B.OUT_DISABLE_SIMULATION,b)}};a.has_physics=function(a){return a._physics?!0:!1};a.has_dynamic_physics=function(a){return(a=
a._physics)&&a.simulated&&("RIGID_BODY"==a.type||"DYNAMIC"==a.type)&&0<a.mass&&0==a.is_ghost?!0:!1};a.has_simulated_physics=function(a){return(a=a._physics)&&a.simulated?!0:!1};a.set_gravity=function(a,b){B.post_msg(B.OUT_SET_GRAVITY,a._physics.body_id,b)};a.has_constraint=g;a.apply_constraint=y;a.clear_constraint=function(a){a=a._physics;B.post_msg(B.OUT_REMOVE_CONSTRAINT,a.cons_id);a.cons_id=null};a.pull_to_constraint_pivot=function(b,c,d,e,f,g){c=Q.create_sep(c,1,d,ea);f=Q.create_sep(f,1,g,D);
Q.invert(c,c);Q.multiply(f,c,c);v.get_tsr(e,f);Q.multiply(f,c,c);v.set_tsr(b,c);v.update_transform(b);a.set_transform(b,b._render.trans,b._render.quat)};a.set_transform=function(a,b,c){Q.set_sep(a._render.trans,1,a._render.quat,a._physics.curr_tsr);var d=B.get_msg_cache(B.OUT_SET_TRANSFORM);d.msg_id=B.OUT_SET_TRANSFORM;d.body_id=a._physics.body_id;d.trans=b;d.quat=c;B.post_msg(B.OUT_ACTIVATE,a._physics.body_id);B.post_msg(B.OUT_SET_TRANSFORM,d)};a.sync_transform=m;a.apply_velocity=function(a,b,c,
d){s(a,b,c,d,Z);a=a._physics.body_id;B.post_msg(B.OUT_ACTIVATE,a);b=Math.abs(0);c=Math.abs(0);d=Math.abs(0);var e=Math.abs(Z[0]),f=Math.abs(Z[1]),w=Math.abs(Z[2]);Z[0]=e?Z[0]/e*Math.max(e,b):0;Z[1]=f?Z[1]/f*Math.max(f,c):0;Z[2]=w?Z[2]/w*Math.max(w,d):0;B.post_msg(B.OUT_SET_LINEAR_VELOCITY,a,Z[0],Z[1],Z[2])};a.apply_velocity_world=function(a,b,c,d){a=a._physics.body_id;B.post_msg(B.OUT_ACTIVATE,a);B.post_msg(B.OUT_SET_LINEAR_VELOCITY,a,b,c,d)};a.apply_force=function(a,b,c,d){s(a,b,c,d,Z);a=a._physics.body_id;
B.post_msg(B.OUT_ACTIVATE,a);B.post_msg(B.OUT_APPLY_CENTRAL_FORCE,a,Z[0],Z[1],Z[2])};a.apply_torque=function(a,b,c,d){s(a,b,c,d,Z);a=a._physics.body_id;B.post_msg(B.OUT_ACTIVATE,a);B.post_msg(B.OUT_APPLY_TORQUE,a,Z[0],Z[1],Z[2])};a.set_character_move_dir=function(a,b,c){a=a._physics.body_id;B.post_msg(B.OUT_ACTIVATE,a);B.post_msg(B.OUT_SET_CHARACTER_MOVE_DIR,a,b,c)};a.set_character_move_type=function(a,b){B.post_msg(B.OUT_SET_CHARACTER_MOVE_TYPE,a._physics.body_id,b)};a.set_character_walk_velocity=
function(a,b){B.post_msg(B.OUT_SET_CHARACTER_WALK_VELOCITY,a._physics.body_id,b)};a.set_character_run_velocity=function(a,b){B.post_msg(B.OUT_SET_CHARACTER_RUN_VELOCITY,a._physics.body_id,b)};a.set_character_fly_velocity=function(a,b){B.post_msg(B.OUT_SET_CHARACTER_FLY_VELOCITY,a._physics.body_id,b)};a.character_jump=function(a){B.post_msg(B.OUT_CHARACTER_JUMP,a._physics.body_id)};a.character_rotation_inc=function(a,b,c){B.post_msg(B.OUT_CHARACTER_ROTATION_INCREMENT,a._physics.body_id,b,c)};a.set_character_rotation=
function(a,b,c){B.post_msg(B.OUT_SET_CHARACTER_ROTATION,a._physics.body_id,b,c)};a.set_character_rotation_h=function(a,b){B.post_msg(B.OUT_SET_CHARACTER_HOR_ROTATION,a._physics.body_id,b)};a.set_character_rotation_v=function(a,b){B.post_msg(B.OUT_SET_CHARACTER_VERT_ROTATION,a._physics.body_id,b)};a.check_underwater=function(){return!1};a.check_on_surface=function(){return!1};a.check_collision=function(){S.error("check_collision() deprecated");return!1};a.check_collision_any=function(){S.error("check_collision_any() deprecated");
return!1};a.check_ray_hit=function(){S.error("check_ray_hit() deprecated");return!1};a.update_object_coords=function(){S.error("update_object_coords() deprecated")};a.append_collision_test=function(a,b,c,d){var e=a._physics,f=e.body_id;b=b||"ANY";for(var w=0;w<e.collision_tests.length;w++){var g=e.collision_tests[w];if(g.collision_id==b&&g.callback==c)return}w=[];a=a._physics.body_id;g=[];x(b,T,g,null);for(var h=0;h<g.length;h++){var k=g[h];a<k?w.push([a,k]):a>k&&w.push([k,a])}g={collision_id:b,callback:c,
pairs:w,pair_results:new Uint8Array(w.length),need_collision_pt:d||!1};e.collision_tests.push(g);B.post_msg(B.OUT_ACTIVATE,f);B.post_msg(B.OUT_APPEND_COLLISION_TEST,w,d)};a.remove_collision_test=function(a,b,c){a=a._physics;b=b||"ANY";for(var d=0;d<a.collision_tests.length;d++){var e=a.collision_tests[d];if(e.collision_id==b&&e.callback==c){a.collision_tests.splice(d,1);d--;for(var f=T._physics.bundles,e=e.pairs,w=0;w<f.length;w++)for(var g=f[w].physics,h=0;h<g.collision_tests.length;h++)for(var k=
g.collision_tests[h],l=0;l<k.pairs.length;l++)for(var m=k.pairs[l],p=0;p<e.length;p++){var n=e[p];m[0]===n[0]&&m[1]===n[1]&&(e.splice(p,1),p--)}e.length&&B.post_msg(B.OUT_REMOVE_COLLISION_TEST,e)}}};a.apply_collision_impulse_test=function(a,b){var c=a._physics;c?(B.post_msg(B.OUT_APPLY_COLLISION_IMPULSE_TEST,c.body_id),c.col_imp_test_cb=b):S.error("Object "+a.name+" has no physics")};a.clear_collision_impulse_test=function(a){var b=a._physics;b?(B.post_msg(B.OUT_CLEAR_COLLISION_IMPULSE_TEST,b.body_id),
b.col_imp_test_cb=null):S.error("Object "+a.name+" has no physics")};a.append_ray_test=function(a,b,c,d,e,f){var w=a._physics;if(w){a=w.body_id;b=b||"ANY";c={from:new Float32Array(c),to:new Float32Array(d),local:e,callback:f,collision_id:b,results:{}};x(b,T,null,c.results);delete c.results[a];for(var g in c.results)c.results[g]=1;w.ray_tests.push(c);C(a,w.ray_tests)}else S.error("Object "+a.name+" has no physics")};a.remove_ray_test=function(a,b,c,d,e){if(b=a._physics){a=b.body_id;for(var f=0;f<b.ray_tests.length;f++){var w=
b.ray_tests[f];O.cmp_arr_float(w.from,c,1E-7)&&O.cmp_arr_float(w.to,d,1E-7)&&w.local==e&&(b.ray_tests.splice(f,1),f--)}C(a,b.ray_tests)}else S.error("Object "+a.name+" has no physics")};a.vehicle_throttle=function(a,b){var c=a._vehicle;c.engine_force=b;A(a,c)};a.vehicle_steer=function(a,b){var c=a._vehicle;c.steering=b;A(a,c)};a.vehicle_brake=function(a,b){var c=a._vehicle;c.brake_force=b;A(a,c)};a.is_vehicle_chassis=f;a.is_vehicle_hull=E;a.is_car_wheel=function(a){if(!a.b4w_vehicle)return!1;a=a.b4w_vehicle_settings.part;
return"WHEEL_FRONT_LEFT"==a||"WHEEL_FRONT_RIGHT"==a||"WHEEL_BACK_LEFT"==a||"WHEEL_BACK_RIGHT"==a?!0:!1};a.is_boat_bob=function(a){return a.b4w_vehicle?"BOB"==a.b4w_vehicle_settings.part?!0:!1:!1};a.is_floater_bob=function(a){return a.b4w_floating?"BOB"==a.b4w_floating_settings.part?!0:!1:!1};a.is_vehicle_steering_wheel=function(a){return a.b4w_vehicle&&"STEERING_WHEEL"==a.b4w_vehicle_settings.part?!0:!1};a.is_vehicle_speedometer=function(a){return a.b4w_vehicle&&"SPEEDOMETER"==a.b4w_vehicle_settings.part?
!0:!1};a.is_vehicle_tachometer=function(a){return a.b4w_vehicle&&"TACHOMETER"==a.b4w_vehicle_settings.part?!0:!1};a.get_vehicle_speed=function(a){return a._vehicle.speed};a.wheel_index=function(a){switch(a){case "WHEEL_FRONT_LEFT":return 0;case "WHEEL_FRONT_RIGHT":return 1;case "WHEEL_BACK_LEFT":return 2;case "WHEEL_BACK_RIGHT":return 3}};a.is_character=n;a.is_floater_main=t;a.get_fps=function(){return 0};a.debug_worker=function(){B.post_msg(B.OUT_DEBUG)};a.remove_bounding_object=function(a){var b=
X.indexOf(a);-1!=b?(X.splice(b,1),a=p.indexOf(a),-1!=a&&p.splice(a,1)):S.error("Object ",a.name," doesn't have bounding physics")}};b4w.module.__data=function(a,q){function r(a,b){for(var c=Z(a,b.id),d=0;d<c.length;d++){var e=c[d];"MESH"==e.type&&delete e.data.submeshes}Va[b.id]=null;Ta[b.id]=null}function c(a,b,c){var d;a instanceof ArrayBuffer&&(a=ka.get_width_height(a));d=a.width;a=a.height;ca.log("%cLOAD IMAGE "+d+"x"+a,"color: #"+(2048<d||2048<a?"a00":1024<d||1024<a?"aa0":"0a0"),b);-1==b.indexOf(ob)&&c&&ca.warn("B4W Warning: image",b,"is not from app root.")}function d(a,b,c,d,e,f){d=b.filepath;if(!d)throw"Nothing requested";
fa.enqueue([[d,fa.AT_JSON,d]],function(d,f,w,g){if(d){ca.log("%cLOAD METADATA","color: #616",g);f=d.b4w_format_version;if(Number(f)<Qa.min_format_version)throw"Incompatible file version: "+f+". Required: "+Qa.min_format_version;for(var h in d)a[h]=d[h];(d=a.binaries[0].binfile)?b.binary_name=d:(H.skip_stage_by_name(b,"load_binaries"),H.skip_stage_by_name(b,"prepare_bindata"));if(a.b4w_export_errors)for(d=0;d<a.b4w_export_errors.length;d++)ca.error("EXPORT ERROR:",a.b4w_export_errors[d]);if(a.b4w_export_warnings)for(d=
0;d<a.b4w_export_warnings.length;d++)ca.warn("EXPORT WARNING:",a.b4w_export_warnings[d]);e(b,c)}else b.loaded_cb(b.id,!1)},null,function(a){f(b,c,a)})}function b(a,b,c,d,e,f){d=X(b.filepath)+b.binary_name;if(!d)throw"Binary data is missing";fa.enqueue([[d,fa.AT_ARRAYBUFFER,d]],function(d,f,w,g){d&&(ca.log("%cLOAD BINARY","color: #616",g),a.bin_data=d,e(b,c))},null,function(a){f(b,c,a)})}function l(a,b,c,d,e,f){d=a.bin_data;f=a.binaries[0];var w=a.objects,g=a.meshes;a=a.actions;for(var k=Aa.check_endians(),
l=["indices"],m=["normal","tangent"],p=["color","group"],n=["position","texcoord","texcoord2"],H=0;H<g.length;H++)for(var t=g[H].submeshes,s=0;s<t.length;s++)for(var ja in t[s]){var D=t[s][ja][1];if(-1!=l.indexOf(ja)){var x=4*t[s][ja][0]+f["int"],y=t[s],I=ja,v=d;if(k)var r=new Uint32Array(v,x,D);else for(var r=new Uint32Array(D),v=new DataView(v),C=0;C<D;C++)r[C]=v.getUint32(x+4*C,!0);y[I]=r}else if(-1!=n.indexOf(ja))x=4*t[s][ja][0]+f["float"],t[s][ja]=h(d,x,D,k);else if(-1!=m.indexOf(ja)){x=2*t[s][ja][0]+
f["short"];y=t[s];I=ja;v=d;r=new Float32Array(D);v=new DataView(v);for(C=0;C<D;C++)r[C]=v.getInt16(x+2*C,!0)/32767;y[I]=r}else if(-1!=p.indexOf(ja)){x=2*t[s][ja][0]+f.ushort;y=t[s];I=ja;v=d;r=new Float32Array(D);v=new DataView(v);for(C=0;C<D;C++)r[C]=v.getUint16(x+2*C,!0)/65535;y[I]=r}}for(ja=0;ja<w.length;ja++)for(g=w[ja].particle_systems,l=0;l<g.length;l++)m=g[l],m.transforms=h(d,4*m.transforms[0]+f["float"],m.transforms[1],k);for(w=0;w<a.length;w++){ja=a[w];var g=ja.fcurves,m=ja.frame_range,l=
m[0],m=m[1],p=ea.get_approx_curve_length(l,m),n=null,t=H=!1,A;for(A in g)H|=-1<A.indexOf("rotation_euler"),t|=-1<A.indexOf("rotation_quaternion");for(A in g)if(H&&t&&-1<A.indexOf("rotation_euler"))delete g[A];else{var s=g[A],L;for(L in s)D=s[L],x=h(d,f["float"]+4*D.bin_data_pos[0],D.bin_data_pos[1],k),y=new Float32Array(p),null===n&&(n=new Int8Array(p)),ea.approximate_curve(D,x,y,n,l,m),D._pierced_points=y;-1<A.indexOf("rotation_euler")&&ea.fcurves_replace_euler_by_quat(g,A)}ja._bflags=n}e(b,c)}function h(a,
b,c,d){if(d)d=new Float32Array(a,b,c);else{d=new Float32Array(c);a=new DataView(a);for(var e=0;e<c;e++)d[e]=a.getFloat32(b+4*e,!0)}return d}function e(a,b,c,d,e,f){var w=a.cameras,g=a.groups,h=a.materials,k=a.meshes,l=a.node_groups,m=a.objects,p=a.particles,n=a.scenes,H=a.speakers,t=a.textures,D=a.worlds;l||(ca.warn('B4W Warning: "node_groups" datablock undefined. reexport main scene.'),l=a.node_groups=[]);for(var y="actions armatures cameras curves groups images lamps materials meshes node_groups objects particles scenes sounds speakers textures worlds".split(" "),
I={},v=0;v<y.length;v++)for(var r=a[y[v]],C=0;C<r.length;C++){var A=r[C];I[A.uuid]=A}for(var L=0;L<n.length;L++){for(var z=n[L],G=z.objects,q=0;q<G.length;q++)x(G,q,I);z.camera&&x(z,"camera",I);z.world&&x(z,"world",I)}for(L=0;L<g.length;L++)for(var fa=g[L].objects,q=0;q<fa.length;q++)x(fa,q,I);for(L=0;L<m.length;L++){var E=m[L];E.dupli_group&&x(E,"dupli_group",I);E.parent&&x(E,"parent",I);if(E.animation_data){var M=E.animation_data;M.action&&x(M,"action",I);if(M.nla_tracks)for(q=0;q<M.nla_tracks.length;q++)for(var ia=
M.nla_tracks[q],F=0;F<ia.strips.length;F++)ia.strips[F].action&&x(ia.strips[F],"action",I)}switch(E.type){case "MESH":if(!E.data)throw"mesh not found for object "+E.name;x(E,"data",I);for(var V=E.modifiers,q=0;q<V.length;q++){var ma=V[q];"ARMATURE"==ma.type?x(ma,"object",I):"CURVE"==ma.type&&x(ma,"object",I)}var ta=E.particle_systems;if(ta)for(q=0;q<ta.length;q++)x(ta[q],"settings",I);break;case "ARMATURE":x(E,"data",I);for(var qa=E.pose.bones,aa=E.data.bones,q=0;q<qa.length;q++){var O=qa[q];O.bone=
aa[O.bone];for(var T=O.parent_recursive,F=0;F<T.length;F++)T[F]=qa[T[F]]}break;case "LAMP":case "CAMERA":case "SPEAKER":case "CURVE":x(E,"data",I)}var ka=E.constraints;if(ka)for(q=0;q<ka.length;q++){var S=ka[q];S.target&&x(S,"target",I)}var P=E.lod_levels;if(P)for(q=0;q<P.length;q++){var Q=P[q];Q.object&&x(Q,"object",I)}}for(L=0;L<k.length;L++)for(var $=k[L].materials,q=0;q<$.length;q++)x($,q,I);for(L=0;L<h.length;L++){for(var Ya=h[L],X=Ya.texture_slots,q=0;q<X.length;q++)x(X[q],"texture",I);var ga=
Ya.node_tree;ga&&s(ga,I)}for(L=0;L<l.length;L++)(ga=l[L].node_tree)&&s(ga,I);for(L=0;L<t.length;L++){var Y=t[L],bb=Y.type;"IMAGE"!=bb&&"ENVIRONMENT_MAP"!=bb||x(Y,"image",I)}for(L=0;L<w.length;L++){var hc=w[L];hc.dof_object&&x(hc,"dof_object",I)}for(L=0;L<H.length;L++){var Ta=H[L];Ta.sound&&x(Ta,"sound",I);if(Ta.animation_data&&(M=Ta.animation_data,M.action&&x(M,"action",I),M.nla_tracks))for(q=0;q<M.nla_tracks.length;q++)for(ia=M.nla_tracks[q],F=0;F<ia.strips.length;F++)ia.strips[F].action&&x(ia.strips[F],
"action",I)}for(L=0;L<p.length;L++){for(var J=p[L],X=J.texture_slots,q=0;q<X.length;q++)x(X[q],"texture",I);J.dupli_group&&x(J,"dupli_group",I);J.dupli_object&&x(J,"dupli_object",I)}for(L=0;L<D.length;L++)if(X=D[L].texture_slots)for(q=0;q<X.length;q++)x(X[q],"texture",I);qb.check_bpy_data(a);Ua=0===b.id;Wa||(Wa=a.scenes[0]);var Tb=a.textures,Va;Va=Ua?a.scenes[0].b4w_anisotropic_filtering:Wa.b4w_anisotropic_filtering;for(var ha=0;ha<Tb.length;ha++)Ua||"SCENE"!=Tb[ha].b4w_source_type||(Tb[ha].b4w_source_id=
""),na.create_texture_bpy(Tb[ha],Va,a.scenes);for(var ob={},ba=a.objects,Ba=0;Ba<ba.length;Ba++){var ua=ba[Ba];if("MESH"===ua.type&&!ua.particle_systems.length)for(var lc=ua.data,cc=lc.name,Xb=lc.submeshes,Ma=lc.materials,xa=0;xa<Xb.length;xa++)0!==Xb[xa].base_length||ob[cc]||(Ma[xa]?ca.warn('B4W Warning: material "'+Ma[xa].name+'" is not assigned to any face (object "'+ua.name+'").'):ca.warn('B4W Warning: Mesh "'+lc.name+'" has no faces (object "'+ua.name+'").'),ob[cc]=!0)}for(var Yb=a.meshes,jb=
0;jb<Yb.length;jb++){var Kb=Yb[jb];Kb.materials.length||Kb.uv_textures.length&&ca.warn('B4W Warning: mesh "'+Kb.name+'" has a UV map but has no exported material.')}var ib=a.materials,db=qb.create_material("DEFAULT");ib.push(db);for(var Cb=a.meshes,Ub=Aa.keysearch("name","DEFAULT",a.materials),vb=0;vb<Cb.length;vb++){var $a=Cb[vb];0==$a.materials.length&&$a.materials.push(Ub)}for(var ic=a.actions,Gb=b.id,dd=0;dd<ic.length;dd++){var Ab=ic[dd];Ab._data_id=Gb;ea.append_action(Ab)}for(var Zb=a.scenes,
Bb=0;Bb<Zb.length;Bb++){for(var ub=Zb[Bb],$b=R.combine_scene_objects(ub,"ALL"),xc=[],mc=0;mc<$b.length;mc++)for(var Xc=$b[mc].particle_systems,nc=0;nc<Xc.length;nc++){var ec=Xc[nc].settings;if("HAIR"==ec.type)if("OBJECT"==ec.render_type)ja.update_object(ec.dupli_object,!0);else if("GROUP"==ec.render_type){for(var ed=ec.dupli_group,Ob=R.combine_scene_objects(ub,"EMPTY"),ab=0;ab<Ob.length;ab++)Ob[ab].dupli_group==ed&&xc.push(Ob[ab]);for(ab=0;ab<ed.objects.length;ab++)ja.update_object(ed.objects[ab],
!0)}else ca.warn("B4W Warning: render type",ec.render_type,"not supported for particle systems ("+ec.name+").")}for(mc=0;mc<xc.length;mc++)K(xc[mc],[ub])}N(a,b.id);for(var Pb=a.scenes,kb=0;kb<Pb.length;kb++){for(var kd=Pb[kb],yc=[],oc=[],Ad=Pb[kb].objects,ac=0;ac<Ad.length;ac++){var ld=Ad[ac];B(Ad,ld,yc,oc);var Qb=ld.dupli_group;if(Qb)for(var Yc=Qb.objects,zc=0;zc<Yc.length;zc++)B(Yc,Yc[zc],yc,oc)}for(ac=0;ac<oc.length;ac++)K(oc[ac],[kd]);for(ac=0;ac<yc.length;ac++)Aa.append_unique(yc[ac][0],yc[ac][1])}N(a,
b.id);var gb=Z(a,b.id);qb.assign_nla_object_params(gb,a.scenes);for(ha=0;ha<gb.length;ha++){var Fc=gb[ha];!Ua&&Fc.parent&&-1<Dc.indexOf(Fc.parent.type)&&(Fc.parent="");ja.update_object(Fc,!1);Fc._render.data_id=b.id}for(var pc=0;pc<gb.length;pc++){var Ac=gb[pc];if("MESH"==Ac.type){var Gc=ea.get_first_armature_object(Ac);if(Gc){var Zc=Gc._render;if(Zc.anim_mixing){var wd=Ac._render.bone_pointers,$c=[],xd;for(xd in wd){var ad=wd[xd];$c.push(4*ad.deform_bone_index,4*ad.bone_index)}Zc.mesh_to_arm_bone_maps.push($c)}Zc.skinned_renders.push(Ac._render)}}}for(var Nc=
-1,Bc=0;Bc<gb.length;Bc++){var fc=gb[Bc],Oc=fc._render;if(Aa.is_mesh(fc)&&Oc.is_skinning){var Bd=Oc.max_bones;Bd>Nc&&(Nc=Bd)}}for(Bc=0;Bc<gb.length;Bc++)if(fc=gb[Bc],Oc=fc._render,Aa.is_mesh(fc)&&Oc.is_skinning){Oc.max_bones=Nc;var fd=fc,md=Oc.max_bones,qc=Qa.max_bones,Pc=fd._render;md>2*qc?Aa.panic('B4W Error: too many bones for "'+fd.name+'"'):md>qc?(ca.warn('B4W Warning: too many bones for "'+fd.name+'" / '+md+" bones (max "+qc+"). Blending between frames will be disabled."),Pc.frames_blending=
!1):Pc.frames_blending=!0;Pc.frames_blending=Pc.frames_blending&&!bd.frames_blending_hack}for(var yd=0;yd<gb.length;yd++){var Rb=gb[yd];if(Aa.is_mesh(Rb)){var Cd=Rb.lod_levels.length;if(Cd)for(var gd=Rb,Hc=0;Hc<Cd;Hc++){var Ic=Rb.lod_levels[Hc].object;if(!Ic){gd._render.last_lod=!0;gd._render.lod_dist_max=Rb.lod_levels[Hc].distance;break}Ic._render.lod_transition_ratio=Rb._render.lod_transition_ratio;gd._render.lod_dist_max=Rb.lod_levels[Hc].distance;Ic._render.lod_dist_min=Rb.lod_levels[Hc].distance;
if(Rb.lod_levels[Hc+1])Ic._render.lod_dist_max=Rb.lod_levels[Hc+1].distance;else{Ic._render.last_lod=!0;Ic._render.lod_dist_max=1E4;break}gd._render.last_lod=!1;gd=Ic}}}for(var Id=0;Id<gb.length;Id++){var la=gb[Id];if(la.b4w_vehicle){var Ra=la.b4w_vehicle_settings;if("CHASSIS"==Ra.part){la._vehicle={};la._vehicle.force_max=Ra.force_max;la._vehicle.brake_max=Ra.brake_max;la._vehicle.suspension_compression=Ra.suspension_compression;la._vehicle.suspension_stiffness=Ra.suspension_stiffness;la._vehicle.suspension_damping=
Ra.suspension_damping;la._vehicle.wheel_friction=Ra.wheel_friction;la._vehicle.roll_influence=Ra.roll_influence;la._vehicle.max_suspension_travel_cm=Ra.max_suspension_travel_cm;la._vehicle.engine_force=0;la._vehicle.brake_force=1;la._vehicle.steering=0;la._vehicle.speed=0;la._vehicle.props=[];la._vehicle.prop_offsets=[];la._vehicle.steering_wheel=null;for(var Md=la._dg_parent?la._dg_parent.dupli_group.objects:gb,nd=0;nd<Md.length;nd++){var Na=Md[nd];if(Na.b4w_vehicle){var Ja=Na.b4w_vehicle_settings;
if(oa.is_car_wheel(Na)&&Ra.name==Ja.name){var Nd=oa.wheel_index(Na.b4w_vehicle_settings.part);la._vehicle.props[Nd]=Na;la._vehicle.prop_offsets[Nd]=new Float32Array(8)}else if(oa.is_vehicle_steering_wheel(Na)&&Ra.name==Ja.name){la._vehicle.steering_wheel=Na;la._vehicle.steering_max=Ja.steering_max;la._vehicle.steering_ratio=Ja.steering_ratio;la._vehicle.inverse_control=Ja.inverse_control;var Hb=cb.invert(la._render.world_matrix,new Float32Array(16)),Dd=cb.multiply(Hb,Na._render.world_matrix,Hb);la._vehicle.steering_wheel_matrix=
Dd;var od=new Float32Array([1,0,0,0]);Jb.transformMat4(od,Dd,od);la._vehicle.steering_wheel_axis=od}else if(oa.is_vehicle_speedometer(Na)&&Ra.name==Ja.name){la._vehicle.speedometer=Na;la._vehicle.speed_ratio=Ja.speed_ratio;la._vehicle.max_speed_angle=Ja.max_speed_angle;var Hb=cb.invert(la._render.world_matrix,new Float32Array(16)),Ed=cb.multiply(Hb,Na._render.world_matrix,Hb);la._vehicle.speedometer_matrix=Ed;var Qc=new Float32Array([1,0,0,0]);Jb.transformMat4(Qc,Ed,Qc);la._vehicle.speedometer_axis=
Qc}else if(oa.is_vehicle_tachometer(Na)&&Ra.name==Ja.name){la._vehicle.tachometer=Na;la._vehicle.delta_tach_angle=Ja.delta_tach_angle;var Hb=cb.invert(la._render.world_matrix,new Float32Array(16)),Fd=cb.multiply(Hb,Na._render.world_matrix,Hb);la._vehicle.tachometer_matrix=Fd;var ud=new Float32Array([1,0,0,0]);Jb.transformMat4(ud,Fd,ud);la._vehicle.tachometer_axis=ud}}}if(4!=la._vehicle.props.length)throw"Not enough wheels for chassis "+la.name;}else if("HULL"==Ra.part){la._vehicle={};la._vehicle.props=
[];la._vehicle.prop_offsets=[];la._vehicle.force_max=Ra.force_max;la._vehicle.brake_max=Ra.brake_max;la._vehicle.floating_factor=Ra.floating_factor;la._vehicle.water_lin_damp=Ra.water_lin_damp;la._vehicle.water_rot_damp=Ra.water_rot_damp;la._vehicle.engine_force=0;la._vehicle.brake_force=1;la._vehicle.steering=0;la._vehicle.speed=0;la._vehicle.steering_wheel=null;for(var Od=la._dg_parent?la._dg_parent.dupli_group.objects:gb,nd=0;nd<Od.length;nd++)Na=Od[nd],Na.b4w_vehicle&&(Ja=Na.b4w_vehicle_settings,
oa.is_boat_bob(Na)&&Ra.name==Ja.name?(la._vehicle.props.push(Na),la._vehicle.prop_offsets.push(new Float32Array(8))):oa.is_vehicle_steering_wheel(Na)&&Ra.name==Ja.name?(la._vehicle.steering_wheel=Na,la._vehicle.steering_max=Ja.steering_max,la._vehicle.steering_ratio=Ja.steering_ratio,la._vehicle.inverse_control=Ja.inverse_control,Hb=cb.invert(la._render.world_matrix,new Float32Array(16)),Dd=cb.multiply(Hb,Na._render.world_matrix,Hb),la._vehicle.steering_wheel_matrix=Dd,od=new Float32Array([1,0,0,
0]),Jb.transformMat4(od,Dd,od),la._vehicle.steering_wheel_axis=od):oa.is_vehicle_speedometer(Na)&&Ra.name==Ja.name?(la._vehicle.speedometer=Na,la._vehicle.speed_ratio=Ja.speed_ratio,la._vehicle.max_speed_angle=Ja.max_speed_angle,Hb=cb.invert(la._render.world_matrix,new Float32Array(16)),Ed=cb.multiply(Hb,Na._render.world_matrix,Hb),la._vehicle.speedometer_matrix=Ed,Qc=new Float32Array([1,0,0,0]),Jb.transformMat4(Qc,Ed,Qc),la._vehicle.speedometer_axis=Qc):oa.is_vehicle_tachometer(Na)&&Ra.name==Ja.name&&
(la._vehicle.tachometer=Na,la._vehicle.delta_tach_angle=Ja.delta_tach_angle,Hb=cb.invert(la._render.world_matrix,new Float32Array(16)),Fd=cb.multiply(Hb,Na._render.world_matrix,Hb),la._vehicle.tachometer_matrix=Fd,ud=new Float32Array([1,0,0,0]),Jb.transformMat4(ud,Fd,ud),la._vehicle.tachometer_axis=ud))}}}for(var Jd=0;Jd<gb.length;Jd++){var Jc=gb[Jd];if(Jc.b4w_floating){var Gd=Jc.b4w_floating_settings;if("MAIN_BODY"==Gd.part){Jc._floater={};Jc._floater.floating_factor=Gd.floating_factor;Jc._floater.water_lin_damp=
Gd.water_lin_damp;Jc._floater.water_rot_damp=Gd.water_rot_damp;Jc._floater.bobs=[];for(var Pd=Jc._dg_parent?Jc._dg_parent.dupli_group.objects:gb,Kd=0;Kd<Pd.length;Kd++){var zd=Pd[Kd];if(zd.b4w_floating){var Td=zd.b4w_floating_settings;oa.is_floater_bob(zd)&&Gd.name==Td.name&&(Jc._floater.bobs.push(zd),zd.bob_synchronize_pos=zd.b4w_floating_settings.synchronize_position)}}}}}e(b,c)}function k(a,b,c,d,e,f){!Ua&&1<a.scenes.length&&(a.scenes=[a.scenes[0]],ca.warn("B4W Warning: loading data contains multiple scenes.",
"Only the first one will be loaded."));-1==bd.framerate&&Ua&&(bd.framerate=a.scenes[0].fps);for(d=0;d<a.scenes.length;d++){f=a.scenes[d];if(Ua&&!f.camera)throw"Scene check failed: No camera";for(var w=R.combine_scene_objects(f,"MESH"),g=0;g<w.length;g++){var h=w[g],k=qb.apply_mesh_modifiers(h);k&&(a.meshes.push(k),h.data=k)}for(var g=Z(a,b.id),h=a.meshes,k=h.slice(0),l=0;l<g.length;l++){var m=g[l];"MESH"==m.type&&(m=k.indexOf(m.data),-1<m&&k.splice(m,1))}for(l=0;l<k.length;l++)h.splice(h.indexOf(k[l]),
1);Ua?(R.append_scene(f,a.textures),f._render.video_textures.length&&(b.has_video_textures=!0),Tb.enabled&&f.b4w_enable_physics&&oa.attach_scene_physics(f),f.b4w_enable_audio&&aa.attach_scene_sfx(f),g=R.get_graph(f),h=f.b4w_batch_grid_size):(R.append_to_existed_scene(f,Wa,a.textures),Tb.enabled&&f.b4w_enable_physics&&!Wa._physics&&oa.attach_scene_physics(Wa),f.b4w_enable_audio&&!Wa._sfx&&aa.attach_scene_sfx(Wa),g=R.get_graph(Wa),h=Wa.b4w_batch_grid_size);w=D.generate_main_batches(g,h,w,f.world,Wa._render.lamps_number);
Ua?(R.add_meta_objects(f,w),R.generate_auxiliary_batches(g)):R.add_meta_objects(Wa,w)}d=a.materials;if(Kb.dds_available&&Qa.use_dds)for(a=0;a<d.length;a++){f=d[a];h=f.texture_slots;for(w=0;w<h.length;w++)if(k=h[w],l=k.texture,"IMAGE"==l.type||"ENVIRONMENT_MAP"==l.type)g=l.image,g._is_dds||(-1<g.filepath.indexOf(".dds")?g._is_dds=!0:(g._is_dds=!l.b4w_disable_compression&&!k.use_map_normal&&"ENVIRONMENT_MAP"!=l.type&&!l.b4w_shore_dist_map&&"MOVIE"!=g.source,g._is_dds&&(g.filepath+=".dds")));if(w=f.node_tree)for(h=
w.nodes,w=0;w<h.length;w++)g=h[w],"TEXTURE"==g.type&&((k=g.texture)?(g=k.image)&&!g._is_dds&&(g._is_dds=k._render.allow_node_dds&&!k.b4w_disable_compression&&"MOVIE"!=g.source,g._is_dds&&(g.filepath+=".dds")):ca.warn("B4W Warning: material ",f.name," has empty textures."))}else for(a=a.images,d=0;d<a.length;d++)f=a[d],w=Boolean("FILE"==f.source&&-1<f.filepath.indexOf(".dds")),f._is_dds=w;e(b,c)}function g(a,b,c,d,e,f){d=a.groups;a=a.objects;f={};for(var w={},g={},h={},k=0;k<d.length;k++){var l=d[k];
f[l.uuid]=l;g[l.uuid]=l}for(k=0;k<a.length;k++)l=a[k],w[l.uuid]=l,h[l.uuid]=l;y(a,null,h,g);for(var m in g)m in f||d.push(g[m]);for(m in h)m in w||a.push(h[m]);e(b,c)}function y(a,b,c,d){for(var e=[],f=0;f<a.length;f++){var g=a[f],h=c[g.uuid];if(g=h.proxy){b&&-1==e.indexOf(g.uuid)&&e.push(g.uuid);for(var k=c[g.uuid],l=k.constraints,g=0;g<l.length;g++){var p=Aa.clone_object_json(l[g]);p.name+="_CLONE";h.constraints.push(p)}"b4w_proxy_inherit_anim"in h&&!h.b4w_proxy_inherit_anim||(h.animation_data&&
(k.animation_data=Aa.clone_object_json(h.animation_data)),k.b4w_use_default_animation=h.b4w_use_default_animation,k.b4w_auto_skel_anim=h.b4w_auto_skel_anim,k.b4w_anim_behavior=h.b4w_anim_behavior,k.b4w_cyclic_animation=h.b4w_cyclic_animation)}}for(f=0;f<e.length;f++)h=Aa.get_index_for_key_value(a,"uuid",e[f]),-1<h&&a.splice(h,1);e={};for(f=0;f<a.length;f++)g=a[f],h=c[g.uuid],b&&(l=Aa.clone_object_json(h),h="origin_name"in h?h.origin_name:h.name,l.name=b+"*"+h,l.origin_name=h,m(l),c[l.uuid]=l,e[g.uuid]=
l.uuid,g.uuid=l.uuid),h=c[g.uuid],h.dupli_group&&(g=h.dupli_group,l=d[g.uuid],k=Aa.clone_object_json(l),k.name=Aa.unique_name(l.name+"_CLONE"),k.uuid=w.hexdigest("Group"+k.name),d[k.uuid]=k,g.uuid=k.uuid,y(k.objects,h.name,c,d));if(b)for(f=0;f<a.length;f++){g=a[f];h=c[g.uuid];h.parent&&h.parent.uuid in e?h.parent.uuid=e[h.parent.uuid]:h.parent&&(ca.warn("B4W Warning: Object's \""+h.name+'" parent is not in dupli group. Disabling parenting.'),h.parent=null);l=h.constraints;for(g=0;g<l.length;g++)b=
l[g],b.target&&b.target.uuid in e&&(b.target.uuid=e[b.target.uuid]);b=h.modifiers;for(g=0;g<b.length;g++)d=b[g],d.object&&d.object.uuid in e&&(d.object.uuid=e[d.object.uuid]);if((h=h.lod_levels)&&h.length)for(g=0;g<h.length;g++)b=h[g],b.object&&b.object.uuid in e&&(b.object.uuid=e[b.object.uuid])}for(var n in e)ib[n]=e[n]}function m(a){a.uuid=w.hexdigest("Object"+a.name)}function s(a,b){for(var c=a.nodes,d=0;d<c.length;d++){var e=c[d];"TEXTURE"==e.type&&e.texture&&x(e,"texture",b);"LAMP"==e.type&&
e.lamp&&(e.lamp.uuid in ib&&(e.lamp.uuid=ib[e.lamp.uuid]),b[e.lamp.uuid]||(e.lamp=null));"GROUP"==e.type&&e.node_group&&x(e,"node_group",b)}e=a.links;for(d=0;d<e.length;d++){var f=e[d];C(f,"from_node",c);C(f,"to_node",c);A(f,"from_socket",f.from_node.outputs);A(f,"to_socket",f.to_node.inputs)}if(c=a.animation_data)if(c.action&&x(c,"action",b),c.nla_tracks)for(d=0;d<c.nla_tracks.length;d++)for(e=c.nla_tracks[d],f=0;f<e.strips.length;f++)e.strips[f].action&&x(e.strips[f],"action",b)}function x(a,b,
c){(c=c[a[b].uuid])||ca.error("Dangling link found:",b,a);a[b]=c}function C(a,b,c){c=Aa.keysearch("name",a[b].name,c);a[b]=c}function A(a,b,c){c=Aa.keysearch("identifier",a[b].identifier,c);a[b]=c}function f(a,b,d,e,f,w){if(!Qa.do_not_load_resources){for(var g=X(b.filepath),h=a.images,k={},l=[],m=0;m<h.length;m++){var p=h[m],n=p.uuid;if("FILE"===p.source||"MOVIE"===p.source){var H=E(p,a.textures);if(!H.length)ca.warn("B4W Warning: image ",p.name," has no users.");else if(!(H[0].b4w_shore_dist_map||
"MOVIE"===p.source&&Qa.firefox_disable_html_video_tex_hack)){H=ga(g+p.filepath);if("FILE"===p.source){var t=p._is_dds?fa.AT_ARRAYBUFFER:fa.AT_IMAGE_ELEMENT;Kb.min50_available&&Qa.use_min50&&(H=fa.split_extension(H),"dds"==H[1]?(H=fa.split_extension(H[0]),H=H[0]+".min50."+H[1]+".dds"):H=H[0]+".min50."+H[1])}else"MOVIE"===p.source&&(Qa.seq_video_fallback?(H=fa.split_extension(H),H=H[0]+".altconv.seq",t=fa.AT_SEQ_VIDEO_ELEMENT):(H=fa.split_extension(H),t=aa.detect_video_container(H[1]),H=t!=H[1]?H[0]+
".altconv."+t:H[0]+"."+t,t=fa.AT_VIDEO_ELEMENT));l.push([n,t,H,p.name]);k[n]=p}}}l.length?(e.image_counter=0,fa.enqueue(l,function(f,g,h,m){if(f){if(h==fa.AT_VIDEO_ELEMENT||h==fa.AT_SEQ_VIDEO_ELEMENT){if(h==fa.AT_VIDEO_ELEMENT)var p=f.videoWidth,H=f.videoHeight;else p=f.images[0].width,H=f.images[0].height;ca.log("%cLOAD VIDEO "+p+"x"+H,"color: #"+(2048<p||2048<H?"a00":1024<p||1024<H?"aa0":"0a0"),m);-1==m.indexOf(ob)&&ca.warn("B4W Warning: video",m,"is not from app root.")}else c(f,m,!0);g=k[g];m=
E(g,a.textures);for(p=0;p<m.length;p++){var H=m[p],n=H.image.filepath;h==fa.AT_SEQ_VIDEO_ELEMENT?(H._render.seq_fps=f.fps,na.update_texture(H._render,f.images,g._is_dds,n)):na.update_texture(H._render,f,g._is_dds,n)}}f=++e.image_counter/l.length;w(b,d,f)},function(){ca.log("%cLOADED ALL IMAGES","color: #0a0");f(b,d)})):f(b,d)}}function E(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];e.image===a&&c.push(e)}return c}function n(a,b,c,d,e,f){if(!Qa.do_not_load_resources){a=Z(a,b.id);for(var w=X(b.filepath),
g=[],h={},k=0;k<a.length;k++){var l=a[k];if(t(l)){var m=l.data.sound,p=m.uuid;"BACKGROUND_MUSIC"==aa.get_spk_behavior(l)?(p=Aa.gen_uuid(),b.has_background_music=!0):"NONE"!=aa.get_spk_behavior(l)&&Qa.init_wa_context_hack&&(b.init_wa_context=!0);if(!(p in h)){h[p]=[];m=ga(w+m.filepath);switch(aa.source_type(l)){case aa.AST_ARRAY_BUFFER:var H=fa.AT_AUDIOBUFFER;break;case aa.AST_HTML_ELEMENT:H=fa.AT_AUDIO_ELEMENT}var m=fa.split_extension(m),n=aa.detect_audio_container(m[1]),m=n!=m[1]?m[0]+".altconv."+
n:m[0]+"."+n;g.push([p,H,m])}h[p].push(l)}}g.length?fa.enqueue(g,function(a,e,w,k){if(a)for(ca.log("%cLOAD SOUND","color: #0aa",k),-1==k.indexOf(ob)&&ca.warn("B4W Warning: sound",k,"is not from app root."),e=h[e],w=0;w<e.length;w++)aa.update_spkobj(e[w],a);a=++d.sound_counter/g.length;f(b,c,a)},function(){ca.log("%cLOADED ALL SOUNDS","color: #0aa");e(b,c)}):e(b,c)}}function t(a){return aa.is_speaker(a)&&aa.source_type(a)!=aa.AST_NONE?!0:!1}function M(a,b){for(var c=R.get_scene_objs(a,"SPEAKER",R.DATA_ID_ALL),
d=0;d<c.length;d++){var e=c[d];aa.is_speaker(e)&&(aa.is_cyclic(e)||b)&&aa.play_def(e)}}function S(a){a=a._render.video_textures;for(var b=0;b<a.length;b++)Qa.seq_video_fallback&&a[b].use_auto_refresh?a[b]._render.seq_video_played=!0:a[b]._render.video_file&&a[b].use_auto_refresh&&a[b]._render.video_file.play()}function z(a,b,c,d,e,f){ta.start();ca.log("%cSTART NLA","color: #0a0");e(b,c)}function B(a,b,c,d){if(b.lod_levels&&b.lod_levels.length)for(var e=b.lod_levels.length,f=0;f<e;f++){var w=b.lod_levels[f],
g=w.object;if(g){var h=Aa.clone_object_nr(g);h.name=b.name+"_LOD_"+String(f+1);m(h);h.lod_levels=[];c.push([a,h]);d.push(g);w.object=h}}}function K(a,b){for(var c=0;c<b.length;c++){for(var d=b[c].objects,e=0;e<d.length;e++){var f=d[e].dupli_group;f&&(f=f.objects,w=f.indexOf(a),-1<w&&f.splice(w,1))}var w=d.indexOf(a);-1<w&&d.splice(w,1)}}function v(a,b,c,d,e,f){for(d=0;d<a.scenes.length;d++){f=a.scenes[d];var w=Ua?f.b4w_enable_physics:Wa.b4w_enable_physics||f.b4w_enable_physics;Ua||(f=Wa);for(var g=
0;g<Cb.length;g++)for(var h=R.get_scene_objs(f,Cb[g],R.DATA_ID_ALL),k=0;k<h.length;k++){var l=h[k];l._render.data_id==b.id&&Tb.enabled&&w&&(oa.append_object(l,f),b.load_hidden&&oa.has_physics(l)&&oa.disable_simulation(l))}}e(b,c)}function Q(a,b,d,e,f,w){var g={};e=[];var h=a.scenes;for(w=0;w<a.scenes.length;w++){var k=h[w];if(k._render.water_params&&(k=k._render.water_params.shoremap_image)&&"FILE"===k.source){var l=k.uuid,m=X(b.filepath),m=ga(m+k.filepath);e.push([l,k._is_dds?fa.AT_ARRAYBUFFER:fa.AT_IMAGE_ELEMENT,
m,k.name]);g[l]=k}}e.length?fa.enqueue(e,function(b,d,e,f){if(b){c(b,f,!0);d=g[d];f=E(d,a.textures);for(e=0;e<f.length;e++){var w=f[e];na.update_texture(w._render,b,d._is_dds,w.image.filepath)}for(e=0;e<h.length;e++)if(f=h[e],f._render.water_params.shoremap_image===d){var k=b,l=d,m=document.createElement("canvas"),w=l.size[0],l=l.size[1];m.width=w;m.height=l;m=m.getContext("2d");m.drawImage(k,0,0);k=m.getImageData(0,0,w,l).data;m=new Float32Array(4);m[0]=1/16581375;m[1]=1/65025;m[2]=1/255;m[3]=1;
for(var w=w*l,l=new Float32Array(w),p=0;p<w;p++)l[p]=m[1]*k[4*p+2]+m[2]*k[4*p+3];f._render.shore_distances=l}}},function(){f(b,d)}):f(b,d)}function O(a,b,d,e,f,w){if(Qa.antialiasing&&Qa.smaa){e=a.scenes[0];a=[];var g=["SMAA_EDGE_DETECTION","SMAA_BLENDING_WEIGHT_CALCULATION","SMAA_NEIGHBORHOOD_BLENDING","SMAA_RESOLVE"];for(w=0;w<g.length;w++){var h=R.get_subs(e,g[w]);h&&a.push(h)}if(a.length){e=[];X(b.filepath);w=fa.AT_IMAGE_ELEMENT;e.push(["SEARCH_TEXTURE",w,I.paths.smaa_search_texture_path,"smaa_search_texture"]);
e.push(["AREA_TEXTURE",w,I.paths.smaa_area_texture_path,"smaa_area_texture"]);for(w=0;w<a.length;w++)if(g=a[w],"SMAA_BLENDING_WEIGHT_CALCULATION"==g.type){a=g.slinks_internal;for(w=0;w<a.length;w++)if(g=a[w],"u_search_tex"==g.to)var k=g.texture;else if("u_area_tex"==g.to)var l=g.texture;break}e.length?fa.enqueue(e,function(a,b,d,e){a&&(c(a,e,!1),b="SEARCH_TEXTURE"==b?k:l,b.source="IMAGE",b.auxilary_texture=!0,d=-1!=e.indexOf(".dds")?1:0,na.update_texture(b,a,d,e),na.set_filters(b,na.TF_LINEAR,na.TF_LINEAR))},
function(){f(b,d)}):f(b,d)}else f(b,d)}else f(b,d)}function L(a,b,c,d,e,f){for(c=0;c<a.scenes.length;c++){e=a.scenes[c];Ua||(e=Wa);f=R.get_scene_objs(e,"ALL",R.DATA_ID_ALL);for(var w=0;w<f.length;w++){var g=f[w];g._render.data_id==b.id&&(b.load_hidden&&Aa.is_mesh(g)&&R.hide_object(g),d.added_objects.push({scene:e,obj:g}))}}}function G(a,b,c,d,e,f){a=d.added_objects;var w=d.obj_counter;a.length?(e=a[w].obj,w=a[w].scene,R.append_object(w,e),-1!=ic.indexOf(e.type)&&w.b4w_enable_audio&&aa.append_object(e,
w),d=++d.obj_counter/a.length):d=1;f(b,c,d)}function V(a,b,c,d,e,f){if(Ua){for(d=0;d<a.scenes.length;d++)f=a.scenes[d],R.sort_lamps(f),R.update_shadow_lamp_id(f),(f._render_to_texture||0==d)&&R.prepare_rendering(f),f.b4w_use_nla&&ta.update_scene_nla(f,f.b4w_nla_cyclic);R.set_active(a.scenes[0])}else R.update_scene_permanent_uniforms(Wa);a=Z(a,b.id);ja.update_objects_dynamics(a);e(b,c)}function $(a,b,c,d,e,f){if(Ua)for(d=0;d<a.scenes.length;d++)a.scenes[d].b4w_use_nla||S(a.scenes[d]),M(a.scenes[d]);
else a.scenes[0].b4w_use_nla||S(Wa),M(Wa);e(b,c)}function P(a,b,c,d,e,f){Qa.is_mobile_device&&(b.has_video_textures||b.has_background_music||b.init_wa_context)?Ba||Y(a,e,b,c):e(b,c)}function Y(a,b,c,d){var e=vb.canvas.parentElement;Ub=e.style.zIndex;e.style.zIndex="999";Ba=document.createElement("div");Ba.style.position="relative";Ba.style.height="88px";Ba.style.width="88px";var f=Math.round(vb.canvas.offsetHeight/2-44),w=Math.round(vb.canvas.offsetWidth/2-44);Ba.style.top=f.toString()+"px";Ba.style.left=
w.toString()+"px";Ba.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAABYCAYAAABxlTA0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAhOSURBVHic7Z1tjFxVGcd/z1AKsbzotoW0IQqFhpSXFlugxbbGRkNSLJEQLVJttH7VEl8+oCYYExLFDxilJib6AWshtlterN20hkBKsNitpFVapB9YIzGBWEq3+IKCLf374Tx3587szGxn5577Mt1fcnN37r1zznP+c/a55557znOMkiDJgLnAADDT9+ktOQYwChwHTvh+tGl7zcyUp/3tsCIzlzQdWAwsA24CLs4o6X8ALwDDwEEz+19G6XZN7gJLugi4mSDqh4HzUqffBN6gXkPT++RvaKzhM5v2lwCzUmm+C/yRIPYfzOyfMcrVjlwE9n//lcAngQVALXV6hFD435vZ3zLK74PARwg/4lWpU6eBI8Au4Lk83Eh0gSUtBDYA8/3QaeAlYB8wbGbHIuc/myD0LcB11H/cEeBhM3sxZv7RBJZ0OfBF4EY/9CawDdhrZv+Kle8ENl0IrADuou5GDhKE/muMPDMXWNIs4PPAxz39t4FBYGeRN5s0fnO9HVgLzAAE7AG2ZP0flZnAkmrAOuBOYDpwEhgCBouqsRPhNXotsAY4l2DzDoLQ72WRRyYCS7oAuJfQKohWG2Lhfno9sIqgySHg+6WoGJIuk/QzSUOSHpF0TdE2TRZJ13gZhiT93FsjhRq0RNI2N2iTpEsKNSgDJM2S9GMv06CkGyf+Vnsm7SIk3QF8idDs2Qc8aGbv9GJMWZB0HvBVQttdhFbGE5NJq2uBJU0DvgJ8wg9tBR4ty7N /lkhaS/DNBjwDbDKzU7Ez/bL/+zwh6aNRMysBkpZK2u5l/lrszNZ4Ro9LujpqZiVC0ryUyHfGyuQGSTsk7ZS0PEomJcZr8k7ferrxtUp8rqSt/guuyzTxCiFpbap1cUZNuNpEF0iaAXwHuAB4HvhVb2ZWFzMbBH4HvA+4z58EO9JRYH/8vRe4DPgL8MN+bC10yY8IWswBviXpnE4XT1SDP0d44/AWcL+ZvZuJiRXGNbifoMlCQjOueyTNlvSk+5zrMrSxL/DH6p2u0ex213WqwesJPUzPm9lLmVtYcczsZUKn1rl0qMUtBZZ0BaFn6RSwOYaBfcIWQhfnKtdsHO1q8AbC4+Fvzez1SMZVHu+OHSJotaHVNeMElrSIcGP7L6GfIRqSdklaEDOPHBgkvLVZ7No10CCwv/1NfonHzeytyMatBg5JekjSwIRXlxDvlB/0jxtcw9ZIWumthl9KOj+2cWrkuKSN3ltXKSRNl/QL125l+lyzi7jV91sL6NsdAB4i1OjVOefdE/4yd5t/vDV9bkxgfyS+HngPeC4368azANhVQf+8lzDm43rXEmiswUuAacCfzezfORvXikr5Z/fFLxM0vCk5nhb4Ft8P52jXREwDNgKvVMQ/J9olWgaB3fAlfmx/zkadCVXxz4nAS3xwy1gNXkjognvVzI4WYdkZUmr/bGZ/B14FzgdugLrAy3xfJvfQiTL750TDZQA1bxgvbTpZBcrqnxMXu1SS1QijDGcCo2Y2Upxdk6Zs/nmEMFj8YmBOjSAuQNU7dUrhn/2NT6LlzBqNE0v6gTL450TLvhQYivfPiZYD/SpwQlH++awROCFv/9wgcHKTO97m4n4iL/+caHnW1OA0efjnlje5s6EGp4npnxtq8BQRqZGqzkUaUgCjwD3AQjPbnXHaiZajaYHL1mkSi1PAJmC+mcUasT7mdqdxdtXg3cA3zOxI5HwSLU+kBe7nGnyEIGzWrqAdYzW4RuqOl1PmeRLTz3 ZirOnbrzX4FPBT4LtmVkT7vq8FzsvPdqKlwHMLMiYr8vaznUi0PF4DjhH88ICkq9p/p7QU5Wdb4hoOEOIGvV7zHvix90iFWdY9ebRnJ0PyAnm/mSl5VB5uOll2dhNq7D0F3cQ60fCGPhH4EPAf4IqSz5g/AtxmZrcVfBNriaRLgcuBd4A/gQvs/14H/LoyuolS+dkOJNodSMLnpHvT9vm+TG6irH62HYl2iZakO5sPEAp0raQZZvZ2npa1oAzt2TPGZ31eS9DwheT4WA12QQ8TRF+Rt4EpSu1nO7AcOAc4nK6czR3uT/n+7mR0YI5Uxc+Ow7X6rH98Kn2uWeC9hKE/s4BPxTcNqJ6fbcXtBM1GCBq2R9Ki1JT9i2JaVfQwpyyQdKHqgaE6T+MC8FiOBwnjhe+OaVwF/WwrkuiBB1vFwWz30vNhQrSl1ZLmRDSu0vgk8DV4ZKpW17QU2ANl7iG0KL4Qy8A+IJkwv6ddcNFOr+2Tic4rpsIZjEchwuEqgkZb2l3XVmCf6Pykf/ymQlTVKRhzDd8mTALf0SlG50QDTx4hhOd+PyFGTd5t49KhEBXwPoImhwkataWjwGZ2GngAeA24EogbmK3k+HyWrwPzgKPA9zJptytEWE3aenf1nGBFkbTONdgu6UNZJ75Y0m88Tk0ZuzSjImm56oHp4pRf0h3+Cz4maV6UTEqIpCu9zEOSPtPNd7saXWlmvwaeJsxk/IGkm7v5fhXxMj5AKPOzZra9m+/3Gt5WwGYze6zbdKqApE8THrSS8LY/MbOT3aSRVYDmPYTYuqVYZaBXvDm6kfAg0VOA5l4NSYcYf7CE84a7RtKAlyWTEONZGJQOkr9ZFY4rLOlqL0NmQfJjLfPwLGGZhzeySD82PlRhPfAxMl7mYWqhkiosVJJGU0vtNJDnYlHHgEcJi0UVshyEQiy4FYSwvUnE1GotFtWMxi93dhJ4kTDgcH/ssWXeslnq2yKCK4CqL3eWRu0X7BPwC mGg3HDGC/Yt820+9XL234J9zajzkpNHCcEsTlBfZvJE02eoLzf5Ad/Sn+cCl6bS7P8lJ9uhqUVT80N9uuzv/wFReZvk3/McjgAAAABJRU5ErkJggg==')";
db=document.createElement("div");db.style.position="relative";db.style.height=vb.canvas.offsetHeight.toString()+"px";db.style.width=vb.canvas.offsetWidth.toString()+"px";db.style.background="rgba(0, 0, 0, 0.5)";db.style.zIndex="999";e.appendChild(db);db.appendChild(Ba);Ba.addEventListener("click",function(){c.has_video_textures&&(na.play(),na.pause(),na.reset());if(c.has_background_music){if(Ua)for(var e=0;e<a.scenes.length;e++)M(a.scenes[e],!0);else M(Wa,!0);aa.pause()}c.init_wa_context&&aa.play_empty_sound();
T();b(c,d)},!1)}function T(){if(Ba){var a=vb.canvas.parentElement;a.style.zIndex=Ub;db.removeChild(Ba);a.removeChild(db);Ba=db=null;Ub=0}}function X(a){(a=a.split("/").slice(0,-1).join("/"))&&(a+="/");return a}function p(a){if(""==a)return".";var b=0==a.indexOf("/")|0;b&&0==a.indexOf("//")&&0!=a.indexOf("///")&&(b=2);a=a.split("/");for(var c=[],d=0;d<a.length;d++){var e=a[d];""!=e&&"."!=e&&(".."!=e||!b&&!c.length||c.length&&".."==c[c.length-1]?c.push(e):c.length&&c.pop())}a=c.join("/");for(d=0;d<
b;d++)a="/"+a;return a||"."}function ga(a){var b=a.split("://",2);return 1<b.length?(b[1]=p(b[1]),b.join("://")):p(a)}function Z(a,b){Ta[b]||N(a,b);return Ta[b]}function N(a,b){for(var c=a.scenes,d=[],e=0;e<c.length;e++)F(c[e].objects,0,d);Ta[b]=[];for(e=0;e<d.length;e++)for(var c=d[e],f=0;f<c.length;f++)for(var w=c[f],g=0;g<w.length;g++)Ta[b].push(w[g])}function F(a,b,c){c[b]=c[b]||[];for(var d=c[b],e=0;e<a.length;e++){var f=a[e],w=ha(f);d[w]=d[w]||[];(Ua||-1==Dc.indexOf(f.type))&&-1==d[w].indexOf(f)&&
d[w].push(f);(f=f.dupli_group)&&F(f.objects,b+1,c)}}function ha(a){return(a=a.parent||ea.get_first_armature_object(a))?1+ha(a):0}var ea=q("__animation"),D=q("__batch"),I=q("__config"),ia=q("__controls"),ka=q("__dds"),qa=q("__extensions");q("__lights");var H=q("__loader"),fa=q("__assets"),w=q("__md5"),ja=q("__objects"),oa=q("__physics"),ca=q("__print"),qb=q("__reformer"),ma=q("__renderer"),R=q("__scenes"),ta=q("__nla"),aa=q("__sfx"),Ya=q("__shaders"),na=q("__textures"),bb=q("__nodemat"),Aa=q("__util"),
Jb=q("vec4"),cb=q("mat4"),Qa=I.defaults,Kb=I.assets,Tb=I.physics,bd=I.animation,hc=I.sfx,Va=null,Ta=null,ob="",Ua=!1,Wa=null,ib={},Ba=null,db=null,Ub=0,Dc=["LAMP","CAMERA"],Cb=["MESH","CAMERA","EMPTY"],ic=["SPEAKER"],vb=null;a.is_primary_loaded=function(a){return H.is_primary_loaded(a)};a.update=function(){H.update_scheduler(Va)};a.setup_context=function(a){vb=a};a.update_media_controls=function(a,b){if(Ba){db.style.height=b.toString()+"px";db.style.width=a.toString()+"px";var c=Math.round(b/2-44),
d=Math.round(a/2-44);Ba.style.top=c.toString()+"px";Ba.style.left=d.toString()+"px"}};a.load=function(a,c,w,h,m){var p={load_main:{priority:H.ASYNC_PRIORITY,background_loading:!1,inputs:[],is_resource:!1,relative_size:500,primary_only:!1,cb_before:d},duplicate_objects:{priority:H.SYNC_PRIORITY,background_loading:!1,inputs:["load_main"],is_resource:!1,relative_size:50,primary_only:!1,cb_before:g},load_binaries:{priority:H.ASYNC_PRIORITY,background_loading:!1,inputs:["load_main"],is_resource:!1,relative_size:500,
primary_only:!1,cb_before:b},prepare_bindata:{priority:H.SYNC_PRIORITY,background_loading:!1,inputs:["duplicate_objects","load_binaries"],is_resource:!1,relative_size:0,primary_only:!1,cb_before:l},prepare_root_datablocks:{priority:H.SYNC_PRIORITY,background_loading:!1,inputs:["duplicate_objects","prepare_bindata"],is_resource:!1,relative_size:150,primary_only:!1,cb_before:e},prepare_root_scenes:{priority:H.SYNC_PRIORITY,background_loading:!1,inputs:["prepare_root_datablocks"],is_resource:!1,relative_size:350,
primary_only:!1,cb_before:k},load_smaa_textures:{priority:H.ASYNC_PRIORITY,background_loading:!0,inputs:["prepare_root_scenes"],is_resource:!1,relative_size:10,primary_only:!0,cb_before:O},load_shoremap:{priority:H.ASYNC_PRIORITY,background_loading:!0,inputs:["prepare_root_scenes"],is_resource:!1,relative_size:10,primary_only:!0,cb_before:Q},load_textures:{priority:H.ASYNC_PRIORITY,background_loading:!0,inputs:["prepare_root_scenes"],is_resource:!0,relative_size:500,primary_only:!1,cb_before:f,cb_param:{image_counter:0}},
add_physics_objects:{priority:H.SYNC_PRIORITY,background_loading:!1,inputs:["load_shoremap"],is_resource:!1,relative_size:20,primary_only:!1,cb_before:v},add_objects:{priority:H.SYNC_PRIORITY,background_loading:!1,inputs:["add_physics_objects"],is_resource:!1,relative_size:800,primary_only:!1,cb_before:L,cb_loop:G,cb_after:V,cb_param:{added_objects:[],obj_counter:0}},load_speakers:{priority:H.ASYNC_PRIORITY,background_loading:!0,inputs:["add_objects"],is_resource:!0,relative_size:30,primary_only:!1,
cb_before:n,cb_param:{sound_counter:0}},mobile_media_start:{priority:H.SYNC_PRIORITY,background_loading:!Qa.is_mobile_device,inputs:["load_textures","load_speakers"],is_resource:!0,relative_size:5,primary_only:!1,cb_before:P,cb_loop:P},synchronize_media:{priority:H.SYNC_PRIORITY,background_loading:!0,inputs:["mobile_media_start"],is_resource:!0,relative_size:70,primary_only:!1,cb_before:$},start_nla:{priority:H.SYNC_PRIORITY,background_loading:!0,inputs:["mobile_media_start"],is_resource:!1,relative_size:5,
primary_only:!1,cb_before:z}},t=H.get_scheduler();t||(t=H.create_scheduler(),Va=[],Ta=[],ib={});Va[t.threads.length]={};return H.create_thread(p,a,c,w,r,h||hc.audio_loading_hack,Qa.do_not_load_resources,m)};a.unload=function(a){var b=H.get_scheduler();if(!b||!b.threads.length||a&&!H.thread_is_finished(b.threads[a]))ca.error("Unable to unload data!");else{if(0==a)ca.log("%cUNLOAD ALL","color: #00a"),ea.cleanup(),aa.cleanup(),ta.cleanup(),R.cleanup(),H.cleanup(),oa.cleanup(),ja.cleanup(),Aa.cleanup(),
ma.cleanup(),bb.cleanup(),Ya.cleanup(),ia.cleanup(),qa.cleanup(),fa.cleanup(),na.cleanup(),Ta=null,ib={},Ua=!1,Va=Wa=null;else{ca.log("%cUNLOAD DATA "+a,"color: #00a");ea.remove_actions(a);for(var b=R.get_all_scenes(),c=0;c<b.length;c++)for(var d=b[c],e=R.get_scene_objs(d,"ALL",R.DATA_ID_ALL),f=e.length-1;0<=f;f--){var w=e[f];if(w._render.data_id==a){var g=d,h=w;ea.is_animated(h)&&ea.remove(h);R.clear_glow_anim(h);oa.has_physics(h)&&(oa.disable_simulation(h),oa.remove_bounding_object(h));ia.check_sensor_manifold(h)&&
ia.remove_sensor_manifold(h);R.remove_object_bundles(g,h);aa.is_speaker(h)&&aa.speaker_remove(h);e.splice(f,1);g=R.get_scene_objs(d,w.type,R.DATA_ID_ALL);w=g.indexOf(w);-1!=w&&g.splice(w,1)}}}T()}};a.set_debug_resources_root=function(a){ob=a}};b4w.module.__batch=function(a,q){function r(a){a={type:a,id:0,render_id:0,odd_id_prop:"",textures:[],texture_names:[],material_names:[],node_elements:[],common_attributes:[],uv_maps_usage:null,vertex_colors_usage:{},shader:null,shaders_info:null,attribute_setters:[],particle_system:null,bufs_data:null,bone_pointers:null,childs:null,debug_sphere_dynamic:!1,num_vertices:0,num_triangles:0,jitter_amp:0,jitter_freq:0,glow_intensity:0,grass_scale_threshold:0,grass_size:0,grass_map_dim:new Float32Array(3),
color_id:new Float32Array(3),cube_fog:new Float32Array(16),blend:!1,color_mask:!1,depth_mask:!1,xray:!1,use_backface_culling:!1,use_shadeless:!1,dynamic_geometry:!1,shadow_cast:!1,shadow_cast_only:!1,shadow_receive:!1,reflexible:!1,reflexible_only:!1,reflective:!1,dynamic_grass:!1,procedural_sky:!1,draw_mode:Y.DM_DEFAULT,zsort_type:Y.ZSORT_DISABLED,texel_size_multiplier:0,texel_size:new Float32Array(2),texel_mask:new Float32Array(2),halo:!1,halo_size:0,halo_hardness:0,halo_stars_blend:0,halo_stars_height:0,
halo_rings_color:new Float32Array(3),halo_lines_color:new Float32Array(3),halo_particles:!1,ambient:0,emit:0,diffuse_intensity:1,reflect_factor:0,specular_color_factor:0,specular_alpha:1,parallax_scale:0,diffuse_color_factor:0,alpha_factor:1,normal_factor:0,mirror_factor:0,offset_z:0,refr_bump:0,diffuse_params:Array(2),specular_params:new Float32Array(3),texture_scale:new Float32Array(3),specular_color:new Float32Array(3),diffuse_color:new Float32Array(4),fresnel_params:new Float32Array(4),lamp_uuid_indexes:null,
lamp_light_positions:null,lamp_light_directions:null,lamp_light_color_intensities:null,lamp_light_factors:null,water:!1,water_dynamic:!1,water_shore_smoothing:!1,water_generated_mesh:!1,water_num_cascads:0,water_subdivs:0,water_detailed_dist:0,water_norm_uv_velocity:.1,shallow_water_col_fac:0,shore_water_col_fac:0,foam_factor:0,foam_uv_freq:new Float32Array(2),foam_mag:new Float32Array(2),foam_scale:new Float32Array(2),shallow_water_col:new Float32Array(3),shore_water_col:new Float32Array(3),normalmap_scales:null,
refractive:!1,p_length:0,p_cyclic:0,p_nfactor:0,p_gravity:0,p_max_lifetime:0,p_mass:0,p_fade_in:0,p_fade_out:0,p_size:0,p_alpha_start:0,p_alpha_end:0,p_size_ramp_length:0,p_color_ramp_length:0,p_wind:new Float32Array(3),p_size_ramp:new Float32Array(8),p_color_ramp:new Float32Array(16)};a.diffuse_color[3]=1;a.color_mask=!0;a.depth_mask=!0;a.texel_size_multiplier=1;return a}function c(a,c,d){for(var e=[],f=0;f<a.length;f++){var g=a[f],h=g._render,k=l(g.data.b4w_bounding_box),m=g.data.b4w_bounding_cylinder_radius,
p=g.data.b4w_bounding_sphere_radius,H=g.data.b4w_bounding_sphere_center,n=g.data.b4w_bounding_ellipsoid_axes,t=g.data.b4w_bounding_ellipsoid_center;if(h.billboard){var p=Math.max(Math.abs(k.max_x),Math.abs(k.min_x)),m=Math.max(Math.abs(k.max_y),Math.abs(k.min_y)),s=Math.max(Math.abs(k.max_z),Math.abs(k.min_z)),s=Math.sqrt(p*p+m*m+s*s),p=Math.sqrt(p*p+m*m);k.max_x=k.max_y=k.max_z=s;k.min_x=k.min_y=k.min_z=-s;m=p;p=s;H[0]=H[1]=H[2]=0;n[0]=n[1]=n[2]=s;t[0]=t[1]=t[2]=0}h.bb_local=k;s=G.bounding_box_transform(k,
h.world_matrix);h.bb_world=s;var s=h,D=m;s.bcyl_local=G.create_bounding_cylinder(D,k);s.bcap_local=G.create_bounding_capsule(m,k);s.bcon_local=G.create_bounding_cone(D,k);H=G.create_bounding_sphere(p,H);h.bs_local=H;H=G.bounding_sphere_transform(H,h.world_matrix);h.bs_world=H;n=G.create_bounding_ellipsoid([n[0],0,0],[0,n[1],0],[0,0,n[2]],t);h.be_local=n;n=G.bounding_ellipsoid_transform(n,h.tsr);h.be_world=n;e=e.concat(b(g,h,c,d))}return e}function d(a,c,d,e){for(var f=[],g=[],h={},k=0;k<a.length;k++){var m=
a[k],H=m._render,n=l(m.data.b4w_bounding_box),t=G.bounding_box_transform(n,H.world_matrix),s=G.create_bounding_sphere(m.data.b4w_bounding_sphere_radius,m.data.b4w_bounding_sphere_center),D=G.bounding_sphere_transform(s,H.world_matrix),x=m.data.b4w_bounding_ellipsoid_axes,x=G.create_bounding_ellipsoid([x[0],0,0],[0,x[1],0],[0,0,x[2]],m.data.b4w_bounding_ellipsoid_center),y=G.bounding_ellipsoid_transform(x,H.tsr);H.bb_local=n;H.bb_world=t;H.bs_local=s;H.bs_world=D;H.be_local=x;H.be_world=y;n={};n.shadow_cast=
H.shadow_cast;n.shadow_cast_only=H.shadow_cast_only;n.shadow_receive=H.shadow_receive;n.selectable=H.selectable;n.origin_selectable=H.origin_selectable;n.glow_anim_settings=H.glow_anim_settings;n.reflexible=H.reflexible;n.reflexible_only=H.reflexible_only;n.reflective=H.reflective;n.caustics=H.caustics;n.wind_bending=H.wind_bending;n.main_bend_col=H.main_bend_col;n.detail_bend_col=H.detail_bend_col;n.billboard=H.billboard;n.billboard_type=H.billboard_type;n.dynamic_grass=H.dynamic_grass;n.do_not_cull=
H.do_not_cull;n.disable_fogging=H.disable_fogging;n.dynamic_geometry=H.dynamic_geometry;t=H.bs_world.center;n.grid_id=0==d?[0,0]:[Math.floor(t[0]/d),Math.floor(t[2]/d)];n.lod_dist_max=H.lod_dist_max;n.lod_dist_min=H.lod_dist_min;n.lod_transition_ratio=H.lod_transition_ratio;H=JSON.stringify(n);h[H]=h[H]||[];h[H].push(m)}for(var v in h){n=JSON.parse(v);d=h[v];var m=p.create_render("STATIC"),L;for(L in n)m[L]=n[L];m.data_id=a[0]._render.data_id;m.wind_bending_amp=0;m.wind_bending_freq=0;m.detail_bending_freq=
0;m.detail_bending_amp=0;m.branch_bending_amp=0;m.hide=!1;for(k=0;k<d.length;k++)H=d[k],0==k?(m.bb_world=I.clone_object_r(H._render.bb_world),m.bs_world=I.clone_object_r(H._render.bs_world),m.be_local=I.clone_object_r(H._render.be_local),m.be_world=I.clone_object_r(H._render.be_world)):(G.expand_bounding_box(m.bb_world,H._render.bb_world),G.expand_bounding_sphere(m.bs_world,H._render.bs_world));m.bb_local=I.clone_object_r(m.bb_world);m.bs_local=I.clone_object_r(m.bs_world);g.push({render:m,objects:d})}for(a=
0;a<g.length;a++)for(h=g[a].render,k=g[a].objects,v=0;v<k.length;v++){L=k[v];d=b(L,h,c,e);m=z(L._render)||z(h);H={};h.wind_bending&&(H.au_center_pos=[m[0],m[1],m[2]],H.au_wind_bending_amp=[L._render.wind_bending_amp],H.au_wind_bending_freq=[L.b4w_wind_bending_freq],H.au_detail_bending_amp=[L.b4w_detail_bending_amp],H.au_detail_bending_freq=[L.b4w_detail_bending_freq],H.au_branch_bending_amp=[L.b4w_branch_bending_amp]);for(n=0;n<d.length;n++)D=d[n].render,t=d[n].submesh,s=d[n].batch,D.is_hair_particles?
D.billboard?Y.submesh_apply_particle_transform(t,m):Y.submesh_apply_transform(t,m):("COLOR_ID"==s.type?(D=d[n].render=L._render,D.type="DYNAMIC",s.odd_id_prop=L.uuid,E(s,D),B(s,I.calc_variable_id(D,0))):t=Y.submesh_apply_transform(t,m),Y.submesh_apply_params(t,H));f=f.concat(d)}return f}function b(a,b,c,d){for(var f=[],g=h(c,b),k=I.calc_variable_id(b,0),l=a.data,m=l.materials,p=0;p<g.length;p++){var H=g[p];if(!a.b4w_do_not_render||"PHYSICS"==H)for(var n=0;n<m.length;n++){var s=m[n];if(("LENS_FLARES"!=
s.name||0!=d)&&!Y.has_empty_submesh(l,n)){var D=r(H);if(e(D,s,!0)){D.draw_mode=l.draw_mode||Y.DM_DEFAULT;"COLOR_ID"===H&&D.color_id.set(a._color_id);E(D,b);for(var x=D,y=a.particle_systems,v=0;v<y.length;v++){var L=y[v].settings.b4w_vcol_from_name,C=y[v].settings.b4w_vcol_to_name;""!==L&&""!==C&&(x.vertex_colors_usage[L]={generate_buffer:!1,src:[{name:L,mask:7}]})}"DYNAMIC"==b.type&&(D.odd_id_prop=a.uuid);B(D,k);x=Y.extract_submesh(l,n,D.common_attributes,D.bone_pointers,D.vertex_colors_usage,D.uv_maps_usage);
"LENS_FLARES"==s.name&&(x=ga.prepare_lens_flares(x));f.push({batch:D,submesh:x,mat_names:[s.name],render:b,rel_objects:[a]})}}}}g=a.particle_systems;if(0<g.length&&f.length){d=!0;for(p=0;p<g.length;p++)if(g[p].settings.use_render_emitter){d=!1;break}p=f[0].batch;g=f[0].submesh;l=[];m=a.particle_systems;H=a.data;for(n=0;n<m.length;n++)if(s=m[n],D=s.settings,D.count)if("EMITTER"==D.type){if("DYNAMIC"==b.type){x=r("PARTICLES");y=H.materials;v=s.settings.material-1;v>=y.length&&($.warn('B4W Warning: Wrong material used for rendering particle system "'+
s.name+'"'),v=0);y=y[v];"HALO"===s.settings.render_type&&(x.halo_particles=!0);e(x,y);E(x,b);v=x;switch(s.settings.b4w_billboard_align){case "VIEW":t(v,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_VIEW");break;case "XY":t(v,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_XY");break;case "YZ":t(v,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_YZ");break;case "ZX":t(v,"BILLBOARD_ALIGN","BILLBOARD_ALIGN_ZX");break;default:throw"Wrong billboard align value";}t(v,"BILLBOARD",0);x.dynamic_geometry=!0;x.odd_id_prop=a.name+"_"+D.uuid;B(x,
k);x.particle_system=s;D=ga.generate_emitter_particles_submesh(x,H,s,y,a._render.tsr);ga.set_emitter_particles_uniforms(x,s,y);l.push({batch:x,submesh:D,mat_names:[y.name],render:b,rel_objects:[a]})}}else if("HAIR"==D.type){x=I.init_rand_r_seed(s.seed);D.b4w_dynamic_grass&&(b.do_not_cull=!0);if(s.transforms.length)var A=s.transforms;else for(var y=Y.geometry_random_points(g,D.count,!1,x),A=new Float32Array(4*y.length),z=0;z<y.length;z++)v=.75+.5*I.rand_r(x),A[4*z]=y[z][0],A[4*z+1]=y[z][1],A[4*z+2]=
y[z][2],A[4*z+3]=v;y=F.find_subs(c,"GRASS_MAP")?!0:!1;if("OBJECT"==D.render_type)v=[h(c,D.dupli_object._render)],s=S(a,b,p,g,[D.dupli_object],v,[A],D,s,y,x,!1),l=l.concat(s);else if("GROUP"==D.render_type){L=D.dupli_group.objects;C=!1;v=[];for(z=0;z<L.length;z++){var q=h(c,D.dupli_group.objects[z]._render);v.push(q)}if(D.use_whole_group){C=A;A=L;z={};for(q=0;q<C.length;q+=4)for(var G=0;G<A.length;G++){var fa=ia.create();ia.scale(A[G]._render.trans,A[G]._render.scale,fa);var M=ia.clone([C[q],C[q+1],
C[q+2]]);ia.add(M,fa,M);z[G]||(z[G]=new Float32Array(C.length));z[G][q]=M[0];z[G][q+1]=M[1];z[G][q+2]=M[2];z[G][q+3]=C[q+3]}A=z;C=!0}else if(D.use_group_count){for(var M=L,K=D.dupli_weights,z=x,q={},G=[],fa=0;fa<M.length;fa++)for(var V=M[fa],V=V.origin_name||V.name,N=0;N<K.length;N++){var qa=K[N];V==qa.name.split(": ")[0]&&G.push(qa)}K.length!=G.length&&$.error("B4W Error: dupli weights match failed");for(fa=0;fa<A.length;fa+=4){var O,K=G;O=[0];for(M=0;M<K.length;M++)O[M+1]=O[M]+K[M].count;K=O[O.length-
1]*I.rand_r(z);for(M=V=0;M<O.length;M++)if(K>=O[M]&&K<O[M+1]){V=M;break}O=V;q[O]=q[O]||[];q[O].push(A[fa],A[fa+1],A[fa+2],A[fa+3])}for(O in q)q[O]=new Float32Array(q[O]);A=q}else{z=x;q=L.length;G={};for(fa=0;fa<A.length;fa+=4){var T=Math.floor(q*I.rand_r(z));G[T]=G[T]||[];G[T].push(A[fa],A[fa+1],A[fa+2],A[fa+3])}for(T in G)G[T]=new Float32Array(G[T]);A=G}s=S(a,b,p,g,L,v,A,D,s,y,x,C);l=l.concat(s)}"INSTANCE"==D.b4w_wind_bend_inheritance&&(a._render.wind_bending_amp=0)}else throw"Unknown particle settings type";
a=l;f=d?a:f.concat(a)}return f}function l(a){return{max_x:a.max_x,min_x:a.min_x,max_y:a.max_y,min_y:a.min_y,max_z:a.max_z,min_z:a.min_z}}function h(a,b){var c=["MAIN","NODES"];b.selectable&&(F.find_subs(a,"COLOR_PICKING")||F.find_subs(a,"GLOW_MASK"))&&c.push("COLOR_ID");F.find_subs(a,"WIREFRAME")&&c.push("WIREFRAME");c.push("PHYSICS");(F.find_subs(a,"DEPTH")||F.find_subs(a,"SHADOW_CAST"))&&c.push("DEPTH");F.find_subs(a,"GRASS_MAP")&&c.push("GRASS_MAP");if(b.shadow_cast_only||b.reflexible_only){var d=
null;b.shadow_cast_only&&(d=["MAIN","NODES","COLOR_ID","PHYSICS","WIREFRAME"]);if(b.reflexible_only)var e=["COLOR_ID","PHYSICS","DEPTH","WIREFRAME"],d=null!==d?I.array_intersect(d,e):e;for(e=0;e<d.length;e++){var f=c.indexOf(d[e]);-1!==f&&c.splice(f,1)}}return c}function e(a,b,c){var d,e;switch(a.type){case "MAIN":if(b.b4w_do_not_render)a=!1;else if(b.use_nodes)a=!1;else{g(a,b);var f=b.game_settings.alpha_blend;a.xray=b.b4w_render_above_all&&"OPAQUE"!=f&&"CLIP"!=f;a.offset_z=b.offset_z;a.texture_scale.set([1,
1,1]);var h=b.texture_slots;ka.set(b.diffuse_color[0],b.diffuse_color[1],b.diffuse_color[2],b.alpha,a.diffuse_color);switch(b.name){case "LENS_FLARES":v(a,"special_lens_flares.glslv","special_lens_flares.glslf");n(a,"a_position");n(a,"a_texcoord");var l=c?[1,1,1,0]:null,l=y(h[0],l);Q(a,l);break;default:v(a,"main.glslv","main.glslf");var p=m("use_map_color_diffuse",!0,h),D=m("use_map_color_spec",!0,h),I=m("use_map_normal",!0,h),L=m("use_map_mirror",!0,h),r=m("use_stencil",!0,h),f=p[0],D=D[0],I=I[0],
L=L[0],p=p[1],h=r[0]&&m("use_rgb_to_intensity",!0,h)[0];if(f){switch(f.blend_type){case "MIX":t(a,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case "MULTIPLY":t(a,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY")}l="IMAGE"==f.texture._render.source&&c?[a.diffuse_color[0],a.diffuse_color[1],a.diffuse_color[2],1]:"ENVIRONMENT_MAP"==f.texture._render.source&&c?[.8,.8,.8,1]:null;l=y(f,l);Q(a,l,"u_colormap0");a.diffuse_color_factor=f.diffuse_color_factor;a.alpha_factor=f.use_map_alpha?f.alpha_factor:
0;a.texture_scale.set(f.scale)}r=f&&f==D;D&&(r||(l=c?[.5,.5,.5,1]:null,l=y(D,l),Q(a,l,"u_specmap0")),a.specular_color_factor=D.specular_color_factor);if(I){n(a,"a_normal");n(a,"a_tangent");l=c?[.5,.5,1,1]:null;l=y(I,l);Q(a,l,"u_normalmap0");a.normal_factor=I.normal_factor;var z=I.texture;if(z.b4w_use_map_parallax&&H.parallax){var l=ha.glsl_value(z.b4w_parallax_steps),q=ha.glsl_value(z.b4w_parallax_lod_dist);t(a,"PARALLAX",1);t(a,"PARALLAX_STEPS",l);t(a,"PARALLAX_LOD_DIST",q);a.parallax_scale=z.b4w_parallax_scale}}L&&
(l=c?[0,0,.5,1]:null,l=y(L,l),Q(a,l,"u_mirrormap"),a.mirror_factor=L.mirror_factor);if(z=f&&p&&h?1:0)l=c?[.8,.8,.8,1]:null,l=y(p,l),Q(a,l,"u_colormap1"),l=c?[.5,.5,.5,1]:null,l=y(h,l),Q(a,l,"u_stencil0");(c=f||D||I)&&a.texture_scale.set(c.scale);t(a,"TEXTURE_SPEC",void 0==D?0:1);t(a,"TEXTURE_MIRROR",void 0==L?0:1);t(a,"ALPHA_AS_SPEC",r?1:0);t(a,"TEXTURE_STENCIL_ALPHA_MASK",z);n(a,"a_position");n(a,"a_normal");(f||D||I)&&n(a,"a_texcoord");if(b.b4w_water){a.water=!0;a.water_shore_smoothing=b.b4w_water_shore_smoothing;
a.water_dynamic=b.b4w_water_dynamic;c=b.texture_slots;v(a,"special_water.glslv","special_water.glslf");n(a,"a_position");n(a,"a_texcoord");n(a,"a_normal");n(a,"a_tangent");H.water_wireframe_debug?(n(a,"a_polyindex"),a.depth_mask=!0,a.wireframe_edge_color=[0,0,0],t(a,"DEBUG_WIREFRAME",1)):t(a,"DEBUG_WIREFRAME",0);r=m("use_map_normal",!0,c);L=m("use_map_mirror",!0,c)[0];r.length&&(z=y(r[0]),Q(a,z,"u_normalmap0"),a.water_norm_uv_velocity=b.b4w_water_norm_uv_velocity);t(a,"NUM_NORMALMAPS",r.length);a.normalmap_scales=
Array(r.length);for(z=0;z<r.length;z++)a.normalmap_scales[z]=new Float32Array(2),a.normalmap_scales[z].set([r[z].scale[0],r[z].scale[1]]);L?(t(a,"TEXTURE_MIRROR",1),r=y(L),Q(a,r,"u_mirrormap"),a.mirror_factor=L.mirror_factor):t(a,"TEXTURE_MIRROR",0);L=null;for(z=0;z<c.length;z++)if(d=c[z],!0===d.texture.b4w_water_foam){L=d;break}L&&H.foam?(t(a,"FOAM",1),r=y(L),Q(a,r,"u_foam"),a.foam_factor=b.b4w_foam_factor,a.foam_uv_freq.set(L.texture.b4w_foam_uv_freq),a.foam_mag.set(L.texture.b4w_foam_uv_magnitude),
a.foam_scale[0]=L.scale[0],a.foam_scale[1]=L.scale[1]):t(a,"FOAM",0);for(z=0;z<c.length;z++)if(d=c[z],!0===d.texture.b4w_shore_dist_map){e=d;break}e&&H.allow_vertex_textures?(e=y(e),Q(a,e,"u_shore_dist_map"),t(a,"SHORE_PARAMS",1),e=d.texture.b4w_shore_boundings,t(a,"MAX_SHORE_DIST",ha.glsl_value(d.texture.b4w_max_shore_dist)),t(a,"SHORE_MAP_SIZE_X",ha.glsl_value(e[0]-e[1])),t(a,"SHORE_MAP_SIZE_Y",ha.glsl_value(e[2]-e[3])),t(a,"SHORE_MAP_CENTER_X",ha.glsl_value((e[0]+e[1])/2)),t(a,"SHORE_MAP_CENTER_Y",
ha.glsl_value((e[2]+e[3])/2))):t(a,"SHORE_PARAMS",0);b.b4w_generated_mesh&&H.deferred_rendering?(t(a,"GENERATED_MESH",1),a.water_generated_mesh=!0,a.water_num_cascads=b.b4w_water_num_cascads,a.water_subdivs=b.b4w_water_subdivs,a.water_detailed_dist=b.b4w_water_detailed_dist):t(a,"GENERATED_MESH",0);if(b.b4w_water_dynamic){d=ha.glsl_value(b.b4w_water_dst_noise_scale0);e=ha.glsl_value(b.b4w_water_dst_noise_scale1);c=ha.glsl_value(b.b4w_water_dst_noise_freq0);var L=ha.glsl_value(b.b4w_water_dst_noise_freq1),
r=ha.glsl_value(b.b4w_water_dir_min_shore_fac),z=ha.glsl_value(b.b4w_water_dir_freq),l=ha.glsl_value(b.b4w_water_dir_noise_scale),q=ha.glsl_value(b.b4w_water_dir_noise_freq),G=ha.glsl_value(b.b4w_water_dir_min_noise_fac),fa=ha.glsl_value(b.b4w_water_dst_min_fac),B=ha.glsl_value(b.b4w_water_waves_hor_fac);t(a,"DST_NOISE_SCALE_0",d);t(a,"DST_NOISE_SCALE_1",e);t(a,"DST_NOISE_FREQ_0",c);t(a,"DST_NOISE_FREQ_1",L);t(a,"DIR_MIN_SHR_FAC",r);t(a,"DIR_FREQ",z);t(a,"DIR_NOISE_SCALE",l);t(a,"DIR_NOISE_FREQ",
q);t(a,"DIR_MIN_NOISE_FAC",G);t(a,"DST_MIN_FAC",fa);t(a,"WAVES_HOR_FAC",B)}x(a,b);C(a,b);a.shallow_water_col.set(b.b4w_shallow_water_col);a.shore_water_col.set(b.b4w_shore_water_col);a.shallow_water_col_fac=b.b4w_shallow_water_col_fac;a.shore_water_col_fac=b.b4w_shore_water_col_fac;t(a,"ABSORB",ha.glsl_value(b.b4w_water_absorb_factor));t(a,"SSS_STRENGTH",ha.glsl_value(b.b4w_water_sss_strength));t(a,"SSS_WIDTH",ha.glsl_value(b.b4w_water_sss_width));d=a.shaders_info;e=a.common_attributes;a.shaders_info=
d;a.common_attributes=e}"HALO"===b.type&&(d=b.halo,v(a,"halo.glslv","halo.glslf"),t(a,"NUM_RINGS",d.ring_count),t(a,"NUM_LINES",d.line_count),t(a,"NUM_STARS",d.star_tip_count),t(a,"SKY_STARS",b.b4w_halo_sky_stars?1:0),a.common_attributes=["a_position"],a.halo_size=d.size,a.halo_hardness=d.hardness/20,a.halo_rings_color.set(d.b4w_halo_rings_color),a.halo_lines_color.set(d.b4w_halo_lines_color),a.halo_stars_blend=1/b.b4w_halo_stars_blend_height,a.halo_stars_height=b.b4w_halo_stars_min_height,a.halo=
!0);t(a,"TEXCOORD",0);t(a,"NORMAL_TEXCOORD",0);f&&k(a,f,"TEXTURE_COLOR0_CO");p&&k(a,p,"TEXTURE_COLOR1_CO");h&&k(a,h,"TEXTURE_STENCIL_ALPHA_MASK_CO");D&&k(a,D,"TEXTURE_SPEC_CO");I&&k(a,I,"TEXTURE_NORM_CO");t(a,"SHADELESS",b.use_shadeless?1:0);a.use_shadeless=b.use_shadeless}f=b.game_settings.alpha_blend;t(a,"ALPHA","OPAQUE"===f?0:1);t(a,"ALPHA_CLIP","CLIP"===f?1:0);t(a,"DOUBLE_SIDED_LIGHTING",b.b4w_double_sided_lighting?1:0);b.use_vertex_color_paint?(t(a,"VERTEX_COLOR",1),n(a,"a_color")):t(a,"VERTEX_COLOR",
0);a.ambient=b.ambient;a.diffuse_intensity=b.diffuse_intensity;a.emit=b.emit;a.specular_color.set(b.specular_color);a.specular_alpha=b.specular_alpha;x(a,b);C(a,b);b.b4w_wettable?t(a,"WETTABLE",1):t(a,"WETTABLE",0);s(a,b);H.glsl_unroll_hack?t(a,"UNROLL_LOOPS",1):t(a,"UNROLL_LOOPS",0);a.refractive=b.b4w_refractive;a.refr_bump=b.b4w_refr_bump;a=!0}break;case "NODES":a=A(a,b);break;case "DEPTH":if("LENS_FLARES"===b.name||b.b4w_water||b.b4w_do_not_render||"HALO"===b.type)a=!1;else if(g(a,b),a.blend)a=
!1;else{v(a,"depth.glslv","depth.glslf");n(a,"a_position");n(a,"a_normal");f=b.game_settings.alpha_blend;t(a,"ALPHA","OPAQUE"===f?0:1);a.texture_scale.set([1,1,1]);if((b=m("use_map_color_diffuse",!0,b.texture_slots)[0])&&"CLIP"===f){a.texture_scale.set(b.scale);t(a,"TEXTURE_COLOR",1);n(a,"a_texcoord");if("IMAGE"==b.texture._render.source||"ENVIRONMENT_MAP"==b.texture._render.source)f=y(b),Q(a,f,"u_colormap0");"NONE"==b.texture._render.source&&(f=y(b),Q(a,f,"u_colormap0"))}else t(a,"TEXTURE_COLOR",
0);a=!0}break;case "PHYSICS":b.b4w_collision?(a.use_ghost=b.b4w_use_ghost,a.collision_id=b.b4w_collision_id,a.collision_group=b.b4w_collision_group,a.collision_mask=b.b4w_collision_mask,a.friction=b.physics.friction,a.elasticity=b.physics.elasticity,a=!0):b.b4w_water?(a.water=!0,a.water_dynamics=b.b4w_water_dynamic,a.dst_noise_scale0=b.b4w_water_dst_noise_scale0,a.dst_noise_scale1=b.b4w_water_dst_noise_scale1,a.dst_noise_freq0=b.b4w_water_dst_noise_freq0,a.dst_noise_freq1=b.b4w_water_dst_noise_freq1,
a.dir_min_shore_fac=b.b4w_water_dir_min_shore_fac,a.dir_freq=b.b4w_water_dir_freq,a.dir_noise_scale=b.b4w_water_dir_noise_scale,a.dir_noise_freq=b.b4w_water_dir_noise_freq,a.dir_min_noise_fac=b.b4w_water_dir_min_noise_fac,a.dst_min_fac=b.b4w_water_dst_min_fac,a.waves_hor_fac=b.b4w_water_waves_hor_fac,a=!0):a=!1;break;case "COLOR_ID":if("LENS_FLARES"===b.name||b.b4w_do_not_render||"HALO"===b.type)a=!1;else{g(a,b);a.zsort_type=Y.ZSORT_DISABLED;a.depth_mask=!0;a.blend=!1;f=b.game_settings.alpha_blend;
a.xray=b.b4w_render_above_all&&"OPAQUE"!=f&&"CLIP"!=f;v(a,"color_id.glslv","color_id.glslf");n(a,"a_position");f=b.game_settings.alpha_blend;t(a,"ALPHA","OPAQUE"===f?0:1);a.texture_scale.set([1,1,1]);if((b=m("use_map_color_diffuse",!0,b.texture_slots)[0])&&"CLIP"===f){a.texture_scale.set(b.scale);t(a,"TEXTURE_COLOR",1);n(a,"a_texcoord");if("IMAGE"==b.texture._render.source||"ENVIRONMENT_MAP"==b.texture._render.source)f=y(b),Q(a,f,"u_colormap0");"NONE"==b.texture._render.source&&(f=y(b),Q(a,f,"u_colormap0"))}else t(a,
"TEXTURE_COLOR",0);a=!0}break;case "GRASS_MAP":!b.b4w_terrain||b.b4w_do_not_render?a=!1:(g(a,b),a.blend=!1,a.zsort_type=Y.ZSORT_DISABLED,a.depth_mask=!0,v(a,"grass_map.glslv","grass_map.glslf"),n(a,"a_position"),f=b.b4w_dynamic_grass_size?b.b4w_dynamic_grass_size:null,b=b.b4w_dynamic_grass_color?b.b4w_dynamic_grass_color:null,a.vertex_colors_usage.a_grass_size={generate_buffer:!0,src:[]},f?(a.vertex_colors_usage.a_grass_size.src.push({name:f,mask:4}),t(a,"DYNAMIC_GRASS_SIZE",1)):t(a,"DYNAMIC_GRASS_SIZE",
0),a.vertex_colors_usage.a_grass_color={generate_buffer:!0,src:[]},b?(a.vertex_colors_usage.a_grass_color.src.push({name:b,mask:7}),t(a,"DYNAMIC_GRASS_COLOR",1)):t(a,"DYNAMIC_GRASS_COLOR",0),H.glsl_unroll_hack?t(a,"UNROLL_LOOPS",1):t(a,"UNROLL_LOOPS",0),a=!0);break;case "WIREFRAME":"LENS_FLARES"===b.name||b.b4w_water||b.b4w_do_not_render||"HALO"===b.type?a=!1:(v(a,"wireframe.glslv","wireframe.glslf"),n(a,"a_position"),n(a,"a_normal"),n(a,"a_polyindex"),a.depth_mask=!0,a.wireframe_mode=0,a.wireframe_edge_color=
[0,0,0],H.glsl_unroll_hack?t(a,"UNROLL_LOOPS",1):t(a,"UNROLL_LOOPS",0),a=!0);break;case "PARTICLES":if(b.b4w_do_not_render)a=!1;else{f=b.texture_slots;if(a.halo_particles)v(a,"particles_color.glslv","particles_color.glslf");else if(v(a,"particles_texture.glslv","particles_texture.glslf"),f=m("use_map_color_diffuse",!0,f)[0]){t(a,"TEXTURE_COLOR",1);switch(f.blend_type){case "MIX":t(a,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MIX");break;case "MULTIPLY":t(a,"TEXTURE_BLEND_TYPE","TEXTURE_BLEND_TYPE_MULTIPLY")}a.diffuse_color_factor=
f.diffuse_color_factor;a.alpha_factor=f.use_map_alpha?f.alpha_factor:0;f=y(f);Q(a,f)}ka.set(b.diffuse_color[0],b.diffuse_color[1],b.diffuse_color[2],b.alpha,a.diffuse_color);a.ambient=b.ambient;a.diffuse_intensity=b.diffuse_intensity;a.emit=b.emit;a.specular_color.set(b.specular_color);a.specular_alpha=b.specular_alpha;n(a,"a_position");n(a,"a_normal");f=b.game_settings.alpha_blend;t(a,"ALPHA","OPAQUE"===f?0:1);t(a,"ALPHA_CLIP","CLIP"===f?1:0);t(a,"PARTICLES_SHADELESS",b.use_shadeless?1:0);x(a,b);
C(a,b);g(a,b);f=b.game_settings.alpha_blend;a.xray=b.b4w_render_above_all&&"OPAQUE"!=f&&"CLIP"!=f;a.offset_z=b.offset_z;H.glsl_unroll_hack?t(a,"UNROLL_LOOPS",1):t(a,"UNROLL_LOOPS",0);a=!0}break;default:throw"Wrong batch type: "+a.type;}return a}function k(a,b,c){switch(b.texture_coords){case "UV":case "ORCO":t(a,c,"TEXTURE_COORDS_UV_ORCO");t(a,"TEXCOORD",1);break;case "NORMAL":t(a,c,"TEXTURE_COORDS_NORMAL");t(a,"NORMAL_TEXCOORD",1);break;default:t(a,c,0)}}function g(a,b){var c=b.game_settings,d=c.alpha_blend;
switch(d){case "ALPHA_SORT":a.blend=!0;a.zsort_type=Y.ZSORT_BACK_TO_FRONT;a.depth_mask=!0;break;case "ALPHA":a.blend=!0;a.zsort_type=Y.ZSORT_DISABLED;a.depth_mask=!0;break;case "CLIP":a.blend=!1;a.zsort_type=Y.ZSORT_DISABLED;a.depth_mask=!0;break;case "ADD":a.blend=!0;a.zsort_type=Y.ZSORT_DISABLED;a.depth_mask=!1;break;case "OPAQUE":a.blend=!1;a.zsort_type=Y.ZSORT_DISABLED;a.depth_mask=!0;break;default:throw Error("Unknown alpha blend mode: "+d);}a.use_backface_culling=c.use_backface_culling}function y(a,
b){var c=a.texture,d=c._render,c=c.image;d&&b&&c&&ea.update_texture(d,b,c._is_dds,c.filepath);return d}function m(a,b,c){for(var d=[],e=c.length,f=0;f<e;f++){var g=c[f];g[a]==b&&g.texture&&g.texture._render&&d.push(g)}return d}function s(a,b){var c=b.raytrace_transparency;a.fresnel_params[0]=c.fresnel;a.fresnel_params[1]=1-c.fresnel_factor/5;c=b.raytrace_mirror;a.reflect_factor=c.reflect_factor;a.fresnel_params[2]=c.fresnel;a.fresnel_params[3]=1-c.fresnel_factor/5}function x(a,b){var c,d=0;switch(b.specular_shader){case "PHONG":case "COOKTORR":t(a,
"SPECULAR_SHADER","SPECULAR_PHONG");c=b.specular_hardness;break;case "WARDISO":t(a,"SPECULAR_SHADER","SPECULAR_WARDISO");c=b.specular_slope;break;case "TOON":t(a,"SPECULAR_SHADER","SPECULAR_TOON");c=b.specular_toon_size;d=b.specular_toon_smooth;break;default:$.error("B4W Error: unsupported specular shader: "+b.specular_shader+' (material "'+b.name+'")'),c=b.specular_hardness}a.specular_params[0]=b.specular_intensity;a.specular_params[1]=c;a.specular_params[2]=d}function C(a,b){switch(b.diffuse_shader){case "LAMBERT":t(a,
"DIFFUSE_SHADER","DIFFUSE_LAMBERT");a.diffuse_params[0]=0;a.diffuse_params[1]=0;break;case "OREN_NAYAR":t(a,"DIFFUSE_SHADER","DIFFUSE_OREN_NAYAR");a.diffuse_params[0]=b.roughness;a.diffuse_params[1]=0;break;case "FRESNEL":t(a,"DIFFUSE_SHADER","DIFFUSE_FRESNEL");a.diffuse_params[0]=b.diffuse_fresnel;a.diffuse_params[1]=b.diffuse_fresnel_factor;break;default:$.error("B4W Error: unsupported diffuse shader: "+b.diffuse_shader+' (material "'+b.name+'")'),a.diffuse_params[0]=0,a.diffuse_params[1]=0}}function A(a,
b){if(!b.use_nodes||b.b4w_do_not_render)return!1;var c=X.compose_nmat_graph(b.node_tree,b.uuid,!1);if(!c)return $.error('Failed to create node graph for material "'+b.name+'", disable nodes'),f(a,b),!0;v(a,"nodes.glslv","nodes.glslf");var d=b.game_settings.alpha_blend;t(a,"ALPHA","OPAQUE"===d?0:1);t(a,"ALPHA_CLIP","CLIP"===d?1:0);t(a,"DOUBLE_SIDED_LIGHTING",b.b4w_double_sided_lighting?1:0);n(a,"a_position");g(a,b);a.offset_z=b.offset_z;d=b.game_settings.alpha_blend;a.xray=b.b4w_render_above_all&&
"OPAQUE"!=d&&"CLIP"!=d;ka.set(b.diffuse_color[0],b.diffuse_color[1],b.diffuse_color[2],b.alpha,a.diffuse_color);a.emit=b.emit;a.ambient=b.ambient;s(a,b);b.b4w_wettable?t(a,"WETTABLE",1):t(a,"WETTABLE",0);a.node_elements=X.compose_node_elements(c);var e=!1;T.traverse(c,function(c,d){switch(d.type){case "GEOMETRY_UV":var f=d.data.name,g=d.data.value;a.uv_maps_usage||(a.uv_maps_usage={});a.uv_maps_usage[g]=f;break;case "GEOMETRY_VC":case "GEOMETRY_VC1":case "GEOMETRY_VC2":case "GEOMETRY_VC3":f=d.data.name;
a.vertex_colors_usage[f]={generate_buffer:!0,src:[{name:d.data.value}]};g=0;if("GEOMETRY_VC"==d.type)g=7;else for(var h=0;h<d.outputs.length;h++){var k="RGB".indexOf(d.outputs[h].identifier);-1<k&&(g|=1<<2-k)}a.vertex_colors_usage[f].src[0].mask=g;break;case "GEOMETRY_NO":n(a,"a_normal");break;case "MATERIAL":case "MATERIAL_EXT":f=d.data.value;n(a,"a_normal");t(a,"DIFFUSE_SHADER","DIFFUSE_"+f.diffuse_shader);t(a,"SPECULAR_SHADER","SPECULAR_"+f.specular_shader);t(a,"SHADELESS_MAT",f.use_shadeless?
1:0);a.use_shadeless=f.use_shadeless;a.specular_alpha=f.specular_alpha;e=!0;break;case "TEXTURE_COLOR":case "TEXTURE_COLOR2":case "TEXTURE_COLOR3":case "TEXTURE_COLOR4":case "TEXTURE_ENVIRONMENT":f=d.data.name;g=d.data.value;!1!==g._render.allow_node_dds&&(g._render.allow_node_dds="TEXTURE_ENVIRONMENT"!=d.type?!0:!1);Q(a,g._render,f);break;case "TEXTURE_NORMAL":case "TEXTURE_NORMAL2":case "TEXTURE_NORMAL3":case "TEXTURE_NORMAL4":case "PARALLAX":t(a,"CALC_TBN_SPACE",1);n(a,"a_normal");n(a,"a_tangent");
f=d.data.name;(g=d.data.value)?(g._render.allow_node_dds=!1,Q(a,g._render,f)):$.error("Missing texture in node ",d.name,"for material ",b.name);break;case "LAMP":d.data&&(a.lamp_uuid_indexes=d.data);break;case "REFRACTION":a.refractive=!0}});e||(a.use_shadeless=!0);H.glsl_unroll_hack?t(a,"UNROLL_LOOPS",1):t(a,"UNROLL_LOOPS",0);return!0}function f(a,b){v(a,"main.glslv","main.glslf");var c=b.game_settings.alpha_blend;t(a,"ALPHA","OPAQUE"===c?0:1);t(a,"ALPHA_CLIP","CLIP"===c?1:0);t(a,"SHADELESS",1);
n(a,"a_position");n(a,"a_normal");ka.set(1,0,1,1,a.diffuse_color);t(a,"VERTEX_COLOR",0);a.offset_z=b.offset_z;g(a,b);return!0}function E(a,b){if("PHYSICS"!==a.type){"DYNAMIC"==b.type?(b.is_hair_particles?t(a,"AU_QUALIFIER","attribute"):t(a,"AU_QUALIFIER","uniform"),t(a,"STATIC_BATCH",0)):(t(a,"AU_QUALIFIER","attribute"),t(a,"STATIC_BATCH",1));"WIREFRAME"==a.type&&(P.get_standard_derivatives()?t(a,"WIREFRAME_QUALITY",1):t(a,"WIREFRAME_QUALITY",0),a.debug_sphere?(t(a,"DEBUG_SPHERE",1),a.debug_sphere_dynamic?
t(a,"DEBUG_SPHERE_DYNAMIC",1):t(a,"DEBUG_SPHERE_DYNAMIC",0)):t(a,"DEBUG_SPHERE",0),t(a,"ALPHA",1));b.wind_bending?(""!==b.main_bend_col?(a.vertex_colors_usage.a_bending_col_main={generate_buffer:!0,src:[{name:b.main_bend_col,mask:4}]},n(a,"a_bending_col_main"),""!==b.detail_bend_col.leaves_stiffness&&""!==b.detail_bend_col.leaves_phase&&""!==b.detail_bend_col.overall_stiffness?(a.vertex_colors_usage.a_bending_col_detail={generate_buffer:!0,src:[{name:b.detail_bend_col.leaves_stiffness,mask:4},{name:b.detail_bend_col.leaves_phase,
mask:2},{name:b.detail_bend_col.overall_stiffness,mask:1}]},n(a,"a_bending_col_detail"),n(a,"a_normal"),t(a,"DETAIL_BEND",1)):t(a,"DETAIL_BEND",0),t(a,"MAIN_BEND_COL",1)):t(a,"MAIN_BEND_COL",0),t(a,"WIND_BEND",1)):t(a,"WIND_BEND",0);b.bend_center_only?t(a,"BEND_CENTER_ONLY",1):t(a,"BEND_CENTER_ONLY",0);b.billboard?t(a,"BILLBOARD",1):t(a,"BILLBOARD",0);b.billboard&&b.is_hair_particles?t(a,"HAIR_BILLBOARD",1):t(a,"HAIR_BILLBOARD",0);b.billboard_spherical?t(a,"BILLBOARD_SPHERICAL",1):t(a,"BILLBOARD_SPHERICAL",
0);switch(b.billboard_type){case "RANDOM":t(a,"BILLBOARD_RANDOM",1);t(a,"BILLBOARD_JITTERED",0);break;case "JITTERED":t(a,"BILLBOARD_RANDOM",0);t(a,"BILLBOARD_JITTERED",1);break;default:t(a,"BILLBOARD_RANDOM",0),t(a,"BILLBOARD_JITTERED",0)}b.dynamic_grass&&H.allow_vertex_textures?t(a,"DYNAMIC_GRASS",1):t(a,"DYNAMIC_GRASS",0);a.dynamic_grass=b.dynamic_grass;a.dynamic_geometry=b.dynamic_geometry;a.shadow_cast=b.shadow_cast;a.shadow_cast_only=b.shadow_cast_only;a.shadow_receive=b.shadow_receive&&!a.use_shadeless&&
!(a.blend&&H.disable_blend_shadows_hack);a.reflexible=b.reflexible;a.reflexible_only=b.reflexible_only;a.reflective=b.reflective;b.is_skinning?(n(a,"a_influence"),t(a,"SKINNED",1),b.frames_blending?t(a,"FRAMES_BLENDING",1):t(a,"FRAMES_BLENDING",0),t(a,"MAX_BONES",b.max_bones)):(t(a,"SKINNED",0),t(a,"FRAMES_BLENDING",0));b.vertex_anim?(t(a,"VERTEX_ANIM",1),H.vert_anim_mix_normals_hack?t(a,"VERTEX_ANIM_MIX_NORMALS_FACTOR",.5):t(a,"VERTEX_ANIM_MIX_NORMALS_FACTOR","u_va_frame_factor")):t(a,"VERTEX_ANIM",
0);if(b.is_skinning&&b.vertex_anim)throw"Skinning and vertex animation are mutually exlusive";b.disable_fogging?t(a,"DISABLE_FOG",1):t(a,"DISABLE_FOG",0);b.bone_pointers&&(a.bone_pointers=b.bone_pointers);if(b.mats_anim_values&&"NODES"==a.type){for(var c=a.node_elements,d=b.mats_anim_inds,e=0;e<c.length;e++){var f=c[e];switch(f.id){case "ANIM_VALUE":for(var g=f.param_values[1],h=0;h<d.length;h+=2)if(d[h]==g){f.param_values[0]=d[h+1];break}}}t(a,"NUM_ANIM_VALUES",b.mats_anim_values.length)}}}function n(a,
b){var c=a.common_attributes;-1==c.indexOf(b)&&c.push(b)}function t(a,b,c){ha.set_directive(a.shaders_info,b,c)}function M(a,b){if("PHYSICS"==a.type)a.submesh=b;else{var c=a.zsort_type,d=a.draw_mode;a.halo&&(b=Y.extract_halo_submesh(b));a.water_generated_mesh&&(b=Z.generate_multigrid(a.water_num_cascads,a.water_subdivs,a.water_detailed_dist));c=Y.submesh_to_bufs_data(b,c,d,a.vertex_colors_usage);a.dynamic_geometry||c.info_for_z_sort_updates||(c.ibo_array=null,c.vbo_array=null);a.bufs_data=c;c=b.va_frames.length;
a.num_vertices=b.base_length*c;a:switch(a.draw_mode){case Y.DM_DEFAULT:case Y.DM_TRIANGLES:case Y.DM_DYNAMIC_TRIANGLES:d=!0;break a;default:d=!1}d?Y.is_indexed(b)?a.num_triangles=b.indices.length/3*c:a.num_triangles=b.base_length/3*c:a.num_triangles=0}}function S(a,b,c,d,f,g,h,k,l,m,p,H){var n=[],s=k.b4w_dynamic_grass;if(!m&&s)return n;for(var t="INSTANCE"==k.b4w_wind_bend_inheritance,x="INSTANCE"==k.b4w_shadow_inheritance,y="INSTANCE"==k.b4w_reflection_inheritance,v=[],L=[],z=0;z<f.length;z++){var A=
f[z],C=I.clone_object_nr(b);C.billboard=k.b4w_hair_billboard;C.billboard_type=k.b4w_hair_billboard_type;C.billboard_spherical="SPHERICAL"==k.b4w_hair_billboard_geometry;C.dynamic_grass=s;C.is_hair_particles=!0;C.mats_anim_values=A._render.mats_anim_values;C.mats_anim_inds=A._render.mats_anim_inds;t?(C.wind_bending=A._render.wind_bending,C.wind_bending_angle=A._render.wind_bending_angle,C.wind_bending_freq=A._render.wind_bending_freq,C.detail_bending_freq=A._render.detail_bending_freq,C.main_bend_col=
A._render.main_bend_col,C.detail_bending_amp=A._render.detail_bending_amp,C.branch_bending_amp=A._render.branch_bending_amp,C.wind_bending_amp=A._render.wind_bending_amp,C.detail_bend_col=A._render.detail_bend_col,C.bend_center_only=!1):(C.wind_bending=a._render.wind_bending,C.wind_bending_angle=a._render.wind_bending_angle,C.wind_bending_freq=a._render.wind_bending_freq,C.detail_bending_freq=a._render.detail_bending_freq,C.main_bend_col=a._render.main_bend_col,C.detail_bending_amp=a._render.detail_bending_amp,
C.branch_bending_amp=a._render.branch_bending_amp,C.wind_bending_amp=a._render.wind_bending_amp,C.detail_bend_col=a._render.detail_bend_col,C.bend_center_only=!0);x?(C.shadow_cast=A._render.shadow_cast,C.shadow_cast_only=A._render.shadow_cast_only,C.shadow_receive=A._render.shadow_receive):(C.shadow_cast=a._render.shadow_cast,C.shadow_cast_only=a._render.shadow_cast_only,C.shadow_receive=a._render.shadow_receive);y?(C.reflexible=A._render.reflexible,C.reflexible_only=A._render.reflexible_only,C.reflective=
A._render.reflective):(C.reflexible=a._render.reflexible,C.reflexible_only=a._render.reflexible_only,C.reflective=a._render.reflective);v.push(C);var q=h[z];q||(q=new Float32Array);H&&I.init_rand_r_seed(l.seed,p);for(var G=new Float32Array(3),fa=new Float32Array([0,0,0,1]),M=[],F=0;F<q.length;F+=4){G[0]=q[F];G[1]=q[F+1];G[2]=q[F+2];var K=q[F+3];if(k.b4w_initial_rand_rotation){switch(k.b4w_rotation_type){case "XYZ":var V=new Float32Array([I.rand_r(p),I.rand_r(p),I.rand_r(p)]);ia.normalize(V,V);break;
case "Z":V=new Float32Array([0,1,0]);break;default:throw"Unsupported random rotation type: "+k.b4w_rotation_type;}qa.setAxisAngle(V,k.b4w_rand_rotation_strength*(2*Math.PI*I.rand_r(p)-Math.PI),fa)}var N=D.create_sep(G,K,fa);M.push(N)}L.push(M)}for(var O={},z=0;z<f.length;z++){var T=g[z],C=v[z],S=I.calc_variable_id(C,0),M=L[z];if(M.length)for(var P=f[z].data,Q=P.materials,F=0;F<Q.length;F++)if(!Y.has_empty_submesh(P,F))for(var X=0;X<T.length;X++){var ga=T[X];if("COLOR_ID"!==ga){var Z=r(ga),ha=Q[F];
if(e(Z,ha,!0)){Z.draw_mode=P.draw_mode||Y.DM_DEFAULT;E(Z,C);Z.odd_id_prop=k.uuid;"JITTERED"==k.b4w_hair_billboard_type&&(Z.jitter_amp=k.b4w_hair_billboard_jitter_amp,Z.jitter_freq=k.b4w_hair_billboard_jitter_freq);s&&(Z.grass_scale_threshold=k.b4w_dynamic_grass_scale_threshold);t||(delete Z.vertex_colors_usage.a_bending_col_main,delete Z.vertex_colors_usage.a_bending_col_detail);B(Z,S);var ea=Y.extract_submesh(P,F,Z.common_attributes,Z.bone_pointers,Z.vertex_colors_usage,Z.uv_maps_usage),rb=[];if(C.wind_bending||
C.dynamic_grass||C.billboard)rb.au_wind_bending_amp=[C.wind_bending_amp],rb.au_wind_bending_freq=[C.wind_bending_freq],rb.au_detail_bending_freq=[C.detail_bending_freq],rb.au_detail_bending_amp=[C.detail_bending_amp],rb.au_branch_bending_amp=[C.branch_bending_amp];var Db=Y.make_clone_submesh(ea,rb,M),rc=Db,jd=M;rc.va_common.au_center_pos=new Float32Array(3*rc.base_length);for(var Kc=jd.length,Uc=rc.base_length/Kc,sc=0;sc<Kc;sc++)for(var cd=jd[sc],Ga=3*Uc*sc,yb=0;yb<Uc;yb++)rc.va_common.au_center_pos[Ga+
3*yb]=cd[0],rc.va_common.au_center_pos[Ga+3*yb+1]=cd[1],rc.va_common.au_center_pos[Ga+3*yb+2]=cd[2];Db=rc;if(C.bend_center_only){var pb=Db,ya=a._render.world_matrix;pb.va_common.a_emitter_center=new Float32Array(3*pb.base_length);var Sa=ka.fromValues(0,0,0,1);ka.transformMat4(Sa,ya,Sa);for(var da=0;da<pb.base_length;da++)pb.va_common.a_emitter_center[3*da]=Sa[0],pb.va_common.a_emitter_center[3*da+1]=Sa[1],pb.va_common.a_emitter_center[3*da+2]=Sa[2];Db=pb}var Za=k.b4w_vcol_from_name,Eb=k.b4w_vcol_to_name,
ra=Z,Pa=c,jc=!t,Ha=P,Ka=[];if(""!==Za&&""!==Eb){var eb,tc=Eb,sa=ra.vertex_colors_usage,Xa=[],Oa=void 0;for(Oa in sa)for(var Ec=sa[Oa].src,kc=0,uc=0;uc<Ec.length;uc++){var vc=Ec[uc].mask;tc==Ec[uc].name&&Xa.push(Oa,vc,kc);kc+=I.rgb_mask_get_channels_count(vc)}eb=Xa;if(0<eb.length)for(var lb=0;lb<eb.length;lb+=3)Ka.push({emitter_attr:Za,emitter_mask:7,particle_attr:eb[lb],particle_mask:eb[lb+1],dst_channel_offset:eb[lb+2]});else Y.has_attr(ra.common_attributes,"a_color")&&Eb==Ha.active_vcol_name&&Ka.push({emitter_attr:Za,
emitter_mask:7,particle_attr:"a_color",particle_mask:7,dst_channel_offset:0})}jc&&("a_bending_col_main"in Pa.vertex_colors_usage&&Ka.push({emitter_attr:"a_bending_col_main",emitter_mask:4,particle_attr:"a_bending_col_main",particle_mask:4,dst_channel_offset:0}),"a_bending_col_detail"in Pa.vertex_colors_usage&&Ka.push({emitter_attr:"a_bending_col_detail",emitter_mask:7,particle_attr:"a_bending_col_detail",particle_mask:7,dst_channel_offset:0}));for(var sb=Db,Lb=M,Vb=d,tb=Ka,Wb=Z.vertex_colors_usage,
Mb=!1,Fa=0;Fa<tb.length;Fa++){var zb=tb[Fa].emitter_attr,Nb=Vb.va_common[zb];if(Nb&&0<Nb.length){Mb=!0;break}}if(Mb){var bc,Fb=a._render.bb_local,mb=Vb.va_frames[0].a_position,hb=Lb,J=O,Ia=new Float32Array(3),pa=new Float32Array(3),fb=new Uint32Array(hb.length);if(!("verts_indices"in J)){var wa=J,ba=Fb,La=mb;wa.cell_size=new Float32Array(3);wa.base_point=new Float32Array(3);wa.verts_indices=new Uint32Array(La.length/3);wa.octs_indices=new Uint32Array(La.length/3);wa.cell_size[0]=(ba.max_x-ba.min_x)/
20;wa.cell_size[1]=(ba.max_y-ba.min_y)/20;wa.cell_size[2]=(ba.max_z-ba.min_z)/20;wa.base_point[0]=ba.min_x;wa.base_point[1]=ba.min_y;wa.base_point[2]=ba.min_z;for(var ua=0;ua<La.length/3;ua++){var lc=La[3*ua+1],cc=La[3*ua+2],Xb=I.trunc((La[3*ua]-wa.base_point[0])/wa.cell_size[0]),Ma=I.trunc((lc-wa.base_point[1])/wa.cell_size[1]),xa=I.trunc((cc-wa.base_point[2])/wa.cell_size[2]),Xb=I.clamp(Xb,0,19),Ma=I.clamp(Ma,0,19),xa=I.clamp(xa,0,19);wa.verts_indices[ua]=ua;wa.octs_indices[ua]=xa*Math.pow(20,2)+
20*Ma+Xb}Y.sort_two_arrays(wa.octs_indices,wa.verts_indices,!0);wa.verts_offsets=new Uint32Array(Math.pow(20,3));for(ua=0;ua<wa.octs_indices.length;ua++)wa.verts_offsets[wa.octs_indices[ua]]++;delete wa.octs_indices;for(ua=1;ua<wa.verts_offsets.length;ua++)wa.verts_offsets[ua]+=wa.verts_offsets[ua-1]}for(var Yb=0;Yb<hb.length;Yb++){Ia[0]=hb[Yb][0];Ia[1]=hb[Yb][1];Ia[2]=hb[Yb][2];for(var jb=1E10,Vc=-1,vd=I.trunc((Ia[0]-J.base_point[0])/J.cell_size[0]),Wc=I.trunc((Ia[1]-J.base_point[1])/J.cell_size[1]),
Lc=I.trunc((Ia[2]-J.base_point[2])/J.cell_size[2]),vd=I.clamp(vd,0,19),Wc=I.clamp(Wc,0,19),Lc=I.clamp(Lc,0,19),dc=Lc*Math.pow(20,2)+20*Wc+vd,Mc=J.verts_offsets[dc],$a=0==dc?0:J.verts_offsets[dc-1];$a<Mc;$a++){var wc=J.verts_indices[$a];pa[0]=mb[3*wc];pa[1]=mb[3*wc+1];pa[2]=mb[3*wc+2];ia.sub(pa,Ia,pa);var Gb=ia.sqrLen(pa);Gb<=jb&&(jb=Gb,Vc=wc)}if(-1==Vc)for($a=0;$a<mb.length/3;$a++)pa[0]=mb[3*$a],pa[1]=mb[3*$a+1],pa[2]=mb[3*$a+2],ia.sub(pa,Ia,pa),Gb=ia.sqrLen(pa),Gb<=jb&&(jb=Gb,Vc=$a);fb[Yb]=Vc}bc=
fb;for(var dd=sb.base_length/Lb.length,Fa=0;Fa<tb.length;Fa++){var Ab=tb[Fa].particle_attr,Zb=tb[Fa].particle_mask,zb=tb[Fa].emitter_attr,Bb=tb[Fa].emitter_mask,Nb=Vb.va_common[zb];switch(Ab){case "a_bending_col_main":var ub=1;break;case "a_bending_col_detail":ub=3;break;case "a_color":ub=3;break;default:for(var $b=ub=0;$b<Wb[Ab].src.length;$b++)ub+=I.rgb_mask_get_channels_count(Wb[Ab].src[$b].mask)}if(Nb&&0<Nb.length){var xc=I.rgb_mask_get_channels_count(Bb),mc=I.rgb_mask_get_channels_count(Zb),
Xc=Bb&Zb,nc=I.rgb_mask_get_channels_presence(Xc);Xc!=Zb&&$.error("Wrong color extraction from "+zb+" to "+Ab+".");if("a_bending_col_main"==Ab||"a_bending_col_detail"==Ab)sb.va_common[Ab]=new Float32Array(sb.base_length*mc);for($b=0;$b<Lb.length;$b++){var ec=bc[$b],ed=ec*xc,Ob=$b*dd*ub;if(-1!=ec)for(var ab=0;ab<dd;ab++)for(var Pb=ab*ub,kb=0;kb<nc.length;kb++)if(nc[kb]){var kd=I.rgb_mask_get_channel_presence_index(Bb,kb),yc=tb[Fa].dst_channel_offset+I.rgb_mask_get_channel_presence_index(Zb,kb);sb.va_common[Ab][Ob+
Pb+yc]=Nb[ed+kd]}}}else sb.va_common[Ab]=new Float32Array(0)}}Db=sb;n.push({batch:Z,submesh:Db,mat_names:[ha.name],render:C,rel_objects:[a]})}}}}return n}function z(a){return D.create_sep(a.trans,a.scale,a.quat)}function B(a,b){for(var c=null,d=null,e=null,f=0;f<a.textures.length;f++){var g=a.textures[f].offscreen_scene;g&&(c||(c={}),c[f]=g,a.textures[f].offscreen_scene=null);if(g=a.textures[f].canvas_context)d||(d={}),d[f]=g,a.textures[f].canvas_context=null;if(g=a.textures[f].video_file)e||(e={}),
e[f]=g,a.textures[f].video_file=null}a.id=0;a.render_id=b;a.id=I.calc_variable_id(a,b);if(c)for(f in c)a.textures[f].offscreen_scene=c[f];if(d)for(var h in d)a.textures[h].canvas_context=d[h];if(e)for(h in e)a.textures[h].video_file=e[h]}function K(a,b,c,d,e){var f=r("WIREFRAME");v(f,"wireframe.glslv","wireframe.glslf");f.wireframe_mode=0;f.debug_sphere=!0;f.depth_mask=!0;f.odd_id_prop=c;e&&(f.debug_sphere_dynamic=!0);E(f,b);B(f,I.calc_variable_id(b,0));d?(b=Z.generate_uv_sphere(16,8,1,a.center,!1,
!1),Y.scale_submesh_xyz(b,[a.axis_x[0],a.axis_y[1],a.axis_z[2]],a.center)):b=Z.generate_uv_sphere(16,8,a.radius,a.center,!1,!1);Y.submesh_drop_indices(b,1,!0);b.va_common.a_polyindex=Y.extract_polyindices(b);M(f,b);return f}function v(a,b,c){a.shaders_info={vert:b,frag:c,directives:[]};ha.set_default_directives(a.shaders_info)}function Q(a,b,c){1==a.textures.length&&0==a.texture_names.length&&a.texture_names.push("default0");c=c||"default"+String(a.textures.length);-1==a.texture_names.indexOf(c)&&
(a.textures.push(b),a.texture_names.push(c))}function O(a){if(!a.shaders_info)throw"No shaders info for batch "+a.name;a.shader=ha.get_compiled_shader(a.shaders_info,a.node_elements);N.assign_uniform_setters(a.shader);N.assign_attribute_setters(a)}function L(a,b,c){var d=a.shaders_info;ha.set_directive(d,"SHADOW_SRC",b);ha.set_directive(d,"SHADOW_DST",c);return a}var G=q("__boundings"),V=q("__config"),$=q("__print"),P=q("__extensions"),Y=q("__geometry"),T=q("__graph"),X=q("__nodemat"),p=q("__objects"),
ga=q("__particles"),Z=q("__primitives");q("__reformer");var N=q("__renderer"),F=q("__scenegraph");q("__scenes");var ha=q("__shaders"),ea=q("__textures"),D=q("__tsr"),I=q("__util"),ia=q("vec3"),ka=q("vec4"),qa=q("quat"),H=V.defaults,fa=["MAIN","NODES"];a.init_batch=r;a.generate_main_batches=function(a,b,e,f,g){for(var h=[],k=[],l=0;l<e.length;l++){var m=e[l];switch(m._render.type){case "DYNAMIC":h.push(m);break;case "STATIC":k.push(m)}}e=[];e=e.concat(c(h,a,g));b=e=e.concat(d(k,a,b,g));l=[];m=[];g=
{};for(e=0;e<b.length;e++){var k=b[e].batch,s=b[e].render,h=null;if(k.id in g){var t=g[k.id],D=m[t].batch,x=m[t].render,C=null,L=null;for(a=0;a<k.textures.length;a++){var A=k.textures[a].canvas_context;A&&(C||(C={}),C[a]=A,k.textures[a].canvas_context=null);if(A=k.textures[a].video_file)L||(L={}),L[a]=A,k.textures[a].video_file=null}I.strict_objs_is_equal(k,D)&&I.strict_objs_is_equal(s,x)&&(h=m[t]);if(C)for(a in C)k.textures[a].canvas_context=C[a];if(L)for(a in L)k.textures[a].video_file=L[a];if(!h){do k.id++;
while(g[k.id])}}h||(h={batch:k,render:b[e].render,rel_objects:[],submeshes:[],mat_names:[]},g[k.id]=m.length,m.push(h));h.rel_objects=h.rel_objects.concat(b[e].rel_objects);b[e].submesh&&b[e].submesh.base_length&&h.submeshes.push(b[e].submesh);if(h.mat_names.length)for(a=0;a<b[e].mat_names.length;a++)k=b[e].mat_names[a],-1==h.mat_names.indexOf(k)&&h.mat_names.push(k);else h.mat_names=b[e].mat_names}for(e=0;e<m.length;e++){b=m[e].submeshes;if(0==b.length)a=I.create_empty_submesh(I.unique_name("%empty"));
else if(1==b.length)a=b[0];else{g=[];for(a=0;a<b.length;a++)Y.is_long_submesh(b[a])||g.push(a);if(g.length<b.length)for(a=0;a<g.length;a++)Y.submesh_drop_indices(b[g[a]]);a=Y.submesh_list_join(b)}l.push({batch:m[e].batch,render:m[e].render,submesh:a,mat_names:m[e].mat_names,rel_objects:m[e].rel_objects})}e=l;for(l=0;l<e.length;l++)M(e[l].batch,e[l].submesh),e[l].batch.material_names=e[l].mat_names;a=[];for(l=0;l<e.length;l++)if(b=e[l].batch,"STATIC"==e[l].render.type)m=I.init_object(I.unique_name("%meta"),
"MESH"),m._render=e[l].render,m._batches=[b],a.push(m);else for(g=[],h=0;h<e[l].rel_objects.length;h++)if(m=e[l].rel_objects[h],-1==g.indexOf(m.name)){for(k=0;k<m._batches.length;k++)if(m._batches[k]==b)throw"Batch already exist in object";m._batches.push(b);g.push(m.name)}if(H.wireframe_debug){for(l=0;l<e.length;l++)b=e[l].render,"DYNAMIC"==b.type&&(m=e[l].rel_objects[0],-1<fa.indexOf(e[l].batch.type)&&(b=K(b.be_local,b,m.name,!0,!0),m._batches.push(b)));for(l=0;l<a.length;l++)m=a[l],b=m._render,
-1<fa.indexOf(m._batches[0].type)&&(b=K(b.bs_local,b,m.name,!1),m._batches.push(b))}m=null;if(f.texture_slots)for(l=0;l<f.texture_slots.length;l++)if(f.texture_slots[l].texture.b4w_use_as_skydome){m=y(f.texture_slots[l],null);break}if(f.b4w_sky_settings.procedural_skydome||m)b=r("MAIN"),v(b,"special_skydome.glslv","special_skydome.glslf"),f.b4w_sky_settings.procedural_skydome?b.procedural_sky=!0:Q(b,m,"u_sky"),f.b4w_sky_settings.reflexible&&(b.reflexible=!0,f.b4w_sky_settings.reflexible_only&&(b.reflexible_only=
!0)),n(b,"a_position"),b.offset_z=99999,f=Z.generate_fullscreen_quad(),M(b,f),m=I.init_object(I.unique_name("%meta"),"MESH"),m._render=p.create_render("DYNAMIC"),m._render.do_not_cull=!0,m._render.bb_local=G.zero_bounding_box(),m._render.bs_local=G.zero_bounding_sphere(),m._render.bb_world=G.zero_bounding_box(),m._render.bs_world=G.zero_bounding_sphere(),m._batches=[b],a.push(m);return a};a.wb_angle_to_amp=function(a,b,c){if(b)b=c*(b.max_y-b.min_y);else throw"No bounding box for mesh";if(0==b)return 0;
a=b*Math.tan(a/180*Math.PI);return.5*(Math.sqrt(2*Math.sqrt(4*a+1)+2)/2-1)/b};a.bb_bpy_to_b4w=l;a.get_batch_texture=y;a.assign_shadow_receive_dirs=function(a,b){t(a,"CSM_SECTION0",0);t(a,"CSM_SECTION1",0);t(a,"CSM_SECTION2",0);t(a,"CSM_SECTION3",0);for(var c=0;c<b.csm_num;c++)t(a,"CSM_SECTION"+String(c),1);t(a,"SHADOW_TEX_RES",ha.glsl_value(b.csm_resolution));t(a,"CSM_FADE_LAST_CASCADE",b.fade_last_cascade?1:0);t(a,"CSM_BLEND_BETWEEN_CASCADES",b.blend_between_cascades?1:0)};a.set_batch_directive=
t;a.get_batch_directive=function(a,b){return ha.get_directive(a.shaders_info,b)};a.append_texture=Q;a.replace_texture=function(a,b,c){c=a.texture_names.indexOf(c);-1<c&&(a.textures[c]=b)};a.create_shadeless_batch=function(a,b,c){var d=r("MAIN");1>c&&(d.blend=!0);ka.set(b[0],b[1],b[2],c,d.diffuse_color);d.draw_mode=Y.DM_TRIANGLES;M(d,a);v(d,"main.glslv","main.glslf");t(d,"SHADELESS",1);O(d);return d};a.update_shader=O;a.check_batch_perm_uniform=function(a,b){return a.shader.permanent_uniform_setters.length?
a.shader.permanent_uniform_setters_table[b]?!0:!1:!1};a.create_shadow_batch_form_depth=function(a,b,c){var d=r("DEPTH");d.use_backface_culling=a.use_backface_culling;d.texture_scale.set(a.texture_scale);d.dynamic_grass=a.dynamic_grass;d.bufs_data=a.bufs_data;d.id=a.id;d.render_id=a.render_id;a.textures.length&&(d.textures[0]=a.textures[0],d.texture_names[0]=a.texture_names[0]);d.common_attributes=a.common_attributes;d.jitter_amp=a.jitter_amp;d.jitter_freq=a.jitter_freq;d.grass_scale_threshold=a.grass_scale_threshold;
d.num_triangles=a.num_triangles;d.num_vertices=a.num_vertices;d.odd_id_prop=a.odd_id_prop;for(var e=0;e<a.material_names.length;e++)d.material_names.push(a.material_names[e]);d.particle_system=a.particle_system;a.childs||(a.childs=[]);a.childs.push(d);v(d,"depth.glslv","depth.glslf");ha.inherit_directives(d.shaders_info,a.shaders_info);return d=L(d,b,c)};a.update_batch_shadow_src_dst=L;a.create_depth_pack_batch=function(a){a=r("DEPTH_PACK");a.use_backface_culling=!0;a.depth_mask=!1;var b=Z.generate_billboard();
M(a,b);v(a,"postprocessing/postprocessing.glslv","postprocessing/depth_pack.glslf");O(a);return a};a.create_postprocessing_batch=function(a){var b=r("POSTPROCESSING");v(b,"postprocessing/postprocessing.glslv","postprocessing/postprocessing.glslf");switch(a){case "NONE":t(b,"POST_EFFECT","POST_EFFECT_NONE");b.texel_mask[0]=1;b.texel_mask[1]=1;break;case "GRAYSCALE":t(b,"POST_EFFECT","POST_EFFECT_GRAYSCALE");b.texel_mask[0]=1;b.texel_mask[1]=1;break;case "X_BLUR":t(b,"POST_EFFECT","POST_EFFECT_X_BLUR");
b.texel_mask[0]=1;b.texel_mask[1]=0;break;case "Y_BLUR":t(b,"POST_EFFECT","POST_EFFECT_Y_BLUR");b.texel_mask[0]=0;b.texel_mask[1]=1;break;case "X_EXTEND":t(b,"POST_EFFECT","POST_EFFECT_X_EXTEND");b.texel_mask[0]=1;b.texel_mask[1]=0;break;case "Y_EXTEND":t(b,"POST_EFFECT","POST_EFFECT_Y_EXTEND");b.texel_mask[0]=0;b.texel_mask[1]=1;break;default:throw"Wrong postprocessing effect: "+a;}b.use_backface_culling=!0;b.depth_mask=!1;a=Z.generate_billboard();M(b,a);O(b);return b};a.create_edge_batch=function(a){a=
r("EDGE");a.depth_mask=!1;a.use_backface_culling=!0;a.texel_mask[0]=1;a.texel_mask[1]=1;var b=Z.generate_billboard();M(a,b);v(a,"postprocessing/postprocessing.glslv","postprocessing/edge.glslf");O(a);return a};a.create_ssao_batch=function(a){var b=r("SSAO");b.depth_mask=!1;b.use_backface_culling=!0;b.texel_mask[0]=1;b.texel_mask[1]=1;var c=Z.generate_billboard();M(b,c);v(b,"postprocessing/postprocessing.glslv","postprocessing/ssao.glslf");t(b,"SSAO_QUALITY","SSAO_QUALITY_"+a.ssao_samples);t(b,"SSAO_HEMISPHERE",
a.ssao_hemisphere?1:0);a={texture:ea.generate_texture("SSAO_TEXTURE",a)};c={width:4,height:4,data:new Uint8Array([150,123,254,0,127,3,97,0,164,246,99,0,155,177,14,0,54,83,221,0,2,142,143,0,32,57,79,0,49,160,32,0,57,232,115,0,178,216,203,0,70,196,218,0,241,164,82,0,225,58,85,0,233,88,189,0,144,25,203,0,117,73,12,0])};a=y(a,c);Q(b,a,"u_ssao_special_tex");O(b);return b};a.create_ssao_blur_batch=function(a){var b=r("SSAO_BLUR");b.depth_mask=!1;b.use_backface_culling=!0;b.texel_mask[0]=1;b.texel_mask[1]=
1;var c=Z.generate_billboard();M(b,c);v(b,"postprocessing/postprocessing.glslv","postprocessing/ssao_blur.glslf");t(b,"SSAO_BLUR_DEPTH",a.ssao_blur_depth?1:0);O(b);return b};a.create_dof_batch=function(a){a=r("DOF");a.depth_mask=!1;a.use_backface_culling=!0;a.texel_mask[0]=1;a.texel_mask[1]=1;var b=Z.generate_billboard();M(a,b);v(a,"postprocessing/postprocessing.glslv","postprocessing/dof.glslf");t(a,"DEPTH_RGBA",1);O(a);return a};a.create_glow_batch=function(){var a=r("GLOW");a.depth_mask=!1;a.use_backface_culling=
!0;a.texel_mask[0]=1;a.texel_mask[1]=1;var b=Z.generate_billboard();M(a,b);v(a,"postprocessing/postprocessing.glslv","postprocessing/glow.glslf");O(a);return a};a.create_god_rays_batch=function(a,b,c,d){a=r("GOD_RAYS");a.depth_mask=!1;a.use_backface_culling=!0;a.texel_mask[0]=1;a.texel_mask[1]=1;var e=Z.generate_billboard();M(a,e);v(a,"postprocessing/god_rays.glslv","postprocessing/god_rays.glslf");t(a,"DEPTH_RGBA",b);t(a,"WATER_EFFECTS",c);t(a,"STEPS_PER_PASS",ha.glsl_value(d,1));O(a);return a};
a.create_god_rays_combine_batch=function(a,b){var c=r("GOD_RAYS_COM");c.depth_mask=!1;c.use_backface_culling=!0;c.texel_mask[0]=1;c.texel_mask[1]=1;var d=Z.generate_billboard();M(c,d);v(c,"postprocessing/postprocessing.glslv","postprocessing/god_rays_combine.glslf");O(c);return c};a.create_sky_batch=function(){var a=r("SKY");a.depth_mask=!1;a.use_backface_culling=!0;a.texel_mask[0]=1;a.texel_mask[1]=1;var b=Z.generate_cube();M(a,b);v(a,"procedural_skydome.glslv","procedural_skydome.glslf");t(a,"NUM_LIGHTS",
1);t(a,"WATER_EFFECTS",1);O(a);return a};a.create_antialiasing_batch=function(){var a=r("ANTIALIASING");a.depth_mask=!1;a.use_backface_culling=!0;a.texel_mask[0]=1;a.texel_mask[1]=1;a.texel_size_multiplier=1/H.resolution_factor;var b=Z.generate_billboard();M(a,b);v(a,"postprocessing/postprocessing.glslv","postprocessing/antialiasing.glslf");t(a,"AA_METHOD","AA_METHOD_FXAA_QUALITY");O(a);return a};a.create_smaa_batch=function(a){var b=r("SMAA"),c=Z.generate_billboard();M(b,c);v(b,"postprocessing/smaa.glslv",
"postprocessing/smaa.glslf");t(b,"AA_METHOD","AA_METHOD_SMAA_HIGH");t(b,"SMAA_PASS",a);t(b,"SMAA_PREDICATION",0);t(b,"SMAA_REPROJECTION",0);O(b);b.depth_mask=!1;b.use_backface_culling=!0;b.texel_mask[0]=1;b.texel_mask[1]=1;b.texel_size_multiplier=1/H.resolution_factor;return b};a.create_lanczos_batch=function(a){var b=r("LANCZOS");b.depth_mask=!1;b.use_backface_culling=!0;b.texel_size_multiplier=1/H.resolution_factor;"LANCZOS_X"==a?(b.texel_mask[0]=1,b.texel_mask[1]=0):"LANCZOS_Y"==a&&(b.texel_mask[0]=
0,b.texel_mask[1]=1);a=Z.generate_billboard();M(b,a);v(b,"postprocessing/postprocessing.glslv","postprocessing/lanczos.glslf");O(b);return b};a.create_compositing_batch=function(){var a=r("COMPOSITING");a.depth_mask=!1;a.use_backface_culling=!0;a.texel_mask[0]=1;a.texel_mask[1]=1;var b=Z.generate_billboard();M(a,b);v(a,"postprocessing/postprocessing.glslv","postprocessing/compositing.glslf");O(a);return a};a.create_motion_blur_batch=function(a){var b=r("MOTION_BLUR");b.use_backface_culling=!0;b.depth_mask=
!1;var c=Z.generate_billboard();M(b,c);v(b,"postprocessing/postprocessing.glslv","postprocessing/motion_blur.glslf");t(b,"BLUR_DECAY_THRESHOLD",ha.glsl_value(a));O(b);return b};a.create_anaglyph_batch=function(a){a=r("ANAGLYPH");a.use_backface_culling=!0;a.depth_mask=!1;var b=Z.generate_billboard();M(a,b);v(a,"postprocessing/postprocessing.glslv","postprocessing/anaglyph.glslf");O(a);return a};a.create_luminance_batch=function(){var a=r("LUMINANCE");a.depth_mask=!1;a.use_backface_culling=!0;a.texel_mask[0]=
1;a.texel_mask[1]=1;var b=Z.generate_billboard();M(a,b);v(a,"postprocessing/postprocessing.glslv","postprocessing/luminance.glslf");O(a);return a};a.create_average_luminance_batch=function(){var a=r("LUMINANCE");a.depth_mask=!1;a.use_backface_culling=!0;a.texel_mask[0]=1;a.texel_mask[1]=1;var b=Z.generate_billboard();M(a,b);v(a,"postprocessing/postprocessing.glslv","postprocessing/luminance_av.glslf");O(a);return a};a.create_luminance_trunced_batch=function(){var a=r("LUMINANCE_X_BLUR");a.depth_mask=
!1;a.use_backface_culling=!0;a.texel_mask[0]=1;a.texel_mask[1]=1;var b=Z.generate_billboard();M(a,b);v(a,"postprocessing/luminance_trunced.glslv","postprocessing/luminance_trunced.glslf");O(a);return a};a.create_bloom_blur_batch=function(a){var b=r("POSTPROCESSING");switch(a){case "X_BLUR":b.texel_mask[0]=1;b.texel_mask[1]=0;break;case "Y_BLUR":b.texel_mask[0]=0;b.texel_mask[1]=1;break;default:throw"Wrong postprocessing effect for bloom blur: "+a;}b.use_backface_culling=!0;b.depth_mask=!1;a=Z.generate_billboard();
M(b,a);v(b,"postprocessing/postprocessing.glslv","postprocessing/bloom_blur.glslf");O(b);return b};a.create_bloom_combine_batch=function(){var a=r("BLOOM");a.depth_mask=!1;a.use_backface_culling=!0;a.texel_mask[0]=1;a.texel_mask[1]=1;var b=Z.generate_billboard();M(a,b);v(a,"postprocessing/postprocessing.glslv","postprocessing/bloom_combine.glslf");O(a);return a};a.create_velocity_batch=function(){var a=r("VELOCITY");a.depth_mask=!1;a.use_backface_culling=!0;a.texel_mask[0]=1;a.texel_mask[1]=1;var b=
Z.generate_billboard();M(a,b);v(a,"postprocessing/postprocessing.glslv","postprocessing/velocity.glslf");O(a);return a};a.set_texel_size=function(a,b,c){var d=a.texel_size_multiplier;a.texel_size[0]=b*a.texel_mask[0]*d;a.texel_size[1]=c*a.texel_mask[1]*d};a.set_texel_size_mult=function(a,b){a.texel_size_multiplier=b};a.find_batch_material=function(a,b,c){a=a._batches;for(var d=null,e=0;e<a.length;e++){var f=a[e];if(-1<f.material_names.indexOf(b)&&(c&&f.type==c||!c)){if(f.childs)return f;d=null===
d?f:d}}return d};a.clear_batch=function(a){for(var b=a.textures,c=0;c<b.length;c++)ea.delete_texture(b[c].w_texture);Y.cleanup_bufs_data(a.bufs_data)}};b4w.module.__nodemat=function(a,q){function r(a,d,e){if(d in D)return D[d];for(var f=X.create(),p=a.nodes,n=a.links,t=a.animation_data,x=0;x<p.length;x++)if(!C(f,p[x],0,t))return D[d]=null;if(e&&-1==s(a,f,"GROUP_OUTPUT","group"))return null;x=O(f);if(!L(f,n,x))return null;if(e)return f;for(x=0;x<n.length;x++){e=n[x];for(var p=l(e.from_node,f),t=l(e.to_node,f),y=0;y<p.length;y++)for(var I=0;I<t.length;I++){for(var v=p[y],A=t[I],r=X.get_node_attr(f,v),z=X.get_node_attr(f,A),q=f,G=z,z=[],B=e.from_socket.identifier,
E=e.to_socket.identifier,M=r.outputs,r=0;r<M.length;r++)if(M[r].identifier==B){z.push(r);break}G=G.inputs;for(r=0;r<G.length;r++)if(G[r].identifier==E){z.push(r);break}2==z.length&&X.append_edge(q,v,A,z)}}b(f);a=s(a,f,"OUTPUT","material");if(-1==a)return D[d]=null;h(f);f=X.subgraph_node_conn(f,a,X.BACKWARD_DIR);c(f);k(f);g(f);m(f);return D[d]=f}function c(a){X.traverse(a,function(b,c){for(var e=c.inputs,f=c.outputs,g=0;g<e.length;g++)d(a,e[g],b,g,1);for(g=0;g<f.length;g++)d(a,f[g],b,g,0)})}function d(a,
b,c,d,e){if(b.is_linked){var f=!0;X.traverse_edges(a,function(a,b,g){if(!e&&a==c&&g[0]==d||e&&b==c&&g[1]==d)f=!1});f&&(b.is_linked=!1)}}function b(a){var b=[];X.traverse(a,function(c,d){switch(d.type){case "TRANSLUCENCY":X.traverse_edges(a,function(a,e,f){a==c&&"Translucency"==d.outputs[f[0]].name&&b.push(a,e,[f[0]+1,f[1]+1])})}});for(var c=0;c<b.length;c+=3)X.append_edge(a,b[c],b[c+1],b[c+2])}function l(a,b){var c=[];X.traverse(b,function(b,d){d.name==a.name&&c.push(b)});if(c.length)return c;throw"Node not found";
}function h(a){var b=[];X.traverse(a,function(a,c){"PARALLAX"!=c.type&&"REROUTE"!=c.type||b.push(a,c)});for(var c=0;c<b.length;c+=2){var d=b[c],f=b[c+1];if("PARALLAX"==f.type){var g=e(a,d,1);if(-1!=g){var h=X.get_in_edge(a,g,0);X.remove_edge(a,g,d,-1);-1!=h&&X.remove_edge(a,h,g,-1);d=X.get_node_attr(a,g);f.data=d.data;f.params[0]=d.params[0];X.remove_node(a,g)}f.inputs.splice(1,1)}else if("REROUTE"==f.type){for(var f=X.get_in_edge(a,d,0),k=X.out_edge_count(a,d),g=[],h=[],l=[],m=0;m<k;m++){var p=X.get_out_edge(a,
d,m),n=h.indexOf(p);-1!=n?l[n]+=1:(h.push(p),l.push(1),g.push(d,p))}if(-1!=f)for(k=X.get_edge_attr(a,f,d,0)[0],m=0;m<h.length;m++)for(p=0;p<l[m];p++)n=X.get_edge_attr(a,d,h[m],p)[1],X.append_edge(a,f,h[m],[k,n]);for(m=0;m<g.length;m+=2)X.remove_edge(a,g[m],g[m+1],-1)}}}function e(a,b,c){a=a.edges;for(var d=0;d<a.length;d+=3)if(a[d+1]==b&&a[d+2][1]==c)return a[d];return-1}function k(a){var b=[];X.traverse(a,function(a,c){"GEOMETRY_VC"!=c.type&&"GEOMETRY_UV"!=c.type&&"GEOMETRY_NO"!=c.type&&"GEOMETRY_FB"!=
c.type&&"GEOMETRY_VW"!=c.type&&"GEOMETRY_GL"!=c.type||b.push(a,c)});for(var c=[],d=0;d<b.length;d+=2){for(var e=b[d],f=b[d+1],g=!0,h=0;h<c.length;h++){var k=c[h];if(y(f,k.attr)){g=[];h=X.out_edge_count(a,e);for(p=0;p<h;p++){var l=X.get_out_edge(a,e,p),m=X.get_edge_attr(a,e,l,0);g.push(e,l,m);X.append_edge(a,k.id,l,m)}for(var p=0;p<g.length;p+=3)X.remove_edge(a,g[p],g[p+1],0);X.remove_node(a,e);g=!1;break}}g&&(k={id:e,attr:f},c.push(k))}}function g(a){var b=[];X.traverse(a,function(a,c){"TEXTURE_COLOR"!=
c.type&&"TEXTURE_NORMAL"!=c.type||b.push(a,c)});for(var c=[],d=0;d<b.length;d+=2){for(var e=b[d],f=b[d+1],g=!0,h=0;h<c.length;h++){var k=c[h];if(!(3<=k.merged_nodes.length)&&y(f,k.attr)){for(var h=[],l=X.in_edge_count(a,e),g={},m=0;m<l;m++){var p=X.get_in_edge(a,e,m);p in g||(g[p]=0);var n=X.get_edge_attr(a,p,e,g[p]++);h.push(p,e,n)}for(var l=[],g=X.out_edge_count(a,e),s={},m=0;m<g;m++)p=X.get_out_edge(a,e,m),p in s||(s[p]=0),n=X.get_edge_attr(a,e,p,s[p]++),l.push(e,p,n);for(var g=h.concat(l),m=0;m<
g.length;m+=3)X.remove_edge(a,g[m],g[m+1],0);X.remove_node(a,e);m={attr:f,edges_in:h,edges_out:l};k.merged_nodes.push(m);g=!1;break}}g&&(k={id:e,attr:f,merged_nodes:[]},c.push(k))}for(d=0;d<c.length;d++){k=c[d];e=k.merged_nodes.length;l=k.attr.inputs.length;g=k.attr.outputs.length;for(h=0;h<e;h++){n=k.merged_nodes[h];m=n.attr;f=n.edges_in;s=n.edges_out;k.attr.inputs=k.attr.inputs.concat(m.inputs);k.attr.outputs=k.attr.outputs.concat(m.outputs);for(m=0;m<k.attr.inputs.length;m++)k.attr.inputs[m].identifier+=
ga.trunc(m/l)+1;for(m=0;m<k.attr.outputs.length;m++)k.attr.outputs[m].identifier+=ga.trunc(m/g)+1;for(m=0;m<f.length;m+=3)p=f[m],n=f[m+2],n[1]+=(h+1)*l,X.append_edge(a,p,k.id,n);for(m=0;m<s.length;m+=3)p=s[m+1],n=s[m+2],n[0]+=(h+1)*g,X.append_edge(a,k.id,p,n)}switch(e){case 1:k.attr.type+="2";break;case 2:k.attr.type+="3";break;case 3:k.attr.type+="4"}X.remove_node(a,k.id);X.append_node(a,k.id,k.attr)}}function y(a,b){if(a.type!==b.type)return!1;switch(a.type){case "GEOMETRY_VC":case "GEOMETRY_UV":return a.data.value==
b.data.value;case "GEOMETRY_NO":case "GEOMETRY_FB":case "GEOMETRY_VW":case "GEOMETRY_GL":return!0;case "TEXTURE_COLOR":case "TEXTURE_NORMAL":return a.data.value==b.data.value;default:return!1}}function m(a){var b=[];X.traverse(a,function(a,c){"GEOMETRY_VC"==c.type&&b.push(a,c)});for(var c=0;c<b.length;c+=2){for(var d=b[c],e=b[c+1],f=!1,g=[],h=[],k=[[],[],[]],m=X.out_edge_count(a,d),l=0;l<m;l++){var p=X.get_out_edge(a,d,l);if("SEPRGB"!=X.get_node_attr(a,p).type){f=!1;break}g.push(d,p);for(var n={},
s=X.out_edge_count(a,p),f=0;f<s;f++){var t=X.get_out_edge(a,p,f);t in n||(n[t]=0);var D=X.get_edge_attr(a,p,t,n[t]++);g.push(p,t);k[D[0]].push(d,t,D)}h.push(p);f=!0}if(f){for(l=d=m=0;l<k.length;l++)k[l].length&&(m++,d|=1<<2-l);if(m){e.type+=m;e.outputs=[];for(l=0;l<k.length;l++)if(k[l].length)for(e.outputs.push({default_value:0,identifier:"RGB"[l],is_linked:!0,name:"RGB"[l]}),f=0;f<k[l].length;f+=3)k[l][f+2][0]=ga.rgb_mask_get_channel_presence_index(d,l);for(l=0;l<g.length;l+=2)X.remove_edge(a,g[l],
g[l+1],0);for(l=0;l<h.length;l++)X.remove_node(a,h[l]);for(l=0;l<k.length;l++)for(f=0;f<k[l].length;f+=3)X.append_edge(a,k[l][f],k[l][f+1],k[l][f+2])}}}}function s(a,b,c,d){a=a.nodes;for(var e=null,f=0;f<a.length;f++){var g=a[f];g.type==c&&(e=g)}return e?l(e,b)[0]:(T.error('No "'+c+'" node in node '+d),-1)}function x(a,b,c,d){return{name:a,type:b,inputs:c,outputs:d}}function C(a,b,c,d){var e=b.name,g=b.type,h=[],k=[],l=[],m=[],p=null;switch(g){case "CAMERA":k=[];l=B(b);break;case "COMBRGB":case "COMBHSV":k=
z(b);l=B(b);break;case "GEOMETRY":a:{for(var g=b.outputs,s=0;s<g.length;s++)if(g[s].is_linked){g=!0;break a}g=!1}if(!g)return!0;g=E(b,c);if(!g)return T.error("Geometry output is not supported"),!1;switch(g){case "GEOMETRY_UV":if(!b.uv_layer)return T.error('Missing uv layer in node "',b.name,'"'),!1;p=f("param_GEOMETRY_UV_a");s=f("param_GEOMETRY_UV_v");h.push(K(p));h.push(K(s));l.push(t(b,"UV"));m.push(K(s));p={name:p,value:b.uv_layer};break;case "GEOMETRY_VC":if(!b.color_layer)return T.error("Missing vertex color layer in node ",
b.name),!1;p=f("param_GEOMETRY_VC_a");s=f("param_GEOMETRY_VC_v");h.push(K(p));h.push(K(s));l.push(t(b,"Vertex Color"));m.push(K(s));p={name:p,value:b.color_layer};break;case "GEOMETRY_NO":l.push(t(b,"Normal"));break;case "GEOMETRY_FB":l.push(t(b,"Front/Back"));break;case "GEOMETRY_VW":l.push(t(b,"View"));break;case "GEOMETRY_GL":l.push(t(b,"Global"))}break;case "GROUP":s=b.node_tree_name.replace(/\.[0-9]{3,}$/g,"");switch(s){case "LINEAR_TO_SRGB":g="LINEAR_TO_SRGB";break;case "NORMAL_VIEW":case "VECTOR_VIEW":g=
"VECTOR_VIEW";break;case "SRGB_TO_LINEAR":g="SRGB_TO_LINEAR";break;case "REFLECT":g="REFLECT";break;case "REFRACTION":g="REFRACTION";break;case "PARALLAX":g="PARALLAX";if(!b.inputs[1].is_linked)return T.error('Missing texture in node "',b.name,'"'),!1;var D=f("temp_texture");m.push(K(D));break;case "CLAMP":g="CLAMP";break;case "TRANSLUCENCY":g="TRANSLUCENCY";break;case "TIME":g="TIME";break;case "SMOOTHSTEP":g="SMOOTHSTEP";break;default:l=b.node_group.node_tree;k={};for(D in l)if("links"==D||"nodes"==
D)for(k[D]=[],p=0;p<l[D].length;p++){k[D][p]={};for(var y in l[D][p])if("links"==D){k[D][p][y]={};for(var v in l[D][p][y])k[D][p][y][v]=A(l[D][p][y][v])}else k[D][p][y]=A(l[D][p][y])}else k[D]=A(l[D]);if("REPLACE"==s||"LEVELS_OF_QUALITY"==s)l=x("Group input","GROUP_INPUT",[],b.inputs),p=x("Group output","GROUP_OUTPUT",b.outputs,[]),D=null,D="REPLACE"==s||"LEVELS_OF_QUALITY"==s&&(ka.quality==Z.P_LOW||ka.force_low_quality_nodes)?{from_node:l,from_socket:l.outputs[1],to_node:p,to_socket:p.inputs[0]}:
{from_node:l,from_socket:l.outputs[0],to_node:p,to_socket:p.inputs[0]},k.nodes=[l,p],k.links=[D];l=b.name;p=k.nodes;D=k.links;for(y=0;y<p.length;y++)p[y].name=Q(p[y].type,l,p[y].name);for(y=0;y<D.length;y++)D[y].from_node.name=Q(D[y].from_node.type,l,D[y].from_node.name),D[y].to_node.name=Q(D[y].to_node.type,l,D[y].to_node.name);p={node_group_graph:r(k,b.node_group.uuid,!0),node_group_links:k.links}}k=z(b);l=B(b);"TRANSLUCENCY"==s&&(s=S("TranslucencyParams","TranslucencyParams",[0,0,0,0]),s.is_linked=
l[0].is_linked,l.push(s));break;case "LAMP":p=b.lamp;if(!p)return T.error("There is no lamp in node: "+b.name),!1;l.push(t(b,"Color"));l.push(t(b,"Light Vector"));l.push(t(b,"Distance"));l.push(t(b,"Visibility Factor"));p.uuid in I?m.push(K(f("param_LAMP_lamp_index"),I[p.uuid],1)):(I[p.uuid]=ia,m.push(K(f("param_LAMP_lamp_index"),ia++,1)));p=I;break;case "NORMAL":k=z(b);l=B(b);s=t(b,"Normal");m.push(K(f("param_NORMAL_Normal"),s.default_value,3));break;case "MAPPING":s=b.vector_type;k.push(n(b,"Vector"));
l.push(t(b,"Vector"));if(0!=N.length(b.translation)||0!=N.length(b.rotation)||b.use_max||b.use_min){var g="MAPPING_HEAVY",L=b.rotation;v=b.scale;D=b.translation;y=F.create();L=ga.euler_to_rotation_matrix(L);v=new Float32Array([v[0],0,0,0,v[1],0,0,0,v[2]]);F.multiply(L,v,y);y=ga.mat3_to_mat4(y,ha.create());switch(s){case "POINT":y[12]=D[0];y[13]=D[1];y[14]=D[2];break;case "TEXTURE":y[12]=D[0];y[13]=D[1];y[14]=D[2];y=ha.invert(y,y);break;case "NORMAL":ha.invert(y,y),ha.transpose(y,y)}m.push(K(f("param_MAPPING_HEAVY_trs_matrix"),
y,16));m.push(K(f("param_MAPPING_HEAVY_use_min"),~~b.use_min,1));m.push(K(f("param_MAPPING_HEAVY_use_max"),~~b.use_max,1));m.push(K(f("param_MAPPING_HEAVY_min_clip"),b.min,3));m.push(K(f("param_MAPPING_HEAVY_max_clip"),b.max,3))}else g="MAPPING_LIGHT",m.push(K(f("param_MAPPING_LIGHT_scale"),b.scale,3));switch(s){case "TEXTURE":m.push(K(f("param_MAPPING_vector_type"),0,1));break;case "POINT":m.push(K(f("param_MAPPING_vector_type"),1,1));break;case "VECTOR":m.push(K(f("param_MAPPING_vector_type"),2,
1));break;case "NORMAL":m.push(K(f("param_MAPPING_vector_type"),3,1))}break;case "MATERIAL":case "MATERIAL_EXT":s=n(b,"Color");s.default_value.splice(3);k.push(s);(s=n(b,"Alpha"))?k.push(s):k.push(S("Alpha","Alpha",1));s=n(b,"Spec");s.default_value.splice(3);k.push(s);p=n(b,"Normal");p.default_value.splice(3);k.push(p);l.push(t(b,"Color"));l.push(t(b,"Alpha"));l.push(t(b,"Normal"));"MATERIAL_EXT"==g&&((s=n(b,"Emit"))?k.push(s):k.push(S("Emit","Emit",0)),s=n(b,"Translucency"),s.default_value=0,s.name=
"Translucency",s.identifier="Translucency",s?k.push(s):k.push(S(s.name,s.identifier,s.default_value)),s=n(b,"Translucency"),s.default_value=[0,0,0,0],s.name="TranslucencyParams",s.identifier="TranslucencyParams",s?k.push(s):k.push(S(s.name,s.identifier,s.default_value)),(s=n(b,"Ray Mirror"))?k.push(s):k.push(S("Ray Mirror","Ray Mirror",0)),(s=n(b,"SpecTra"))?k.push(s):k.push(S("SpecTra","SpecTra",0)),l.push(t(b,"Diffuse")),l.push(t(b,"Spec")));D=0;switch(b.specular_shader){case "COOKTORR":case "PHONG":s=
b.specular_hardness;break;case "WARDISO":s=b.specular_slope;break;case "TOON":s=b.specular_toon_size;D=b.specular_toon_smooth;break;default:T.error("B4W Error: unsupported specular shader: "+b.specular_shader+' (material "'+b.material_name+'")'),s=b.specular_hardness}switch(b.diffuse_shader){case "LAMBERT":v=y=0;break;case "OREN_NAYAR":y=b.roughness;v=0;break;case "FRESNEL":y=b.diffuse_fresnel;v=b.diffuse_fresnel_factor;break;default:T.error("B4W Error: unsupported diffuse shader: "+b.diffuse_shader+
' (material "'+b.material_name+'")'),v=y=0}m.push(K(f("param_MATERIAL_diffuse"),[b.use_diffuse?1:0,y,v],3));m.push(K(f("param_MATERIAL_spec"),[b.use_specular?1:0,b.specular_intensity,s,D],4));m.push(K(f("param_MATERIAL_norm"),p.is_linked?1:0,1));p={name:b.name,value:{specular_shader:b.specular_shader,diffuse_shader:b.diffuse_shader,use_shadeless:b.use_shadeless,specular_alpha:b.specular_alpha}};break;case "MATH":switch(b.operation){case "ADD":g="MATH_ADD";break;case "SUBTRACT":g="MATH_SUBTRACT";break;
case "MULTIPLY":g="MATH_MULTIPLY";break;case "DIVIDE":g="MATH_DIVIDE";break;case "SINE":g="MATH_SINE";break;case "COSINE":g="MATH_COSINE";break;case "TANGENT":g="MATH_TANGENT";break;case "ARCSINE":g="MATH_ARCSINE";break;case "ARCCOSINE":g="MATH_ARCCOSINE";break;case "ARCTANGENT":g="MATH_ARCTANGENT";break;case "POWER":g="MATH_POWER";break;case "LOGARITHM":g="MATH_LOGARITHM";break;case "MINIMUM":g="MATH_MINIMUM";break;case "MAXIMUM":g="MATH_MAXIMUM";break;case "ROUND":g="MATH_ROUND";break;case "LESS_THAN":g=
"MATH_LESS_THAN";break;case "GREATER_THAN":g="MATH_GREATER_THAN";break;case "MODULO":g="MATH_MODULO";break;case "ABSOLUTE":g="MATH_ABSOLUTE";break;default:return T.error("Unsupported MATH operation: "+b.operation),!1}k=z(b);l=B(b);break;case "MIX_RGB":switch(b.blend_type){case "MIX":g="MIX_RGB_MIX";break;case "ADD":g="MIX_RGB_ADD";break;case "MULTIPLY":g="MIX_RGB_MULTIPLY";break;case "SUBTRACT":g="MIX_RGB_SUBTRACT";break;case "SCREEN":g="MIX_RGB_SCREEN";break;case "DIVIDE":g="MIX_RGB_DIVIDE";break;
case "DIFFERENCE":g="MIX_RGB_DIFFERENCE";break;case "DARKEN":g="MIX_RGB_DARKEN";break;case "LIGHTEN":g="MIX_RGB_LIGHTEN";break;case "OVERLAY":g="MIX_RGB_OVERLAY";break;case "DODGE":g="MIX_RGB_DODGE";break;case "BURN":g="MIX_RGB_BURN";break;case "HUE":g="MIX_RGB_HUE";break;case "SATURATION":g="MIX_RGB_SATURATION";break;case "VALUE":g="MIX_RGB_VALUE";break;case "COLOR":g="MIX_RGB_COLOR";break;case "SOFT_LIGHT":g="MIX_RGB_SOFT_LIGHT";break;case "LINEAR_LIGHT":g="MIX_RGB_LINEAR_LIGHT";break;default:return T.error("Unsupported MIX_RGB blend type: "+
b.blend_type),!1}k=z(b);l=B(b);break;case "OUTPUT":k=z(b);l=[];break;case "RGB":s=t(b,"Color");l.push(s);m.push(K(f("param_RGB_Color"),s.default_value,3));break;case "SEPRGB":case "SEPHSV":k=z(b);l=B(b);break;case "TEXTURE":if(!b.texture)return T.error("No texture attached to node: "+b.name),!1;a:{g=b.outputs;p=!1;for(s=0;s<g.length;s++)if(D=g[s],D.is_linked)switch(D.identifier){case "Color":g="ENVIRONMENT_MAP"==b.texture.type?"TEXTURE_ENVIRONMENT":"TEXTURE_COLOR";break a;case "Normal":g="TEXTURE_NORMAL";
break a;case "Value":p=!0;break;default:throw"Unknown texture output";}g=p?"ENVIRONMENT_MAP"==b.texture.type?"TEXTURE_ENVIRONMENT":"TEXTURE_COLOR":void 0}k.push(n(b,"Vector"));if("TEXTURE_COLOR"==g||"TEXTURE_ENVIRONMENT"==g)l.push(t(b,"Color")),l.push(t(b,"Value"));if("TEXTURE_NORMAL"==g){if("ENVIRONMENT_MAP"==b.texture.type)return T.error("Wrong output for ENVIRONMENT_MAP texture: "+b.name),!1;l.push(t(b,"Normal"));l.push(t(b,"Value"))}D=f("param_TEXTURE_texture");m.push(K(D));p={name:D,value:b.texture};
break;case "VALUE":a:if(d){if(g=d.action){var q=g._render.params;for(s in q)if(q=s.match(/"(.*?)"/)[1],q==b.name){D=g.name+"_"+s;break a}}D=d.nla_tracks;for(y=0;y<D.length;y++)for(v=D[y].strips,L=0;L<D[y].strips.length;L++)for(s in g=v[L].action,q=g._render.params,q)if(q=s.match(/"(.*?)"/)[1],q==b.name){D=g.name+"_"+s;break a}D=void 0}else D=null;s=t(b,"Value");D?(g="ANIM_VALUE",y={name:f("param_ANIM_VALUE_Value"),value:"0"},m.push(y),y={name:"-1",value:D},m.push(y)):(g="VALUE",m.push(K(f("param_value_value"),
s.default_value,1)));l.push(s);break;case "VECT_MATH":switch(b.operation){case "ADD":g="VECT_MATH_ADD";break;case "SUBTRACT":g="VECT_MATH_SUBTRACT";break;case "AVERAGE":g="VECT_MATH_AVERAGE";break;case "DOT_PRODUCT":g="VECT_MATH_DOT_PRODUCT";break;case "CROSS_PRODUCT":g="VECT_MATH_CROSS_PRODUCT";break;case "NORMALIZE":g="VECT_MATH_NORMALIZE";break;default:return T.error("Unsupported VECT_MATH operation: "+b.operation),!1}k=z(b);l=B(b);break;default:k=z(b),l=B(b)}e={name:e,type:g,vparams:h,inputs:k,
outputs:l,params:m,data:p};X.append_node(a,X.gen_node_id(a),e);if(e="GEOMETRY"==b.type)a:{e=b.outputs;for(m=h=0;m<e.length;m++)if(e[m].is_linked&&h++>c){e=!0;break a}e=!1}return e&&!C(a,b,++c,d)?!1:!0}function A(a){var b=typeof a;return"string"!=b&&"number"!=b&&"boolean"!=b&&a?ga.clone_object_nr(a):a}function f(a){ea[a]||(ea[a]=0);var b=a+ea[a],b=b.replace(/ /g,"_").replace(/\//g,"_");ea[a]++;return b}function E(a,b){for(var c=a.outputs,d=0,e=0;e<c.length;e++){var f=c[e];if(f.is_linked&&!(d++<b))switch(f.identifier){case "UV":return"GEOMETRY_UV";
case "Vertex Color":return"GEOMETRY_VC";case "Normal":return"GEOMETRY_NO";case "Front/Back":return"GEOMETRY_FB";case "View":return"GEOMETRY_VW";case "Global":return"GEOMETRY_GL";default:return null}}}function n(a,b){for(var c=a.inputs,d=0;d<c.length;d++){var e=c[d];if(e.identifier==b)return M(e)}return null}function t(a,b){for(var c=a.outputs,d=0;d<c.length;d++){var e=c[d];if(e.identifier==b)return M(e)}return null}function M(a){var b=a.name,c=a.identifier,d=a.is_linked;a=a.default_value;a=ga.is_vector(a)?
a.slice(0):a;return{name:b,identifier:c,is_linked:d,default_value:a}}function S(a,b,c){return{name:a,identifier:b,is_linked:!1,default_value:c}}function z(a){for(var b=[],c=0;c<a.inputs.length;c++){var d=M(a.inputs[c]);d.default_value.length&&d.default_value.splice(3);b.push(d)}return b}function B(a){for(var b=[],c=0;c<a.outputs.length;c++){var d=M(a.outputs[c]);b.push(d)}return b}function K(a,b,c){b=null===b||void 0===b?null:p.glsl_value(b,c);if(ka.shader_constants_hack&&b){c="param_MAPPING_HEAVY_trs_matrix param_MAPPING_HEAVY_min_clip param_MAPPING_HEAVY_max_clip param_MAPPING_HEAVY_use_min param_MAPPING_HEAVY_use_max param_MAPPING_LIGHT_min_clip param_MAPPING_LIGHT_max_clip param_MAPPING_LIGHT_scale param_MAPPING_vector_type".split(" ");
for(var d=!1,e=0;e<c.length;e++)if(0<=a.indexOf(c[e])){d=!0;break}d&&(b=v(b))}return{name:a,value:b}}function v(a){a=a.replace(/(,)/g,"$1 ");a=a.replace(/(^|[^0-9]|\s)(0\.0)($|[^0-9]|\s)/g,"$1ZERO_VALUE_NODES$3");a=a.replace(/(^|[^0-9]|\s)(1\.0)($|[^0-9]|\s)/g,"$1UNITY_VALUE_NODES$3");return a=a.replace(/\s+/g,"")}function Q(a,b,c){return"GROUP_INPUT"==a?b+"*GI*"+c:"GROUP_OUTPUT"==a?b+"*GO*"+c:b+"*"+c}function O(a){var b=[];X.traverse(a,function(a,c){"GROUP"==c.type&&b.push(c)});return b}function L(a,
b,c){for(var d=0;d<c.length;d++){var e=c[d].data.node_group_graph,f=c[d].data.node_group_links;if(!e)return!1;X.traverse(e,function(b,c){X.append_node(a,X.gen_node_id(a),c)});for(e=0;e<f.length;e++)b.push(f[e]);Y(c[d],b,a)}return!0}function G(a,b,c,d,e,f){switch(a.type){case "GROUP":a.name==b&&d.push(c);break;case "GROUP_INPUT":a.name.indexOf(b+"*GI*")||e.push(c);break;case "GROUP_OUTPUT":a.name.indexOf(b+"*GO*")||f.push(c)}}function V(a,b,c){for(var d=[],e=0;e<c.length;e++){for(var f=c[e],g=null,
h=0;h<b.length;h++)if(f.from_socket.identifier==b[h].to_socket.identifier){g=b[h];break}g?(f.from_node=g.from_node,f.from_socket=g.from_socket):d.push(f)}for(e=0;e<b.length;e++)a.splice(a.indexOf(b[e]),1);return d}function $(a,b){if(b.length)for(var c=b[0].from_node.name,d=0;d<a.length;d++)a[d].from_node.name==c&&b.push(a[d])}function P(a,b,c,d){for(var e=0;e<d.length;e++){for(var f=d[e],g,h=0;h<c.inputs.length;h++)if(f.from_socket.identifier==c.inputs[h].identifier){g=c.inputs[h].default_value;break}for(var h=
f,k=b,m=g,p=l(h.to_node,k),n=0;n<p.length;n++)for(var s=X.get_node_attr(k,p[n]),t=0;t<s.inputs.length;t++)if(s.inputs[t].identifier==h.to_socket.identifier){s.inputs[t].default_value=m;break}f=a.indexOf(f);-1!=f&&a.splice(f,1)}}function Y(a,b,c){for(var d=a.name,e=[],f=[],g=[],h=[],k=0;k<b.length;k++){var l=b[k];G(l.from_node,d,l,e,g,h);G(l.to_node,d,l,f,g,h)}f=V(b,f,g);e=V(b,h,e);$(b,f);P(b,c,a,f);if(e.length){var m;X.traverse(c,function(a,b){"GROUP_OUTPUT"!=b.type||b.name.indexOf(d+"*GO*")||(m=
b)});P(b,c,m,e)}}var T=q("__print"),X=q("__graph"),p=q("__shaders"),ga=q("__util"),Z=q("__config"),N=q("vec3");q("vec4");var F=q("mat3"),ha=q("mat4"),ea={},D={},I={},ia=0;new Float32Array(4);var ka=Z.defaults;a.compose_nmat_graph=r;a.compose_node_elements=function(a){var b=[],c={};ea={};var d=X.topsort(a);X.traverse(d,function(a,d){var e;e=[];for(var g=[],h=[],k=[],l=[],m=[],n=0;n<d.inputs.length;n++){var s=d.inputs[n];if(s.is_linked)e.push(null),g.push(null);else{e.push(f("in_"+d.type+"_"+s.identifier));
var w=p.glsl_value(s.default_value,0);ka.shader_constants_hack&&(0<=d.type.indexOf("MIX_RGB_")&&("Color1"==s.identifier||"Color2"==s.identifier||"Fac"==s.identifier)||0<=d.type.indexOf("MATH_")&&("Value"==s.identifier||"Value_001"==s.identifier)||0<=d.type.indexOf("VECT_MATH_")&&"Vector_001"==s.identifier)&&(w=v(w));g.push(w)}}for(n=0;n<d.outputs.length;n++)s=d.outputs[n],s.is_linked?h.push(null):h.push(f("out_"+d.type+"_"+s.identifier));for(n=0;n<d.params.length;n++)s=d.params[n],k.push(s.name),
l.push(s.value);for(n=0;n<d.vparams.length;n++)m.push(d.vparams[n].name);e={id:d.type,inputs:e,input_values:g,outputs:h,params:k,param_values:l,vparams:m};b.push(e);c[a]=e});X.traverse_edges(d,function(a,b,e){var g=X.get_node_attr(d,a);X.get_node_attr(d,b);var h=g.outputs[e[0]];a=c[a].outputs;b=c[b].inputs;g=a[e[0]]||f("out_"+g.type+"_"+h.identifier);a[e[0]]=g;b[e[1]]=g});return b};a.cleanup=function(){for(var a in D)delete D[a];for(var b in I)delete I[b];ia=0}};b4w.module.__animation=function(a,q){function r(a,b){var c=a._anim_slots[b];c&&c.finish_callback&&c.exec_finish_callback&&(c.exec_finish_callback=!1,c.finish_callback(a))}function c(a,b,c){c=a._anim_slots[c];c.type=30;var d=b.frame_start,e=b.frame_end-d+1;c.start=d;c.length=e;c.current_frame_float=d;c.animation_name=b.name;for(e=d=0;e<a.data.b4w_vertex_anim.length;e++){var f=a.data.b4w_vertex_anim[e];if(f==b)break;else d+=f.frame_end-f.frame_start+1}c.va_frame_offset=d}function d(a,b,c){a=a._anim_slots[c];
a.type=50;a.animation_name=b.name;c=b.settings;a.start=c.frame_start;a.length=c.frame_end-a.start;b.settings.b4w_cyclic||(a.length+=c.lifetime);a.particle_system=b}function b(a){return a.replace(/_B4W_BAKED$/,"")}function l(a){switch(a){case "CYCLIC":return 10;case "FINISH_RESET":return 20;case "FINISH_STOP":return 30;default:ga.panic("Wrong animation behavior")}}function h(a){var b=[];a=a.data.materials;for(var c=0;c<a.length;c++){var d=a[c].node_tree;d&&d.animation_data&&(d=d.animation_data,d.action&&
b.push(d.action))}return b}function e(a){return ga.is_mesh(a)&&a._render.vertex_anim?!0:!1}function k(a){a=a.modifiers;for(var b=0;b<a.length;b++){var c=a[b];if("ARMATURE"==c.type)return c.object}return null}function g(a,b,c){if(-1==b)for(b=0;8>b;b++){var d=a[b];d&&c(d)}else(d=a[b])&&c(d)}function y(a,b,c){E(a,b,c);r(a,c);a._render.anim_mixing&&(M(a,b),t(a,b))}function m(a,b,c){var d=b.frame_range,e=b._render,g=a._anim_slots[c];g.animation_name=b.name;g.action_frame_range=d;g.action_step=e.pierce_step;
g.action_bflags=e.bflags;g.start=d[0];g.length=d[1]-d[0];g.current_frame_float=d[0];d=ga.get_dict_length(e.bones);if(ga.is_armature(a)&&d){g.type=10;var h=s(a,b);h||(h=A(a),h=S(a,b,h),a._action_anim_cache.push(b,h));g.trans=h.trans;g.quats=h.quats;var g=a._render,h=g.skinned_renders,k=a._anim_slots[c],e=k.skinning_data,l;a:{l=g.skinning_data_cache;for(var m=0;m<l.length;m+=2)if(b==l[m]){l=l[m+1];break a}l=null}if(l)k.skinning_data=l;else{for(k=0;k<h.length;k++)l=S(a,b,h[k].bone_pointers),e.push(l);
g.skinning_data_cache.push(b,e)}g.anim_mixing&&(b=g.two_last_skeletal_slots,c>b[1]?(g=b[1],b[1]=c,b[0]=g):c>b[0]&&c<b[1]&&(b[0]=c),x(a))}else if(T.is_speaker(a)&&(e.params.volume||e.params.pitch))g.volume=e.params.volume||null,g.pitch=e.params.pitch||null,g.type=40;else if("MESH"==a.type&&f(b)){g.type=70;e=s(a,b);if(!e){e=[];k=[];l=b._render;m=a._render.mats_anim_inds;for(h in l.params)for(var p=b.name+"_"+h,n=0;n<m.length;n+=2)if(p==m[n]){e.push(m[n+1]);k.push(l.params[h]);break}e={value_inds:e,
values:k};a._action_anim_cache.push(b,e)}g.node_value_inds=e.value_inds;g.nodemat_values=e.values}else if(h=e.params.tsr){g.type=20;e=s(a,b);if(!e){e=b._render.num_pierced;k=[];l=[];for(m=0;m<e;m++)k.push(h.subarray(8*m,8*m+4)),l.push(h.subarray(8*m+4,8*m+8));e={trans:k,quats:l};a._action_anim_cache.push(b,e)}g.trans=e.trans;g.quats=e.quats;V.has_particles(a)&&V.update_start_pos(a,g.trans,g.quats)}else P.warn('B4W Warning: Incompatible action "'+b.name+'" has been applied to object "'+a.name+'"'),
g.type=60;ga.is_armature(a)&&!d&&C(a,c)}function s(a,b){for(var c=a._action_anim_cache,d=0;d<c.length;d+=2)if(b==c[d])return c[d+1];return null}function x(a){var b=a._render.two_last_skeletal_slots;if(-1!=b[0]&&-1!=b[1]){var c=a._anim_slots;a=c[b[1]].current_frame_float;var d=Math.floor(a),e=a-d,b=c[b[0]];a=b.current_frame_float;d=Math.floor(a);b.current_frame_float=d+e}}function C(a,b){var c=a._render.two_last_skeletal_slots,d=c[1];c[0]=-1;c[1]=-1;if(-1!=b)for(var e=a._anim_slots;0<=d;d--){var f=
e[d];if(f&&10==f.type)if(d>c[1])c[1]=d;else{d>c[0]&&(c[1]=d);break}}}function A(a){var b=a.data.bones;a=a.pose.bones;for(var c={},d=0;d<b.length;d++){var e=b[d].name;c[e]={bone_index:d,deform_bone_index:d,pose_bone_index:ga.get_index_for_key_value(a,"name",e),vgroup_index:-1}}return c}function f(a){a=a._render;for(var b in a.params)if(-1!=b.indexOf("nodes"))return!0;return!1}function E(a,b,c){if((c=a._anim_slots[c])&&(c.play||0==b)){var d=a._render,e=c.current_frame_float,f=c.start,g=c.length,e=e+
c.speed*b*N.framerate,h=c.type,k=c.speed;if(0<=k&&e>=f+g||0>k&&e<f)switch(c.exec_finish_callback=!0,c.behavior){case 10:e=0<=k?(e-f)%g+f:f+g-1E-6;break;case 20:e=0<=k?f:f+g-1E-6;c.play=!1;break;case 30:e=0<=k?f+g-1E-6:f,c.play=!1}c.current_frame_float=e;switch(h){case 10:if(!d.anim_mixing){e=n(c,e,F);b=e[0];f=e[1];e=e[2];d.quats_before=c.quats[b];d.quats_after=c.quats[f];d.trans_before=c.trans[b];d.trans_after=c.trans[f];d.frame_factor=e;d=d.skinned_renders;c=c.skinning_data;for(g=0;g<d.length;g++)h=
d[g],k=c[g],h.quats_before=k.quats[b],h.quats_after=k.quats[f],h.trans_before=k.trans[b],h.trans_after=k.trans[f],h.frame_factor=e;X.update_transform(a)}break;case 20:h=e=n(c,e,F);(d=ha)||(d=new Float32Array(4));var f=h[0],g=h[1],h=h[2],k=c.trans,l=k[f][1],m=k[f][2],p=k[g][1],s=k[g][2];d[0]=(1-h)*k[f][0]+h*k[g][0];d[1]=(1-h)*l+h*p;d[2]=(1-h)*m+h*s;f=e;(g=D)||(g=new Float32Array(4));h=f[1];k=f[2];l=c.quats;Z.slerp(l[f[0]].subarray(0,4),l[h].subarray(0,4),k,g);f=g;g=e[2];h=c.trans;e=(1-g)*h[e[0]][3]+
g*h[e[1]][3];c.trans_smooth_period&&(g=ea,X.get_translation(a,g),ga.smooth_v(d,g,b,c.trans_smooth_period,d));c.quat_smooth_period&&(g=I,X.get_rotation(a,g),ga.smooth_q(f,g,b,c.quat_smooth_period,f));X.set_translation(a,d);X.set_rotation(a,f);X.set_scale(a,e);X.update_transform(a);$.sync_transform(a);break;case 30:(a=F)||(a=Array(3));f=e-c.start;0>f&&(f=0);f>=c.length&&(f=c.length);b=Math.floor(f);e=b+1;f-=b;10!=c.behavior&&e==c.length&&(e=b-=1,f=1);c=c.va_frame_offset;a[0]=b+c;a[1]=e+c;a[2]=f;e=F;
d.va_frame=e[0];d.va_frame_factor=e[2];break;case 40:e=n(c,e,F);b=e[0];d=e[1];e=e[2];c.volume&&T.set_volume(a,(1-e)*c.volume[b]+e*c.volume[d]);c.pitch&&T.playrate(a,(1-e)*c.pitch[b]+e*c.pitch[d]);break;case 50:V.set_time(c.particle_system,e/N.framerate);break;case 70:e=n(c,e,F);b=e[0];d=e[1];e=e[2];f=c.nodemat_values;c=c.node_value_inds;for(g=0;g<c.length;g++)h=f[g],a._render.mats_anim_values[c[g]]=(1-e)*h[b]+e*h[d];break;case 60:break;default:throw"Unknown animation type:"+h;}}}function n(a,b,c){c||
(c=Array(3));var d=a.action_frame_range[0],e=a.action_frame_range[1]-d;b-=d;0>b&&(b=0);b>=e&&(b=e);b/=a.action_step;e=Math.floor(b);a=a.action_bflags[e]?b-e:0;c[0]=e;c[1]=e+1;c[2]=a;return c}function t(a,b){var c=a._render,d=c.anim_mix_factor,e=c.two_last_skeletal_slots,f=e[0],e=e[1];if(-1!=e){if(-1!=f){var g=a._anim_slots[f];if(g.play||0==b)var h=n(g,g.current_frame_float,F),k=h[0],l=h[1],h=h[2],m=g.quats[k],p=g.quats[l],k=g.trans[k],l=g.trans[l];else d=1}else d=1;e=a._anim_slots[e];if(e.play||0==
b)var h=n(e,e.current_frame_float,F),s=h[0],t=h[1],h=h[2];else if(-1!=f&&g.play)d=0;else return;f=e.quats[s];g=e.quats[t];s=e.trans[s];e=e.trans[t];if(1==d)c.quats_before.set(f),c.quats_after.set(g),c.trans_before.set(s),c.trans_after.set(e);else if(0==d)c.quats_before.set(m),c.quats_after.set(p),c.trans_before.set(k),c.trans_after.set(l);else{for(t=0;t<m.length;t+=4){for(var x=D,y=I,v=0;4>v;v++)x[v]=m[t+v],y[v]=f[t+v];Z.slerp(x,y,d,x);for(v=0;4>v;v++)c.quats_before[t+v]=x[v];for(v=0;4>v;v++)x[v]=
p[t+v],y[v]=g[t+v];Z.slerp(x,y,d,x);for(v=0;4>v;v++)c.quats_after[t+v]=x[v]}ga.blend_arrays(k,s,d,c.trans_before);ga.blend_arrays(l,e,d,c.trans_after)}X.update_transform(a);d=c.skinned_renders;m=c.mesh_to_arm_bone_maps;for(t=0;t<d.length;t++){p=d[t];k=m[t];for(l=0;l<k.length;l+=2)for(s=k[l],f=k[l+1],g=0;4>g;g++)p.quats_before[s+g]=c.quats_before[f+g],p.quats_after[s+g]=c.quats_after[f+g],p.trans_before[s+g]=c.trans_before[f+g],p.trans_after[s+g]=c.trans_after[f+g];p.frame_factor=h}}}function M(a,
b){var c=a._render,d=c.anim_mix_factor,e=c.anim_mix_factor_change_speed;if(0!=e){var d=c.anim_destination_mix_factor-d,f=e*b;ga.sign(d)==ga.sign(e)&&Math.abs(f)<Math.abs(d)?c.anim_mix_factor+=f:(c.anim_mix_factor=c.anim_destination_mix_factor,c.anim_mix_factor_change_speed=0)}}function S(a,b,c){for(var d=a.pose.bones,e=[],f=[],g=b._render.num_pierced,h=0;h<g;h++){for(var k=0;k<d.length;k++){var l=d[k],m=p.create(),n=b._render.bones[l.name];n&&p.copy(n.subarray(8*h,8*h+8),m);l._tsr_basis=m;l._tsr_channel_cache_valid=
!1}k=z(a,c);e.push(k.trans);f.push(k.quats)}return{trans:e,quats:f}}function z(a,b){var c=[],d=[],e=a.pose.bones,f=new Float32Array(4),g=new Float32Array(4),h;for(h in b){var k=b[h],l=k.deform_bone_index,m=e[k.pose_bone_index],k=f,n=g,s=m._chain,t=s[s.length-1],D=t._tsr_channel_cache;t._tsr_channel_cache_valid||p.identity(D);for(t=s.length-1;0<=t;t--){var m=s[t],x=m._tsr_channel_cache;if(m._tsr_channel_cache_valid)D=x;else{var y=m._tsr_local,I=m._tsr_basis;p.invert(y,ia);p.multiply(I,ia,ia);p.multiply(y,
ia,ia);p.multiply(D,ia,x);D=x;m._tsr_channel_cache_valid=!0}}m=m._tsr_channel_cache;k[0]=m[0];k[1]=m[1];k[2]=m[2];k[3]=m[3];n[0]=m[4];n[1]=m[5];n[2]=m[6];n[3]=m[7];Z.normalize(n,n);for(k=0;4>k;k++)n=4*l+k,c[n]=f[k],d[n]=g[k]}c=new Float32Array(c);d=new Float32Array(d);return{trans:c,quats:d}}function B(a,b,c,d,e,f,g){var h=a+(b-a)/2,k=K(h,d,e,f,g)-c;return.02>Math.abs(k)?h:0<k?B(a,h,c,d,e,f,g):B(h,b,c,d,e,f,g)}function K(a,b,c,d,e){var f=1-a;return b*f*f*f+3*c*f*f*a+3*d*f*a*a+e*a*a*a}function v(a,
b){a._anim_slots||(a._anim_slots=[null,null,null,null,null,null,null,null]);a._anim_slots[b]={type:null,animation_name:null,quats:null,trans:null,skinning_data:[],play:!1,behavior:20,current_frame_float:0,start:0,length:0,trans_smooth_period:0,quat_smooth_period:0,exec_finish_callback:!1,va_frame_offset:null,speed:1,volume:null,pitch:null,nodemat_values:[],node_value_inds:[]};a._action_anim_cache=a._action_anim_cache||[];-1==ka.indexOf(a)&&ka.push(a)}function Q(a,b){X.update_transform(a);$.sync_transform(a);
y(a,0,b)}function O(a,b,e){e=e||0;if(ga.is_mesh(a)){var f=ga.keysearch("name",b,a.data.b4w_vertex_anim);if(f)return v(a,e),c(a,f,e),Q(a,e),1;if((f=ga.keysearch("name",b,a.particle_systems))&&"EMITTER"==f.settings.type)return v(a,e),d(a,f,e),Q(a,e),1}if(f=ga.keysearch("name",b,qa)||ga.keysearch("name",b+"_B4W_BAKED",qa)){if(!ga.get_dict_length(f.fcurves))return P.error('No fcurves in action "'+f.name+'"'),0;v(a,e);m(a,f,e);Q(a,e);return 1}P.error('Unsupported object: "',a.name,'" or animation name: "',
b,'"');return 0}function L(a){if("MESH"!=a.type||!a.data)return!1;a=a.data.materials;if(!a)return!1;for(var b=0;b<a.length;b++){var c=a[b],d=c.node_tree;if(c.use_nodes&&d&&d.animation_data)return!0}return!1}var G=q("__config"),V=q("__particles"),$=q("__physics"),P=q("__print"),Y=q("__scenes"),T=q("__sfx"),X=q("__transform"),p=q("__tsr"),ga=q("__util");q("mat4");var Z=q("quat");q("vec4");var N=G.animation;a.OBJ_ANIM_TYPE_ARMATURE=10;a.OBJ_ANIM_TYPE_OBJECT=20;a.OBJ_ANIM_TYPE_VERTEX=30;a.OBJ_ANIM_TYPE_SOUND=
40;a.OBJ_ANIM_TYPE_PARTICLES=50;a.OBJ_ANIM_TYPE_STATIC=60;a.OBJ_ANIM_TYPE_MATERIAL=70;a.SLOT_0=0;a.SLOT_1=1;a.SLOT_2=2;a.SLOT_3=3;a.SLOT_4=4;a.SLOT_5=5;a.SLOT_6=6;a.SLOT_7=7;a.SLOT_ALL=-1;a.AB_CYCLIC=10;a.AB_FINISH_RESET=20;a.AB_FINISH_STOP=30;var F=Array(3),ha=new Float32Array(3),ea=new Float32Array(3),D=new Float32Array(4),I=new Float32Array(4),ia=new Float32Array(8);new Float32Array(16);var ka=[],qa=[];a.frame_to_sec=function(a){return a/N.framerate};a.update=function(a){for(var b=0;b<ka.length;b++){for(var c=
ka[b],d=0;8>d;d++)E(c,a,d);c._render.anim_mixing&&(M(c,a),t(c,a))}for(b=0;b<ka.length;b++)for(c=ka[b],d=0;8>d&&c._anim_slots;d++)r(c,d)};a.get_all_actions=function(){return qa};a.get_current_animation_name=function(a,c){var d=a._anim_slots[c];return d&&d.animation_name?b(d.animation_name):null};a.get_anim_names=function(a){var c=[];if(e(a))for(var d=0;d<a.data.b4w_vertex_anim.length;d++)c.push(a.data.b4w_vertex_anim[d].name);var g,d=[];for(g=0;g<qa.length;g++){var k=qa[g],l=ga.get_dict_length(k._render.bones),
m=k._render;l?"ARMATURE"==a.type&&d.push(k):m.params.volume||m.params.pitch?T.is_speaker(a)&&d.push(k):f(k)||d.push(k)}"MESH"==a.type&&(d=d.concat(h(a)));g=d;for(d=0;d<g.length;d++)c.push(b(g[d].name));if(V.has_particles(a)&&V.has_anim_particles(a))for(d=0;d<a.particle_systems.length;d++)c.push(a.particle_systems[d].name);return c};a.strip_baked_suffix=b;a.get_anim_type=function(a,b){var c=a._anim_slots[b];return c?c.type:null};a.apply_def=function(a){var b=0,f;f=[];var g=a.animation_data;if(g&&g.action){var k=
ga.get_dict_length(g.action._render.bones);"ARMATURE"!=a.type&&k||f.push(g.action)}T.is_speaker(a)&&a.data.animation_data&&a.data.animation_data.action&&f.push(a.data.animation_data.action);"MESH"==a.type&&(f=f.concat(h(a)));for(g=0;g<f.length;g++)k=f[g],ga.get_dict_length(k.fcurves)?(v(a,b),m(a,k,b),Q(a,b),a._anim_slots[b].behavior=l(a.b4w_anim_behavior),b++):P.error('No fcurves in action "'+k.name+'"');k=a.particle_systems;for(g=0;g<k.length;g++){var p=k[g],n=p.settings;"EMITTER"==n.type&&(v(a,
b),d(a,p,b),Q(a,b),a._anim_slots[b].behavior=l(a.b4w_anim_behavior),n.b4w_cyclic&&(a._anim_slots[b].behavior=10),b++)}e(a)?(v(a,b),c(a,a.data.b4w_vertex_anim[0],b),Q(a,b),a._anim_slots[b].behavior=l(a.b4w_anim_behavior)):f.length||V.has_anim_particles(a)||(v(a,0),f=a._anim_slots[0],f.type=60,f.animation_name=a.name+"_STATIC",g=Y.get_scene_timeline(Y.get_active()),f.start=g[0],f.length=g[1]-g[0]+1,Q(a,b))};a.get_first_armature_object=k;a.play=function(a,b,c){g(a._anim_slots,c,function(a){a.play=!0;
a.finish_callback=b?b:null;a.exec_finish_callback=!1});a._render.anim_mixing&&x(a)};a.stop=function(a,b){g(a._anim_slots,b,function(a){a.play=!1;a.finish_callback=null;a.exec_finish_callback=!1})};a.is_play=function(a,b){var c=a._anim_slots[b];return c?c.play:!1};a.set_current_frame_float=function(a,b,c){var d=a._anim_slots;if(-1==c)for(c=0;8>c;c++){var e=d[c];e&&(e.current_frame_float=b,y(a,0,c))}else if(e=d[c])e.current_frame_float=b,y(a,0,c)};a.get_current_frame_float=function(a,b){var c=a._anim_slots[b];
return c&&c.current_frame_float?c.current_frame_float:0};a.is_cyclic=function(a,b){var c=a._anim_slots[b];return c&&10==c.behavior};a.set_behavior=function(a,b,c){g(a._anim_slots,c,function(a){a.behavior=b})};a.get_behavior=function(a,b){var c=a._anim_slots[b];return c&&c.behavior};a.apply_smoothing=function(a,b,c,d){g(a._anim_slots,d,function(a){a.trans_smooth_period=b||0;a.quat_smooth_period=c||0})};a.remove_slot_animation=function(a,b){if(-1==b)for(var c=0;8>c;c++)a._anim_slots[c]=null;else a._anim_slots[b]=
null;a._render.anim_mixing&&C(a,b)};a.update_object_animation=y;a.is_animatable=function(a){if("ARMATURE"==a.type||k(a))return!0;var b=a.animation_data;return b&&b.action||"SPEAKER"==a.type&&a.data.animation_data&&a.data.animation_data.action||V.has_particles(a)&&V.has_anim_particles(a)||"MESH"==a.type&&a.data.b4w_vertex_anim.length||L(a)?!0:!1};a.is_animated=function(a){return a._anim_slots?!0:!1};a.calc_armature_bone_pointers=A;a.calc_pose_data=z;a.append_action=function(a){a._render={};var b=a._render;
b.pierce_step=1/N.frame_steps;var c=new RegExp(/pose.bones\[\".+\"\]/g),d=p.create(),e=function(a,b,e,f){if(-1<e.search(c)){a=b;e=e.split('"')[1];var g=d}else-1<e.indexOf("location")?(e="tsr",g=d):-1<e.indexOf("rotation_quaternion")?(e="tsr",g=d):-1<e.indexOf("scale")?(e="tsr",g=d):g=0;if(!a[e]){b=a;var h=e;if("object"==typeof g&&g.length)for(var k=g.length,l=new Float32Array(f*k),m=0;m<f;m++)for(var p=0;p<k;p++)l[m*k+p]=g[p];else if("number"==typeof g)for(l=new Float32Array(f),m=0;m<f;m++)l[m]=g;
else throw"Wrong storage default value";b[h]=l}return a[e]},f=function(a,b){if(-1<a.indexOf("location"))var c=0,d=b;else-1<a.indexOf("rotation_quaternion")?(c=4,d=0==b?3:b-1):(c=-1<a.indexOf("scale")?3:0,d=0);return c+d},g=a.fcurves,h={},k={},l=0,m;for(m in g){var n=g[m],s;for(s in n){var t=n[s]._pierced_points;l||(l=t.length);for(var D=e(h,k,m,l),x=D.length/l,y=f(m,s|0),I=0;I<l;I++)D[I*x+y]=t[I]}}var e=function(a,b){for(var c=0;c<b;c++){var d=a.subarray(8*c+4,8*c+8);Z.normalize(d,d)}},v;for(v in h)"tsr"==
v&&e(h[v],l);for(var L in k)e(k[L],l);b.params=h;b.bones=k;b.bflags=a._bflags;b.num_pierced=l;qa.push(a)};a.get_approx_curve_length=function(a,b){return(b-a)*N.frame_steps+1};a.approximate_curve=function(a,b,c,d,e,f){var g,h,k=new Float32Array(2),l=new Float32Array(2),m=new Float32Array(2),p=new Float32Array(2),n=b[1],s=b[2],t=b[a.last_frame_offset+1];a=b[a.last_frame_offset+2];for(var D=0,x=0,y=null;e<=f;e++)if(e<n)for(var I=0;I<N.frame_steps;I++)c[D++]=s;else if(e>t)for(I=0;I<N.frame_steps;I++)c[D++]=
a;else{var v=b[x],L=3;0===v&&(L+=2);0===y&&(L+=2);var C=2===v?0:1;if(b[x+1]==b[x+L+1])y=v,x+=L;else{I=0;e==b[x+1]&&(C&&(d[D]=1),c[D]=b[x+2],D++,I++);if(e==t)for(;I<N.frame_steps;I++)c[D++]=a;else for(k[0]=b[x+1],k[1]=b[x+2],0!==v?(l[0]=0,l[1]=0):0===y?(l[0]=b[x+5],l[1]=b[x+6]):(l[0]=b[x+3],l[1]=b[x+4]),0!==v?(m[0]=0,m[1]=0):(m[0]=b[x+L+3],m[1]=b[x+L+4]),p[0]=b[x+L+1],p[1]=b[x+L+2];I<N.frame_steps;I++){var r=e+I/N.frame_steps;switch(v){case 0:g=k;h=l;var A=m,z=p,q=[],G=[],E=void 0,M=void 0,F=void 0,
E=void 0;q[0]=g[0]-h[0];q[1]=g[1]-h[1];G[0]=z[0]-A[0];G[1]=z[1]-A[1];F=z[0]-g[0];E=Math.abs(q[0]);M=Math.abs(G[0]);0!=E+M&&E+M>F&&(E=F/(E+M),h[0]=g[0]-E*q[0],h[1]=g[1]-E*q[1],A[0]=z[0]-E*G[0],A[1]=z[1]-E*G[1]);C&&(d[D]=1);g=D;h=k;A=l;z=m;q=p;r=B(0,1,r,h[0],A[0],z[0],q[0]);r=K(r,h[1],A[1],z[1],q[1]);c[g]=r;D++;break;case 1:h=k[0];A=k[1];g=z=(p[1]-A)/(p[0]-h);h=A-z*h;C&&(d[D]=1);c[D]=g*r+h;D++;break;case 2:C&&(d[D]=1);c[D]=b[x+2];D++;break;default:throw"Unknown keyframe intepolation mode: "+v;}}e+1==
b[x+L+1]&&(y=v,x+=L)}}};a.first_animated=function(a){for(var b=0;b<a.length;b++)if(a[b]._anim)return a[b];return!1};a.apply=O;a.get_slot_num_by_anim=function(a,c){for(var d=a._anim_slots,e=0;e<d.length;e++){var f=d[e];if(f&&b(f.animation_name)==b(c))return e}return-1};a.get_anim_by_slot_num=function(a,c){var d=a._anim_slots[c];return d&&d.animation_name?b(d.animation_name):null};a.remove=function(a){a._anim_slots=null;a=ka.indexOf(a);-1!=a&&ka.splice(a,1)};a.remove_actions=function(a){for(var b=qa.length-
1;0<=b;b--)qa[b]._data_id==a&&qa.splice(b,1)};a.apply_to_first_empty_slot=function(a,b){if(!a._anim_slots)return O(a,b,0)?0:-1;for(var c=0;c<a._anim_slots.length;c++)if(!a._anim_slots[c])return O(a,b,c)?c:-1};a.set_skel_mix_factor=function(a,b,c){a._render.anim_mix_factor_change_speed=(b-a._render.anim_mix_factor)/c;a._render.anim_destination_mix_factor=b};a.set_speed=function(a,b,c){g(a._anim_slots,c,function(a){a.speed=b})};a.get_speed=function(a,b){return a._anim_slots[b].speed};a.get_anim_start_frame=
function(a,b){return a._anim_slots[b].start};a.get_anim_length=function(a,b){return a._anim_slots[b].length};a.has_animated_nodemats=L;a.cleanup=function(){ka.length=0;qa.length=0};a.fcurves_replace_euler_by_quat=function(a,b){var c=a[b],d=(c[0]||c[1]||c[2])._pierced_points.length,e=D,f=ha,g=Boolean(c[0]);g||(c[0]={_pierced_points:new Float32Array(d)});var h=Boolean(c[1]);h||(c[1]={_pierced_points:new Float32Array(d)});var k=Boolean(c[2]);k||(c[2]={_pierced_points:new Float32Array(d)});c[3]={_pierced_points:new Float32Array(d)};
for(var l=0;l<d;l++)f[0]=g?c[0]._pierced_points[l]:0,f[1]=h?c[1]._pierced_points[l]:0,f[2]=k?c[2]._pierced_points[l]:0,ga.euler_to_quat(f,e),c[0]._pierced_points[l]=e[3],c[1]._pierced_points[l]=e[0],c[2]._pierced_points[l]=e[1],c[3]._pierced_points[l]=e[2];d=b.replace("euler","quaternion");a[d]=c;delete a[b]}};b4w.module.__time=function(a,q){q("__util");var r=0;a.set_timeline=function(a){r=a};a.get_timeline=function(){return r}};b4w.module.__transform=function(a,q){function r(a){var f=a._render;b.update_constraint(a,n);d.update_camera(a);"CAMERA"==a.type&&d.clamp_limits(a);var m=f.trans,s=f.scale,x=f.quat;g.set_sep(m,s,x,f.tsr);var A=f.world_matrix;C.identity(A);C.fromQuat(x,A);"CAMERA"!=a.type&&y.scale_mat4(A,s,A);A[12]=m[0];A[13]=m[1];A[14]=m[2];C.invert(A,f.inv_world_matrix);a._anim_slots&&h.has_anim_particles(a)&&h.update_emitter_transform(a);f.bb_local&&f.bb_world&&(c.bounding_box_transform(f.bb_local,A,f.bb_world),
c.bounding_sphere_transform(f.bs_local,A,f.bs_world),c.bounding_ellipsoid_transform(f.be_local,f.tsr,f.be_world),f.shadow_cast&&e.schedule_shadow_update(e.get_active()));switch(a.type){case "SPEAKER":k.speaker_update_transform(a,n);break;case "CAMERA":d.update_camera_transform(a);e.check_active()&&e.get_camera(e.get_active())==a&&k.listener_update_transform(e.get_active(),m,x,n);break;case "LAMP":l.update_light_transform(a);e.check_active()&&e.update_lamp_scene(a,e.get_active());break;case "EMPTY":a.field&&
e.update_force(a)}"LAMP"!=a.type&&"CAMERA"!=a.type||!e.check_active()||(f=e.get_active(),e.schedule_shadow_update(f),e.schedule_grass_map_update(f));a=a._descends;for(f=0;f<a.length;f++)r(a[f])}var c=q("__boundings"),d=q("__camera"),b=q("__constraints"),l=q("__lights"),h=q("__particles"),e=q("__scenes"),k=q("__sfx"),g=q("__tsr"),y=q("__util"),m=q("vec3"),s=q("quat"),x=q("mat3"),C=q("mat4"),A=new Float32Array(3),f=new Float32Array(4),E=new Float32Array(9),n=0;a.SPACE_WORLD=0;a.SPACE_LOCAL=1;a.update=
function(a){n=a};a.set_translation=function(a,c){if(b.get_type(a)==b.CONS_TYPE_CHILD_OF){var d=b.get_child_of_offset(a);g.set_trans(c,d)}else a._render.trans.set(c)};a.get_translation=function(a,c){if(b.get_type(a)==b.CONS_TYPE_CHILD_OF){var d=b.get_child_of_offset(a);m.copy(g.get_trans_view(d),c)}else m.copy(a._render.trans,c)};a.set_rotation=function(a,c){if(b.get_type(a)==b.CONS_TYPE_CHILD_OF){var d=b.get_child_of_offset(a);g.set_quat(c,d)}else a._render.quat.set(c)};a.get_rotation=function(a,
c){if(b.get_type(a)==b.CONS_TYPE_CHILD_OF){var d=b.get_child_of_offset(a);s.copy(g.get_quat_view(d),c)}else s.copy(a._render.quat,c)};a.set_rotation_euler=function(a,c){if(b.get_type(a)==b.CONS_TYPE_CHILD_OF){var d=y.euler_to_quat(c,f),e=b.get_child_of_offset(a);g.set_quat(d,e)}else y.euler_to_quat(c,a._render.quat)};a.set_scale=function(a,c){if(b.get_type(a)==b.CONS_TYPE_CHILD_OF){var d=b.get_child_of_offset(a);g.set_scale(c,d)}else a._render.scale=c};a.get_scale=function(a){return b.get_type(a)==
b.CONS_TYPE_CHILD_OF?(a=b.get_child_of_offset(a),g.get_scale(a)):a._render.scale};a.get_tsr=function(a,c){if(b.get_type(a)==b.CONS_TYPE_CHILD_OF){var d=b.get_child_of_offset(a);g.copy(d,c)}else d=a._render,g.set_sep(d.trans,d.scale,d.quat,c)};a.set_tsr=function(a,c){if(b.get_type(a)==b.CONS_TYPE_CHILD_OF){var d=b.get_child_of_offset(a);g.copy(c,d)}else d=a._render,d.trans[0]=c[0],d.trans[1]=c[1],d.trans[2]=c[2],d.scale=c[3],d.quat[0]=c[4],d.quat[1]=c[5],d.quat[2]=c[6],d.quat[3]=c[7]};a.get_object_size=
function(a){var b=a._render,c=a.data.b4w_bounding_box;a=b.scale*(c.max_x-c.min_x);var d=b.scale*(c.max_y-c.min_y),b=b.scale*(c.max_z-c.min_z);return.5*Math.sqrt(a*a+d*d+b*b)};a.get_object_center=function(a,b,c){c||(c=new Float32Array(3));b?(b=a._render,m.copy(b.bs_world.center,c)):(b=a._render,a=a.data.b4w_bounding_box,c[0]=(a.max_x+a.min_x)/2,c[1]=(a.max_y+a.min_y)/2,c[2]=(a.max_z+a.min_z)/2,m.transformMat4(c,b.world_matrix,c));return c};a.move_local=function(a,b,c,d){a=a._render;A[0]=b;A[1]=c;A[2]=
d;b=x.fromMat4(a.world_matrix,E);m.transformMat3(A,b,A);m.add(a.trans,A,a.trans)};a.update_transform=r;a.distance=function(a,b){return m.dist(a._render.trans,b._render.trans)};a.obj_point_distance=function(a,b){return m.dist(a._render.trans,b)};a.get_object_bounding_box=function(a){return{max_x:a._render.bb_world.max_x,min_x:a._render.bb_world.min_x,max_y:a._render.bb_world.max_y,min_y:a._render.bb_world.min_y,max_z:a._render.bb_world.max_z,min_z:a._render.bb_world.min_z}}};b4w.module.__tsr=function(a,q){function r(a,b,c,d){d[0]=a[0];d[1]=a[1];d[2]=a[2];d[3]=b;d[4]=c[0];d[5]=c[1];d[6]=c[2];d[7]=c[3]}function c(a,b,c){var d=b[0],e=b[1],h=b[2],l=b[3],A=b[4],f=b[5],r=b[6];b=b[7];var n=a[0]*l,t=a[1]*l,q=a[2]*l;a=b*n+f*q-r*t;var l=b*t+r*n-A*q,S=b*q+A*t-f*n,n=-A*n-f*t-r*q;c[0]=a*b+n*-A+l*-r-S*-f;c[1]=l*b+n*-f+S*-A-a*-r;c[2]=S*b+n*-r+a*-f-l*-A;c[0]+=d;c[1]+=e;c[2]+=h;return c}var d=q("__util"),b=q("vec3"),l=q("quat");q("mat4");var h=new Float32Array(3),e=new Float32Array(4);
new Float32Array(16);a.create=function(){var a=new Float32Array(8);a[3]=1;a[7]=1;return a};a.copy=function(a,b){b.set(a)};a.identity=function(a){a[0]=0;a[1]=0;a[2]=0;a[3]=1;a[4]=0;a[5]=0;a[6]=0;a[7]=1;return a};a.create_sep=function(a,b,c,d){d||(d=new Float32Array(8));r(a,b,c,d);return d};a.set_sep=r;a.set_trans=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2]};a.set_scale=function(a,b){b[3]=a};a.set_transcale=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3]};a.set_quat=function(a,b){b[4]=a[0];b[5]=
a[1];b[6]=a[2];b[7]=a[3]};a.get_trans_view=function(a){return a.subarray(0,3)};a.get_scale=function(a){return a[3]};a.get_quat_view=function(a){return a.subarray(4)};a.invert=function(a,b){var c=1/a[3];if(!c)return null;var d=a[0],h=a[1],x=a[2];e[0]=a[4];e[1]=a[5];e[2]=a[6];e[3]=a[7];l.invert(e,e);var C=e[0],A=e[1],f=e[2],r=e[3],d=d*c,h=h*c,n=x*c,x=r*d+A*n-f*h,t=r*h+f*d-C*n,q=r*n+C*h-A*d,d=-C*d-A*h-f*n;b[0]=-(x*r+d*-C+t*-f-q*-A);b[1]=-(t*r+d*-A+q*-C-x*-f);b[2]=-(q*r+d*-f+x*-A-t*-C);b[3]=c;b[4]=C;
b[5]=A;b[6]=f;b[7]=r;return b};a.from_mat4=function(a,b){var c=d.matrix_to_trans(a,h),l=d.matrix_to_scale(a),s=d.matrix_to_quat(a,e);r(c,l,s,b);return b};a.multiply=function(a,b,d){c(b,a,d);d[3]=a[3]*b[3];var e=a[4],h=a[5],l=a[6];a=a[7];var C=b[4],r=b[5],f=b[6];b=b[7];d[4]=e*b+a*C+h*f-l*r;d[5]=h*b+a*r+l*C-e*f;d[6]=l*b+a*f+e*r-h*C;d[7]=a*b-e*C-h*r-l*f;return d};a.transform_vec3=c;a.transform_vectors=function(a,b,c,d){d||(d=0);var e=a.length,h=b[0],l=b[1],r=b[2],f=b[3],q=b[4],n=b[5],t=b[6];b=b[7];for(var M=
0;M<e;M+=3){var S=a[M]*f,z=a[M+1]*f,B=a[M+2]*f,K=b*S+n*B-t*z,v=b*z+t*S-q*B,Q=b*B+q*z-n*S,S=-q*S-n*z-t*B;c[d+M]=K*b+S*-q+v*-t-Q*-n;c[d+M+1]=v*b+S*-n+Q*-q-K*-t;c[d+M+2]=Q*b+S*-t+K*-n-v*-q;c[d+M]+=h;c[d+M+1]+=l;c[d+M+2]+=r}return c};a.transform_dir_vectors=function(a,b,c,d){d||(d=0);var e=a.length,h=b[3],l=b[4],r=b[5],f=b[6];b=b[7];for(var q=0;q<e;q+=3){var n=a[q]*h,t=a[q+1]*h,M=a[q+2]*h,S=b*n+r*M-f*t,z=b*t+f*n-l*M,B=b*M+l*t-r*n,n=-l*n-r*t-f*M;c[d+q]=S*b+n*-l+z*-f-B*-r;c[d+q+1]=z*b+n*-r+B*-l-S*-f;c[d+
q+2]=B*b+n*-f+S*-r-z*-l}return c};a.transform_dir_vec3=function(a,b,c){var d=b[3],e=b[4],h=b[5],l=b[6];b=b[7];var r=a[0]*d,f=a[1]*d,q=a[2]*d;a=b*r+h*q-l*f;var d=b*f+l*r-e*q,n=b*q+e*f-h*r,r=-e*r-h*f-l*q;c[0]=a*b+r*-e+d*-l-n*-h;c[1]=d*b+r*-h+n*-e-a*-l;c[2]=n*b+r*-l+a*-h-d*-e;return c};a.transform_tangents=function(a,b,c,d){d||(d=0);var e=a.length,h=b[3],l=b[4],r=b[5],f=b[6];b=b[7];for(var q=0;q<e;q+=4){var n=a[q]*h,t=a[q+1]*h,M=a[q+2]*h,S=b*n+r*M-f*t,z=b*t+f*n-l*M,B=b*M+l*t-r*n,n=-l*n-r*t-f*M;c[d+q]=
S*b+n*-l+z*-f-B*-r;c[d+q+1]=z*b+n*-r+B*-l-S*-f;c[d+q+2]=B*b+n*-f+S*-r-z*-l;c[d+q+3]=a[q+3]}return c};a.translate=function(a,b,c){var d=a[3],e=a[4],h=a[5],l=a[6],r=a[7],f=b[0]*d,q=b[1]*d,n=b[2]*d;b=r*f+h*n-l*q;var d=r*q+l*f-e*n,t=r*n+e*q-h*f,f=-e*f-h*q-l*n;c[0]=a[0]+b*r+f*-e+d*-l-t*-h;c[1]=a[1]+d*r+f*-h+t*-e-b*-l;c[2]=a[2]+t*r+f*-l+b*-h-d*-e;c[3]=a[3];c[4]=a[4];c[5]=a[5];c[6]=a[6];c[7]=a[7];return c};a.interpolate=function(a,c,d,e){e||(e=new Float32Array(8));var h=a.subarray(0,3),x=c.subarray(0,3),
r=e.subarray(0,3);b.lerp(h,x,d,r);h=a[3];e[3]=h+d*(c[3]-h);a=a.subarray(4);c=c.subarray(4);h=e.subarray(4);l.slerp(a,c,d,h);return e};a.extrapolate=function(a,b,c,d){d||(d=new Float32Array(8));var e=a.subarray(0,3),h=b.subarray(0,3),r=d.subarray(0,3);r[0]=h[0]*(c+1)-e[0]*c;r[1]=h[1]*(c+1)-e[1]*c;r[2]=h[2]*(c+1)-e[2]*c;d[3]=b[3]*(c+1)-a[3]*c;a=a.subarray(4);b=b.subarray(4);e=d.subarray(4);e[0]=b[0]*(c+1)-a[0]*c;e[1]=b[1]*(c+1)-a[1]*c;e[2]=b[2]*(c+1)-a[2]*c;e[3]=b[3]*(c+1)-a[3]*c;l.normalize(e,e);return d};
a.integrate=function(a,b,c,d,e){var h=a.subarray(0,3),r=e.subarray(0,3);r[0]=h[0]+b*c[0];r[1]=h[1]+b*c[1];r[2]=h[2]+b*c[2];e[3]=a[3];a=a.subarray(4);e=e.subarray(4);c=d[0];h=d[1];d=d[2];var r=a[0],q=a[1],f=a[2],E=a[3];e[0]=.5*(c*E+h*f-d*q);e[1]=.5*(h*E+d*r-c*f);e[2]=.5*(d*E+c*q-h*r);e[3]=.5*(-c*r-h*q-d*f);e[0]=a[0]+e[0]*b;e[1]=a[1]+e[1]*b;e[2]=a[2]+e[2]*b;e[3]=a[3]+e[3]*b;l.normalize(e,e)}};b4w.module.__util=function(a,q){function r(a,b,c){for(var d=[],e=c.length,f=0;f<e;f++){var g=c[f];g[a]==b&&d.push(g)}return d}function c(a,b){var d=a instanceof Array?[]:{},e;for(e in a)!a[e]||"object"!=typeof a[e]||-1!=b.indexOf(a[e])||a[e]instanceof Float32Array?d[e]=a[e]:d[e]=c(a[e],b);return d}function d(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=Math.sqrt(b*b+c*c+d*d),f=1/f;a[0]=b*f;a[1]=c*f;a[2]=d*f;a[3]=e*f}function b(a,b){return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]}function l(a,b){var c=b;switch(typeof a){case "number":return h(a,
c);case "string":return e(a,c);case "boolean":return h(a|0,c);case "function":case "undefined":return h(0,c);case "object":if(a){var d=a instanceof Array;if(a.buffer instanceof ArrayBuffer&&"undefined"!==a.byteLength)for(d=0;d<a.length;d++)c=h(a[d],c);else if(d)for(d=0;d<a.length;d++)c=l(a[d],c);else for(var f in a)c=l(a[f],c)}else c=h(0,c)}return c}function h(a,b){var c=b;V[0]=a;c=(c<<5)-c+$[0];c&=c;c=(c<<5)-c+$[1];return c&c}function e(a,b){for(var c=b,d=0;d<a.length;d++)var e=a.charCodeAt(d),c=
(c<<5)-c+e,c=c&c;return c}function k(a){return(34*a+1)*a%289}function g(a){return a-Math.floor(a)}function y(a){return m((34*a+5)*a)}function m(a){return a-289*Math.floor(a/289)}function s(a){return a-7*Math.floor(a/7)}function x(a,b){if(a&&b){var c=a instanceof Array,d=a.buffer instanceof ArrayBuffer&&"undefined"!==a.byteLength,e=b.buffer instanceof ArrayBuffer&&"undefined"!==b.byteLength;if(c!=b instanceof Array||d!=e)return!1;if(c){if(a.length!=b.length)return!1;for(c=0;c<a.length;c++)if(!C(a[c],
b[c]))return!1}else if(d){if(a.length!=b.length)return!1;for(c=0;c<a.length;c++)if(a[c]!=b[c])return!1}else{for(var f in a)if(!C(a[f],b[f]))return!1;for(f in b)if(!(f in a))return!1}return!0}return!(a||b)}function C(a,b){if(typeof a!=typeof b)return!1;switch(typeof a){case "number":case "string":case "boolean":return a==b;case "object":return x(a,b);default:return!0}}var A=q("__print"),f=q("vec3"),E=q("vec4"),n=q("quat"),t=q("mat3"),M=q("mat4"),S=0,z={},B=new Float32Array(3),K=new Float32Array(3),
v=new Float32Array(4),Q=new Float32Array(4),O=new Float32Array(9),L=new Float32Array(16),G=new Float32Array(16),V=new Float64Array(1),$=new Uint32Array(V.buffer),P=new Float32Array([0,0,0]),Y=new Float32Array([0,0,0,1]),T=new Float32Array([0,0,0,1,0,0,0,1]),X=new Float32Array([1,0,0]),p=new Float32Array([0,1,0]),ga=new Float32Array([0,0,1]),Z=new Float32Array([-1,0,0]),N=new Float32Array([0,-1,0]),F=new Float32Array([0,0,-1]),ha=Math.floor(44488.07041494893);a.VEC3_IDENT=P;a.QUAT4_IDENT=Y;a.TSR8_IDENT=
T;a.AXIS_X=X;a.AXIS_Y=p;a.AXIS_Z=ga;a.AXIS_MX=Z;a.AXIS_MY=N;a.AXIS_MZ=F;a.keyfind=r;a.float32_concat=function(a,b){var c=a.length,d=new Float32Array(c+b.length);d.set(a);d.set(b,c);return d};a.uint32_concat=function(a,b){var c=a.length,d=new Uint32Array(c+b.length);d.set(a);d.set(b,c);return d};a.check_endians=function(){var a=new Uint16Array([255]);return 255==(new DataView(a.buffer)).getUint16(0,!0)};a.array_intersect=function(a,b){var c=[],d={},e=b.length,f,g;for(f=0;f<e;f++)d[b[f]]=!0;e=a.length;
for(f=0;f<e;f++)g=a[f],g in d&&c.push(g);return c};a.sign=function(a){return 0<a?1:0>a?-1:0};a.keycheck=function(a,b,c){for(var d=c.length,e=0;e<d;e++)if(c[e][a]==b)return!0;return!1};a.keysearch=function(a,b,c){for(var d=0;d<c.length;d++){var e=c[d];if(e[a]===b)return e}return null};a.key2search=function(a,b,c,d,e){for(var f=0;f<e.length;f++){var g=e[f];if(g[a]==b&&g[c]==d)return g}return null};a.get_index_for_key_value=function(a,b,c){for(var d=0;d<a.length;d++)if(a[d][b]==c)return d;return-1};
a.append_unique=function(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return;a.push(b)};a.check_uniqueness=function(a){for(var b=0;b<a.length-1;b++)for(var c=a[b],d=b+1;d<a.length;d++)if(c==a[d])return!1;return!0};a.objs_by_type=function(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d];e.type==b&&c.push(e)}return c};a.objs_by_name=function(a,b){var c=r("name",b,a);1<c.length&&A.error("obj_by_name(): name resolution ambiguity");return c};a.objs_by_name_r=function(a,b){var c=r("name",b,a),d=c.length;
1<d&&A.error("obj_by_name(): name resolution ambiguity");if(0>=d)return[];for(var e=[],f=0;f<d;f++){var g=c[f];if("EMPTY"==g.type&&g.dupli_group)for(var g=g.dupli_group.objects,h=0;h<g.length;h++)e.push(g[h])}return c=c.concat(e)};a.trans_matrix=function(a,b,c,d){d||(d=new Float32Array(16));M.identity(d);d[12]=a;d[13]=b;d[14]=c;return d};var ea=1;a.rand=function(){ea=(69069*ea+5)%Math.pow(2,32);return Math.round(ea/65536)%32768/32767};a.srand=function(a){ea=a};a.rand_r=function(a){var b=a[0]%ha*48271-
3399*Math.floor(a[0]/ha);a[0]=0<b?b:b+2147483647;return(a[0]-1)/2147483646};a.init_rand_r_seed=function(a,b){b||(b=[]);b[0]=5E4+Math.floor(a);return b};a.euler_to_quat=function(a,b){var c=Math.cos(a[1]/2),d=Math.cos(a[2]/2),e=Math.cos(a[0]/2),f=Math.sin(a[1]/2),g=Math.sin(a[2]/2),h=Math.sin(a[0]/2);b[0]=f*g*e+c*d*h;b[1]=f*d*e+c*g*h;b[2]=c*g*e-f*d*h;b[3]=c*d*e-f*g*h;return b};a.euler_to_rotation_matrix=function(a){var b=t.create(),c=Math.cos(a[0]),d=Math.cos(a[1]),e=Math.cos(a[2]),f=Math.sin(a[0]),
g=Math.sin(a[1]);a=Math.sin(a[2]);var h=c*e,l=c*a,k=f*e,m=f*a;b[0]=d*e;b[1]=d*a;b[2]=-g;b[3]=g*k-l;b[4]=g*m+h;b[5]=d*f;b[6]=g*h+m;b[7]=g*l-k;b[8]=d*c;return b};a.quat_to_euler=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=c*c,h=d*d,l=e*e,k=c*d+e*f;.499999<k?(b[0]=0,b[1]=2*Math.atan2(c,f),b[2]=Math.PI/2):-.499999>k?(b[0]=0,b[1]=-2*Math.atan2(c,f),b[2]=-Math.PI/2):(b[0]=Math.atan2(2*c*f-2*d*e,1-2*g-2*l),b[1]=Math.atan2(2*d*f-2*c*e,1-2*h-2*l),b[2]=Math.asin(2*c*d+2*e*f));return b};a.quat_to_dir=function(a,
b,c){c||(c=new Float32Array(3));f.transformQuat(b,a,c);return c};a.dir_to_quat=function(a,b,c){c||(c=new Float32Array(4));a=f.normalize(a,B);var d=f.dot(b,a);a=f.cross(b,a,K);d=Math.acos(d);c[0]=a[0]*Math.sin(d/2);c[1]=a[1]*Math.sin(d/2);c[2]=a[2]*Math.sin(d/2);c[3]=Math.cos(d/2);return c};a.trans_quat_to_plane=function(a,b,c,d){d||(d=new Float32Array(4));f.transformQuat(c,b,d);d[3]=-f.dot(a,d);return d};a.dir_ground_proj_angle=function(a){var b=a._render.quat;switch(a.type){case "CAMERA":B[0]=0;
B[1]=-1;B[2]=0;f.transformQuat(B,b,B);K[0]=0;K[1]=0;K[2]=-1;break;case "MESH":B[0]=0;B[1]=0;B[2]=1;f.transformQuat(B,b,B);K[0]=0;K[1]=0;K[2]=1;break;case "EMPTY":B[0]=0,B[1]=1,B[2]=0,f.transformQuat(B,b,B),K[0]=0,K[1]=1,K[2]=0}B[1]=0;f.normalize(B,B);a=f.dot(B,K);b=0<-B[0]*K[2]?-1:1;return Math.acos(a)*b};a.blend_arrays=function(a,b,c,d){if(0==c)return a;d=d||[];for(var e=0;e<a.length;e++)d[e]=(1-c)*a[e]+c*b[e];return d};a.unique_id=function(){S++;return S.toString(16)};a.unique_name=function(a){z[a]||
(z[a]=0);var b=a+z[a];z[a]++;return b};a.create_empty_va_frame=function(){return{a_position:new Float32Array(0),a_tangent:new Float32Array(0),a_normal:new Float32Array(0)}};a.create_empty_submesh=function(a){var b={a_influence:new Float32Array(0),a_color:new Float32Array(0),a_texcoord:new Float32Array(0)};return{name:a,base_length:0,indices:null,va_frames:[],va_common:b}};a.init_object=function(a,b){return{name:a,type:b,modifiers:[],particle_systems:[],data:null}};a.clone_object_json=function(a){return JSON.parse(JSON.stringify(a))};
a.clone_object=function(a,b){var d=[],e;for(e in b){var f=b[e];if(f)for(var g=0;g<f.length;g++)d.push(f[g])}return c(a,d)};a.clone_object_r=function(b){var c=b instanceof Array?[]:{},d;for(d in b)c[d]=b[d]&&"object"==typeof b[d]?b[d]instanceof Float32Array?new Float32Array(b[d]):b[d]instanceof Uint32Array?new Uint32Array(b[d]):b[d]instanceof Uint16Array?new Uint16Array(b[d]):a.clone_object_r(b[d]):b[d];return c};a.clone_object_nr=function(a){var b=a instanceof Array?[]:{},c;for(c in a)b[c]=a[c]&&
"object"==typeof a[c]?a[c]instanceof Float32Array?new Float32Array(a[c]):a[c]instanceof Uint32Array?new Uint32Array(a[c]):a[c]instanceof Uint16Array?new Uint16Array(a[c]):a[c]instanceof Array?a[c].slice(0):a[c]:a[c];return b};a.is_mesh=function(a){return"MESH"===a.type?!0:!1};a.is_empty=function(a){return"EMPTY"===a.type?!0:!1};a.is_armature=function(a){return"ARMATURE"===a.type?!0:!1};a.matrix_to_quat=function(a,b){b||(b=new Float32Array(4));t.fromMat4(a,O);var c=O[0],d=O[3],e=O[6],f=O[1],g=O[4],
h=O[7],l=O[2],k=O[5],m=O[8],c=Math.sqrt(c*c+d*d+e*e)||1,f=Math.sqrt(f*f+g*g+h*h)||1,l=Math.sqrt(l*l+k*k+m*m)||1;O[0]/=c;O[3]/=c;O[6]/=c;O[1]/=f;O[4]/=f;O[7]/=f;O[2]/=l;O[5]/=l;O[8]/=l;n.fromMat3(O,b);return b};a.matrix_to_trans=function(a,b){b||(b=new Float32Array(3));b[0]=a[12];b[1]=a[13];b[2]=a[14];return b};a.matrix_to_scale=function(a){v[0]=.577350269189626;v[1]=.577350269189626;v[2]=.577350269189626;v[3]=0;E.transformMat4(v,a,v);return E.length(v)};a.extract_frustum_planes=function(a,b){var c=
b.left,e=b.right,f=b.top,g=b.bottom,h=b.near,l=b.far;c[0]=a[3]+a[0];c[1]=a[7]+a[4];c[2]=a[11]+a[8];c[3]=a[15]+a[12];e[0]=a[3]-a[0];e[1]=a[7]-a[4];e[2]=a[11]-a[8];e[3]=a[15]-a[12];f[0]=a[3]-a[1];f[1]=a[7]-a[5];f[2]=a[11]-a[9];f[3]=a[15]-a[13];g[0]=a[3]+a[1];g[1]=a[7]+a[5];g[2]=a[11]+a[9];g[3]=a[15]+a[13];h[0]=a[3]+a[2];h[1]=a[7]+a[6];h[2]=a[11]+a[10];h[3]=a[15]+a[14];l[0]=a[3]-a[2];l[1]=a[7]-a[6];l[2]=a[11]-a[10];l[3]=a[15]-a[14];d(c);d(e);d(f);d(g);d(h);d(l);return b};a.sphere_is_out_of_frustum=function(a,
c,d){return d<-b(a,c.left)||d<-b(a,c.right)||d<-b(a,c.top)||d<-b(a,c.bottom)||d<-b(a,c.near)||d<-b(a,c.far)?!0:!1};a.ellipsoid_is_out_of_frustum=function(a,c,d,e,g){h=f.dot(d,c.far);l=f.dot(e,c.far);k=f.dot(g,c.far);h=Math.sqrt(h*h+l*l+k*k);if(h<-b(a,c.near)||h<-b(a,c.far))return!0;var h=f.dot(d,c.left),l=f.dot(e,c.left),k=f.dot(g,c.left);if(Math.sqrt(h*h+l*l+k*k)<-b(a,c.left))return!0;h=f.dot(d,c.right);l=f.dot(e,c.right);k=f.dot(g,c.right);if(Math.sqrt(h*h+l*l+k*k)<-b(a,c.right))return!0;h=f.dot(d,
c.top);l=f.dot(e,c.top);k=f.dot(g,c.top);if(Math.sqrt(h*h+l*l+k*k)<-b(a,c.top))return!0;h=f.dot(d,c.bottom);l=f.dot(e,c.bottom);k=f.dot(g,c.bottom);return Math.sqrt(h*h+l*l+k*k)<-b(a,c.bottom)?!0:!1};a.positions_multiply_matrix=function(a,b,c,d){d||(d=0);for(var e=a.length,f=0;f<e;f+=3){var g=a[f],h=a[f+1],l=a[f+2];c[d+f]=b[0]*g+b[4]*h+b[8]*l+b[12];c[d+f+1]=b[1]*g+b[5]*h+b[9]*l+b[13];c[d+f+2]=b[2]*g+b[6]*h+b[10]*l+b[14]}return c};a.vectors_multiply_matrix=function(a,b,c,d){d||(d=0);for(var e=a.length,
f=0;f<e;f+=3){var g=a[f],h=a[f+1],l=a[f+2];c[d+f]=b[0]*g+b[4]*h+b[8]*l;c[d+f+1]=b[1]*g+b[5]*h+b[9]*l;c[d+f+2]=b[2]*g+b[6]*h+b[10]*l}return c};a.tangents_multiply_matrix=function(a,b,c,d){d||(d=0);for(var e=a.length,f=0;f<e;f+=4){var g=a[f],h=a[f+1],l=a[f+2];c[d+f]=b[0]*g+b[4]*h+b[8]*l;c[d+f+1]=b[1]*g+b[5]*h+b[9]*l;c[d+f+2]=b[2]*g+b[6]*h+b[10]*l;c[d+f+3]=a[f+3]}return c};a.vecdir_multiply_matrix=function(a,b,c){c||(c=new Float32Array(3));v[0]=a[0];v[1]=a[1];v[2]=a[2];v[3]=0;E.transformMat4(v,b,v);
c[0]=v[0];c[1]=v[1];c[2]=v[2]};a.flatten=function(a,b){var c=a.length;if(!c)throw"flatten(): Wrong or empty array";var d=a[0].length;if(!d)throw"flatten(): Wrong or empty subarray";b||(b=new Float32Array(c*d));for(var e=0;e<c;e++)for(var f=0;f<d;f++)b[e*d+f]=a[e][f];return b};a.vectorize=function(a,b){b||(b=[]);for(var c=0;c<a.length;c+=3){var d=new Float32Array([a[c],a[c+1],a[c+2]]);b[c/3]=d}return b};a.binary_search_max=function(b,c,d,e){if(e<d)return d;var f=d+Math.floor((e-d)/2);return b[f]>c?
a.binary_search_max(b,c,d,f-1):b[f]<c?a.binary_search_max(b,c,f+1,e):f};a.cmp_arr=function(a,b){for(var c=0;c<a.length;c++)if(a[c]!=b[c])return!1;return!0};a.cmp_arr_float=function(a,b,c){for(var d=0;d<a.length;d++)if(Math.abs(a[d]-b[d])>c)return!1;return!0};a.scale_mat4=function(a,b,c){c||(c=new Float32Array(16));for(var d=0;12>d;d++)c[d]=a[d]*b;c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15];return c};a.transform_mat4=function(a,b,c,d,e){e||(e=new Float32Array(16));b=M.fromRotationTranslation(c,
d,L);M.multiply(b,a,e);return e};a.transform_vec3=function(a,b,c,d,e){e||(e=new Float32Array(3));c=M.fromRotationTranslation(c,d,L);1!==b&&(d=M.identity(G),b=f.set(b,b,b,B),M.scale(d,b,d),M.multiply(c,d,c));f.transformMat4(a,c,e);return e};a.transform_vec4=function(a,b,c,d,e){e||(e=new Float32Array(4));b=M.fromRotationTranslation(c,d,L);E.transformMat4(a,b,e);return e};a.inverse_transform_vec3=function(a,b,c,d,e){e||(e=new Float32Array(3));b=M.fromRotationTranslation(c,d,L);M.invert(b,b);f.transformMat4(a,
b,e);return e};a.transcale_quat_to_matrix=function(a,b,c){c||(c=new Float32Array(16));M.fromRotationTranslation(b,a,c);a=a[3];for(b=0;12>b;b++)c[b]*=a;return c};a.matrix_to_transcale_quat=function(b,c,d){a.matrix_to_trans(b,c);c[3]=a.matrix_to_scale(b);a.matrix_to_quat(b,d)};a.array_stringify=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return JSON.stringify(b)};a.rotate_point_pivot=function(a,b,c,d){d||(d=new Float32Array(3));f.subtract(b,a,B);f.transformQuat(B,c,B);f.subtract(b,B,d)};
a.generate_cubemap_matrices=function(){var a=new Float32Array([0,0,0]),b=new Float32Array(16),c=new Float32Array(16),d=new Float32Array(16),e=new Float32Array(16),f=new Float32Array(16),g=new Float32Array(16);M.lookAt(a,[-1,0,0],[0,-1,0],b);M.scale(b,[-1,1,1],b);M.scale(b,[-1,1,-1],c);M.lookAt(a,[0,-1,0],[0,0,-1],d);M.scale(d,[1,1,-1],d);M.scale(d,[1,-1,-1],e);M.lookAt(a,[0,0,-1],[0,-1,0],f);M.scale(f,[-1,1,1],f);M.scale(f,[-1,1,-1],g);return[b,c,d,e,f,g]};a.calc_variable_id=function(a,b){return l(a,
b)};a.hash_code=l;a.hash_code_string=e;a.mat4_translate=function(a,b,c){var d=b[0],e=b[1];b=b[2];var f,g,h,l,k,m,p,n,s,t,x,y;if(!c||a===c)return a[12]=a[0]*d+a[4]*e+a[8]*b+a[12],a[13]=a[1]*d+a[5]*e+a[9]*b+a[13],a[14]=a[2]*d+a[6]*e+a[10]*b+a[14],a[15]=a[3]*d+a[7]*e+a[11]*b+a[15],a;f=a[0];g=a[1];h=a[2];l=a[3];k=a[4];m=a[5];p=a[6];n=a[7];s=a[8];t=a[9];x=a[10];y=a[11];c[0]=f;c[1]=g;c[2]=h;c[3]=l;c[4]=k;c[5]=m;c[6]=p;c[7]=n;c[8]=s;c[9]=t;c[10]=x;c[11]=y;c[12]=f*d+k*e+s*b+a[12];c[13]=g*d+m*e+t*b+a[13];
c[14]=h*d+p*e+x*b+a[14];c[15]=l*d+n*e+y*b+a[15];return c};a.mat3_to_mat4=function(a,b){b[15]=1;b[14]=0;b[13]=0;b[12]=0;b[11]=0;b[10]=a[8];b[9]=a[7];b[8]=a[6];b[7]=0;b[6]=a[5];b[5]=a[4];b[4]=a[3];b[3]=0;b[2]=a[2];b[1]=a[1];b[0]=a[0];return b};a.quat_to_angle_axis=function(a,b){b||(b=a);var c=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];0<c?(b[3]=2*Math.acos(a[3]),c=1/Math.sqrt(c),b[0]=a[0]*c,b[1]=a[1]*c,b[2]=a[2]*c):(b[3]=0,b[0]=1,b[1]=0,b[2]=0);return b};a.trunc=function(a){return isNaN(a)||"undefined"==typeof a?
NaN:a|0};a.rad=function(a){return a*Math.PI/180};a.deg=function(a){return 180*a/Math.PI};a.snoise=function(a){var b=.366025403784439*a[0]+.366025403784439*a[1],c=Math.floor(a[0]+b),d=Math.floor(a[1]+b),e=.211324865405187*c+.211324865405187*d,b=a[0]-c+e;a=a[1]-d+e;var f=b>a?1:0,h=1-f,e=b+.211324865405187-f,l=a+.211324865405187-h,m=b+-.577350269189626,p=a+-.577350269189626,c=c%289,d=d%289,n=k(k(d)+c),h=k(k(d+h)+c+f),s=k(k(d+1)+c+1),c=Math.max(.5-(b*b+a*a),0),d=Math.max(.5-(e*e+l*l),0),f=Math.max(.5-
(m*m+p*p),0),c=c*c*c*c,d=d*d*d*d,f=f*f*f*f,t=2*g(.024390243902439*n)-1,x=2*g(.024390243902439*h)-1,y=2*g(.024390243902439*s)-1,n=Math.abs(t)-.5,h=Math.abs(x)-.5,s=Math.abs(y)-.5,t=t-Math.floor(t+.5),x=x-Math.floor(x+.5),y=y-Math.floor(y+.5);return 130*(c*(1.79284291400159-.85373472095314*(t*t+n*n))*(t*b+n*a)+d*(1.79284291400159-.85373472095314*(x*x+h*h))*(x*e+h*l)+f*(1.79284291400159-.85373472095314*(y*y+s*s))*(y*m+s*p))};a.cellular2x2=function(a){var b=1/7,c=b/2,d=m(Math.floor(a[0])),e=m(Math.floor(a[1])),
f=g(a[0]);a=g(a[1]);var h=f-.5,l=f-1.5,f=a-.5;a-=1.5;var k=y(d),d=y(d+1),p=k,n=d,k=y(k+e),d=y(d+e),p=y(p+e+1),n=y(n+e+1),t=s(k)*b+c,x=s(d)*b+c,v=s(p)*b+c,e=s(n)*b+c,k=s(Math.floor(k*b))*b+c,d=s(Math.floor(d*b))*b+c,p=s(Math.floor(p*b))*b+c,b=s(Math.floor(n*b))*b+c,c=h+.7*t,x=l+.7*x,h=h+.7*v,l=l+.7*e,e=f+.7*k,f=f+.7*d,k=a+.7*p;a+=.7*b;return Math.min(c*c+e*e,x*x+f*f,h*h+k*k,l*l+a*a)};a.quat_project=function(a,b,c,d,e){e||(e=new Float32Array(4));a=f.transformQuat(b,a,B);b=c[0];var g=c[1];c=c[2];O[0]=
g*g+c*c;O[1]=-g*b;O[2]=-c*b;O[3]=-b*g;O[4]=b*b+c*c;O[5]=-c*g;O[6]=-b*c;O[7]=-g*c;O[8]=b*b+g*g;f.transformMat3(a,O,a);f.normalize(a,a);n.rotationTo(d,a,e);return e};a.cam_quat_to_mesh_quat=function(a,b){b||(b=new Float32Array(4));var c=v,d=Q,c=n.setAxisAngle([0,1,0],Math.PI,n.create()),d=n.setAxisAngle([1,0,0],Math.PI/2,n.create());n.multiply(c,d,c);n.multiply(a,c,b);return b};a.cleanup=function(){S=0;z={}};a.clamp=function(a,b,c){return Math.min(Math.max(a,b),c)};a.smooth=function(a,b,c,d){c=Math.exp(-c/
d);return(1-c)*a+c*b};a.smooth_v=function(a,b,c,d,e){e||(e=new Float32Array(a.length));c=Math.exp(-c/d);for(d=0;d<e.length;d++)e[d]=(1-c)*a[d]+c*b[d];return e};a.smooth_q=function(a,b,c,d,e){e||(e=new Float32Array(a.length));c=Math.exp(-c/d);n.slerp(a,b,c,e);return e};a.is_arr_buf_view=function(a){return"object"===typeof a&&a.buffer&&a.buffer instanceof ArrayBuffer?!0:!1};a.is_vector=function(a,b){if(a instanceof Array||a.buffer&&a.buffer instanceof ArrayBuffer)if(b&&b==a.length||!b)return!0;return!1};
a.correct_cam_quat_up=function(a,b){var c=t.fromQuat(a,O);K[0]=0;K[1]=1;K[2]=0;B[0]=c[3];B[1]=c[4];B[2]=c[5];var d=f.cross(K,B,B);f.normalize(d,d);var e=c[7];!b&&0<e&&(d[0]*=-1,d[1]*=-1,d[2]*=-1);K[0]=c[0];K[1]=c[1];K[2]=c[2];f.normalize(K,K);n.rotationTo(K,d,Q);n.multiply(Q,a,a)};a.get_array_smooth_value=function(a,b,c,d){c=c*b-.5;var e=d*b-.5;d=c-Math.floor(c);var f=e-Math.floor(e);c=Math.floor(c);var e=Math.floor(e),g=b-1,h=a[e*b+c],l=a[e*b+Math.min(c+1,g)],k=a[Math.min(e+1,g)*b+c];a=a[Math.min(e+
1,g)*b+Math.min(c+1,g)];return(h*(1-d)+l*d)*(1-f)+(k*(1-d)+a*d)*f};a.rgb_mask_get_channels_count=function(a){for(var b=0,c=0;3>c;c++)0<(a&1<<c)&&b++;return b};a.rgb_mask_get_channels_presence=function(a){for(var b=[0,0,0],c=0;3>c;c++)0<(a&1<<c)&&(b[2-c]=1);return b};a.rgb_mask_get_channel_presence_index=function(a,b){var c=0;(1==b||2==b)&&0<(a&4)&&c++;2==b&&0<(a&2)&&c++;return c};a.gen_uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|
0;return("x"==a?b:b&3|8).toString(16)})};a.get_dict_length=function(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b};a.random_from_array=function(a){if(!a.length)return null;var b=Math.floor(Math.random()*a.length);return a[b]};a.xz_direction=function(a,b,c){c||(c=new Float32Array(3));c[0]=a[0]-b[0];c[1]=0;c[2]=a[2]-b[2];f.normalize(c,c)};a.transformQuatFast=function(a,b,c){var d=a[0],e=a[1];a=a[2];var f=b[0],g=b[1],h=b[2];b=b[3];var l=g*a-h*e,k=h*d-f*a,m=f*e-g*d,p=g*m-h*k,h=h*l-f*m,f=f*
k-g*l;c[0]=d+2*l*b+2*p;c[1]=e+2*k*b+2*h;c[2]=a+2*m*b+2*f;return c};a.panic=function(a){a&&A.error.apply(A,arguments);throw"panic: see above for possible error messages";};a.angle_wrap_0_2pi=function(a){return a-2*Math.floor(a/(2*Math.PI))*Math.PI};a.get_file_extension=function(a){return/(?:\.([^.]+))?$/.exec(a)[1]};a.strict_objs_is_equal=function(a,b){for(var c in a){var d=!0,e=a[c],f=b[c];switch(typeof e){case "number":case "string":case "boolean":d=e==f;break;case "object":d=x(e,f)}if(!d)return!1}return!0};
a.quat_bpy_b4w=function(a,b){var c=a[0],d=a[2],e=a[3];b[0]=a[1];b[1]=d;b[2]=e;b[3]=c;return b};a.gen_color_id=function(a){a+=1;132651<a&&A.error("Color ID pool depleted");var b=Math.floor(a/2601);a%=2601;var c=Math.floor(a/51);return[b/51,c/51,a%51/51]};a.line_plane_intersect=function(a,b,c,d,e){v.set(a);v[3]=b;Q.set(d);Q[3]=0;a=E.dot(v,Q);if(0==a)return null;Q.set(c);Q[3]=1;a=-E.dot(v,Q)/a;e[0]=c[0]+a*d[0];e[1]=c[1]+a*d[1];e[2]=c[2]+a*d[2];return e};a.copy_array=function(a,b){for(var c=0;c<a.length;c++)b[c]=
a[c];return b};a.rotation_to_stable=function(a,b,c){var d=f.dot(a,b);-.9999999>d?(f.cross(X,a,B),1E-6>f.length(B)&&f.cross(p,a,B),f.normalize(B,B),n.setAxisAngle(B,Math.PI,c)):(f.cross(a,b,B),c.set(B),c[3]=1+d,n.normalize(c,c));return c}};b4w.module.__nla=function(a,q){function r(){return{type:"CLIP",frame_start:0,frame_end:0,scheduled:!1,paused:!1,anim_name:"",anim_slot:0,action_frame_start:0,action_frame_end:0,ext_frame_start:0,ext_frame_end:0,stop_video:!1}}function c(a,b){for(var c=a.b4w_nla_script,d=b.script,e=0;e<c.length;e++){var f=c[e];switch(f.type){case "PLAY":d.push({type:"PLAY",frame_start:f.frame_range[0],frame_end:f.frame_range[1],in_play:!1});break;case "SELECT":case "SELECT_PLAY":var g=C.get_object(C.GET_OBJECT_BY_NAME,
f.object,0),h=C.get_selectable_objects(a),l=h.indexOf(g);if(-1==l)return x.error("NLA script error: non-selectable object"),[];for(var f={type:f.type,slot_idx_hit:"SELECT"==f.type?f.target_slot:e+1,slot_idx_miss:e+1,sel_state:-1,sel_objs_len:h.length,sel_obj_idx:l,frame_start:f.frame_range[0],frame_end:f.frame_range[1],in_play:!1},l=[],k=0;k<h.length;k++)l.push(m.create_selection_sensor(h[k],!0));m.create_sensor_manifold(g,"NLA_SELECT_"+e,m.CT_SHOT,l,m.default_OR_logic_fun,function(a,c,d,e){if(!(b.curr_script_slot>=
b.script.length)&&(d=b.script[b.curr_script_slot],"SELECT"==d.type||"SELECT_PLAY"==d.type&&!d.in_play)){for(d=0;d<e.sel_objs_len;d++)if(m.get_sensor_value(a,c,d)&&d==e.sel_obj_idx){e.sel_state=1;return}e.sel_state=0}},f);d.push(f);break;case "JUMP":d.push({type:"JUMP",slot_idx:f.target_slot});break;case "CONDJUMP":d.push({type:"CONDJUMP",slot_idx:f.target_slot,cond:f.condition,reg1:f.register1,reg2:f.register2,num1:f.number1,num2:f.number2});break;case "REGSTORE":d.push({type:"REGSTORE",reg:f.registerd,
num:f.number1});break;case "MATH":d.push({type:"MATH",op:f.operation,reg1:f.register1,reg2:f.register2,num1:f.number1,num2:f.number2,regd:f.registerd});break;case "SHOW":case "HIDE":g=C.get_object(C.GET_OBJECT_BY_NAME,f.object,0);d.push({type:f.type,obj:g});break;case "REDIRECT":d.push({type:"REDIRECT",url:f.url});break;case "PAGEPARAM":d.push({type:"PAGEPARAM",param_name:f.param_name,regd:f.registerd});break;case "NOOP":d.push({type:"NOOP"})}}}function d(a,c,e,g){if(a.script.length){if(a.curr_script_slot>=
a.script.length)if(a.cyclic)a.curr_script_slot=0;else{a.frame_offset-=n.framerate*e;return}var h=l(a,c,g,!1),k=a.script[a.curr_script_slot];switch(k.type){case "PLAY":k.in_play?h>=k.frame_end&&(k.in_play=!1,a.curr_script_slot++,d(a,c,e,g)):(a.frame_offset+=k.frame_start-h,k.in_play=!0,b(a,k));break;case "SELECT":case "SELECT_PLAY":-1<k.sel_state?"SELECT"==k.type||"SELECT_PLAY"==k.type&&0==k.sel_state?(a.curr_script_slot=k.sel_state?k.slot_idx_hit:k.slot_idx_miss,k.sel_state=-1,d(a,c,e,g)):k.in_play?
h>=k.frame_end&&(k.in_play=!1,a.curr_script_slot=k.slot_idx_hit,k.sel_state=-1,d(a,c,e,g)):(a.frame_offset+=k.frame_start-h,k.in_play=!0,b(a,k)):a.frame_offset-=n.framerate*e;break;case "JUMP":a.curr_script_slot=k.slot_idx;d(a,c,e,g);break;case "CONDJUMP":var h=-1==k.reg1?k.num1:a.registers[k.reg1],m=-1==k.reg2?k.num2:a.registers[k.reg2],s=!1;switch(k.cond){case "EQUAL":h==m&&(s=!0);break;case "NOTEQUAL":h!=m&&(s=!0);break;case "LESS":h<m&&(s=!0);break;case "GREATER":h>m&&(s=!0);break;case "LEQUAL":h<=
m&&(s=!0);break;case "GEQUAL":h>=m&&(s=!0)}s?a.curr_script_slot=k.slot_idx:a.curr_script_slot++;d(a,c,e,g);break;case "REGSTORE":a.registers[k.reg]=k.num;a.curr_script_slot++;d(a,c,e,g);break;case "MATH":h=-1==k.reg1?k.num1:a.registers[k.reg1];m=-1==k.reg2?k.num2:a.registers[k.reg2];switch(k.op){case "ADD":a.registers[k.regd]=h+m;break;case "MUL":a.registers[k.regd]=h*m;break;case "SUB":a.registers[k.regd]=h-m;break;case "DIV":0==m&&f.panic("Division by zero in NLA script"),a.registers[k.regd]=h/
m}a.curr_script_slot++;d(a,c,e,g);break;case "SHOW":C.show_object(k.obj);a.curr_script_slot++;d(a,c,e,g);break;case "HIDE":C.hide_object(k.obj);a.curr_script_slot++;d(a,c,e,g);break;case "REDIRECT":window.location.href=k.url;a.script.length=0;break;case "PAGEPARAM":h=a.registers;m=k.regd;a:{k=k.param_name;s=location.href.toString();if(-1!=s.indexOf("?"))for(var s=s.split("?")[1].split("&"),t=0;t<s.length;t++){var x=s[t].split("=");if(1<x.length&&x[0]==k){k=Number(x[1]);break a}}k=0}h[m]=k;a.curr_script_slot++;
d(a,c,e,g);break;case "NOOP":a.curr_script_slot++,d(a,c,e,g)}}}function b(a,b){for(var c=a.script,d=0;d<c.length;d++){var e=c[d];e!=b&&(e.sel_state=-1)}}function l(a,b,c,d){b=(b-c)*n.framerate+a.frame_offset-a.frame_start;a.cyclic&&d&&(b%=a.frame_end-a.frame_start+1);return b+=a.frame_start}function h(a,b){b?E.pause_video(a.name):(E.reset_video(a.name),E.play_video(a.name))}function e(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d].strips;if(e)for(var f=0;f<e.length;f++){var g=e[f],h=r();h.type=
g.type;h.frame_start=g.frame_start;h.frame_end=g.frame_end;h.anim_name=g.action?g.action.name:"";h.anim_slot=b;h.action_frame_start=g.action_frame_start;h.action_frame_end=g.action_frame_end;c.push(h)}}return c}function k(a){return A.is_speaker(a)&&a.data.animation_data&&a.data.animation_data.nla_tracks.length?!0:!1}var g=q("__animation"),y=q("__camera"),m=q("__controls"),s=q("__config");q("__loader");q("__particles");var x=q("__print"),C=q("__scenes"),A=q("__sfx"),f=q("__util"),E=q("__textures"),
n=s.animation,t=s.defaults,M=[],S=-1;a.update_scene_nla=function(a,b){var d={frame_start:a.frame_start,frame_end:a.frame_end,frame_offset:0,last_frame:-1,cyclic:b,objects:[],textures:[],script:[],curr_script_slot:0,registers:{R1:0,R2:0,R3:0,R4:0,R5:0,R6:0,R7:0,R8:0}};c(a,d);for(var h=C.get_scene_objs(a,"ALL",C.DATA_ID_ALL),l=0;l<h.length;l++){var m=h[l],n=0,s=[],q=m.animation_data;if(q&&q.nla_tracks.length&&(q=q.nla_tracks,f.is_armature(m)||y.is_camera(m)||f.is_mesh(m)||f.is_empty(m)||A.is_speaker(m))){var E=
e(q,n);E.length&&(s=s.concat(E),n++)}k(m)&&(q=m.data.animation_data.nla_tracks,E=e(q,n),E.length&&(s=s.concat(E),n++));if(g.has_animated_nodemats(m))for(var P=m.data.materials,S=0;S<P.length;S++)if(E=P[S].node_tree,q=E.animation_data,E&&q){for(var q=q.nla_tracks,E=e(q,-1),T=[],X=0;X<E.length;X++)q=E[X],-1==T.indexOf(q.anim_name)&&T.push(q.anim_name),q.anim_slot=n+T.indexOf(q.anim_name),s.push(q);n+=T.length}for(S=0;S<m.particle_systems.length;S++)P=m.particle_systems[S],q=P.settings,"EMITTER"==q.type&&
q.b4w_allow_nla&&(q=r(),q.type="CLIP",q.frame_start=d.frame_start,q.frame_end=d.frame_end+1,q.anim_name=P.name,q.anim_slot=n,s.push(q),n++);P=n+1;if(f.is_mesh(m)&&m.data)for(S=0;S<m.data.b4w_vertex_anim.length;S++)E=m.data.b4w_vertex_anim[S],E.allow_nla&&(n=P,q=r(),q.type="CLIP",q.frame_start=d.frame_start,q.frame_end=d.frame_end+1,q.anim_name=E.name,q.anim_slot=n,s.push(q));s.length&&(m._nla_events=s,d.objects.push(m))}h=a._render.video_textures;for(S=0;S<h.length;S++)if(l=h[S]._render,l.video_file||
l.seq_video)q=r(),q.type="VIDEO",m=1,t.seq_video_fallback&&(m=l.fps),q.frame_start=Math.min(l.frame_start*m,d.frame_end),q.frame_end=l.use_cyclic?d.frame_end:Math.min((l.frame_duration+l.frame_start+l.frame_offset)*m,d.frame_end),q.anim_name=h[S].name,l._nla_tex_event=q,d.textures.push(l);S=d.frame_start;h=d.frame_end;for(l=0;l<d.objects.length;l++)for(m=d.objects[l],n=m._nla_events,s=0;s<n.length;s++)q=n[s],P=m.name+" ["+q.frame_start+":"+q.frame_end+"]",q.frame_start=Math.max(S,q.frame_start),q.frame_end=
Math.min(h+1,q.frame_end),q.frame_start>q.frame_end&&(x.warn("NLA: out of scene range: "+P),n.splice(s,1),s--);for(S=0;S<d.objects.length;S++)for(h=d.objects[S]._nla_events,l=0;l<h.length;l++){m=h[l];n=d.frame_start;s=d.frame_end+1;for(q=0;q<h.length;q++)P=h[q],m.anim_slot==P.anim_slot&&(P.frame_end<=m.frame_start&&(n=m.frame_start),P.frame_start>=m.frame_end&&(s=Math.min(s,P.frame_start)));m.ext_frame_start=n;m.ext_frame_end=s}M.push(d)};a.start=function(){S=0};a.update=function(a,b){if(!(0>S)){0==
S&&(S=a);for(var c=0;c<M.length;c++){var e=M[c];d(e,a,b,S);for(var f=l(e,a,S,!0),k=0;k<e.objects.length;k++){for(var m=e.objects[k],s=m._nla_events,t=0;t<s.length;t++){var x=s[t];"SOUND"==x.type&&f<e.last_frame-1E-6&&(x.scheduled=!1)}for(t=0;t<s.length;t++)switch(x=s[t],x.type){case "CLIP":if(x.ext_frame_start<=f&&f<x.ext_frame_end&&!x.scheduled){var y=m,q=x;g.apply(y,q.anim_name,q.anim_slot);g.set_behavior(y,g.AB_FINISH_STOP,q.anim_slot);for(y=0;y<s.length;y++)s[y]!=x&&s[y].anim_slot==x.anim_slot&&
(s[y].scheduled=!1);x.scheduled=!0}x.scheduled&&(y=m,g.set_current_frame_float(y,f-x.frame_start+x.action_frame_start,x.anim_slot),g.update_object_animation(y,0,x.anim_slot));break;case "SOUND":(f<e.last_frame-1E-6||e.last_frame<x.frame_start)&&x.frame_start<=f&&f<x.frame_end&&!x.scheduled&&(A.play(m,(x.frame_start-f)/n.framerate,(x.frame_end-x.frame_start)/n.framerate),x.scheduled=!0),e.last_frame<x.frame_end&&x.frame_end<=f&&x.scheduled&&(x.scheduled=!1)}}for(k=0;k<e.textures.length;k++)x=e.textures[k]._nla_tex_event,
x.frame_start<=Math.round(f)&&Math.round(f)<x.frame_end&&!x.stop_video&&(h(e.textures[k],x.stop_video),x.stop_video=!0),x.frame_end<=Math.round(f)&&x.stop_video&&(h(e.textures[k],x.stop_video),x.stop_video=!1);e.last_frame=f}}};a.cleanup=function(){M.length=0;S=-1};a.has_nla=function(a){var b=a.animation_data;return b&&b.nla_tracks.length||k(a)||g.has_animated_nodemats(a)?!0:!1}};b4w.module.__sfx=function(a,q){function r(){var a=window.AudioContext||window.webkitAudioContext;if(a){a=new a;if(a.createGain)return a;C.warn("B4W warning: deprecated WebAudio implementation");return null}C.warn("B4W warning: WebAudio is not supported");return null}function c(a,c,d){var e=a._sfx;if("NONE"!=e.behavior){d||(d=0);var f=e.loop,g=e.pitch;if(e.src&&(f||0<=d)){e.base_seed=Math.floor(5E4*Math.random());c=B.currentTime+c;e.start_time=c;e.state=20;var k=a._sfx;if(!k.proc_chain_in){var s=a._render.trans,
p=a._render.quat;if(E.mix_mode){var t=B.createBiquadFilter();t.type="peaking"}else t=null;var x=B.createGain();switch(k.behavior){case "POSITIONAL":var y=B.createPanner();y.panningModel=y.EQUALPOWER;y.distanceModel=y.INVERSE_DISTANCE;y.setPosition(s[0],s[1],s[2]);k.last_position.set(s);var q=n;A.quat_to_dir(p,A.AXIS_MY,q);y.setOrientation(q[0],q[1],q[2]);k.direction.set(q);y.refDistance=k.dist_ref;y.maxDistance=k.dist_max;y.rolloffFactor=k.attenuation;y.coneInnerAngle=k.cone_angle_inner;y.coneOuterAngle=
k.cone_angle_outer;y.coneOuterGain=k.cone_volume_outer;q=B.createGain();q.gain.value=m(k);t?(y.connect(t),t.connect(q)):y.connect(q);q.connect(x);k.proc_chain_in=y;if(k.volume_random){var r=B.createGain();x.connect(r);r.connect(B?K._sfx.proc_chain_in:null)}else r=null,x.connect(B?K._sfx.proc_chain_in:null);break;case "BACKGROUND_SOUND":y=null;q=B.createGain();q.gain.value=m(k);t?(k.proc_chain_in=t,t.connect(q)):k.proc_chain_in=q;q.connect(x);k.volume_random?(r=B.createGain(),x.connect(r),r.connect(B?
K._sfx.proc_chain_in:null)):(r=null,x.connect(B?K._sfx.proc_chain_in:null));break;case "BACKGROUND_MUSIC":r=y=null,q=B.createGain(),q.gain.value=m(k),t?(k.proc_chain_in=t,t.connect(q)):k.proc_chain_in=q,q.connect(x),x.connect(B?K._sfx.proc_chain_in:null)}k.panner_node=y;k.filter_node=t;k.gain_node=q;k.fade_gain_node=x;k.rand_gain_node=r}if("POSITIONAL"==e.behavior||"BACKGROUND_SOUND"==e.behavior)a=B.createBufferSource(),a.buffer=e.src,a.playbackRate.value=g,f?(e.source_node&&e.source_node.disconnect(),
a.loop=!0,a.start(c),e.duration=0):(f=a.buffer?a.buffer.duration:0,d>f?(f=c+d+e.fade_out,a.loop=!0,a.start(c),a.stop(f),e.duration=d):(a.loop=!1,a.start(c),e.duration=f)),a.connect(e.proc_chain_in),e.source_node=a,b(e),l(e);else if("BACKGROUND_MUSIC"==e.behavior){window.clearTimeout(e.bgm_stop_timeout);d=a._sfx;if(f=d.src)f.volume=1,f.loop=d.cyclic,d.source_node=d.source_node||B.createMediaElementSource(f),d.source_node.connect(d.proc_chain_in),20==d.state&&f.play();e.duration=1E6}h(e,c)}}}function d(a){var b=
a._sfx,d=b.duration,b=b.delay+b.delay_random*Math.random();c(a,b,d)}function b(a){a.volume_random&&a.rand_gain_node.gain.cancelScheduledValues(a.start_time);a.pitch_random&&a.source_node.playbackRate.cancelScheduledValues(a.start_time);a.vp_rand_end_time=a.start_time}function l(a){if(a.volume_random||a.pitch_random){var b=a.rand_gain_node,c=a.source_node,d=c.buffer?c.buffer.duration:0;if(d){var e=a.start_time;Q[0]=a.base_seed;for(var f=0;5>f;){var g=a.pitch+a.pitch_random*A.rand_r(Q);if(e>=a.vp_rand_end_time){if(a.volume_random){var h=
1-A.clamp(a.volume_random,0,1)*Math.random();b.gain.setValueAtTime(h,e)}a.pitch_random&&c.playbackRate.setValueAtTime(g,e);f++}e+=d/g}a.vp_rand_end_time=e-.001}}}function h(a,b){if(a.fade_in||a.fade_out){var c=a.fade_gain_node;c.gain.cancelScheduledValues(b);a.fade_in?(c.gain.setValueAtTime(0,b),c.gain.linearRampToValueAtTime(1,b+a.fade_in)):c.gain.setValueAtTime(1,b);a.fade_out&&!a.loop&&(c.gain.setValueAtTime(1,b+a.duration),c.gain.linearRampToValueAtTime(0,b+a.duration+a.fade_out))}}function e(a){if("SPEAKER"!=
a.type)throw"Wrong object type";a=a._sfx;if(20==a.state||40==a.state){var b=a.fade_gain_node,c=B.currentTime;a.fade_out&&(b.gain.setValueAtTime(b.gain.value,c),b.gain.linearRampToValueAtTime(0,c+a.fade_out));if("BACKGROUND_MUSIC"==a.behavior){var d=a.src;d&&(a.bgm_stop_timeout=window.setTimeout(function(){d.currentTime&&(d.currentTime=0);d.pause()},1E3*a.fade_out))}else b=a.source_node,a.duration<b.buffer.duration?a.fade_out&&20==a.state?b.stop(c+a.fade_out):20==a.state&&(b.stop(0),b.disconnect()):
b.disconnect(),a.start_time=0,a.pause_time=0,a.buf_offset=0;a.state=30}}function k(a){a=a._sfx;if(20==a.state){if("BACKGROUND_MUSIC"==a.behavior){var c=a.src;c&&c.pause()}else{var d=B.currentTime;a.pause_time=d;if(d>a.start_time){Q[0]=a.base_seed;for(var e=a.source_node.buffer.duration,f=a.start_time;f<d;)c=a.pitch+a.pitch_random*A.rand_r(Q),f+=e/c;a.buf_offset=(e/c-(f-d))*c}else a.buf_offset=0;a.source_node.stop(0);a.source_node.disconnect();b(a)}a.state=40}}function g(a){var b=a._sfx;if(40==b.state){if("BACKGROUND_MUSIC"==
b.behavior)b.src.play();else{a=a._sfx;var c=B.createBufferSource();c.loop=a.source_node.loop;c.buffer=a.source_node.buffer;c.playbackRate.value=a.source_node.playbackRate.value;a.panner_node?c.connect(a.panner_node):c.connect(a.gain_node);a.source_node=c;a=B.currentTime;b.start_time+=a-b.pause_time;b.vp_rand_end_time=a;b.source_node.start(b.start_time,b.buf_offset);l(b);h(b,b.start_time)}b.state=20}}function y(a){return!a._sfx||20!=a._sfx.state&&40!=a._sfx.state&&30!=a._sfx.state?!1:!0}function m(a){return a.muted?
0:a.volume}function s(a){a=a._sfx;return(a=a.src)?a.duration:0}var x=q("__config"),C=q("__print"),A=q("__util"),f=q("vec3"),E=x.sfx;a.AST_NONE=10;a.AST_ARRAY_BUFFER=20;a.AST_HTML_ELEMENT=30;var n=new Float32Array(3),t=new Float32Array(3),M=new Float32Array(3),S=[],z=[],B=null,K=null,v=[],Q=[1],O=null;a.init=function(){var a=document.createElement("audio"),b=document.createElement("video");a.canPlayType&&(""!=a.canPlayType("audio/ogg")&&(S.push("ogg"),S.push("ogv")),""!=a.canPlayType("audio/mpeg")&&
S.push("mp3"),""!=a.canPlayType("audio/mp4")&&(S.push("mp4"),S.push("m4v")),""!=a.canPlayType("audio/webm")&&S.push("webm"));b.canPlayType&&(""!=b.canPlayType("video/ogg")&&z.push("ogv"),""!=b.canPlayType("video/mp4")&&z.push("m4v"),""!=b.canPlayType("video/webm")&&z.push("webm"));(B=E.webaudio?r():null)&&C.log("%cINIT WEBAUDIO: "+B.sampleRate+"Hz","color: #00a")};a.attach_scene_sfx=function(a){var b={listener_last_eye:new Float32Array(3),listener_direction:new Float32Array(3),listener_speed_avg:new Float32Array(3)};
a._sfx=b;if(B){var c=B.createGain(),d=B.createGain();b.gain_node=c;b.fade_gain_node=d;c.connect(d);d.connect(B.destination);if(a.b4w_enable_dynamic_compressor){var d=B.createDynamicsCompressor(),e=a.b4w_dynamic_compressor_settings;d.threshold.value=e.threshold;d.knee.value=e.knee;d.ratio.value=e.ratio;d.attack.value=e.attack;d.release.value=e.release;d.connect(c);b.compressor_node=d;b.proc_chain_in=d}else b.compressor_node=null,b.proc_chain_in=c;c=B.listener;c.dopplerFactor=a.audio_doppler_factor;
c.speedOfSound=a.audio_doppler_speed;b.muted=!1;b.volume=1;b.duck_time=0}};a.set_active_scene=function(a){K=a};a.detect_audio_container=function(a){a||(a="ogg");return-1<S.indexOf(a)?a:"ogg"==a&&-1<S.indexOf("mp4")?"mp4":"mp3"==a&&-1<S.indexOf("ogg")?"ogg":"mp4"==a&&-1<S.indexOf("ogg")?"ogg":"ogv"==a&&-1<S.indexOf("m4v")?"m4v":"webm"==a&&-1<S.indexOf("m4v")?"m4v":"m4v"==a&&-1<S.indexOf("webm")?"webm":""};a.detect_video_container=function(a){a||(a="webm");return-1<z.indexOf(a)?a:"ogv"==a&&-1<z.indexOf("m4v")?
"m4v":"webm"==a&&-1<z.indexOf("m4v")?"m4v":"m4v"==a&&-1<z.indexOf("webm")?"webm":""};a.append_object=function(a,b){if("SPEAKER"!=a.type)throw"Wrong speaker object";var c=a.data;a._sfx={};switch(c.b4w_behavior){case "POSITIONAL":case "BACKGROUND_SOUND":a._sfx.behavior=B?c.b4w_behavior:"NONE";break;case "BACKGROUND_MUSIC":var d=a._sfx,e;B?(window.MediaElementAudioSourceNode?e=!0:(C.warn("B4W warning: MediaElementAudioSourceNode not found"),e=!1),e=e?"BACKGROUND_MUSIC":"BACKGROUND_SOUND"):e="NONE";d.behavior=
e;break;default:throw"Wrong speaker behavior";}c.sound||(a._sfx.behavior="NONE");a._sfx.disable_doppler=c.b4w_disable_doppler;a._sfx.muted=c.muted;a._sfx.volume=c.volume;a._sfx.pitch=c.pitch;a._sfx.attenuation=c.attenuation;a._sfx.dist_ref=c.distance_reference;a._sfx.dist_max=c.distance_max||1E4;a._sfx.cone_angle_inner=c.cone_angle_inner;a._sfx.cone_angle_outer=c.cone_angle_outer;a._sfx.cone_volume_outer=c.cone_volume_outer;a._sfx.cyclic=c.b4w_cyclic_play;a._sfx.loop=c.b4w_loop;a._sfx.delay=c.b4w_delay;
a._sfx.delay_random=c.b4w_delay_random;a._sfx.volume_random=c.b4w_volume_random;a._sfx.pitch_random=c.b4w_pitch_random;a._sfx.fade_in=c.b4w_fade_in;a._sfx.fade_out=c.b4w_fade_out;a._sfx.start_time=0;a._sfx.pause_time=0;a._sfx.buf_offset=0;a._sfx.duration=0;a._sfx.vp_rand_end_time=0;a._sfx.base_seed=1;a._sfx.src=null;a._sfx.state=10;a._sfx.last_position=new Float32Array(3);a._sfx.direction=new Float32Array(3);a._sfx.speed_avg=new Float32Array(3);a._sfx.bgm_stop_timeout=null;a._sfx.duck_time=0;v.push(a)};
a.source_type=function(b){if("SPEAKER"!=b.type)throw"Wrong object type";switch(b._sfx.behavior){case "POSITIONAL":return a.AST_ARRAY_BUFFER;case "BACKGROUND_SOUND":return a.AST_ARRAY_BUFFER;case "BACKGROUND_MUSIC":return a.AST_HTML_ELEMENT;case "NONE":return a.AST_NONE;default:throw"Wrong speaker behavior";}};a.update_spkobj=function(a,b){var c=a._sfx;switch(c.behavior){case "POSITIONAL":case "BACKGROUND_SOUND":case "BACKGROUND_MUSIC":c.src=b;break;case "NONE":break;default:throw"Wrong speaker behavior";
}};a.play_empty_sound=function(){var a=B.createBufferSource();a.buffer=B.createBuffer(1,22050,22050);a.connect(B.destination);a.start(0)};a.decode_audio_data=function(a,b,c){B?B.decodeAudioData(a,b,c):c()};a.speaker_remove=function(a){e(a);delete a._sfx;v.splice(v.indexOf(a),1)};a.cleanup=function(){for(var a=0;a<v.length;a++){var b=v[a]._sfx;"BACKGROUND_MUSIC"==b.behavior?(b=b.src)&&b.pause():b.source_node&&b.source_node.disconnect()}K&&K._sfx&&(a=K._sfx,a.listener_last_eye[0]=0,a.listener_last_eye[1]=
0,a.listener_last_eye[2]=0,a.listener_speed_avg[0]=0,a.listener_speed_avg[1]=0,a.listener_speed_avg[2]=0);K=null;v.splice(0);O=null};a.update=function(a,b){if(B&&0!=v.length){for(var c=0;c<v.length;c++){var f=v[c],g=f._sfx,h=B.currentTime;!g.loop&&g.cyclic&&20==g.state&&g.duration&&B&&g.start_time+g.duration<h&&d(f);20==g.state&&3>g.vp_rand_end_time-h&&l(g)}O&&(-1==O.active||a>O.active_start_time+O.durations[O.active])&&(c=O,-1<c.active&&e(c.speakers[c.active]),-1==c.active&&c.random?f=Math.round(Math.random()*
(c.speakers.length-1)):c.random?(f=1+Math.round(Math.random()*(c.speakers.length-2)),f=(c.active+f)%c.speakers.length):f=(c.active+1)%c.speakers.length,d(c.speakers[f]),c.active=f,c.active_start_time=a)}};a.play=c;a.play_def=d;a.stop=e;a.is_play=function(a){return 20==a._sfx.state};a.speaker_pause=k;a.speaker_resume=g;a.playrate=function(a,c){var d=a._sfx;d.pitch=c;!y(a)||"POSITIONAL"!=d.behavior&&"BACKGROUND_SOUND"!=d.behavior||(d.source_node.playbackRate.value=c,b(d),l(d))};a.get_playrate=function(a){return a._sfx.pitch};
a.cyclic=function(a,b){a._sfx.cyclic=Boolean(b)};a.is_cyclic=function(a){return a._sfx.cyclic};a.listener_update_transform=function(a,b,c,d){if(B&&a._sfx){var e=n;e[0]=0;e[1]=-1;e[2]=0;f.transformQuat(e,c,e);t[0]=0;t[1]=0;t[2]=-1;f.transformQuat(t,c,t);c=B.listener;c.setPosition(b[0],b[1],b[2]);c.setOrientation(e[0],e[1],e[2],t[0],t[1],t[2]);a._sfx.listener_direction.set(e);d&&(M[0]=(b[0]-a._sfx.listener_last_eye[0])/d,M[1]=(b[1]-a._sfx.listener_last_eye[1])/d,M[2]=(b[2]-a._sfx.listener_last_eye[2])/
d,A.smooth_v(M,a._sfx.listener_speed_avg,d,.3,M),c.setVelocity(M[0],M[1],M[2]),a._sfx.listener_speed_avg.set(M));a._sfx.listener_last_eye.set(b)}};a.listener_reset_speed=function(a,b){if(B&&K._sfx){var c=n;b?c.set(b):c.set(K._sfx.listener_direction);f.scale(c,a,c);B.listener.setVelocity(c[0],c[1],c[2]);K._sfx.listener_speed_avg.set(c)}};a.speaker_update_transform=function(a,b){var c=a._sfx;if(y(a)&&"POSITIONAL"==c.behavior){var d=a._render.trans,e=c.panner_node;e.setPosition(d[0],d[1],d[2]);var f=
n;A.quat_to_dir(a._render.quat,A.AXIS_MY,f);e.setOrientation(f[0],f[1],f[2]);f=c.last_position;!c.disable_doppler&&b&&(t[0]=(d[0]-f[0])/b,t[1]=(d[1]-f[1])/b,t[2]=(d[2]-f[2])/b,A.smooth_v(t,c.speed_avg,b,.3,t),e.setVelocity(t[0],t[1],t[2]),c.speed_avg.set(t));f.set(d)}};a.speaker_reset_speed=function(a,b,c){var d=a._sfx;if(y(a)&&"POSITIONAL"==d.behavior){var e=n;c?e.set(c):e.set(d.direction);f.scale(e,b,e);d.panner_node.setVelocity(e[0],e[1],e[2]);d.speed_avg.set(e);d.last_position.set(a._render.trans)}};
a.is_speaker=function(a){return a._sfx?!0:!1};a.get_spk_behavior=function(a){return a._sfx.behavior};a.check_active_speakers=function(){for(var a=0;a<v.length;a++)if(y(v[a]))return!0;return!1};a.set_master_volume=function(a){var b=K._sfx;b&&(b.volume=a,B&&(b.gain_node.gain.value=m(b)))};a.get_master_volume=function(){var a=K._sfx;return a?a.volume:0};a.set_volume=function(a,b){var c=a._sfx;c.volume=b;y(a)&&(c.gain_node.gain.value=m(c))};a.get_volume=function(a){return a._sfx.volume};a.mute=function(a,
b){a._sfx.muted=Boolean(b);y(a)&&(a._sfx.gain_node.gain.value=m(a._sfx))};a.is_muted=function(a){return a._sfx.muted};a.mute_master=function(a){var b=K._sfx;b&&(b.muted=Boolean(a),B&&(b.gain_node.gain.value=m(b)))};a.is_master_muted=function(){var a=K._sfx;return a?a.muted:!1};a.get_speaker_objects=function(){return v};a.pause=function(){for(var a=0;a<v.length;a++)k(v[a])};a.resume=function(){for(var a=0;a<v.length;a++)g(v[a])};a.set_compressor_params=function(a,b){if(a._sfx&&a._sfx.compressor_node){var c=
a._sfx.compressor_node;c.threshold.value=b.threshold;c.knee.value=b.knee;c.ratio.value=b.ratio;c.attack.value=b.attack;c.release.value=b.release}};a.get_compressor_params=function(a){if(!a._sfx||!a._sfx.compressor_node)return null;a=a._sfx.compressor_node;return{threshold:a.threshold.value,knee:a.knee.value,ratio:a.ratio.value,attack:a.attack.value,release:a.release.value}};a.duck=function(a,b,c){if(y(a)){a=a._sfx;var d=a.fade_gain_node,e=B.currentTime;d.gain.setValueAtTime(d.gain.value,e);d.gain.linearRampToValueAtTime(b,
e+c);a.duck_time=c}};a.unduck=function(a){if(y(a)){a=a._sfx;var b=a.fade_gain_node,c=B.currentTime;b.gain.setValueAtTime(b.gain.value,c);b.gain.linearRampToValueAtTime(1,c+a.duck_time);a.duck_time=0}};a.duck_master=function(a,b){if(B){var c=K._sfx,d=c.fade_gain_node,e=B.currentTime;d.gain.setValueAtTime(d.gain.value,e);d.gain.linearRampToValueAtTime(a,e+b);c.duck_time=b}};a.unduck_master=function(){if(B){var a=K._sfx,b=a.fade_gain_node,c=B.currentTime;b.gain.setValueAtTime(b.gain.value,c);b.gain.linearRampToValueAtTime(1,
c+a.duck_time);a.duck_time=0}};a.apply_playlist=function(a,b,c){O={active:-1,active_start_time:0,random:c,speakers:[],durations:[]};for(c=0;c<a.length;c++){var d=a[c];e(d);O.speakers.push(d);d=s(d);O.durations.push(d+b)}};a.get_duration=s;a.clear_playlist=function(){if(O)for(var a=O.speakers,b=0;b<a.length;b++)e(a[b]);O=null};a.get_positional_params=function(a){return(a=a._sfx)&&"POSITIONAL"==a.behavior?{dist_ref:a.dist_ref,dist_max:a.dist_max,attenuation:a.attenuation}:null};a.set_positional_params=
function(a,b){var c=a._sfx;if(c&&"POSITIONAL"==c.behavior){c.dist_ref=b.dist_ref;c.dist_max=b.dist_max;c.attenuation=b.attenuation;var d=c.panner_node;d&&(d.refDistance=c.dist_ref,d.maxDistance=c.dist_max,d.rolloffFactor=c.attenuation)}};a.set_filter_params=function(a,b){var c=a._sfx;c&&c.filter_node&&(c.filter_node.frequency.value=b.freq,c.filter_node.Q.value=b.Q,c.filter_node.gain.value=b.gain)};a.get_filter_params=function(a){return(a=a._sfx)&&a.filter_node?{freq:a.filter_node.frequency.value,
Q:a.filter_node.Q.value,gain:a.filter_node.gain.value}:null};a.get_filter_freq_response=function(a,b,c,d){a=a._sfx;if(!a||!a.filter_node)return null;a.filter_node.getFrequencyResponse(b,c,d)}};b4w.module.vec3=function(a,q){var r="undefined"!==typeof Float32Array?Float32Array:Array,c=Math.random;a.create=function(){var a=new r(3);a[0]=0;a[1]=0;a[2]=0;return a};a.clone=function(a){var b=new r(3);b[0]=a[0];b[1]=a[1];b[2]=a[2];return b};a.fromValues=function(a,b,c){var h=new r(3);h[0]=a;h[1]=b;h[2]=c;return h};a.copy=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];return b};a.set=function(a,b,c,h){h[0]=a;h[1]=b;h[2]=c;return h};a.add=function(a,b,c){c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];
return c};a.subtract=function(a,b,c){c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];return c};a.sub=a.subtract;a.multiply=function(a,b,c){c[0]=a[0]*b[0];c[1]=a[1]*b[1];c[2]=a[2]*b[2];return c};a.mul=a.multiply;a.divide=function(a,b,c){c[0]=a[0]/b[0];c[1]=a[1]/b[1];c[2]=a[2]/b[2];return c};a.div=a.divide;a.min=function(a,b,c){c[0]=Math.min(a[0],b[0]);c[1]=Math.min(a[1],b[1]);c[2]=Math.min(a[2],b[2]);return c};a.max=function(a,b,c){c[0]=Math.max(a[0],b[0]);c[1]=Math.max(a[1],b[1]);c[2]=Math.max(a[2],
b[2]);return c};a.scale=function(a,b,c){c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;return c};a.scaleAndAdd=function(a,b,c,h){h[0]=a[0]+b[0]*c;h[1]=a[1]+b[1]*c;h[2]=a[2]+b[2]*c;return h};a.distance=function(a,b){var c=b[0]-a[0],h=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+h*h+e*e)};a.dist=a.distance;a.squaredDistance=function(a,b){var c=b[0]-a[0],h=b[1]-a[1],e=b[2]-a[2];return c*c+h*h+e*e};a.sqrDist=a.squaredDistance;a.length=function(a){var b=a[0],c=a[1];a=a[2];return Math.sqrt(b*b+c*c+a*a)};a.len=a.length;
a.squaredLength=function(a){var b=a[0],c=a[1];a=a[2];return b*b+c*c+a*a};a.sqrLen=a.squaredLength;a.negate=function(a,b){b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];return b};a.inverse=function(a,b){b[0]=1/a[0];b[1]=1/a[1];b[2]=1/a[2];return b};a.normalize=function(a,b){var c=a[0],h=a[1],e=a[2],c=c*c+h*h+e*e;0<c&&(c=1/Math.sqrt(c),b[0]=a[0]*c,b[1]=a[1]*c,b[2]=a[2]*c);return b};a.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};a.cross=function(a,b,c){var h=a[0],e=a[1];a=a[2];var k=b[0],g=b[1];b=b[2];
c[0]=e*b-a*g;c[1]=a*k-h*b;c[2]=h*g-e*k;return c};a.lerp=function(a,b,c,h){var e=a[0],k=a[1];a=a[2];h[0]=e+c*(b[0]-e);h[1]=k+c*(b[1]-k);h[2]=a+c*(b[2]-a);return h};a.random=function(a,b){a=a||1;var l=2*c()*Math.PI,h=2*c()-1,e=Math.sqrt(1-h*h)*a;b[0]=Math.cos(l)*e;b[1]=Math.sin(l)*e;b[2]=h*a;return b};a.transformMat4=function(a,b,c){var h=a[0],e=a[1];a=a[2];var k=b[3]*h+b[7]*e+b[11]*a+b[15],k=k||1;c[0]=(b[0]*h+b[4]*e+b[8]*a+b[12])/k;c[1]=(b[1]*h+b[5]*e+b[9]*a+b[13])/k;c[2]=(b[2]*h+b[6]*e+b[10]*a+b[14])/
k;return c};a.transformMat3=function(a,b,c){var h=a[0],e=a[1];a=a[2];c[0]=h*b[0]+e*b[3]+a*b[6];c[1]=h*b[1]+e*b[4]+a*b[7];c[2]=h*b[2]+e*b[5]+a*b[8];return c};a.transformQuat=function(a,b,c){var h=a[0],e=a[1],k=a[2];a=b[0];var g=b[1],y=b[2];b=b[3];var m=b*h+g*k-y*e,s=b*e+y*h-a*k,x=b*k+a*e-g*h,h=-a*h-g*e-y*k;c[0]=m*b+h*-a+s*-y-x*-g;c[1]=s*b+h*-g+x*-a-m*-y;c[2]=x*b+h*-y+m*-g-s*-a;return c};a.rotateX=function(a,b,c,h){var e=[],k=[];e[0]=a[0]-b[0];e[1]=a[1]-b[1];e[2]=a[2]-b[2];k[0]=e[0];k[1]=e[1]*Math.cos(c)-
e[2]*Math.sin(c);k[2]=e[1]*Math.sin(c)+e[2]*Math.cos(c);h[0]=k[0]+b[0];h[1]=k[1]+b[1];h[2]=k[2]+b[2];return h};a.rotateY=function(a,b,c,h){var e=[],k=[];e[0]=a[0]-b[0];e[1]=a[1]-b[1];e[2]=a[2]-b[2];k[0]=e[2]*Math.sin(c)+e[0]*Math.cos(c);k[1]=e[1];k[2]=e[2]*Math.cos(c)-e[0]*Math.sin(c);h[0]=k[0]+b[0];h[1]=k[1]+b[1];h[2]=k[2]+b[2];return h};a.rotateZ=function(a,b,c,h){var e=[],k=[];e[0]=a[0]-b[0];e[1]=a[1]-b[1];e[2]=a[2]-b[2];k[0]=e[0]*Math.cos(c)-e[1]*Math.sin(c);k[1]=e[0]*Math.sin(c)+e[1]*Math.cos(c);
k[2]=e[2];h[0]=k[0]+b[0];h[1]=k[1]+b[1];h[2]=k[2]+b[2];return h};a.forEach=function(){var c=a.create();return function(a,l,h,e,k,g){l||(l=3);h||(h=0);for(e=e?Math.min(e*l+h,a.length):a.length;h<e;h+=l)c[0]=a[h],c[1]=a[h+1],c[2]=a[h+2],k(c,g,c),a[h]=c[0],a[h+1]=c[1],a[h+2]=c[2];return a}}();a.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"};"undefined"!==typeof a&&(a.vec3=a)};
b4w.module.vec4=function(a,q){var r="undefined"!==typeof Float32Array?Float32Array:Array,c=Math.random;a.create=function(){var a=new r(4);a[0]=0;a[1]=0;a[2]=0;a[3]=0;return a};a.clone=function(a){var b=new r(4);b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b};a.fromValues=function(a,b,c,h){var e=new r(4);e[0]=a;e[1]=b;e[2]=c;e[3]=h;return e};a.copy=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b};a.set=function(a,b,c,h,e){e[0]=a;e[1]=b;e[2]=c;e[3]=h;return e};a.add=function(a,b,c){c[0]=
a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];c[3]=a[3]+b[3];return c};a.subtract=function(a,b,c){c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];c[3]=a[3]-b[3];return c};a.sub=a.subtract;a.multiply=function(a,b,c){c[0]=a[0]*b[0];c[1]=a[1]*b[1];c[2]=a[2]*b[2];c[3]=a[3]*b[3];return c};a.mul=a.multiply;a.divide=function(a,b,c){c[0]=a[0]/b[0];c[1]=a[1]/b[1];c[2]=a[2]/b[2];c[3]=a[3]/b[3];return c};a.div=a.divide;a.min=function(a,b,c){c[0]=Math.min(a[0],b[0]);c[1]=Math.min(a[1],b[1]);c[2]=Math.min(a[2],b[2]);c[3]=
Math.min(a[3],b[3]);return c};a.max=function(a,b,c){c[0]=Math.max(a[0],b[0]);c[1]=Math.max(a[1],b[1]);c[2]=Math.max(a[2],b[2]);c[3]=Math.max(a[3],b[3]);return c};a.scale=function(a,b,c){c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;c[3]=a[3]*b;return c};a.scaleAndAdd=function(a,b,c,h){h[0]=a[0]+b[0]*c;h[1]=a[1]+b[1]*c;h[2]=a[2]+b[2]*c;h[3]=a[3]+b[3]*c;return h};a.distance=function(a,b){var c=b[0]-a[0],h=b[1]-a[1],e=b[2]-a[2],k=b[3]-a[3];return Math.sqrt(c*c+h*h+e*e+k*k)};a.dist=a.distance;a.squaredDistance=
function(a,b){var c=b[0]-a[0],h=b[1]-a[1],e=b[2]-a[2],k=b[3]-a[3];return c*c+h*h+e*e+k*k};a.sqrDist=a.squaredDistance;a.length=function(a){var b=a[0],c=a[1],h=a[2];a=a[3];return Math.sqrt(b*b+c*c+h*h+a*a)};a.len=a.length;a.squaredLength=function(a){var b=a[0],c=a[1],h=a[2];a=a[3];return b*b+c*c+h*h+a*a};a.sqrLen=a.squaredLength;a.negate=function(a,b){b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=-a[3];return b};a.inverse=function(a,b){b[0]=1/a[0];b[1]=1/a[1];b[2]=1/a[2];b[3]=1/a[3];return b};a.normalize=
function(a,b){var c=a[0],h=a[1],e=a[2],k=a[3],c=c*c+h*h+e*e+k*k;0<c&&(c=1/Math.sqrt(c),b[0]=a[0]*c,b[1]=a[1]*c,b[2]=a[2]*c,b[3]=a[3]*c);return b};a.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};a.lerp=function(a,b,c,h){var e=a[0],k=a[1],g=a[2];a=a[3];h[0]=e+c*(b[0]-e);h[1]=k+c*(b[1]-k);h[2]=g+c*(b[2]-g);h[3]=a+c*(b[3]-a);return h};a.random=function(d,b){d=d||1;b[0]=c();b[1]=c();b[2]=c();b[3]=c();a.normalize(b,b);a.scale(b,d,b);return b};a.transformMat4=function(a,b,c){var h=a[0],
e=a[1],k=a[2];a=a[3];c[0]=b[0]*h+b[4]*e+b[8]*k+b[12]*a;c[1]=b[1]*h+b[5]*e+b[9]*k+b[13]*a;c[2]=b[2]*h+b[6]*e+b[10]*k+b[14]*a;c[3]=b[3]*h+b[7]*e+b[11]*k+b[15]*a;return c};a.transformQuat=function(a,b,c){var h=a[0],e=a[1],k=a[2];a=b[0];var g=b[1],y=b[2];b=b[3];var m=b*h+g*k-y*e,s=b*e+y*h-a*k,x=b*k+a*e-g*h,h=-a*h-g*e-y*k;c[0]=m*b+h*-a+s*-y-x*-g;c[1]=s*b+h*-g+x*-a-m*-y;c[2]=x*b+h*-y+m*-g-s*-a;return c};a.forEach=function(){var c=a.create();return function(a,l,h,e,k,g){l||(l=4);h||(h=0);for(e=e?Math.min(e*
l+h,a.length):a.length;h<e;h+=l)c[0]=a[h],c[1]=a[h+1],c[2]=a[h+2],c[3]=a[h+3],k(c,g,c),a[h]=c[0],a[h+1]=c[1],a[h+2]=c[2],a[h+3]=c[3];return a}}();a.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};"undefined"!==typeof a&&(a.vec4=a)};
b4w.module.quat=function(a,q){var r=q("vec3"),c=q("vec4"),d=q("mat3"),b="undefined"!==typeof Float32Array?Float32Array:Array;a.create=function(){var a=new b(4);a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a};a.rotationTo=function(){var b=r.create(),c=r.fromValues(1,0,0),d=r.fromValues(0,1,0);return function(k,g,y){var m=r.dot(k,g);if(-.9999999>m)return r.cross(c,k,b),1E-6>r.length(b)&&r.cross(d,k,b),r.normalize(b,b),a.setAxisAngle(b,Math.PI,y),y;if(.9999999<m)return y[0]=0,y[1]=0,y[2]=0,y[3]=1,y;r.cross(k,
g,b);y[0]=b[0];y[1]=b[1];y[2]=b[2];y[3]=1+m;return a.normalize(y,y)}}();a.setAxes=function(){var b=d.create();return function(c,d,k,g){b[0]=d[0];b[3]=d[1];b[6]=d[2];b[1]=k[0];b[4]=k[1];b[7]=k[2];b[2]=-c[0];b[5]=-c[1];b[8]=-c[2];return a.normalize(a.fromMat3(b,g),g)}}();a.clone=c.clone;a.fromValues=c.fromValues;a.copy=c.copy;a.set=c.set;a.identity=function(a){a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a};a.setAxisAngle=function(a,b,c){b*=.5;var d=Math.sin(b);c[0]=d*a[0];c[1]=d*a[1];c[2]=d*a[2];c[3]=Math.cos(b);
return c};a.add=c.add;a.multiply=function(a,b,c){var d=a[0],g=a[1],y=a[2];a=a[3];var m=b[0],s=b[1],x=b[2];b=b[3];c[0]=d*b+a*m+g*x-y*s;c[1]=g*b+a*s+y*m-d*x;c[2]=y*b+a*x+d*s-g*m;c[3]=a*b-d*m-g*s-y*x;return c};a.mul=a.multiply;a.scale=c.scale;a.rotateX=function(a,b,c){b*=.5;var d=a[0],g=a[1],y=a[2];a=a[3];var m=Math.sin(b);b=Math.cos(b);c[0]=d*b+a*m;c[1]=g*b+y*m;c[2]=y*b-g*m;c[3]=a*b-d*m;return c};a.rotateY=function(a,b,c){b*=.5;var d=a[0],g=a[1],y=a[2];a=a[3];var m=Math.sin(b);b=Math.cos(b);c[0]=d*
b-y*m;c[1]=g*b+a*m;c[2]=y*b+d*m;c[3]=a*b-g*m;return c};a.rotateZ=function(a,b,c){b*=.5;var d=a[0],g=a[1],y=a[2];a=a[3];var m=Math.sin(b);b=Math.cos(b);c[0]=d*b+g*m;c[1]=g*b-d*m;c[2]=y*b+a*m;c[3]=a*b-y*m;return c};a.calculateW=function(a,b){var c=a[0],d=a[1],g=a[2];b[0]=c;b[1]=d;b[2]=g;b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-g*g));return b};a.dot=c.dot;a.lerp=c.lerp;a.slerp=function(a,b,c,d){var g=a[0],y=a[1],m=a[2];a=a[3];var s=b[0],x=b[1],q=b[2];b=b[3];var r,f,E;f=g*s+y*x+m*q+a*b;0>f&&(f=-f,s=-s,x=-x,
q=-q,b=-b);1E-6<1-f?(r=Math.acos(f),E=Math.sin(r),f=Math.sin((1-c)*r)/E,c=Math.sin(c*r)/E):f=1-c;d[0]=f*g+c*s;d[1]=f*y+c*x;d[2]=f*m+c*q;d[3]=f*a+c*b;return d};a.invert=function(a,b){var c=a[0],d=a[1],g=a[2],y=a[3],m=c*c+d*d+g*g+y*y,m=m?1/m:0;b[0]=-c*m;b[1]=-d*m;b[2]=-g*m;b[3]=y*m;return b};a.conjugate=function(a,b){b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=a[3];return b};a.length=c.length;a.len=a.length;a.squaredLength=c.squaredLength;a.sqrLen=a.squaredLength;a.normalize=c.normalize;a.fromMat3=function(a,
b){var c=a[0]+a[4]+a[8];if(0<c)c=Math.sqrt(c+1),b[3]=.5*c,c=.5/c,b[0]=(a[5]-a[7])*c,b[1]=(a[6]-a[2])*c,b[2]=(a[1]-a[3])*c;else{var d=0;a[4]>a[0]&&(d=1);a[8]>a[3*d+d]&&(d=2);var g=(d+1)%3,y=(d+2)%3,c=Math.sqrt(a[3*d+d]-a[3*g+g]-a[3*y+y]+1);b[d]=.5*c;c=.5/c;b[3]=(a[3*g+y]-a[3*y+g])*c;b[g]=(a[3*g+d]+a[3*d+g])*c;b[y]=(a[3*y+d]+a[3*d+y])*c}return b};a.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};"undefined"!==typeof a&&(a.quat=a)};
b4w.module.mat3=function(a,q){var r="undefined"!==typeof Float32Array?Float32Array:Array;a.create=function(){var a=new r(9);a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return a};a.fromMat4=function(a,d){d[0]=a[0];d[1]=a[1];d[2]=a[2];d[3]=a[4];d[4]=a[5];d[5]=a[6];d[6]=a[8];d[7]=a[9];d[8]=a[10];return d};a.clone=function(a){var d=new r(9);d[0]=a[0];d[1]=a[1];d[2]=a[2];d[3]=a[3];d[4]=a[4];d[5]=a[5];d[6]=a[6];d[7]=a[7];d[8]=a[8];return d};a.copy=function(a,d){d[0]=a[0];d[1]=a[1];d[2]=
a[2];d[3]=a[3];d[4]=a[4];d[5]=a[5];d[6]=a[6];d[7]=a[7];d[8]=a[8];return d};a.identity=function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return a};a.transpose=function(a,d){if(d===a){var b=a[1],l=a[2],h=a[5];d[1]=a[3];d[2]=a[6];d[3]=b;d[5]=a[7];d[6]=l;d[7]=h}else d[0]=a[0],d[1]=a[3],d[2]=a[6],d[3]=a[1],d[4]=a[4],d[5]=a[7],d[6]=a[2],d[7]=a[5],d[8]=a[8];return d};a.invert=function(a,d){var b=a[0],l=a[1],h=a[2],e=a[3],k=a[4],g=a[5],y=a[6],m=a[7],s=a[8],x=s*k-g*m,q=-s*e+g*y,r=
m*e-k*y,f=b*x+l*q+h*r;if(!f)return null;f=1/f;d[0]=x*f;d[1]=(-s*l+h*m)*f;d[2]=(g*l-h*k)*f;d[3]=q*f;d[4]=(s*b-h*y)*f;d[5]=(-g*b+h*e)*f;d[6]=r*f;d[7]=(-m*b+l*y)*f;d[8]=(k*b-l*e)*f;return d};a.adjoint=function(a,d){var b=a[0],l=a[1],h=a[2],e=a[3],k=a[4],g=a[5],y=a[6],m=a[7],s=a[8];d[0]=k*s-g*m;d[1]=h*m-l*s;d[2]=l*g-h*k;d[3]=g*y-e*s;d[4]=b*s-h*y;d[5]=h*e-b*g;d[6]=e*m-k*y;d[7]=l*y-b*m;d[8]=b*k-l*e;return d};a.determinant=function(a){var d=a[3],b=a[4],l=a[5],h=a[6],e=a[7],k=a[8];return a[0]*(k*b-l*e)+a[1]*
(-k*d+l*h)+a[2]*(e*d-b*h)};a.multiply=function(a,d,b){var l=a[0],h=a[1],e=a[2],k=a[3],g=a[4],y=a[5],m=a[6],s=a[7];a=a[8];var x=d[0],q=d[1],r=d[2],f=d[3],E=d[4],n=d[5],t=d[6],M=d[7];d=d[8];b[0]=x*l+q*k+r*m;b[1]=x*h+q*g+r*s;b[2]=x*e+q*y+r*a;b[3]=f*l+E*k+n*m;b[4]=f*h+E*g+n*s;b[5]=f*e+E*y+n*a;b[6]=t*l+M*k+d*m;b[7]=t*h+M*g+d*s;b[8]=t*e+M*y+d*a;return b};a.mul=a.multiply;a.translate=function(a,d,b){var l=a[0],h=a[1],e=a[2],k=a[3],g=a[4],y=a[5],m=a[6],s=a[7];a=a[8];var x=d[0];d=d[1];b[0]=l;b[1]=h;b[2]=e;
b[3]=k;b[4]=g;b[5]=y;b[6]=x*l+d*k+m;b[7]=x*h+d*g+s;b[8]=x*e+d*y+a;return b};a.rotate=function(a,d,b){var l=a[0],h=a[1],e=a[2],k=a[3],g=a[4],y=a[5],m=a[6],s=a[7];a=a[8];var x=Math.sin(d);d=Math.cos(d);b[0]=d*l+x*k;b[1]=d*h+x*g;b[2]=d*e+x*y;b[3]=d*k-x*l;b[4]=d*g-x*h;b[5]=d*y-x*e;b[6]=m;b[7]=s;b[8]=a;return b};a.scale=function(a,d,b){var l=d[0];d=d[1];b[0]=l*a[0];b[1]=l*a[1];b[2]=l*a[2];b[3]=d*a[3];b[4]=d*a[4];b[5]=d*a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return b};a.fromMat2d=function(a,d){d[0]=a[0];d[1]=
a[1];d[2]=0;d[3]=a[2];d[4]=a[3];d[5]=0;d[6]=a[4];d[7]=a[5];d[8]=1;return d};a.fromQuat=function(a,d){var b=a[0],l=a[1],h=a[2],e=a[3],k=b+b,g=l+l,y=h+h,b=b*k,m=l*k,l=l*g,s=h*k,x=h*g,h=h*y,k=e*k,g=e*g,e=e*y;d[0]=1-l-h;d[3]=m-e;d[6]=s+g;d[1]=m+e;d[4]=1-b-h;d[7]=x-k;d[2]=s-g;d[5]=x+k;d[8]=1-b-l;return d};a.normalFromMat4=function(a,d){var b=a[0],l=a[1],h=a[2],e=a[3],k=a[4],g=a[5],y=a[6],m=a[7],s=a[8],x=a[9],q=a[10],r=a[11],f=a[12],E=a[13],n=a[14],t=a[15],M=b*g-l*k,S=b*y-h*k,z=b*m-e*k,B=l*y-h*g,K=l*m-
e*g,v=h*m-e*y,Q=s*E-x*f,O=s*n-q*f,s=s*t-r*f,L=x*n-q*E,x=x*t-r*E,q=q*t-r*n,r=M*q-S*x+z*L+B*s-K*O+v*Q;if(!r)return null;r=1/r;d[0]=(g*q-y*x+m*L)*r;d[1]=(y*s-k*q-m*O)*r;d[2]=(k*x-g*s+m*Q)*r;d[3]=(h*x-l*q-e*L)*r;d[4]=(b*q-h*s+e*O)*r;d[5]=(l*s-b*x-e*Q)*r;d[6]=(E*v-n*K+t*B)*r;d[7]=(n*z-f*v-t*S)*r;d[8]=(f*K-E*z+t*M)*r;return d};a.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};a.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],
2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2))};"undefined"!==typeof a&&(a.mat3=a)};
b4w.module.mat4=function(a,q){var r="undefined"!==typeof Float32Array?Float32Array:Array;a.create=function(){var a=new r(16);a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};a.clone=function(a){var d=new r(16);d[0]=a[0];d[1]=a[1];d[2]=a[2];d[3]=a[3];d[4]=a[4];d[5]=a[5];d[6]=a[6];d[7]=a[7];d[8]=a[8];d[9]=a[9];d[10]=a[10];d[11]=a[11];d[12]=a[12];d[13]=a[13];d[14]=a[14];d[15]=a[15];return d};a.copy=function(a,d){d[0]=a[0];
d[1]=a[1];d[2]=a[2];d[3]=a[3];d[4]=a[4];d[5]=a[5];d[6]=a[6];d[7]=a[7];d[8]=a[8];d[9]=a[9];d[10]=a[10];d[11]=a[11];d[12]=a[12];d[13]=a[13];d[14]=a[14];d[15]=a[15];return d};a.identity=function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};a.transpose=function(a,d){if(d===a){var b=a[1],l=a[2],h=a[3],e=a[6],k=a[7],g=a[11];d[1]=a[4];d[2]=a[8];d[3]=a[12];d[4]=b;d[6]=a[9];d[7]=a[13];d[8]=l;d[9]=e;d[11]=a[14];d[12]=h;d[13]=
k;d[14]=g}else d[0]=a[0],d[1]=a[4],d[2]=a[8],d[3]=a[12],d[4]=a[1],d[5]=a[5],d[6]=a[9],d[7]=a[13],d[8]=a[2],d[9]=a[6],d[10]=a[10],d[11]=a[14],d[12]=a[3],d[13]=a[7],d[14]=a[11],d[15]=a[15];return d};a.invert=function(a,d){var b=a[0],l=a[1],h=a[2],e=a[3],k=a[4],g=a[5],y=a[6],m=a[7],s=a[8],x=a[9],q=a[10],r=a[11],f=a[12],E=a[13],n=a[14],t=a[15],M=b*g-l*k,S=b*y-h*k,z=b*m-e*k,B=l*y-h*g,K=l*m-e*g,v=h*m-e*y,Q=s*E-x*f,O=s*n-q*f,L=s*t-r*f,G=x*n-q*E,V=x*t-r*E,$=q*t-r*n,P=M*$-S*V+z*G+B*L-K*O+v*Q;if(!P)return null;
P=1/P;d[0]=(g*$-y*V+m*G)*P;d[1]=(h*V-l*$-e*G)*P;d[2]=(E*v-n*K+t*B)*P;d[3]=(q*K-x*v-r*B)*P;d[4]=(y*L-k*$-m*O)*P;d[5]=(b*$-h*L+e*O)*P;d[6]=(n*z-f*v-t*S)*P;d[7]=(s*v-q*z+r*S)*P;d[8]=(k*V-g*L+m*Q)*P;d[9]=(l*L-b*V-e*Q)*P;d[10]=(f*K-E*z+t*M)*P;d[11]=(x*z-s*K-r*M)*P;d[12]=(g*O-k*G-y*Q)*P;d[13]=(b*G-l*O+h*Q)*P;d[14]=(E*S-f*B-n*M)*P;d[15]=(s*B-x*S+q*M)*P;return d};a.adjoint=function(a,d){var b=a[0],l=a[1],h=a[2],e=a[3],k=a[4],g=a[5],y=a[6],m=a[7],s=a[8],x=a[9],q=a[10],r=a[11],f=a[12],E=a[13],n=a[14],t=a[15];
d[0]=g*(q*t-r*n)-x*(y*t-m*n)+E*(y*r-m*q);d[1]=-(l*(q*t-r*n)-x*(h*t-e*n)+E*(h*r-e*q));d[2]=l*(y*t-m*n)-g*(h*t-e*n)+E*(h*m-e*y);d[3]=-(l*(y*r-m*q)-g*(h*r-e*q)+x*(h*m-e*y));d[4]=-(k*(q*t-r*n)-s*(y*t-m*n)+f*(y*r-m*q));d[5]=b*(q*t-r*n)-s*(h*t-e*n)+f*(h*r-e*q);d[6]=-(b*(y*t-m*n)-k*(h*t-e*n)+f*(h*m-e*y));d[7]=b*(y*r-m*q)-k*(h*r-e*q)+s*(h*m-e*y);d[8]=k*(x*t-r*E)-s*(g*t-m*E)+f*(g*r-m*x);d[9]=-(b*(x*t-r*E)-s*(l*t-e*E)+f*(l*r-e*x));d[10]=b*(g*t-m*E)-k*(l*t-e*E)+f*(l*m-e*g);d[11]=-(b*(g*r-m*x)-k*(l*r-e*x)+s*
(l*m-e*g));d[12]=-(k*(x*n-q*E)-s*(g*n-y*E)+f*(g*q-y*x));d[13]=b*(x*n-q*E)-s*(l*n-h*E)+f*(l*q-h*x);d[14]=-(b*(g*n-y*E)-k*(l*n-h*E)+f*(l*y-h*g));d[15]=b*(g*q-y*x)-k*(l*q-h*x)+s*(l*y-h*g);return d};a.determinant=function(a){var d=a[0],b=a[1],l=a[2],h=a[3],e=a[4],k=a[5],g=a[6],q=a[7],m=a[8],s=a[9],x=a[10],r=a[11],A=a[12],f=a[13],E=a[14];a=a[15];return(d*k-b*e)*(x*a-r*E)-(d*g-l*e)*(s*a-r*f)+(d*q-h*e)*(s*E-x*f)+(b*g-l*k)*(m*a-r*A)-(b*q-h*k)*(m*E-x*A)+(l*q-h*g)*(m*f-s*A)};a.multiply=function(a,d,b){var l=
a[0],h=a[1],e=a[2],k=a[3],g=a[4],q=a[5],m=a[6],s=a[7],x=a[8],r=a[9],A=a[10],f=a[11],E=a[12],n=a[13],t=a[14];a=a[15];var M=d[0],S=d[1],z=d[2],B=d[3];b[0]=M*l+S*g+z*x+B*E;b[1]=M*h+S*q+z*r+B*n;b[2]=M*e+S*m+z*A+B*t;b[3]=M*k+S*s+z*f+B*a;M=d[4];S=d[5];z=d[6];B=d[7];b[4]=M*l+S*g+z*x+B*E;b[5]=M*h+S*q+z*r+B*n;b[6]=M*e+S*m+z*A+B*t;b[7]=M*k+S*s+z*f+B*a;M=d[8];S=d[9];z=d[10];B=d[11];b[8]=M*l+S*g+z*x+B*E;b[9]=M*h+S*q+z*r+B*n;b[10]=M*e+S*m+z*A+B*t;b[11]=M*k+S*s+z*f+B*a;M=d[12];S=d[13];z=d[14];B=d[15];b[12]=M*l+
S*g+z*x+B*E;b[13]=M*h+S*q+z*r+B*n;b[14]=M*e+S*m+z*A+B*t;b[15]=M*k+S*s+z*f+B*a;return b};a.mul=a.multiply;a.translate=function(a,d,b){var l=d[0],h=d[1];d=d[2];var e,k,g,q,m,s,x,r,A,f,E,n;a===b?(b[12]=a[0]*l+a[4]*h+a[8]*d+a[12],b[13]=a[1]*l+a[5]*h+a[9]*d+a[13],b[14]=a[2]*l+a[6]*h+a[10]*d+a[14],b[15]=a[3]*l+a[7]*h+a[11]*d+a[15]):(e=a[0],k=a[1],g=a[2],q=a[3],m=a[4],s=a[5],x=a[6],r=a[7],A=a[8],f=a[9],E=a[10],n=a[11],b[0]=e,b[1]=k,b[2]=g,b[3]=q,b[4]=m,b[5]=s,b[6]=x,b[7]=r,b[8]=A,b[9]=f,b[10]=E,b[11]=n,
b[12]=e*l+m*h+A*d+a[12],b[13]=k*l+s*h+f*d+a[13],b[14]=g*l+x*h+E*d+a[14],b[15]=q*l+r*h+n*d+a[15]);return b};a.scale=function(a,d,b){var l=d[0],h=d[1];d=d[2];b[0]=a[0]*l;b[1]=a[1]*l;b[2]=a[2]*l;b[3]=a[3]*l;b[4]=a[4]*h;b[5]=a[5]*h;b[6]=a[6]*h;b[7]=a[7]*h;b[8]=a[8]*d;b[9]=a[9]*d;b[10]=a[10]*d;b[11]=a[11]*d;b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b};a.rotate=function(a,d,b,l){var h=b[0],e=b[1];b=b[2];var k=Math.sqrt(h*h+e*e+b*b),g,q,m,s,x,r,A,f,E,n,t,M,S,z,B,K,v,Q,O,L;if(1E-7>Math.abs(k))return null;
k=1/k;h*=k;e*=k;b*=k;g=Math.sin(d);q=Math.cos(d);m=1-q;d=a[0];k=a[1];s=a[2];x=a[3];r=a[4];A=a[5];f=a[6];E=a[7];n=a[8];t=a[9];M=a[10];S=a[11];z=h*h*m+q;B=e*h*m+b*g;K=b*h*m-e*g;v=h*e*m-b*g;Q=e*e*m+q;O=b*e*m+h*g;L=h*b*m+e*g;h=e*b*m-h*g;e=b*b*m+q;l[0]=d*z+r*B+n*K;l[1]=k*z+A*B+t*K;l[2]=s*z+f*B+M*K;l[3]=x*z+E*B+S*K;l[4]=d*v+r*Q+n*O;l[5]=k*v+A*Q+t*O;l[6]=s*v+f*Q+M*O;l[7]=x*v+E*Q+S*O;l[8]=d*L+r*h+n*e;l[9]=k*L+A*h+t*e;l[10]=s*L+f*h+M*e;l[11]=x*L+E*h+S*e;a!==l&&(l[12]=a[12],l[13]=a[13],l[14]=a[14],l[15]=a[15]);
return l};a.rotateX=function(a,d,b){var l=Math.sin(d);d=Math.cos(d);var h=a[4],e=a[5],k=a[6],g=a[7],q=a[8],m=a[9],s=a[10],x=a[11];a!==b&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]);b[4]=h*d+q*l;b[5]=e*d+m*l;b[6]=k*d+s*l;b[7]=g*d+x*l;b[8]=q*d-h*l;b[9]=m*d-e*l;b[10]=s*d-k*l;b[11]=x*d-g*l;return b};a.rotateY=function(a,d,b){var l=Math.sin(d);d=Math.cos(d);var h=a[0],e=a[1],k=a[2],g=a[3],q=a[8],m=a[9],s=a[10],x=a[11];a!==b&&(b[4]=a[4],b[5]=a[5],b[6]=a[6],
b[7]=a[7],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]);b[0]=h*d-q*l;b[1]=e*d-m*l;b[2]=k*d-s*l;b[3]=g*d-x*l;b[8]=h*l+q*d;b[9]=e*l+m*d;b[10]=k*l+s*d;b[11]=g*l+x*d;return b};a.rotateZ=function(a,d,b){var l=Math.sin(d);d=Math.cos(d);var h=a[0],e=a[1],k=a[2],g=a[3],q=a[4],m=a[5],s=a[6],x=a[7];a!==b&&(b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]);b[0]=h*d+q*l;b[1]=e*d+m*l;b[2]=k*d+s*l;b[3]=g*d+x*l;b[4]=q*d-h*l;b[5]=m*d-e*l;b[6]=s*d-k*l;b[7]=x*d-g*l;return b};
a.fromRotationTranslation=function(a,d,b){var l=a[0],h=a[1],e=a[2],k=a[3],g=l+l,q=h+h,m=e+e;a=l*g;var s=l*q,l=l*m,x=h*q,h=h*m,e=e*m,g=k*g,q=k*q,k=k*m;b[0]=1-(x+e);b[1]=s+k;b[2]=l-q;b[3]=0;b[4]=s-k;b[5]=1-(a+e);b[6]=h+g;b[7]=0;b[8]=l+q;b[9]=h-g;b[10]=1-(a+x);b[11]=0;b[12]=d[0];b[13]=d[1];b[14]=d[2];b[15]=1;return b};a.fromQuat=function(a,d){var b=a[0],l=a[1],h=a[2],e=a[3],k=b+b,g=l+l,q=h+h,b=b*k,m=l*k,l=l*g,s=h*k,x=h*g,h=h*q,k=e*k,g=e*g,e=e*q;d[0]=1-l-h;d[1]=m+e;d[2]=s-g;d[3]=0;d[4]=m-e;d[5]=1-b-h;
d[6]=x+k;d[7]=0;d[8]=s+g;d[9]=x-k;d[10]=1-b-l;d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return d};a.frustum=function(a,d,b,l,h,e,k){var g=1/(d-a),q=1/(l-b),m=1/(h-e);k[0]=2*h*g;k[1]=0;k[2]=0;k[3]=0;k[4]=0;k[5]=2*h*q;k[6]=0;k[7]=0;k[8]=(d+a)*g;k[9]=(l+b)*q;k[10]=(e+h)*m;k[11]=-1;k[12]=0;k[13]=0;k[14]=e*h*2*m;k[15]=0;return k};a.perspective=function(a,d,b,l,h){a=1/Math.tan(a/2);var e=1/(b-l);h[0]=a/d;h[1]=0;h[2]=0;h[3]=0;h[4]=0;h[5]=a;h[6]=0;h[7]=0;h[8]=0;h[9]=0;h[10]=(l+b)*e;h[11]=-1;h[12]=0;h[13]=0;
h[14]=2*l*b*e;h[15]=0;return h};a.ortho=function(a,d,b,l,h,e,k){var g=1/(a-d),q=1/(b-l),m=1/(h-e);k[0]=-2*g;k[1]=0;k[2]=0;k[3]=0;k[4]=0;k[5]=-2*q;k[6]=0;k[7]=0;k[8]=0;k[9]=0;k[10]=2*m;k[11]=0;k[12]=(a+d)*g;k[13]=(l+b)*q;k[14]=(e+h)*m;k[15]=1;return k};a.lookAt=function(c,d,b,l){var h,e,k,g,q,m,s,x,r=c[0],A=c[1];c=c[2];k=b[0];g=b[1];e=b[2];s=d[0];b=d[1];h=d[2];if(1E-7>Math.abs(r-s)&&1E-7>Math.abs(A-b)&&1E-7>Math.abs(c-h))return a.identity(l);d=r-s;b=A-b;s=c-h;x=1/Math.sqrt(d*d+b*b+s*s);d*=x;b*=x;s*=
x;h=g*s-e*b;e=e*d-k*s;k=k*b-g*d;(x=Math.sqrt(h*h+e*e+k*k))?(x=1/x,h*=x,e*=x,k*=x):k=e=h=0;g=b*k-s*e;q=s*h-d*k;m=d*e-b*h;(x=Math.sqrt(g*g+q*q+m*m))?(x=1/x,g*=x,q*=x,m*=x):m=q=g=0;l[0]=h;l[1]=g;l[2]=d;l[3]=0;l[4]=e;l[5]=q;l[6]=b;l[7]=0;l[8]=k;l[9]=m;l[10]=s;l[11]=0;l[12]=-(h*r+e*A+k*c);l[13]=-(g*r+q*A+m*c);l[14]=-(d*r+b*A+s*c);l[15]=1;return l};a.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+
", "+a[13]+", "+a[14]+", "+a[15]+")"};a.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2)+Math.pow(a[9],2)+Math.pow(a[10],2)+Math.pow(a[11],2)+Math.pow(a[12],2)+Math.pow(a[13],2)+Math.pow(a[14],2)+Math.pow(a[15],2))};"undefined"!==typeof a&&(a.mat4=a)};b4w.module.__gpp_eval=function(a,q){a.parser=function(){function a(c,d,b,l,h,e){this.message=c;this.expected=d;this.found=b;this.offset=l;this.line=h;this.column=e;this.name="SyntaxError"}(function(a,d){function b(){this.constructor=a}b.prototype=d.prototype;a.prototype=new b})(a,Error);return{SyntaxError:a,parse:function(c){function d(a){if(Ia!==a){Ia>a&&(Ia=0,pa={line:1,column:1,seenCR:!1});var b=pa,d,e;for(d=Ia;d<a;d++)e=c.charAt(d),"\n"===e?(b.seenCR||b.line++,b.column=1,b.seenCR=!1):"\r"===e||
"\u2028"===e||"\u2029"===e?(b.line++,b.column=1,b.seenCR=!0):(b.column++,b.seenCR=!1);Ia=a}return pa}function b(a){J<fb||(J>fb&&(fb=J,wa=[]),wa.push(a))}function l(){var a,d,e;a=J;d=p();d!==F?(d=h(),d!==F?(e=p(),e!==F?(ba++,10===c.charCodeAt(J)?(e=Fa,J++):(e=F,0===ba&&b(zb)),e===F&&(c.substr(J,2)===Nb?(e=Nb,J+=2):(e=F,0===ba&&b(bc)),e===F&&(13===c.charCodeAt(J)?(e=Fb,J++):(e=F,0===ba&&b(mb)))),ba--,e===F&&0===ba&&b(Mb),e===F&&(e=I),e!==F?a=d:(J=a,a=D)):(J=a,a=D)):(J=a,a=D)):(J=a,a=D);return a}function h(){var a,
d,f,g,h,k,m,l;a=J;d=e();if(d!==F){f=[];g=J;h=p();h!==F?(44===c.charCodeAt(J)?(k=ia,J++):(k=F,0===ba&&b(ka)),k!==F?(m=p(),m!==F?(l=e(),l!==F?g=h=[h,k,m,l]:(J=g,g=D)):(J=g,g=D)):(J=g,g=D)):(J=g,g=D);for(;g!==F;)f.push(g),g=J,h=p(),h!==F?(44===c.charCodeAt(J)?(k=ia,J++):(k=F,0===ba&&b(ka)),k!==F?(m=p(),m!==F?(l=e(),l!==F?g=h=[h,k,m,l]:(J=g,g=D)):(J=g,g=D)):(J=g,g=D)):(J=g,g=D);f!==F?(0!=f.length&&(d=f[f.length-1]),a=d):(J=a,a=D)}else J=a,a=D;return a}function e(){var a,d,e,f;a=J;d=k();d!==F?(e=p(),e!==
F?(63===c.charCodeAt(J)?(e=qa,J++):(e=F,0===ba&&b(H)),e!==F?(e=p(),e!==F?(e=h(),e!==F?(f=p(),f!==F?(58===c.charCodeAt(J)?(f=fa,J++):(f=F,0===ba&&b(w)),f!==F?(f=p(),f!==F?(f=h(),f!==F?a=d?e:f:(J=a,a=D)):(J=a,a=D)):(J=a,a=D)):(J=a,a=D)):(J=a,a=D)):(J=a,a=D)):(J=a,a=D)):(J=a,a=D)):(J=a,a=D);a===F&&(a=k());return a}function k(){var a,b,c,d,e,f,h,k;a=J;b=g();if(b!==F){c=[];d=J;e=p();e!==F?(f=X(),f!==F?(h=p(),h!==F?(k=g(),k!==F?d=e=[e,f,h,k]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);for(;d!==F;)c.push(d),
d=J,e=p(),e!==F?(f=X(),f!==F?(h=p(),h!==F?(k=g(),k!==F?d=e=[e,f,h,k]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);if(c!==F)for(a=b,b=0;b<c.length;b++)a=a||c[b][3];else J=a,a=D}else J=a,a=D;return a}function g(){var a,b,c,d,e,f,g,h;a=J;b=q();if(b!==F){c=[];d=J;e=p();e!==F?(f=T(),f!==F?(g=p(),g!==F?(h=q(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);for(;d!==F;)c.push(d),d=J,e=p(),e!==F?(f=T(),f!==F?(g=p(),g!==F?(h=q(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);if(c!==
F)for(a=b,b=0;b<c.length;b++)a=a&&c[b][3];else J=a,a=D}else J=a,a=D;return a}function q(){var a,b,c,d,e,f,g,h;a=J;b=m();if(b!==F){c=[];d=J;e=p();e!==F?(f=Y(),f!==F?(g=p(),g!==F?(h=m(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);for(;d!==F;)c.push(d),d=J,e=p(),e!==F?(f=Y(),f!==F?(g=p(),g!==F?(h=m(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);if(c!==F)for(a=b,b=0;b<c.length;b++)a|=c[b][3];else J=a,a=D}else J=a,a=D;return a}function m(){var a,b,c,d,e,f,g,h;a=J;b=
s();if(b!==F){c=[];d=J;e=p();e!==F?(f=P(),f!==F?(g=p(),g!==F?(h=s(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);for(;d!==F;)c.push(d),d=J,e=p(),e!==F?(f=P(),f!==F?(g=p(),g!==F?(h=s(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);if(c!==F)for(a=b,b=0;b<c.length;b++)a^=c[b][3];else J=a,a=D}else J=a,a=D;return a}function s(){var a,b,c,d,e,f,g,h;a=J;b=x();if(b!==F){c=[];d=J;e=p();e!==F?(f=$(),f!==F?(g=p(),g!==F?(h=x(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,
d=D)):(J=d,d=D);for(;d!==F;)c.push(d),d=J,e=p(),e!==F?(f=$(),f!==F?(g=p(),g!==F?(h=x(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);if(c!==F)for(a=b,b=0;b<c.length;b++)a&=c[b][3];else J=a,a=D}else J=a,a=D;return a}function x(){var a,b,c,d,e,f,g,h;a=J;b=C();if(b!==F){c=[];d=J;e=p();e!==F?(f=V(),f!==F?(g=p(),g!==F?(h=C(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);for(;d!==F;)c.push(d),d=J,e=p(),e!==F?(f=V(),f!==F?(g=p(),g!==F?(h=C(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):
(J=d,d=D)):(J=d,d=D)):(J=d,d=D);if(c!==F)for(a=b,b=0;b<c.length;b++)switch(c[b][1]){case "==":a=a==c[b][3];break;case "!=":a=a!=c[b][3]}else J=a,a=D}else J=a,a=D;return a}function C(){var a,b,c,d,e,f,g,h;a=J;b=A();if(b!==F){c=[];d=J;e=p();e!==F?(f=G(),f!==F?(g=p(),g!==F?(h=A(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);for(;d!==F;)c.push(d),d=J,e=p(),e!==F?(f=G(),f!==F?(g=p(),g!==F?(h=A(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);if(c!==F)for(a=b,b=0;b<c.length;b++)switch(c[b][1]){case "<=":a=
a<=c[b][3];break;case ">=":a=a>=c[b][3];break;case "<":a=a<c[b][3];break;case ">":a=a>c[b][3]}else J=a,a=D}else J=a,a=D;return a}function A(){var a,b,c,d,e,g,h,k;a=J;b=f();if(b!==F){c=[];d=J;e=p();e!==F?(g=L(),g!==F?(h=p(),h!==F?(k=f(),k!==F?d=e=[e,g,h,k]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);for(;d!==F;)c.push(d),d=J,e=p(),e!==F?(g=L(),g!==F?(h=p(),h!==F?(k=f(),k!==F?d=e=[e,g,h,k]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);if(c!==F)for(a=b,b=0;b<c.length;b++)switch(c[b][1]){case "<<":a<<=c[b][3];
break;case ">>":a>>=c[b][3]}else J=a,a=D}else J=a,a=D;return a}function f(){var a,b,c,d,e,f,g,h;a=J;b=E();if(b!==F){c=[];d=J;e=p();e!==F?(f=O(),f!==F?(g=p(),g!==F?(h=E(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);for(;d!==F;)c.push(d),d=J,e=p(),e!==F?(f=O(),f!==F?(g=p(),g!==F?(h=E(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);if(c!==F)for(a=b,b=0;b<c.length;b++)switch(c[b][1]){case "+":a+=c[b][3];break;case "-":a-=c[b][3]}else J=a,a=D}else J=a,a=D;return a}function E(){var a,
b,c,d,e,f,g,h;a=J;b=n();if(b!==F){c=[];d=J;e=p();e!==F?(f=Q(),f!==F?(g=p(),g!==F?(h=n(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);for(;d!==F;)c.push(d),d=J,e=p(),e!==F?(f=Q(),f!==F?(g=p(),g!==F?(h=n(),h!==F?d=e=[e,f,g,h]:(J=d,d=D)):(J=d,d=D)):(J=d,d=D)):(J=d,d=D);if(c!==F)for(a=b,b=0;b<c.length;b++)switch(c[b][1]){case "*":a*=c[b][3];break;case "/":a=Math.floor(a/c[b][3]);break;case "%":a%=c[b][3]}else J=a,a=D}else J=a,a=D;return a}function n(){var a,d,e;a=J;c.substr(J,7)===ja?
(d=ja,J+=7):(d=F,0===ba&&b(oa));d!==F?(e=p(),e!==F?(e=M(),e!==F?a=e:(J=a,a=D)):(J=a,a=D)):(J=a,a=D);if(a===F){a=J;d=t();if(d!==F)if(e=p(),e!==F)if(c.substr(J,2)===db?(e=db,J+=2):(e=F,0===ba&&b(Ub)),e===F&&(c.substr(J,2)===Dc?(e=Dc,J+=2):(e=F,0===ba&&b(Cb))),e!==F){a:{a=d;switch(e){case "++":d=++a;break a;case "--":d=--a;break a}d=void 0}a=d}else J=a,a=D;else J=a,a=D;else J=a,a=D;a===F&&(a=t());a===F&&(a=J,c.substr(J,2)===db?(d=db,J+=2):(d=F,0===ba&&b(Ub)),d===F&&(c.substr(J,2)===Dc?(d=Dc,J+=2):(d=
F,0===ba&&b(Cb)),d===F&&(43===c.charCodeAt(J)?(d=ic,J++):(d=F,0===ba&&b(vb)),d===F&&(45===c.charCodeAt(J)?(d=pd,J++):(d=F,0===ba&&b(wb)),d===F&&(126===c.charCodeAt(J)?(d=td,J++):(d=F,0===ba&&b(qd)),d===F&&(33===c.charCodeAt(J)?(d=rd,J++):(d=F,0===ba&&b(sd))))))),d!==F?(e=p(),e!==F?(e=n(),e!==F?a=d=ca(d,e):(J=a,a=D)):(J=a,a=D)):(J=a,a=D))}return a}function t(){var a,d,e;ba++;var f;a=J;48===c.charCodeAt(J)?(d=na,J++):(d=F,0===ba&&b(bb));if(d!==F)if(Kb.test(c.charAt(J))?(d=c.charAt(J),J++):(d=F,0===
ba&&b(Tb)),d!==F){d=J;e=[];f=z();if(f!==F)for(;f!==F;)e.push(f),f=z();else e=D;e!==F&&(e=c.substring(d,J));d=e;d!==F?a=d=parseInt("0x"+d):(J=a,a=D)}else J=a,a=D;else J=a,a=D;if(a===F){a=J;48===c.charCodeAt(J)?(d=na,J++):(d=F,0===ba&&b(bb));if(d===F)if(d=J,cb.test(c.charAt(J))?(e=c.charAt(J),J++):(e=F,0===ba&&b(Qa)),e!==F){var g;f=[];g=S();if(g!==F)for(;g!==F;)f.push(g),g=S();else f=D;f===F&&(f=I);f!==F?d=e=[e,f]:(J=d,d=D)}else J=d,d=D;d!==F&&(d=c.substring(a,J));a=d;a!==F&&(a=parseInt(a))}ba--;a===
F&&0===ba&&b(Ya);a===F&&(d=B(),d!==F&&(d=0),a=d,a===F&&(a=J,40===c.charCodeAt(J)?(d=qb,J++):(d=F,0===ba&&b(ma)),d!==F?(d=p(),d!==F?(d=h(),d!==F?(e=p(),e!==F?(41===c.charCodeAt(J)?(e=R,J++):(e=F,0===ba&&b(ta)),e!==F?a=d:(J=a,a=D)):(J=a,a=D)):(J=a,a=D)):(J=a,a=D)):(J=a,a=D)));return a}function M(){var a,d,e,f,g;d=B();d!==F&&(d=0);a=d;if(a===F){d=[];f=e=J;ba++;40===c.charCodeAt(J)?(g=qb,J++):(g=F,0===ba&&b(ma));g===F&&(41===c.charCodeAt(J)?(g=R,J++):(g=F,0===ba&&b(ta)));ba--;g===F?f=aa:(J=f,f=D);f!==
F?(g=Z(),g!==F?e=f=[f,g]:(J=e,e=D)):(J=e,e=D);if(e!==F)for(;e!==F;)d.push(e),f=e=J,ba++,40===c.charCodeAt(J)?(g=qb,J++):(g=F,0===ba&&b(ma)),g===F&&(41===c.charCodeAt(J)?(g=R,J++):(g=F,0===ba&&b(ta))),ba--,g===F?f=aa:(J=f,f=D),f!==F?(g=Z(),g!==F?e=f=[f,g]:(J=e,e=D)):(J=e,e=D);else d=D;d!==F&&(d=1);a=d;a===F&&(a=J,40===c.charCodeAt(J)?(d=qb,J++):(d=F,0===ba&&b(ma)),d!==F?(e=p(),e!==F?(f=M(),f!==F?(g=p(),g!==F?(41===c.charCodeAt(J)?(d=R,J++):(d=F,0===ba&&b(ta)),d!==F?a=f:(J=a,a=D)):(J=a,a=D)):(J=a,a=
D)):(J=a,a=D)):(J=a,a=D))}return a}function S(){var a;Aa.test(c.charAt(J))?(a=c.charAt(J),J++):(a=F,0===ba&&b(Jb));return a}function z(){var a;bd.test(c.charAt(J))?(a=c.charAt(J),J++):(a=F,0===ba&&b(hc));return a}function B(){var a,d;ba++;d=a=J;ba++;var e,f,g,h;e=J;c.substr(J,7)===ja?(f=ja,J+=7):(f=F,0===ba&&b(oa));f!==F?(g=J,ba++,h=v(),ba--,h===F?g=aa:(J=g,g=D),g!==F?e=f=[f,g]:(J=e,e=D)):(J=e,e=D);ba--;e===F?d=aa:(J=d,d=D);if(d!==F){ba++;d=J;e=K();if(e!==F){f=[];for(g=v();g!==F;)f.push(g),g=v();
f!==F?d=e+=f.join(""):(J=d,d=D)}else J=d,d=D;ba--;d===F&&0===ba&&b(Va);d!==F?a=d:(J=a,a=D)}else J=a,a=D;ba--;a===F&&0===ba&&b(Va);return a}function K(){var a;ib.test(c.charAt(J))?(a=c.charAt(J),J++):(a=F,0===ba&&b(Ba));a===F&&(36===c.charCodeAt(J)?(a=Ta,J++):(a=F,0===ba&&b(ob)),a===F&&(95===c.charCodeAt(J)?(a=Ua,J++):(a=F,0===ba&&b(Wa))));return a}function v(){var a;a=K();a===F&&(a=S());return a}function Q(){var a,d,e,f;a=J;42===c.charCodeAt(J)?(d=xb,J++):(d=F,0===ba&&b(rb));d===F&&(47===c.charCodeAt(J)?
(d=Db,J++):(d=F,0===ba&&b(rc)),d===F&&(37===c.charCodeAt(J)?(d=jd,J++):(d=F,0===ba&&b(Kc))));d!==F?(e=J,ba++,61===c.charCodeAt(J)?(f=Uc,J++):(f=F,0===ba&&b(sc)),ba--,f===F?e=aa:(J=e,e=D),e!==F?a=d:(J=a,a=D)):(J=a,a=D);return a}function O(){var a,d,e;a=J;43===c.charCodeAt(J)?(d=ic,J++):(d=F,0===ba&&b(vb));d!==F?(d=J,ba++,43===c.charCodeAt(J)?(e=ic,J++):(e=F,0===ba&&b(vb)),e===F&&(61===c.charCodeAt(J)?(e=Uc,J++):(e=F,0===ba&&b(sc))),ba--,e===F?d=aa:(J=d,d=D),d!==F?a="+":(J=a,a=D)):(J=a,a=D);a===F&&
(a=J,45===c.charCodeAt(J)?(d=pd,J++):(d=F,0===ba&&b(wb)),d!==F?(d=J,ba++,45===c.charCodeAt(J)?(e=pd,J++):(e=F,0===ba&&b(wb)),e===F&&(61===c.charCodeAt(J)?(e=Uc,J++):(e=F,0===ba&&b(sc))),ba--,e===F?d=aa:(J=d,d=D),d!==F?a="-":(J=a,a=D)):(J=a,a=D));return a}function L(){var a;c.substr(J,2)===cd?(a=cd,J+=2):(a=F,0===ba&&b(Ga));a===F&&(c.substr(J,2)===yb?(a=yb,J+=2):(a=F,0===ba&&b(pb)));return a}function G(){var a;c.substr(J,2)===ya?(a=ya,J+=2):(a=F,0===ba&&b(Sa));a===F&&(c.substr(J,2)===da?(a=da,J+=2):
(a=F,0===ba&&b(Za)),a===F&&(60===c.charCodeAt(J)?(a=Eb,J++):(a=F,0===ba&&b(ra)),a===F&&(62===c.charCodeAt(J)?(a=Pa,J++):(a=F,0===ba&&b(jc)))));return a}function V(){var a;c.substr(J,2)===Ha?(a=Ha,J+=2):(a=F,0===ba&&b(Ka));a===F&&(c.substr(J,2)===eb?(a=eb,J+=2):(a=F,0===ba&&b(tc)));return a}function $(){var a,d,e;a=J;38===c.charCodeAt(J)?(d=sa,J++):(d=F,0===ba&&b(Xa));d!==F?(d=J,ba++,38===c.charCodeAt(J)?(e=sa,J++):(e=F,0===ba&&b(Xa)),ba--,e===F?d=aa:(J=d,d=D),d!==F?a="&":(J=a,a=D)):(J=a,a=D);return a}
function P(){var a,d,e;a=J;94===c.charCodeAt(J)?(d=Oa,J++):(d=F,0===ba&&b(Ec));d!==F?(d=J,ba++,94===c.charCodeAt(J)?(e=Oa,J++):(e=F,0===ba&&b(Ec)),ba--,e===F?d=aa:(J=d,d=D),d!==F?a="^":(J=a,a=D)):(J=a,a=D);return a}function Y(){var a,d,e;a=J;124===c.charCodeAt(J)?(d=kc,J++):(d=F,0===ba&&b(uc));d!==F?(d=J,ba++,124===c.charCodeAt(J)?(e=kc,J++):(e=F,0===ba&&b(uc)),ba--,e===F?d=aa:(J=d,d=D),d!==F?a="|":(J=a,a=D)):(J=a,a=D);return a}function T(){var a;c.substr(J,2)===vc?(a=vc,J+=2):(a=F,0===ba&&b(lb));
a!==F&&(a="&&");return a}function X(){var a;c.substr(J,2)===sb?(a=sb,J+=2):(a=F,0===ba&&b(Lb));a!==F&&(a="||");return a}function p(){var a,b;a=[];for(b=ga();b!==F;)a.push(b),b=ga();return a}function ga(){var a;ba++;tb.test(c.charAt(J))?(a=c.charAt(J),J++):(a=F,0===ba&&b(Wb));ba--;a===F&&0===ba&&b(Vb);return a}function Z(){var a;c.length>J?(a=c.charAt(J),J++):(a=F,0===ba&&b(hb));return a}var N=1<arguments.length?arguments[1]:{},F={},ha={start:l},ea=l,D=F,I=null,ia=",",ka={type:"literal",value:",",
description:'","'},qa="?",H={type:"literal",value:"?",description:'"?"'},fa=":",w={type:"literal",value:":",description:'":"'},ja="defined",oa={type:"literal",value:"defined",description:'"defined"'},ca=function(a,b){switch(a){case "++":return++b;case "--":return--b;case "+":return+b;case "-":return-b;case "~":return~b;case "!":return!b}},qb="(",ma={type:"literal",value:"(",description:'"("'},R=")",ta={type:"literal",value:")",description:'")"'},aa=void 0,Ya={type:"other",description:"number"},na=
"0",bb={type:"literal",value:"0",description:'"0"'},Aa=/^[0-9]/,Jb={type:"class",value:"[0-9]",description:"[0-9]"},cb=/^[1-9]/,Qa={type:"class",value:"[1-9]",description:"[1-9]"},Kb=/^[xX]/,Tb={type:"class",value:"[xX]",description:"[xX]"},bd=/^[0-9a-fA-F]/,hc={type:"class",value:"[0-9a-fA-F]",description:"[0-9a-fA-F]"},Va={type:"other",description:"identifier"},Ta="$",ob={type:"literal",value:"$",description:'"$"'},Ua="_",Wa={type:"literal",value:"_",description:'"_"'},ib=/^[a-zA-Z]/,Ba={type:"class",
value:"[a-zA-Z]",description:"[a-zA-Z]"},db="++",Ub={type:"literal",value:"++",description:'"++"'},Dc="--",Cb={type:"literal",value:"--",description:'"--"'},ic="+",vb={type:"literal",value:"+",description:'"+"'},pd="-",wb={type:"literal",value:"-",description:'"-"'},td="~",qd={type:"literal",value:"~",description:'"~"'},rd="!",sd={type:"literal",value:"!",description:'"!"'},xb="*",rb={type:"literal",value:"*",description:'"*"'},Db="/",rc={type:"literal",value:"/",description:'"/"'},jd="%",Kc={type:"literal",
value:"%",description:'"%"'},Uc="=",sc={type:"literal",value:"=",description:'"="'},cd="<<",Ga={type:"literal",value:"<<",description:'"<<"'},yb=">>",pb={type:"literal",value:">>",description:'">>"'},ya="<=",Sa={type:"literal",value:"<=",description:'"<="'},da=">=",Za={type:"literal",value:">=",description:'">="'},Eb="<",ra={type:"literal",value:"<",description:'"<"'},Pa=">",jc={type:"literal",value:">",description:'">"'},Ha="==",Ka={type:"literal",value:"==",description:'"=="'},eb="!=",tc={type:"literal",
value:"!=",description:'"!="'},sa="&",Xa={type:"literal",value:"&",description:'"&"'},Oa="^",Ec={type:"literal",value:"^",description:'"^"'},kc="|",uc={type:"literal",value:"|",description:'"|"'},vc="&&",lb={type:"literal",value:"&&",description:'"&&"'},sb="||",Lb={type:"literal",value:"||",description:'"||"'},Vb={type:"other",description:"whitespace"},tb=/^[\t\x0B\f ]/,Wb={type:"class",value:"[\\t\\x0B\\f ]",description:"[\\t\\x0B\\f ]"},Mb={type:"other",description:"end of line"},Fa="\n",zb={type:"literal",
value:"\n",description:'"\\n"'},Nb="\r\n",bc={type:"literal",value:"\r\n",description:'"\\r\\n"'},Fb="\r",mb={type:"literal",value:"\r",description:'"\\r"'},hb={type:"any",description:"any character"},J=0,Ia=0,pa={line:1,column:1,seenCR:!1},fb=0,wa=[],ba=0,La;if("startRule"in N){if(!(N.startRule in ha))throw Error("Can't start parsing from rule \""+N.startRule+'".');ea=ha[N.startRule]}La=ea();if(La!==F&&J===c.length)return La;La!==F&&J<c.length&&b({type:"end",description:"end of input"});throw function(b,
e,f){function g(a){var b=1;for(a.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0});b<a.length;)a[b-1]===a[b]?a.splice(b,1):b++}function h(a,b){function c(a){function b(a){return a.charCodeAt(0).toString(16).toUpperCase()}return a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(a){return"\\x0"+b(a)}).replace(/[\x10-\x1F\x80-\xFF]/g,
function(a){return"\\x"+b(a)}).replace(/[\u0180-\u0FFF]/g,function(a){return"\\u0"+b(a)}).replace(/[\u1080-\uFFFF]/g,function(a){return"\\u"+b(a)})}var d=Array(a.length),e;for(e=0;e<a.length;e++)d[e]=a[e].description;d=1<a.length?d.slice(0,-1).join(", ")+" or "+d[a.length-1]:d[0];e=b?'"'+c(b)+'"':"end of input";return"Expected "+d+" but "+e+" found."}var k=d(f),m=f<c.length?c.charAt(f):null;null!==e&&g(e);return new a(null!==b?b:h(e,m),e,m,f,k.line,k.column)}(null,wa,fb);}}}()};b4w.module.__gpp_parser=function(a,q){a.parser=function(){function a(c,d,b,l,h,e){this.message=c;this.expected=d;this.found=b;this.offset=l;this.line=h;this.column=e;this.name="SyntaxError"}(function(a,d){function b(){this.constructor=a}b.prototype=d.prototype;a.prototype=new b})(a,Error);return{SyntaxError:a,parse:function(c){function d(a){if(Ld!==a){Ld>a&&(Ld=0,Ud={line:1,column:1,seenCR:!1});var b=Ud,d,e;for(d=Ld;d<a;d++)e=c.charAt(d),"\n"===e?(b.seenCR||b.line++,b.column=1,b.seenCR=!1):"\r"===
e||"\u2028"===e||"\u2029"===e?(b.line++,b.column=1,b.seenCR=!0):(b.column++,b.seenCR=!1);Ld=a}return Ud}function b(a){u<Qd||(u>Qd&&(Qd=u,Vd=[]),Vd.push(a))}function l(){var a,b,c;a=u;b=Q();b!==p?(b=h(),b!==p?(c=Q(),c!==p?a=b:(u=a,a=N)):(u=a,a=N)):(u=a,a=N);return a}function h(){var a,b,c,d,f,g;a=u;b=e();if(b!==p){c=[];d=u;f=Q();f!==p?(g=e(),g!==p?d=f=[f,g]:(u=d,d=N)):(u=d,d=N);for(;d!==p;)c.push(d),d=u,f=Q(),f!==p?(g=e(),g!==p?d=f=[f,g]:(u=d,d=N)):(u=d,d=N);c!==p?a=b=ha(b,c):(u=a,a=N)}else u=a,a=
N;a===p&&(a=F);a!==p&&(a={type:"group",parts:null!==a?a:[]});return a}function e(){var a,d,e,f,l,n,s,t,x;d=u;var q,r,y,w,A,C,z,B,E,M;q=u;35===c.charCodeAt(u)?(r=ea,u++):(r=p,0===U&&b(D));r!==p?(y=K(),y!==p?(c.substr(u,2)===I?(w=I,u+=2):(w=p,0===U&&b(ia)),w!==p?(A=v(),A!==p?(C=g(),C!==p?(z=K(),z!==p?(B=G(),B!==p?(E=Q(),E!==p?(M=h(),M!==p?q=r={type:"if",expression:C,group:M}:(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N);q===p&&(q=u,35===c.charCodeAt(u)?
(r=ea,u++):(r=p,0===U&&b(D)),r!==p?(y=K(),y!==p?(c.substr(u,5)===ka?(w=ka,u+=5):(w=p,0===U&&b(qa)),w!==p?(A=v(),A!==p?(C=m(),C!==p?(z=K(),z!==p?(B=G(),B!==p?(E=Q(),E!==p?(M=h(),M!==p?q=r={type:"ifdef",name:C,group:M}:(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N),q===p&&(q=u,35===c.charCodeAt(u)?(r=ea,u++):(r=p,0===U&&b(D)),r!==p?(y=K(),y!==p?(c.substr(u,6)===H?(w=H,u+=6):(w=p,0===U&&b(fa)),w!==p?(A=v(),A!==p?(C=m(),C!==p?(z=K(),z!==p?(B=G(),B!==
p?(E=Q(),E!==p?(M=h(),M!==p?q=r={type:"ifndef",name:C,group:M}:(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)):(u=q,q=N)));e=q;if(e!==p)if(f=Q(),f!==p){l=[];for(n=k();n!==p;)l.push(n),n=k();if(l!==p)if(n=Q(),n!==p){var J,L,S,O,P,X,Z,ga;J=u;35===c.charCodeAt(u)?(L=ea,u++):(L=p,0===U&&b(D));L!==p?(S=K(),S!==p?(c.substr(u,4)===oa?(O=oa,u+=4):(O=p,0===U&&b(ca)),O!==p?(P=K(),P!==p?(X=G(),X!==p?(Z=Q(),Z!==p?(ga=h(),ga!==p?J=L={type:"else",group:ga}:(u=J,J=N)):(u=
J,J=N)):(u=J,J=N)):(u=J,J=N)):(u=J,J=N)):(u=J,J=N)):(u=J,J=N);s=J;s===p&&(s=F);if(s!==p)if(t=Q(),t!==p){var Y,ha,$,ja,ba,la;Y=u;35===c.charCodeAt(u)?(ha=ea,u++):(ha=p,0===U&&b(D));ha!==p?($=K(),$!==p?(c.substr(u,5)===qb?(ja=qb,u+=5):(ja=p,0===U&&b(ma)),ja!==p?(ba=K(),ba!==p?(la=V(),la!==p?Y=ha=[ha,$,ja,ba,la]:(u=Y,Y=N)):(u=Y,Y=N)):(u=Y,Y=N)):(u=Y,Y=N)):(u=Y,Y=N);x=Y;if(x!==p){for(var ra=s,ua=[e],wa=0;wa<l.length;wa++)ua.push(l[wa]);null!==ra&&ua.push(ra);d=e={type:"condition",parts:ua}}else u=d,d=
N}else u=d,d=N;else u=d,d=N}else u=d,d=N;else u=d,d=N}else u=d,d=N;else u=d,d=N;a=d;if(a===p){var W,za,pa,Ea,va,Ca,Da,sa,xa,Ha,Ma,Pa,Na,Xa,gb;W=u;35===c.charCodeAt(u)?(za=ea,u++):(za=p,0===U&&b(D));if(za!==p)if(pa=K(),pa!==p)if(c.substr(u,7)===R?(Ea=R,u+=7):(Ea=p,0===U&&b(ta)),Ea!==p)if(va=K(),va!==p){var nb,Ra,eb,Za,hb,$a;nb=u;60===c.charCodeAt(u)?(Ra=sc,u++):(Ra=p,0===U&&b(cd));if(Ra!==p)if(eb=K(),eb!==p){var ab,Ja,Ka,Fa;ab=[];Ka=Ja=u;U++;Fa=V();Fa===p&&(62===c.charCodeAt(u)?(Fa=Ga,u++):(Fa=p,0===
U&&b(yb)));U--;Fa===p?Ka=Sa:(u=Ka,Ka=N);Ka!==p?(Fa=T(),Fa!==p?Ja=Ka=[Ka,Fa]:(u=Ja,Ja=N)):(u=Ja,Ja=N);for(;Ja!==p;)ab.push(Ja),Ka=Ja=u,U++,Fa=V(),Fa===p&&(62===c.charCodeAt(u)?(Fa=Ga,u++):(Fa=p,0===U&&b(yb))),U--,Fa===p?Ka=Sa:(u=Ka,Ka=N),Ka!==p?(Fa=T(),Fa!==p?Ja=Ka=[Ka,Fa]:(u=Ja,Ja=N)):(u=Ja,Ja=N);ab!==p&&(ab=da(ab));Za=ab;Za!==p?(hb=K(),hb!==p?(62===c.charCodeAt(u)?($a=Ga,u++):($a=p,0===U&&b(yb)),$a!==p?nb=Ra=Za:(u=nb,nb=N)):(u=nb,nb=N)):(u=nb,nb=N)}else u=nb,nb=N;else u=nb,nb=N;if(nb===p)if(nb=u,
34===c.charCodeAt(u)?(Ra=pb,u++):(Ra=p,0===U&&b(ya)),Ra!==p)if(eb=K(),eb!==p){var fb,La,Oa,Ia;fb=[];Oa=La=u;U++;Ia=V();Ia===p&&(34===c.charCodeAt(u)?(Ia=pb,u++):(Ia=p,0===U&&b(ya)));U--;Ia===p?Oa=Sa:(u=Oa,Oa=N);Oa!==p?(Ia=T(),Ia!==p?La=Oa=[Oa,Ia]:(u=La,La=N)):(u=La,La=N);for(;La!==p;)fb.push(La),Oa=La=u,U++,Ia=V(),Ia===p&&(34===c.charCodeAt(u)?(Ia=pb,u++):(Ia=p,0===U&&b(ya))),U--,Ia===p?Oa=Sa:(u=Oa,Oa=N),Oa!==p?(Ia=T(),Ia!==p?La=Oa=[Oa,Ia]:(u=La,La=N)):(u=La,La=N);fb!==p&&(fb=da(fb));Za=fb;Za!==p?
(hb=K(),hb!==p?(34===c.charCodeAt(u)?($a=pb,u++):($a=p,0===U&&b(ya)),$a!==p?nb=Ra=Za:(u=nb,nb=N)):(u=nb,nb=N)):(u=nb,nb=N)}else u=nb,nb=N;else u=nb,nb=N;Ca=nb;Ca!==p?(Da=K(),Da!==p?(sa=V(),sa!==p?W=za={type:"include",file:Ca}:(u=W,W=N)):(u=W,W=N)):(u=W,W=N)}else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;if(W===p&&(W=u,35===c.charCodeAt(u)?(za=ea,u++):(za=p,0===U&&b(D)),za!==p?(pa=K(),pa!==p?(c.substr(u,6)===aa?(Ea=aa,u+=6):(Ea=p,0===U&&b(Ya)),Ea===p&&(c.substr(u,6)===na?(Ea=na,u+=6):(Ea=p,0===
U&&b(bb))),Ea!==p?(va=u,Ca=v(),Ca!==p?(Da=g(),Da!==p?va=Ca=[Ca,Da]:(u=va,va=N)):(u=va,va=N),va===p&&(va=F),va!==p?(Ca=K(),Ca!==p?(Da=V(),Da!==p?W=za={type:Ea}:(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N),W===p)){W=u;35===c.charCodeAt(u)?(za=ea,u++):(za=p,0===U&&b(D));if(za!==p)if(pa=K(),pa!==p)if(c.substr(u,6)===Aa?(Ea=Aa,u+=6):(Ea=p,0===U&&b(Jb)),Ea===p&&(c.substr(u,3)===cb?(Ea=cb,u+=3):(Ea=p,0===U&&b(Qa))),Ea!==p)if(va=v(),va!==p)if(Ca=m(),Ca!==p)if(Da=u,sa=v(),sa!==p?(xa=g(),
xa!==p?Da=sa=[sa,xa]:(u=Da,Da=N)):(u=Da,Da=N),Da===p&&(Da=F),Da!==p)if(sa=K(),sa!==p)if(xa=V(),xa!==p){var Eb=Ea,Lb=Ca,Bb=Da,Hb=[];if(null!==Bb)for(var Fb=0;Fb<Bb[1].length;Fb++)Hb.push(Bb[1][Fb]);W=za={type:Eb,name:Lb,tokens:Hb}}else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;if(W===p){W=u;35===c.charCodeAt(u)?(za=ea,u++):(za=p,0===U&&b(D));if(za!==p)if(pa=K(),pa!==p)if(c.substr(u,6)===Aa?(Ea=Aa,u+=6):(Ea=p,0===U&&b(Jb)),Ea!==p)if(va=v(),va!==
p)if(Ca=m(),Ca!==p)if(40===c.charCodeAt(u)?(Da=Kb,u++):(Da=p,0===U&&b(Tb)),Da!==p)if(sa=K(),sa!==p){var mb,Ab,ub,Ib,kb,lb,sb,tb;mb=u;Ab=m();if(Ab!==p){ub=[];Ib=u;kb=K();kb!==p?(44===c.charCodeAt(u)?(lb=Wd,u++):(lb=p,0===U&&b(Xd)),lb!==p?(sb=K(),sb!==p?(tb=m(),tb!==p?Ib=kb=[kb,lb,sb,tb]:(u=Ib,Ib=N)):(u=Ib,Ib=N)):(u=Ib,Ib=N)):(u=Ib,Ib=N);for(;Ib!==p;)ub.push(Ib),Ib=u,kb=K(),kb!==p?(44===c.charCodeAt(u)?(lb=Wd,u++):(lb=p,0===U&&b(Xd)),lb!==p?(sb=K(),sb!==p?(tb=m(),tb!==p?Ib=kb=[kb,lb,sb,tb]:(u=Ib,Ib=
N)):(u=Ib,Ib=N)):(u=Ib,Ib=N)):(u=Ib,Ib=N);if(ub!==p){for(var Wb=[Ab],Mb=0;Mb<ub.length;Mb++)Wb.push(ub[Mb][3]);mb=Ab=Wb}else u=mb,mb=N}else u=mb,mb=N;xa=mb;xa===p&&(xa=F);xa!==p?(Ha=K(),Ha!==p?(41===c.charCodeAt(u)?(Ma=bd,u++):(Ma=p,0===U&&b(hc)),Ma!==p?(Pa=K(),Pa!==p?(Na=g(),Na===p&&(Na=F),Na!==p?(Xa=K(),Xa!==p?(gb=V(),gb!==p?W=za={type:"define",name:Ca,params:null!==xa?xa:[],tokens:null!==Na?Na:[]}:(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)}else u=W,W=N;else u=W,
W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;if(W===p){W=u;35===c.charCodeAt(u)?(za=ea,u++):(za=p,0===U&&b(D));if(za!==p)if(pa=K(),pa!==p)if(c.substr(u,5)===Va?(Ea=Va,u+=5):(Ea=p,0===U&&b(Ta)),Ea!==p)if(va=u,Ca=v(),Ca!==p?(Da=g(),Da!==p?va=Ca=[Ca,Da]:(u=va,va=N)):(u=va,va=N),va===p&&(va=F),va!==p)if(Ca=K(),Ca!==p)if(Da=V(),Da!==p){var Nb=va,$b=[];if(null!==Nb)for(var Ob=0;Ob<Nb[1].length;Ob++)$b.push(Nb[1][Ob]);W=za={type:"error",tokens:$b}}else u=W,W=N;else u=W,W=N;else u=
W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;if(W===p&&(W=u,35===c.charCodeAt(u)?(za=ea,u++):(za=p,0===U&&b(D)),za!==p?(pa=K(),pa!==p?(c.substr(u,4)===ob?(Ea=ob,u+=4):(Ea=p,0===U&&b(Ua)),Ea!==p?(va=v(),va!==p?(Ca=g(),Ca!==p?(Da=K(),Da!==p?(sa=V(),sa!==p?W=za={type:"line",tokens:Ca}:(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N),W===p&&(W=u,35===c.charCodeAt(u)?(za=ea,u++):(za=p,0===U&&b(D)),za!==p?(pa=K(),pa!==p?(c.substr(u,6)===Wa?(Ea=Wa,u+=6):(Ea=p,0===U&&b(ib)),Ea!==
p?(va=v(),va!==p?(Ca=m(),Ca!==p?(Da=v(),Da!==p?(sa=g(),sa!==p?(xa=K(),xa!==p?(Ha=V(),Ha!==p?W=za={type:"pragma",name:Ca,tokens:sa}:(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N),W===p&&(W=u,35===c.charCodeAt(u)?(za=ea,u++):(za=p,0===U&&b(D)),za!==p?(pa=K(),pa!==p?(c.substr(u,5)===Ba?(Ea=Ba,u+=5):(Ea=p,0===U&&b(db)),Ea!==p?(va=v(),va!==p?(Ca=m(),Ca!==p?(Da=K(),Da!==p?(sa=V(),sa!==p?W=za={type:"undef",name:Ca}:(u=W,W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,
W=N)):(u=W,W=N)):(u=W,W=N)):(u=W,W=N),W===p)))){W=u;35===c.charCodeAt(u)?(za=ea,u++):(za=p,0===U&&b(D));if(za!==p)if(pa=K(),pa!==p)if(c.substr(u,7)===Ub?(Ea=Ub,u+=7):(Ea=p,0===U&&b(Dc)),Ea!==p)if(va=u,Ca=v(),Ca!==p?(Da=g(),Da!==p?va=Ca=[Ca,Da]:(u=va,va=N)):(u=va,va=N),va===p&&(va=F),va!==p)if(Ca=K(),Ca!==p)if(Da=V(),Da!==p){var Pb=va,ac=[];if(null!==Pb)for(var Rb=0;Rb<Pb[1].length;Rb++)ac.push(Pb[1][Rb]);W=za={type:"warning",tokens:ac}}else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,
W=N;else u=W,W=N;if(W===p){W=u;35===c.charCodeAt(u)?(za=ea,u++):(za=p,0===U&&b(D));if(za!==p)if(pa=K(),pa!==p)if(c.substr(u,9)===Cb?(Ea=Cb,u+=9):(Ea=p,0===U&&b(ic)),Ea!==p)if(va=u,Ca=v(),Ca!==p?(Da=g(),Da!==p?va=Ca=[Ca,Da]:(u=va,va=N)):(u=va,va=N),va===p&&(va=F),va!==p)if(Ca=K(),Ca!==p)if(Da=V(),Da!==p){var Vb=va,bc=[];if(null!==Vb)for(var Yb=0;Yb<Vb[1].length;Yb++)bc.push(Vb[1][Yb]);W=za={type:"extension",tokens:bc}}else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;else u=W,W=N;W===
p&&(W=u,35===c.charCodeAt(u)?(za=ea,u++):(za=p,0===U&&b(D)),za!==p?(pa=K(),pa!==p?(Ea=V(),Ea!==p?W=za={type:"#"}:(u=W,W=N)):(u=W,W=N)):(u=W,W=N))}}}}}a=W;if(a===p){var gc,Zb,jc,lc;gc=u;var Sb,Xb,mc,ec,tc,kc,uc,wc,Bc,vc;Sb=u;35===c.charCodeAt(u)?(Xb=ea,u++):(Xb=p,0===U&&b(D));Xb!==p?(mc=K(),mc!==p?(c.substr(u,4)===vb?(ec=vb,u+=4):(ec=p,0===U&&b(pd)),ec!==p?(tc=v(),tc!==p?(kc=m(),kc!==p?(uc=K(),uc!==p?(wc=G(),wc!==p?(Bc=Q(),Bc!==p?(vc=h(),vc!==p?Sb=Xb={type:"node",name:kc,group:vc}:(u=Sb,Sb=N)):(u=
Sb,Sb=N)):(u=Sb,Sb=N)):(u=Sb,Sb=N)):(u=Sb,Sb=N)):(u=Sb,Sb=N)):(u=Sb,Sb=N)):(u=Sb,Sb=N)):(u=Sb,Sb=N);Zb=Sb;if(Zb!==p)if(jc=Q(),jc!==p){var jb,dc,xc,nc,yc,fc;jb=u;35===c.charCodeAt(u)?(dc=ea,u++):(dc=p,0===U&&b(D));dc!==p?(xc=K(),xc!==p?(c.substr(u,7)===wb?(nc=wb,u+=7):(nc=p,0===U&&b(td)),nc!==p?(yc=K(),yc!==p?(fc=V(),fc===p&&(fc=F),fc!==p?jb=dc=[dc,xc,nc,yc,fc]:(u=jb,jb=N)):(u=jb,jb=N)):(u=jb,jb=N)):(u=jb,jb=N)):(u=jb,jb=N);lc=jb;lc!==p?gc=Zb:(u=gc,gc=N)}else u=gc,gc=N;else u=gc,gc=N;if(gc===p){var Rc,
qc,Hc,Ec,zb,cc,oc;Rc=u;35===c.charCodeAt(u)?(qc=ea,u++):(qc=p,0===U&&b(D));if(qc!==p)if(Hc=K(),Hc!==p)if(c.substr(u,7)===qd?(Ec=qd,u+=7):(Ec=p,0===U&&b(rd)),Ec!==p)if(zb=u,cc=v(),cc!==p?(oc=g(),oc!==p?zb=cc=[cc,oc]:(u=zb,zb=N)):(u=zb,zb=N),zb===p&&(zb=F),zb!==p)if(cc=K(),cc!==p)if(oc=G(),oc!==p){var Fc=zb,Ic=[];if(null!==Fc)for(var Jc=0;Jc<Fc[1].length;Jc++)Ic.push(Fc[1][Jc]);Rc=qc={type:"node_in",name:Ic.pop(),qualifier:Ic}}else u=Rc,Rc=N;else u=Rc,Rc=N;else u=Rc,Rc=N;else u=Rc,Rc=N;else u=Rc,Rc=
N;else u=Rc,Rc=N;gc=Rc;if(gc===p){var Sc,Cc,Vc,Mc,Gb,pc,Ac;Sc=u;35===c.charCodeAt(u)?(Cc=ea,u++):(Cc=p,0===U&&b(D));if(Cc!==p)if(Vc=K(),Vc!==p)if(c.substr(u,8)===sd?(Mc=sd,u+=8):(Mc=p,0===U&&b(xb)),Mc!==p)if(Gb=u,pc=v(),pc!==p?(Ac=g(),Ac!==p?Gb=pc=[pc,Ac]:(u=Gb,Gb=N)):(u=Gb,Gb=N),Gb===p&&(Gb=F),Gb!==p)if(pc=K(),pc!==p)if(Ac=G(),Ac!==p){var Oc=Gb,Pc=[];if(null!==Oc)for(var Wc=0;Wc<Oc[1].length;Wc++)Pc.push(Oc[1][Wc]);Sc=Cc={type:"node_out",name:Pc.pop(),qualifier:Pc}}else u=Sc,Sc=N;else u=Sc,Sc=N;
else u=Sc,Sc=N;else u=Sc,Sc=N;else u=Sc,Sc=N;else u=Sc,Sc=N;gc=Sc;if(gc===p){var Tc,Lc,dd,Xc,Qb,zc,Gc;Tc=u;35===c.charCodeAt(u)?(Lc=ea,u++):(Lc=p,0===U&&b(D));if(Lc!==p)if(dd=K(),dd!==p)if(c.substr(u,10)===rb?(Xc=rb,u+=10):(Xc=p,0===U&&b(Db)),Xc!==p)if(Qb=u,zc=v(),zc!==p?(Gc=g(),Gc!==p?Qb=zc=[zc,Gc]:(u=Qb,Qb=N)):(u=Qb,Qb=N),Qb===p&&(Qb=F),Qb!==p)if(zc=K(),zc!==p)if(Gc=G(),Gc!==p){var Zc=Qb,$c=[];if(null!==Zc)for(var ad=0;ad<Zc[1].length;ad++)$c.push(Zc[1][ad]);Tc=Lc={type:"node_param",name:$c.pop(),
qualifier:$c}}else u=Tc,Tc=N;else u=Tc,Tc=N;else u=Tc,Tc=N;else u=Tc,Tc=N;else u=Tc,Tc=N;else u=Tc,Tc=N;gc=Tc;if(gc===p){var hd,Nc,fd,ed,kd,ld;hd=u;35===c.charCodeAt(u)?(Nc=ea,u++):(Nc=p,0===U&&b(D));Nc!==p?(fd=K(),fd!==p?(c.substr(u,12)===rc?(ed=rc,u+=12):(ed=p,0===U&&b(jd)),ed!==p?(kd=K(),kd!==p?(ld=V(),ld!==p?hd=Nc={type:"nodes_global"}:(u=hd,hd=N)):(u=hd,hd=N)):(u=hd,hd=N)):(u=hd,hd=N)):(u=hd,hd=N);gc=hd;if(gc===p){var id,Yc,md,gd,nd,od;id=u;35===c.charCodeAt(u)?(Yc=ea,u++):(Yc=p,0===U&&b(D));
Yc!==p?(md=K(),md!==p?(c.substr(u,10)===Kc?(gd=Kc,u+=10):(gd=p,0===U&&b(Uc)),gd!==p?(nd=K(),nd!==p?(od=V(),od!==p?id=Yc={type:"nodes_main"}:(u=id,id=N)):(u=id,id=N)):(u=id,id=N)):(u=id,id=N)):(u=id,id=N);gc=id}}}}}a=gc;if(a===p){var Qc;Qc=g();Qc!==p&&(Qc={type:"textline",tokens:Qc});a=Qc}}}return a}function k(){var a,d,e,f;a=u;35===c.charCodeAt(u)?(d=ea,u++):(d=p,0===U&&b(D));d!==p?(d=K(),d!==p?(c.substr(u,4)===w?(d=w,u+=4):(d=p,0===U&&b(ja)),d!==p?(d=v(),d!==p?(d=g(),d!==p?(e=K(),e!==p?(e=G(),e!==
p?(e=Q(),e!==p?(e=h(),e!==p?(f=Q(),f!==p?a=d={type:"elif",expression:d,group:e}:(u=a,a=N)):(u=a,a=N)):(u=a,a=N)):(u=a,a=N)):(u=a,a=N)):(u=a,a=N)):(u=a,a=N)):(u=a,a=N)):(u=a,a=N)):(u=a,a=N);return a}function g(){var a,b,c,d,e,f;a=u;b=q();if(b!==p){c=[];d=u;e=K();e!==p?(f=q(),f!==p?d=e=[e,f]:(u=d,d=N)):(u=d,d=N);for(;d!==p;)c.push(d),d=u,e=K(),e!==p?(f=q(),f!==p?d=e=[e,f]:(u=d,d=N)):(u=d,d=N);c!==p?a=b=ha(b,c):(u=a,a=N)}else u=a,a=N;return a}function q(){var a;a=m();if(a===p){var d,e,f;U++;a=u;var g;
d=u;48===c.charCodeAt(u)?(e=wa,u++):(e=p,0===U&&b(ba));if(e!==p)if(La.test(c.charAt(u))?(e=c.charAt(u),u++):(e=p,0===U&&b(ua)),e!==p){e=u;f=[];g=n();if(g!==p)for(;g!==p;)f.push(g),g=n();else f=N;f!==p&&(f=c.substring(e,u));e=f;e!==p?d=e=String(parseInt("0x"+e)):(u=d,d=N)}else u=d,d=N;else u=d,d=N;if(d===p){var h,k;e=d=u;f=C();f!==p?(46===c.charCodeAt(u)?(g=pa,u++):(g=p,0===U&&b(fb)),g!==p?(h=A(),h===p&&(h=F),h!==p?(k=E(),k===p&&(k=F),k!==p?e=f=[f,g,h,k]:(u=e,e=N)):(u=e,e=N)):(u=e,e=N)):(u=e,e=N);
e!==p&&(e=c.substring(d,u));d=e;d===p&&(e=d=u,46===c.charCodeAt(u)?(f=pa,u++):(f=p,0===U&&b(fb)),f!==p?(g=A(),g!==p?(h=E(),h===p&&(h=F),h!==p?e=f=[f,g,h]:(u=e,e=N)):(u=e,e=N)):(u=e,e=N),e!==p&&(e=c.substring(d,u)),d=e,d===p&&(e=d=u,f=C(),f!==p?(g=E(),g===p&&(g=F),g!==p?e=f=[f,g]:(u=e,e=N)):(u=e,e=N),e!==p&&(e=c.substring(d,u)),d=e))}d!==p?(e=u,U++,f=s(),U--,f===p?e=Sa:(u=e,e=N),e!==p?a=d:(u=a,a=N)):(u=a,a=N);U--;a===p&&0===U&&b(Ia);if(a===p){U++;a=u;34===c.charCodeAt(u)?(d=pb,u++):(d=p,0===U&&b(ya));
if(d!==p){e=[];f=t();if(f!==p)for(;f!==p;)e.push(f),f=t();else e=N;e!==p&&(e=e.join(""));e===p&&(e=F);e!==p?(34===c.charCodeAt(u)?(f=pb,u++):(f=p,0===U&&b(ya)),f!==p?a=d=[d,e,f]:(u=a,a=N)):(u=a,a=N)}else u=a,a=N;if(a===p)if(a=u,39===c.charCodeAt(u)?(d=dc,u++):(d=p,0===U&&b(Mc)),d!==p){e=[];f=M();if(f!==p)for(;f!==p;)e.push(f),f=M();else e=N;e!==p&&(e=e.join(""));e===p&&(e=F);e!==p?(39===c.charCodeAt(u)?(f=dc,u++):(f=p,0===U&&b(Mc)),f!==p?a=d=[d,e,f]:(u=a,a=N)):(u=a,a=N)}else u=a,a=N;a!==p&&(a='"'+
a[1]+'"');U--;a===p&&0===U&&b(Lc);a===p&&(U++,c.substr(u,2)===xc?(a=xc,u+=2):(a=p,0===U&&b(mc)),a===p&&(c.substr(u,2)===Xc?(a=Xc,u+=2):(a=p,0===U&&b(nc)),a===p&&(c.substr(u,2)===ec?(a=ec,u+=2):(a=p,0===U&&b(ed)),a===p&&(c.substr(u,2)===Ob?(a=Ob,u+=2):(a=p,0===U&&b(ab)),a===p&&(c.substr(u,2)===Pb?(a=Pb,u+=2):(a=p,0===U&&b(kb)),a===p&&(c.substr(u,2)===kd?(a=kd,u+=2):(a=p,0===U&&b(yc)),a===p&&(c.substr(u,2)===oc?(a=oc,u+=2):(a=p,0===U&&b(Ad)),a===p&&(c.substr(u,2)===ac?(a=ac,u+=2):(a=p,0===U&&b(ld)),
a===p&&(c.substr(u,2)===Qb?(a=Qb,u+=2):(a=p,0===U&&b(Yc)),a===p&&(c.substr(u,2)===zc?(a=zc,u+=2):(a=p,0===U&&b(gb)),a===p&&(c.substr(u,3)===Fc?(a=Fc,u+=3):(a=p,0===U&&b(pc)),a===p&&(c.substr(u,3)===Ac?(a=Ac,u+=3):(a=p,0===U&&b(Gc)),a===p&&(c.substr(u,2)===Zc?(a=Zc,u+=2):(a=p,0===U&&b(wd)),a===p&&(c.substr(u,2)===$c?(a=$c,u+=2):(a=p,0===U&&b(xd)),a===p&&(c.substr(u,2)===ad?(a=ad,u+=2):(a=p,0===U&&b(Nc)),a===p&&(c.substr(u,2)===Bc?(a=Bc,u+=2):(a=p,0===U&&b(fc)),a===p&&(c.substr(u,2)===Oc?(a=Oc,u+=2):
(a=p,0===U&&b(Bd)),a===p&&(c.substr(u,2)===fd?(a=fd,u+=2):(a=p,0===U&&b(md)),a===p&&(c.substr(u,2)===qc?(a=qc,u+=2):(a=p,0===U&&b(Pc)),a===p&&(c.substr(u,2)===yd?(a=yd,u+=2):(a=p,0===U&&b(Rb)),a===p&&(123===c.charCodeAt(u)?(a=Cd,u++):(a=p,0===U&&b(gd)),a===p&&(125===c.charCodeAt(u)?(a=Hc,u++):(a=p,0===U&&b(Ic)),a===p&&(91===c.charCodeAt(u)?(a=Id,u++):(a=p,0===U&&b(la)),a===p&&(93===c.charCodeAt(u)?(a=Ra,u++):(a=p,0===U&&b(Md)),a===p&&(40===c.charCodeAt(u)?(a=Kb,u++):(a=p,0===U&&b(Tb)),a===p&&(41===
c.charCodeAt(u)?(a=bd,u++):(a=p,0===U&&b(hc)),a===p&&(59===c.charCodeAt(u)?(a=nd,u++):(a=p,0===U&&b(Na)),a===p&&(58===c.charCodeAt(u)?(a=Ja,u++):(a=p,0===U&&b(Nd)),a===p&&(63===c.charCodeAt(u)?(a=Hb,u++):(a=p,0===U&&b(Dd)),a===p&&(46===c.charCodeAt(u)?(a=pa,u++):(a=p,0===U&&b(fb)),a===p&&(43===c.charCodeAt(u)?(a=od,u++):(a=p,0===U&&b(Ed)),a===p&&(45===c.charCodeAt(u)?(a=Qc,u++):(a=p,0===U&&b(Fd)),a===p&&(42===c.charCodeAt(u)?(a=ud,u++):(a=p,0===U&&b(Od)),a===p&&(47===c.charCodeAt(u)?(a=Jd,u++):(a=
p,0===U&&b(Jc)),a===p&&(37===c.charCodeAt(u)?(a=Gd,u++):(a=p,0===U&&b(Pd)),a===p&&(94===c.charCodeAt(u)?(a=Kd,u++):(a=p,0===U&&b(zd)),a===p&&(38===c.charCodeAt(u)?(a=Td,u++):(a=p,0===U&&b(be)),a===p&&(124===c.charCodeAt(u)?(a=ce,u++):(a=p,0===U&&b(de)),a===p&&(126===c.charCodeAt(u)?(a=ee,u++):(a=p,0===U&&b(fe)),a===p&&(33===c.charCodeAt(u)?(a=ge,u++):(a=p,0===U&&b(he)),a===p&&(61===c.charCodeAt(u)?(a=ie,u++):(a=p,0===U&&b(je)),a===p&&(60===c.charCodeAt(u)?(a=sc,u++):(a=p,0===U&&b(cd)),a===p&&(62===
c.charCodeAt(u)?(a=Ga,u++):(a=p,0===U&&b(yb)),a===p&&(44===c.charCodeAt(u)?(a=Wd,u++):(a=p,0===U&&b(Xd))))))))))))))))))))))))))))))))))))))))))))),U--,a===p&&0===U&&b($b))}}return a}function m(){var a,d;U++;d=a=u;U++;var e,f,g,h;e=u;c.substr(u,7)===eb?(f=eb,u+=7):(f=p,0===U&&b(tc));f===p&&(c.substr(u,5)===sa?(f=sa,u+=5):(f=p,0===U&&b(Xa)),f===p&&(c.substr(u,5)===Oa?(f=Oa,u+=5):(f=p,0===U&&b(Ec)),f===p&&(c.substr(u,6)===kc?(f=kc,u+=6):(f=p,0===U&&b(uc)),f===p&&(c.substr(u,6)===vc?(f=vc,u+=6):(f=p,
0===U&&b(lb)),f===p&&(c.substr(u,3)===sb?(f=sb,u+=3):(f=p,0===U&&b(Lb)),f===p&&(c.substr(u,6)===Vb?(f=Vb,u+=6):(f=p,0===U&&b(tb)),f===p&&(c.substr(u,7)===Wb?(f=Wb,u+=7):(f=p,0===U&&b(Mb)),f===p&&(c.substr(u,8)===Fa?(f=Fa,u+=8):(f=p,0===U&&b(zb)),f===p&&(c.substr(u,5)===Nb?(f=Nb,u+=5):(f=p,0===U&&b(bc)),f===p&&(c.substr(u,7)===Fb?(f=Fb,u+=7):(f=p,0===U&&b(mb)),f===p&&(c.substr(u,8)===hb?(f=hb,u+=8):(f=p,0===U&&b(J)),f===p&&(c.substr(u,3)===cb?(f=cb,u+=3):(f=p,0===U&&b(Qa)),f===p&&(c.substr(u,6)===
aa?(f=aa,u+=6):(f=p,0===U&&b(Ya)),f===p&&(c.substr(u,6)===na?(f=na,u+=6):(f=p,0===U&&b(bb))))))))))))))));f!==p?(g=u,U++,h=x(),U--,h===p?g=Sa:(u=g,g=N),g!==p?e=f=[f,g]:(u=e,e=N)):(u=e,e=N);U--;e===p?d=Sa:(u=d,d=N);if(d!==p){U++;d=u;e=s();if(e!==p){f=[];for(g=x();g!==p;)f.push(g),g=x();f!==p?d=e+=f.join(""):(u=d,d=N)}else u=d,d=N;U--;d===p&&0===U&&b(Za);d!==p?a=d:(u=a,a=N)}else u=a,a=N;U--;a===p&&0===U&&b(Za);return a}function s(){var a;Ha.test(c.charAt(u))?(a=c.charAt(u),u++):(a=p,0===U&&b(Ka));a===
p&&(36===c.charCodeAt(u)?(a=Eb,u++):(a=p,0===U&&b(ra)),a===p&&(95===c.charCodeAt(u)?(a=Pa,u++):(a=p,0===U&&b(jc))));return a}function x(){var a;a=s();a===p&&(a=f());return a}function C(){var a,d,e;48===c.charCodeAt(u)?(a=wa,u++):(a=p,0===U&&b(ba));a===p&&(a=u,Xb.test(c.charAt(u))?(d=c.charAt(u),u++):(d=p,0===U&&b(Ma)),d!==p?(e=A(),e===p&&(e=F),e!==p?a=d=[d,e]:(u=a,a=N)):(u=a,a=N));return a}function A(){var a,b;a=[];b=f();if(b!==p)for(;b!==p;)a.push(b),b=f();else a=N;return a}function f(){var a;lc.test(c.charAt(u))?
(a=c.charAt(u),u++):(a=p,0===U&&b(cc));return a}function E(){var a,d,e;a=u;xa.test(c.charAt(u))?(d=c.charAt(u),u++):(d=p,0===U&&b(Yb));if(d!==p){var f,g;e=u;jb.test(c.charAt(u))?(f=c.charAt(u),u++):(f=p,0===U&&b(Vc));f===p&&(f=F);f!==p?(g=A(),g!==p?e=f=[f,g]:(u=e,e=N)):(u=e,e=N);e!==p?a=d=[d,e]:(u=a,a=N)}else u=a,a=N;return a}function n(){var a;vd.test(c.charAt(u))?(a=c.charAt(u),u++):(a=p,0===U&&b(Wc));return a}function t(){var a,d,e;d=a=u;U++;34===c.charCodeAt(u)?(e=pb,u++):(e=p,0===U&&b(ya));e===
p&&(92===c.charCodeAt(u)?(e=$a,u++):(e=p,0===U&&b(wc)),e===p&&(e=L()));U--;e===p?d=Sa:(u=d,d=N);d!==p?(e=T(),e!==p?a=e:(u=a,a=N)):(u=a,a=N);a===p&&(a=u,92===c.charCodeAt(u)?(d=$a,u++):(d=p,0===U&&b(wc)),d!==p?(e=z(),e!==p?a=e:(u=a,a=N)):(u=a,a=N),a===p&&(a=S()));return a}function M(){var a,d,e;d=a=u;U++;39===c.charCodeAt(u)?(e=dc,u++):(e=p,0===U&&b(Mc));e===p&&(92===c.charCodeAt(u)?(e=$a,u++):(e=p,0===U&&b(wc)),e===p&&(e=L()));U--;e===p?d=Sa:(u=d,d=N);d!==p?(e=T(),e!==p?a=e:(u=a,a=N)):(u=a,a=N);a===
p&&(a=u,92===c.charCodeAt(u)?(d=$a,u++):(d=p,0===U&&b(wc)),d!==p?(e=z(),e!==p?a=e:(u=a,a=N)):(u=a,a=N),a===p&&(a=S()));return a}function S(){var a,d;a=u;92===c.charCodeAt(u)?(d=$a,u++):(d=p,0===U&&b(wc));d!==p?(d=V(),d!==p?a=d:(u=a,a=N)):(u=a,a=N);return a}function z(){var a,d,e;a=B();a===p&&(d=a=u,U++,e=B(),e===p&&(e=f(),e===p&&(120===c.charCodeAt(u)?(e=Ab,u++):(e=p,0===U&&b(Zb)),e===p&&(117===c.charCodeAt(u)?(e=Bb,u++):(e=p,0===U&&b(ub))))),U--,e===p?d=Sa:(u=d,d=N),d===p&&(d=L()),d!==p?(d=T(),d!==
p?a=d:(u=a,a=N)):(u=a,a=N));if(a===p&&(a=u,48===c.charCodeAt(u)?(d=wa,u++):(d=p,0===U&&b(ba)),d!==p?(d=u,U++,e=f(),U--,e===p?d=Sa:(u=d,d=N),d!==p?a="\x00":(u=a,a=N)):(u=a,a=N),a===p)){var g,h;a=u;120===c.charCodeAt(u)?(d=Ab,u++):(d=p,0===U&&b(Zb));d!==p?(e=d=u,g=n(),g!==p?(h=n(),h!==p?e=g=[g,h]:(u=e,e=N)):(u=e,e=N),e!==p&&(e=c.substring(d,u)),d=e,d!==p?a=d=String.fromCharCode(parseInt("0x"+d)):(u=a,a=N)):(u=a,a=N)}return a}function B(){var a;Gb.test(c.charAt(u))?(a=c.charAt(u),u++):(a=p,0===U&&b(dd));
a!==p&&(a=a.replace("b","\b").replace("f","\f").replace("n","\n").replace("r","\r").replace("t","\t").replace("v","\x0B"));return a}function K(){var a,b;a=[];b=O();b===p&&(b=S(),b===p&&(b=P(),b===p&&(b=Y())));for(;b!==p;)a.push(b),b=O(),b===p&&(b=S(),b===p&&(b=P(),b===p&&(b=Y())));return a}function v(){var a,b;a=[];b=O();b===p&&(b=S(),b===p&&(b=P(),b===p&&(b=Y())));if(b!==p)for(;b!==p;)a.push(b),b=O(),b===p&&(b=S(),b===p&&(b=P(),b===p&&(b=Y())));else a=N;return a}function Q(){var a,b;a=[];b=O();b===
p&&(b=S(),b===p&&(b=G(),b===p&&(b=$())));for(;b!==p;)a.push(b),b=O(),b===p&&(b=S(),b===p&&(b=G(),b===p&&(b=$())));return a}function O(){var a;U++;ke.test(c.charAt(u))?(a=c.charAt(u),u++):(a=p,0===U&&b(le));U--;a===p&&0===U&&b(me);return a}function L(){var a;ne.test(c.charAt(u))?(a=c.charAt(u),u++):(a=p,0===U&&b(oe));return a}function G(){var a;U++;10===c.charCodeAt(u)?(a=pe,u++):(a=p,0===U&&b(qe));a===p&&(c.substr(u,2)===Yd?(a=Yd,u+=2):(a=p,0===U&&b(re)),a===p&&(13===c.charCodeAt(u)?(a=se,u++):(a=
p,0===U&&b(te))));U--;a===p&&0===U&&b(ue);return a}function V(){var a;a=G();if(a===p){var d;a=u;U++;c.length>u?(d=c.charAt(u),u++):(d=p,0===U&&b(Zd));U--;d===p?a=Sa:(u=a,a=N)}return a}function $(){var a;U++;var d,e,f,g,h;a=u;c.substr(u,2)===Rd?(d=Rd,u+=2):(d=p,0===U&&b($d));if(d!==p){e=[];g=f=u;U++;c.substr(u,2)===Cc?(h=Cc,u+=2):(h=p,0===U&&b(Hd));U--;h===p?g=Sa:(u=g,g=N);g!==p?(h=T(),h!==p?f=g=[g,h]:(u=f,f=N)):(u=f,f=N);for(;f!==p;)e.push(f),g=f=u,U++,c.substr(u,2)===Cc?(h=Cc,u+=2):(h=p,0===U&&b(Hd)),
U--,h===p?g=Sa:(u=g,g=N),g!==p?(h=T(),h!==p?f=g=[g,h]:(u=f,f=N)):(u=f,f=N);e!==p?(c.substr(u,2)===Cc?(f=Cc,u+=2):(f=p,0===U&&b(Hd)),f!==p?a=d=[d,e,f]:(u=a,a=N)):(u=a,a=N)}else u=a,a=N;a===p&&(a=Y());U--;a===p&&0===U&&b(ve);return a}function P(){var a,d,e,f,g,h;a=u;c.substr(u,2)===Rd?(d=Rd,u+=2):(d=p,0===U&&b($d));if(d!==p){e=[];g=f=u;U++;c.substr(u,2)===Cc?(h=Cc,u+=2):(h=p,0===U&&b(Hd));h===p&&(h=L());U--;h===p?g=Sa:(u=g,g=N);g!==p?(h=T(),h!==p?f=g=[g,h]:(u=f,f=N)):(u=f,f=N);for(;f!==p;)e.push(f),
g=f=u,U++,c.substr(u,2)===Cc?(h=Cc,u+=2):(h=p,0===U&&b(Hd)),h===p&&(h=L()),U--,h===p?g=Sa:(u=g,g=N),g!==p?(h=T(),h!==p?f=g=[g,h]:(u=f,f=N)):(u=f,f=N);e!==p?(c.substr(u,2)===Cc?(f=Cc,u+=2):(f=p,0===U&&b(Hd)),f!==p?a=d=[d,e,f]:(u=a,a=N)):(u=a,a=N)}else u=a,a=N;return a}function Y(){var a,d,e,f,g,h;a=u;c.substr(u,2)===ae?(d=ae,u+=2):(d=p,0===U&&b(we));if(d!==p){e=[];g=f=u;U++;h=L();U--;h===p?g=Sa:(u=g,g=N);g!==p?(h=T(),h!==p?f=g=[g,h]:(u=f,f=N)):(u=f,f=N);for(;f!==p;)e.push(f),g=f=u,U++,h=L(),U--,h===
p?g=Sa:(u=g,g=N),g!==p?(h=T(),h!==p?f=g=[g,h]:(u=f,f=N)):(u=f,f=N);e!==p?a=d=[d,e]:(u=a,a=N)}else u=a,a=N;return a}function T(){var a;c.length>u?(a=c.charAt(u),u++):(a=p,0===U&&b(Zd));return a}var X=1<arguments.length?arguments[1]:{},p={},ga={start:l},Z=l,N=p,F=null,ha=function(a,b){for(var c=[a],d=0;d<b.length;d++)c.push(b[d][1]);return c},ea="#",D={type:"literal",value:"#",description:'"#"'},I="if",ia={type:"literal",value:"if",description:'"if"'},ka="ifdef",qa={type:"literal",value:"ifdef",description:'"ifdef"'},
H="ifndef",fa={type:"literal",value:"ifndef",description:'"ifndef"'},w="elif",ja={type:"literal",value:"elif",description:'"elif"'},oa="else",ca={type:"literal",value:"else",description:'"else"'},qb="endif",ma={type:"literal",value:"endif",description:'"endif"'},R="include",ta={type:"literal",value:"include",description:'"include"'},aa="import",Ya={type:"literal",value:"import",description:'"import"'},na="export",bb={type:"literal",value:"export",description:'"export"'},Aa="define",Jb={type:"literal",
value:"define",description:'"define"'},cb="var",Qa={type:"literal",value:"var",description:'"var"'},Kb="(",Tb={type:"literal",value:"(",description:'"("'},bd=")",hc={type:"literal",value:")",description:'")"'},Va="error",Ta={type:"literal",value:"error",description:'"error"'},ob="line",Ua={type:"literal",value:"line",description:'"line"'},Wa="pragma",ib={type:"literal",value:"pragma",description:'"pragma"'},Ba="undef",db={type:"literal",value:"undef",description:'"undef"'},Ub="warning",Dc={type:"literal",
value:"warning",description:'"warning"'},Cb="extension",ic={type:"literal",value:"extension",description:'"extension"'},vb="node",pd={type:"literal",value:"node",description:'"node"'},wb="endnode",td={type:"literal",value:"endnode",description:'"endnode"'},qd="node_in",rd={type:"literal",value:"node_in",description:'"node_in"'},sd="node_out",xb={type:"literal",value:"node_out",description:'"node_out"'},rb="node_param",Db={type:"literal",value:"node_param",description:'"node_param"'},rc="nodes_global",
jd={type:"literal",value:"nodes_global",description:'"nodes_global"'},Kc="nodes_main",Uc={type:"literal",value:"nodes_main",description:'"nodes_main"'},sc="<",cd={type:"literal",value:"<",description:'"<"'},Ga=">",yb={type:"literal",value:">",description:'">"'},pb='"',ya={type:"literal",value:'"',description:'"\\""'},Sa=void 0,da=function(a){for(var b="",c=0;c<a.length;c++)b+=a[c][1];return b},Za={type:"other",description:"identifier"},Eb="$",ra={type:"literal",value:"$",description:'"$"'},Pa="_",
jc={type:"literal",value:"_",description:'"_"'},Ha=/^[a-zA-Z]/,Ka={type:"class",value:"[a-zA-Z]",description:"[a-zA-Z]"},eb="#define",tc={type:"literal",value:"#define",description:'"#define"'},sa="#elif",Xa={type:"literal",value:"#elif",description:'"#elif"'},Oa="#else",Ec={type:"literal",value:"#else",description:'"#else"'},kc="#endif",uc={type:"literal",value:"#endif",description:'"#endif"'},vc="#error",lb={type:"literal",value:"#error",description:'"#error"'},sb="#if",Lb={type:"literal",value:"#if",
description:'"#if"'},Vb="#ifdef",tb={type:"literal",value:"#ifdef",description:'"#ifdef"'},Wb="#ifndef",Mb={type:"literal",value:"#ifndef",description:'"#ifndef"'},Fa="#include",zb={type:"literal",value:"#include",description:'"#include"'},Nb="#line",bc={type:"literal",value:"#line",description:'"#line"'},Fb="#pragma",mb={type:"literal",value:"#pragma",description:'"#pragma"'},hb="#warning",J={type:"literal",value:"#warning",description:'"#warning"'},Ia={type:"other",description:"number"},pa=".",
fb={type:"literal",value:".",description:'"."'},wa="0",ba={type:"literal",value:"0",description:'"0"'},La=/^[xX]/,ua={type:"class",value:"[xX]",description:"[xX]"},lc=/^[0-9]/,cc={type:"class",value:"[0-9]",description:"[0-9]"},Xb=/^[1-9]/,Ma={type:"class",value:"[1-9]",description:"[1-9]"},xa=/^[eE]/,Yb={type:"class",value:"[eE]",description:"[eE]"},jb=/^[\-+]/,Vc={type:"class",value:"[\\-+]",description:"[\\-+]"},vd=/^[0-9a-fA-F]/,Wc={type:"class",value:"[0-9a-fA-F]",description:"[0-9a-fA-F]"},
Lc={type:"other",description:"string"},dc="'",Mc={type:"literal",value:"'",description:'"\'"'},$a="\\",wc={type:"literal",value:"\\",description:'"\\\\"'},Gb=/^['"\\bfnrtv]/,dd={type:"class",value:"['\"\\\\bfnrtv]",description:"['\"\\\\bfnrtv]"},Ab="x",Zb={type:"literal",value:"x",description:'"x"'},Bb="u",ub={type:"literal",value:"u",description:'"u"'},$b={type:"other",description:"punctuation"},xc="+=",mc={type:"literal",value:"+=",description:'"+="'},Xc="-=",nc={type:"literal",value:"-=",description:'"-="'},
ec="*=",ed={type:"literal",value:"*=",description:'"*="'},Ob="/=",ab={type:"literal",value:"/=",description:'"/="'},Pb="%=",kb={type:"literal",value:"%=",description:'"%="'},kd="^=",yc={type:"literal",value:"^=",description:'"^="'},oc="&=",Ad={type:"literal",value:"&=",description:'"&="'},ac="|=",ld={type:"literal",value:"|=",description:'"|="'},Qb="<<",Yc={type:"literal",value:"<<",description:'"<<"'},zc=">>",gb={type:"literal",value:">>",description:'">>"'},Fc="<<=",pc={type:"literal",value:"<<=",
description:'"<<="'},Ac=">>=",Gc={type:"literal",value:">>=",description:'">>="'},Zc="==",wd={type:"literal",value:"==",description:'"=="'},$c="!=",xd={type:"literal",value:"!=",description:'"!="'},ad="<=",Nc={type:"literal",value:"<=",description:'"<="'},Bc=">=",fc={type:"literal",value:">=",description:'">="'},Oc="&&",Bd={type:"literal",value:"&&",description:'"&&"'},fd="||",md={type:"literal",value:"||",description:'"||"'},qc="++",Pc={type:"literal",value:"++",description:'"++"'},yd="--",Rb={type:"literal",
value:"--",description:'"--"'},Cd="{",gd={type:"literal",value:"{",description:'"{"'},Hc="}",Ic={type:"literal",value:"}",description:'"}"'},Id="[",la={type:"literal",value:"[",description:'"["'},Ra="]",Md={type:"literal",value:"]",description:'"]"'},nd=";",Na={type:"literal",value:";",description:'";"'},Ja=":",Nd={type:"literal",value:":",description:'":"'},Hb="?",Dd={type:"literal",value:"?",description:'"?"'},od="+",Ed={type:"literal",value:"+",description:'"+"'},Qc="-",Fd={type:"literal",value:"-",
description:'"-"'},ud="*",Od={type:"literal",value:"*",description:'"*"'},Jd="/",Jc={type:"literal",value:"/",description:'"/"'},Gd="%",Pd={type:"literal",value:"%",description:'"%"'},Kd="^",zd={type:"literal",value:"^",description:'"^"'},Td="&",be={type:"literal",value:"&",description:'"&"'},ce="|",de={type:"literal",value:"|",description:'"|"'},ee="~",fe={type:"literal",value:"~",description:'"~"'},ge="!",he={type:"literal",value:"!",description:'"!"'},ie="=",je={type:"literal",value:"=",description:'"="'},
Wd=",",Xd={type:"literal",value:",",description:'","'},me={type:"other",description:"whitespace"},ke=/^[\t\x0B\f ]/,le={type:"class",value:"[\\t\\x0B\\f ]",description:"[\\t\\x0B\\f ]"},ne=/^[\n\r]/,oe={type:"class",value:"[\\n\\r]",description:"[\\n\\r]"},ue={type:"other",description:"end of line"},pe="\n",qe={type:"literal",value:"\n",description:'"\\n"'},Yd="\r\n",re={type:"literal",value:"\r\n",description:'"\\r\\n"'},se="\r",te={type:"literal",value:"\r",description:'"\\r"'},ve={type:"other",
description:"comment"},Rd="/*",$d={type:"literal",value:"/*",description:'"/*"'},Cc="*/",Hd={type:"literal",value:"*/",description:'"*/"'},ae="//",we={type:"literal",value:"//",description:'"//"'},Zd={type:"any",description:"any character"},u=0,Ld=0,Ud={line:1,column:1,seenCR:!1},Qd=0,Vd=[],U=0,Sd;if("startRule"in X){if(!(X.startRule in ga))throw Error("Can't start parsing from rule \""+X.startRule+'".');Z=ga[X.startRule]}Sd=Z();if(Sd!==p&&u===c.length)return Sd;Sd!==p&&u<c.length&&b({type:"end",
description:"end of input"});throw function(b,e,f){function g(a){var b=1;for(a.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0});b<a.length;)a[b-1]===a[b]?a.splice(b,1):b++}function h(a,b){function c(a){function b(a){return a.charCodeAt(0).toString(16).toUpperCase()}return a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,
function(a){return"\\x0"+b(a)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(a){return"\\x"+b(a)}).replace(/[\u0180-\u0FFF]/g,function(a){return"\\u0"+b(a)}).replace(/[\u1080-\uFFFF]/g,function(a){return"\\u"+b(a)})}var d=Array(a.length),e;for(e=0;e<a.length;e++)d[e]=a[e].description;d=1<a.length?d.slice(0,-1).join(", ")+" or "+d[a.length-1]:d[0];e=b?'"'+c(b)+'"':"end of input";return"Expected "+d+" but "+e+" found."}var k=d(f),m=f<c.length?c.charAt(f):null;null!==e&&g(e);return new a(null!==b?b:h(e,
m),e,m,f,k.line,k.column)}(null,Vd,Qd);}}}()};b4w.module.__md5=function(a,q){function r(a,h){var g=a[0],q=a[1],m=a[2],s=a[3],g=d(g,q,m,s,h[0],7,-680876936),s=d(s,g,q,m,h[1],12,-389564586),m=d(m,s,g,q,h[2],17,606105819),q=d(q,m,s,g,h[3],22,-1044525330),g=d(g,q,m,s,h[4],7,-176418897),s=d(s,g,q,m,h[5],12,1200080426),m=d(m,s,g,q,h[6],17,-1473231341),q=d(q,m,s,g,h[7],22,-45705983),g=d(g,q,m,s,h[8],7,1770035416),s=d(s,g,q,m,h[9],12,-1958414417),m=d(m,s,g,q,h[10],17,-42063),q=d(q,m,s,g,h[11],22,-1990404162),g=d(g,q,m,s,h[12],7,1804603682),s=d(s,g,q,
m,h[13],12,-40341101),m=d(m,s,g,q,h[14],17,-1502002290),q=d(q,m,s,g,h[15],22,1236535329),g=b(g,q,m,s,h[1],5,-165796510),s=b(s,g,q,m,h[6],9,-1069501632),m=b(m,s,g,q,h[11],14,643717713),q=b(q,m,s,g,h[0],20,-373897302),g=b(g,q,m,s,h[5],5,-701558691),s=b(s,g,q,m,h[10],9,38016083),m=b(m,s,g,q,h[15],14,-660478335),q=b(q,m,s,g,h[4],20,-405537848),g=b(g,q,m,s,h[9],5,568446438),s=b(s,g,q,m,h[14],9,-1019803690),m=b(m,s,g,q,h[3],14,-187363961),q=b(q,m,s,g,h[8],20,1163531501),g=b(g,q,m,s,h[13],5,-1444681467),
s=b(s,g,q,m,h[2],9,-51403784),m=b(m,s,g,q,h[7],14,1735328473),q=b(q,m,s,g,h[12],20,-1926607734),g=c(q^m^s,g,q,h[5],4,-378558),s=c(g^q^m,s,g,h[8],11,-2022574463),m=c(s^g^q,m,s,h[11],16,1839030562),q=c(m^s^g,q,m,h[14],23,-35309556),g=c(q^m^s,g,q,h[1],4,-1530992060),s=c(g^q^m,s,g,h[4],11,1272893353),m=c(s^g^q,m,s,h[7],16,-155497632),q=c(m^s^g,q,m,h[10],23,-1094730640),g=c(q^m^s,g,q,h[13],4,681279174),s=c(g^q^m,s,g,h[0],11,-358537222),m=c(s^g^q,m,s,h[3],16,-722521979),q=c(m^s^g,q,m,h[6],23,76029189),
g=c(q^m^s,g,q,h[9],4,-640364487),s=c(g^q^m,s,g,h[12],11,-421815835),m=c(s^g^q,m,s,h[15],16,530742520),q=c(m^s^g,q,m,h[2],23,-995338651),g=l(g,q,m,s,h[0],6,-198630844),s=l(s,g,q,m,h[7],10,1126891415),m=l(m,s,g,q,h[14],15,-1416354905),q=l(q,m,s,g,h[5],21,-57434055),g=l(g,q,m,s,h[12],6,1700485571),s=l(s,g,q,m,h[3],10,-1894986606),m=l(m,s,g,q,h[10],15,-1051523),q=l(q,m,s,g,h[1],21,-2054922799),g=l(g,q,m,s,h[8],6,1873313359),s=l(s,g,q,m,h[15],10,-30611744),m=l(m,s,g,q,h[6],15,-1560198380),q=l(q,m,s,g,
h[13],21,1309151649),g=l(g,q,m,s,h[4],6,-145523070),s=l(s,g,q,m,h[11],10,-1120210379),m=l(m,s,g,q,h[2],15,718787259),q=l(q,m,s,g,h[9],21,-343485551);a[0]=g+a[0]&4294967295;a[1]=q+a[1]&4294967295;a[2]=m+a[2]&4294967295;a[3]=s+a[3]&4294967295}function c(a,b,c,d,h,l){b=(b+a&4294967295)+(d+l&4294967295)&4294967295;return(b<<h|b>>>32-h)+c&4294967295}function d(a,b,d,h,m,l,q){return c(b&d|~b&h,a,b,m,l,q)}function b(a,b,d,h,m,l,q){return c(b&h|d&~h,a,b,m,l,q)}function l(a,b,d,h,m,l,q){return c(d^(b|~h),
a,b,m,l,q)}var h="0123456789abcdef".split("");a.hexdigest=function(a){var b=a,c=b.length;a=[1732584193,-271733879,-1732584194,271733878];var d;for(d=64;d<=b.length;d+=64){for(var m=b.substring(d-64,d),l=[],q=void 0,q=0;64>q;q+=4)l[q>>2]=m.charCodeAt(q)+(m.charCodeAt(q+1)<<8)+(m.charCodeAt(q+2)<<16)+(m.charCodeAt(q+3)<<24);r(a,l)}b=b.substring(d-64);m=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(d=0;d<b.length;d++)m[d>>2]|=b.charCodeAt(d)<<(d%4<<3);m[d>>2]|=128<<(d%4<<3);if(55<d)for(r(a,m),d=0;16>d;d++)m[d]=
0;m[14]=8*c;r(a,m);for(b=0;b<a.length;b++){c=a;d=b;m=a[b];l="";for(q=0;4>q;q++)l+=h[m>>8*q+4&15]+h[m>>8*q&15];c[d]=l}return a.join("")}};b4w.module.animation=function(a,q){var r=q("__animation"),c=q("__constraints");q("__physics");var d=q("__print"),b=q("__util");a.SLOT_0=r.SLOT_0;a.SLOT_1=r.SLOT_1;a.SLOT_2=r.SLOT_2;a.SLOT_3=r.SLOT_3;a.SLOT_4=r.SLOT_4;a.SLOT_5=r.SLOT_5;a.SLOT_6=r.SLOT_6;a.SLOT_7=r.SLOT_7;a.SLOT_ALL=r.SLOT_ALL;a.OBJ_ANIM_TYPE_ARMATURE=r.OBJ_ANIM_TYPE_ARMATURE;a.OBJ_ANIM_TYPE_OBJECT=r.OBJ_ANIM_TYPE_OBJECT;a.OBJ_ANIM_TYPE_VERTEX=r.OBJ_ANIM_TYPE_VERTEX;a.OBJ_ANIM_TYPE_SOUND=r.OBJ_ANIM_TYPE_SOUND;a.OBJ_ANIM_TYPE_PARTICLES=
r.OBJ_ANIM_TYPE_PARTICLES;a.OBJ_ANIM_TYPE_MATERIAL=r.OBJ_ANIM_TYPE_MATERIAL;a.OBJ_ANIM_TYPE_STATIC=r.OBJ_ANIM_TYPE_STATIC;a.AB_CYCLIC=r.AB_CYCLIC;a.AB_FINISH_RESET=r.AB_FINISH_RESET;a.AB_FINISH_STOP=r.AB_FINISH_STOP;var l=new Float32Array(4);a.is_animated=function(a){return r.is_animated(a)};a.get_actions=function(){for(var a=[],b=r.get_all_actions(),c=0;c<b.length;c++)a.push(r.strip_baked_suffix(b[c].name));return a};a.get_current_action=function(b,c){return a.get_current_anim_name(b,c)};a.get_anim_names=
function(a){return r.is_animatable(a)?r.get_anim_names(a):[]};a.get_current_anim_name=function(a,b){if(!r.is_animated(a))return null;b=b||r.SLOT_0;return r.get_current_animation_name(a,b)};a.apply=function(a,b,c){if(c>r.SLOT_7)d.error("Can't apply animation to slot "+c+' for object "'+a.name+'". Object can have maximum of 8 animation slots');else{c=c||r.SLOT_0;if(r.is_animated(a)){var g=r.get_slot_num_by_anim(a,b);if(-1!=g&&g!=c){d.error('Animation "'+b+'" is already applied to object "'+a.name+'" (slot "'+
g+'").');return}}r.apply(a,b,c)}};a.remove=function(a){r.remove(a)};a.remove_slot_animation=function(a,b){r.is_animated(a)&&(b=b||r.SLOT_0,r.remove_slot_animation(a,b))};a.apply_def=function(a){r.apply_def(a)};a.play=function(a,b,c){r.is_animated(a)?(c=c||r.SLOT_0,r.play(a,b,c),r.update_object_animation(a,0,c)):d.error('Object "'+a.name+'" has no applied animation')};a.stop=function(a,b){r.is_animated(a)&&(b=b||r.SLOT_0,r.stop(a,b))};a.is_play=function(a,b){if(!r.is_animated(a))return!1;b=b||r.SLOT_0;
return r.is_play(a,b)};a.set_current_frame_float=function(b,c,d){a.set_frame(b,c,d)};a.get_current_frame_float=function(b,c){return a.get_frame(b,c)};a.set_frame=function(a,b,c){r.is_animated(a)&&(c=c||r.SLOT_0,r.set_current_frame_float(a,b,c),r.update_object_animation(a,0,c))};a.get_frame=function(a,b){if(!r.is_animated(a))return 0;b=b||r.SLOT_0;return r.get_current_frame_float(a,b)};a.set_speed=function(a,b,c){r.is_animated(a)&&(c=c||r.SLOT_0,r.set_speed(a,b||1,c))};a.get_speed=function(a,b){if(!r.is_animated(a))return 0;
b=b||r.SLOT_0;return r.get_speed(a,b)};a.get_frame_range=function(a,b){if(r.is_animated(a)){b=b||r.SLOT_0;var c=a._anim_slots[b];if(c)return[c.start,c.start+c.length]}return null};a.get_anim_start_frame=function(a,b){return r.is_animated(a)?(b=b||r.SLOT_0,r.get_anim_start_frame(a,b)):-1};a.get_anim_length=function(a,b){return r.is_animated(a)?(b=b||r.SLOT_0,r.get_anim_length(a,b)):-1};a.cyclic=function(b,c,d){a.set_behavior(b,c?r.AB_CYCLIC:r.AB_FINISH_RESET,d)};a.is_cyclic=function(a,b){if(!r.is_animated(a))return!1;
b=b||r.SLOT_0;return r.is_cyclic(a,b)};a.set_behavior=function(a,b,c){r.is_animated(a)&&(c=c||r.SLOT_0,r.set_behavior(a,b,c))};a.get_behavior=function(a,b){if(!r.is_animated(a))return null;b=b||r.SLOT_0;return r.get_behavior(a,b)};a.apply_smoothing=function(a,b,c,d){d=d||r.SLOT_0;r.is_animated(a)&&r.apply_smoothing(a,b,c,d)};a.update_object_animation=function(a,b,c){r.is_animated(a)&&(c=c||r.SLOT_0,r.update_object_animation(a,b||0,c))};a.frame_to_sec=function(a){return r.frame_to_sec(a)};a.get_bone_translation=
function(a,d,k){if(!b.is_armature(a))return null;k||(k=new Float32Array(3));c.get_bone_pose(a,d,!1,l,null);k[0]=l[0];k[1]=l[1];k[2]=l[2];return k};a.get_first_armature_object=function(a){return b.is_mesh(a)?r.get_first_armature_object(a):null};a.get_slot_num_by_anim=function(a,b){return r.is_animated(a)&&b?r.get_slot_num_by_anim(a,b):null};a.get_anim_name=function(a,b){if(!r.is_animated(a))return null;b=b||r.SLOT_0;return r.get_anim_by_slot_num(a,b)};a.get_anim_type=function(a,b){return r.is_animated(a)?
r.get_anim_type(a,b):null};a.apply_to_first_empty_slot=function(a,b){return r.apply_to_first_empty_slot(a,b)};a.get_skel_mix_factor=function(a){return a._render.anim_mix_factor};a.set_skel_mix_factor=function(a,c,k){b.is_armature(a)?(c=Math.min(Math.max(c,0),1),a._render.anim_mix_factor!=c&&r.set_skel_mix_factor(a,c,k||0)):d.error("Can't blend animation. Object \""+a.name+'" is not armature')}};b4w.module.assets=function(a,q){var r=q("__assets");a.AT_ARRAYBUFFER=r.AT_ARRAYBUFFER;a.AT_JSON=r.AT_JSON;a.AT_TEXT=r.AT_TEXT;a.AT_AUDIOBUFFER=r.AT_AUDIOBUFFER;a.AT_IMAGE_ELEMENT=r.AT_IMAGE_ELEMENT;a.AT_AUDIO_ELEMENT=r.AT_AUDIO_ELEMENT;a.enqueue=function(a,d,b){r.enqueue(a,d,b)}};b4w.module.material=function(a,q){function r(a,b){for(var c=a._batches,d=0;d<c.length;d++){var e=c[d];if(-1<e.material_names.indexOf(b))return"MAIN"==e.type}return!1}function c(a,c){var d=b.find_batch_material(a,c,"MAIN");return Boolean(d&&d.specular_params[0])}function d(a,c){var d=b.find_batch_material(a,c,"MAIN");return Boolean(d&&d.specular_params[1])}var b=q("__batch"),l=q("__config"),h=q("__print"),e=q("__objects"),k=q("__shaders");q("__util");q("vec4");var g=l.defaults,y="u_colormap0 u_colormap1 u_stencil0 u_specmap u_normalmap0 u_mirrormap".split(" ");
a.max_bones=function(){h.error("max_bones() deprecated, return default value");return g.max_bones};a.set_max_bones=function(a){h.error("set_max_bones() deprecated")};a.set_batch_param=function(){h.error("set_batch_param() deprecated")};a.inherit_material=function(a,c,d,g){if(e.is_dynamic_mesh(d)&&e.is_dynamic_mesh(a)){for(var k=["MAIN","DEPTH","COLOR_ID"],f=!1,l=0;l<k.length;l++){var n=k[l],q=b.find_batch_material(a,c,n),r=b.find_batch_material(d,g,n);if(q&&r)for(f=!0,"MAIN"==n&&(r.diffuse_color.set(q.diffuse_color),
r.diffuse_intensity=q.diffuse_intensity,r.specular_color.set(q.specular_color),r.specular_params.set(q.specular_params),r.emit=q.emit,r.ambient=q.ambient,r.ambient=q.ambient,r.diffuse_color_factor=q.diffuse_color_factor,r.alpha_factor=q.alpha_factor),n=0;n<r.texture_names.length;n++){var S=r.texture_names[n];if(-1!==y.indexOf(S)){var z=q.texture_names.indexOf(S);if(-1!==z&&(r.textures[n]=q.textures[z],r.childs))for(n=0;n<r.childs.length;n++){var B=r.childs[n],K=B.texture_names.indexOf(S);-1!==K&&
(B.textures[K]=q.textures[z])}}}}f||h.error("Wrong objects for inheriting material!")}else h.error("Wrong or batched object(s)")};a.get_materials_names=function(a){var b=[];a=a.data.materials;for(var c=0;c<a.length;c++)b.push(a[c].name);return b};a.set_diffuse_color=function(a,c,d){(a=b.find_batch_material(a,c,"MAIN"))?a.diffuse_color.set(d):h.error('Couldn\'t set property "diffuse_color"!')};a.get_diffuse_color=function(a,c){var d=b.find_batch_material(a,c,"MAIN");if(d){var e=Array(4);e[0]=d.diffuse_color[0];
e[1]=d.diffuse_color[1];e[2]=d.diffuse_color[2];e[3]=d.diffuse_color[3];return e}h.error('Couldn\'t get property "diffuse_color"!')};a.set_diffuse_intensity=function(a,c,d){(a=b.find_batch_material(a,c,"MAIN"))?a.diffuse_intensity=d:h.error('Couldn\'t set property "diffuse_color"!')};a.get_diffuse_intensity=function(a,c){var d=b.find_batch_material(a,c,"MAIN");if(d)return d.diffuse_intensity;h.error('Couldn\'t get property "diffuse_intensity"!')};a.set_specular_color=function(a,c,d){(a=b.find_batch_material(a,
c,"MAIN"))?a.specular_color.set(d):h.error('Couldn\'t set property "specular_color"!')};a.get_specular_color=function(a,c){var d=b.find_batch_material(a,c,"MAIN");if(d){var e=Array(3);e[0]=d.specular_color[0];e[1]=d.specular_color[1];e[2]=d.specular_color[2];return e}h.error('Couldn\'t get property "specular_color"!')};a.set_specular_intensity=function(a,d,e){c(a,d)||h.error('Property "specular_intensity" is missing!');b.find_batch_material(a,d,"MAIN").specular_params[0]=e};a.get_specular_intensity=
function(a,d){c(a,d)||h.error('Property "specular_intensity" is missing!');return b.find_batch_material(a,d,"MAIN").specular_params[0]};a.check_specular_intensity=c;a.set_specular_hardness=function(a,c,e){d(a,c)||h.error('Property "specular_hardness" is missing!');b.find_batch_material(a,c,"MAIN").specular_params[1]=e};a.get_specular_hardness=function(a,c){d(a,c)||h.error('Property "specular_hardness" is missing!');return b.find_batch_material(a,c,"MAIN").specular_params[1]};a.check_specular_hardness=
d;a.set_emit_factor=function(a,c,d){(a=b.find_batch_material(a,c,"MAIN"))?a.emit=d:h.error('Couldn\'t set property "emit_factor"!')};a.get_emit_factor=function(a,c){var d=b.find_batch_material(a,c,"MAIN");if(d)return d.emit;h.error('Couldn\'t get property "emit_factor"!')};a.set_ambient_factor=function(a,c,d){(a=b.find_batch_material(a,c,"MAIN"))?a.ambient=d:h.error('Couldn\'t set property "ambient_factor"!')};a.get_ambient_factor=function(a,c){var d=b.find_batch_material(a,c,"MAIN");if(d)return d.ambient;
h.error('Couldn\'t get property "ambient_factor"!')};a.set_diffuse_color_factor=function(a,c,d){(a=b.find_batch_material(a,c,"MAIN"))?a.diffuse_color_factor=d:h.error('Couldn\'t set property "diffuse_color_factor"!')};a.get_diffuse_color_factor=function(a,c){var d=b.find_batch_material(a,c,"MAIN");if(d)return d.diffuse_color_factor;h.error('Couldn\'t get property "diffuse_color_factor"!')};a.set_alpha_factor=function(a,c,d){(a=b.find_batch_material(a,c,"MAIN"))?a.alpha_factor=alpha_factor:h.error('Couldn\'t set property "alpha_factor"!')};
a.get_alpha_factor=function(a,c){var d=b.find_batch_material(a,c,"MAIN");if(d)return d.alpha_factor;h.error('Couldn\'t get property "alpha_factor"!')};a.get_material_extended_params=function(a,c){if(!a||!c)return h.error("B4W Error: missing arguments in get_material_params"),null;if(!r(a,c))return null;var d=b.find_batch_material(a,c,"MAIN");if(!d)return null;var e={};"MAIN"==d.type&&(e.reflect_factor=d.reflect_factor,e.fresnel=d.fresnel_params[2],e.fresnel_factor=5*(1-d.fresnel_params[3]),e.parallax_scale=
d.parallax_scale,e.parallax_steps=b.get_batch_directive(d,"PARALLAX_STEPS")[1]);return e};a.get_water_material_params=function(a,c){if(!a||!c)return h.error("B4W Error: missing arguments in get_water_material_params"),null;if(!r(a,c))return null;var d=b.find_batch_material(a,c,"MAIN");if(!d||!d.water)return null;if(!d)return h.warn("B4W Warning: material not found"),null;var e={};if("MAIN"==d.type){if(g.shore_distance){var k=e.shallow_water_col=Array(3);k[0]=d.shallow_water_col[0];k[1]=d.shallow_water_col[1];
k[2]=d.shallow_water_col[2];k=e.shore_water_col=Array(3);k[0]=d.shore_water_col[0];k[1]=d.shore_water_col[1];k[2]=d.shore_water_col[2];e.shallow_water_col_fac=d.shallow_water_col_fac;e.shore_water_col_fac=d.shore_water_col_fac}e.foam_factor=d.foam_factor;e.norm_uv_velocity=d.water_norm_uv_velocity;e.absorb_factor=b.get_batch_directive(d,"ABSORB")[1];e.sss_strength=b.get_batch_directive(d,"SSS_STRENGTH")[1];e.sss_width=b.get_batch_directive(d,"SSS_WIDTH")[1];e.dst_noise_scale0=b.get_batch_directive(d,
"DST_NOISE_SCALE_0")[1];e.dst_noise_scale1=b.get_batch_directive(d,"DST_NOISE_SCALE_1")[1];e.dst_noise_freq0=b.get_batch_directive(d,"DST_NOISE_FREQ_0")[1];e.dst_noise_freq1=b.get_batch_directive(d,"DST_NOISE_FREQ_1")[1];e.dir_min_shore_fac=b.get_batch_directive(d,"DIR_MIN_SHR_FAC")[1];e.dir_freq=b.get_batch_directive(d,"DIR_FREQ")[1];e.dir_noise_scale=b.get_batch_directive(d,"DIR_NOISE_SCALE")[1];e.dir_noise_freq=b.get_batch_directive(d,"DIR_NOISE_FREQ")[1];e.dir_min_noise_fac=b.get_batch_directive(d,
"DIR_MIN_NOISE_FAC")[1];e.dst_min_fac=b.get_batch_directive(d,"DST_MIN_FAC")[1];e.waves_hor_fac=b.get_batch_directive(d,"WAVES_HOR_FAC")[1]}return e};a.set_material_extended_params=function(a,c,d){if(a&&c&&d){if(!r(a,c))return h.warn("B4W Warning: setting material params is not possible"),null;a=b.find_batch_material(a,c,"MAIN");a?"MAIN"==a.type&&("number"==typeof d.material_reflectivity&&(a.reflect_factor=d.material_reflectivity),"number"==typeof d.material_fresnel&&(a.fresnel_params[2]=d.material_fresnel),
"number"==typeof d.material_fresnel_factor&&(a.fresnel_params[3]=1-d.material_fresnel_factor/5),"number"==typeof d.material_parallax_scale&&(a.parallax_scale=d.material_parallax_scale),"number"==typeof d.material_parallax_steps&&(d=k.glsl_value(parseFloat(d.material_parallax_steps)),b.set_batch_directive(a,"PARALLAX_STEPS",d),b.update_shader(a,!0))):h.warn("B4W Warning: material not found")}else h.error("B4W Error: missing arguments in set_material_params")};a.set_water_material_params=function(a,
c,d){if(!a||!c||!d)return h.error("B4W Error: missing arguments in set_water_material_params"),null;if(!r(a,c))return h.warn("B4W Warning: setting water material params is not possible"),null;a=b.find_batch_material(a,c,"MAIN");if(!a)return h.warn("B4W Warning: material not found"),null;"MAIN"==a.type&&(g.shore_distance&&("object"==typeof d.shallow_water_col&&a.shallow_water_col.set(d.shallow_water_col),"number"==typeof d.shallow_water_col_fac&&(a.shallow_water_col_fac=d.shallow_water_col_fac),"object"==
typeof d.shore_water_col&&a.shore_water_col.set(d.shore_water_col),"number"==typeof d.shore_water_col_fac&&(a.shore_water_col_fac=d.shore_water_col_fac)),g.shore_smoothing&&a.water_shore_smoothing&&("boolean"==typeof d.shore_smoothing&&(d.shore_smoothing?b.set_batch_directive(a,"SHORE_SMOOTHING",1):b.set_batch_directive(a,"SHORE_SMOOTHING",0)),"number"==typeof d.absorb_factor&&(c=k.glsl_value(parseFloat(d.absorb_factor)),b.set_batch_directive(a,"ABSORB",c))),"number"==typeof d.foam_factor&&g.foam&&
(a.foam_factor=d.foam_factor),"number"==typeof d.norm_uv_velocity&&(a.water_norm_uv_velocity=d.norm_uv_velocity),g.water_dynamic&&a.water_dynamic&&("boolean"==typeof d.water_dynamic&&(d.water_dynamic?b.set_batch_directive(a,"DYNAMIC",1):b.set_batch_directive(a,"DYNAMIC",0)),"number"==typeof d.waves_height&&(c=k.glsl_value(parseFloat(d.waves_height)),b.set_batch_directive(a,"WAVES_HEIGHT",c)),"number"==typeof d.waves_length&&(c=k.glsl_value(parseFloat(d.waves_length)),b.set_batch_directive(a,"WAVES_LENGTH",
c)),"number"==typeof d.sss_strength&&(c=k.glsl_value(parseFloat(d.sss_strength)),b.set_batch_directive(a,"SSS_STRENGTH",c)),"number"==typeof d.sss_width&&(c=k.glsl_value(parseFloat(d.sss_width)),b.set_batch_directive(a,"SSS_WIDTH",c)),"number"==typeof d.dst_noise_scale0&&(c=k.glsl_value(parseFloat(d.dst_noise_scale0)),b.set_batch_directive(a,"DST_NOISE_SCALE_0",c)),"number"==typeof d.dst_noise_scale1&&(c=k.glsl_value(parseFloat(d.dst_noise_scale1)),b.set_batch_directive(a,"DST_NOISE_SCALE_1",c)),
"number"==typeof d.dst_noise_freq0&&(c=k.glsl_value(parseFloat(d.dst_noise_freq0)),b.set_batch_directive(a,"DST_NOISE_FREQ_0",c)),"number"==typeof d.dst_noise_freq1&&(c=k.glsl_value(parseFloat(d.dst_noise_freq1)),b.set_batch_directive(a,"DST_NOISE_FREQ_1",c)),"number"==typeof d.dir_min_shore_fac&&(c=k.glsl_value(parseFloat(d.dir_min_shore_fac)),b.set_batch_directive(a,"DIR_MIN_SHR_FAC",c)),"number"==typeof d.dir_freq&&(c=k.glsl_value(parseFloat(d.dir_freq)),b.set_batch_directive(a,"DIR_FREQ",c)),
"number"==typeof d.dir_noise_scale&&(c=k.glsl_value(parseFloat(d.dir_noise_scale)),b.set_batch_directive(a,"DIR_NOISE_SCALE",c)),"number"==typeof d.dir_noise_freq&&(c=k.glsl_value(parseFloat(d.dir_noise_freq)),b.set_batch_directive(a,"DIR_NOISE_FREQ",c)),"number"==typeof d.dir_min_noise_fac&&(c=k.glsl_value(parseFloat(d.dir_min_noise_fac)),b.set_batch_directive(a,"DIR_MIN_NOISE_FAC",c)),"number"==typeof d.dst_min_fac&&(c=k.glsl_value(parseFloat(d.dst_min_fac)),b.set_batch_directive(a,"DST_MIN_FAC",
c)),"number"==typeof d.waves_hor_fac&&(d=k.glsl_value(parseFloat(d.waves_hor_fac)),b.set_batch_directive(a,"WAVES_HOR_FAC",d))),b.update_shader(a,!0));return!0}};b4w.module.camera=function(a,q){function r(a,e){c.is_target_camera(a)?(k.copy(e,a._render.pivot),h.update_transform(a),d.sync_transform(a)):b.error("set_pivot(): Wrong object or camera move style")}var c=q("__camera");q("__config");var d=q("__physics"),b=q("__print"),l=q("__constraints"),h=q("__transform"),e=q("__util"),k=q("vec3"),g=q("vec4"),y=q("quat"),m=q("mat3"),s=q("mat4"),x=new Float32Array(3),C=new Float32Array(3),A=new Float32Array(4),f=new Float32Array(4),E=new Float32Array(4),n=new Float32Array(9);
a.MS_STATIC=c.MS_STATIC;a.MS_ANIMATION=c.MS_ANIMATION;a.MS_CONTROLS=c.MS_TARGET_CONTROLS;a.MS_TARGET_CONTROLS=c.MS_TARGET_CONTROLS;a.MS_EYE_CONTROLS=c.MS_EYE_CONTROLS;a.MS_HOVER_CONTROLS=c.MS_HOVER_CONTROLS;a.is_camera=function(a){return c.is_camera(a)};a.set_move_style=function(a,b){a._render.move_style=b};a.get_move_style=function(a){return c.is_camera(a)?c.get_move_style(a):(b.error("get_move_style(): Wrong object"),null)};a.set_velocity_params=function(a,d){if(!c.is_target_camera(a)&&!c.is_eye_camera(a)&&
!c.is_hover_camera(a))return b.error("set_velocity_params(): Wrong object or camera move style"),null;var e=a._render;e.velocity_trans=d[0];e.velocity_rot=d[1];e.velocity_zoom=d[2]};a.get_velocity_params=function(a,d){if(!c.is_target_camera(a)&&!c.is_eye_camera(a)&&!c.is_hover_camera(a))return b.error("get_velocity_params(): Wrong object or camera move style"),null;d||(d=new Float32Array(3));var e=a._render;d[0]=e.velocity_trans;d[1]=e.velocity_rot;d[2]=e.velocity_zoom;return d};a.change_eye_target_dist=
function(){b.error("change_eye_target_dist() deprecated")};a.set_look_at=function(a,b,e,f){var g=a._render;c.eye_target_up_to_trans_quat(b,e,f,g.trans,g.quat);h.update_transform(a);d.sync_transform(a)};a.get_eye=function(a,d){if(c.is_camera(a))return d||(d=new Float32Array(3)),k.copy(a._render.trans,d),d;b.error("get_eye(): Wrong object")};a.set_pivot=r;a.get_pivot=function(a,d){if(c.is_target_camera(a))return d||(d=new Float32Array(3)),k.copy(a._render.pivot,d),d;b.error("get_pivot(): Wrong object or camera move style")};
a.rotate_pivot=function(a,g,l){if(c.is_target_camera(a)){var m=a._render;x[0]=1;x[1]=0;x[2]=0;k.transformQuat(x,m.quat,x);y.setAxisAngle(x,l,A);x[0]=0;x[1]=1;x[2]=0;l=e.quat_to_dir(m.quat,e.AXIS_MY,C);.999999>Math.abs(k.dot(l,x))&&(y.setAxisAngle(x,g,f),y.multiply(f,A,A));e.rotate_point_pivot(m.trans,m.pivot,A,m.trans);h.update_transform(a);d.sync_transform(a)}else b.error("rotate_pivot(): wrong object")};a.move_pivot=function(a,e,f){if(c.is_target_camera(a)){var g=a._render;if(g.use_panning){var l=
m.fromMat4(g.world_matrix,n),q=k.subtract(g.trans,g.pivot,C);x[0]=e;x[1]=0;x[2]=f;k.scale(x,k.len(q),x);k.transformMat3(x,l,x);k.add(g.pivot,x,g.pivot);k.add(g.trans,x,g.trans);h.update_transform(a);d.sync_transform(a)}}else b.error("move_pivot(): wrong object")};a.rotate_hover_cam=function(a,f){if(c.is_hover_camera(a)){var g=a._render;if(g.use_distance_limits&&g.enable_hover_hor_rotation&&f){var k=y.setAxisAngle(e.AXIS_Y,f,A);y.normalize(k,k);y.multiply(k,g.quat,g.quat);h.update_transform(a);d.sync_transform(a)}}else b.error("rotate_hover_cam(): wrong object")};
a.get_hover_cam_angle=function(a){return c.is_hover_camera(a)?c.get_hover_angle(a):(b.error("get_hover_cam_angle(): wrong object or camera move style"),null)};a.set_hover_cam_angle=function(a,f){if(c.is_hover_camera(a)){var g=a._render;if(g.use_distance_limits){var k=e.quat_to_dir(g.quat,e.AXIS_X,x),l=c.get_hover_angle(a)-f,k=y.setAxisAngle(k,l,A),g=y.multiply(k,g.quat,A);h.set_rotation(a,g);h.update_transform(a);d.sync_transform(a)}else b.warn("set_hover_cam_angle(): undefined without distance limits")}else b.error("set_hover_cam_angle(): wrong object or camera move style")};
a.get_hover_angle_limits=function(a,d){if(c.is_hover_camera(a))return a._render.hover_angle_limits?(d||(d=new Float32Array(2)),d[0]=a._render.hover_angle_limits.up,d[1]=a._render.hover_angle_limits.down):b.warn("get_hover_angle_limits(): camera hasn't angle limits"),d;b.error("get_hover_angle_limits(): wrong object")};a.get_cam_dist_limits=function(a,d){if(c.is_hover_camera(a)||c.is_target_camera(a))return a._render.use_distance_limits?(d||(d=new Float32Array(2)),d[0]=a._render.distance_max,d[1]=
a._render.distance_min):b.warn("get_cam_dist_limits(): camera hasn't distance limits"),d;b.error("get_cam_dist_limits(): wrong object")};a.translate_hover_cam_v=function(a,e){if(c.is_hover_camera(a)){var f=a._render;f.use_distance_limits?k.copy(e,f.hover_pivot):h.set_translation(a,e);h.update_transform(a);d.sync_transform(a)}else b.error("translate_hover_cam_v(): wrong object")};a.get_hover_cam_pivot=function(a,d){if(!c.is_hover_camera(a))return b.error("get_hover_cam_pivot(): wrong object"),null;
d||(d=new Float32Array(3));k.copy(a._render.hover_pivot,d);return d};a.has_distance_limits=function(a){return c.is_target_camera(a)||c.is_hover_camera(a)?a._render.use_distance_limits:(b.error("has_distance_limits(): wrong object"),null)};a.apply_vertical_limits=function(a,e,f,g){if(c.is_target_camera(a)||c.is_eye_camera(a)){var k=a._render;k.vertical_limits={down:e,up:f};g==h.SPACE_LOCAL&&c.vertical_limits_local_to_world(a);c.vertical_limits_correct(a)}else if(c.is_hover_camera(a)){if(e>f){b.error("apply_vertical_limits(): wrong horizontal limits");
return}k=a._render;k.vertical_limits={down:-f,up:-e}}else{b.error("apply_vertical_limits(): wrong object");return}h.update_transform(a);d.sync_transform(a)};a.clear_vertical_limits=function(a){a._render.vertical_limits=null;(c.is_target_camera(a)||c.is_eye_camera(a))&&c.vertical_limits_correct(a)};a.apply_horizontal_limits=function(a,e,f,g){if(c.is_target_camera(a)||c.is_eye_camera(a)){var k=a._render;k.horizontal_limits={left:e,right:f};g==h.SPACE_LOCAL&&c.horizontal_limits_local_to_world(a);c.vertical_limits_correct(a)}else if(c.is_hover_camera(a)){if(e>
f){b.error("apply_horizontal_limits(): wrong horizontal limits");return}k=a._render;k.horizontal_limits={left:e,right:f}}else{b.error("apply_horizontal_limits(): wrong object");return}h.update_transform(a);d.sync_transform(a)};a.clear_horizontal_limits=function(a){a._render.horizontal_limits=null};a.get_horizontal_limits=function(a,d){if(c.is_target_camera(a)||c.is_eye_camera(a)||c.is_hover_camera(a)){var e=a._render;d=d||new Float32Array(2);if(e.horizontal_limits)return d[0]=e.horizontal_limits.left,
d[1]=e.horizontal_limits.right,d}else b.error("get_horizontal_limits(): wrong object")};a.has_horizontal_limits=function(a){if(c.is_target_camera(a)||c.is_eye_camera(a)||c.is_hover_camera(a))return Boolean(a._render.horizontal_limits);b.error("has_horizontal_limits(): wrong object")};a.apply_hover_angle_limits=function(a,e,f){c.is_hover_camera(a)?e>f?b.error("apply_hover_angle_limits(): wrong vertical limits"):(a._render.hover_angle_limits={down:e,up:f},h.update_transform(a),d.sync_transform(a)):
b.error("apply_hover_angle_limits(): wrong object")};a.clear_hover_angle_limits=function(a){c.is_hover_camera(a)?a._render.hover_angle_limits=null:b.error("clear_hover_angle_limits(): wrong object")};a.apply_distance_limits=function(a,e,f){if(c.is_target_camera(a)||c.is_hover_camera(a))if(e>f)b.error("apply_distance_limits(): wrong distance limits");else{var g=a._render;g.use_distance_limits=!0;g.distance_min=e;g.distance_max=f;h.update_transform(a);d.sync_transform(a)}else b.error("apply_distance_limits(): wrong object")};
a.clear_distance_limits=function(a){c.is_target_camera(a)||c.is_hover_camera(a)?a._render.use_distance_limits=!1:b.error("clear_distance_limits(): wrong object")};a.set_eye_params=function(a,b,e){y.identity(a._render.quat);c.rotate_v_local(a,Math.PI/2);c.rotate_h(a,b);c.rotate_v_local(a,-e);h.update_transform(a);d.sync_transform(a)};a.is_look_up=function(a){e.quat_to_dir(a._render.quat,e.AXIS_MY,x);return 0<=x[1]?!0:!1};a.rotate=function(a,b,e){c.rotate_h(a,b);c.rotate_v_local(a,-e);h.update_transform(a);
d.sync_transform(a)};a.get_angles=function(a,b){b||(b=new Float32Array(2));c.get_angles(a,b);return b};a.set_stereo_distance=function(a,b){for(var d=a._render.cameras,e=0;e<d.length;e++){var f=d[e];f.type!=c.TYPE_STEREO_LEFT&&f.type!=c.TYPE_STEREO_RIGHT||c.set_stereo_params(f,b,f.stereo_eye_dist)}};a.get_stereo_distance=function(a,b){for(var d=a._render.cameras,e=0;e<d.length;e++){var f=d[e];if(f.type==c.TYPE_STEREO_LEFT||f.type==c.TYPE_STEREO_RIGHT)return f.stereo_conv_dist}return 0};a.is_underwater=
function(a){return a._render.underwater};a.translate_view=function(a,b,d,e){a=a._render.cameras;for(var f=0;f<a.length;f++){var g=a[f];g.reflection_plane||c.set_projection(g,g.aspect);var h=x;h[0]=-b;h[1]=-d;h[2]=0;s.translate(g.proj_matrix,h,g.proj_matrix);s.rotateZ(g.proj_matrix,e,g.proj_matrix);s.multiply(g.proj_matrix,g.view_matrix,g.view_proj_matrix);c.calc_view_proj_inverse(g);c.calc_sky_vp_inverse(g)}};a.correct_up=function(a,b){b||(b=e.AXIS_Y);l.correct_up(a,b)};a.zoom_object=function(a,e){if(c.is_target_camera(a)){h.get_object_center(e,
!1,x);r(a,x);h.update_transform(a);var f=h.get_object_size(e),g=c.get_angular_diameter(a)/2,f=f/Math.sin(g),g=h.obj_point_distance(a,x);h.move_local(a,0,f-g,0);h.update_transform(a);d.sync_transform(a)}else b.error("zoom_object(): wrong object")};a.set_ortho_scale=function(d,e){if(c.is_camera(d)){var f=d._render;if(c.is_target_camera(d)){var g=k.dist(f.trans,f.pivot);f.init_top=e/2*f.init_dist/g}else c.is_hover_camera(d)&&a.has_distance_limits(d)?(g=c.get_hover_dir_pivot(d),g=k.len(g),f.init_top=
e/2*f.init_dist/g):f.init_top=e/2;c.update_ortho_scale(d)}else b.error("set_ortho_scale(): wrong object")};a.get_ortho_scale=function(a){if(c.is_camera(a))return a._render.cameras[0].type==c.TYPE_ORTHO?2*a._render.cameras[0].top:0;b.error("get_ortho_scale(): wrong object")};a.is_ortho_camera=function(a){if(c.is_camera(a))return a._render.cameras[0].type==c.TYPE_ORTHO;b.error("is_ortho_camera(): wrong object")};a.calc_ray=function(a,d,e,f){f||(f=new Float32Array(3));var h=a._render.cameras[0];switch(h.type){case c.TYPE_PERSP:case c.TYPE_PERSP_ASPECT:case c.TYPE_STEREO_LEFT:case c.TYPE_STEREO_RIGHT:var l=
Math.tan(h.fov*Math.PI/360);E[0]=(2*d/h.width-1)*l*h.aspect;E[1]=-1;E[2]=(2*e/h.height-1)*l;E[3]=0;g.transformMat4(E,a._render.world_matrix,E);f[0]=E[0];f[1]=E[1];f[2]=E[2];k.normalize(f,f);return f;default:return b.error("Non-compatible camera"),f}};a.project_point=function(a,d,e){e||(e=new Float32Array(2));var f=a._render.cameras[0];switch(f.type){case c.TYPE_PERSP:case c.TYPE_PERSP_ASPECT:case c.TYPE_STEREO_LEFT:case c.TYPE_STEREO_RIGHT:return h.get_translation(a,x),k.subtract(d,x,x),E.set(x),
E[3]=0,g.transformMat4(E,f.view_proj_matrix,E),a=-E[1]/E[3],e[0]=(E[0]/E[3]+1)/2*f.width|0,e[1]=(a+1)/2*f.height|0,e;default:return b.error("Non-compatible camera"),e}}};b4w.module.config=function(a,q){var r=q("__config");a.P_LOW=r.P_LOW;a.P_HIGH=r.P_HIGH;a.P_ULTRA=r.P_ULTRA;a.P_CUSTOM=r.P_CUSTOM;a.set=r.set;a.get=r.get;a.reset=r.reset;a.get_std_assets_path=r.get_std_assets_path};b4w.module.controls=function(a,q){var r=q("__controls");q("__print");a.CT_CONTINUOUS=r.CT_CONTINUOUS;a.CT_TRIGGER=r.CT_TRIGGER;a.CT_SHOT=r.CT_SHOT;a.CT_LEVEL=r.CT_LEVEL;a.KEY_BACKSPACE=8;a.KEY_TAB=9;a.KEY_ENTER=13;a.KEY_SHIFT=16;a.KEY_CTRL=17;a.KEY_ALT=18;a.KEY_PAUSE=19;a.KEY_CAPSLOCK=20;a.KEY_ESC=27;a.KEY_SPACE=32;a.KEY_LEFT=37;a.KEY_UP=38;a.KEY_RIGHT=39;a.KEY_DOWN=40;a.KEY_NUM0=96;a.KEY_NUM1=97;a.KEY_NUM2=98;a.KEY_NUM3=99;a.KEY_NUM4=100;a.KEY_NUM5=101;a.KEY_NUM6=102;a.KEY_NUM7=103;a.KEY_NUM8=104;
a.KEY_NUM9=105;a.KEY_A=65;a.KEY_B=66;a.KEY_C=67;a.KEY_D=68;a.KEY_E=69;a.KEY_F=70;a.KEY_G=71;a.KEY_H=72;a.KEY_I=73;a.KEY_J=74;a.KEY_K=75;a.KEY_L=76;a.KEY_M=77;a.KEY_N=78;a.KEY_O=79;a.KEY_P=80;a.KEY_Q=81;a.KEY_R=82;a.KEY_S=83;a.KEY_T=84;a.KEY_U=85;a.KEY_V=86;a.KEY_W=87;a.KEY_X=88;a.KEY_Y=89;a.KEY_Z=90;a.KEY_1=49;a.KEY_2=50;a.KEY_3=51;a.KEY_4=52;a.KEY_5=53;a.KEY_6=54;a.KEY_7=55;a.KEY_8=56;a.KEY_9=57;a.KEY_DEC_POINT=110;a.KEY_SEMI_COLON=186;a.KEY_EQUAL_SIGN=187;a.KEY_COMMA=188;a.KEY_DASH=189;a.KEY_PERIOD=
190;a.KEY_FORWARD_SLASH=191;a.KEY_GRAVE_ACCENT=192;a.KEY_LEFT_SQ_BRACKET=219;a.KEY_BACK_SLASH=220;a.KEY_RIGHT_SQ_BRACKET=221;a.KEY_SINGLE_QUOTE=222;a.PL_SINGLE_TOUCH_MOVE=r.PL_SINGLE_TOUCH_MOVE;a.PL_MULTITOUCH_MOVE_ZOOM=r.PL_MULTITOUCH_MOVE_ZOOM;a.PL_MULTITOUCH_MOVE_PAN=r.PL_MULTITOUCH_MOVE_PAN;a.create_custom_sensor=r.create_custom_sensor;a.create_keyboard_sensor=r.create_keyboard_sensor;a.create_collision_sensor=r.create_collision_sensor;a.create_collision_impulse_sensor=r.create_collision_impulse_sensor;
a.create_ray_sensor=r.create_ray_sensor;a.create_mouse_click_sensor=r.create_mouse_click_sensor;a.create_mouse_wheel_sensor=r.create_mouse_wheel_sensor;a.create_mouse_move_sensor=r.create_mouse_move_sensor;a.create_touch_move_sensor=r.create_touch_move_sensor;a.create_touch_zoom_sensor=r.create_touch_zoom_sensor;a.create_motion_sensor=r.create_motion_sensor;a.create_vertical_velocity_sensor=r.create_vertical_velocity_sensor;a.create_gyro_angles_sensor=r.create_gyro_angles_sensor;a.create_gyro_delta_sensor=
r.create_gyro_delta_sensor;a.create_timer_sensor=function(a,d){return r.create_timer_sensor(a,d||!1)};a.reset_timer_sensor=r.reset_timer_sensor;a.create_elapsed_sensor=r.create_elapsed_sensor;a.create_timeline_sensor=r.create_timeline_sensor;a.create_selection_sensor=function(a,d){return r.create_selection_sensor(a,d||!1)};a.set_custom_sensor=function(a,d){r.sensor_set_value(a,d)};a.get_custom_sensor=function(a,d){return a.value};a.get_sensor_value=r.get_sensor_value;a.get_sensor_payload=r.get_sensor_payload;
a.sensor_make_positive=function(a){throw"Deprecated method execution";};a.sensor_make_negative=function(a){throw"Deprecated method execution";};a.create_sensor_lock=function(a,d,b){a.lock_sensors=d.slice(0);a.lock_sensor_values=Array(d.length);a.lock_logic_fun=b||r.default_AND_logic_fun};a.remove_sensor_lock=function(a){a.lock_sensors=null;a.lock_sensor_values=null;a.lock_logic_fun=null};a.create_sensor_manifold=function(a,d,b,l,h,e,k){h=h||r.default_AND_logic_fun;r.create_sensor_manifold(a,d,b,l,
h,e,void 0===k?null:k)};a.create_kb_sensor_manifold=function(a,d,b,l,h,e){l=r.create_keyboard_sensor(l);r.create_sensor_manifold(a,d,b,[l],r.default_AND_logic_fun,h,void 0===e?null:e)};a.check_sensor_manifolds=function(a){return r.check_sensor_manifold(a,null)};a.check_sensor_manifold=r.check_sensor_manifold;a.remove_sensor_manifolds=function(a){r.remove_sensor_manifold(a,null)};a.remove_sensor_manifold=r.remove_sensor_manifold;a.reset=r.reset;a.register_keyboard_events=r.register_keyboard_events;
a.register_mouse_events=function(a,d,b,l){r.register_mouse_events(a,d,!!b)};a.register_wheel_events=r.register_wheel_events;a.register_touch_events=r.register_touch_events;a.register_device_orientation=r.register_device_orientation;a.unregister_keyboard_events=r.unregister_keyboard_events;a.unregister_mouse_events=r.unregister_mouse_events;a.unregister_wheel_events=r.unregister_wheel_events;a.unregister_device_orientation=r.register_device_orientation;a.unregister_touch_events=r.unregister_touch_events};b4w.module.constraints=function(a,q){var r=q("__constraints"),c=q("__physics"),d=q("__transform");a.append_stiff=function(a,l,h,e,k){k=k||1;l instanceof Array&&2==l.length?r.append_stiff_bone(a,l[0],l[1],h,e,k):r.append_stiff_obj(a,l,h,e,k);d.update_transform(a);c.sync_transform(a)};a.append_semi_stiff=function(a,l,h,e){r.append_semi_stiff_obj(a,l,h,e);d.update_transform(a);c.sync_transform(a)};a.append_semi_stiff_cam=function(a,l,h,e,k,g,q,m){r.append_semi_stiff_cam_obj(a,l,h,e,k,g,q,m);d.update_transform(a);
c.sync_transform(a)};a.append_semi_soft_cam=function(a,l,h,e){if(!e||0>e)e=.25;r.append_semi_soft_cam_obj(a,l,h,e);d.update_transform(a);c.sync_transform(a)};a.append_stiff_trans=function(a,l,h){r.append_stiff_trans_obj(a,l,h);d.update_transform(a);c.sync_transform(a)};a.append_copy_trans=function(a,l,h){r.append_copy_trans_obj(a,l,h);d.update_transform(a);c.sync_transform(a)};a.append_stiff_trans_rot=function(a,l,h,e){r.append_stiff_trans_rot_obj(a,l,h,e,1);d.update_transform(a);c.sync_transform(a)};
a.append_track=function(a,l){3==l.length?r.append_track_point(a,l):r.append_track_obj(a,l);d.update_transform(a);c.sync_transform(a)};a.append_follow=function(a,l,h,e){3==l.length?r.append_follow_point(a,l,h,e):r.append_follow_obj(a,l,h,e);d.update_transform(a);c.sync_transform(a)};a.remove=function(a){a._constraint&&r.remove(a)}};b4w.module.data=function(a,q){var r=q("__data");q("__print");var c=q("__util");a.load=r.load;a.unload=function(a){r.unload(a|0)};a.set_debug_resources_root=r.set_debug_resources_root;a.is_primary_loaded=r.is_primary_loaded;a.load_and_add_new=r.load;a.get_bpy_world=function(a){c.panic("get_bpy_world() deprecated");return null};a.cleanup=a.unload};b4w.module.debug=function(a,q){q("__batch");var r=q("__print"),c=q("__controls"),d=q("__debug"),b=q("__physics"),l=q("__scenegraph"),h=q("__scenes"),e=q("__sfx"),k=q("__textures"),g=q("__util");q("__config");var y=q("vec3");a.physics_worker=function(){b.debug_worker()};a.physics_id=function(a){r.log("O",b.find_obj_by_body_id(a));for(var c=b.get_active_scene()._physics.bundles,d=0;d<c.length;d++){var e=c[d];e.physics.body_id==a&&r.log("B",e)}};a.visible_objects=function(){for(var a=h.get_active(),
b=h.get_scene_objs(a,"MESH",h.DATA_ID_ALL),a=h.get_subs(a,"MAIN_OPAQUE").bundles,c=0;c<b.length;c++){var d=b[c],e=d._render;if("DYNAMIC"==e.type)for(var f=0;f<a.length;f++){var g=a[f];if(g.do_render&&g.obj_render==e){r.log(d.name,d);break}}}};a.object_info=function(a){for(var b=h.get_active(),c=h.get_scene_objs(b,"MESH",h.DATA_ID_ALL),d=0;d<c.length;d++){var e=c[d];if(e.name==a){r.log("Object",e);for(var f=h.get_all_subscenes(b),g=0;g<f.length;g++){for(var k=f[g],l=k.bundles,q=[],y=0;y<l.length;y++)l[y].obj_render==
e._render&&q.push(l[y]);r.log("Subscene "+k.type,q)}}}};a.objects_stat=function(){var a=h.get_active();console.log("Armatures: "+h.get_scene_objs(a,"ARMATURE",h.DATA_ID_ALL).length);console.log("Cameras: "+h.get_scene_objs(a,"CAMERA",h.DATA_ID_ALL).length);console.log("Curves: "+h.get_scene_objs(a,"CURVE",h.DATA_ID_ALL).length);console.log("Empties: "+h.get_scene_objs(a,"EMPTY",h.DATA_ID_ALL).length);console.log("Lamps: "+h.get_scene_objs(a,"LAMP",h.DATA_ID_ALL).length);console.log("Meshes: "+h.get_scene_objs(a,
"MESH",h.DATA_ID_ALL).length);console.log("Speakers: "+h.get_scene_objs(a,"SPEAKER",h.DATA_ID_ALL).length)};a.num_vertices=function(){for(var a=0,b=h.get_active(),b=[h.get_subs(b,"MAIN_OPAQUE"),h.get_subs(b,"MAIN_BLEND")],c=0;c<b.length;c++){var d=b[c];if(d)for(var d=d.bundles,e=0;e<d.length;e++){var f=d[e].batch;f&&(a+=f.num_vertices)}}return a};a.num_triangles=function(){for(var a=0,b=h.get_active(),b=[h.get_subs(b,"MAIN_OPAQUE"),h.get_subs(b,"MAIN_BLEND")],c=0;c<b.length;c++){var d=b[c];if(d)for(var d=
d.bundles,e=0;e<d.length;e++){var f=d[e].batch;f&&(a+=f.num_triangles)}}return a};a.num_draw_calls=function(){var a=h.get_active(),a=[h.get_subs(a,"MAIN_OPAQUE"),h.get_subs(a,"MAIN_BLEND")];return a[0].bundles.length+a[1].bundles.length};a.geometry_stats=function(){for(var a=h.get_active(),b=h.get_all_subscenes(a),a={},c=0;c<b.length;c++){var d=b[c];if("SINK"!=d.type&&"WIREFRAME"!=d.type)for(var e=d.bundles,f=0;f<e.length;f++){var g=e[f].batch,k=e[f].obj_render;g&&("COLOR_PICKING"!=d.type&&"GLOW_MASK"!=
d.type||k.origin_selectable)&&(a[g.id]=g)}}var e=d=c=b=0,l;for(l in a)g=a[l],g=g.bufs_data,g.debug_ibo_bytes&&(d++,e+=g.debug_ibo_bytes/1048576),b++,c+=g.debug_vbo_bytes/1048576;return{vbo_number:b,vbo_memory:c,ibo_number:d,ibo_memory:e}};a.num_textures=function(){for(var a=[],b=0,c=h.get_active(),c=[h.get_subs(c,"MAIN_OPAQUE"),h.get_subs(c,"MAIN_BLEND")],d=0;d<c.length;d++){var e=c[d];if(e)for(var e=e.bundles,f=0;f<e.length;f++){var g=e[f].batch;if(g)for(var g=g.textures,k=0;k<g.length;k++){var l=
g[k];if("IMAGE"===l.source||"ENVIRONMENT_MAP"===l.source){var q=l.w_texture;-1===a.indexOf(q)&&(a.push(q),l=l.width*l.height*4/1048576/l.compress_ratio,l*=1.3333,b+=l)}}}}return{number:a.length,memory:b}};a.num_render_targets=function(){for(var a=[],b=0,c=h.get_active(),c=h.get_all_subscenes(c),d=0;d<c.length;d++){var e=c[d];if("SINK"!=e.type){var f=e.camera,g=[f.color_attachment,f.depth_attachment];g.push.apply(g,e.textures_internal);for(e=0;e<g.length;e++){var l=g[e];k.is_texture(l)&&-1==a.indexOf(l)&&
(a.push(l),b+=f.width*f.height*k.get_texture_channel_size(l))}}}return{number:a.length,memory:b/1024/1024}};a.make_camera_frustum_shot=function(){var a=h.get_active();(a=h.get_subs(a,"MAIN_OPAQUE"))&&h.make_frustum_shot(a.camera,a,[1,1,0])};a.make_light_frustum_shot=function(){var a=h.get_active(),b=h.get_subs(a,"MAIN_OPAQUE"),a=h.subs_array(a,["SHADOW_CAST"]);if(b)for(var c=0;c<a.length;c++){var d=a[c],e;switch(c){case 0:e=[1,0,0];break;case 1:e=[0,1,0];break;case 2:e=[0,0,1];break;default:e=[1,
0,1]}h.make_frustum_shot(d.camera,b,e)}};a.scenegraph_to_dot=function(){var a=h.get_active(),a=h.get_graph(a);r.log(l.debug_convert_to_dot(a))};a.controls_info=c.debug;a.object_distance=function(a,b){return y.dist(a._render.trans,b._render.trans)};a.msg=d.msg;a.fbmsg=d.fbmsg;a.print_telemetry=d.print_telemetry;a.plot_telemetry=d.plot_telemetry;a.fbres=function(a,b){b||(b=16);var c=function(){d.fbmsg("FBRES",a());setTimeout(c,b)};c()};a.assert_constants=function(){var a=new Float32Array(3),b=new Float32Array([0,
0,0,1]),c=new Float32Array([1,0,0]),d=new Float32Array([0,1,0]),e=new Float32Array([0,0,1]),f=new Float32Array([-1,0,0]),h=new Float32Array([0,-1,0]),k=new Float32Array([0,0,-1]);if(!g.cmp_arr(a,g.VEC3_IDENT))throw"Wrong VEC3_IDENT";if(!g.cmp_arr(b,g.QUAT4_IDENT))throw"Wrong QUAT4_IDENT";if(!g.cmp_arr(c,g.AXIS_X))throw"Wrong AXIS_X";if(!g.cmp_arr(d,g.AXIS_Y))throw"Wrong AXIS_Y";if(!g.cmp_arr(e,g.AXIS_Z))throw"Wrong AXIS_Z";if(!g.cmp_arr(f,g.AXIS_MX))throw"Wrong AXIS_MX";if(!g.cmp_arr(h,g.AXIS_MY))throw"Wrong AXIS_MY";
if(!g.cmp_arr(k,g.AXIS_MZ))throw"Wrong AXIS_MZ";};a.mute_music=function(){for(var a=e.get_speaker_objects(),b=0;b<a.length;b++){var c=a[b];"BACKGROUND_MUSIC"==e.get_spk_behavior(c)&&e.mute(c,!0)}};a.check_finite=function(a){d.check_finite(a)};a.set_debug_params=function(a){var b=h.get_active();if(b=h.get_subs(b,"WIREFRAME"))"string"==typeof a.wireframe_mode&&h.set_wireframe_mode(b,a.wireframe_mode),"object"==typeof a.wireframe_edge_color&&h.set_wireframe_edge_color(b,a.wireframe_edge_color);else throw"Wireframe subscene not found.";
};a.get_error_quantity=function(){return r.get_error_count()};a.get_warning_quantity=function(){return r.get_warning_count()};a.clear_errors_warnings=function(){return r.clear_errors_warnings()}};b4w.module.geometry=function(a,q){function r(a){return a&&a._render&&a._render.dynamic_geometry?!0:!1}var c=q("__batch"),d=q("__geometry"),b=q("__print"),l=q("__renderer");a.extract_vertex_array=function(a,e,k){if(!r(a))return b.error("Wrong object:",a.name),null;if(a=c.find_batch_material(a,e,"MAIN")||c.find_batch_material(a,e,"NODES")){if((e=a.bufs_data)&&e.pointers&&e.pointers[k])return d.extract_array(e,k);b.error("Attribute not found:"+k);return null}b.error("Wrong material:",e);return null};
a.extract_index_array=function(a,d){if(!r(a))return b.error("Wrong object:",a.name),null;var k=c.find_batch_material(a,d,"MAIN")||c.find_batch_material(a,d,"NODES");if(k){if((k=k.bufs_data)&&k.pointers)return k.ibo_array;b.error("Buffer data not found");return null}b.error("Wrong material:",d);return null};a.update_vertex_array=function(a,e,k,g){var l=["MAIN","NODES","DEPTH","COLOR_ID"];if(r(a))for(var m=0;m<l.length;m++){var q=c.find_batch_material(a,e,l[m]);q&&(q=q.bufs_data)&&q.pointers&&q.pointers[k]&&
d.update_bufs_data_array(q,k,0,g)}else b.error("Wrong object:",a.name)};a.override_geometry=function(a,e,k,g,q){var m=["MAIN","NODES","DEPTH","COLOR_ID"];if(r(a))if(k instanceof Uint16Array||k instanceof Uint32Array)if(g instanceof Float32Array)for(var s=0;s<m.length;s++){var x=c.find_batch_material(a,e,m[s]);if(x){var C=x.bufs_data;if(C){d.update_bufs_data_index_array(C,x.draw_mode,k);var A=0,f;for(f in C.pointers)var E=C.pointers[f],A=A+g.length/3*E.num_comp;C.vbo_array=new Float32Array(A);var A=
C.vbo_array,n=0;for(f in C.pointers)switch(E=C.pointers[f],f){case "a_position":A.set(g,n);E.offset=n;E.length=g.length;n+=E.length;break;case "a_normal":var t;q&&(t=d.calc_shared_indices(k,g,g));var M=d.calc_normals(k,g,t);A.set(M,n);E.offset=n;E.length=g.length;n+=E.length;break;case "a_tangent":E.offset=n;E.length=g.length/3*E.num_comp;for(var S=new Float32Array(E.length),M=0;M<S.length;M+=4)S[M]=1,S[M+3]=1;A.set(S,n);n+=E.length;break;default:E.offset=n,E.length=g.length/3*E.num_comp,M=new Float32Array(E.length),
A.set(M,n),n+=E.length}d.update_gl_buffers(C);l.assign_attribute_setters(x);if(x.childs)for(M=0;M<x.childs.length;M++)(E=x.childs[M])&&E.bufs_data&&(E.bufs_data=C)}}}else b.error("Wrong positions_array type");else b.error("Wrong ibo_array type");else b.error("Wrong object:",a.name)}};b4w.module.hud=function(a,q){var r=q("__hud");q("__print");a.draw_mixer_strip=r.draw_mixer_strip;a.plot_array=r.plot_array};b4w.module.lights=function(a,q){function r(a){for(var g=b.get_active(),m=b.get_scene_objs(g,"LAMP",b.DATA_ID_ALL),f=0;f<m.length;f++){var q=m[f];if("SUN"==q._light.type){var n=q;break}}if(!n)return c.error("There is no sun on the scene"),null;"number"==typeof a.hor_position&&"number"==typeof a.vert_position&&(m=(90-a.vert_position)/180*Math.PI,f=n._render,l.set_rotation_euler(n,[m,(180-a.hor_position)/180*Math.PI,0]),a=new Float32Array(3),h.quat_to_dir(f.quat,h.AXIS_Y,a),f=e.length(f.trans),e.copy(a,
k),e.scale(k,f,k),l.set_translation(n,k),l.update_transform(n),a=n._light,a.dynamic_intensity&&(q=n.data.energy,f=g.world.light_settings.environment_energy,m=Math.cos(Math.abs(m)),q*=Math.max(Math.min(3*m,1),0),m=Math.max(m,.1)*f,d.set_light_energy(a,q),b.set_environment_colors(g,m,null,null)),b.update_lamp_scene(n,g))}var c=q("__print"),d=q("__lights"),b=q("__scenes"),l=q("__transform"),h=q("__util"),e=q("vec3"),k=new Float32Array(3),g,y,m,s=60;a.get_lamps=function(a){var c=b.get_active(),c=b.get_scene_objs(c,
"LAMP",b.DATA_ID_ALL);if(!a)return c;for(var d=[],e=0;e<c.length;e++){var g=c[e];g._light.type===a&&d.push(g)}return d};a.get_sun_params=function(){for(var a=b.get_active(),a=b.get_scene_objs(a,"LAMP",b.DATA_ID_ALL),c=null,d=0;d<a.length;d++){var e=a[d];if("SUN"==e._light.type){c=e;break}}return c?(c=c._light.direction,a=180*Math.atan2(c[2],c[0])/Math.PI+90,180<a&&(a-=360),c=180*Math.atan2(c[1],Math.sqrt(c[0]*c[0]+c[2]*c[2]))/Math.PI,d={},d.hor_position=a,d.vert_position=c,d):null};a.set_sun_params=
r;a.set_day_time=function(a){for(var d=b.get_active(),d=b.get_scene_objs(d,"LAMP",b.DATA_ID_ALL),e=0;e<d.length;e++){var f=d[e];if("SUN"==f._light.type){var g=f;break}}if(!g)return c.error("There is no sun on the scene"),null;g=12>a?15*a:15*(a-24);a=-Math.cos(a/12*Math.PI)*s;d={};d.hor_position=g;d.vert_position=a;r(d)};a.set_date=function(a){g=a.getDate();y=a.getMonth();m=a.getFullYear();if(g)if(1582==g&&10==a.m&&4<a.d&&15>a.d)c.error("The dates 5 through 14 October, 1582, do not exist in the Gregorian system!");
else{a=g;var b=y,d=m,e,h;2<b?(e=a,h=b+1):(e=a-1,h=b+13);h=Math.floor(Math.floor(365.25*e)+Math.floor(30.6001*h)+d+1720995);588829<=d+31*(b+12*a)&&(a=Math.floor(.01*e),h+=2-a+Math.floor(.25*a));a=1E5*h;b=Math.floor(a);.5<a-b&&++b}else c.error("There is no year 0 in the Julian system!")};a.set_max_sun_angle=function(a){s=Math.min(Math.max(a,0),90)};a.get_light_params=function(a){var d=b.get_active();if(!d)return c.error("No active scene"),!1;for(var d=b.get_scene_objs(d,"LAMP",b.DATA_ID_ALL),e=0;e<
d.length;e++){var f=d[e];if(f.name===a){var g=f._light;break}}return g?{light_color:g.color,light_energy:g.energy}:!1};a.set_light_params=function(a,e){var g=b.get_active();if(!g)return c.error("No active scene"),!1;for(var f=b.get_scene_objs(g,"LAMP",b.DATA_ID_ALL),h=0;h<f.length;h++){var k=f[h];if(k.name===a){var l=k._light;break}}if(!l)return c.error('B4W Warning: light "'+a+'" not found'),!1;"number"==typeof e.light_energy&&(d.set_light_energy(l,e.light_energy),b.update_lamp_scene(k,g));"object"==
typeof e.light_color&&(d.set_light_color(l,e.light_color),b.update_lamp_scene(k,g))};a.get_lights_names=function(){var a=b.get_active();if(!a)return c.error("No active scene"),!1;for(var d=[],a=b.get_scene_objs(a,"LAMP",b.DATA_ID_ALL),e=0;e<a.length;e++)d.push(a[e]._light.name);return d}};b4w.module.physics=function(a,q){var r=q("__print"),c=q("__physics"),d=q("__util");a.CM_WALK=0;a.CM_RUN=1;a.CM_CLIMB=2;a.CM_FLY=3;a.enable_simulation=function(a){c.has_physics(a)?c.enable_simulation(a):r.error("No physics for object "+a.name)};a.disable_simulation=function(a){c.has_physics(a)?c.disable_simulation(a):r.error("No physics for object "+a.name)};a.has_physics=function(a){return c.has_physics(a)};a.has_simulated_physics=function(a){return c.has_simulated_physics(a)};a.has_dynamic_physics=
function(a){return c.has_dynamic_physics(a)};a.set_gravity=function(a,d){c.has_physics(a)?c.set_gravity(a,d):r.error("No physics for object "+a.name)};a.set_damping=function(a,d,h){c.has_physics(a)?c.post_msg("set_damping",a._physics.body_id,d,h):r.error("No physics for object "+a.name)};a.reset_damping=function(a){if(c.has_physics(a)){var d=a.game;c.post_msg("set_damping",a._physics.body_id,d.damping,d.rotation_damping)}else r.error("No physics for object "+a.name)};a.set_transform=function(a,d,
h){c.has_physics(a)?c.set_transform.apply(this,arguments):r.error("No physics for object "+a.name)};a.sync_transform=function(a){c.has_physics(a)?c.sync_transform(a):r.error("No physics for object "+a.name)};a.apply_velocity=function(a){c.has_physics(a)?c.apply_velocity.apply(this,arguments):r.error("No physics for object "+a.name)};a.apply_velocity_world=function(a){c.has_physics(a)?c.apply_velocity_world.apply(this,arguments):r.error("No physics for object "+a.name)};a.apply_force=function(a,d,
h,e){c.has_physics(a)?c.apply_force.apply(this,arguments):r.error("No physics for object "+a.name)};a.apply_torque=function(a,d,h,e){c.has_physics(a)?c.apply_torque.apply(this,arguments):r.error("No physics for object "+a.name)};a.vehicle_throttle=function(a,l){c.has_physics(a)?(c.is_vehicle_chassis(a)||c.is_vehicle_hull(a)||r.error("Wrong object"),c.vehicle_throttle(a,d.clamp(l,-1,1))):r.error("No physics for object "+a.name)};a.vehicle_throttle_inc=function(a,l,h){if(c.has_physics(a)){c.is_vehicle_chassis(a)||
c.is_vehicle_hull(a)||r.error("Wrong object");l=d.clamp(l,0,1);var e=a._vehicle.engine_force;-1==h||1==h?e=Math.max(-1,Math.min(e+h*l,1)):0==h&&0<=e?(e-=l,e=Math.max(0,e)):0==h&&0>e?(e+=l,e=Math.min(0,e)):r.error("Wrong steering direction");c.vehicle_throttle(a,d.clamp(e,-1,1))}else r.error("No physics for object "+a.name)};a.vehicle_steer=function(a,l){c.has_physics(a)?(c.is_vehicle_chassis(a)||c.is_vehicle_hull(a)||r.error("Wrong object"),c.vehicle_steer(a,d.clamp(l,-1,1))):r.error("No physics for object "+
a.name)};a.vehicle_steer_inc=function(a,l,h){if(c.has_physics(a)){c.is_vehicle_chassis(a)||c.is_vehicle_hull(a)||r.error("Wrong object");l=d.clamp(l,0,1);var e=a._vehicle.steering;-1==h||1==h?e=Math.max(-1,Math.min(e+h*l,1)):0==h&&0<=e?(e-=l,e=Math.max(0,e)):0==h&&0>e?(e+=l,e=Math.min(0,e)):r.error("Wrong steering direction");c.vehicle_steer(a,d.clamp(e,-1,1))}else r.error("No physics for object "+a.name)};a.vehicle_brake=function(a,l){c.has_physics(a)?(c.is_vehicle_chassis(a)||c.is_vehicle_hull(a)||
r.error("Wrong object"),c.vehicle_brake(a,d.clamp(l,0,1))):r.error("No physics for object "+a.name)};a.vehicle_brake_inc=function(a,l){if(c.has_physics(a)){c.is_vehicle_chassis(a)||c.is_vehicle_hull(a)||r.error("Wrong object");l=d.clamp(l,-1,1);var h=a._vehicle.brake_force;c.vehicle_brake(a,d.clamp(h+h*l,0,1))}else r.error("No physics for object "+a.name)};a.is_vehicle_chassis=function(a){return c.is_vehicle_chassis(a)};a.is_vehicle_hull=function(a){return c.is_vehicle_hull(a)};a.get_vehicle_name=
function(a){if(!c.has_physics(a))return r.error("No physics for object "+a.name),null;if(c.is_vehicle_chassis(a)||c.is_vehicle_hull(a))return a.b4w_vehicle_settings.name;r.error("Wrong object");return null};a.get_vehicle_throttle=function(a){if(!c.has_physics(a))return r.error("No physics for object "+a.name),null;if(c.is_vehicle_chassis(a)||c.is_vehicle_hull(a))return a._vehicle.engine_force;r.error("Wrong object")};a.get_vehicle_steering=function(a){if(!c.has_physics(a))return r.error("No physics for object "+
a.name),null;if(c.is_vehicle_chassis(a)||c.is_vehicle_hull(a))return a._vehicle.steering;r.error("Wrong object")};a.get_vehicle_brake=function(a){if(!c.has_physics(a))return r.error("No physics for object "+a.name),null;if(c.is_vehicle_chassis(a)||c.is_vehicle_hull(a))return a._vehicle.brake_force;r.error("Wrong object")};a.get_vehicle_speed=function(a){if(!c.has_physics(a))return r.error("No physics for object "+a.name),null;if(c.is_vehicle_chassis(a)||c.is_vehicle_hull(a))return c.get_vehicle_speed(a);
r.error("Wrong object")};a.is_character=function(a){return c.is_character(a)};a.set_character_move_dir=function(a,d,h){c.has_physics(a)?c.set_character_move_dir(a,d,h):r.error("No physics for object "+a.name)};a.set_character_move_type=function(a,d){c.has_physics(a)?c.set_character_move_type(a,d):r.error("No physics for object "+a.name)};a.set_character_dist_to_water=function(a,c){r.warn("Function set_character_dist_to_water() is deprecated")};a.set_character_walk_velocity=function(a,d){c.has_physics(a)?
c.set_character_walk_velocity(a,d):r.error("No physics for object "+a.name)};a.set_character_run_velocity=function(a,d){c.has_physics(a)?c.set_character_run_velocity(a,d):r.error("No physics for object "+a.name)};a.set_character_fly_velocity=function(a,d){c.has_physics(a)?c.set_character_fly_velocity(a,d):r.error("No physics for object "+a.name)};a.character_jump=function(a){c.has_physics(a)?c.character_jump(a):r.error("No physics for object "+a.name)};a.character_rotation_inc=function(a,d,h){c.has_physics(a)?
c.character_rotation_inc(a,d,h):r.error("No physics for object "+a.name)};a.set_character_rotation_quat=function(a,d){c.has_physics(a)?c.set_character_rotation_quat(a,d):r.error("No physics for object "+a.name)};a.set_character_rotation=function(a,d,h){c.has_physics(a)?c.set_character_rotation(a,d,h):r.error("No physics for object "+a.name)};a.set_character_rotation_v=function(a,d){c.has_physics(a)?c.set_character_rotation_v(a,d):r.error("No physics for object "+a.name)};a.set_character_rotation_h=
function(a,d){c.has_physics(a)?c.set_character_rotation_h(a,d):r.error("No physics for object "+a.name)};a.append_collision_test=function(a,d,h,e){c.has_physics(a)?c.append_collision_test(a,d,h,e):r.error("No physics for object "+a.name)};a.remove_collision_test=function(a,d){c.has_physics(a)?c.remove_collision_test(a,d):r.error("No physics for object "+a.name)};a.apply_collision_impulse_test=function(a,d){c.has_physics(a)?c.apply_collision_impulse_test(a,d):r.error("No physics for object "+a.name)};
a.clear_collision_impulse_test=function(a){c.has_physics(a)?c.clear_collision_impulse_test(a):r.error("No physics for object "+a.name)};a.append_ray_test=function(a,d,h,e,k,g){c.has_physics(a)?c.append_ray_test(a,d,h,e,k,g):r.error("No physics for object "+a.name)};a.remove_ray_test=function(a,d,h,e,k){c.has_physics(a)?c.remove_ray_test(a,d,h,e,k):r.error("No physics for object "+a.name)};a.apply_constraint=function(a,d,h,e,k,g,q,m,s,x){c.has_physics(d)&&c.has_physics(k)?c.apply_constraint(a,d,h,
e,k,g,q,m,s,x):r.error("Wrong objects")};a.clear_constraint=function(a){c.has_physics(a)&&c.has_constraint(a)?c.clear_constraint(a):r.error("Wrong object")};a.pull_to_constraint_pivot=function(a,d,h,e,k,g){c.has_physics(a)&&c.has_physics(e)?c.pull_to_constraint_pivot(a,d,h,e,k,g):r.error("Wrong objects")}};b4w.module.scenes=function(a,q){var r=q("__batch"),c=q("__camera"),d=q("__graph"),b=q("__objects"),l=q("__print"),h=q("__physics"),e=q("__scenes"),k=q("__util");a.DATA_ID_ALL=e.DATA_ID_ALL;a.set_active=function(a){var b=e.get_all_scenes();e.set_active(k.keysearch("name",a,b))};a.get_active=function(){return e.check_active()?e.get_active().name:""};a.get_scenes=function(){for(var a=e.get_all_scenes(),b=[],c=0;c<a.length;c++)b.push(a[c].name);return b};a.get_active_camera=function(){if(e.check_active())return e.get_camera(e.get_active());
l.error("No active scene");return!1};a.get_object_by_name=function(a,b){return e.get_object(e.GET_OBJECT_BY_NAME,a,b|0)};a.get_object_by_dupli_name=function(a,b,c){return e.get_object(e.GET_OBJECT_BY_DUPLI_NAME,a,b,c|0)};a.get_object_by_dupli_name_list=function(a,b){return e.get_object(e.GET_OBJECT_BY_DUPLI_NAME_LIST,a,b|0)};a.get_object_by_empty_name=function(b,c,d){l.warn("get_object_by_empty_name() deprecated, use get_object_by_dupli_name() instead");return a.get_object_by_dupli_name(b,c,d)};a.get_object_data_id=
function(a){return e.get_object_data_id(a)};a.pick_object=e.pick_object;a.set_glow_intensity=function(a,b){for(var c=0;c<a._batches.length;c++){var d=a._batches[c];"COLOR_ID"==d.type&&(d.glow_intensity=b)}};a.apply_glow_anim=function(a,b,c,d){a._render&&a._render.selectable&&e.apply_glow_anim(a,b,c,d)};a.apply_glow_anim_def=function(a){if(a._render&&a._render.selectable){var b=a._render.glow_anim_settings;e.apply_glow_anim(a,b.glow_duration,b.glow_period,b.glow_relapses)}};a.clear_glow_anim=function(a){a._render&&
a._render.selectable&&e.clear_glow_anim(a)};a.set_glow_color=function(a){var b=e.get_active();if(b=e.get_subs(b,"GLOW"))b.glow_color.set(a),b.need_perm_uniforms_update=!0};a.get_shadow_params=function(){if(!e.check_active())return l.error("No active scene"),!1;var a=e.get_active(),b=e.get_subs(a,"SHADOW_CAST");if(!b)return null;var c=a._render.shadow_params,d=e.get_subs(a,"MAIN_OPAQUE"),h=e.get_subs(a,"DEPTH"),k={};k.csm_resolution=c.csm_resolution;k.self_shadow_polygon_offset=b.self_shadow_polygon_offset;
h&&(k.self_shadow_normal_offset=h.self_shadow_normal_offset);k.b4w_enable_csm=c.b4w_enable_csm;k.csm_num=c.csm_num;k.csm_first_cascade_border=c.csm_first_cascade_border;k.first_cascade_blur_radius=c.first_cascade_blur_radius;k.csm_last_cascade_border=c.csm_last_cascade_border;k.last_cascade_blur_radius=c.last_cascade_blur_radius;k.fade_last_cascade=c.fade_last_cascade;k.blend_between_cascades=c.blend_between_cascades;c.b4w_enable_csm?(k.csm_borders=e.get_csm_borders(a,d.camera),k.blur_radii=new Float32Array(c.csm_num),
k.blur_radii.set(d.camera.pcf_blur_radii.subarray(0,c.csm_num))):(k.csm_borders=null,k.blur_radii=null);return k};a.set_shadow_params=function(a){if(!e.check_active())return l.error("No active scene"),!1;var b=e.get_active();"number"==typeof a.self_shadow_polygon_offset&&d.traverse(b._render.graph,function(b,c){"SHADOW_CAST"===c.type&&(c.self_shadow_polygon_offset=a.self_shadow_polygon_offset)});var h=e.get_subs(b,"DEPTH");h&&("number"==typeof a.self_shadow_normal_offset&&(h.self_shadow_normal_offset=
a.self_shadow_normal_offset),"number"==typeof a.pcf_blur_radius&&(h.pcf_blur_radius=a.pcf_blur_radius));var k=e.get_subs(b,"MAIN_BLEND");k&&("number"==typeof a.self_shadow_normal_offset&&(k.self_shadow_normal_offset=a.self_shadow_normal_offset),"number"==typeof a.pcf_blur_radius&&(k.pcf_blur_radius=a.pcf_blur_radius),k.need_perm_uniforms_update=!0);k=b._render.shadow_params;"number"==typeof a.csm_first_cascade_border&&(k.csm_first_cascade_border=a.csm_first_cascade_border);"number"==typeof a.first_cascade_blur_radius&&
(k.first_cascade_blur_radius=a.first_cascade_blur_radius);"number"==typeof a.csm_last_cascade_border&&(k.csm_last_cascade_border=a.csm_last_cascade_border);"number"==typeof a.last_cascade_blur_radius&&(k.last_cascade_blur_radius=a.last_cascade_blur_radius);if(h){for(var q=h.bundles,C=0;C<q.length;C++){var A=q[C];A.obj_render.shadow_receive&&(A=A.batch,r.assign_shadow_receive_dirs(A,k),r.update_shader(A))}h.need_perm_uniforms_update=!0}h=b.camera._render.cameras;for(C=0;C<h.length;C++)c.update_camera_shadows(h[C],
k);e.schedule_shadow_update(b)};a.get_environment_colors=function(){if(!e.check_active())return l.error("No active scene"),!1;var a=e.get_active();return e.get_environment_colors(a)};a.set_environment_colors=function(a,b,c){if(!e.check_active())return l.error("No active scene"),!1;var d=e.get_active();e.set_environment_colors(d,parseFloat(a),b,c)};a.get_fog_color_density=function(a){if(!e.check_active())return l.error("No active scene"),!1;var b=e.get_active();return e.get_fog_color_density(b,a)};
a.set_fog_color_density=function(a){if(!e.check_active())return l.error("No active scene"),!1;var b=e.get_active();e.set_fog_color_density(b,a)};a.get_ssao_params=function(){if(!e.check_active())return l.error("No active scene"),!1;var a=e.get_active();return e.get_ssao_params(a)};a.set_ssao_params=function(a){if(!e.check_active())return l.error("No active scene"),!1;var b=e.get_active();e.set_ssao_params(b,a)};a.get_color_correction_params=function(){if(!e.check_active())return l.error("No active scene"),
null;var a=e.get_active(),a=e.get_subs(a,"COMPOSITING");if(!a)return null;var b={};b.brightness=a.brightness;b.contrast=a.contrast;b.exposure=a.exposure;b.saturation=a.saturation;return b};a.set_color_correction_params=function(a){if(!e.check_active())return l.error("No active scene"),null;var b=e.get_active(),b=e.get_subs(b,"COMPOSITING");if(!b)return null;"number"==typeof a.brightness&&(b.brightness=a.brightness);"number"==typeof a.contrast&&(b.contrast=a.contrast);"number"==typeof a.exposure&&
(b.exposure=a.exposure);"number"==typeof a.saturation&&(b.saturation=a.saturation);b.need_perm_uniforms_update=!0};a.get_sky_params=function(){if(!e.check_active())return l.error("No active scene"),!1;var a=e.get_active();return e.get_sky_params(a)};a.set_sky_params=function(a){if(!e.check_active())return l.error("No active scene"),!1;var b=e.get_active();e.set_sky_params(b,a)};a.get_dof_params=function(){if(!e.check_active())return l.error("No active scene"),!1;var a=e.get_active();return e.get_subs(a,
"DOF")?e.get_dof_params(a):null};a.set_dof_params=function(a){if(!e.check_active())return l.error("No active scene"),!1;var b=e.get_active();e.set_dof_params(b,a)};a.get_god_rays_params=function(){if(!e.check_active())return l.error("No active scene"),!1;var a=e.get_active();return e.get_subs(a,"GOD_RAYS")?e.get_god_rays_params(a):null};a.set_god_rays_params=function(a){if(!e.check_active())return l.error("No active scene"),!1;var b=e.get_active();e.set_god_rays_params(b,a)};a.get_bloom_params=function(){if(!e.check_active())return l.error("No active scene"),
!1;var a=e.get_active();return e.get_subs(a,"BLOOM")?e.get_bloom_params(a):null};a.set_bloom_params=function(a){if(!e.check_active())return l.error("No active scene"),!1;var b=e.get_active();e.set_bloom_params(b,a)};a.get_wind_params=function(){return e.get_wind_params()};a.set_wind_params=function(a){if(!e.check_active())return l.error("No active scene"),!1;var b=e.get_active();e.set_wind_params(b,a)};a.get_water_surface_level=e.get_water_surface_level;a.set_water_params=function(a){if(!e.check_active())return l.error("No active scene"),
!1;var b=e.get_active();e.set_water_params(b,a)};a.get_water_mat_params=function(a){if(!e.check_active())return l.error("No active scene"),!1;var b=e.get_active();e.get_water_mat_params(b,a)};a.update_scene_materials_params=function(){if(!e.check_active())return l.error("No active scene"),!1;var a=e.get_active();e.update_scene_permanent_uniforms(a)};a.hide_object=function(a){b.is_dynamic_mesh(a)?e.hide_object(a):l.error("B4W Error: show/hide is only supported for dynamic meshes")};a.show_object=function(a){b.is_dynamic_mesh(a)?
e.show_object(a):l.error("B4W Error: show/hide is only supported for dynamic meshes")};a.is_visible=function(a){return a._render.is_visible};a.check_object=function(a){return e.check_active()?e.check_object(a,e.get_active()):(l.error("No active scene"),!1)};a.get_all_objects=function(a,b){var c=e.get_active();a||(a="ALL");b||0===b||(b=e.DATA_ID_ALL);return e.get_scene_objs(c,a,b)};a.get_appended_objs=function(b,c){l.warn("get_appended_objs() deprecated, use get_all_objects() instead");return a.get_all_objects(b,
c)};a.get_object_name=function(a){return a?a.name:(l.error("Wrong object name"),"")};a.get_object_type=function(a){return a&&a.type?a.type:(l.error("Wrong object ID"),"UNDEFINED")};a.get_object_dg_parent=function(a){return a._dg_parent};a.get_object_children=function(a){return a._descends.slice(0)};a.get_first_character=function(){for(var a=e.get_scene_objs(e.get_active(),"MESH",e.DATA_ID_ALL),b=0;b<a.length;b++){var c=a[b];if(h.is_character(c))return c}return null};a.get_shore_dist=function(a,b){b||
0===b||(b=1);return e.get_shore_dist(a,b)};a.get_cam_water_depth=function(){return e.get_cam_water_depth()};a.get_type_mesh_object=function(a){return"MESH"==a.type?a._render.type:null};a.get_meta_tags=function(){if(!e.check_active())return l.error("No active scene"),!1;var a=e.get_active();return e.get_meta_tags(a)};a.append_object=function(a){k.panic('Method "append_object" is deprecated')};a.add_object=function(a){k.panic('Method "add_object" is deprecated')};a.remove_object=function(a){k.panic('Method "remove_object" is deprecated')};
a.get_screen_scenes=function(){k.panic("get_screen_scenes() deprecated")};a.set_light_pos=function(){k.panic("set_light_pos() deprecated, use lights module instead")};a.set_light_direction=function(){k.panic("set_light_direction() deprecated, use lights module instead")};a.set_dir_light_color=function(a,b){k.panic("set_dir_light_color() deprecated, use lights module instead")};a.get_lights_names=function(){k.panic("get_lights_names() deprecated, use lights module instead")};a.remove_all=function(){k.panic("remove_all() deprecated, use lights module instead")};
a.check_collision=function(){k.panic("check_collision() deprecated, use lights module instead")};a.check_ray_hit=function(){k.panic("check_ray_hit() deprecated, use lights module instead")}};b4w.module.sfx=function(a,q){var r=q("__scenes"),c=q("__sfx"),d=q("__print");a.play=function(a,d,h){c.play(a,d,h)};a.play_def=function(a){c.play_def(a)};a.is_play=function(a){return c.is_play(a)};a.speaker_play=function(a,d,h,e){c.cyclic(a,d);e&&c.playrate(a,e);c.play(a,0,h)};a.speaker_stop=function(a){c.stop(a)};a.stop=function(a){c.stop(a)};a.pause=function(a){c.speaker_pause(a)};a.resume=function(a){c.speaker_resume(a)};a.speaker_playback_rate=function(a,d){c.playrate(a,d)};a.playrate=function(a,
d){c.playrate(a,d)};a.get_playrate=function(a){return c.get_playrate(a)};a.cyclic=function(a,d){c.cyclic(a,d)};a.is_cyclic=function(a){return c.is_cyclic(a)};a.listener_reset_speed=function(a,d){c.listener_reset_speed(a,d)};a.speaker_reset_speed=function(a,d,h){c.speaker_reset_speed(a,d,h)};a.get_volume=function(a){return a&&"object"===typeof a?c.get_volume(a):c.get_master_volume()};a.set_volume=function(a,d){a&&"object"===typeof a?c.set_volume(a,d):c.set_master_volume(d)};a.mute=function(a,d){a&&
"object"===typeof a?c.mute(a,d):c.mute_master(d)};a.is_muted=function(a){return a&&"object"===typeof a?c.is_muted(a):c.is_master_muted()};a.get_speaker_objects=function(){return c.get_speaker_objects().slice(0)};a.get_speakers=function(){return a.get_speaker_objects()};a.check_active_speakers=c.check_active_speakers;a.set_compressor_params=function(a){c.set_compressor_params(r.get_active(),a)};a.get_compressor_params=function(){return c.get_compressor_params(r.get_active())};a.duck=function(a,d,h){a&&
"object"===typeof a?c.duck(a,d,h):c.duck_master(d,h)};a.unduck=function(a){a&&"object"===typeof a?c.unduck(a):c.unduck_master()};a.apply_playlist=c.apply_playlist;a.clear_playlist=c.clear_playlist;a.detect_audio_container=c.detect_audio_container;a.detect_video_container=c.detect_video_container;a.set_positional_params=c.set_positional_params;a.get_positional_params=c.get_positional_params;a.set_filter_params=c.set_filter_params;a.get_filter_params=c.get_filter_params;a.get_filter_freq_response=c.get_filter_freq_response;
a.get_duration=function(a){if(a&&c.is_speaker(a))return c.get_duration(a);d.error('Object "'+(a?a.name:void 0)+'" is not a valid speaker')}};b4w.module.shaders=function(a,q){function r(a){var b={};if(!a)return b;a=a.split("\n");for(var c=0;c<a.length;c++){var d=a[c];if(-1!=d.search(new RegExp(/^[A-Z.]+ /))){var e=d.split(" ")[0];e in b||(b[e]=0);b[e]++}}c=a=0;for(e in b)switch(e){case "KIL":case "TEX":case "TXB":case "TXP":case "KIL.F":case "TEX.F":case "TXB.F":case "TXD.F":case "TXL.F":case "TXQ.F":case "TXP.F":c+=b[e];break;default:a+=b[e]}b.ALU_OPS=a;b.TEX_OPS=c;return b}function c(a,b){var c=new XMLHttpRequest;c.open("POST",a,!1);
c.send(b);if(200==c.status)return c.responseText;throw"Error POST XHR: "+c.status;}function d(a){for(var b=e.get_all_scenes(),c=0;c<b.length;c++)for(var d=e.get_scene_objs(b[c],"MESH",e.DATA_ID_ALL),h=0;h<d.length;h++){var k=d[h];if(k._batches)for(var l=0;l<k._batches.length;l++){var f=k._batches[l];if(f.shader==a&&f.material_names.length)return f.material_names}}return null}function b(a){a.sort(function(a,b){return b.fstats.ALU_OPS-a.fstats.ALU_OPS});for(var b=0;b<a.length;b++){var c=a[b],e=c.fstats,
h=c.vstats,k=d(c.cshader),k=k?"\t\t("+k.join(", ")+")":"\t\t(NA)";l.groupCollapsed("FRAG --\x3e","ALU",e.ALU_OPS,"TEX",e.TEX_OPS,"\t\tVERT --\x3e","ALU",h.ALU_OPS,"TEX",h.TEX_OPS,k);l.groupCollapsed("directives");for(var k=c.shaders_info.directives,q=0;q<k.length;q++){var f=k[q];l.log(f[0],f[1])}l.groupEnd();l.groupCollapsed("vert src");l.log(c.vsrc);l.groupEnd();l.groupCollapsed("vert stats");for(var r in h)"ALU_OPS"!=r&&"TEX_OPS"!=r&&l.log(r,h[r]);l.groupEnd();l.groupCollapsed("frag src");l.log(c.fsrc);
l.groupEnd();l.groupCollapsed("frag stats");for(r in e)"ALU_OPS"!=r&&"TEX_OPS"!=r&&l.log(r,e[r]);l.groupEnd();l.groupEnd()}}q("__config");var l=q("__print"),h=q("__extensions"),e=q("__scenes"),k=q("__shaders");q("__util");a.report_repeatful_compilation=function(){var a=k.debug_get_compilation_stats(),b=0,c;for(c in a){var d=a[c],e=d.count;1<e&&l.log(e-1,d.shader_filename,d.hc);b+=e-1}l.log("TOTAL OVERHEAD:",b);return"OK"};a.analyze=function(a){var d=k.get_compiled_shaders(),e=0,q;for(q in d)a&&-1===
q.indexOf(a)||e++;var e="of "+e+" analyzing...",x={};for(q in d)if(!a||-1!==q.indexOf(a)){var C=d[q],A;var f=C.vshader;A=C.fshader;var E=h.get_debug_shaders();if(E){f=E.getTranslatedShaderSource(f);A=E.getTranslatedShaderSource(A);var E=c("/nvidia_vert",f),n=r(E),t=c("/nvidia_frag",A),M=r(t);A={vsrc:f,vout:E,vstats:n,fsrc:A,fout:t,fstats:M}}else l.error("B4W Error: WEBGL_debug_shaders not found (run Chrome with --enable-privileged-webgl-extensions)"),A=void 0;E=C.shaders_info;f=E.vert+" + "+E.frag;
A.cshader=C;A.shaders_info=E;C=x[f]=x[f]||[];C.push(A);l.log(e)}for(f in x)l.group("%c"+f,"color: #800"),C=x[f],b(C),l.groupEnd()}};b4w.module.transform=function(a,q){var r=q("__print"),c=q("__physics"),d=q("__transform"),b=q("__util"),l=new Float32Array(3),h=new Float32Array(4);a.SPACE_LOCAL=d.SPACE_LOCAL;a.SPACE_WORLD=d.SPACE_WORLD;a.set_translation=function(a,b,g,h){l[0]=b;l[1]=g;l[2]=h;d.set_translation(a,l);d.update_transform(a);c.sync_transform(a)};a.set_translation_v=function(a,b){d.set_translation(a,b);d.update_transform(a);c.sync_transform(a)};a.set_translation_rel=function(a,h,g,q,m){l[0]=h;l[1]=g;l[2]=q;b.transform_vec3(l,
1,m._render.quat,m._render.trans,l);d.set_translation(a,l);d.update_transform(a);c.sync_transform(a)};a.get_translation=function(a,b){b||(b=new Float32Array(3));d.get_translation(a,b);return b};a.set_rotation=function(a,b,g,l,m){h[0]=b;h[1]=g;h[2]=l;h[3]=m;d.set_rotation(a,h);d.update_transform(a);c.sync_transform(a)};a.set_rotation_quat=a.set_rotation;a.set_rotation_v=function(a,b){d.set_rotation(a,b);d.update_transform(a);c.sync_transform(a)};a.set_rotation_quat_v=a.set_rotation_v;a.get_rotation=
function(a,b){b||(b=new Float32Array(4));d.get_rotation(a,b);return b};a.get_rotation_quat=a.get_rotation;a.set_rotation_euler=function(a,b,g,h){l[0]=b;l[1]=g;l[2]=h;d.set_rotation_euler(a,l);d.update_transform(a);c.sync_transform(a)};a.set_rotation_euler_v=function(a,b){d.set_rotation_euler(a,b);d.update_transform(a);c.sync_transform(a)};a.set_scale=function(a,b){d.set_scale(a,b);d.update_transform(a)};a.get_scale=function(a){return d.get_scale(a)};a.empty_reset_transform=function(a){if("EMPTY"!=
a.type)return r.error("Wrong object: "+a.name),!1;d.set_translation(a,[0,0,0]);d.set_rotation(a,[0,0,0,1]);d.set_scale(a,1);d.update_transform(a);c.sync_transform(a)};a.get_object_size=function(a){return b.is_mesh(a)?d.get_object_size(a):(r.error("Wrong object: "+a.name),0)};a.get_object_center=function(a,c,g){return b.is_mesh(a)?d.get_object_center(a,c,g):(r.error("Wrong object: "+a.name),null)};a.move_local=function(a,b,g,h){d.move_local(a,b,g,h);d.update_transform(a);c.sync_transform(a)};a.get_object_bounding_box=
function(a){return d.get_object_bounding_box(a)}};b4w.module.util=function(a,q){var r=q("__print"),c=q("__util"),d=q("vec3");q("mat4");a.AXIS_X=new Float32Array([1,0,0]);a.AXIS_Y=new Float32Array([0,1,0]);a.AXIS_Z=new Float32Array([0,0,1]);a.AXIS_MX=new Float32Array([-1,0,0]);a.AXIS_MY=new Float32Array([0,-1,0]);a.AXIS_MZ=new Float32Array([0,0,-1]);a.keyfind=c.keyfind;a.keysearch=c.keysearch;a.matrix_to_quat=function(a){return c.matrix_to_quat(a)};a.euler_to_quat=function(a,d){d||(d=new Float32Array(4));return c.euler_to_quat(a,d)};a.quat_to_euler=
function(a,d){d||(d=new Float32Array(3));return c.quat_to_euler(a,d)};a.sign=c.sign;a.clamp=c.clamp;a.quat_to_dir=c.quat_to_dir;a.ground_project_quat=function(a,d){return c.quat_project(a,c.AXIS_MY,c.AXIS_Y,c.AXIS_MZ,d)};a.cam_quat_to_mesh_quat=function(a,d){return c.cam_quat_to_mesh_quat(a,d)};a.quat_project=function(a,l,h,e,k){return 0!=d.dot(h,e)?(r.error("Wrong in-plane direction"),null):c.quat_project(a,l,h,e,k)};a.hash_code=c.hash_code;a.smooth=c.smooth;a.smooth_v=c.smooth_v;a.is_vector=c.is_vector;
a.correct_cam_quat_up=c.correct_cam_quat_up;a.quat_to_angle_axis=c.quat_to_angle_axis;a.random_from_array=c.random_from_array;a.xz_direction=c.xz_direction;a.line_plane_intersect=c.line_plane_intersect;a.is_mesh=c.is_mesh};"object"==typeof module&&module.exports&&(GLOBAL.b4w={module:{}});b4w.module.version=function(a,q){var r=q("__version");a.version=r.version;a.type=r.type;a.date=r.date};"object"==typeof module&&module.exports&&b4w.module.version(exports);b4w.module.particles=function(a,q){var r=q("__particles"),c=q("__print");a.set_size=function(a,b,l){r.has_particles(a)?r.set_size(a,b,l):c.error('"',a.name,'" has no particle systems')};a.set_normal_factor=function(a,b,l){r.has_particles(a)?r.set_normal_factor(a,b,l):c.error('"',a.name,'" has no particle systems')};a.set_factor=function(a,b,l){r.has_particles(a)?(l=Math.min(l,1),l=Math.max(l,0),r.set_factor(a,b,l)):c.error('"',a.name,'" has no particle systems')}};b4w.module.textures=function(a,q){var r=q("__textures"),c=q("__print");a.get_canvas_texture_context=function(a){var b=r.get_canvas_context(a);if(b)return b;c.error('Canvas texture with ID "'+a+'" not found!')};a.update_canvas_texture_context=function(a){r.update_canvas_context(a)||c.error('Canvas texture with ID "'+a+'" not found!')};a.play_video=function(a){r.play_video(a)||c.error('Texture with name "'+a+'" not found!')};a.stop_video=function(d){c.warn("stop_video() deprecated, use pause_video() instead");
return a.pause_video(d)};a.pause_video=function(a){r.pause_video(a)||c.error('Texture with name "'+a+'" not found!')};a.reset_video=function(a){r.reset_video(a)||c.error('Texture with name "'+a+'" not found!')}};b4w.module.objects=function(a,q){var r=q("__objects");a.get_meta_tags=function(a){if(a&&a.b4w_object_tags)return r.get_meta_tags(a)}};b4w.module.main=function(a,q){function r(){G.set_timeline(0);window.performance||(C.log("Apply performance workaround"),window.performance={});var a=Date.now();if(window.performance.now)return a-performance.now();C.log("Apply performance.now() workaround");window.performance.now=function(){return Date.now()-a};return a}function c(a,b){a.addEventListener("webglcontextlost",function(a){a.preventDefault();C.error("B4W Error: WebGL context lost");h()},!1);n.setup_context(b);var c=n.get_renderer_info();
c&&C.log("%cRENDERER INFO:","color: #00a",b.getParameter(c.UNMASKED_VENDOR_WEBGL)+", "+b.getParameter(c.UNMASKED_RENDERER_WEBGL));K.setup_context(b);t.setup_context(b);L.setup_context(b);O.setup_context(b);E.setup_context(b);f.setup_context(b);v.setup_dim(a.width,a.height,1,d("x"),d("y"));Q.init();ea=y();k()}function d(a){if("x"==a)var c=X.offsetLeft;else if("y"==a)c=X.offsetTop;else return 0;return b(c,X,a)}function b(a,c,d){a=a||0;if(c=c.offsetParent){if("x"==d)var e=c.offsetLeft;else"y"==d&&(e=
c.offsetTop);a=b(a+e,c,d)}return a}function l(){D=function(){}}function h(){e()||(Z=performance.now()/1E3,Q.pause(),B.pause(),L.pause())}function e(){return N<Z}function k(){qa(k);var a=performance.now()/1E3;ga||(ga=a);var b=a-ga;if(!(b<1/T.max_fps)){for(var c=G.get_timeline(),d=0;d<F.length;d++)F[d](c,b);e()||(N>ga&&(b-=N-Math.max(Z,ga)),c+=b,G.set_timeline(c),E.update(),z.update(),f.update(),g(c,b),ea(b));ga=a}}function g(a,b){f.is_primary_loaded()&&(M.reset(),V.update(b),S.update(a,b),Q.update(a,
b),m.update(b),f.is_primary_loaded()&&(B.update(a,b),f.is_primary_loaded()&&(D(b,a),f.is_primary_loaded()&&(A.update(a,b),f.is_primary_loaded()&&(v.update(a,b),I&&(I(X.toDataURL()),I=null))))))}function y(){var a=60,b=0,c=0,d=T.fps_measurement_interval,e=T.fps_callback_interval;return function(f){a=$.smooth(1/f,a,f,d);b=$.smooth(B.get_fps(),b,f,d);c=(c+1)%e;0==c&&ha(Math.round(a),Math.round(b))}}var m=q("__animation"),s=q("__compat"),x=q("__config"),C=q("__print"),A=q("__controls"),f=q("__data"),
E=q("__debug"),n=q("__extensions"),t=q("__geometry"),M=q("__hud"),S=q("__nla"),z=q("__assets"),B=q("__physics"),K=q("__renderer"),v=q("__scenes"),Q=q("__sfx"),O=q("__shaders"),L=q("__textures"),G=q("__time"),V=q("__transform"),$=q("__util"),P=q("__version"),Y=x.context,T=x.defaults,X=null,p=null,ga=0,Z=0,N=0,F=[],ha=function(){},ea=function(){},D=function(){},I=null,ia=["webgl","experimental-webgl"],ka=null,qa=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||
window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return window.setTimeout(a,1E3/T.max_fps)}}();a.init=function(a,b){x.set_resources_paths();C.set_verbose(T.console_verbose);var d=P.version()+" "+P.type()+" ("+P.date()+")";C.log("%cINIT B4W ENGINE","color: #00a",d);if(!window.WebGLRenderingContext)return null;d=r();X=a;s.apply_context_alpha_hack(e);var e;e=null;for(var f=0;f<ia.length;f++){var g=ia[f];try{e=a.getContext(g,Y)}catch(h){}if(e)break}if(!e)return null;ka=e;c(X,
e);x.apply_quality();s.set_hardware_defaults(e);C.log("%cSET PRECISION:","color: #00a",T.precision);b?(M.init(b),p=b):(x.defaults.show_hud_debug_info=!1,x.sfx.mix_mode=!1);B.init_engine(d);return e};a.set_check_gl_errors=function(a){E.set_check_gl_errors(a)};a.resize=function(a,b,c){!1!==c&&(X.style.width=a+"px",X.style.height=b+"px",p&&(p.style.width=a+"px",p.style.height=b+"px"));p&&(p.width=a,p.height=b,M.update_dim());if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||
navigator.userAgent.match(/iPod/i))T.canvas_resolution_factor=1;c=a*T.canvas_resolution_factor;b*=T.canvas_resolution_factor;T.allow_hidpi&&1<window.devicePixelRatio&&(c*=window.devicePixelRatio,b*=window.devicePixelRatio);X.width=c;X.height=b;if(c>ka.drawingBufferWidth||b>ka.drawingBufferHeight){C.warn("B4W Warning: canvas size exceeds platform limits, downscaling");var e=Math.min(ka.drawingBufferWidth/c,ka.drawingBufferHeight/b);c*=e;b*=e;X.width=c;X.height=b}v.setup_dim(c,b,c/a,d("x"),d("y"));
K.clear();g(G.get_timeline(),0);f.update_media_controls(X.width,X.height)};a.set_fps_callback=function(a){ha=a};a.clear_fps_callback=function(){ha=function(){}};a.set_on_before_render_callback=function(a){D=a};a.set_render_callback=function(a){D=a};a.clear_on_before_render_callback=function(){l()};a.clear_render_callback=function(){l()};a.global_timeline=function(){return G.get_timeline()};a.redraw=function(){g(G.get_timeline(),0)};a.pause=h;a.resume=function(){e()&&(N=performance.now()/1E3,Q.resume(),
B.resume(),L.play(!0))};a.is_paused=e;a.reset=function(){f.unload();p=X=null;N=Z=ga=0;ha=function(){};ea=function(){};D=function(){};F.length=0;ka=null};a.canvas_data_url=function(a){I=a};a.get_canvas_elem=function(){return X};a.set_texture_quality=function(){$.panic("set_texture_quality() deprecated")};a.set_shaders_dir=function(){$.panic("set_shaders_dir() deprecated")};a.detect_mobile=function(){return s.detect_mobile()};a.append_loop_cb=function(a){for(var b=0;b<F.length;b++)if(F[b]==a)return;
F.push(a)};a.remove_loop_cb=function(a){for(var b=0;b<F.length;b++)if(F[b]==a){F.splice(b,1);break}}};b4w.module.storage=function(a,q){function r(a){b=a;try{l=window.localStorage}catch(c){d.warn("Applying chrome localStorage bug workaround"),l=null}l||(d.warn("localStorage is not available, initializing temporary storage"),l={})}function c(){return l[b]?JSON.parse(l[b]):{}}var d=q("__print"),b="",l=null;a.init=r;a.set=function(a,d){var k=c();k[a]=String(d);l[b]=JSON.stringify(k)};a.cleanup=function(){delete l[b]};a.get=function(a){var b=c();return b[a]?b[a]:""};a.debug=function(){d.log(c())};r("b4w")};b4w.module.app=function(a,q){function r(){var a=n.is_paused();document.addEventListener("visibilitychange",function(){document.hidden?(a=n.is_paused(),n.pause()):a||n.resume()},!1)}function c(a,b){var c=String(a);b&&(c+="/"+String(b));O.innerHTML=c}function d(a){a=document.getElementById(a);var b=a.cloneNode(!0);a.parentNode.replaceChild(b,a);return b}function b(a,b,c){if(s.has_distance_limits(a))var d=z.get_translation(a,G),e=s.get_hover_cam_pivot(a,V),d=K.subtract(d,e,G),d=Math.max(K.len(d),1);
else d=10;e=z.get_rotation_quat(a,Y);b=B.quat_to_dir(e,b,G);b[1]=0;K.normalize(b,b);K.scale(b,d*c,b);s.has_distance_limits(a)?(e=s.get_hover_cam_pivot(a,V),K.add(e,b,e),s.translate_hover_cam_v(a,e)):(d=z.get_translation(a,V),K.add(d,b,d),s.translate_hover_cam_v(a,d))}function l(a,b){if(s.has_distance_limits(a)){var c=s.get_hover_angle_limits(a,L);if(0<c[0]-c[1]){var d=s.get_hover_cam_angle(a),c=(d-c[1])/(c[0]-c[1]),e=s.get_cam_dist_limits(a),c=Math.max(c,2/e[0]);s.set_hover_cam_angle(a,d-c*b)}}else d=
z.get_translation(a,G),c=K.scale(B.AXIS_Y,-b,V),K.add(d,c,d),s.translate_hover_cam_v(a,d)}function h(a,b,c,d){z.move_local(a,5*b,5*c,5*d)}function e(a,b,c){var d=z.get_translation(a,G),e=s.get_pivot(a,V),d=K.dist(d,e),e=Math.abs(b);c=Math.pow(e*c,1-Math.pow(e*c,.15));z.move_local(a,0,0>b?.001<d?-d*c:0:c/(1-c)*d,0)}function k(a,b,c,d,e){for(a=d*c;0<b;--b)d+=a,e+=a,a=d*c;return e}function g(a,b,c,d,e,f){f?(e=s.get_pivot(a,G),f=s.get_eye(a),e=K.dist(e,f)+d,d=0<b?k(a,b,-c,e,d):k(a,-b,c/(1-c),e,d)):d-=
b*e*c;return d}function y(a,b,c,d){var e=document.createElement("div"),f=document.createElement("div"),g=document.createElement("div");if(d)for(var h=0;h<d.length;h++){var k=document.getElementById(d[h]);k&&k.parentNode.removeChild(k)}e.style.cssText="z-index:10;width:100%;height:auto;position:absolute;top:50%;margin-top:150px;text-align:center;";f.style.cssText="color:#fff;font-size:24px;";g.style.cssText="color:#fff;font-size:20px;";f.innerHTML=a;g.innerHTML=b+'   <a style="color:#fff;font-size:20px;width:100%;" href="'+
c+'">'+c.replace("https://www.","")+"</a>";e.appendChild(f);e.appendChild(g);document.body.appendChild(e)}function m(a,b,c,d){function e(g,h){var k=1E3*g-f;d(a+k*(b-a)/c);k>=c&&n.remove_loop_cb(e)}var f=1E3*n.global_timeline();n.append_loop_cb(e)}q("animation");var s=q("camera"),x=q("config"),C=q("constraints"),A=q("controls"),f=q("data"),E=q("debug"),n=q("main"),t=q("physics"),M=q("print"),S=q("scenes"),z=q("transform"),B=q("util"),K=q("vec3");q("quat");var v=null,Q=null,O=null,L=new Float32Array(2),
G=new Float32Array(3),V=new Float32Array(3),$=new Float32Array(3),P=new Float32Array(3),Y=new Float32Array(4);a.init=function(a){a=a||{};var b=null,d=function(){},e=!1,g=null,h=null,k=null,l=!0,m=!1,q=!0,s=!0,t=!1,z=!1,B;for(B in a)switch(B){case "canvas_container_id":b=a.canvas_container_id;break;case "callback":d=a.callback;break;case "do_not_use_onload":break;case "gl_debug":e=a.gl_debug;break;case "show_hud_debug_info":z=a.show_hud_debug_info;break;case "sfx_mix_mode":m=a.sfx_mix_mode;break;case "show_fps":t=
a.show_fps;break;case "fps_wrapper_id":k=a.fps_wrapper_id;break;case "fps_elem_id":h=a.fps_elem_id;break;case "error_purge_elements":g=a.error_purge_elements;break;case "report_init_failure":s=a.report_init_failure;break;case "pause_invisible":q=a.pause_invisible;break;case "key_pause_enabled":l=a.key_pause_enabled;break;default:x.set(B,a[B])}a=function(a){a.keyCode==A.KEY_P&&(n.is_paused()?n.resume():n.pause())};l&&document.addEventListener("keydown",a,!1);x.set("show_hud_debug_info",z);x.set("sfx_mix_mode",
m);var C=z||m||null,l=function(){var a;a=b;var f=s,l=g,m=document.createElement("canvas");m.style.cssText="position: absolute;left:0px; top:0px;";if(C){var x=document.createElement("canvas");x.style.cssText="z-index: 2; position:absolute; left:0px; top:0px; pointer-events: none;"}else x=null;n.init(m,x)?(Q=m,f=document.getElementById(a),f||(M.error('Warning: canvas container "'+a+'" not found, appending to body'),f=document.body),f.appendChild(m),x&&f.appendChild(x),a=f):(f&&y("Browser could not initialize WebGL",
"For more info visit","https://www.blend4web.com/troubleshooting",l),a=null);a?(v=a,n.set_check_gl_errors(e),t&&((a=h)?(k&&(document.getElementById(k).style.display="block"),O=document.getElementById(a)):(O=document.createElement("div"),O.innerHTML=0,O.style.cssText="             position:absolute;            top: 23px;            right: 20px;            font-size: 45px;            line-height: 50px;            font-weight: bold;            color: #000;            z-index: 1;        ",document.body.appendChild(O)),
n.set_fps_callback(c)),q&&r(),d(Q,!0)):d(Q,!1)};"complete"==document.readyState?window.setTimeout(l,0):window.addEventListener("load",l,!1);window.addEventListener("unload",function(){f.cleanup()},!1)};a.get_canvas_container=function(){return v};a.set_onclick=function(a,b){var c=d(a);c.addEventListener("mouseup",function(a){b(c.value)},!1)};a.set_onchange=function(a,b){var c=d(a);c.addEventListener("change",function(a){a=c.checked;b(void 0!=a?a:c.value)},!1)};a.set_onkeypress=function(a,b){var c=
d(a);c.addEventListener("keypress",function(a){b(a.keyCode,c.value)},!1)};a.enable_camera_controls=function(a,c){var d=S.get_active_camera(),f=!1,k=null,m=!1;switch(s.get_move_style(d)){case s.MS_TARGET_CONTROLS:f=!a;break;case s.MS_EYE_CONTROLS:k=S.get_first_character();break;case s.MS_STATIC:return;case s.MS_HOVER_CONTROLS:m=!0}var n=s.get_velocity_params(d,P),q=A.create_elapsed_sensor();if(t.has_simulated_physics(d)){var r=A.create_collision_sensor(d,null,!0);A.create_sensor_manifold(d,"CAMERA_COLLISION",
A.CT_CONTINUOUS,[q,r],null,function(a,b,c){if(1==c){b=A.get_sensor_payload(a,b,1);c=z.get_translation(a,G);var d=V;K.sub(c,b,d);K.normalize(d,d);K.scale(d,.01,d);K.add(c,d,c);z.set_translation_v(a,c)}})}if(k){var v=z.get_translation(d),x=z.get_rotation(d),x=B.cam_quat_to_mesh_quat(x);v[1]-=.5;t.set_transform(k,v,x);C.append_stiff_trans(d,k,[0,.5,0]);var y=new Float32Array(2),E=!0;t.set_character_move_type(k,t.CM_FLY);A.create_kb_sensor_manifold(d,"TOGGLE_CHAR_MOVE_TYPE",A.CT_SHOT,A.KEY_C,function(){E=
!E;t.set_character_move_type(k,E?t.CM_FLY:t.CM_WALK)})}v=function(a,c,d){if(!r||!A.get_sensor_value(a,"CAMERA_COLLISION",1)){if(1==d)switch(d=A.get_sensor_value(a,c,0),s.get_velocity_params(a,n),c){case "FORWARD":k?y[0]=1:m?Math.abs(s.get_hover_cam_angle(a))>=Math.PI/4?b(a,B.AXIS_MZ,.5*n[0]*d):b(a,B.AXIS_MY,.5*n[0]*d):f?e(a,-n[2],d):h(a,0,-n[0]*d,0);break;case "BACKWARD":k?y[0]=-1:m?Math.abs(s.get_hover_cam_angle(a))>=Math.PI/4?b(a,B.AXIS_Z,.5*n[0]*d):b(a,B.AXIS_Y,.5*n[0]*d):f?e(a,n[2],d):h(a,0,n[0]*
d,0);break;case "UP":m?l(a,30*-n[2]*d):k||h(a,0,0,-n[0]*d);break;case "DOWN":m?l(a,30*n[2]*d):k||h(a,0,0,n[0]*d);break;case "LEFT":k?y[1]=1:m?b(a,B.AXIS_MX,.5*n[0]*d):h(a,-n[0]*d,0,0);break;case "RIGHT":k?y[1]=-1:m?b(a,B.AXIS_X,.5*n[0]*d):h(a,n[0]*d,0,0);break;case "ROT_LEFT":f?s.rotate_pivot(a,2*-n[1]*d,0):s.rotate(a,2*n[1]*d,0);break;case "ROT_RIGHT":f?s.rotate_pivot(a,2*n[1]*d,0):s.rotate(a,2*-n[1]*d,0);break;case "ROT_UP":f?s.rotate_pivot(a,0,2*-n[1]*d):s.rotate(a,0,2*-n[1]*d);break;case "ROT_DOWN":f?
s.rotate_pivot(a,0,2*n[1]*d):s.rotate(a,0,2*n[1]*d)}else switch(c){case "FORWARD":case "BACKWARD":k&&(y[0]=0);break;case "LEFT":case "RIGHT":k&&(y[1]=0)}k&&(t.set_character_move_dir(k,y[0],y[1]),c=L,s.get_angles(a,c),c[0]+=Math.PI,c[1]*=-1,t.set_character_rotation(k,c[0],c[1]))}};if(c)x=M=H=O=w=Q=A.create_custom_sensor(0);else var x=A.create_keyboard_sensor(A.KEY_W),M=A.create_keyboard_sensor(A.KEY_S),H=A.create_keyboard_sensor(A.KEY_A),O=A.create_keyboard_sensor(A.KEY_D),w=A.create_keyboard_sensor(A.KEY_R),
Q=A.create_keyboard_sensor(A.KEY_F);var Y=A.create_keyboard_sensor(A.KEY_UP),ca=A.create_keyboard_sensor(A.KEY_DOWN),qb=A.create_keyboard_sensor(A.KEY_LEFT),ma=A.create_keyboard_sensor(A.KEY_RIGHT),R=function(a){return a[0]&&(a[1]||a[2])};m||(A.create_sensor_manifold(d,"FORWARD",A.CT_CONTINUOUS,[q,x],null,v),A.create_sensor_manifold(d,"BACKWARD",A.CT_CONTINUOUS,[q,M],null,v));f?(A.create_sensor_manifold(d,"ROT_UP",A.CT_CONTINUOUS,[q,Y,w],R,v),A.create_sensor_manifold(d,"ROT_DOWN",A.CT_CONTINUOUS,
[q,ca,Q],R,v),A.create_sensor_manifold(d,"ROT_LEFT",A.CT_CONTINUOUS,[q,qb,H],R,v),A.create_sensor_manifold(d,"ROT_RIGHT",A.CT_CONTINUOUS,[q,ma,O],R,v)):m?(A.create_sensor_manifold(d,"LEFT",A.CT_CONTINUOUS,[q,qb,H],R,v),A.create_sensor_manifold(d,"RIGHT",A.CT_CONTINUOUS,[q,ma,O],R,v),A.create_sensor_manifold(d,"FORWARD",A.CT_CONTINUOUS,[q,Y,x],R,v),A.create_sensor_manifold(d,"BACKWARD",A.CT_CONTINUOUS,[q,ca,M],R,v),A.create_sensor_manifold(d,"UP",A.CT_CONTINUOUS,[q,Q],R,v),A.create_sensor_manifold(d,
"DOWN",A.CT_CONTINUOUS,[q,w],R,v)):(A.create_sensor_manifold(d,"UP",A.CT_CONTINUOUS,[q,w],R,v),A.create_sensor_manifold(d,"DOWN",A.CT_CONTINUOUS,[q,Q],R,v),A.create_sensor_manifold(d,"LEFT",A.CT_CONTINUOUS,[q,H],R,v),A.create_sensor_manifold(d,"RIGHT",A.CT_CONTINUOUS,[q,O],R,v),A.create_sensor_manifold(d,"ROT_UP",A.CT_CONTINUOUS,[q,Y],R,v),A.create_sensor_manifold(d,"ROT_DOWN",A.CT_CONTINUOUS,[q,ca],R,v),A.create_sensor_manifold(d,"ROT_LEFT",A.CT_CONTINUOUS,[q,qb],R,v),A.create_sensor_manifold(d,
"ROT_RIGHT",A.CT_CONTINUOUS,[q,ma],R,v));var ta=0,v=A.create_mouse_wheel_sensor(),aa=0,x=A.create_touch_zoom_sensor();A.create_sensor_manifold(d,"MOUSE_WHEEL",A.CT_LEVEL,[v],null,function(a,b,c){1==c&&(b=A.get_sensor_value(a,b,0),s.get_velocity_params(a,n),f||m?ta=g(a,b,n[2],ta,2,f):(n[0]*=1+b*n[2],s.set_velocity_params(a,n)))});A.create_sensor_manifold(d,"TOUCH_ZOOM",A.CT_LEVEL,[x],null,function(a,b,c,d){1==c&&(c=A.get_sensor_value(a,b,0),s.get_velocity_params(a,n),A.get_sensor_payload(a,b,0)===
A.PL_MULTITOUCH_MOVE_ZOOM&&(aa=g(a,c,.03*n[2],aa,2,f)))});A.create_sensor_manifold(d,"ZOOM_INTERPOL",A.CT_CONTINUOUS,[q],null,function(a,b,c){if(1==c&&(f||m))if(1E-5<Math.abs(ta)||1E-5<Math.abs(aa)){b=A.get_sensor_value(a,b,0);c=B.smooth(ta,0,b,.1);ta-=c;var d=B.smooth(aa,0,b,.15);aa-=d;if(!r||!A.get_sensor_value(a,"CAMERA_COLLISION",1))if(m)l(a,-(c+d));else{b=s.get_pivot(a,G);var e=s.get_eye(a,V);.001<K.dist(b,e)+c+d?z.move_local(a,0,c+d,0):(c=K.subtract(e,b,V),d=K.normalize(c,$),K.scale(d,.001,
d),K.add(b,d,c),z.set_translation_v(a,c),aa=ta=0)}}else aa=ta=0});var Ya=0,na=0,bb=0,Aa=0,v=A.create_mouse_move_sensor("X"),x=A.create_mouse_move_sensor("Y"),M=A.create_mouse_click_sensor(),H=function(a,b,c,d){if(1==c){c=A.get_sensor_value(a,b,1);s.get_velocity_params(a,n);if(m)e=.003*n[0],f=7.5E-4*n[1];else var e=.003*n[1],f=7.5E-4*n[0];if(1===A.get_sensor_payload(a,b,0))Ya+="X"==d?-c*e:0,na+="Y"==d?-c*e:0;else if(2===A.get_sensor_payload(a,b,0)||3===A.get_sensor_payload(a,b,0))bb+="X"==d?-c*f:0,
Aa+="Y"==d?-c*f:0}};A.create_sensor_manifold(d,"MOUSE_X",A.CT_LEVEL,[M,v],null,H,"X");A.create_sensor_manifold(d,"MOUSE_Y",A.CT_LEVEL,[M,x],null,H,"Y");var Jb=0,cb=0,Qa=0,Kb=0,v=A.create_touch_move_sensor("X"),x=A.create_touch_move_sensor("Y"),M=function(a,b,c,d){if(1==c){var e=m?.003*n[0]:.003*n[1];c=A.get_sensor_value(a,b,0);A.get_sensor_payload(a,b,0)===A.PL_SINGLE_TOUCH_MOVE?(Jb+="X"==d?-c*e:0,cb+="Y"==d?-c*e:0):A.get_sensor_payload(a,b,0)===A.PL_MULTITOUCH_MOVE_PAN&&(a=m?.003*n[1]:7.5E-4*n[0],
Qa+="X"==d?-c*a:0,Kb+="Y"==d?-c*a:0)}};A.create_sensor_manifold(d,"TOUCH_X",A.CT_LEVEL,[v],null,M,"X");A.create_sensor_manifold(d,"TOUCH_Y",A.CT_LEVEL,[x],null,M,"Y");A.create_sensor_manifold(d,"ROT_TRANS_INTERPOL",A.CT_CONTINUOUS,[q],null,function(a,c,d){if(1==d&&(.001<Math.abs(Ya)||.001<Math.abs(na)||.001<Math.abs(Jb)||.001<Math.abs(cb)||.001<Math.abs(bb)||.001<Math.abs(Aa)||1E-5<Math.abs(Qa)||1E-5<Math.abs(Kb))){var e=A.get_sensor_value(a,c,0);c=B.smooth(Ya,0,e,.08);d=B.smooth(na,0,e,.08);Ya-=
c;na-=d;var g=B.smooth(Jb,0,e,.12),h=B.smooth(cb,0,e,.12);Jb-=g;cb-=h;var l=B.smooth(bb,0,e,.08),p=B.smooth(Aa,0,e,.08);bb-=l;Aa-=p;var n=B.smooth(Qa,0,e,.12),e=B.smooth(Kb,0,e,.12);Qa-=n;Kb-=e;f?(s.rotate_pivot(a,c+g,d+h),s.move_pivot(a,l+n,p+e)):m?(c+g&&b(a,B.AXIS_X,.2*(c+g)),d+h&&(Math.abs(s.get_hover_cam_angle(a))>Math.PI/4?b(a,B.AXIS_Z,.2*(d+h)):b(a,B.AXIS_Y,.2*(d+h))),s.rotate_hover_cam(a,l+n)):(s.rotate(a,.5*(c+g),.5*-(d+h)),k&&(c=L,s.get_angles(a,c),c[0]+=Math.PI,c[1]*=-1,t.set_character_rotation(k,
c[0],c[1])))}});A.create_kb_sensor_manifold(d,"DEC_STEREO_DIST",A.CT_SHOT,A.KEY_LEFT_SQ_BRACKET,function(a,b,c){b=s.get_stereo_distance(a);s.set_stereo_distance(a,.9*b)});A.create_kb_sensor_manifold(d,"INC_STEREO_DIST",A.CT_SHOT,A.KEY_RIGHT_SQ_BRACKET,function(a,b,c){b=s.get_stereo_distance(a);s.set_stereo_distance(a,1.1*b)})};a.disable_camera_controls=function(){for(var a=S.get_active_camera(),b="FORWARD BACKWARD ROT_UP ROT_DOWN ROT_LEFT ROT_RIGHT UP DOWN LEFT RIGHT MOUSE_WHEEL TOUCH_ZOOM ZOOM_INTERPOL MOUSE_X MOUSE_Y TOUCH_X TOUCH_Y ROT_TRANS_INTERPOL".split(" "),
c=0;c<b.length;c++)A.remove_sensor_manifold(a,b[c])};a.enable_object_controls=function(a){var b=t.is_vehicle_chassis(a)||t.is_vehicle_hull(a),c=function(a,c,d){if(1==d)switch(d=A.get_sensor_value(a,c,0),c){case "FORWARD":b?t.vehicle_throttle(a,1):z.move_local(a,0,0,1*d);break;case "BACKWARD":b?t.vehicle_throttle(a,-1):z.move_local(a,0,0,-1*d);break;case "LEFT":b?t.vehicle_steer(a,-1):z.move_local(a,1*d,0,0);break;case "RIGHT":b?t.vehicle_steer(a,1):z.move_local(a,-1*d,0,0)}else switch(c){case "FORWARD":case "BACKWARD":b&&
t.vehicle_throttle(a,0);break;case "LEFT":case "RIGHT":b&&t.vehicle_steer(a,0)}},d=A.create_elapsed_sensor(),e=A.create_keyboard_sensor(A.KEY_W),f=A.create_keyboard_sensor(A.KEY_S),g=A.create_keyboard_sensor(A.KEY_A),h=A.create_keyboard_sensor(A.KEY_D),k=A.create_keyboard_sensor(A.KEY_UP),l=A.create_keyboard_sensor(A.KEY_DOWN),m=A.create_keyboard_sensor(A.KEY_LEFT),n=A.create_keyboard_sensor(A.KEY_RIGHT),q=function(a){return a[0]&&(a[1]||a[2])};A.create_sensor_manifold(a,"FORWARD",A.CT_CONTINUOUS,
[d,e,k],q,c);A.create_sensor_manifold(a,"BACKWARD",A.CT_CONTINUOUS,[d,f,l],q,c);A.create_sensor_manifold(a,"LEFT",A.CT_CONTINUOUS,[d,g,m],q,c);A.create_sensor_manifold(a,"RIGHT",A.CT_CONTINUOUS,[d,h,n],q,c)};a.disable_object_controls=function(a){for(var b=["FORWARD","BACKWARD","LEFT","RIGHT"],c=0;c<b.length;c++)A.remove_sensor_manifold(a,b[c])};a.enable_controls=function(a){A.register_keyboard_events(document,!1);A.register_mouse_events(a,!0);A.register_wheel_events(a,!0);A.register_touch_events(a,
!0);A.register_device_orientation()};a.disable_controls=function(a){A.unregister_keyboard_events(document);A.unregister_mouse_events(a);A.unregister_wheel_events(a);A.unregister_touch_events(a);A.unregister_device_orientation()};a.enable_debug_controls=function(){A.create_kb_sensor_manifold(null,"CAMERA_SHOT",A.CT_SHOT,A.KEY_K,function(){E.make_camera_frustum_shot()});A.create_kb_sensor_manifold(null,"LIGHT_SHOT",A.CT_SHOT,A.KEY_L,function(){E.make_light_frustum_shot()});A.create_kb_sensor_manifold(null,
"TELEMETRY",A.CT_SHOT,A.KEY_T,function(){E.plot_telemetry()})};a.request_fullscreen=function(a,b,c){function d(){document.fullscreenElement===a||document.webkitFullScreenElement===a||document.mozFullScreenElement===a||document.webkitIsFullScreen||document.msFullscreenElement===a?b():(document.removeEventListener("fullscreenchange",d,!1),document.removeEventListener("webkitfullscreenchange",d,!1),document.removeEventListener("mozfullscreenchange",d,!1),document.removeEventListener("MSFullscreenChange",
d,!1),c())}b=b||function(){};c=c||function(){};document.addEventListener("fullscreenchange",d,!1);document.addEventListener("webkitfullscreenchange",d,!1);document.addEventListener("mozfullscreenchange",d,!1);document.addEventListener("MSFullscreenChange",d,!1);a.requestFullScreen=a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen||a.msRequestFullscreen;a.requestFullScreen==a.webkitRequestFullScreen?a.requestFullScreen(Element.ALLOW_KEYBOARD_INPUT):a.requestFullScreen()};a.exit_fullscreen=
function(){var a=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;if("function"!=typeof a)throw"B4W App: exit fullscreen method is not supported";a.apply(document)};a.check_fullscreen=function(){return window.document.fullscreenEnabled||window.document.mozFullScreenEnabled||window.document.webkitFullscreenEnabled?!0:!1};a.report_app_error=y;a.get_url_params=function(){var a=location.href.toString();if(-1==a.indexOf("?"))return null;for(var a=
a.split("?")[1].split("&"),b={},c=0;c<a.length;c++){var d=a[c].split("=");b[d[0]]=1<d.length?d[1]:""}return b};a.css_animate=function(a,b,c,d,e,f,g){m(c,d,e,function(e){var h=e;f&&(h+=f);a.style[b]=h;(c>d&&e<=d||c<d&&e>=d)&&g()})}};b4w.module.mouse=function(a,q){function r(){var a=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;"function"===typeof a&&a.apply(document)}function c(a){a.removeEventListener("mousedown",b,!1);a.removeEventListener("mouseup",l,!1);a.removeEventListener("mousemove",d,!1)}function d(a){S()&&(t[0]+=2*(a.clientX-E),t[1]+=2*(a.clientY-n),E=a.clientX,n=a.clientY);a.preventDefault()}function b(a){E=a.clientX;n=a.clientY;a.currentTarget.addEventListener("mousemove",d,
!1);a.preventDefault()}function l(a){a.currentTarget.removeEventListener("mousemove",d,!1);a.preventDefault()}function h(a,b,c){if(.01<Math.abs(t[0])||.01<Math.abs(t[1])){b=m.get_sensor_value(a,b,0);a=A.smooth(t[0],0,b,.1);var d=A.smooth(t[1],0,b,.1);b=C.get_first_character();c=C.get_active_camera();y.rotate(c,4E-4*-a,4E-4*d);t[0]-=a;t[1]-=d;b&&(a=M,y.get_angles(c,a),a[0]+=Math.PI,a[1]*=-1,s.set_character_rotation(b,a[0],a[1]))}}function e(a){var b=k(a);a=g(a);(b=C.pick_object(b,a))?(C.set_glow_intensity(b,
1),z&&b!=z&&C.set_glow_intensity(z,0)):z&&C.set_glow_intensity(z,0);z=b}function k(a){return a.clientX||a.touches&&a.touches[0].pageX||-1}function g(a){return a.clientY||a.touches&&a.touches[0].pageY||-1}var y=q("camera"),m=q("controls"),s=q("physics"),x=q("print"),C=q("scenes"),A=q("util"),f=q("main"),E=0,n=0,t=new Float32Array(2),M=new Float32Array(2),S=null,z=null;a.request_pointerlock=function(a,b,d,e,f){function g(){if(document.pointerLockElement===a||document.webkitPointerLockElement===a||document.mozPointerLockElement===
a){c(a);a.addEventListener("mousemove",e,!1);var f=C.get_active_camera();if(!m.check_sensor_manifold(f,"SMOOTH_PL")){var k=m.create_elapsed_sensor();m.create_sensor_manifold(f,"SMOOTH_PL",m.CT_CONTINUOUS,[k],null,h)}b()}else a.removeEventListener("mousemove",e,!1),document.removeEventListener("pointerlockchange",g,!1),document.removeEventListener("webkitpointerlockchange",g,!1),document.removeEventListener("mozpointerlockchange",g,!1),d()}b=b||function(){};d=d||function(){};f=f||function(){return!0};
e=e||function(a){if(f()){var b=a.movementY||a.webkitMovementY||a.mozMovementY||0;t[0]+=a.movementX||a.webkitMovementX||a.mozMovementX||0;t[1]+=b}};document.addEventListener("pointerlockchange",g,!1);document.addEventListener("webkitpointerlockchange",g,!1);document.addEventListener("mozpointerlockchange",g,!1);var k=a.requestPointerLock||a.webkitRequestPointerLock||a.mozRequestPointerLock;"function"===typeof k?k.apply(a):x.error("Pointer lock is not available")};a.exit_pointerlock=r;a.check_pointerlock=
function(a){return"function"===typeof(a.requestPointerLock||a.webkitRequestPointerLock||a.mozRequestPointerLock)?!0:!1};a.request_mouse_drag=function(a,c){r();S=c||function(){return!0};a.addEventListener("mousedown",b,!1);a.addEventListener("mouseup",l,!1);var d=C.get_active_camera();if(!m.check_sensor_manifold(d,"SMOOTH_DRAG")){var e=m.create_elapsed_sensor();m.create_sensor_manifold(d,"SMOOTH_DRAG",m.CT_CONTINUOUS,[e],null,h)}};a.exit_mouse_drag=c;a.enable_mouse_hover_glow=function(){f.detect_mobile()||
f.get_canvas_elem().addEventListener("mousemove",e)};a.disable_mouse_hover_glow=function(){f.detect_mobile()||(f.get_canvas_elem().removeEventListener("mousemove",e),z&&C.set_glow_intensity(z,0))};a.get_coords_x=k;a.get_coords_y=g};b4w.module.preloader=function(a,q){var r=q("app"),c,d,b,l,h,e,k,g,y,m=null;a.create_simple_preloader=function(a){var g=null,k=null,q="#bf9221",f="#000",r;for(r in a)switch(r){case "canvas_container_id":g=a.canvas_container_id;break;case "background_container_id":k=a.background_container_id;break;case "bg_color":f=a.bg_color;break;case "bar_color":q=a.bar_color;break;case "preloader_fadeout":c=a.preloader_fadeout}a=document.createElement("div");r=document.createElement("div");a.id="simple_preloader_container";
var n=document.createElement("div"),t=document.createElement("div"),k=document.getElementById(k);m=document.getElementById(g);a.style.cssText="         z-index: 4;        background-color: "+f+";        width: 100%;        height: 100%;        position: absolute;        margin: 0;        padding: 0;        top: 0;        left: 0;    ";r.style.cssText="         position: absolute;        left: 50%;        top: 82%;        width: 300px;        height: 20px;        margin-left: -150px;        margin-top: -10px;        border-style:solid;        border-width:4px;        border-color: #000;        border-radius: 0px;    ";
n.style.cssText="         position: absolute;        left: 0px;        top: 1px;        width: 0px;        height: 18px;        background-color: "+q+";        border-radius: 0px;    ";t.style.cssText="         position: absolute;        left: 50%;        top: 50%;        width: 100%;        height: 100%;        margin-left: -150px;        margin-top: -10px;        text-align: center;        font-size: 17px;        font-weight: bold;        color: #000;        font-family: Verdana;    ";r.appendChild(n);
r.appendChild(t);a.appendChild(r);document.body.appendChild(a);d="SIMPLE";b=a;l=n;h=t;e=k};a.create_rotation_preloader=function(a){var c=null,g=null,l="rgba(0,0,0,0)",f="",q="",n;for(n in a)switch(n){case "canvas_container_id":c=a.canvas_container_id;break;case "background_container_id":g=a.background_container_id;break;case "frame_bg_color":l=a.frame_bg_color;break;case "frame_class":f=a.frame_class;break;case "anim_elem_class":q=a.anim_elem_class}a=document.createElement("div");n=document.createElement("div");
var r=document.createElement("div"),y=document.createElement("div"),g=document.getElementById(g);m=document.getElementById(c);a.style.cssText="         z-index: 4;        background-color: rgba(0,0,0,0);        width: 100%;        height: 100%;        position: absolute;        margin: 0;        padding: 0;    ";n.style.cssText="         position: absolute;        left: 50%;        top: 50%;        width: 117px;        height: 117px;        margin-left: -58px;        margin-top: -58px;        background-color: "+
l+";    ";r.style.cssText="         position: absolute;        left: 0px;        top: 0px;        width: 100%;        height: 100%;        background-position: center;        background-repeat: no-repeat;    ";y.style.cssText="         position: absolute;        width: 100%;        height: 100%;        text-align: center;        margin-top: 38px;        font-size: 36px;        color: #ffffff;        font-family: Arial;        font-weight: bold;    ";r.className=q;n.appendChild(r);n.className=f;n.appendChild(y);
a.appendChild(n);document.body.appendChild(a);d="ROTATION";b=a;k=r;h=y;e=g};a.create_advanced_preloader=function(a){var c=a.preloader_width,k=a.canvas_container_id,c=c/(c-a.img_width),q=document.getElementById(a.preloader_bar_id),f=document.getElementById(a.fill_band_id),r=document.getElementById(a.preloader_caption_id),n=document.getElementById(a.preloader_container_id);a=document.getElementById(a.background_container_id);m=document.getElementById(k);d="ADVANCED";l=q;g=f;y=c;h=r;b=n;e=a};a.update_preloader=
function(a){h.innerHTML=a+"%";"SIMPLE"==d&&(l.style.width=a+"%");"ADVANCED"==d&&(l.style.width=a/y+"%",g.style.width=100-a+"%");"ROTATION"==d&&(k.style.transform="rotate("+a+"deg)");100==a&&(c?(r.css_animate(e,"opacity",1,0,1500,null,function(){e.style.display="none"}),r.css_animate(b,"opacity",1,0,1E3,null,function(){b.style.display="none"})):(b.style.display="none",m.style.zIndex=1,e&&(e.style.display="none")))}};if(!window.b4w)throw"Failed to register module ns_compat, load b4w first";b4w.module.ns_compat=function(a,q){for(var r in b4w.module)b4w[r]=b4w.require(r)};b4w.require("ns_compat");
